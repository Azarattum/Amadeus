var Qo=Object.defineProperty;var Po=(r,e,t)=>e in r?Qo(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var ce=(r,e,t)=>(Po(r,typeof e!="symbol"?e+"":e,t),t),Oi=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var i=(r,e,t)=>(Oi(r,e,"read from private field"),t?t.call(r):e.get(r)),T=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},k=(r,e,t,n)=>(Oi(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var ie=(r,e,t)=>(Oi(r,e,"access private method"),t);import{S as SvelteComponent,i as init$1,s as safe_not_equal,F as create_slot,k as element,l as claim_element,m as children,h as detach,n as attr,M as toggle_class,b as insert_hydration,G as update_slot_base,H as get_all_dirty_from_scope,I as get_slot_changes,g as transition_in,d as transition_out,X as setContext,e as empty$1,v as group_outros,O as noop$2,f as check_outros,J as getContext,a as space,c as claim_space,p as set_style,D as append_hydration,L as listen,U as action_destroyer,R as update_keyed_each,W as outro_and_destroy_block,$ as run_all,E as component_subscribe,a4 as createEventDispatcher,o as onMount,t as tick,af as globals,y as create_component,z as claim_component,A as mount_component,B as destroy_component,N as set_store_value,w as binding_callbacks,P as compute_slots,a5 as assign$1,ae as set_dynamic_element_data,a6 as get_spread_update,Y as bubble,ac as src_url_equal,q as text,r as claim_text,u as set_data}from"./index.84a1bd3e.js";import{w as writable,d as derived}from"./paths.e6cb63f4.js";import{l as lock,a as unlock,g as getScrollParent,p as position$1,d as debounce,I as Icon}from"./Spinner.svelte_svelte_type_style_lang.4c7447fd.js";const observers=new Map,dispatch$1=r=>r.forEach(e=>{var t,n;(t=e.target)==null||t.dispatchEvent(new CustomEvent("intersect",{detail:e})),(n=e.target)==null||n.dispatchEvent(new CustomEvent(e.isIntersecting?"viewenter":"viewleave",{detail:e}))});function intersection(r,e){const t=(e==null?void 0:e.toString())||"",n=observers.get(t)||[new IntersectionObserver(dispatch$1,{threshold:e}),0];return observers.has(t)||observers.set(t,n),n[0].observe(r),n[1]+=1,{destroy(){n[0].unobserve(r),n[1]-=1,n[1]<=0&&(n[0].disconnect(),observers.delete(t))}}}let observing=0,observer=null;const dispatch=r=>r.forEach(e=>{var t;(t=e.target)==null||t.dispatchEvent(new CustomEvent("resize",{detail:e}))});function resize(r){return observer||(observer=new ResizeObserver(dispatch)),observer.observe(r),observing+=1,{destroy(){observer==null||observer.unobserve(r),observing-=1,observing<=0&&(observer==null||observer.disconnect(),observer=null)}}}function drag(r,e="touchstart"){function t(c){do{if(c!=null&&c.draggable)return c;c=(c==null?void 0:c.parentElement)||null}while(c);return null}function n(c){const d=t(c.target);d&&(lock(),c.preventDefault(),d.dispatchEvent(new DragEvent("dragstart",{bubbles:!0})))}function s(c){c.preventDefault(),addEventListener("pointercancel",a),addEventListener("pointerup",a)}function a(){unlock(),removeEventListener("pointercancel",a),removeEventListener("pointerup",a),r.dispatchEvent(new DragEvent("dragend",{bubbles:!0}))}return r.addEventListener(e,n),r.addEventListener("dragstart",s),{destroy(){r.removeEventListener(e,n),r.removeEventListener("dragstart",s)}}}function hold(r,{touch:e=!0,mouse:t=!1,duration:n=300}={}){function s(a){const c=setTimeout(()=>{var p;d();const h=a instanceof TouchEvent?TouchEvent:MouseEvent;(p=a.target)==null||p.dispatchEvent(new h("hold",a))},n),d=()=>{clearTimeout(c),e&&(r.removeEventListener("touchcancel",d),r.removeEventListener("touchmove",d),r.removeEventListener("touchend",d)),t&&(r.removeEventListener("mousemove",d),r.removeEventListener("mouseup",d))};e&&(r.addEventListener("touchcancel",d,{once:!0}),r.addEventListener("touchend",d,{once:!0}),r.addEventListener("touchmove",d,{once:!0,passive:!0})),t&&(r.addEventListener("mousemove",d,{once:!0}),r.addEventListener("mouseup",d,{once:!0}))}return e&&r.addEventListener("touchstart",s,{passive:!0}),t&&r.addEventListener("mousedown",s),{destroy(){r.removeEventListener("touchstart",s),r.removeEventListener("mousedown",s)}}}function create_fragment$7(r){let e,t,n;const s=r[6].default,a=create_slot(s,r,r[5],null);return{c(){e=element("div"),a&&a.c(),this.h()},l(c){e=claim_element(c,"DIV",{class:!0});var d=children(e);a&&a.l(d),d.forEach(detach),this.h()},h(){attr(e,"class",t=r[0]?"contents":"hidden"),toggle_class(e,"sm:contents",!r[0]&&r[1]),toggle_class(e,"md:contents",!r[0]&&r[2]),toggle_class(e,"lg:contents",!r[0]&&r[3]),toggle_class(e,"xl:contents",!r[0]&&r[4]),toggle_class(e,"sm:hidden",r[0]&&r[1]),toggle_class(e,"md:hidden",r[0]&&r[2]),toggle_class(e,"lg:hidden",r[0]&&r[3]),toggle_class(e,"xl:hidden",r[0]&&r[4])},m(c,d){insert_hydration(c,e,d),a&&a.m(e,null),n=!0},p(c,[d]){a&&a.p&&(!n||d&32)&&update_slot_base(a,s,c,c[5],n?get_slot_changes(s,c[5],d,null):get_all_dirty_from_scope(c[5]),null),(!n||d&1&&t!==(t=c[0]?"contents":"hidden"))&&attr(e,"class",t),(!n||d&3)&&toggle_class(e,"sm:contents",!c[0]&&c[1]),(!n||d&5)&&toggle_class(e,"md:contents",!c[0]&&c[2]),(!n||d&9)&&toggle_class(e,"lg:contents",!c[0]&&c[3]),(!n||d&17)&&toggle_class(e,"xl:contents",!c[0]&&c[4]),(!n||d&3)&&toggle_class(e,"sm:hidden",c[0]&&c[1]),(!n||d&5)&&toggle_class(e,"md:hidden",c[0]&&c[2]),(!n||d&9)&&toggle_class(e,"lg:hidden",c[0]&&c[3]),(!n||d&17)&&toggle_class(e,"xl:hidden",c[0]&&c[4])},i(c){n||(transition_in(a,c),n=!0)},o(c){transition_out(a,c),n=!1},d(c){c&&detach(e),a&&a.d(c)}}}function instance$8(r,e,t){let{$$slots:n={},$$scope:s}=e,{not:a=!1}=e,{sm:c=!1}=e,{md:d=!1}=e,{lg:h=!1}=e,{xl:p=!1}=e;return r.$$set=N=>{"not"in N&&t(0,a=N.not),"sm"in N&&t(1,c=N.sm),"md"in N&&t(2,d=N.md),"lg"in N&&t(3,h=N.lg),"xl"in N&&t(4,p=N.xl),"$$scope"in N&&t(5,s=N.$$scope)},[a,c,d,h,p,s,n]}class When extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$8,create_fragment$7,safe_not_equal,{not:0,sm:1,md:2,lg:3,xl:4})}}function create_fragment$6(r){let e;const t=r[1].default,n=create_slot(t,r,r[0],null);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,[a]){n&&n.p&&(!e||a&1)&&update_slot_base(n,t,s,s[0],e?get_slot_changes(t,s[0],a,null):get_all_dirty_from_scope(s[0]),null)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}const initRealm=()=>({ssr:"",claimed:new Set,mounted:new Set,claim:new Set,destroy:new Set,mount:new Set,target:void 0});function instance$7(r,e,t){let{$$slots:n={},$$scope:s}=e;return setContext("realm",{}),r.$$set=c=>{"$$scope"in c&&t(0,s=c.$$scope)},[s,n]}class Realm extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$7,create_fragment$6,safe_not_equal,{})}}function create_key_block(r){let e;const t=r[4].default,n=create_slot(t,r,r[3],null);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,a){n&&n.p&&(!e||a&8)&&update_slot_base(n,t,s,s[3],e?get_slot_changes(t,s[3],a,null):get_all_dirty_from_scope(s[3]),null)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}function create_fragment$5(r){let e=r[0],t,n,s=create_key_block(r);return{c(){s.c(),t=empty$1()},l(a){s.l(a),t=empty$1()},m(a,c){s.m(a,c),insert_hydration(a,t,c),n=!0},p(a,[c]){c&1&&safe_not_equal(e,e=a[0])?(group_outros(),transition_out(s,1,1,noop$2),check_outros(),s=create_key_block(a),s.c(),transition_in(s,1),s.m(t.parentNode,t)):s.p(a,c)},i(a){n||(transition_in(s),n=!0)},o(a){transition_out(s),n=!1},d(a){a&&detach(t),s.d(a)}}}function instance$6($$self,$$props,$$invalidate){let{$$slots:slots={},$$scope}=$$props,{to=""}=$$props,{unique=""}=$$props;const realm=getContext("realm");if(!realm)throw new Error("A portal should exists within a realm!");realm[to]||(realm[to]=initRealm());const target=eval("slots");if(target.default){const[r]=target.default;target.default[0]=(...e)=>{const t=r(...e),n=realm[to];let s=!0,a=!0;function c(p){if(!p||n.claimed.has(unique))return a=!1;t.l(p),unique&&n.claimed.add(unique)}function d(p,N){if(n.mounted.has(unique))return s=!1;a&&t.m(p,N),unique&&n.mounted.add(unique)}function h(p){s&&n.mounted.delete(unique),a&&n.claimed.delete(unique),s&&t.d(p),n.claim.delete(c),n.mount.delete(d),n.destroy.delete(h)}return n.claim.add(c),n.mount.add(d),n.destroy.add(h),{...t,d:h,l:()=>{},m:()=>n.target&&d.apply(null,n.target)}}}return $$self.$$set=r=>{"to"in r&&$$invalidate(0,to=r.to),"unique"in r&&$$invalidate(1,unique=r.unique),"$$scope"in r&&$$invalidate(3,$$scope=r.$$scope)},$$self.$$.update=()=>{$$self.$$.dirty&5&&(realm[to]||$$invalidate(2,realm[to]=initRealm(),realm))},[to,unique,realm,$$scope,slots]}class Portal extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$6,create_fragment$5,safe_not_equal,{to:0,unique:1})}}function minmax(r,e,t,n){return r<e?n??e:r>t?n??t:r}const{Map:Map_1}=globals,get_default_slot_changes_1=r=>({item:r[0]&4096}),get_default_slot_context_1=r=>({item:r[12].data,index:NaN});function get_each_context(r,e,t){const n=r.slice();return n[53]=e[t],n[55]=t,n}const get_default_slot_changes$1=r=>({item:r[0]&65536,index:r[0]&66560}),get_default_slot_context$1=r=>({item:r[53],index:r[10]+r[55]});function create_each_block(r,e){let t,n,s,a;const c=e[37].default,d=create_slot(c,e,e[41],get_default_slot_context$1);return{key:r,first:null,c(){t=element("div"),d&&d.c(),n=space(),this.h()},l(h){t=claim_element(h,"DIV",{draggable:!0,style:!0});var p=children(t);d&&d.l(p),n=claim_space(p),p.forEach(detach),this.h()},h(){var h,p;attr(t,"draggable",s=e[3]&&e[2](e[53])!=null?"true":void 0),set_style(t,"overflow-anchor","none"),toggle_class(t,"invisible",((h=e[12])==null?void 0:h.owner)===e[4]&&((p=e[12])==null?void 0:p.key)===e[2](e[53])),this.first=t},m(h,p){insert_hydration(h,t,p),d&&d.m(t,null),append_hydration(t,n),a=!0},p(h,p){var N,O;e=h,d&&d.p&&(!a||p[0]&66560|p[1]&1024)&&update_slot_base(d,c,e,e[41],a?get_slot_changes(c,e[41],p,get_default_slot_changes$1):get_all_dirty_from_scope(e[41]),get_default_slot_context$1),(!a||p[0]&65548&&s!==(s=e[3]&&e[2](e[53])!=null?"true":void 0))&&attr(t,"draggable",s),(!a||p[0]&69652)&&toggle_class(t,"invisible",((N=e[12])==null?void 0:N.owner)===e[4]&&((O=e[12])==null?void 0:O.key)===e[2](e[53]))},i(h){a||(transition_in(d,h),a=!0)},o(h){transition_out(d,h),a=!1},d(h){h&&detach(t),d&&d.d(h)}}}function create_if_block$3(r){let e,t;return e=new Portal({props:{to:"overlay",$$slots:{default:[create_default_slot$1]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),t=!0},p(n,s){const a={};s[0]&4849|s[1]&1024&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}function create_if_block_1$2(r){let e,t=`translate3d(
          ${r[12].back?r[12].back.x:r[9].x+Math.max(r[12].offset.x,-r[5].width/r[7]+r[0])}px,
          ${r[12].back?r[12].back.y:r[9].y+Math.max(r[12].offset.y,-r[6]+r[0])}px, 0)`,n=`${r[5].width/r[7]-r[0]}px`,s=`${r[6]-r[0]}px`,a;const c=r[37].default,d=create_slot(c,r,r[41],get_default_slot_context_1);return{c(){e=element("div"),d&&d.c(),this.h()},l(h){e=claim_element(h,"DIV",{class:!0});var p=children(e);d&&d.l(p),p.forEach(detach),this.h()},h(){attr(e,"class","absolute will-change-transform contain-[size_layout]"),toggle_class(e,"transition-transform",r[12].back),set_style(e,"transform",t),set_style(e,"width",n),set_style(e,"height",s)},m(h,p){insert_hydration(h,e,p),d&&d.m(e,null),a=!0},p(h,p){d&&d.p&&(!a||p[0]&4096|p[1]&1024)&&update_slot_base(d,c,h,h[41],a?get_slot_changes(c,h[41],p,get_default_slot_changes_1):get_all_dirty_from_scope(h[41]),get_default_slot_context_1),(!a||p[0]&4096)&&toggle_class(e,"transition-transform",h[12].back),p[0]&4833&&t!==(t=`translate3d(
          ${h[12].back?h[12].back.x:h[9].x+Math.max(h[12].offset.x,-h[5].width/h[7]+h[0])}px,
          ${h[12].back?h[12].back.y:h[9].y+Math.max(h[12].offset.y,-h[6]+h[0])}px, 0)`)&&set_style(e,"transform",t),p[0]&161&&n!==(n=`${h[5].width/h[7]-h[0]}px`)&&set_style(e,"width",n),p[0]&65&&s!==(s=`${h[6]-h[0]}px`)&&set_style(e,"height",s)},i(h){a||(transition_in(d,h),a=!0)},o(h){transition_out(d,h),a=!1},d(h){h&&detach(e),d&&d.d(h)}}}function create_default_slot$1(r){var s;let e,t,n=((s=r[12])==null?void 0:s.owner)===r[4]&&create_if_block_1$2(r);return{c(){n&&n.c(),e=empty$1()},l(a){n&&n.l(a),e=empty$1()},m(a,c){n&&n.m(a,c),insert_hydration(a,e,c),t=!0},p(a,c){var d;((d=a[12])==null?void 0:d.owner)===a[4]?n?(n.p(a,c),c[0]&4112&&transition_in(n,1)):(n=create_if_block_1$2(a),n.c(),transition_in(n,1),n.m(e.parentNode,e)):n&&(group_outros(),transition_out(n,1,1,()=>{n=null}),check_outros())},i(a){t||(transition_in(n),t=!0)},o(a){transition_out(n),t=!1},d(a){n&&n.d(a),a&&detach(e)}}}function create_fragment$4(r){let e,t,n,s=`translateY(${+!!r[8]*r[1]*100}%)`,a=`${r[14]}px`,c,d=[],h=new Map_1,p=`translate3d(0,${Math.ceil(r[10]/r[7])*r[6]}px,0)`,N=`${r[0]}px`,O,A=`${r[11]}px`,R,x,m,w=r[16];const y=g=>g[2](g[53])==null?g[55]:g[2](g[53]);for(let g=0;g<w.length;g+=1){let W=get_each_context(r,w,g),z=y(W);h.set(z,d[g]=create_each_block(z,W))}let _=r[3]&&create_if_block$3(r);return{c(){e=element("div"),t=element("div"),n=element("div"),c=space();for(let g=0;g<d.length;g+=1)d[g].c();O=space(),_&&_.c(),this.h()},l(g){e=claim_element(g,"DIV",{class:!0});var W=children(e);t=claim_element(W,"DIV",{class:!0});var z=children(t);n=claim_element(z,"DIV",{class:!0,"aria-hidden":!0}),children(n).forEach(detach),c=claim_space(z);for(let X=0;X<d.length;X+=1)d[X].l(z);z.forEach(detach),O=claim_space(W),_&&_.l(W),W.forEach(detach),this.h()},h(){attr(n,"class","absolute z-50 w-0.5"),attr(n,"aria-hidden",""),set_style(n,"transform",s),set_style(n,"height",a),attr(t,"class","grid auto-rows-max will-change-transform contain-layout"),toggle_class(t,"pointer-events-none",!!r[12]),set_style(t,"transform",p),set_style(t,"grid-template-columns",r[15]),set_style(t,"gap",N),attr(e,"class","shrink-0 contain-[size_layout]"),set_style(e,"height",A)},m(g,W){insert_hydration(g,e,W),append_hydration(e,t),append_hydration(t,n),append_hydration(t,c);for(let z=0;z<d.length;z+=1)d[z]&&d[z].m(t,null);r[40](t),append_hydration(e,O),_&&_.m(e,null),R=!0,x||(m=[listen(window,"dragstart",r[18]),listen(window,"dragend",r[19]),listen(n,"intersect",r[38]),listen(n,"viewleave",r[39]),action_destroyer(intersection.call(null,n)),action_destroyer(drag.call(null,t,"hold")),action_destroyer(hold.call(null,t))],x=!0)},p(g,W){W[0]&258&&s!==(s=`translateY(${+!!g[8]*g[1]*100}%)`)&&set_style(n,"transform",s),W[0]&16384&&a!==(a=`${g[14]}px`)&&set_style(n,"height",a),W[0]&70684|W[1]&1024&&(w=g[16],group_outros(),d=update_keyed_each(d,W,y,1,g,w,h,t,outro_and_destroy_block,create_each_block,null,get_each_context),check_outros()),(!R||W[0]&4096)&&toggle_class(t,"pointer-events-none",!!g[12]),W[0]&1216&&p!==(p=`translate3d(0,${Math.ceil(g[10]/g[7])*g[6]}px,0)`)&&set_style(t,"transform",p),W[0]&32768&&set_style(t,"grid-template-columns",g[15]),W[0]&1&&N!==(N=`${g[0]}px`)&&set_style(t,"gap",N),g[3]?_?(_.p(g,W),W[0]&8&&transition_in(_,1)):(_=create_if_block$3(g),_.c(),transition_in(_,1),_.m(e,null)):_&&(group_outros(),transition_out(_,1,1,()=>{_=null}),check_outros()),W[0]&2048&&A!==(A=`${g[11]}px`)&&set_style(e,"height",A)},i(g){if(!R){for(let W=0;W<w.length;W+=1)transition_in(d[W]);transition_in(_),R=!0}},o(g){for(let W=0;W<d.length;W+=1)transition_out(d[W]);transition_out(_),R=!1},d(g){g&&detach(e);for(let W=0;W<d.length;W+=1)d[W].d();r[40](null),_&&_.d(),x=!1,run_all(m)}}}let transfer=writable(null);function instance$5(r,e,t){let n,s,a,c,d,h,p,N,O,A,R,x,m,w,y,_,g;component_subscribe(r,transfer,M=>t(12,g=M));let{$$slots:W={},$$scope:z}=e;const X=createEventDispatcher();let{gap:Z=0}=e,{items:j}=e,{move:le=!1}=e,{fixed:Q=!1}=e,{overthrow:U=1}=e,{prerender:P=1}=e,{columns:V=1}=e,{key:te=M=>M}=e,{animate:ne=!1}=e,{sortable:B=!1}=e,{container:G=void 0}=e,ae=null,je=new DOMRect,Le=new DOMRect,lt=!1,At=!1,Ye=1,ze=0,Qe=0;function cr(M=(he=>(he=ae==null?void 0:ae.firstElementChild)==null?void 0:he.getBoundingClientRect())()){!O||!M||(t(8,Qe-=Math.round((M.y-je.y)/O)),!At&&Qe>=c-1&&(X("end"),At=!0))}function vt(M){if(!h&&M.length&&tick().then(Wt),!ne||!M.length)return;const he=new Map;for(let de=0;de<M.length;de++){const Ae=te(M[de]);if(Ae==null||(he.set(Ae,de),(g==null?void 0:g.owner)===ae&&Ae===(g==null?void 0:g.key))||de<s||de>=a)continue;const We=h==null?void 0:h.get(Ae);if(We==null)continue;const $r=~~(We/ze)-~~(de/ze),Ur=~~(We%ze)-~~(de%ze);($r||Ur)&&Tn(We,Ur,$r)}return he}function Tn(M,he,de){const Ae=ae==null?void 0:ae.children.item(M-s+1);if(!Ae||Ae.style.visibility==="hidden")return;const We=[`translate3d(${he*100}%,${de*100}%,0)`,"translate3d(0,0,0)"];Ae.animate({transform:We,zIndex:["100","100"]},{easing:"ease",composite:"accumulate",duration:p})}function Wt(){var Ae,We;if(!G||!ae)return;t(5,Le=(Ae=ae.parentElement)==null?void 0:Ae.getBoundingClientRect()),t(27,je=G.getBoundingClientRect()),t(5,Le.y+=G.scrollTop,Le),t(5,Le.width+=Z,Le);const M=(We=ae.firstElementChild)==null?void 0:We.nextElementSibling;if(!M)return;const{width:he,height:de}=M.getBoundingClientRect();!he||!de||(t(7,ze=~~(Le.width/(he+Z))),t(6,Ye=de+Z))}let It,bt,Lt={x:0,y:0},Y={x:0,y:0};async function Oe({target:M}){if(Wt(),await tick(),!B||!ae||!M||g||M.parentElement!==ae||j[_]==null||te(j[_])==null)return;bt=_,It=le?-1:bt;const he=M.getBoundingClientRect();he.x-=Lt.x,he.y-=Lt.y,set_store_value(transfer,g={group:B===!0?ae:B,key:te(j[_]),data:j[_],owner:ae,offset:he},g)}function Mr(M,he=!1){if(!B||!g||Q||te(j[M])==null)return;if(!Number.isInteger(M)){It!=null&&g.owner!==ae&&(Mr(It,!0),It=void 0);return}if(te(j[M])===g.key)return;M<0&&!j.length&&(M=0);const de=j.findIndex(Ae=>te(Ae)===(g==null?void 0:g.key));de!==M&&(!he&&It==null&&(It=de,bt=de),~de&&j.splice(de,1),~M&&j.splice(M,0,g.data),requestAnimationFrame(()=>t(20,j))),!he&&ae&&set_store_value(transfer,g.owner=ae,g)}async function dr(){if(!B||!g||bt==null)return;const M=j.findIndex(he=>te(he)===(g==null?void 0:g.key));if(g.owner===ae&&~M){const he=ae.children.item(M-s+1);he&&(set_store_value(transfer,g.back=he.getBoundingClientRect(),g),set_store_value(transfer,g.group=Math.random().toString(),g),await new Promise(de=>setTimeout(de,150)))}if(bt!==M){const he=g.data,de=j[M-1],Ae=(+!!~bt<<1)+ +!!~M,We=[void 0,"push","purge","rearrange"][Ae];We&&X("edit",{action:We,index:M,after:de,item:he})}bt=void 0,It=void 0,g.owner===ae&&set_store_value(transfer,g=null,g)}onMount(()=>{const M=debounce(()=>lt||cr(),100);function he(){M(),B&&(t(28,Y.x=(G==null?void 0:G.scrollLeft)||0,Y),t(28,Y.y=(G==null?void 0:G.scrollTop)||0,Y))}G||t(21,G=getScrollParent(ae));const de=B&&position$1.subscribe(We=>t(9,Lt=We));G.addEventListener("scroll",he),G.addEventListener("resize",Wt);const{destroy:Ae}=resize(G);return()=>{G==null||G.removeEventListener("scroll",he),G==null||G.removeEventListener("resize",Wt),de&&de(),Ae()}});const Te=M=>t(13,lt=M.detail.isIntersecting),ot=M=>cr(M.detail.boundingClientRect);function vn(M){binding_callbacks[M?"unshift":"push"](()=>{ae=M,t(4,ae)})}return r.$$set=M=>{"gap"in M&&t(0,Z=M.gap),"items"in M&&t(20,j=M.items),"move"in M&&t(22,le=M.move),"fixed"in M&&t(23,Q=M.fixed),"overthrow"in M&&t(1,U=M.overthrow),"prerender"in M&&t(24,P=M.prerender),"columns"in M&&t(25,V=M.columns),"key"in M&&t(2,te=M.key),"animate"in M&&t(26,ne=M.animate),"sortable"in M&&t(3,B=M.sortable),"container"in M&&t(21,G=M.container),"$$scope"in M&&t(41,z=M.$$scope)},r.$$.update=()=>{r.$$.dirty[0]&134217920&&t(36,n=Math.ceil(je.height/Ye)*ze),r.$$.dirty[0]&258|r.$$.dirty[1]&32&&t(10,s=Math.max(Qe-U,0)*n),r.$$.dirty[0]&16777474|r.$$.dirty[1]&32&&t(35,a=Math.max((Qe+U+1)*n,P)),r.$$.dirty[0]&1048576|r.$$.dirty[1]&32&&(c=~~(j.length/n)),r.$$.dirty[0]&1049600|r.$$.dirty[1]&16&&t(16,d=j.slice(s,a)),r.$$.dirty[0]&1048576&&(h=vt(j)),r.$$.dirty[0]&67108864&&(p=ne===!0?300:ne||0),r.$$.dirty[0]&1048769&&t(11,N=Math.ceil(j.length/ze)*Ye-Z),r.$$.dirty[0]&192|r.$$.dirty[1]&32&&t(14,O=n/ze*Ye),r.$$.dirty[0]&33554432&&t(15,A=Number.isInteger(V)?`repeat(${V},1fr)`:`repeat(auto-fill,minmax(min(100%,${V}),1fr))`),r.$$.dirty[0]&2048&&Number.isFinite(N)&&(tick().then(Wt),At=!1),r.$$.dirty[0]&24&&t(30,R=B===!0?ae:B),r.$$.dirty[0]&402653729&&t(34,x=minmax(Lt.y+Z/2,je.top,je.bottom,NaN)+Y.y-Le.y),r.$$.dirty[0]&268436001&&t(33,m=minmax(Lt.x+Z/2,Le.left,Le.right-Z-1,NaN)+Y.x-Le.x),r.$$.dirty[0]&64|r.$$.dirty[1]&8&&t(32,w=Math.floor(x/Ye)),r.$$.dirty[0]&160|r.$$.dirty[1]&4&&t(31,y=Math.floor(m/(Le.width/ze))),r.$$.dirty[0]&1048704|r.$$.dirty[1]&3&&t(29,_=minmax(w*ze+y,0,j.length-1)),r.$$.dirty[0]&1610616832&&(g==null?void 0:g.group)===R&&Mr(_)},[Z,U,te,B,ae,Le,Ye,ze,Qe,Lt,s,N,g,lt,O,A,d,cr,Oe,dr,j,G,le,Q,P,V,ne,je,Y,_,R,y,w,m,x,a,n,W,Te,ot,vn,z]}class Virtual extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$5,create_fragment$4,safe_not_equal,{gap:0,items:20,move:22,fixed:23,overthrow:1,prerender:24,columns:25,key:2,animate:26,sortable:3,container:21},null,[-1,-1])}}const get_after_slot_changes=r=>({}),get_after_slot_context=r=>({}),get_before_slot_changes=r=>({}),get_before_slot_context=r=>({});function create_if_block_1$1(r){let e,t;const n=r[9].before,s=create_slot(n,r,r[8],get_before_slot_context);return{c(){e=element("div"),s&&s.c(),this.h()},l(a){e=claim_element(a,"DIV",{class:!0});var c=children(e);s&&s.l(c),c.forEach(detach),this.h()},h(){attr(e,"class","z-20 flex items-center")},m(a,c){insert_hydration(a,e,c),s&&s.m(e,null),t=!0},p(a,c){s&&s.p&&(!t||c&256)&&update_slot_base(s,n,a,a[8],t?get_slot_changes(n,a[8],c,get_before_slot_changes):get_all_dirty_from_scope(a[8]),get_before_slot_context)},i(a){t||(transition_in(s,a),t=!0)},o(a){transition_out(s,a),t=!1},d(a){a&&detach(e),s&&s.d(a)}}}function create_if_block$2(r){let e;return{c(){e=element("hr"),this.h()},l(t){e=claim_element(t,"HR",{"aria-hidden":!0,class:!0}),this.h()},h(){attr(e,"aria-hidden",""),attr(e,"class","absolute bottom-0 h-[1px] w-full border-none bg-content/10 group-last-of-type:opacity-0")},m(t,n){insert_hydration(t,e,n)},d(t){t&&detach(e)}}}function create_dynamic_element(r){let e,t,n,s,a,c,d,h,p,N,O,A,R,x,m,w,y,_,g,W,z,X,Z,j=r[7].before&&create_if_block_1$1(r);const le=r[9].default,Q=create_slot(le,r,r[8],null);let U=r[2]&&(r[1]||r[0])&&create_if_block$2();x=new Icon({props:{name:"circle"}}),y=new Icon({props:{name:"target"}});const P=r[9].after,V=create_slot(P,r,r[8],get_after_slot_context);let te=[{href:r[5]},{draggable:"false"},{class:W="group relative z-10 flex w-full items-center gap-4 overflow-hidden px-4 outline-2 -outline-offset-2 outline-primary-600 contain-inline-size focus-visible:outline "+(r[4]?"cursor-pointer touch-manipulation select-none "+(r[2]?"":"transition-transform active:scale-95"):"")+" "+(r[0]?"focus-visible:z-50":r[1]?"rounded-lg py-1 focus-visible:z-50":"rounded-2xl py-4")+" "+(r[2]?"bg-surface":"bg-surface-100 shadow-[0_0_20px_-4px] shadow-black/20 dark:shadow-none")}],ne={};for(let B=0;B<te.length;B+=1)ne=assign$1(ne,te[B]);return{c(){e=element(r[4]?r[5]?"a":"button":"article"),t=element("div"),n=space(),s=element("div"),c=space(),j&&j.c(),d=space(),h=element("div"),Q&&Q.c(),p=space(),U&&U.c(),O=space(),A=element("div"),R=element("div"),create_component(x.$$.fragment),m=space(),w=element("div"),create_component(y.$$.fragment),_=space(),g=element("div"),V&&V.c(),this.h()},l(B){e=claim_element(B,((r[4]?r[5]?"a":"button":"article")||"null").toUpperCase(),{href:!0,draggable:!0,class:!0});var G=children(e);t=claim_element(G,"DIV",{"aria-hidden":!0,class:!0}),children(t).forEach(detach),n=claim_space(G),s=claim_element(G,"DIV",{"aria-hidden":!0,class:!0}),children(s).forEach(detach),c=claim_space(G),j&&j.l(G),d=claim_space(G),h=claim_element(G,"DIV",{class:!0});var ae=children(h);Q&&Q.l(ae),p=claim_space(ae),U&&U.l(ae),ae.forEach(detach),O=claim_space(G),A=claim_element(G,"DIV",{class:!0});var je=children(A);R=claim_element(je,"DIV",{class:!0});var Le=children(R);claim_component(x.$$.fragment,Le),Le.forEach(detach),m=claim_space(je),w=claim_element(je,"DIV",{class:!0});var lt=children(w);claim_component(y.$$.fragment,lt),lt.forEach(detach),_=claim_space(je),g=claim_element(je,"DIV",{class:!0});var At=children(g);V&&V.l(At),At.forEach(detach),je.forEach(detach),G.forEach(detach),this.h()},h(){attr(t,"aria-hidden",""),attr(t,"class","pointer-events-none absolute inset-0 -z-10 bg-primary-200/30 opacity-0 transition-opacity"),toggle_class(t,"opacity-100",r[6]===!0),attr(s,"aria-hidden",""),attr(s,"class",a="pointer-events-none absolute inset-0 z-0 bg-highlight opacity-0 "+(r[4]?"group-hover:opacity-30 "+(r[2]?"dark:group-hover:opacity-50":"dark:group-hover:opacity-10"):"")),attr(h,"class",N="z-10 grid w-full grid-cols-1 items-baseline overflow-hidden contain-inline-size "+(r[1]||r[0]?"justify-start gap-0.5":"place-items-center justify-center gap-2")+" "+((r[1]||r[0])&&r[3]?"lg:auto-cols-fr lg:grid-flow-col lg:gap-4":"")),attr(R,"class","flex justify-center text-primary-600 opacity-0 transition-opacity"),toggle_class(R,"opacity-100",r[6]),attr(w,"class","flex scale-0 justify-center text-primary-600 transition-transform"),toggle_class(w,"scale-100",r[6]===!0),attr(g,"class","opacity-0 transition-opacity"),toggle_class(g,"opacity-100",!r[6]),attr(A,"class","z-20 grid items-center [&>*]:col-start-1 [&>*]:row-start-1"),set_dynamic_element_data(r[4]?r[5]?"a":"button":"article")(e,ne)},m(B,G){insert_hydration(B,e,G),append_hydration(e,t),append_hydration(e,n),append_hydration(e,s),append_hydration(e,c),j&&j.m(e,null),append_hydration(e,d),append_hydration(e,h),Q&&Q.m(h,null),append_hydration(h,p),U&&U.m(h,null),append_hydration(e,O),append_hydration(e,A),append_hydration(A,R),mount_component(x,R,null),append_hydration(A,m),append_hydration(A,w),mount_component(y,w,null),append_hydration(A,_),append_hydration(A,g),V&&V.m(g,null),z=!0,X||(Z=[listen(e,"click",r[10]),listen(e,"contextmenu",r[11])],X=!0)},p(B,G){(!z||G&64)&&toggle_class(t,"opacity-100",B[6]===!0),(!z||G&20&&a!==(a="pointer-events-none absolute inset-0 z-0 bg-highlight opacity-0 "+(B[4]?"group-hover:opacity-30 "+(B[2]?"dark:group-hover:opacity-50":"dark:group-hover:opacity-10"):"")))&&attr(s,"class",a),B[7].before?j?(j.p(B,G),G&128&&transition_in(j,1)):(j=create_if_block_1$1(B),j.c(),transition_in(j,1),j.m(e,d)):j&&(group_outros(),transition_out(j,1,1,()=>{j=null}),check_outros()),Q&&Q.p&&(!z||G&256)&&update_slot_base(Q,le,B,B[8],z?get_slot_changes(le,B[8],G,null):get_all_dirty_from_scope(B[8]),null),B[2]&&(B[1]||B[0])?U||(U=create_if_block$2(),U.c(),U.m(h,null)):U&&(U.d(1),U=null),(!z||G&11&&N!==(N="z-10 grid w-full grid-cols-1 items-baseline overflow-hidden contain-inline-size "+(B[1]||B[0]?"justify-start gap-0.5":"place-items-center justify-center gap-2")+" "+((B[1]||B[0])&&B[3]?"lg:auto-cols-fr lg:grid-flow-col lg:gap-4":"")))&&attr(h,"class",N),(!z||G&64)&&toggle_class(R,"opacity-100",B[6]),(!z||G&64)&&toggle_class(w,"scale-100",B[6]===!0),V&&V.p&&(!z||G&256)&&update_slot_base(V,P,B,B[8],z?get_slot_changes(P,B[8],G,get_after_slot_changes):get_all_dirty_from_scope(B[8]),get_after_slot_context),(!z||G&64)&&toggle_class(g,"opacity-100",!B[6]),set_dynamic_element_data(B[4]?B[5]?"a":"button":"article")(e,ne=get_spread_update(te,[(!z||G&32)&&{href:B[5]},{draggable:"false"},(!z||G&23&&W!==(W="group relative z-10 flex w-full items-center gap-4 overflow-hidden px-4 outline-2 -outline-offset-2 outline-primary-600 contain-inline-size focus-visible:outline "+(B[4]?"cursor-pointer touch-manipulation select-none "+(B[2]?"":"transition-transform active:scale-95"):"")+" "+(B[0]?"focus-visible:z-50":B[1]?"rounded-lg py-1 focus-visible:z-50":"rounded-2xl py-4")+" "+(B[2]?"bg-surface":"bg-surface-100 shadow-[0_0_20px_-4px] shadow-black/20 dark:shadow-none")))&&{class:W}]))},i(B){z||(transition_in(j),transition_in(Q,B),transition_in(x.$$.fragment,B),transition_in(y.$$.fragment,B),transition_in(V,B),z=!0)},o(B){transition_out(j),transition_out(Q,B),transition_out(x.$$.fragment,B),transition_out(y.$$.fragment,B),transition_out(V,B),z=!1},d(B){B&&detach(e),j&&j.d(),Q&&Q.d(B),U&&U.d(),destroy_component(x),destroy_component(y),V&&V.d(B),X=!1,run_all(Z)}}}function create_fragment$3(r){let e=r[4]?r[5]?"a":"button":"article",t,n,s=(r[4]?r[5]?"a":"button":"article")&&create_dynamic_element(r);return{c(){s&&s.c(),t=empty$1()},l(a){s&&s.l(a),t=empty$1()},m(a,c){s&&s.m(a,c),insert_hydration(a,t,c),n=!0},p(a,[c]){!a[4]||a[5],e?safe_not_equal(e,a[4]?a[5]?"a":"button":"article")?(s.d(1),s=create_dynamic_element(a),e=a[4]?a[5]?"a":"button":"article",s.c(),s.m(t.parentNode,t)):s.p(a,c):(s=create_dynamic_element(a),e=a[4]?a[5]?"a":"button":"article",s.c(),s.m(t.parentNode,t))},i(a){n||(transition_in(s),n=!0)},o(a){transition_out(s),n=!1},d(a){a&&detach(t),s&&s.d(a)}}}function instance$4(r,e,t){let{$$slots:n={},$$scope:s}=e;const a=compute_slots(n);let{xs:c=!1}=e,{sm:d=!1}=e,{flat:h=!1}=e,{flow:p=!1}=e,{interactive:N=!1}=e,{href:O=void 0}=e,{selected:A=!1}=e;function R(m){bubble.call(this,r,m)}function x(m){bubble.call(this,r,m)}return r.$$set=m=>{"xs"in m&&t(0,c=m.xs),"sm"in m&&t(1,d=m.sm),"flat"in m&&t(2,h=m.flat),"flow"in m&&t(3,p=m.flow),"interactive"in m&&t(4,N=m.interactive),"href"in m&&t(5,O=m.href),"selected"in m&&t(6,A=m.selected),"$$scope"in m&&t(8,s=m.$$scope)},[c,d,h,p,N,O,A,a,s,n,R,x]}class Card extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$4,create_fragment$3,safe_not_equal,{xs:0,sm:1,flat:2,flow:3,interactive:4,href:5,selected:6})}}function create_fragment$2(r){let e,t,n;const s=r[6].default,a=create_slot(s,r,r[5],null);return{c(){e=element("span"),a&&a.c(),this.h()},l(c){e=claim_element(c,"SPAN",{class:!0});var d=children(e);a&&a.l(d),d.forEach(detach),this.h()},h(){attr(e,"class",t="w-max max-w-full overflow-hidden text-ellipsis whitespace-nowrap rounded-md text-left [&>*]:align-bottom "+(r[1]?"animate-pulse bg-highlight text-transparent":"")+" "+(r[2]?"font-medium":"font-normal")),toggle_class(e,"text-content-200",r[0]),toggle_class(e,"ml-4",r[3]),toggle_class(e,"text-sm",r[4])},m(c,d){insert_hydration(c,e,d),a&&a.m(e,null),n=!0},p(c,[d]){a&&a.p&&(!n||d&32)&&update_slot_base(a,s,c,c[5],n?get_slot_changes(s,c[5],d,null):get_all_dirty_from_scope(c[5]),null),(!n||d&6&&t!==(t="w-max max-w-full overflow-hidden text-ellipsis whitespace-nowrap rounded-md text-left [&>*]:align-bottom "+(c[1]?"animate-pulse bg-highlight text-transparent":"")+" "+(c[2]?"font-medium":"font-normal")))&&attr(e,"class",t),(!n||d&7)&&toggle_class(e,"text-content-200",c[0]),(!n||d&14)&&toggle_class(e,"ml-4",c[3]),(!n||d&22)&&toggle_class(e,"text-sm",c[4])},i(c){n||(transition_in(a,c),n=!0)},o(c){transition_out(a,c),n=!1},d(c){c&&detach(e),a&&a.d(c)}}}function instance$3(r,e,t){let{$$slots:n={},$$scope:s}=e,{secondary:a=!1}=e,{loading:c=!1}=e,{accent:d=!1}=e,{indent:h=!1}=e,{sm:p=!1}=e;return r.$$set=N=>{"secondary"in N&&t(0,a=N.secondary),"loading"in N&&t(1,c=N.loading),"accent"in N&&t(2,d=N.accent),"indent"in N&&t(3,h=N.indent),"sm"in N&&t(4,p=N.sm),"$$scope"in N&&t(5,s=N.$$scope)},[a,c,d,h,p,s,n]}class Text extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$3,create_fragment$2,safe_not_equal,{secondary:0,loading:1,accent:2,indent:3,sm:4})}}function create_if_block_1(r){let e;const t=r[7].default,n=create_slot(t,r,r[6],null);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,a){n&&n.p&&(!e||a&64)&&update_slot_base(n,t,s,s[6],e?get_slot_changes(t,s[6],a,null):get_all_dirty_from_scope(s[6]),null)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}function create_if_block$1(r){let e,t,n,s,a,c;return{c(){e=element("img"),this.h()},l(d){e=claim_element(d,"IMG",{alt:!0,src:!0,class:!0,loading:!0,width:!0,height:!0,draggable:!0}),this.h()},h(){attr(e,"alt",r[3]),src_url_equal(e.src,t=r[2]<100/devicePixelRatio?r[0]:r[1])||attr(e,"src",t),attr(e,"class","opacity-0 transition-opacity duration-500"),attr(e,"loading","lazy"),attr(e,"width",n=r[2]+"px"),attr(e,"height",s=r[2]+"px"),attr(e,"draggable","false"),toggle_class(e,"opacity-100",r[5]==="ok")},m(d,h){insert_hydration(d,e,h),r[8](e),a||(c=[listen(e,"load",r[9]),listen(e,"error",r[10])],a=!0)},p(d,h){h&8&&attr(e,"alt",d[3]),h&7&&!src_url_equal(e.src,t=d[2]<100/devicePixelRatio?d[0]:d[1])&&attr(e,"src",t),h&4&&n!==(n=d[2]+"px")&&attr(e,"width",n),h&4&&s!==(s=d[2]+"px")&&attr(e,"height",s),h&32&&toggle_class(e,"opacity-100",d[5]==="ok")},i:noop$2,o:noop$2,d(d){d&&detach(e),r[8](null),a=!1,run_all(c)}}}function create_fragment$1(r){let e,t,n,s,a=`${r[2]}px`,c=`${r[2]}px`,d;const h=[create_if_block$1,create_if_block_1],p=[];function N(O,A){return O[1]&&O[5]!=="error"?0:O[5]==="error"?1:-1}return~(t=N(r))&&(n=p[t]=h[t](r)),{c(){e=element("div"),n&&n.c(),this.h()},l(O){e=claim_element(O,"DIV",{class:!0});var A=children(e);n&&n.l(A),A.forEach(detach),this.h()},h(){attr(e,"class",s="overflow-hidden "+(r[2]>200?"rounded-2xl":"rounded")+" bg-highlight-100"),toggle_class(e,"animate-pulse",r[5]==="loading"),set_style(e,"height",a),set_style(e,"width",c)},m(O,A){insert_hydration(O,e,A),~t&&p[t].m(e,null),d=!0},p(O,[A]){let R=t;t=N(O),t===R?~t&&p[t].p(O,A):(n&&(group_outros(),transition_out(p[R],1,1,()=>{p[R]=null}),check_outros()),~t?(n=p[t],n?n.p(O,A):(n=p[t]=h[t](O),n.c()),transition_in(n,1),n.m(e,null)):n=null),(!d||A&4&&s!==(s="overflow-hidden "+(O[2]>200?"rounded-2xl":"rounded")+" bg-highlight-100"))&&attr(e,"class",s),(!d||A&36)&&toggle_class(e,"animate-pulse",O[5]==="loading"),A&4&&a!==(a=`${O[2]}px`)&&set_style(e,"height",a),A&4&&c!==(c=`${O[2]}px`)&&set_style(e,"width",c)},i(O){d||(transition_in(n),d=!0)},o(O){transition_out(n),d=!1},d(O){O&&detach(e),~t&&p[t].d()}}}function instance$2(r,e,t){let n,{$$slots:s={},$$scope:a}=e,{thumbnail:c=void 0}=e,{src:d=void 0}=e,{size:h=48}=e,{alt:p=""}=e,N;onMount(()=>(N==null?void 0:N.complete)&&t(4,N.style.opacity="1",N));function O(x){binding_callbacks[x?"unshift":"push"](()=>{N=x,t(4,N)})}const A=()=>t(5,n="ok"),R=()=>t(5,n="error");return r.$$set=x=>{"thumbnail"in x&&t(0,c=x.thumbnail),"src"in x&&t(1,d=x.src),"size"in x&&t(2,h=x.size),"alt"in x&&t(3,p=x.alt),"$$scope"in x&&t(6,a=x.$$scope)},r.$$.update=()=>{r.$$.dirty&2&&t(5,n=d===""||d===null?"error":"loading")},[c,d,h,p,N,n,a,s,O,A,R]}class Image extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$2,create_fragment$1,safe_not_equal,{thumbnail:0,src:1,size:2,alt:3})}}function capitalize(r,e=!0){return r&&(e?r.replace(/\b\w/g,t=>t.toUpperCase()):r.replace(/\b\w/,t=>t.toUpperCase()))}function clean(r){return r.normalize().trim().toLowerCase().replace(/\s+/g," ")}const __vite_glob_0_0=`CREATE TRIGGER IF NOT EXISTS cascade_playlists_library
AFTER DELETE ON playlists
FOR EACH ROW
BEGIN
  DELETE FROM library WHERE playlist = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_library_tracks
AFTER DELETE ON library
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM library 
    WHERE track = OLD.track 
  UNION ALL SELECT 1 FROM playback
    WHERE track = OLD.track
  LIMIT 1
)
BEGIN
  DELETE FROM tracks WHERE id = OLD.track;
END;

CREATE TRIGGER IF NOT EXISTS cascade_playback_tracks
AFTER DELETE ON playback
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM library
    WHERE track = OLD.track
  UNION ALL SELECT 1 FROM playback
    WHERE track = OLD.track
  LIMIT 1
)
BEGIN
  DELETE FROM tracks WHERE id = OLD.track;
END;

CREATE TRIGGER IF NOT EXISTS cascade_tracks_albums
AFTER DELETE ON tracks
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM tracks WHERE album = OLD.album LIMIT 1
)
BEGIN
  DELETE FROM albums WHERE id = OLD.album;
END;

CREATE TRIGGER IF NOT EXISTS cascade_albums_attribution
AFTER DELETE ON albums
FOR EACH ROW
BEGIN
  DELETE FROM attribution WHERE album = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_attribution_artists
AFTER DELETE ON attribution
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM attribution
    WHERE artist = OLD.artist
)
BEGIN
  DELETE FROM artists WHERE id = OLD.artist;
END;

CREATE TRIGGER IF NOT EXISTS cascade_tracks_resources
AFTER DELETE ON tracks
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_albums_resources
AFTER DELETE ON albums
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
  DELETE FROM assets WHERE owner = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_artists_resources
AFTER DELETE ON artists
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
  DELETE FROM assets WHERE owner = OLD.id;
END;
`,__vite_glob_0_1=`CREATE VIRTUAL TABLE IF NOT EXISTS tracks_fts USING fts5 (
  title,
  album,
  artists,
  content='',
  tokenize='trigram'
);

CREATE VIRTUAL TABLE IF NOT EXISTS albums_fts USING fts5 (
  title,
  artists,
  content='',
  tokenize='trigram'
);

CREATE VIRTUAL TABLE IF NOT EXISTS artists_fts USING fts5 (
  title,
  content='',
  tokenize='trigram'
);

---------------------------- Artists Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_artists_insert AFTER INSERT ON artists BEGIN
  -- Update artists index
  INSERT INTO artists_fts(rowid,title) VALUES (NEW.id, NEW.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title,
      CASE WHEN EXISTS (SELECT 1 FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id) THEN albums.title ELSE NULL END,
      (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS fts_artists_update AFTER UPDATE OF title ON artists WHEN (OLD.title IS NOT NEW.title) BEGIN
  -- Update artists index
  INSERT INTO artists_fts(artists_fts,rowid,title) VALUES ('delete', OLD.id, OLD.title);
  INSERT INTO artists_fts(rowid,title) VALUES (NEW.id, NEW.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(CASE WHEN artists.id = OLD.id THEN OLD.title ELSE title END) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = OLD.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(CASE WHEN artists.id = OLD.id THEN OLD.title ELSE title END) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = OLD.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS fts_artists_delete BEFORE DELETE ON artists BEGIN
  -- Update artists index
  INSERT INTO artists_fts(artists_fts,rowid,title) VALUES ('delete', OLD.id, OLD.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = OLD.id;
END;

---------------------------- Albums Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_albums_insert AFTER INSERT ON albums BEGIN
  -- Update albums index
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT NEW.id, NEW.title, group_concat(artists.title)
    FROM attribution
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE attribution.album = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, NULL, NULL
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS albums_fts_update AFTER UPDATE OF title ON albums WHEN (OLD.title IS NOT NEW.title) BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', OLD.id, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
    WHERE attribution.album = OLD.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT NEW.id, NEW.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
    WHERE attribution.album = OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = OLD.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, NEW.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS albums_fts_delete BEFORE DELETE ON albums BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', OLD.id, OLD.title, group_concat(artists.title)
    FROM attribution
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE attribution.album = OLD.id
    GROUP BY OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = OLD.id;
END;

---------------------------- Attribution Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_attribution_insert AFTER INSERT ON attribution
  WHEN EXISTS (SELECT 1 FROM artists WHERE id = NEW.artist) AND EXISTS (SELECT 1 FROM albums WHERE id = NEW.album)
BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, NULL, NULL
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT  tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
END;

CREATE TRIGGER IF NOT EXISTS fts_attribution_delete BEFORE DELETE ON attribution BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = OLD.album AND attribution.artist = OLD.artist;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = OLD.album AND attribution.artist = OLD.artist;
END;

---------------------------- Tracks Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_tracks_insert AFTER INSERT ON tracks BEGIN
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT NEW.id, NEW.title, albums.title, group_concat(artists.title)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE albums.id = NEW.album;
END;

CREATE TRIGGER IF NOT EXISTS fts_tracks_update AFTER UPDATE OF title ON tracks WHEN (OLD.title IS NOT NEW.title) BEGIN
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', OLD.id, OLD.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
    WHERE albums.id = OLD.album;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT NEW.id, NEW.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
    WHERE albums.id = NEW.album;
END;

CREATE TRIGGER IF NOT EXISTS fts_tracks_delete BEFORE DELETE ON tracks BEGIN
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', OLD.id, OLD.title, albums.title, group_concat(artists.title)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE albums.id = OLD.album
    GROUP BY OLD.id;
END;`,__vite_glob_0_2=`INSERT OR IGNORE INTO devices VALUES (crsql_siteid(), -1, 0, 0, 0, 0);

CREATE VIEW IF NOT EXISTS queue AS
  WITH ordered AS
    (SELECT playback.*, row_number() OVER (
      ORDER BY
        CASE WHEN "direction" != 1 THEN "order" ELSE NULL END ASC,
        CASE WHEN "direction" = 1 THEN "order" ELSE NULL END DESC,
        CASE WHEN "direction" != 1 THEN "playback"."id" ELSE NULL END ASC,
        CASE WHEN "direction" = 1 THEN "playback"."id" ELSE NULL END DESC
    ) as position FROM devices INNER JOIN playback ON playback.device = devices.id
    WHERE devices.id = crsql_siteid())
  SELECT id, device, track, 
    (position - 
      (SELECT position FROM ordered WHERE id = (SELECT playback FROM devices WHERE id = device))
    ) as position
  FROM ordered;

CREATE TRIGGER IF NOT EXISTS playback_started
BEFORE INSERT ON playback
FOR EACH ROW
WHEN NEW.device = crsql_siteid()
BEGIN
  UPDATE devices SET playback = NEW.id WHERE id = NEW.device AND playback IS -1;
END;

CREATE TRIGGER IF NOT EXISTS playback_finised
BEFORE UPDATE OF progress ON devices
FOR EACH ROW
WHEN NEW.progress >= 1 AND NEW.id = crsql_siteid()
BEGIN
  INSERT INTO library SELECT ABS(RANDOM() % 4294967296), -1, track, UNIXEPOCH(), -1 FROM playback WHERE id = NEW.playback;
  UPDATE devices SET 
    playback = CASE WHEN NEW.repeat = 2 AND NOT EXISTS (SELECT 1 FROM queue WHERE position > 0)
      THEN IFNULL((SELECT id FROM queue LIMIT 1), playback)
      WHEN NEW.repeat = 1 THEN playback
      ELSE IFNULL((SELECT id FROM queue WHERE position = 1), playback)
    END,
    progress = 0
  WHERE id = NEW.id;
  SELECT RAISE(IGNORE);
END;

CREATE TRIGGER IF NOT EXISTS playback_backtracked
BEFORE UPDATE OF progress ON devices
FOR EACH ROW
WHEN NEW.progress < 0 AND NEW.id = crsql_siteid()
BEGIN
  UPDATE devices SET 
    playback = IFNULL((SELECT id FROM queue WHERE position = -1), playback),
    progress = 0
  WHERE id = NEW.id;
  SELECT RAISE(IGNORE);
END;

CREATE TRIGGER IF NOT EXISTS playback_shuffled
AFTER UPDATE OF direction ON devices
FOR EACH ROW
WHEN NEW.direction = 2 AND NEW.id = crsql_siteid()
BEGIN
  UPDATE playback SET "temp"="order" WHERE
    (SELECT id FROM queue WHERE position = 0) != id AND device = NEW.id;
  UPDATE playback SET
    "order"=(SELECT "order" FROM playback WHERE "temp" IS NULL)||trim(hex(randomblob(2)),'0')
  WHERE "temp" IS NOT NULL;
END;

CREATE TRIGGER IF NOT EXISTS playback_unshuffled
AFTER UPDATE OF direction ON devices
FOR EACH ROW
WHEN OLD.direction = 2 AND NEW.direction != 2 AND NEW.id = crsql_siteid()
BEGIN
  UPDATE playback SET
    "order"="temp",
    "temp"=NULL
  WHERE "temp" IS NOT NULL AND device = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS playback_purged
BEFORE DELETE ON playback
FOR EACH ROW
WHEN (OLD.id = (SELECT playback FROM devices WHERE id = crsql_siteid()))
BEGIN
  UPDATE devices SET 
    playback = (SELECT id FROM queue WHERE position = 1),
    progress = 0
  WHERE id = OLD.device;
END;`,__vite_glob_0_3=`INSERT OR IGNORE INTO playlists (id, title, "order", relevancy, shared, remote) VALUES
  (-1, 'Listened', 1, 0, NULL, NULL),
  (-2, 'Recommended', 1, -1, NULL, NULL),
  (-3, 'Blocked', 1, -1, NULL, NULL),
  (-4, 'Followed', 1, 0, NULL, NULL);`;function isUndefined(r){return typeof r>"u"||r===void 0}function isString(r){return typeof r=="string"}function isNumber(r){return typeof r=="number"}function isBoolean(r){return typeof r=="boolean"}function isNull(r){return r===null}function isDate(r){return r instanceof Date}function isBigInt(r){return typeof r=="bigint"}function isFunction(r){return typeof r=="function"}function isObject$2(r){return typeof r=="object"&&r!==null}function freeze(r){return Object.freeze(r)}function isReadonlyArray(r){return Array.isArray(r)}function noop$1(r){return r}const AlterTableNode=freeze({is(r){return r.kind==="AlterTableNode"},create(r){return freeze({kind:"AlterTableNode",table:r})},cloneWithTableProps(r,e){return freeze({...r,...e})},cloneWithColumnAlteration(r,e){return freeze({...r,columnAlterations:r.columnAlterations?[...r.columnAlterations,e]:[e]})}}),IdentifierNode=freeze({is(r){return r.kind==="IdentifierNode"},create(r){return freeze({kind:"IdentifierNode",name:r})}}),CreateIndexNode=freeze({is(r){return r.kind==="CreateIndexNode"},create(r){return freeze({kind:"CreateIndexNode",name:IdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})},cloneWithColumns(r,e){return freeze({...r,columns:[...r.columns||[],...e]})}}),CreateSchemaNode=freeze({is(r){return r.kind==="CreateSchemaNode"},create(r,e){return freeze({kind:"CreateSchemaNode",schema:IdentifierNode.create(r),...e})},cloneWith(r,e){return freeze({...r,...e})}}),ON_COMMIT_ACTIONS=["preserve rows","delete rows","drop"],CreateTableNode=freeze({is(r){return r.kind==="CreateTableNode"},create(r){return freeze({kind:"CreateTableNode",table:r,columns:freeze([])})},cloneWithColumn(r,e){return freeze({...r,columns:freeze([...r.columns,e])})},cloneWithConstraint(r,e){return freeze({...r,constraints:r.constraints?freeze([...r.constraints,e]):freeze([e])})},cloneWithFrontModifier(r,e){return freeze({...r,frontModifiers:r.frontModifiers?freeze([...r.frontModifiers,e]):freeze([e])})},cloneWithEndModifier(r,e){return freeze({...r,endModifiers:r.endModifiers?freeze([...r.endModifiers,e]):freeze([e])})},cloneWith(r,e){return freeze({...r,...e})}}),SchemableIdentifierNode=freeze({is(r){return r.kind==="SchemableIdentifierNode"},create(r){return freeze({kind:"SchemableIdentifierNode",identifier:IdentifierNode.create(r)})},createWithSchema(r,e){return freeze({kind:"SchemableIdentifierNode",schema:IdentifierNode.create(r),identifier:IdentifierNode.create(e)})}}),DropIndexNode=freeze({is(r){return r.kind==="DropIndexNode"},create(r,e){return freeze({kind:"DropIndexNode",name:SchemableIdentifierNode.create(r),...e})},cloneWith(r,e){return freeze({...r,...e})}}),DropSchemaNode=freeze({is(r){return r.kind==="DropSchemaNode"},create(r,e){return freeze({kind:"DropSchemaNode",schema:IdentifierNode.create(r),...e})},cloneWith(r,e){return freeze({...r,...e})}}),DropTableNode=freeze({is(r){return r.kind==="DropTableNode"},create(r,e){return freeze({kind:"DropTableNode",table:r,...e})},cloneWith(r,e){return freeze({...r,...e})}}),AliasNode=freeze({is(r){return r.kind==="AliasNode"},create(r,e){return freeze({kind:"AliasNode",node:r,alias:e})}}),TableNode=freeze({is(r){return r.kind==="TableNode"},create(r){return freeze({kind:"TableNode",table:SchemableIdentifierNode.create(r)})},createWithSchema(r,e){return freeze({kind:"TableNode",table:SchemableIdentifierNode.createWithSchema(r,e)})}});function isOperationNodeSource(r){return isObject$2(r)&&isFunction(r.toOperationNode)}function isExpression(r){return isObject$2(r)&&"expressionType"in r&&isOperationNodeSource(r)}function isAliasedExpression(r){return isObject$2(r)&&"expression"in r&&isString(r.alias)&&isOperationNodeSource(r)}const SelectModifierNode=freeze({is(r){return r.kind==="SelectModifierNode"},create(r){return freeze({kind:"SelectModifierNode",modifier:r})},createWithExpression(r){return freeze({kind:"SelectModifierNode",rawModifier:r})}}),AndNode=freeze({is(r){return r.kind==="AndNode"},create(r,e){return freeze({kind:"AndNode",left:r,right:e})}}),OrNode=freeze({is(r){return r.kind==="OrNode"},create(r,e){return freeze({kind:"OrNode",left:r,right:e})}}),OnNode=freeze({is(r){return r.kind==="OnNode"},create(r){return freeze({kind:"OnNode",on:r})},cloneWithOperation(r,e,t){return freeze({...r,on:e==="And"?AndNode.create(r.on,t):OrNode.create(r.on,t)})}}),JoinNode=freeze({is(r){return r.kind==="JoinNode"},create(r,e){return freeze({kind:"JoinNode",joinType:r,table:e,on:void 0})},createWithOn(r,e,t){return freeze({kind:"JoinNode",joinType:r,table:e,on:OnNode.create(t)})},cloneWithOn(r,e){return freeze({...r,on:r.on?OnNode.cloneWithOperation(r.on,"And",e):OnNode.create(e)})},cloneWithOrOn(r,e){return freeze({...r,on:r.on?OnNode.cloneWithOperation(r.on,"Or",e):OnNode.create(e)})}}),BinaryOperationNode=freeze({is(r){return r.kind==="BinaryOperationNode"},create(r,e,t){return freeze({kind:"BinaryOperationNode",leftOperand:r,operator:e,rightOperand:t})}}),RawNode=freeze({is(r){return r.kind==="RawNode"},create(r,e){return freeze({kind:"RawNode",sqlFragments:freeze(r),parameters:freeze(e)})},createWithSql(r){return RawNode.create([r],[])},createWithChild(r){return RawNode.create(["",""],[r])},createWithChildren(r){return RawNode.create(new Array(r.length+1).fill(""),r)}}),COMPARISON_OPERATORS=["=","==","!=","<>",">",">=","<","<=","in","not in","is","is not","like","not like","match","ilike","not ilike","@>","<@","?","?&","!<","!>","<=>","!~","~","~*","!~*","@@","@@@","!!","<->"],ARITHMETIC_OPERATORS=["+","-","*","/","%","^","&","|","#","<<",">>"],BINARY_OPERATORS=[...COMPARISON_OPERATORS,...ARITHMETIC_OPERATORS,"&&","||"],UNARY_FILTER_OPERATORS=["exists","not exists"],UNARY_OPERATORS=["not","-",...UNARY_FILTER_OPERATORS],OPERATORS=[...BINARY_OPERATORS,...UNARY_OPERATORS],OperatorNode=freeze({is(r){return r.kind==="OperatorNode"},create(r){return freeze({kind:"OperatorNode",operator:r})}});function isBinaryOperator(r){return isString(r)&&BINARY_OPERATORS.includes(r)}function isComparisonOperator(r){return isString(r)&&COMPARISON_OPERATORS.includes(r)}const ParensNode=freeze({is(r){return r.kind==="ParensNode"},create(r){return freeze({kind:"ParensNode",node:r})}}),ColumnNode=freeze({is(r){return r.kind==="ColumnNode"},create(r){return freeze({kind:"ColumnNode",column:IdentifierNode.create(r)})}}),SelectAllNode=freeze({is(r){return r.kind==="SelectAllNode"},create(){return freeze({kind:"SelectAllNode"})}}),ReferenceNode=freeze({is(r){return r.kind==="ReferenceNode"},create(r,e){return freeze({kind:"ReferenceNode",table:r,column:e})},createSelectAll(r){return freeze({kind:"ReferenceNode",table:r,column:SelectAllNode.create()})}}),OrderByItemNode=freeze({is(r){return r.kind==="OrderByItemNode"},create(r,e){return freeze({kind:"OrderByItemNode",orderBy:r,direction:e})}});function isOrderByDirection(r){return r==="asc"||r==="desc"}function parseOrderBy(r,e){return OrderByItemNode.create(parseOrderByExpression(r),parseOrderByDirectionExpression(e))}function parseOrderByExpression(r){return parseReferenceExpression(r)}function parseOrderByDirectionExpression(r){if(r)return r==="asc"||r==="desc"?RawNode.createWithSql(r):r.toOperationNode()}function parseSimpleReferenceExpression(r){return isString(r)?parseStringReference(r):r.toOperationNode()}function parseReferenceExpressionOrList(r){return isReadonlyArray(r)?r.map(e=>parseReferenceExpression(e)):[parseReferenceExpression(r)]}function parseReferenceExpression(r){return isExpressionOrFactory(r)?parseExpression(r):parseSimpleReferenceExpression(r)}function parseStringReference(r){const e=".";if(r.includes(e)){const t=r.split(e).map(trim$2);if(t.length===3)return parseStringReferenceWithTableAndSchema(t);if(t.length===2)return parseStringReferenceWithTable(t);throw new Error(`invalid column reference ${r}`)}else return ColumnNode.create(r)}function parseAliasedStringReference(r){const e=" as ";if(r.includes(e)){const[t,n]=r.split(e).map(trim$2);return AliasNode.create(parseStringReference(t),IdentifierNode.create(n))}else return parseStringReference(r)}function parseColumnName(r){return ColumnNode.create(r)}function parseOrderedColumnName(r){const e=" ";if(r.includes(e)){const[t,n]=r.split(e).map(trim$2);if(!isOrderByDirection(n))throw new Error(`invalid order direction "${n}" next to "${t}"`);return parseOrderBy(t,n)}else return parseColumnName(r)}function parseStringReferenceWithTableAndSchema(r){const[e,t,n]=r;return ReferenceNode.create(TableNode.createWithSchema(e,t),ColumnNode.create(n))}function parseStringReferenceWithTable(r){const[e,t]=r;return ReferenceNode.create(TableNode.create(e),ColumnNode.create(t))}function trim$2(r){return r.trim()}const PrimitiveValueListNode=freeze({is(r){return r.kind==="PrimitiveValueListNode"},create(r){return freeze({kind:"PrimitiveValueListNode",values:freeze([...r])})}}),ValueListNode=freeze({is(r){return r.kind==="ValueListNode"},create(r){return freeze({kind:"ValueListNode",values:freeze(r)})}}),ValueNode=freeze({is(r){return r.kind==="ValueNode"},create(r){return freeze({kind:"ValueNode",value:r})},createImmediate(r){return freeze({kind:"ValueNode",value:r,immediate:!0})}});function parseValueExpressionOrList(r){return isReadonlyArray(r)?parseValueExpressionList(r):parseValueExpression(r)}function parseValueExpression(r){return isExpressionOrFactory(r)?parseExpression(r):ValueNode.create(r)}function parseValueExpressionList(r){return r.some(isExpressionOrFactory)?ValueListNode.create(r.map(e=>parseValueExpression(e))):PrimitiveValueListNode.create(r)}const OrderByNode=freeze({is(r){return r.kind==="OrderByNode"},create(r){return freeze({kind:"OrderByNode",items:freeze([r])})},cloneWithItem(r,e){return freeze({...r,items:freeze([...r.items,e])})}}),PartitionByNode=freeze({is(r){return r.kind==="PartitionByNode"},create(r){return freeze({kind:"PartitionByNode",items:freeze(r)})},cloneWithItems(r,e){return freeze({...r,items:freeze([...r.items,...e])})}}),OverNode=freeze({is(r){return r.kind==="OverNode"},create(){return freeze({kind:"OverNode"})},cloneWithOrderByItem(r,e){return freeze({...r,orderBy:r.orderBy?OrderByNode.cloneWithItem(r.orderBy,e):OrderByNode.create(e)})},cloneWithPartitionByItems(r,e){return freeze({...r,partitionBy:r.partitionBy?PartitionByNode.cloneWithItems(r.partitionBy,e):PartitionByNode.create(e)})}}),FromNode=freeze({is(r){return r.kind==="FromNode"},create(r){return freeze({kind:"FromNode",froms:freeze(r)})},cloneWithFroms(r,e){return freeze({...r,froms:freeze([...r.froms,...e])})}}),GroupByNode=freeze({is(r){return r.kind==="GroupByNode"},create(r){return freeze({kind:"GroupByNode",items:freeze(r)})},cloneWithItems(r,e){return freeze({...r,items:freeze([...r.items,...e])})}}),HavingNode=freeze({is(r){return r.kind==="HavingNode"},create(r){return freeze({kind:"HavingNode",having:r})},cloneWithOperation(r,e,t){return freeze({...r,having:e==="And"?AndNode.create(r.having,t):OrNode.create(r.having,t)})}}),SelectQueryNode=freeze({is(r){return r.kind==="SelectQueryNode"},create(r,e){return freeze({kind:"SelectQueryNode",from:FromNode.create(r),...e&&{with:e}})},cloneWithSelections(r,e){return freeze({...r,selections:r.selections?freeze([...r.selections,...e]):freeze(e)})},cloneWithDistinctOn(r,e){return freeze({...r,distinctOn:r.distinctOn?freeze([...r.distinctOn,...e]):freeze(e)})},cloneWithFrontModifier(r,e){return freeze({...r,frontModifiers:r.frontModifiers?freeze([...r.frontModifiers,e]):freeze([e])})},cloneWithEndModifier(r,e){return freeze({...r,endModifiers:r.endModifiers?freeze([...r.endModifiers,e]):freeze([e])})},cloneWithOrderByItem(r,e){return freeze({...r,orderBy:r.orderBy?OrderByNode.cloneWithItem(r.orderBy,e):OrderByNode.create(e)})},cloneWithGroupByItems(r,e){return freeze({...r,groupBy:r.groupBy?GroupByNode.cloneWithItems(r.groupBy,e):GroupByNode.create(e)})},cloneWithLimit(r,e){return freeze({...r,limit:e})},cloneWithOffset(r,e){return freeze({...r,offset:e})},cloneWithHaving(r,e){return freeze({...r,having:r.having?HavingNode.cloneWithOperation(r.having,"And",e):HavingNode.create(e)})},cloneWithOrHaving(r,e){return freeze({...r,having:r.having?HavingNode.cloneWithOperation(r.having,"Or",e):HavingNode.create(e)})},cloneWithSetOperation(r,e){return freeze({...r,setOperations:r.setOperations?freeze([...r.setOperations,e]):freeze([e])})},cloneWithoutSelections(r){return freeze({...r,selections:[]})},cloneWithoutLimit(r){return freeze({...r,limit:void 0})},cloneWithoutOffset(r){return freeze({...r,offset:void 0})},cloneWithoutOrderBy(r){return freeze({...r,orderBy:void 0})}}),UnaryOperationNode=freeze({is(r){return r.kind==="UnaryOperationNode"},create(r,e){return freeze({kind:"UnaryOperationNode",operator:r,operand:e})}});function parseExists(r){return parseUnaryOperation("exists",r)}function parseNotExists(r){return parseUnaryOperation("not exists",r)}function parseUnaryOperation(r,e){return UnaryOperationNode.create(OperatorNode.create(r),parseReferenceExpression(e))}function preventAwait(r,e){Object.defineProperties(r.prototype,{then:{enumerable:!1,value:()=>{throw new Error(e)}}})}var ve;const dt=class{constructor(e){T(this,ve,void 0);k(this,ve,freeze(e))}on(...e){return new dt({...i(this,ve),joinNode:JoinNode.cloneWithOn(i(this,ve).joinNode,parseOn(e))})}orOn(...e){return new dt({...i(this,ve),joinNode:JoinNode.cloneWithOrOn(i(this,ve).joinNode,parseOn(e))})}onRef(e,t,n){return new dt({...i(this,ve),joinNode:JoinNode.cloneWithOn(i(this,ve).joinNode,parseReferentialComparison(e,t,n))})}orOnRef(e,t,n){return new dt({...i(this,ve),joinNode:JoinNode.cloneWithOrOn(i(this,ve).joinNode,parseReferentialComparison(e,t,n))})}onExists(e){return new dt({...i(this,ve),joinNode:JoinNode.cloneWithOn(i(this,ve).joinNode,parseExists(e))})}onNotExists(e){return new dt({...i(this,ve),joinNode:JoinNode.cloneWithOn(i(this,ve).joinNode,parseNotExists(e))})}orOnExists(e){return new dt({...i(this,ve),joinNode:JoinNode.cloneWithOrOn(i(this,ve).joinNode,parseExists(e))})}orOnNotExists(e){return new dt({...i(this,ve),joinNode:JoinNode.cloneWithOrOn(i(this,ve).joinNode,parseNotExists(e))})}onTrue(){return new dt({...i(this,ve),joinNode:JoinNode.cloneWithOn(i(this,ve).joinNode,RawNode.createWithSql("true"))})}$call(e){return e(this)}toOperationNode(){return i(this,ve).joinNode}};let JoinBuilder=dt;ve=new WeakMap;preventAwait(JoinBuilder,"don't await JoinBuilder instances. They are never executed directly and are always just a part of a query.");const PartitionByItemNode=freeze({is(r){return r.kind==="PartitionByItemNode"},create(r){return freeze({kind:"PartitionByItemNode",partitionBy:r})}});function parsePartitionBy(r){return parseReferenceExpressionOrList(r).map(PartitionByItemNode.create)}var Yt;const Bn=class{constructor(e){T(this,Yt,void 0);k(this,Yt,freeze(e))}orderBy(e,t){return new Bn({overNode:OverNode.cloneWithOrderByItem(i(this,Yt).overNode,parseOrderBy(e,t))})}partitionBy(e){return new Bn({overNode:OverNode.cloneWithPartitionByItems(i(this,Yt).overNode,parsePartitionBy(e))})}$call(e){return e(this)}toOperationNode(){return i(this,Yt).overNode}};let OverBuilder=Bn;Yt=new WeakMap;preventAwait(OverBuilder,"don't await OverBuilder instances. They are never executed directly and are always just a part of a query.");const SelectionNode=freeze({is(r){return r.kind==="SelectionNode"},create(r){return freeze({kind:"SelectionNode",selection:r})},createSelectAll(){return freeze({kind:"SelectionNode",selection:SelectAllNode.create()})},createSelectAllFromTable(r){return freeze({kind:"SelectionNode",selection:ReferenceNode.createSelectAll(r)})}});var Nr;class DynamicReferenceBuilder{constructor(e){T(this,Nr,void 0);k(this,Nr,e)}get dynamicReference(){return i(this,Nr)}get refType(){}toOperationNode(){return parseSimpleReferenceExpression(i(this,Nr))}}Nr=new WeakMap;function isDynamicReferenceBuilder(r){return isObject$2(r)&&isOperationNodeSource(r)&&isString(r.dynamicReference)}function parseSelectArg(r){return isFunction(r)?parseSelectArg(r(expressionBuilder())):isReadonlyArray(r)?r.map(e=>parseSelectExpression(e)):[parseSelectExpression(r)]}function parseSelectExpression(r){return isString(r)?SelectionNode.create(parseAliasedStringReference(r)):isDynamicReferenceBuilder(r)?SelectionNode.create(r.toOperationNode()):SelectionNode.create(parseAliasedExpression(r))}function parseSelectAll(r){return r?Array.isArray(r)?r.map(parseSelectAllArg):[parseSelectAllArg(r)]:[SelectionNode.createSelectAll()]}function parseSelectAllArg(r){if(isString(r))return SelectionNode.createSelectAllFromTable(parseTable(r));throw new Error(`invalid value selectAll expression: ${JSON.stringify(r)}`)}const ValuesNode=freeze({is(r){return r.kind==="ValuesNode"},create(r){return freeze({kind:"ValuesNode",values:freeze(r)})}}),DefaultInsertValueNode=freeze({is(r){return r.kind==="DefaultInsertValueNode"},create(){return freeze({kind:"DefaultInsertValueNode"})}});function parseInsertExpression(r){const e=isFunction(r)?r(expressionBuilder()):r,t=isReadonlyArray(e)?e:freeze([e]);return parseInsertColumnsAndValues(t)}function parseInsertColumnsAndValues(r){const e=parseColumnNamesAndIndexes(r);return[freeze([...e.keys()].map(ColumnNode.create)),ValuesNode.create(r.map(t=>parseRowValues(t,e)))]}function parseColumnNamesAndIndexes(r){const e=new Map;for(const t of r){const n=Object.keys(t);for(const s of n)!e.has(s)&&t[s]!==void 0&&e.set(s,e.size)}return e}function parseRowValues(r,e){const t=Object.keys(r),n=Array.from({length:e.size});let s=!1;for(const c of t){const d=e.get(c);if(isUndefined(d))continue;const h=r[c];(isUndefined(h)||isExpressionOrFactory(h))&&(s=!0),n[d]=h}if(t.length<e.size||s){const c=DefaultInsertValueNode.create();return ValueListNode.create(n.map(d=>isUndefined(d)?c:parseValueExpression(d)))}return PrimitiveValueListNode.create(n)}const InsertQueryNode=freeze({is(r){return r.kind==="InsertQueryNode"},create(r,e,t){return freeze({kind:"InsertQueryNode",into:r,...e&&{with:e},replace:t})},cloneWith(r,e){return freeze({...r,...e})}}),UpdateQueryNode=freeze({is(r){return r.kind==="UpdateQueryNode"},create(r,e){return freeze({kind:"UpdateQueryNode",table:r,...e&&{with:e}})},cloneWithFromItems(r,e){return freeze({...r,from:r.from?FromNode.cloneWithFroms(r.from,e):FromNode.create(e)})},cloneWithUpdates(r,e){return freeze({...r,updates:r.updates?freeze([...r.updates,...e]):e})}}),UsingNode=freeze({is(r){return r.kind==="UsingNode"},create(r){return freeze({kind:"UsingNode",tables:freeze(r)})},cloneWithTables(r,e){return freeze({...r,tables:freeze([...r.tables,...e])})}}),DeleteQueryNode=freeze({is(r){return r.kind==="DeleteQueryNode"},create(r,e){return freeze({kind:"DeleteQueryNode",from:FromNode.create(r),...e&&{with:e}})},cloneWithOrderByItem(r,e){return freeze({...r,orderBy:r.orderBy?OrderByNode.cloneWithItem(r.orderBy,e):OrderByNode.create(e)})},cloneWithLimit(r,e){return freeze({...r,limit:e})},cloneWithUsing(r,e){return freeze({...r,using:r.using!==void 0?UsingNode.cloneWithTables(r.using,e):UsingNode.create(e)})}}),WhereNode=freeze({is(r){return r.kind==="WhereNode"},create(r){return freeze({kind:"WhereNode",where:r})},cloneWithOperation(r,e,t){return freeze({...r,where:e==="And"?AndNode.create(r.where,t):OrNode.create(r.where,t)})}}),ReturningNode=freeze({is(r){return r.kind==="ReturningNode"},create(r){return freeze({kind:"ReturningNode",selections:freeze(r)})},cloneWithSelections(r,e){return freeze({...r,selections:r.selections?freeze([...r.selections,...e]):freeze(e)})}}),ExplainNode=freeze({is(r){return r.kind==="ExplainNode"},create(r,e){return freeze({kind:"ExplainNode",format:r,options:e})}}),QueryNode=freeze({is(r){return SelectQueryNode.is(r)||InsertQueryNode.is(r)||UpdateQueryNode.is(r)||DeleteQueryNode.is(r)},cloneWithWhere(r,e){return freeze({...r,where:r.where?WhereNode.cloneWithOperation(r.where,"And",e):WhereNode.create(e)})},cloneWithOrWhere(r,e){return freeze({...r,where:r.where?WhereNode.cloneWithOperation(r.where,"Or",e):WhereNode.create(e)})},cloneWithJoin(r,e){return freeze({...r,joins:r.joins?freeze([...r.joins,e]):freeze([e])})},cloneWithReturning(r,e){return freeze({...r,returning:r.returning?ReturningNode.cloneWithSelections(r.returning,e):ReturningNode.create(e)})},cloneWithoutWhere(r){return freeze({...r,where:void 0})},cloneWithExplain(r,e,t){return freeze({...r,explain:ExplainNode.create(e,t==null?void 0:t.toOperationNode())})}}),ColumnUpdateNode=freeze({is(r){return r.kind==="ColumnUpdateNode"},create(r,e){return freeze({kind:"ColumnUpdateNode",column:r,value:e})}});function parseUpdateExpression(r){const e=isFunction(r)?r(expressionBuilder()):r;return Object.entries(e).filter(([t,n])=>n!==void 0).map(([t,n])=>ColumnUpdateNode.create(ColumnNode.create(t),parseValueExpression(n)))}const OnDuplicateKeyNode=freeze({is(r){return r.kind==="OnDuplicateKeyNode"},create(r){return freeze({kind:"OnDuplicateKeyNode",updates:r})}});var Yr,Zr;class InsertResult{constructor(e,t){T(this,Yr,void 0);T(this,Zr,void 0);k(this,Yr,e),k(this,Zr,t)}get insertId(){return i(this,Yr)}get numInsertedOrUpdatedRows(){return i(this,Zr)}}Yr=new WeakMap,Zr=new WeakMap;for(const r of["insertId","numInsertedOrUpdatedRows"])Object.defineProperty(InsertResult.prototype,r,{enumerable:!0});class NoResultError extends Error{constructor(t){super("no result");ce(this,"node");this.node=t}}function isNoResultErrorConstructor(r){return Object.prototype.hasOwnProperty.call(r,"prototype")}const OnConflictNode=freeze({is(r){return r.kind==="OnConflictNode"},create(){return freeze({kind:"OnConflictNode"})},cloneWith(r,e){return freeze({...r,...e})},cloneWithIndexWhere(r,e){return freeze({...r,indexWhere:r.indexWhere?WhereNode.cloneWithOperation(r.indexWhere,"And",e):WhereNode.create(e)})},cloneWithIndexOrWhere(r,e){return freeze({...r,indexWhere:r.indexWhere?WhereNode.cloneWithOperation(r.indexWhere,"Or",e):WhereNode.create(e)})},cloneWithUpdateWhere(r,e){return freeze({...r,updateWhere:r.updateWhere?WhereNode.cloneWithOperation(r.updateWhere,"And",e):WhereNode.create(e)})},cloneWithUpdateOrWhere(r,e){return freeze({...r,updateWhere:r.updateWhere?WhereNode.cloneWithOperation(r.updateWhere,"Or",e):WhereNode.create(e)})},cloneWithoutIndexWhere(r){return freeze({...r,indexWhere:void 0})},cloneWithoutUpdateWhere(r){return freeze({...r,updateWhere:void 0})}});var oe;const Ke=class{constructor(e){T(this,oe,void 0);k(this,oe,freeze(e))}column(e){const t=ColumnNode.create(e);return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWith(i(this,oe).onConflictNode,{columns:i(this,oe).onConflictNode.columns?freeze([...i(this,oe).onConflictNode.columns,t]):freeze([t])})})}columns(e){const t=e.map(ColumnNode.create);return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWith(i(this,oe).onConflictNode,{columns:i(this,oe).onConflictNode.columns?freeze([...i(this,oe).onConflictNode.columns,...t]):freeze(t)})})}constraint(e){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWith(i(this,oe).onConflictNode,{constraint:IdentifierNode.create(e)})})}expression(e){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWith(i(this,oe).onConflictNode,{indexExpression:e.toOperationNode()})})}where(...e){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,oe).onConflictNode,parseWhere(e))})}whereRef(e,t,n){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,oe).onConflictNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWithIndexOrWhere(i(this,oe).onConflictNode,parseWhere(e))})}orWhereRef(e,t,n){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWithIndexOrWhere(i(this,oe).onConflictNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,oe).onConflictNode,parseExists(e))})}whereNotExists(e){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,oe).onConflictNode,parseNotExists(e))})}orWhereExists(e){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWithIndexOrWhere(i(this,oe).onConflictNode,parseExists(e))})}orWhereNotExists(e){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWithIndexOrWhere(i(this,oe).onConflictNode,parseNotExists(e))})}clearWhere(){return new Ke({...i(this,oe),onConflictNode:OnConflictNode.cloneWithoutIndexWhere(i(this,oe).onConflictNode)})}doNothing(){return new OnConflictDoNothingBuilder({...i(this,oe),onConflictNode:OnConflictNode.cloneWith(i(this,oe).onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new OnConflictUpdateBuilder({...i(this,oe),onConflictNode:OnConflictNode.cloneWith(i(this,oe).onConflictNode,{updates:parseUpdateExpression(e)})})}$call(e){return e(this)}};let OnConflictBuilder=Ke;oe=new WeakMap;preventAwait(OnConflictBuilder,"don't await OnConflictBuilder instances.");var en;class OnConflictDoNothingBuilder{constructor(e){T(this,en,void 0);k(this,en,freeze(e))}toOperationNode(){return i(this,en).onConflictNode}}en=new WeakMap;preventAwait(OnConflictDoNothingBuilder,"don't await OnConflictDoNothingBuilder instances.");var Ie;const ft=class{constructor(e){T(this,Ie,void 0);k(this,Ie,freeze(e))}where(...e){return new ft({...i(this,Ie),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,Ie).onConflictNode,parseWhere(e))})}whereRef(e,t,n){return new ft({...i(this,Ie),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,Ie).onConflictNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new ft({...i(this,Ie),onConflictNode:OnConflictNode.cloneWithUpdateOrWhere(i(this,Ie).onConflictNode,parseWhere(e))})}orWhereRef(e,t,n){return new ft({...i(this,Ie),onConflictNode:OnConflictNode.cloneWithUpdateOrWhere(i(this,Ie).onConflictNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new ft({...i(this,Ie),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,Ie).onConflictNode,parseExists(e))})}whereNotExists(e){return new ft({...i(this,Ie),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,Ie).onConflictNode,parseNotExists(e))})}orWhereExists(e){return new ft({...i(this,Ie),onConflictNode:OnConflictNode.cloneWithUpdateOrWhere(i(this,Ie).onConflictNode,parseExists(e))})}orWhereNotExists(e){return new ft({...i(this,Ie),onConflictNode:OnConflictNode.cloneWithUpdateOrWhere(i(this,Ie).onConflictNode,parseNotExists(e))})}clearWhere(){return new ft({...i(this,Ie),onConflictNode:OnConflictNode.cloneWithoutUpdateWhere(i(this,Ie).onConflictNode)})}$call(e){return e(this)}toOperationNode(){return i(this,Ie).onConflictNode}};let OnConflictUpdateBuilder=ft;Ie=new WeakMap;preventAwait(OnConflictUpdateBuilder,"don't await OnConflictUpdateBuilder instances.");var se;const De=class{constructor(e){T(this,se,void 0);k(this,se,freeze(e))}values(e){const[t,n]=parseInsertExpression(e);return new De({...i(this,se),queryNode:InsertQueryNode.cloneWith(i(this,se).queryNode,{columns:t,values:n})})}columns(e){return new De({...i(this,se),queryNode:InsertQueryNode.cloneWith(i(this,se).queryNode,{columns:freeze(e.map(ColumnNode.create))})})}expression(e){return new De({...i(this,se),queryNode:InsertQueryNode.cloneWith(i(this,se).queryNode,{values:parseExpression(e)})})}ignore(){return new De({...i(this,se),queryNode:InsertQueryNode.cloneWith(i(this,se).queryNode,{ignore:!0})})}onConflict(e){return new De({...i(this,se),queryNode:InsertQueryNode.cloneWith(i(this,se).queryNode,{onConflict:e(new OnConflictBuilder({onConflictNode:OnConflictNode.create()})).toOperationNode()})})}onDuplicateKeyUpdate(e){return new De({...i(this,se),queryNode:InsertQueryNode.cloneWith(i(this,se).queryNode,{onDuplicateKey:OnDuplicateKeyNode.create(parseUpdateExpression(e))})})}returning(e){return new De({...i(this,se),queryNode:QueryNode.cloneWithReturning(i(this,se).queryNode,parseSelectArg(e))})}returningAll(){return new De({...i(this,se),queryNode:QueryNode.cloneWithReturning(i(this,se).queryNode,parseSelectAll())})}$call(e){return e(this)}call(e){return this.$call(e)}$if(e,t){return e?t(this):new De({...i(this,se)})}if(e,t){return e?t(this):new De({...i(this,se)})}$castTo(){return new De(i(this,se))}castTo(){return this.$castTo()}$narrowType(){return new De(i(this,se))}$assertType(){return new De(i(this,se))}assertType(){return new De(i(this,se))}withPlugin(e){return new De({...i(this,se),executor:i(this,se).executor.withPlugin(e)})}toOperationNode(){return i(this,se).executor.transformQuery(i(this,se).queryNode,i(this,se).queryId)}compile(){return i(this,se).executor.compileQuery(this.toOperationNode(),i(this,se).queryId)}async execute(){const e=this.compile(),t=e.query,n=await i(this,se).executor.executeQuery(e,i(this,se).queryId);return i(this,se).executor.adapter.supportsReturning&&t.returning?n.rows:[new InsertResult(n.insertId,n.numAffectedRows??n.numUpdatedOrDeletedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,se).executor.stream(t,e,i(this,se).queryId);for await(const s of n)yield*s.rows}async explain(e,t){return await new De({...i(this,se),queryNode:QueryNode.cloneWithExplain(i(this,se).queryNode,e,t)}).execute()}};let InsertQueryBuilder=De;se=new WeakMap;preventAwait(InsertQueryBuilder,"don't await InsertQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var tn;class DeleteResult{constructor(e){T(this,tn,void 0);k(this,tn,e)}get numDeletedRows(){return i(this,tn)}}tn=new WeakMap;Object.defineProperty(DeleteResult.prototype,"numDeletedRows",{enumerable:!0});const LimitNode=freeze({is(r){return r.kind==="LimitNode"},create(r){return freeze({kind:"LimitNode",limit:ValueNode.create(r)})}});var J;const pe=class{constructor(e){T(this,J,void 0);k(this,J,freeze(e))}where(...e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithWhere(i(this,J).queryNode,parseWhere(e))})}whereRef(e,t,n){return new pe({...i(this,J),queryNode:QueryNode.cloneWithWhere(i(this,J).queryNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithOrWhere(i(this,J).queryNode,parseWhere(e))})}orWhereRef(e,t,n){return new pe({...i(this,J),queryNode:QueryNode.cloneWithOrWhere(i(this,J).queryNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithWhere(i(this,J).queryNode,parseExists(e))})}whereNotExists(e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithWhere(i(this,J).queryNode,parseNotExists(e))})}orWhereExists(e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithOrWhere(i(this,J).queryNode,parseExists(e))})}orWhereNotExists(e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithOrWhere(i(this,J).queryNode,parseNotExists(e))})}clearWhere(){return new pe({...i(this,J),queryNode:QueryNode.cloneWithoutWhere(i(this,J).queryNode)})}using(e){return new pe({...i(this,J),queryNode:DeleteQueryNode.cloneWithUsing(i(this,J).queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithJoin(i(this,J).queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithJoin(i(this,J).queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithJoin(i(this,J).queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithJoin(i(this,J).queryNode,parseJoin("FullJoin",e))})}returning(e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithReturning(i(this,J).queryNode,parseSelectArg(e))})}returningAll(e){return new pe({...i(this,J),queryNode:QueryNode.cloneWithReturning(i(this,J).queryNode,parseSelectAll(e))})}orderBy(e,t){return new pe({...i(this,J),queryNode:DeleteQueryNode.cloneWithOrderByItem(i(this,J).queryNode,parseOrderBy(e,t))})}limit(e){return new pe({...i(this,J),queryNode:DeleteQueryNode.cloneWithLimit(i(this,J).queryNode,LimitNode.create(e))})}$call(e){return e(this)}call(e){return this.$call(e)}$if(e,t){return e?t(this):new pe({...i(this,J)})}if(e,t){return this.$if(e,t)}$castTo(){return new pe(i(this,J))}castTo(){return this.$castTo()}$narrowType(){return new pe(i(this,J))}$assertType(){return new pe(i(this,J))}assertType(){return new pe(i(this,J))}withPlugin(e){return new pe({...i(this,J),executor:i(this,J).executor.withPlugin(e)})}toOperationNode(){return i(this,J).executor.transformQuery(i(this,J).queryNode,i(this,J).queryId)}compile(){return i(this,J).executor.compileQuery(this.toOperationNode(),i(this,J).queryId)}async execute(){const e=this.compile(),t=e.query,n=await i(this,J).executor.executeQuery(e,i(this,J).queryId);return i(this,J).executor.adapter.supportsReturning&&t.returning?n.rows:[new DeleteResult(n.numAffectedRows??n.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,J).executor.stream(t,e,i(this,J).queryId);for await(const s of n)yield*s.rows}async explain(e,t){return await new pe({...i(this,J),queryNode:QueryNode.cloneWithExplain(i(this,J).queryNode,e,t)}).execute()}};let DeleteQueryBuilder=pe;J=new WeakMap;preventAwait(DeleteQueryBuilder,"don't await DeleteQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var rn;class UpdateResult{constructor(e){T(this,rn,void 0);k(this,rn,e)}get numUpdatedRows(){return i(this,rn)}}rn=new WeakMap;Object.defineProperty(UpdateResult.prototype,"numUpdatedRows",{enumerable:!0});var K;const Ne=class{constructor(e){T(this,K,void 0);k(this,K,freeze(e))}where(...e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseWhere(e))})}whereRef(e,t,n){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithOrWhere(i(this,K).queryNode,parseWhere(e))})}orWhereRef(e,t,n){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithOrWhere(i(this,K).queryNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseExists(e))})}whereNotExists(e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseNotExists(e))})}orWhereExists(e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithOrWhere(i(this,K).queryNode,parseExists(e))})}orWhereNotExists(e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithOrWhere(i(this,K).queryNode,parseNotExists(e))})}clearWhere(){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithoutWhere(i(this,K).queryNode)})}from(e){return new Ne({...i(this,K),queryNode:UpdateQueryNode.cloneWithFromItems(i(this,K).queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("FullJoin",e))})}set(e){return new Ne({...i(this,K),queryNode:UpdateQueryNode.cloneWithUpdates(i(this,K).queryNode,parseUpdateExpression(e))})}returning(e){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithReturning(i(this,K).queryNode,parseSelectArg(e))})}returningAll(){return new Ne({...i(this,K),queryNode:QueryNode.cloneWithReturning(i(this,K).queryNode,parseSelectAll())})}$call(e){return e(this)}call(e){return this.$call(e)}$if(e,t){return e?t(this):new Ne({...i(this,K)})}if(e,t){return this.$if(e,t)}$castTo(){return new Ne(i(this,K))}castTo(){return this.$castTo()}$narrowType(){return new Ne(i(this,K))}$assertType(){return new Ne(i(this,K))}assertType(){return new Ne(i(this,K))}withPlugin(e){return new Ne({...i(this,K),executor:i(this,K).executor.withPlugin(e)})}toOperationNode(){return i(this,K).executor.transformQuery(i(this,K).queryNode,i(this,K).queryId)}compile(){return i(this,K).executor.compileQuery(this.toOperationNode(),i(this,K).queryId)}async execute(){const e=this.compile(),t=e.query,n=await i(this,K).executor.executeQuery(e,i(this,K).queryId);return i(this,K).executor.adapter.supportsReturning&&t.returning?n.rows:[new UpdateResult(n.numAffectedRows??n.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,K).executor.stream(t,e,i(this,K).queryId);for await(const s of n)yield*s.rows}async explain(e,t){return await new Ne({...i(this,K),queryNode:QueryNode.cloneWithExplain(i(this,K).queryNode,e,t)}).execute()}};let UpdateQueryBuilder=Ne;K=new WeakMap;preventAwait(UpdateQueryBuilder,"don't await UpdateQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");const CommonTableExpressionNode=freeze({is(r){return r.kind==="CommonTableExpressionNode"},create(r,e){return freeze({kind:"CommonTableExpressionNode",name:r,expression:e})}}),CommonTableExpressionNameNode=freeze({is(r){return r.kind==="CommonTableExpressionNameNode"},create(r,e){return freeze({kind:"CommonTableExpressionNameNode",table:TableNode.create(r),columns:e?freeze(e.map(ColumnNode.create)):void 0})}});function parseCommonTableExpression(r,e){const t=e(createQueryCreator());return CommonTableExpressionNode.create(parseCommonTableExpressionName(r),t.toOperationNode())}function parseCommonTableExpressionName(r){if(r.includes("(")){const e=r.split(/[\(\)]/),t=e[0],n=e[1].split(",").map(s=>s.trim());return CommonTableExpressionNameNode.create(t,n)}else return CommonTableExpressionNameNode.create(r)}const WithNode=freeze({is(r){return r.kind==="WithNode"},create(r,e){return freeze({kind:"WithNode",expressions:freeze([r]),...e})},cloneWithExpression(r,e){return freeze({...r,expressions:freeze([...r.expressions,e])})}}),CHARS=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];function randomString(r){let e="";for(let t=0;t<r;++t)e+=randomChar();return e}function randomChar(){return CHARS[~~(Math.random()*CHARS.length)]}function createQueryId(){return new LazyQueryId}var br;class LazyQueryId{constructor(){T(this,br,void 0)}get queryId(){return i(this,br)===void 0&&k(this,br,randomString(8)),i(this,br)}}br=new WeakMap;function requireAllProps(r){return r}var zn;class OperationNodeTransformer{constructor(){ce(this,"nodeStack",[]);T(this,zn,freeze({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this)}))}transformNode(e){if(!e)return e;this.nodeStack.push(e);const t=this.transformNodeImpl(e);return this.nodeStack.pop(),freeze(t)}transformNodeImpl(e){return i(this,zn)[e.kind](e)}transformNodeList(e){return e&&freeze(e.map(t=>this.transformNode(t)))}transformSelectQuery(e){return{kind:"SelectQueryNode",from:this.transformNode(e.from),selections:this.transformNodeList(e.selections),distinctOn:this.transformNodeList(e.distinctOn),joins:this.transformNodeList(e.joins),groupBy:this.transformNode(e.groupBy),orderBy:this.transformNode(e.orderBy),where:this.transformNode(e.where),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),limit:this.transformNode(e.limit),offset:this.transformNode(e.offset),with:this.transformNode(e.with),having:this.transformNode(e.having),explain:this.transformNode(e.explain),setOperations:this.transformNodeList(e.setOperations)}}transformSelection(e){return{kind:"SelectionNode",selection:this.transformNode(e.selection)}}transformColumn(e){return{kind:"ColumnNode",column:this.transformNode(e.column)}}transformAlias(e){return{kind:"AliasNode",node:this.transformNode(e.node),alias:this.transformNode(e.alias)}}transformTable(e){return{kind:"TableNode",table:this.transformNode(e.table)}}transformFrom(e){return{kind:"FromNode",froms:this.transformNodeList(e.froms)}}transformReference(e){return{kind:"ReferenceNode",table:this.transformNode(e.table),column:this.transformNode(e.column)}}transformAnd(e){return{kind:"AndNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformOr(e){return{kind:"OrNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformValueList(e){return{kind:"ValueListNode",values:this.transformNodeList(e.values)}}transformParens(e){return{kind:"ParensNode",node:this.transformNode(e.node)}}transformJoin(e){return{kind:"JoinNode",joinType:e.joinType,table:this.transformNode(e.table),on:this.transformNode(e.on)}}transformRaw(e){return{kind:"RawNode",sqlFragments:freeze([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters)}}transformWhere(e){return{kind:"WhereNode",where:this.transformNode(e.where)}}transformInsertQuery(e){return{kind:"InsertQueryNode",into:this.transformNode(e.into),columns:this.transformNodeList(e.columns),values:this.transformNode(e.values),returning:this.transformNode(e.returning),onConflict:this.transformNode(e.onConflict),onDuplicateKey:this.transformNode(e.onDuplicateKey),with:this.transformNode(e.with),ignore:e.ignore,replace:e.replace,explain:this.transformNode(e.explain)}}transformValues(e){return{kind:"ValuesNode",values:this.transformNodeList(e.values)}}transformDeleteQuery(e){return{kind:"DeleteQueryNode",from:this.transformNode(e.from),using:this.transformNode(e.using),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),returning:this.transformNode(e.returning),with:this.transformNode(e.with),orderBy:this.transformNode(e.orderBy),limit:this.transformNode(e.limit),explain:this.transformNode(e.explain)}}transformReturning(e){return{kind:"ReturningNode",selections:this.transformNodeList(e.selections)}}transformCreateTable(e){return{kind:"CreateTableNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),constraints:this.transformNodeList(e.constraints),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers)}}transformColumnDefinition(e){return{kind:"ColumnDefinitionNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),references:this.transformNode(e.references),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo),check:this.transformNode(e.check),generated:this.transformNode(e.generated),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers)}}transformAddColumn(e){return{kind:"AddColumnNode",column:this.transformNode(e.column)}}transformDropTable(e){return{kind:"DropTableNode",table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformOrderBy(e){return{kind:"OrderByNode",items:this.transformNodeList(e.items)}}transformOrderByItem(e){return{kind:"OrderByItemNode",orderBy:this.transformNode(e.orderBy),direction:this.transformNode(e.direction)}}transformGroupBy(e){return{kind:"GroupByNode",items:this.transformNodeList(e.items)}}transformGroupByItem(e){return{kind:"GroupByItemNode",groupBy:this.transformNode(e.groupBy)}}transformUpdateQuery(e){return{kind:"UpdateQueryNode",table:this.transformNode(e.table),from:this.transformNode(e.from),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),updates:this.transformNodeList(e.updates),returning:this.transformNode(e.returning),with:this.transformNode(e.with),explain:this.transformNode(e.explain)}}transformColumnUpdate(e){return{kind:"ColumnUpdateNode",column:this.transformNode(e.column),value:this.transformNode(e.value)}}transformLimit(e){return{kind:"LimitNode",limit:this.transformNode(e.limit)}}transformOffset(e){return{kind:"OffsetNode",offset:this.transformNode(e.offset)}}transformOnConflict(e){return{kind:"OnConflictNode",columns:this.transformNodeList(e.columns),constraint:this.transformNode(e.constraint),indexExpression:this.transformNode(e.indexExpression),indexWhere:this.transformNode(e.indexWhere),updates:this.transformNodeList(e.updates),updateWhere:this.transformNode(e.updateWhere),doNothing:e.doNothing}}transformOnDuplicateKey(e){return{kind:"OnDuplicateKeyNode",updates:this.transformNodeList(e.updates)}}transformCreateIndex(e){return{kind:"CreateIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists,where:this.transformNode(e.where)}}transformList(e){return{kind:"ListNode",items:this.transformNodeList(e.items)}}transformDropIndex(e){return{kind:"DropIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformPrimaryKeyConstraint(e){return{kind:"PrimaryKeyConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)}}transformUniqueConstraint(e){return{kind:"UniqueConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)}}transformForeignKeyConstraint(e){return{kind:"ForeignKeyConstraintNode",columns:this.transformNodeList(e.columns),references:this.transformNode(e.references),name:this.transformNode(e.name),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformSetOperation(e){return{kind:"SetOperationNode",operator:e.operator,expression:this.transformNode(e.expression),all:e.all}}transformReferences(e){return{kind:"ReferencesNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformCheckConstraint(e){return{kind:"CheckConstraintNode",expression:this.transformNode(e.expression),name:this.transformNode(e.name)}}transformWith(e){return{kind:"WithNode",expressions:this.transformNodeList(e.expressions),recursive:e.recursive}}transformCommonTableExpression(e){return{kind:"CommonTableExpressionNode",name:this.transformNode(e.name),expression:this.transformNode(e.expression)}}transformCommonTableExpressionName(e){return{kind:"CommonTableExpressionNameNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns)}}transformHaving(e){return{kind:"HavingNode",having:this.transformNode(e.having)}}transformCreateSchema(e){return{kind:"CreateSchemaNode",schema:this.transformNode(e.schema),ifNotExists:e.ifNotExists}}transformDropSchema(e){return{kind:"DropSchemaNode",schema:this.transformNode(e.schema),ifExists:e.ifExists,cascade:e.cascade}}transformAlterTable(e){return{kind:"AlterTableNode",table:this.transformNode(e.table),renameTo:this.transformNode(e.renameTo),setSchema:this.transformNode(e.setSchema),columnAlterations:this.transformNodeList(e.columnAlterations),addConstraint:this.transformNode(e.addConstraint),dropConstraint:this.transformNode(e.dropConstraint)}}transformDropColumn(e){return{kind:"DropColumnNode",column:this.transformNode(e.column)}}transformRenameColumn(e){return{kind:"RenameColumnNode",column:this.transformNode(e.column),renameTo:this.transformNode(e.renameTo)}}transformAlterColumn(e){return{kind:"AlterColumnNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),dataTypeExpression:this.transformNode(e.dataTypeExpression),setDefault:this.transformNode(e.setDefault),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull}}transformModifyColumn(e){return{kind:"ModifyColumnNode",column:this.transformNode(e.column)}}transformAddConstraint(e){return{kind:"AddConstraintNode",constraint:this.transformNode(e.constraint)}}transformDropConstraint(e){return{kind:"DropConstraintNode",constraintName:this.transformNode(e.constraintName),ifExists:e.ifExists,modifier:e.modifier}}transformCreateView(e){return{kind:"CreateViewNode",name:this.transformNode(e.name),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns),as:this.transformNode(e.as)}}transformDropView(e){return{kind:"DropViewNode",name:this.transformNode(e.name),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade}}transformGenerated(e){return{kind:"GeneratedNode",byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression)}}transformDefaultValue(e){return{kind:"DefaultValueNode",defaultValue:this.transformNode(e.defaultValue)}}transformOn(e){return{kind:"OnNode",on:this.transformNode(e.on)}}transformSelectModifier(e){return{kind:"SelectModifierNode",modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier)}}transformCreateType(e){return{kind:"CreateTypeNode",name:this.transformNode(e.name),enum:this.transformNode(e.enum)}}transformDropType(e){return{kind:"DropTypeNode",name:this.transformNode(e.name),ifExists:e.ifExists}}transformExplain(e){return{kind:"ExplainNode",format:e.format,options:this.transformNode(e.options)}}transformSchemableIdentifier(e){return{kind:"SchemableIdentifierNode",schema:this.transformNode(e.schema),identifier:this.transformNode(e.identifier)}}transformAggregateFunction(e){return{kind:"AggregateFunctionNode",aggregated:this.transformNodeList(e.aggregated),distinct:e.distinct,filter:this.transformNode(e.filter),func:e.func,over:this.transformNode(e.over)}}transformOver(e){return{kind:"OverNode",orderBy:this.transformNode(e.orderBy),partitionBy:this.transformNode(e.partitionBy)}}transformPartitionBy(e){return{kind:"PartitionByNode",items:this.transformNodeList(e.items)}}transformPartitionByItem(e){return{kind:"PartitionByItemNode",partitionBy:this.transformNode(e.partitionBy)}}transformBinaryOperation(e){return{kind:"BinaryOperationNode",leftOperand:this.transformNode(e.leftOperand),operator:this.transformNode(e.operator),rightOperand:this.transformNode(e.rightOperand)}}transformUnaryOperation(e){return{kind:"UnaryOperationNode",operator:this.transformNode(e.operator),operand:this.transformNode(e.operand)}}transformUsing(e){return{kind:"UsingNode",tables:this.transformNodeList(e.tables)}}transformFunction(e){return{kind:"FunctionNode",func:e.func,arguments:this.transformNodeList(e.arguments)}}transformCase(e){return{kind:"CaseNode",value:this.transformNode(e.value),when:this.transformNodeList(e.when),else:this.transformNode(e.else),isStatement:e.isStatement}}transformWhen(e){return{kind:"WhenNode",condition:this.transformNode(e.condition),result:this.transformNode(e.result)}}transformDataType(e){return e}transformSelectAll(e){return e}transformIdentifier(e){return e}transformValue(e){return e}transformPrimitiveValueList(e){return e}transformOperator(e){return e}transformDefaultInsertValue(e){return e}}zn=new WeakMap;const ROOT_OPERATION_NODES=freeze({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0});var wr,Zt,Qn,uo,Pn,lo,er,Jr,nn,Ti,Mn,co;class WithSchemaTransformer extends OperationNodeTransformer{constructor(t){super();T(this,Qn);T(this,Pn);T(this,er);T(this,nn);T(this,Mn);T(this,wr,void 0);T(this,Zt,new Set);k(this,wr,t)}transformNodeImpl(t){if(!ie(this,Qn,uo).call(this,t))return super.transformNodeImpl(t);const n=ie(this,Pn,lo).call(this,t);for(const a of n)i(this,Zt).add(a);const s=super.transformNodeImpl(t);for(const a of n)i(this,Zt).delete(a);return s}transformSchemableIdentifier(t){const n=super.transformSchemableIdentifier(t);return n.schema||!i(this,Zt).has(t.identifier.name)?n:{...n,schema:IdentifierNode.create(i(this,wr))}}transformReferences(t){const n=super.transformReferences(t);return n.table.table.schema?n:{...n,table:TableNode.createWithSchema(i(this,wr),n.table.table.identifier.name)}}}wr=new WeakMap,Zt=new WeakMap,Qn=new WeakSet,uo=function(t){return t.kind in ROOT_OPERATION_NODES},Pn=new WeakSet,lo=function(t){const n=new Set;if("name"in t&&t.name&&SchemableIdentifierNode.is(t.name)&&ie(this,nn,Ti).call(this,t.name,n),"from"in t&&t.from)for(const s of t.from.froms)ie(this,er,Jr).call(this,s,n);if("into"in t&&t.into&&ie(this,er,Jr).call(this,t.into,n),"table"in t&&t.table&&ie(this,er,Jr).call(this,t.table,n),"joins"in t&&t.joins)for(const s of t.joins)ie(this,er,Jr).call(this,s.table,n);return"with"in t&&t.with&&ie(this,Mn,co).call(this,t.with,n),n},er=new WeakSet,Jr=function(t,n){const s=TableNode.is(t)?t:AliasNode.is(t)&&TableNode.is(t.node)?t.node:null;s&&ie(this,nn,Ti).call(this,s.table,n)},nn=new WeakSet,Ti=function(t,n){i(this,Zt).has(t.identifier.name)||n.add(t.identifier.name)},Mn=new WeakSet,co=function(t,n){for(const s of t.expressions)n.delete(s.name.table.table.identifier.name)};var sn;class WithSchemaPlugin{constructor(e){T(this,sn,void 0);k(this,sn,new WithSchemaTransformer(e))}transformQuery(e){return i(this,sn).transformNode(e.node)}async transformResult(e){return e.result}}sn=new WeakMap;var be;const Kt=class{constructor(e){T(this,be,void 0);k(this,be,freeze(e))}selectFrom(e){return new SelectQueryBuilder({queryId:createQueryId(),executor:i(this,be).executor,queryNode:SelectQueryNode.create(parseTableExpressionOrList(e),i(this,be).withNode)})}insertInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:i(this,be).executor,queryNode:InsertQueryNode.create(parseTable(e),i(this,be).withNode)})}replaceInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:i(this,be).executor,queryNode:InsertQueryNode.create(parseTable(e),i(this,be).withNode,!0)})}deleteFrom(e){return new DeleteQueryBuilder({queryId:createQueryId(),executor:i(this,be).executor,queryNode:DeleteQueryNode.create(parseTableExpressionOrList(e),i(this,be).withNode)})}updateTable(e){return new UpdateQueryBuilder({queryId:createQueryId(),executor:i(this,be).executor,queryNode:UpdateQueryNode.create(parseTableExpression(e),i(this,be).withNode)})}with(e,t){const n=parseCommonTableExpression(e,t);return new Kt({...i(this,be),withNode:i(this,be).withNode?WithNode.cloneWithExpression(i(this,be).withNode,n):WithNode.create(n)})}withRecursive(e,t){const n=parseCommonTableExpression(e,t);return new Kt({...i(this,be),withNode:i(this,be).withNode?WithNode.cloneWithExpression(i(this,be).withNode,n):WithNode.create(n,{recursive:!0})})}withPlugin(e){return new Kt({...i(this,be),executor:i(this,be).executor.withPlugin(e)})}withoutPlugins(){return new Kt({...i(this,be),executor:i(this,be).executor.withoutPlugins()})}withSchema(e){return new Kt({...i(this,be),executor:i(this,be).executor.withPluginAtFront(new WithSchemaPlugin(e))})}};let QueryCreator=Kt;be=new WeakMap;var on,Er,gr;class Deferred{constructor(){T(this,on,void 0);T(this,Er,void 0);T(this,gr,void 0);ce(this,"resolve",e=>{i(this,Er)&&i(this,Er).call(this,e)});ce(this,"reject",e=>{i(this,gr)&&i(this,gr).call(this,e)});k(this,on,new Promise((e,t)=>{k(this,gr,t),k(this,Er,e)}))}get promise(){return i(this,on)}}on=new WeakMap,Er=new WeakMap,gr=new WeakMap;const LOGGED_MESSAGES=new Set;function logOnce(r){LOGGED_MESSAGES.has(r)||(LOGGED_MESSAGES.add(r),console.log(r))}const NO_PLUGINS=freeze([]);var tr,an,vi;class QueryExecutorBase{constructor(e=NO_PLUGINS){T(this,an);T(this,tr,void 0);k(this,tr,e)}get plugins(){return i(this,tr)}transformQuery(e,t){for(const n of i(this,tr)){const s=n.transformQuery({node:e,queryId:t});if(s.kind===e.kind)e=s;else throw new Error(["KyselyPlugin.transformQuery must return a node","of the same kind that was given to it.",`The plugin was given a ${e.kind}`,`but it returned a ${s.kind}`].join(" "))}return e}async executeQuery(e,t){return await this.provideConnection(async n=>{const s=await n.executeQuery(e),a=await ie(this,an,vi).call(this,s,t);return warnOfOutdatedDriverOrPlugins(s,a),a})}async*stream(e,t,n){const s=new Deferred,a=new Deferred;this.provideConnection(async d=>(s.resolve(d),await a.promise)).catch(d=>s.reject(d));const c=await s.promise;try{for await(const d of c.streamQuery(e,t))yield await ie(this,an,vi).call(this,d,n)}finally{a.resolve()}}}tr=new WeakMap,an=new WeakSet,vi=async function(e,t){for(const n of i(this,tr))e=await n.transformResult({result:e,queryId:t});return e};function warnOfOutdatedDriverOrPlugins(r,e){const{numAffectedRows:t}=r;t===void 0&&r.numUpdatedOrDeletedRows===void 0||t!==void 0&&e.numAffectedRows!==void 0||logOnce("kysely:warning: outdated driver/plugin detected! QueryResult.numUpdatedOrDeletedRows is deprecated and will be removed in a future release.")}class NoopQueryExecutor extends QueryExecutorBase{get adapter(){throw new Error("this query cannot be compiled to SQL")}compileQuery(){throw new Error("this query cannot be compiled to SQL")}provideConnection(){throw new Error("this query cannot be executed")}withConnectionProvider(){throw new Error("this query cannot have a connection provider")}withPlugin(e){return new NoopQueryExecutor([...this.plugins,e])}withPlugins(e){return new NoopQueryExecutor([...this.plugins,...e])}withPluginAtFront(e){return new NoopQueryExecutor([e,...this.plugins])}withoutPlugins(){return new NoopQueryExecutor([])}}const NOOP_QUERY_EXECUTOR=new NoopQueryExecutor;function createSelectQueryBuilder(){return new SelectQueryBuilder({queryId:createQueryId(),executor:NOOP_QUERY_EXECUTOR,queryNode:SelectQueryNode.create(parseTableExpressionOrList([]))})}function createQueryCreator(){return new QueryCreator({executor:NOOP_QUERY_EXECUTOR})}function createJoinBuilder(r,e){return new JoinBuilder({joinNode:JoinNode.create(r,parseTableExpression(e))})}function createOverBuilder(){return new OverBuilder({overNode:OverNode.create()})}const WhenNode=freeze({is(r){return r.kind==="WhenNode"},create(r){return freeze({kind:"WhenNode",condition:r})},cloneWithResult(r,e){return freeze({...r,result:e})}}),CaseNode=freeze({is(r){return r.kind==="CaseNode"},create(r){return freeze({kind:"CaseNode",value:r})},cloneWithWhen(r,e){return freeze({...r,when:freeze(r.when?[...r.when,e]:[e])})},cloneWithThen(r,e){return freeze({...r,when:r.when?freeze([...r.when.slice(0,-1),WhenNode.cloneWithResult(r.when[r.when.length-1],e)]):void 0})},cloneWith(r,e){return freeze({...r,...e})}});function parseValueBinaryOperation(r,e,t){if(!isBinaryOperator(e)&&!isOperationNodeSource(e))throw new Error(`invalid binary operator ${JSON.stringify(e)}`);return isIsComparison(e,t)?parseIs(r,e,t):BinaryOperationNode.create(parseReferenceExpression(r),parseOperator(e),parseValueExpressionOrList(t))}function parseReferentialBinaryOperation(r,e,t){if(!isBinaryOperator(e)&&!isOperationNodeSource(e))throw new Error(`invalid binary operator ${JSON.stringify(e)}`);return BinaryOperationNode.create(parseReferenceExpression(r),parseOperator(e),parseReferenceExpression(t))}function parseValueComparison(r,e,t){if(!isComparisonOperator(e)&&!isOperationNodeSource(e))throw new Error(`invalid comparison operator ${JSON.stringify(e)}`);return parseValueBinaryOperation(r,e,t)}function parseReferentialComparison(r,e,t){if(!isComparisonOperator(e)&&!isOperationNodeSource(e))throw new Error(`invalid comparison operator ${JSON.stringify(e)}`);return parseReferentialBinaryOperation(r,e,t)}function parseWhere(r){return parseFilter("where",r)}function parseHaving(r){return parseFilter("having",r)}function parseOn(r){return parseFilter("on",r)}function parseWhen(r){return parseFilter("when",r)}function parseFilter(r,e){if(e.length===3)return parseValueComparison(e[0],e[1],e[2]);if(e.length===1)return parseOneArgFilterExpression(r,e[0]);throw createFilterExpressionError(r,e)}function isIsComparison(r,e){return(r==="is"||r==="is not")&&(isNull(e)||isBoolean(e))}function parseIs(r,e,t){return BinaryOperationNode.create(parseReferenceExpression(r),parseOperator(e),ValueNode.createImmediate(t))}function parseOperator(r){if(isString(r)&&OPERATORS.includes(r))return OperatorNode.create(r);if(isOperationNodeSource(r))return r.toOperationNode();throw new Error(`invalid operator ${JSON.stringify(r)}`)}function parseOneArgFilterExpression(r,e){if(isFunction(e)){if(r==="when")throw new Error("when method doesn't accept a callback as an argument");return CALLBACK_PARSERS[r](e)}else if(isOperationNodeSource(e)){const t=e.toOperationNode();if(RawNode.is(t)||BinaryOperationNode.is(t)||UnaryOperationNode.is(t)||ParensNode.is(t)||CaseNode.is(t))return t}else if(r==="when")return ValueNode.create(e);throw createFilterExpressionError(r,e)}function createFilterExpressionError(r,e){return new Error(`invalid arguments passed to a '${r}' method: ${JSON.stringify(e)}`)}const CALLBACK_PARSERS=freeze({where(r){const e=createSelectQueryBuilder(),t=expressionBuilder(),s=r(Object.assign(e,t)).toOperationNode();if(SelectQueryNode.is(s)){if(!s.where)throw new Error("no `where` methods called inside a group callback");return ParensNode.create(s.where.where)}else return s},having(r){const e=createSelectQueryBuilder(),t=expressionBuilder(),s=r(Object.assign(e,t)).toOperationNode();if(SelectQueryNode.is(s)){if(!s.having)throw new Error("no `having` methods called inside a group callback");return ParensNode.create(s.having.having)}else return s},on(r){const e=createJoinBuilder("InnerJoin","table"),t=expressionBuilder(),s=r(Object.assign(e,t)).toOperationNode();if(JoinNode.is(s)){if(!s.on)throw new Error("no `on` methods called inside a group callback");return ParensNode.create(s.on.on)}else return s}});function parseJoin(r,e){if(e.length===3)return parseSingleOnJoin(r,e[0],e[1],e[2]);if(e.length===2)return parseCallbackJoin(r,e[0],e[1]);throw new Error("not implemented")}function parseCallbackJoin(r,e,t){return t(createJoinBuilder(r,e)).toOperationNode()}function parseSingleOnJoin(r,e,t,n){return JoinNode.createWithOn(r,parseTableExpression(e),parseReferentialComparison(t,"=",n))}const OffsetNode=freeze({is(r){return r.kind==="OffsetNode"},create(r){return freeze({kind:"OffsetNode",offset:ValueNode.create(r)})}}),GroupByItemNode=freeze({is(r){return r.kind==="GroupByItemNode"},create(r){return freeze({kind:"GroupByItemNode",groupBy:r})}});function parseGroupBy(r){return r=isFunction(r)?r(expressionBuilder()):r,parseReferenceExpressionOrList(r).map(GroupByItemNode.create)}const SetOperationNode=freeze({is(r){return r.kind==="SetOperationNode"},create(r,e,t){return freeze({kind:"SetOperationNode",operator:r,expression:e,all:t})}});function parseSetOperation(r,e,t){return SetOperationNode.create(r,e.toOperationNode(),t)}var I;const H=class{constructor(e){T(this,I,void 0);k(this,I,freeze(e))}get expressionType(){}where(...e){return new H({...i(this,I),queryNode:QueryNode.cloneWithWhere(i(this,I).queryNode,parseWhere(e))})}whereRef(e,t,n){return new H({...i(this,I),queryNode:QueryNode.cloneWithWhere(i(this,I).queryNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new H({...i(this,I),queryNode:QueryNode.cloneWithOrWhere(i(this,I).queryNode,parseWhere(e))})}orWhereRef(e,t,n){return new H({...i(this,I),queryNode:QueryNode.cloneWithOrWhere(i(this,I).queryNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new H({...i(this,I),queryNode:QueryNode.cloneWithWhere(i(this,I).queryNode,parseExists(e))})}whereNotExists(e){return new H({...i(this,I),queryNode:QueryNode.cloneWithWhere(i(this,I).queryNode,parseNotExists(e))})}orWhereExists(e){return new H({...i(this,I),queryNode:QueryNode.cloneWithOrWhere(i(this,I).queryNode,parseExists(e))})}orWhereNotExists(e){return new H({...i(this,I),queryNode:QueryNode.cloneWithOrWhere(i(this,I).queryNode,parseNotExists(e))})}having(...e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseHaving(e))})}havingRef(e,t,n){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseReferentialComparison(e,t,n))})}orHaving(...e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithOrHaving(i(this,I).queryNode,parseHaving(e))})}orHavingRef(e,t,n){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithOrHaving(i(this,I).queryNode,parseReferentialComparison(e,t,n))})}havingExists(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseExists(e))})}havingNotExist(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseNotExists(e))})}havingNotExists(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseNotExists(e))})}orHavingExists(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithOrHaving(i(this,I).queryNode,parseExists(e))})}orHavingNotExists(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithOrHaving(i(this,I).queryNode,parseNotExists(e))})}select(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithSelections(i(this,I).queryNode,parseSelectArg(e))})}distinctOn(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithDistinctOn(i(this,I).queryNode,parseReferenceExpressionOrList(e))})}modifyFront(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithFrontModifier(i(this,I).queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}modifyEnd(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}distinct(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithFrontModifier(i(this,I).queryNode,SelectModifierNode.create("Distinct"))})}forUpdate(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("ForUpdate"))})}forShare(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("ForShare"))})}forKeyShare(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("ForKeyShare"))})}forNoKeyUpdate(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("ForNoKeyUpdate"))})}skipLocked(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("SkipLocked"))})}noWait(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("NoWait"))})}selectAll(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithSelections(i(this,I).queryNode,parseSelectAll(e))})}innerJoin(...e){return new H({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new H({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new H({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new H({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("FullJoin",e))})}innerJoinLateral(...e){return new H({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("LateralInnerJoin",e))})}leftJoinLateral(...e){return new H({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("LateralLeftJoin",e))})}orderBy(e,t){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithOrderByItem(i(this,I).queryNode,parseOrderBy(e,t))})}groupBy(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithGroupByItems(i(this,I).queryNode,parseGroupBy(e))})}limit(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithLimit(i(this,I).queryNode,LimitNode.create(e))})}offset(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithOffset(i(this,I).queryNode,OffsetNode.create(e))})}union(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("union",e,!1))})}unionAll(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("union",e,!0))})}intersect(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("intersect",e,!1))})}intersectAll(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("intersect",e,!0))})}except(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("except",e,!1))})}exceptAll(e){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("except",e,!0))})}as(e){return new AliasedSelectQueryBuilder(this,e)}clearSelect(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithoutSelections(i(this,I).queryNode)})}clearWhere(){return new H({...i(this,I),queryNode:QueryNode.cloneWithoutWhere(i(this,I).queryNode)})}clearLimit(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithoutLimit(i(this,I).queryNode)})}clearOffset(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithoutOffset(i(this,I).queryNode)})}clearOrderBy(){return new H({...i(this,I),queryNode:SelectQueryNode.cloneWithoutOrderBy(i(this,I).queryNode)})}$call(e){return e(this)}call(e){return this.$call(e)}$if(e,t){return e?t(this):new H({...i(this,I)})}if(e,t){return this.$if(e,t)}$castTo(){return new H(i(this,I))}castTo(){return this.$castTo()}$narrowType(){return new H(i(this,I))}$assertType(){return new H(i(this,I))}assertType(){return new H(i(this,I))}withPlugin(e){return new H({...i(this,I),executor:i(this,I).executor.withPlugin(e)})}toOperationNode(){return i(this,I).executor.transformQuery(i(this,I).queryNode,i(this,I).queryId)}compile(){return i(this,I).executor.compileQuery(this.toOperationNode(),i(this,I).queryId)}async execute(){const e=this.compile();return(await i(this,I).executor.executeQuery(e,i(this,I).queryId)).rows}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,I).executor.stream(t,e,i(this,I).queryId);for await(const s of n)yield*s.rows}async explain(e,t){return await new H({...i(this,I),queryNode:QueryNode.cloneWithExplain(i(this,I).queryNode,e,t)}).execute()}};let SelectQueryBuilder=H;I=new WeakMap;preventAwait(SelectQueryBuilder,"don't await SelectQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var _r,Or;class AliasedSelectQueryBuilder{constructor(e,t){T(this,_r,void 0);T(this,Or,void 0);k(this,_r,e),k(this,Or,t)}get expression(){return i(this,_r)}get alias(){return i(this,Or)}toOperationNode(){return AliasNode.create(i(this,_r).toOperationNode(),IdentifierNode.create(i(this,Or)))}}_r=new WeakMap,Or=new WeakMap;var Tr;const xi=class{constructor(e){T(this,Tr,void 0);k(this,Tr,e)}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}$castTo(){return new xi(i(this,Tr))}toOperationNode(){return i(this,Tr)}};let ExpressionWrapper=xi;Tr=new WeakMap;var vr,Qt;class AliasedExpressionWrapper{constructor(e,t){T(this,vr,void 0);T(this,Qt,void 0);k(this,vr,e),k(this,Qt,t)}get expression(){return i(this,vr)}get alias(){return i(this,Qt)}toOperationNode(){return AliasNode.create(i(this,vr).toOperationNode(),isOperationNodeSource(i(this,Qt))?i(this,Qt).toOperationNode():IdentifierNode.create(i(this,Qt)))}}vr=new WeakMap,Qt=new WeakMap;const AggregateFunctionNode=freeze({is(r){return r.kind==="AggregateFunctionNode"},create(r,e=[]){return freeze({kind:"AggregateFunctionNode",func:r,aggregated:e})},cloneWithDistinct(r){return freeze({...r,distinct:!0})},cloneWithFilter(r,e){return freeze({...r,filter:r.filter?WhereNode.cloneWithOperation(r.filter,"And",e):WhereNode.create(e)})},cloneWithOrFilter(r,e){return freeze({...r,filter:r.filter?WhereNode.cloneWithOperation(r.filter,"Or",e):WhereNode.create(e)})},cloneWithOver(r,e){return freeze({...r,over:e})}}),FunctionNode=freeze({is(r){return r.kind==="FunctionNode"},create(r,e){return freeze({kind:"FunctionNode",func:r,arguments:e})}});var Ee;const at=class{constructor(e){T(this,Ee,void 0);k(this,Ee,freeze(e))}get expressionType(){}as(e){return new AliasedAggregateFunctionBuilder(this,e)}distinct(){return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithDistinct(i(this,Ee).aggregateFunctionNode)})}filterWhere(...e){return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,Ee).aggregateFunctionNode,parseWhere(e))})}filterWhereExists(e){return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,Ee).aggregateFunctionNode,parseExists(e))})}filterWhereNotExists(e){return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,Ee).aggregateFunctionNode,parseNotExists(e))})}filterWhereRef(e,t,n){return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,Ee).aggregateFunctionNode,parseReferentialComparison(e,t,n))})}orFilterWhere(...e){return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithOrFilter(i(this,Ee).aggregateFunctionNode,parseWhere(e))})}orFilterWhereExists(e){return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithOrFilter(i(this,Ee).aggregateFunctionNode,parseExists(e))})}orFilterWhereNotExists(e){return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithOrFilter(i(this,Ee).aggregateFunctionNode,parseNotExists(e))})}orFilterWhereRef(e,t,n){return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithOrFilter(i(this,Ee).aggregateFunctionNode,parseReferentialComparison(e,t,n))})}over(e){const t=createOverBuilder();return new at({...i(this,Ee),aggregateFunctionNode:AggregateFunctionNode.cloneWithOver(i(this,Ee).aggregateFunctionNode,(e?e(t):t).toOperationNode())})}$call(e){return e(this)}toOperationNode(){return i(this,Ee).aggregateFunctionNode}};let AggregateFunctionBuilder=at;Ee=new WeakMap;preventAwait(AggregateFunctionBuilder,"don't await AggregateFunctionBuilder instances. They are never executed directly and are always just a part of a query.");var Ir,Sr;class AliasedAggregateFunctionBuilder{constructor(e,t){T(this,Ir,void 0);T(this,Sr,void 0);k(this,Ir,e),k(this,Sr,t)}get expression(){return i(this,Ir)}get alias(){return i(this,Sr)}toOperationNode(){return AliasNode.create(i(this,Ir).toOperationNode(),IdentifierNode.create(i(this,Sr)))}}Ir=new WeakMap,Sr=new WeakMap;function createFunctionModule(){const r=(t,n)=>new ExpressionWrapper(FunctionNode.create(t,parseReferenceExpressionOrList(n))),e=(t,n)=>new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create(t,n?parseReferenceExpressionOrList(n):void 0)});return Object.assign(r,{agg:e,avg(t){return e("avg",[t])},coalesce(t,...n){return r("coalesce",[t,...n])},count(t){return e("count",[t])},countAll(t){return new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create("count",parseSelectAll(t))})},max(t){return e("max",[t])},min(t){return e("min",[t])},sum(t){return e("sum",[t])}})}var Cr;class CaseBuilder{constructor(e){T(this,Cr,void 0);k(this,Cr,freeze(e))}when(...e){return new CaseThenBuilder({...i(this,Cr),node:CaseNode.cloneWithWhen(i(this,Cr).node,WhenNode.create(parseWhen(e)))})}}Cr=new WeakMap;var Rr;class CaseThenBuilder{constructor(e){T(this,Rr,void 0);k(this,Rr,freeze(e))}then(e){return new CaseWhenBuilder({...i(this,Rr),node:CaseNode.cloneWithThen(i(this,Rr).node,parseValueExpression(e))})}}Rr=new WeakMap;var _t;class CaseWhenBuilder{constructor(e){T(this,_t,void 0);k(this,_t,freeze(e))}when(...e){return new CaseThenBuilder({...i(this,_t),node:CaseNode.cloneWithWhen(i(this,_t).node,WhenNode.create(parseWhen(e)))})}else(e){return new CaseEndBuilder({...i(this,_t),node:CaseNode.cloneWith(i(this,_t).node,{else:parseValueExpression(e)})})}end(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,_t).node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,_t).node,{isStatement:!0}))}}_t=new WeakMap;var xr;class CaseEndBuilder{constructor(e){T(this,xr,void 0);k(this,xr,freeze(e))}end(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,xr).node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,xr).node,{isStatement:!0}))}}xr=new WeakMap;function createExpressionBuilder(r=NOOP_QUERY_EXECUTOR){function e(t,n){return new ExpressionWrapper(parseUnaryOperation(t,n))}return{get fn(){return createFunctionModule()},selectFrom(t){return new SelectQueryBuilder({queryId:createQueryId(),executor:r,queryNode:SelectQueryNode.create(parseTableExpressionOrList(t))})},case(t){return new CaseBuilder({node:CaseNode.create(isUndefined(t)?void 0:parseReferenceExpression(t))})},ref(t){return new ExpressionWrapper(parseStringReference(t))},val(t){return new ExpressionWrapper(parseValueExpressionOrList(t))},cmpr(t,n,s){return new ExpressionWrapper(parseValueBinaryOperation(t,n,s))},bxp(t,n,s){return new ExpressionWrapper(parseValueBinaryOperation(t,n,s))},unary:e,not(t){return e("not",t)},exists(t){return e("exists",t)},neg(t){return e("-",t)},and(t){if(t.length===0)return new ExpressionWrapper(ValueNode.createImmediate(!0));if(t.length===1)return new ExpressionWrapper(t[0].toOperationNode());let n=AndNode.create(t[0].toOperationNode(),t[1].toOperationNode());for(let s=2;s<t.length;++s)n=AndNode.create(n,t[s].toOperationNode());return new ExpressionWrapper(ParensNode.create(n))},or(t){if(t.length===0)return new ExpressionWrapper(ValueNode.createImmediate(!1));if(t.length===1)return new ExpressionWrapper(t[0].toOperationNode());let n=OrNode.create(t[0].toOperationNode(),t[1].toOperationNode());for(let s=2;s<t.length;++s)n=OrNode.create(n,t[s].toOperationNode());return new ExpressionWrapper(ParensNode.create(n))},withSchema(t){return createExpressionBuilder(r.withPluginAtFront(new WithSchemaPlugin(t)))}}}function expressionBuilder(r){return createExpressionBuilder()}function parseExpression(r){if(isOperationNodeSource(r))return r.toOperationNode();if(isFunction(r))return r(expressionBuilder()).toOperationNode();throw new Error(`invalid expression: ${JSON.stringify(r)}`)}function parseAliasedExpression(r){if(isOperationNodeSource(r))return r.toOperationNode();if(isFunction(r))return r(expressionBuilder()).toOperationNode();throw new Error(`invalid aliased expression: ${JSON.stringify(r)}`)}function isExpressionOrFactory(r){return isExpression(r)||isAliasedExpression(r)||isFunction(r)}function parseTableExpressionOrList(r){return isReadonlyArray(r)?r.map(e=>parseTableExpression(e)):[parseTableExpression(r)]}function parseTableExpression(r){return isString(r)?parseAliasedTable(r):parseAliasedExpression(r)}function parseAliasedTable(r){const e=" as ";if(r.includes(e)){const[t,n]=r.split(e).map(trim$1);return AliasNode.create(parseTable(t),IdentifierNode.create(n))}else return parseTable(r)}function parseTable(r){const e=".";if(r.includes(e)){const[t,n]=r.split(e).map(trim$1);return TableNode.createWithSchema(t,n)}else return TableNode.create(r)}function trim$1(r){return r.trim()}const AddColumnNode=freeze({is(r){return r.kind==="AddColumnNode"},create(r){return freeze({kind:"AddColumnNode",column:r})}}),AlterColumnNode=freeze({is(r){return r.kind==="AlterColumnNode"},create(r){return freeze({kind:"AlterColumnNode",column:ColumnNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}}),ColumnDefinitionNode=freeze({is(r){return r.kind==="ColumnDefinitionNode"},create(r,e){return freeze({kind:"ColumnDefinitionNode",column:ColumnNode.create(r),dataType:e})},cloneWithFrontModifier(r,e){return freeze({...r,frontModifiers:r.frontModifiers?freeze([...r.frontModifiers,e]):[e]})},cloneWithEndModifier(r,e){return freeze({...r,endModifiers:r.endModifiers?freeze([...r.endModifiers,e]):[e]})},cloneWith(r,e){return freeze({...r,...e})}}),DropColumnNode=freeze({is(r){return r.kind==="DropColumnNode"},create(r){return freeze({kind:"DropColumnNode",column:ColumnNode.create(r)})}}),RenameColumnNode=freeze({is(r){return r.kind==="RenameColumnNode"},create(r,e){return freeze({kind:"RenameColumnNode",column:ColumnNode.create(r),renameTo:ColumnNode.create(e)})}}),CheckConstraintNode=freeze({is(r){return r.kind==="CheckConstraintNode"},create(r,e){return freeze({kind:"CheckConstraintNode",expression:r,name:e?IdentifierNode.create(e):void 0})}}),ON_MODIFY_FOREIGN_ACTIONS=["no action","restrict","cascade","set null","set default"],ReferencesNode=freeze({is(r){return r.kind==="ReferencesNode"},create(r,e){return freeze({kind:"ReferencesNode",table:r,columns:freeze([...e])})},cloneWithOnDelete(r,e){return freeze({...r,onDelete:e})},cloneWithOnUpdate(r,e){return freeze({...r,onUpdate:e})}});function parseDefaultValueExpression(r){return isOperationNodeSource(r)?r.toOperationNode():ValueNode.createImmediate(r)}const GeneratedNode=freeze({is(r){return r.kind==="GeneratedNode"},create(r){return freeze({kind:"GeneratedNode",...r})},createWithExpression(r){return freeze({kind:"GeneratedNode",always:!0,expression:r})},cloneWith(r,e){return freeze({...r,...e})}}),DefaultValueNode=freeze({is(r){return r.kind==="DefaultValueNode"},create(r){return freeze({kind:"DefaultValueNode",defaultValue:r})}});function parseOnModifyForeignAction(r){if(ON_MODIFY_FOREIGN_ACTIONS.includes(r))return r;throw new Error(`invalid OnModifyForeignAction ${r}`)}var me;const Fe=class{constructor(e){T(this,me,void 0);k(this,me,e)}autoIncrement(){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{autoIncrement:!0}))}primaryKey(){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{primaryKey:!0}))}references(e){const t=parseStringReference(e);if(!ReferenceNode.is(t)||SelectAllNode.is(t.column))throw new Error(`invalid call references('${e}'). The reference must have format table.column or schema.table.column`);return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{references:ReferencesNode.create(t.table,[t.column])}))}onDelete(e){if(!i(this,me).references)throw new Error("on delete constraint can only be added for foreign keys");return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{references:ReferencesNode.cloneWithOnDelete(i(this,me).references,parseOnModifyForeignAction(e))}))}onUpdate(e){if(!i(this,me).references)throw new Error("on update constraint can only be added for foreign keys");return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{references:ReferencesNode.cloneWithOnUpdate(i(this,me).references,parseOnModifyForeignAction(e))}))}unique(){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{unique:!0}))}notNull(){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{notNull:!0}))}unsigned(){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{unsigned:!0}))}defaultTo(e){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{defaultTo:DefaultValueNode.create(parseDefaultValueExpression(e))}))}check(e){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{check:CheckConstraintNode.create(e.toOperationNode())}))}generatedAlwaysAs(e){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{generated:GeneratedNode.createWithExpression(e.toOperationNode())}))}generatedAlwaysAsIdentity(){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{generated:GeneratedNode.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{generated:GeneratedNode.create({identity:!0,byDefault:!0})}))}stored(){if(!i(this,me).generated)throw new Error("stored() can only be called after generatedAlwaysAs");return new Fe(ColumnDefinitionNode.cloneWith(i(this,me),{generated:GeneratedNode.cloneWith(i(this,me).generated,{stored:!0})}))}modifyFront(e){return new Fe(ColumnDefinitionNode.cloneWithFrontModifier(i(this,me),e.toOperationNode()))}modifyEnd(e){return new Fe(ColumnDefinitionNode.cloneWithEndModifier(i(this,me),e.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return i(this,me)}};let ColumnDefinitionBuilder=Fe;me=new WeakMap;preventAwait(ColumnDefinitionBuilder,"don't await ColumnDefinitionBuilder instances directly.");const ModifyColumnNode=freeze({is(r){return r.kind==="ModifyColumnNode"},create(r){return freeze({kind:"ModifyColumnNode",column:r})}}),DataTypeNode=freeze({is(r){return r.kind==="DataTypeNode"},create(r){return freeze({kind:"DataTypeNode",dataType:r})}});function parseDataTypeExpression(r){return isOperationNodeSource(r)?r.toOperationNode():DataTypeNode.create(r)}const ForeignKeyConstraintNode=freeze({is(r){return r.kind==="ForeignKeyConstraintNode"},create(r,e,t,n){return freeze({kind:"ForeignKeyConstraintNode",columns:r,references:ReferencesNode.create(e,t),name:n?IdentifierNode.create(n):void 0})},cloneWith(r,e){return freeze({...r,...e})}});var rr;const $n=class{constructor(e){T(this,rr,void 0);k(this,rr,e)}onDelete(e){return new $n(ForeignKeyConstraintNode.cloneWith(i(this,rr),{onDelete:parseOnModifyForeignAction(e)}))}onUpdate(e){return new $n(ForeignKeyConstraintNode.cloneWith(i(this,rr),{onUpdate:parseOnModifyForeignAction(e)}))}$call(e){return e(this)}toOperationNode(){return i(this,rr)}};let ForeignKeyConstraintBuilder=$n;rr=new WeakMap;preventAwait(ForeignKeyConstraintBuilder,"don't await ForeignKeyConstraintBuilder instances directly.");const AddConstraintNode=freeze({is(r){return r.kind==="AddConstraintNode"},create(r){return freeze({kind:"AddConstraintNode",constraint:r})}}),UniqueConstraintNode=freeze({is(r){return r.kind==="UniqueConstraintNode"},create(r,e){return freeze({kind:"UniqueConstraintNode",columns:freeze(r.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0})}}),DropConstraintNode=freeze({is(r){return r.kind==="DropConstraintNode"},create(r){return freeze({kind:"DropConstraintNode",constraintName:IdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}});class AlterColumnBuilder{constructor(e){ce(this,"alterColumnNode");this.alterColumnNode=e}setDataType(e){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{dataType:parseDataTypeExpression(e)}))}setDefault(e){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{setDefault:parseDefaultValueExpression(e)}))}dropDefault(){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{dropDefault:!0}))}setNotNull(){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{setNotNull:!0}))}dropNotNull(){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{dropNotNull:!0}))}$call(e){return e(this)}}class AlteredColumnBuilder extends AlterColumnBuilder{toOperationNode(){return this.alterColumnNode}}var ht;class AlterTableExecutor{constructor(e){T(this,ht,void 0);k(this,ht,freeze(e))}toOperationNode(){return i(this,ht).executor.transformQuery(i(this,ht).node,i(this,ht).queryId)}compile(){return i(this,ht).executor.compileQuery(this.toOperationNode(),i(this,ht).queryId)}async execute(){await i(this,ht).executor.executeQuery(this.compile(),i(this,ht).queryId)}}ht=new WeakMap;preventAwait(AlterTableExecutor,"don't await AlterTableExecutor instances directly. To execute the query you need to call `execute`");var He;const Un=class{constructor(e){T(this,He,void 0);k(this,He,freeze(e))}onDelete(e){return new Un({...i(this,He),constraintBuilder:i(this,He).constraintBuilder.onDelete(e)})}onUpdate(e){return new Un({...i(this,He),constraintBuilder:i(this,He).constraintBuilder.onUpdate(e)})}$call(e){return e(this)}toOperationNode(){return i(this,He).executor.transformQuery(AlterTableNode.cloneWithTableProps(i(this,He).node,{addConstraint:AddConstraintNode.create(i(this,He).constraintBuilder.toOperationNode())}),i(this,He).queryId)}compile(){return i(this,He).executor.compileQuery(this.toOperationNode(),i(this,He).queryId)}async execute(){await i(this,He).executor.executeQuery(this.compile(),i(this,He).queryId)}};let AlterTableAddForeignKeyConstraintBuilder=Un;He=new WeakMap;preventAwait(AlterTableAddForeignKeyConstraintBuilder,"don't await AlterTableAddForeignKeyConstraintBuilder instances directly. To execute the query you need to call `execute`");var ke;const jr=class{constructor(e){T(this,ke,void 0);k(this,ke,freeze(e))}ifExists(){return new jr({...i(this,ke),node:AlterTableNode.cloneWithTableProps(i(this,ke).node,{dropConstraint:DropConstraintNode.cloneWith(i(this,ke).node.dropConstraint,{ifExists:!0})})})}cascade(){return new jr({...i(this,ke),node:AlterTableNode.cloneWithTableProps(i(this,ke).node,{dropConstraint:DropConstraintNode.cloneWith(i(this,ke).node.dropConstraint,{modifier:"cascade"})})})}restrict(){return new jr({...i(this,ke),node:AlterTableNode.cloneWithTableProps(i(this,ke).node,{dropConstraint:DropConstraintNode.cloneWith(i(this,ke).node.dropConstraint,{modifier:"restrict"})})})}$call(e){return e(this)}toOperationNode(){return i(this,ke).executor.transformQuery(i(this,ke).node,i(this,ke).queryId)}compile(){return i(this,ke).executor.compileQuery(this.toOperationNode(),i(this,ke).queryId)}async execute(){await i(this,ke).executor.executeQuery(this.compile(),i(this,ke).queryId)}};let AlterTableDropConstraintBuilder=jr;ke=new WeakMap;preventAwait(AlterTableDropConstraintBuilder,"don't await AlterTableDropConstraintBuilder instances directly. To execute the query you need to call `execute`");var ge;class AlterTableBuilder{constructor(e){T(this,ge,void 0);k(this,ge,freeze(e))}renameTo(e){return new AlterTableExecutor({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{renameTo:parseTable(e)})})}setSchema(e){return new AlterTableExecutor({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{setSchema:IdentifierNode.create(e)})})}alterColumn(e,t){const n=t(new AlterColumnBuilder(AlterColumnNode.create(e)));return new AlterTableColumnAlteringBuilder({...i(this,ge),node:AlterTableNode.cloneWithColumnAlteration(i(this,ge).node,n.toOperationNode())})}dropColumn(e){return new AlterTableColumnAlteringBuilder({...i(this,ge),node:AlterTableNode.cloneWithColumnAlteration(i(this,ge).node,DropColumnNode.create(e))})}renameColumn(e,t){return new AlterTableColumnAlteringBuilder({...i(this,ge),node:AlterTableNode.cloneWithColumnAlteration(i(this,ge).node,RenameColumnNode.create(e,t))})}addColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...i(this,ge),node:AlterTableNode.cloneWithColumnAlteration(i(this,ge).node,AddColumnNode.create(s.toOperationNode()))})}modifyColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...i(this,ge),node:AlterTableNode.cloneWithColumnAlteration(i(this,ge).node,ModifyColumnNode.create(s.toOperationNode()))})}addUniqueConstraint(e,t){return new AlterTableExecutor({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{addConstraint:AddConstraintNode.create(UniqueConstraintNode.create(t,e))})})}addCheckConstraint(e,t){return new AlterTableExecutor({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{addConstraint:AddConstraintNode.create(CheckConstraintNode.create(t.toOperationNode(),e))})})}addForeignKeyConstraint(e,t,n,s){return new AlterTableAddForeignKeyConstraintBuilder({...i(this,ge),constraintBuilder:new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(t.map(ColumnNode.create),parseTable(n),s.map(ColumnNode.create),e))})}dropConstraint(e){return new AlterTableDropConstraintBuilder({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{dropConstraint:DropConstraintNode.create(e)})})}$call(e){return e(this)}call(e){return this.$call(e)}}ge=new WeakMap;var Re;const Gt=class{constructor(e){T(this,Re,void 0);k(this,Re,freeze(e))}alterColumn(e,t){const n=t(new AlterColumnBuilder(AlterColumnNode.create(e)));return new Gt({...i(this,Re),node:AlterTableNode.cloneWithColumnAlteration(i(this,Re).node,n.toOperationNode())})}dropColumn(e){return new Gt({...i(this,Re),node:AlterTableNode.cloneWithColumnAlteration(i(this,Re).node,DropColumnNode.create(e))})}renameColumn(e,t){return new Gt({...i(this,Re),node:AlterTableNode.cloneWithColumnAlteration(i(this,Re).node,RenameColumnNode.create(e,t))})}addColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new Gt({...i(this,Re),node:AlterTableNode.cloneWithColumnAlteration(i(this,Re).node,AddColumnNode.create(s.toOperationNode()))})}modifyColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new Gt({...i(this,Re),node:AlterTableNode.cloneWithColumnAlteration(i(this,Re).node,ModifyColumnNode.create(s.toOperationNode()))})}toOperationNode(){return i(this,Re).executor.transformQuery(i(this,Re).node,i(this,Re).queryId)}compile(){return i(this,Re).executor.compileQuery(this.toOperationNode(),i(this,Re).queryId)}async execute(){await i(this,Re).executor.executeQuery(this.compile(),i(this,Re).queryId)}};let AlterTableColumnAlteringBuilder=Gt;Re=new WeakMap;preventAwait(AlterTableBuilder,"don't await AlterTableBuilder instances");preventAwait(AlterColumnBuilder,"don't await AlterColumnBuilder instances");preventAwait(AlterTableColumnAlteringBuilder,"don't await AlterTableColumnAlteringBuilder instances directly. To execute the query you need to call `execute`");class ImmediateValueTransformer extends OperationNodeTransformer{transformValue(e){return{...super.transformValue(e),immediate:!0}}}var ye;const gt=class{constructor(e){T(this,ye,void 0);k(this,ye,freeze(e))}ifNotExists(){return new gt({...i(this,ye),node:CreateIndexNode.cloneWith(i(this,ye).node,{ifNotExists:!0})})}unique(){return new gt({...i(this,ye),node:CreateIndexNode.cloneWith(i(this,ye).node,{unique:!0})})}on(e){return new gt({...i(this,ye),node:CreateIndexNode.cloneWith(i(this,ye).node,{table:parseTable(e)})})}column(e){return new gt({...i(this,ye),node:CreateIndexNode.cloneWithColumns(i(this,ye).node,[parseOrderedColumnName(e)])})}columns(e){return new gt({...i(this,ye),node:CreateIndexNode.cloneWithColumns(i(this,ye).node,e.map(parseOrderedColumnName))})}expression(e){return new gt({...i(this,ye),node:CreateIndexNode.cloneWithColumns(i(this,ye).node,[e.toOperationNode()])})}using(e){return new gt({...i(this,ye),node:CreateIndexNode.cloneWith(i(this,ye).node,{using:RawNode.createWithSql(e)})})}where(...e){const t=new ImmediateValueTransformer;return new gt({...i(this,ye),node:QueryNode.cloneWithWhere(i(this,ye).node,t.transformNode(parseWhere(e)))})}$call(e){return e(this)}toOperationNode(){return i(this,ye).executor.transformQuery(i(this,ye).node,i(this,ye).queryId)}compile(){return i(this,ye).executor.compileQuery(this.toOperationNode(),i(this,ye).queryId)}async execute(){await i(this,ye).executor.executeQuery(this.compile(),i(this,ye).queryId)}};let CreateIndexBuilder=gt;ye=new WeakMap;preventAwait(CreateIndexBuilder,"don't await CreateIndexBuilder instances directly. To execute the query you need to call `execute`");var nt;const ki=class{constructor(e){T(this,nt,void 0);k(this,nt,freeze(e))}ifNotExists(){return new ki({...i(this,nt),node:CreateSchemaNode.cloneWith(i(this,nt).node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,nt).executor.transformQuery(i(this,nt).node,i(this,nt).queryId)}compile(){return i(this,nt).executor.compileQuery(this.toOperationNode(),i(this,nt).queryId)}async execute(){await i(this,nt).executor.executeQuery(this.compile(),i(this,nt).queryId)}};let CreateSchemaBuilder=ki;nt=new WeakMap;preventAwait(CreateSchemaBuilder,"don't await CreateSchemaBuilder instances directly. To execute the query you need to call `execute`");const PrimaryConstraintNode=freeze({is(r){return r.kind==="PrimaryKeyConstraintNode"},create(r,e){return freeze({kind:"PrimaryKeyConstraintNode",columns:freeze(r.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0})}});function parseOnCommitAction(r){if(ON_COMMIT_ACTIONS.includes(r))return r;throw new Error(`invalid OnCommitAction ${r}`)}var fe;const ut=class{constructor(e){T(this,fe,void 0);k(this,fe,freeze(e))}temporary(){return new ut({...i(this,fe),node:CreateTableNode.cloneWith(i(this,fe).node,{temporary:!0})})}onCommit(e){return new ut({...i(this,fe),node:CreateTableNode.cloneWith(i(this,fe).node,{onCommit:parseOnCommitAction(e)})})}ifNotExists(){return new ut({...i(this,fe),node:CreateTableNode.cloneWith(i(this,fe).node,{ifNotExists:!0})})}addColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new ut({...i(this,fe),node:CreateTableNode.cloneWithColumn(i(this,fe).node,s.toOperationNode())})}addPrimaryKeyConstraint(e,t){return new ut({...i(this,fe),node:CreateTableNode.cloneWithConstraint(i(this,fe).node,PrimaryConstraintNode.create(t,e))})}addUniqueConstraint(e,t){return new ut({...i(this,fe),node:CreateTableNode.cloneWithConstraint(i(this,fe).node,UniqueConstraintNode.create(t,e))})}addCheckConstraint(e,t){return new ut({...i(this,fe),node:CreateTableNode.cloneWithConstraint(i(this,fe).node,CheckConstraintNode.create(t.toOperationNode(),e))})}addForeignKeyConstraint(e,t,n,s,a=noop$1){const c=a(new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(t.map(ColumnNode.create),parseTable(n),s.map(ColumnNode.create),e)));return new ut({...i(this,fe),node:CreateTableNode.cloneWithConstraint(i(this,fe).node,c.toOperationNode())})}modifyFront(e){return new ut({...i(this,fe),node:CreateTableNode.cloneWithFrontModifier(i(this,fe).node,e.toOperationNode())})}modifyEnd(e){return new ut({...i(this,fe),node:CreateTableNode.cloneWithEndModifier(i(this,fe).node,e.toOperationNode())})}$call(e){return e(this)}call(e){return this.$call(e)}toOperationNode(){return i(this,fe).executor.transformQuery(i(this,fe).node,i(this,fe).queryId)}compile(){return i(this,fe).executor.compileQuery(this.toOperationNode(),i(this,fe).queryId)}async execute(){await i(this,fe).executor.executeQuery(this.compile(),i(this,fe).queryId)}};let CreateTableBuilder=ut;fe=new WeakMap;preventAwait(CreateTableBuilder,"don't await CreateTableBuilder instances directly. To execute the query you need to call `execute`");var Me;const Kr=class{constructor(e){T(this,Me,void 0);k(this,Me,freeze(e))}on(e){return new Kr({...i(this,Me),node:DropIndexNode.cloneWith(i(this,Me).node,{table:parseTable(e)})})}ifExists(){return new Kr({...i(this,Me),node:DropIndexNode.cloneWith(i(this,Me).node,{ifExists:!0})})}cascade(){return new Kr({...i(this,Me),node:DropIndexNode.cloneWith(i(this,Me).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,Me).executor.transformQuery(i(this,Me).node,i(this,Me).queryId)}compile(){return i(this,Me).executor.compileQuery(this.toOperationNode(),i(this,Me).queryId)}async execute(){await i(this,Me).executor.executeQuery(this.compile(),i(this,Me).queryId)}};let DropIndexBuilder=Kr;Me=new WeakMap;preventAwait(DropIndexBuilder,"don't await DropIndexBuilder instances directly. To execute the query you need to call `execute`");var Ge;const Vn=class{constructor(e){T(this,Ge,void 0);k(this,Ge,freeze(e))}ifExists(){return new Vn({...i(this,Ge),node:DropSchemaNode.cloneWith(i(this,Ge).node,{ifExists:!0})})}cascade(){return new Vn({...i(this,Ge),node:DropSchemaNode.cloneWith(i(this,Ge).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,Ge).executor.transformQuery(i(this,Ge).node,i(this,Ge).queryId)}compile(){return i(this,Ge).executor.compileQuery(this.toOperationNode(),i(this,Ge).queryId)}async execute(){await i(this,Ge).executor.executeQuery(this.compile(),i(this,Ge).queryId)}};let DropSchemaBuilder=Vn;Ge=new WeakMap;preventAwait(DropSchemaBuilder,"don't await DropSchemaBuilder instances directly. To execute the query you need to call `execute`");var Xe;const Hn=class{constructor(e){T(this,Xe,void 0);k(this,Xe,freeze(e))}ifExists(){return new Hn({...i(this,Xe),node:DropTableNode.cloneWith(i(this,Xe).node,{ifExists:!0})})}cascade(){return new Hn({...i(this,Xe),node:DropTableNode.cloneWith(i(this,Xe).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,Xe).executor.transformQuery(i(this,Xe).node,i(this,Xe).queryId)}compile(){return i(this,Xe).executor.compileQuery(this.toOperationNode(),i(this,Xe).queryId)}async execute(){await i(this,Xe).executor.executeQuery(this.compile(),i(this,Xe).queryId)}};let DropTableBuilder=Hn;Xe=new WeakMap;preventAwait(DropTableBuilder,"don't await DropTableBuilder instances directly. To execute the query you need to call `execute`");const CreateViewNode=freeze({is(r){return r.kind==="CreateViewNode"},create(r){return freeze({kind:"CreateViewNode",name:SchemableIdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}});var Jn;class ImmediateValuePlugin{constructor(){T(this,Jn,new ImmediateValueTransformer)}transformQuery(e){return i(this,Jn).transformNode(e.node)}transformResult(e){return Promise.resolve(e.result)}}Jn=new WeakMap;var Se;const zt=class{constructor(e){T(this,Se,void 0);k(this,Se,freeze(e))}temporary(){return new zt({...i(this,Se),node:CreateViewNode.cloneWith(i(this,Se).node,{temporary:!0})})}materialized(){return new zt({...i(this,Se),node:CreateViewNode.cloneWith(i(this,Se).node,{materialized:!0})})}ifNotExists(){return new zt({...i(this,Se),node:CreateViewNode.cloneWith(i(this,Se).node,{ifNotExists:!0})})}orReplace(){return new zt({...i(this,Se),node:CreateViewNode.cloneWith(i(this,Se).node,{orReplace:!0})})}columns(e){return new zt({...i(this,Se),node:CreateViewNode.cloneWith(i(this,Se).node,{columns:e.map(parseColumnName)})})}as(e){const t=e.withPlugin(new ImmediateValuePlugin).toOperationNode();return new zt({...i(this,Se),node:CreateViewNode.cloneWith(i(this,Se).node,{as:t})})}$call(e){return e(this)}toOperationNode(){return i(this,Se).executor.transformQuery(i(this,Se).node,i(this,Se).queryId)}compile(){return i(this,Se).executor.compileQuery(this.toOperationNode(),i(this,Se).queryId)}async execute(){await i(this,Se).executor.executeQuery(this.compile(),i(this,Se).queryId)}};let CreateViewBuilder=zt;Se=new WeakMap;preventAwait(CreateViewBuilder,"don't await CreateViewBuilder instances directly. To execute the query you need to call `execute`");const DropViewNode=freeze({is(r){return r.kind==="DropViewNode"},create(r){return freeze({kind:"DropViewNode",name:SchemableIdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}});var $e;const Gr=class{constructor(e){T(this,$e,void 0);k(this,$e,freeze(e))}materialized(){return new Gr({...i(this,$e),node:DropViewNode.cloneWith(i(this,$e).node,{materialized:!0})})}ifExists(){return new Gr({...i(this,$e),node:DropViewNode.cloneWith(i(this,$e).node,{ifExists:!0})})}cascade(){return new Gr({...i(this,$e),node:DropViewNode.cloneWith(i(this,$e).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,$e).executor.transformQuery(i(this,$e).node,i(this,$e).queryId)}compile(){return i(this,$e).executor.compileQuery(this.toOperationNode(),i(this,$e).queryId)}async execute(){await i(this,$e).executor.executeQuery(this.compile(),i(this,$e).queryId)}};let DropViewBuilder=Gr;$e=new WeakMap;preventAwait(DropViewBuilder,"don't await DropViewBuilder instances directly. To execute the query you need to call `execute`");const CreateTypeNode=freeze({is(r){return r.kind==="CreateTypeNode"},create(r){return freeze({kind:"CreateTypeNode",name:r})},cloneWithEnum(r,e){return freeze({...r,enum:ValueListNode.create(e.map(t=>ValueNode.createImmediate(t)))})}});var it;const Ai=class{constructor(e){T(this,it,void 0);k(this,it,freeze(e))}toOperationNode(){return i(this,it).executor.transformQuery(i(this,it).node,i(this,it).queryId)}asEnum(e){return new Ai({...i(this,it),node:CreateTypeNode.cloneWithEnum(i(this,it).node,e)})}$call(e){return e(this)}compile(){return i(this,it).executor.compileQuery(this.toOperationNode(),i(this,it).queryId)}async execute(){await i(this,it).executor.executeQuery(this.compile(),i(this,it).queryId)}};let CreateTypeBuilder=Ai;it=new WeakMap;preventAwait(CreateTypeBuilder,"don't await CreateTypeBuilder instances directly. To execute the query you need to call `execute`");const DropTypeNode=freeze({is(r){return r.kind==="DropTypeNode"},create(r){return freeze({kind:"DropTypeNode",name:r})},cloneWith(r,e){return freeze({...r,...e})}});var st;const Wi=class{constructor(e){T(this,st,void 0);k(this,st,freeze(e))}ifExists(){return new Wi({...i(this,st),node:DropTypeNode.cloneWith(i(this,st).node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,st).executor.transformQuery(i(this,st).node,i(this,st).queryId)}compile(){return i(this,st).executor.compileQuery(this.toOperationNode(),i(this,st).queryId)}async execute(){await i(this,st).executor.executeQuery(this.compile(),i(this,st).queryId)}};let DropTypeBuilder=Wi;st=new WeakMap;preventAwait(DropTypeBuilder,"don't await DropTypeBuilder instances directly. To execute the query you need to call `execute`");function parseSchemableIdentifier(r){const e=".";if(r.includes(e)){const t=r.split(e).map(trim);if(t.length===2)return SchemableIdentifierNode.createWithSchema(t[0],t[1]);throw new Error(`invalid schemable identifier ${r}`)}else return SchemableIdentifierNode.create(r)}function trim(r){return r.trim()}var Be;const Xr=class{constructor(e){T(this,Be,void 0);k(this,Be,e)}createTable(e){return new CreateTableBuilder({queryId:createQueryId(),executor:i(this,Be),node:CreateTableNode.create(parseTable(e))})}dropTable(e){return new DropTableBuilder({queryId:createQueryId(),executor:i(this,Be),node:DropTableNode.create(parseTable(e))})}createIndex(e){return new CreateIndexBuilder({queryId:createQueryId(),executor:i(this,Be),node:CreateIndexNode.create(e)})}dropIndex(e){return new DropIndexBuilder({queryId:createQueryId(),executor:i(this,Be),node:DropIndexNode.create(e)})}createSchema(e){return new CreateSchemaBuilder({queryId:createQueryId(),executor:i(this,Be),node:CreateSchemaNode.create(e)})}dropSchema(e){return new DropSchemaBuilder({queryId:createQueryId(),executor:i(this,Be),node:DropSchemaNode.create(e)})}alterTable(e){return new AlterTableBuilder({queryId:createQueryId(),executor:i(this,Be),node:AlterTableNode.create(parseTable(e))})}createView(e){return new CreateViewBuilder({queryId:createQueryId(),executor:i(this,Be),node:CreateViewNode.create(e)})}dropView(e){return new DropViewBuilder({queryId:createQueryId(),executor:i(this,Be),node:DropViewNode.create(e)})}createType(e){return new CreateTypeBuilder({queryId:createQueryId(),executor:i(this,Be),node:CreateTypeNode.create(parseSchemableIdentifier(e))})}dropType(e){return new DropTypeBuilder({queryId:createQueryId(),executor:i(this,Be),node:DropTypeNode.create(parseSchemableIdentifier(e))})}withPlugin(e){return new Xr(i(this,Be).withPlugin(e))}withoutPlugins(){return new Xr(i(this,Be).withoutPlugins())}withSchema(e){return new Xr(i(this,Be).withPluginAtFront(new WithSchemaPlugin(e)))}};let SchemaModule=Xr;Be=new WeakMap;class DynamicModule{ref(e){return new DynamicReferenceBuilder(e)}}var kr;class DefaultConnectionProvider{constructor(e){T(this,kr,void 0);k(this,kr,e)}async provideConnection(e){const t=await i(this,kr).acquireConnection();try{return await e(t)}finally{await i(this,kr).releaseConnection(t)}}}kr=new WeakMap;var Ot,Tt,Ct;const Xt=class extends QueryExecutorBase{constructor(t,n,s,a=[]){super(a);T(this,Ot,void 0);T(this,Tt,void 0);T(this,Ct,void 0);k(this,Ot,t),k(this,Tt,n),k(this,Ct,s)}get adapter(){return i(this,Tt)}compileQuery(t){return i(this,Ot).compileQuery(t)}provideConnection(t){return i(this,Ct).provideConnection(t)}withPlugins(t){return new Xt(i(this,Ot),i(this,Tt),i(this,Ct),[...this.plugins,...t])}withPlugin(t){return new Xt(i(this,Ot),i(this,Tt),i(this,Ct),[...this.plugins,t])}withPluginAtFront(t){return new Xt(i(this,Ot),i(this,Tt),i(this,Ct),[t,...this.plugins])}withConnectionProvider(t){return new Xt(i(this,Ot),i(this,Tt),t,[...this.plugins])}withoutPlugins(){return new Xt(i(this,Ot),i(this,Tt),i(this,Ct),[])}};let DefaultQueryExecutor=Xt;Ot=new WeakMap,Tt=new WeakMap,Ct=new WeakMap;function performanceNow(){return typeof performance<"u"&&isFunction(performance.now)?performance.now():Date.now()}var pt,Pt,Rt,nr,un,jn,fo,Kn,ho,Gn,po,Xn,mo,ln,Ii;class RuntimeDriver{constructor(e,t){T(this,jn);T(this,Kn);T(this,Gn);T(this,Xn);T(this,ln);T(this,pt,void 0);T(this,Pt,void 0);T(this,Rt,void 0);T(this,nr,void 0);T(this,un,new WeakSet);k(this,pt,e),k(this,Pt,t)}async init(){i(this,Rt)||k(this,Rt,i(this,pt).init().catch(e=>(k(this,Rt,void 0),Promise.reject(e)))),await i(this,Rt)}async acquireConnection(){await this.init();const e=await i(this,pt).acquireConnection();return i(this,un).has(e)||(ie(this,jn,fo).call(this)&&ie(this,Kn,ho).call(this,e),i(this,un).add(e)),e}async releaseConnection(e){await i(this,pt).releaseConnection(e)}beginTransaction(e,t){return i(this,pt).beginTransaction(e,t)}commitTransaction(e){return i(this,pt).commitTransaction(e)}rollbackTransaction(e){return i(this,pt).rollbackTransaction(e)}async destroy(){i(this,Rt)&&(await i(this,Rt),i(this,nr)||k(this,nr,i(this,pt).destroy().catch(e=>(k(this,nr,void 0),Promise.reject(e)))),await i(this,nr))}}pt=new WeakMap,Pt=new WeakMap,Rt=new WeakMap,nr=new WeakMap,un=new WeakMap,jn=new WeakSet,fo=function(){return i(this,Pt).isLevelEnabled("query")||i(this,Pt).isLevelEnabled("error")},Kn=new WeakSet,ho=function(e){const t=e.executeQuery;e.executeQuery=async n=>{const s=performanceNow();try{return await t.call(e,n)}catch(a){throw await ie(this,Gn,po).call(this,a,n,s),a}finally{await ie(this,Xn,mo).call(this,n,s)}}},Gn=new WeakSet,po=async function(e,t,n){await i(this,Pt).error(()=>({level:"error",error:e,query:t,queryDurationMillis:ie(this,ln,Ii).call(this,n)}))},Xn=new WeakSet,mo=async function(e,t){await i(this,Pt).query(()=>({level:"query",query:e,queryDurationMillis:ie(this,ln,Ii).call(this,t)}))},ln=new WeakSet,Ii=function(e){return performanceNow()-e};var cn,Mt,Yn,yo;class SingleConnectionProvider{constructor(e){T(this,Yn);T(this,cn,void 0);T(this,Mt,void 0);k(this,cn,e)}async provideConnection(e){for(;i(this,Mt);)await i(this,Mt);const t=ie(this,Yn,yo).call(this,e);return k(this,Mt,t.then(()=>{k(this,Mt,void 0)}).catch(()=>{k(this,Mt,void 0)})),t}}cn=new WeakMap,Mt=new WeakMap,Yn=new WeakSet,yo=async function(e){return await e(i(this,cn))};const TRANSACTION_ISOLATION_LEVELS=["read uncommitted","read committed","repeatable read","serializable"];freeze(["query","error"]);var $t,ir;class Log{constructor(e){T(this,$t,void 0);T(this,ir,void 0);isFunction(e)?(k(this,ir,e),k(this,$t,freeze({query:!0,error:!0}))):(k(this,ir,defaultLogger),k(this,$t,freeze({query:e.includes("query"),error:e.includes("error")})))}isLevelEnabled(e){return i(this,$t)[e]}async query(e){i(this,$t).query&&await i(this,ir).call(this,e())}async error(e){i(this,$t).error&&await i(this,ir).call(this,e())}}$t=new WeakMap,ir=new WeakMap;function defaultLogger(r){r.level==="query"?(console.log(`kysely:query: ${r.query.sql}`),console.log(`kysely:query: duration: ${r.queryDurationMillis.toFixed(1)}ms`)):r.level==="error"&&(r.error instanceof Error?console.error(`kysely:error: ${r.error.stack??r.error.message}`):console.error(`kysely:error: ${r}`))}function isCompilable(r){return isObject$2(r)&&isFunction(r.compile)}var Ue;const mr=class extends QueryCreator{constructor(t){let n,s;if(isKyselyProps(t))n={executor:t.executor},s={...t};else{const a=t.dialect,c=a.createDriver(),d=a.createQueryCompiler(),h=a.createAdapter(),p=new Log(t.log??[]),N=new RuntimeDriver(c,p),O=new DefaultConnectionProvider(N),A=new DefaultQueryExecutor(d,h,O,t.plugins??[]);n={executor:A},s={config:t,executor:A,dialect:a,driver:N}}super(n);T(this,Ue,void 0);k(this,Ue,freeze(s))}get schema(){return new SchemaModule(i(this,Ue).executor)}get dynamic(){return new DynamicModule}get introspection(){return i(this,Ue).dialect.createIntrospector(this.withoutPlugins())}case(t){return new CaseBuilder({node:CaseNode.create(isUndefined(t)?void 0:parseExpression(t))})}get fn(){return createFunctionModule()}transaction(){return new TransactionBuilder({...i(this,Ue)})}connection(){return new ConnectionBuilder({...i(this,Ue)})}withPlugin(t){return new mr({...i(this,Ue),executor:i(this,Ue).executor.withPlugin(t)})}withoutPlugins(){return new mr({...i(this,Ue),executor:i(this,Ue).executor.withoutPlugins()})}withSchema(t){return new mr({...i(this,Ue),executor:i(this,Ue).executor.withPluginAtFront(new WithSchemaPlugin(t))})}withTables(){return new mr({...i(this,Ue)})}async destroy(){await i(this,Ue).driver.destroy()}get isTransaction(){return!1}getExecutor(){return i(this,Ue).executor}executeQuery(t,n=createQueryId()){const s=isCompilable(t)?t.compile():t;return this.getExecutor().executeQuery(s,n)}};let Kysely=mr;Ue=new WeakMap;var mt;const yr=class extends Kysely{constructor(t){super(t);T(this,mt,void 0);k(this,mt,t)}get isTransaction(){return!0}transaction(){throw new Error("calling the transaction method for a Transaction is not supported")}connection(){throw new Error("calling the connection method for a Transaction is not supported")}async destroy(){throw new Error("calling the destroy method for a Transaction is not supported")}withPlugin(t){return new yr({...i(this,mt),executor:i(this,mt).executor.withPlugin(t)})}withoutPlugins(){return new yr({...i(this,mt),executor:i(this,mt).executor.withoutPlugins()})}withSchema(t){return new yr({...i(this,mt),executor:i(this,mt).executor.withPluginAtFront(new WithSchemaPlugin(t))})}withTables(){return new yr({...i(this,mt)})}};let Transaction=yr;mt=new WeakMap;function isKyselyProps(r){return isObject$2(r)&&isObject$2(r.config)&&isObject$2(r.driver)&&isObject$2(r.executor)&&isObject$2(r.dialect)}var sr;class ConnectionBuilder{constructor(e){T(this,sr,void 0);k(this,sr,freeze(e))}async execute(e){return i(this,sr).executor.provideConnection(async t=>{const n=i(this,sr).executor.withConnectionProvider(new SingleConnectionProvider(t)),s=new Kysely({...i(this,sr),executor:n});return await e(s)})}}sr=new WeakMap;preventAwait(ConnectionBuilder,"don't await ConnectionBuilder instances directly. To execute the query you need to call the `execute` method");var yt;const Li=class{constructor(e){T(this,yt,void 0);k(this,yt,freeze(e))}setIsolationLevel(e){return new Li({...i(this,yt),isolationLevel:e})}async execute(e){const{isolationLevel:t,...n}=i(this,yt),s={isolationLevel:t};return validateTransactionSettings(s),i(this,yt).executor.provideConnection(async a=>{const c=i(this,yt).executor.withConnectionProvider(new SingleConnectionProvider(a)),d=new Transaction({...n,executor:c});try{await i(this,yt).driver.beginTransaction(a,s);const h=await e(d);return await i(this,yt).driver.commitTransaction(a),h}catch(h){throw await i(this,yt).driver.rollbackTransaction(a),h}})}};let TransactionBuilder=Li;yt=new WeakMap;preventAwait(TransactionBuilder,"don't await TransactionBuilder instances directly. To execute the transaction you need to call the `execute` method");function validateTransactionSettings(r){if(r.isolationLevel&&!TRANSACTION_ISOLATION_LEVELS.includes(r.isolationLevel))throw new Error(`invalid transaction isolation level ${r.isolationLevel}`)}var tt,Ar,Fn,dn,Si,fn,Ci;const Zn=class{constructor(e){T(this,Ar);T(this,dn);T(this,fn);T(this,tt,void 0);k(this,tt,freeze(e))}get expressionType(){}as(e){return new AliasedRawBuilder(this,e)}$castTo(){return new Zn({...i(this,tt)})}castTo(){return this.$castTo()}withPlugin(e){return new Zn({...i(this,tt),plugins:i(this,tt).plugins!==void 0?freeze([...i(this,tt).plugins,e]):freeze([e])})}toOperationNode(){return ie(this,dn,Si).call(this,ie(this,Ar,Fn).call(this))}compile(e){return ie(this,fn,Ci).call(this,ie(this,Ar,Fn).call(this,e))}async execute(e){const t=ie(this,Ar,Fn).call(this,e);return t.executeQuery(ie(this,fn,Ci).call(this,t),i(this,tt).queryId)}};let RawBuilder=Zn;tt=new WeakMap,Ar=new WeakSet,Fn=function(e){const t=e!==void 0?e.getExecutor():NOOP_QUERY_EXECUTOR;return i(this,tt).plugins!==void 0?t.withPlugins(i(this,tt).plugins):t},dn=new WeakSet,Si=function(e){return e.transformQuery(i(this,tt).rawNode,i(this,tt).queryId)},fn=new WeakSet,Ci=function(e){return e.compileQuery(ie(this,dn,Si).call(this,e),i(this,tt).queryId)};preventAwait(RawBuilder,"don't await RawBuilder instances directly. To execute the query you need to call `execute`");var Wr,Ut;class AliasedRawBuilder{constructor(e,t){T(this,Wr,void 0);T(this,Ut,void 0);k(this,Wr,e),k(this,Ut,t)}get expression(){return i(this,Wr)}get alias(){return i(this,Ut)}toOperationNode(){return AliasNode.create(i(this,Wr).toOperationNode(),isOperationNodeSource(i(this,Ut))?i(this,Ut).toOperationNode():IdentifierNode.create(i(this,Ut)))}}Wr=new WeakMap,Ut=new WeakMap;const sql=Object.assign((r,...e)=>new RawBuilder({queryId:createQueryId(),rawNode:RawNode.create(r,(e==null?void 0:e.map(parseValueExpression))??[])}),{ref(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseStringReference(r))})},val(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseValueExpression(r))})},value(r){return this.val(r)},table(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseTable(r))})},id(...r){const e=new Array(r.length+1).fill(".");return e[0]="",e[e.length-1]="",new RawBuilder({queryId:createQueryId(),rawNode:RawNode.create(e,r.map(IdentifierNode.create))})},lit(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(ValueNode.createImmediate(r))})},literal(r){return this.lit(r)},raw(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithSql(r)})},join(r,e=sql`, `){const t=new Array(2*r.length-1),n=e.toOperationNode();for(let s=0;s<r.length;++s)t[2*s]=parseValueExpression(r[s]),s!==r.length-1&&(t[2*s+1]=n);return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChildren(t)})}});var ei;class OperationNodeVisitor{constructor(){ce(this,"nodeStack",[]);T(this,ei,freeze({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this)}));ce(this,"visitNode",e=>{this.nodeStack.push(e),i(this,ei)[e.kind](e),this.nodeStack.pop()})}get parentNode(){return this.nodeStack[this.nodeStack.length-2]}}ei=new WeakMap;var Lr,or;class DefaultQueryCompiler extends OperationNodeVisitor{constructor(){super(...arguments);T(this,Lr,"");T(this,or,[])}get numParameters(){return i(this,or).length}compileQuery(t){return k(this,Lr,""),k(this,or,[]),this.visitNode(t),freeze({query:t,sql:this.getSql(),parameters:[...i(this,or)]})}getSql(){return i(this,Lr)}visitSelectQuery(t){const n=this.parentNode!==void 0&&!InsertQueryNode.is(this.parentNode)&&!CreateViewNode.is(this.parentNode)&&!SetOperationNode.is(this.parentNode);this.parentNode===void 0&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("select "),t.distinctOn&&(this.compileDistinctOn(t.distinctOn),this.append(" ")),t.frontModifiers&&t.frontModifiers.length>0&&(this.compileList(t.frontModifiers," "),this.append(" ")),t.selections&&(this.compileList(t.selections),this.append(" ")),this.visitNode(t.from),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.groupBy&&(this.append(" "),this.visitNode(t.groupBy)),t.having&&(this.append(" "),this.visitNode(t.having)),t.setOperations&&(this.append(" "),this.compileList(t.setOperations," ")),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.offset&&(this.append(" "),this.visitNode(t.offset)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," ")),n&&this.append(")")}visitFrom(t){this.append("from "),this.compileList(t.froms)}visitSelection(t){this.visitNode(t.selection)}visitColumn(t){this.visitNode(t.column)}compileDistinctOn(t){this.append("distinct on ("),this.compileList(t),this.append(")")}compileList(t,n=", "){const s=t.length-1;for(let a=0;a<=s;a++)this.visitNode(t[a]),a<s&&this.append(n)}visitWhere(t){this.append("where "),this.visitNode(t.where)}visitHaving(t){this.append("having "),this.visitNode(t.having)}visitInsertQuery(t){const n=this.nodeStack.find(QueryNode.is)!==t;!n&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append(t.replace?"replace":"insert"),t.ignore&&this.append(" ignore"),this.append(" into "),this.visitNode(t.into),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.values&&(this.append(" "),this.visitNode(t.values)),t.onConflict&&(this.append(" "),this.visitNode(t.onConflict)),t.onDuplicateKey&&(this.append(" "),this.visitNode(t.onDuplicateKey)),t.returning&&(this.append(" "),this.visitNode(t.returning)),n&&this.append(")")}visitValues(t){this.append("values "),this.compileList(t.values)}visitDeleteQuery(t){const n=this.nodeStack.find(QueryNode.is)!==t;!n&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("delete "),this.visitNode(t.from),t.using&&(this.append(" "),this.visitNode(t.using)),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.returning&&(this.append(" "),this.visitNode(t.returning)),n&&this.append(")")}visitReturning(t){this.append("returning "),this.compileList(t.selections)}visitAlias(t){this.visitNode(t.node),this.append(" as "),this.visitNode(t.alias)}visitReference(t){this.visitNode(t.table),this.append("."),this.visitNode(t.column)}visitSelectAll(t){this.append("*")}visitIdentifier(t){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(t),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(t){if(!isString(t.name))throw new Error("a non-string identifier was passed to compileUnwrappedIdentifier.");this.append(this.sanitizeIdentifier(t.name))}visitAnd(t){this.visitNode(t.left),this.append(" and "),this.visitNode(t.right)}visitOr(t){this.visitNode(t.left),this.append(" or "),this.visitNode(t.right)}visitValue(t){t.immediate?this.appendImmediateValue(t.value):this.appendValue(t.value)}visitValueList(t){this.append("("),this.compileList(t.values),this.append(")")}visitPrimitiveValueList(t){this.append("(");const{values:n}=t;for(let s=0;s<n.length;++s)this.appendValue(n[s]),s!==n.length-1&&this.append(", ");this.append(")")}visitParens(t){this.append("("),this.visitNode(t.node),this.append(")")}visitJoin(t){this.append(JOIN_TYPE_SQL[t.joinType]),this.append(" "),this.visitNode(t.table),t.on&&(this.append(" "),this.visitNode(t.on))}visitOn(t){this.append("on "),this.visitNode(t.on)}visitRaw(t){const{sqlFragments:n,parameters:s}=t;for(let a=0;a<n.length;++a)this.append(n[a]),s.length>a&&this.visitNode(s[a])}visitOperator(t){this.append(t.operator)}visitTable(t){this.visitNode(t.table)}visitSchemableIdentifier(t){t.schema&&(this.visitNode(t.schema),this.append(".")),this.visitNode(t.identifier)}visitCreateTable(t){this.append("create "),t.frontModifiers&&t.frontModifiers.length>0&&(this.compileList(t.frontModifiers," "),this.append(" ")),t.temporary&&this.append("temporary "),this.append("table "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.table),this.append(" ("),this.compileList([...t.columns,...t.constraints??[]]),this.append(")"),t.onCommit&&(this.append(" on commit "),this.append(t.onCommit)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," "))}visitColumnDefinition(t){this.visitNode(t.column),this.append(" "),this.visitNode(t.dataType),t.unsigned&&this.append(" unsigned"),t.frontModifiers&&t.frontModifiers.length>0&&(this.append(" "),this.compileList(t.frontModifiers," ")),t.generated&&(this.append(" "),this.visitNode(t.generated)),t.defaultTo&&(this.append(" "),this.visitNode(t.defaultTo)),t.notNull&&this.append(" not null"),t.unique&&this.append(" unique"),t.primaryKey&&this.append(" primary key"),t.autoIncrement&&(this.append(" "),this.append(this.getAutoIncrement())),t.references&&(this.append(" "),this.visitNode(t.references)),t.check&&(this.append(" "),this.visitNode(t.check)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," "))}getAutoIncrement(){return"auto_increment"}visitReferences(t){this.append("references "),this.visitNode(t.table),this.append(" ("),this.compileList(t.columns),this.append(")"),t.onDelete&&(this.append(" on delete "),this.append(t.onDelete)),t.onUpdate&&(this.append(" on update "),this.append(t.onUpdate))}visitDropTable(t){this.append("drop table "),t.ifExists&&this.append("if exists "),this.visitNode(t.table),t.cascade&&this.append(" cascade")}visitDataType(t){this.append(t.dataType)}visitOrderBy(t){this.append("order by "),this.compileList(t.items)}visitOrderByItem(t){this.visitNode(t.orderBy),t.direction&&(this.append(" "),this.visitNode(t.direction))}visitGroupBy(t){this.append("group by "),this.compileList(t.items)}visitGroupByItem(t){this.visitNode(t.groupBy)}visitUpdateQuery(t){const n=this.nodeStack.find(QueryNode.is)!==t;!n&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("update "),this.visitNode(t.table),this.append(" set "),t.updates&&this.compileList(t.updates),t.from&&(this.append(" "),this.visitNode(t.from)),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.returning&&(this.append(" "),this.visitNode(t.returning)),n&&this.append(")")}visitColumnUpdate(t){this.visitNode(t.column),this.append(" = "),this.visitNode(t.value)}visitLimit(t){this.append("limit "),this.visitNode(t.limit)}visitOffset(t){this.append("offset "),this.visitNode(t.offset)}visitOnConflict(t){this.append("on conflict"),t.columns?(this.append(" ("),this.compileList(t.columns),this.append(")")):t.constraint?(this.append(" on constraint "),this.visitNode(t.constraint)):t.indexExpression&&(this.append(" ("),this.visitNode(t.indexExpression),this.append(")")),t.indexWhere&&(this.append(" "),this.visitNode(t.indexWhere)),t.doNothing===!0?this.append(" do nothing"):t.updates&&(this.append(" do update set "),this.compileList(t.updates),t.updateWhere&&(this.append(" "),this.visitNode(t.updateWhere)))}visitOnDuplicateKey(t){this.append("on duplicate key update "),this.compileList(t.updates)}visitCreateIndex(t){this.append("create "),t.unique&&this.append("unique "),this.append("index "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.name),t.table&&(this.append(" on "),this.visitNode(t.table)),t.using&&(this.append(" using "),this.visitNode(t.using)),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.where&&(this.append(" "),this.visitNode(t.where))}visitDropIndex(t){this.append("drop index "),t.ifExists&&this.append("if exists "),this.visitNode(t.name),t.table&&(this.append(" on "),this.visitNode(t.table)),t.cascade&&this.append(" cascade")}visitCreateSchema(t){this.append("create schema "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.schema)}visitDropSchema(t){this.append("drop schema "),t.ifExists&&this.append("if exists "),this.visitNode(t.schema),t.cascade&&this.append(" cascade")}visitPrimaryKeyConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("primary key ("),this.compileList(t.columns),this.append(")")}visitUniqueConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("unique ("),this.compileList(t.columns),this.append(")")}visitCheckConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("check ("),this.visitNode(t.expression),this.append(")")}visitForeignKeyConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("foreign key ("),this.compileList(t.columns),this.append(") "),this.visitNode(t.references),t.onDelete&&(this.append(" on delete "),this.append(t.onDelete)),t.onUpdate&&(this.append(" on update "),this.append(t.onUpdate))}visitList(t){this.compileList(t.items)}visitWith(t){this.append("with "),t.recursive&&this.append("recursive "),this.compileList(t.expressions)}visitCommonTableExpression(t){this.visitNode(t.name),this.append(" as "),this.visitNode(t.expression)}visitCommonTableExpressionName(t){this.visitNode(t.table),t.columns&&(this.append("("),this.compileList(t.columns),this.append(")"))}visitAlterTable(t){this.append("alter table "),this.visitNode(t.table),this.append(" "),t.renameTo&&(this.append("rename to "),this.visitNode(t.renameTo)),t.setSchema&&(this.append("set schema "),this.visitNode(t.setSchema)),t.addConstraint&&this.visitNode(t.addConstraint),t.dropConstraint&&this.visitNode(t.dropConstraint),t.columnAlterations&&this.compileList(t.columnAlterations)}visitAddColumn(t){this.append("add column "),this.visitNode(t.column)}visitRenameColumn(t){this.append("rename column "),this.visitNode(t.column),this.append(" to "),this.visitNode(t.renameTo)}visitDropColumn(t){this.append("drop column "),this.visitNode(t.column)}visitAlterColumn(t){this.append("alter column "),this.visitNode(t.column),this.append(" "),t.dataType&&(this.append("type "),this.visitNode(t.dataType),t.dataTypeExpression&&(this.append("using "),this.visitNode(t.dataTypeExpression))),t.setDefault&&(this.append("set default "),this.visitNode(t.setDefault)),t.dropDefault&&this.append("drop default"),t.setNotNull&&this.append("set not null"),t.dropNotNull&&this.append("drop not null")}visitModifyColumn(t){this.append("modify column "),this.visitNode(t.column)}visitAddConstraint(t){this.append("add "),this.visitNode(t.constraint)}visitDropConstraint(t){this.append("drop constraint "),t.ifExists&&this.append("if exists "),this.visitNode(t.constraintName),t.modifier==="cascade"?this.append(" cascade"):t.modifier==="restrict"&&this.append(" restrict")}visitSetOperation(t){this.append(t.operator),this.append(" "),t.all&&this.append("all "),this.visitNode(t.expression)}visitCreateView(t){this.append("create "),t.orReplace&&this.append("or replace "),t.materialized&&this.append("materialized "),t.temporary&&this.append("temporary "),this.append("view "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.name),this.append(" "),t.columns&&(this.append("("),this.compileList(t.columns),this.append(") ")),t.as&&(this.append("as "),this.visitNode(t.as))}visitDropView(t){this.append("drop "),t.materialized&&this.append("materialized "),this.append("view "),t.ifExists&&this.append("if exists "),this.visitNode(t.name),t.cascade&&this.append(" cascade")}visitGenerated(t){this.append("generated "),t.always&&this.append("always "),t.byDefault&&this.append("by default "),this.append("as "),t.identity&&this.append("identity"),t.expression&&(this.append("("),this.visitNode(t.expression),this.append(")")),t.stored&&this.append(" stored")}visitDefaultValue(t){this.append("default "),this.visitNode(t.defaultValue)}visitSelectModifier(t){t.rawModifier?this.visitNode(t.rawModifier):this.append(SELECT_MODIFIER_SQL[t.modifier])}visitCreateType(t){this.append("create type "),this.visitNode(t.name),t.enum&&(this.append(" as enum "),this.visitNode(t.enum))}visitDropType(t){this.append("drop type "),t.ifExists&&this.append("if exists "),this.visitNode(t.name)}visitExplain(t){this.append("explain"),(t.options||t.format)&&(this.append(" "),this.append(this.getLeftExplainOptionsWrapper()),t.options&&(this.visitNode(t.options),t.format&&this.append(this.getExplainOptionsDelimiter())),t.format&&(this.append("format"),this.append(this.getExplainOptionAssignment()),this.append(t.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(t){this.append("default")}visitAggregateFunction(t){this.append(t.func),this.append("("),t.distinct&&this.append("distinct "),this.compileList(t.aggregated),this.append(")"),t.filter&&(this.append(" filter("),this.visitNode(t.filter),this.append(")")),t.over&&(this.append(" "),this.visitNode(t.over))}visitOver(t){this.append("over("),t.partitionBy&&(this.visitNode(t.partitionBy),t.orderBy&&this.append(" ")),t.orderBy&&this.visitNode(t.orderBy),this.append(")")}visitPartitionBy(t){this.append("partition by "),this.compileList(t.items)}visitPartitionByItem(t){this.visitNode(t.partitionBy)}visitBinaryOperation(t){this.visitNode(t.leftOperand),this.append(" "),this.visitNode(t.operator),this.append(" "),this.visitNode(t.rightOperand)}visitUnaryOperation(t){this.visitNode(t.operator),this.isMinusOperator(t.operator)||this.append(" "),this.visitNode(t.operand)}isMinusOperator(t){return OperatorNode.is(t)&&t.operator==="-"}visitUsing(t){this.append("using "),this.compileList(t.tables)}visitFunction(t){this.append(t.func),this.append("("),this.compileList(t.arguments),this.append(")")}visitCase(t){this.append("case"),t.value&&(this.append(" "),this.visitNode(t.value)),t.when&&(this.append(" "),this.compileList(t.when," ")),t.else&&(this.append(" else "),this.visitNode(t.else)),this.append(" end"),t.isStatement&&this.append(" case")}visitWhen(t){this.append("when "),this.visitNode(t.condition),t.result&&(this.append(" then "),this.visitNode(t.result))}append(t){k(this,Lr,i(this,Lr)+t)}appendValue(t){this.addParameter(t),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getCurrentParameterPlaceholder(){return"$"+this.numParameters}getLeftExplainOptionsWrapper(){return"("}getExplainOptionAssignment(){return" "}getExplainOptionsDelimiter(){return", "}getRightExplainOptionsWrapper(){return")"}sanitizeIdentifier(t){const n=this.getLeftIdentifierWrapper(),s=this.getRightIdentifierWrapper();let a="";for(const c of t)a+=c,c===n?a+=n:c===s&&(a+=s);return a}addParameter(t){i(this,or).push(t)}appendImmediateValue(t){if(isString(t))this.append(`'${t}'`);else if(isNumber(t)||isBoolean(t))this.append(t.toString());else if(isNull(t))this.append("null");else if(isDate(t))this.appendImmediateValue(t.toISOString());else if(isBigInt(t))this.appendImmediateValue(t.toString());else throw new Error(`invalid immediate value ${t}`)}}Lr=new WeakMap,or=new WeakMap;const SELECT_MODIFIER_SQL=freeze({ForKeyShare:"for key share",ForNoKeyUpdate:"for no key update",ForUpdate:"for update",ForShare:"for share",NoWait:"nowait",SkipLocked:"skip locked",Distinct:"distinct"}),JOIN_TYPE_SQL=freeze({InnerJoin:"inner join",LeftJoin:"left join",RightJoin:"right join",FullJoin:"full join",LateralInnerJoin:"inner join lateral",LateralLeftJoin:"left join lateral"}),CompiledQuery=freeze({raw(r){return freeze({sql:r,query:RawNode.createWithSql(r),parameters:freeze([])})}});var xt,hn,qr,Dr;class SqliteDriver{constructor(e){T(this,xt,void 0);T(this,hn,new ConnectionMutex);T(this,qr,void 0);T(this,Dr,void 0);k(this,xt,freeze({...e}))}async init(){k(this,qr,isFunction(i(this,xt).database)?await i(this,xt).database():i(this,xt).database),k(this,Dr,new SqliteConnection(i(this,qr))),i(this,xt).onCreateConnection&&await i(this,xt).onCreateConnection(i(this,Dr))}async acquireConnection(){return await i(this,hn).lock(),i(this,Dr)}async beginTransaction(e){await e.executeQuery(CompiledQuery.raw("begin"))}async commitTransaction(e){await e.executeQuery(CompiledQuery.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(CompiledQuery.raw("rollback"))}async releaseConnection(){i(this,hn).unlock()}async destroy(){var e;(e=i(this,qr))==null||e.close()}}xt=new WeakMap,hn=new WeakMap,qr=new WeakMap,Dr=new WeakMap;var pn;class SqliteConnection{constructor(e){T(this,pn,void 0);k(this,pn,e)}executeQuery(e){const{sql:t,parameters:n}=e,s=i(this,pn).prepare(t);if(s.reader)return Promise.resolve({rows:s.all(n)});{const{changes:a,lastInsertRowid:c}=s.run(n),d=a!=null?BigInt(a):void 0;return Promise.resolve({numUpdatedOrDeletedRows:d,numAffectedRows:d,insertId:c!=null?BigInt(c):void 0,rows:[]})}}async*streamQuery(){throw new Error("Sqlite driver doesn't support streaming")}}pn=new WeakMap;var ar,Fr;class ConnectionMutex{constructor(){T(this,ar,void 0);T(this,Fr,void 0)}async lock(){for(;i(this,ar);)await i(this,ar);k(this,ar,new Promise(e=>{k(this,Fr,e)}))}unlock(){const e=i(this,Fr);k(this,ar,void 0),k(this,Fr,void 0),e==null||e()}}ar=new WeakMap,Fr=new WeakMap;const ID_WRAP_REGEX=/"/g;class SqliteQueryCompiler extends DefaultQueryCompiler{getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}sanitizeIdentifier(e){return e.replace(ID_WRAP_REGEX,'""')}visitDefaultInsertValue(e){this.append("null")}}const DEFAULT_MIGRATION_TABLE="kysely_migration",DEFAULT_MIGRATION_LOCK_TABLE="kysely_migration_lock";freeze({__noMigrations__:!0});var Br,ti,No;class SqliteIntrospector{constructor(e){T(this,ti);T(this,Br,void 0);k(this,Br,e)}async getSchemas(){return[]}async getTables(e={withInternalKyselyTables:!1}){let t=i(this,Br).selectFrom("sqlite_schema").where("type","in",["table","view"]).where("name","not like","sqlite_%").select("name").orderBy("name").$castTo();e.withInternalKyselyTables||(t=t.where("name","!=",DEFAULT_MIGRATION_TABLE).where("name","!=",DEFAULT_MIGRATION_LOCK_TABLE));const n=await t.execute();return Promise.all(n.map(({name:s})=>ie(this,ti,No).call(this,s)))}async getMetadata(e){return{tables:await this.getTables(e)}}}Br=new WeakMap,ti=new WeakSet,No=async function(e){var c,d,h,p,N,O;const t=i(this,Br),n=await t.selectFrom("sqlite_master").where("name","=",e).select(["sql","type"]).$castTo().executeTakeFirstOrThrow(),s=(O=(N=(p=(h=(d=(c=n.sql)==null?void 0:c.split(/[\(\),]/))==null?void 0:d.find(A=>A.toLowerCase().includes("autoincrement")))==null?void 0:h.trimStart())==null?void 0:p.split(/\s+/))==null?void 0:N[0])==null?void 0:O.replace(/["`]/g,""),a=await t.selectFrom(sql`pragma_table_info(${e})`.as("table_info")).select(["name","type","notnull","dflt_value"]).orderBy("cid").execute();return{name:e,isView:n.type==="view",columns:a.map(A=>({name:A.name,dataType:A.type,isNullable:!A.notnull,isAutoIncrementing:A.name===s,hasDefaultValue:A.dflt_value!=null}))}};class SqliteAdapter{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(){}async releaseMigrationLock(){}}var mn;class SqliteDialect{constructor(e){T(this,mn,void 0);k(this,mn,freeze({...e}))}createDriver(){return new SqliteDriver(i(this,mn))}createQueryCompiler(){return new SqliteQueryCompiler}createAdapter(){return new SqliteAdapter}createIntrospector(e){return new SqliteIntrospector(e)}}mn=new WeakMap;function toBytes(r){return Uint8Array.from([...r].map(e=>e.charCodeAt(0)))}function fromBytes(r){return String.fromCharCode(...r)}function encode(r){return r.length?[fromBytes(r[0].site_id),...r.flatMap(e=>[e.cid,e.pk,e.table,e.val,e.db_version,e.col_version])]:[]}function decode(r){if(!r[0])return[];const e=toBytes(r[0]),t=[];for(let n=1;n<r.length;n+=6)t.push({site_id:e,cid:r[n],pk:r[n+1],table:r[n+2],val:r[n+3],db_version:r[n+4],col_version:r[n+5]});return t}function selectVersion(){const r=sql`SELECT 
    crsql_dbversion() as current,
    IFNULL(MAX(version), 0) as synced
  FROM "__crstore_sync"`;return{execute:()=>r.execute(this).then(e=>e.rows[0])}}function updateVersion(r){return this.updateTable("__crstore_sync").set({version:r??sql`crsql_dbversion()`})}function selectClient(){const r=sql`SELECT crsql_siteid() as client`;return{execute:()=>r.execute(this).then(e=>fromBytes(e.rows[0].client))}}function changesSince(r,e){let t=this.selectFrom("crsql_changes").select(sql`crsql_siteid()`.as("site_id")).select(["cid","pk","table","val","db_version","col_version"]).where("db_version",">",r).$if(!r,n=>n.where("cid","!=","__crsql_del")).$if(e===null,n=>n.where("site_id","is",null)).$if(typeof e=="string",n=>n.where("site_id","is not",toBytes(e))).$castTo();return{execute:()=>t.execute().then(encode)}}function insertChanges(r){const e=async t=>{r.length&&(await t.insertInto("crsql_changes").values(decode(r)).execute(),await updateVersion.bind(t)().execute())};return{execute:()=>this.isTransaction?e(this):this.transaction().execute(e)}}function resolveChanges(r){return{execute:()=>applyOperation.bind(this)(e=>insertChanges.bind(e)(r).execute()).execute().then(e=>e.changes)}}function applyOperation(r,...e){return{execute:()=>this.transaction().execute(async t=>{const{current:n}=await selectVersion.bind(t)().execute(),s=await r(t,...e),a=await changesSince.bind(t)(n).execute();return{result:s,changes:a}})}}function finalize(){const r=sql`select crsql_finalize();`;return{execute:()=>r.execute(this)}}function affectedTables(r){var e,t,n;if(Array.isArray(r)){const s=new Set;for(let a=3;a<r.length;a+=6)s.add(r[a]);return[...s]}if(r.kind==="TableNode")return[r.table.identifier.name];if(r.kind==="ReferenceNode")return[r.table.table.identifier.name];if(r.kind==="AliasNode")return affectedTables(r.node);if(r.kind==="SelectQueryNode"){const s=[...r.from.froms,...((e=r.joins)==null?void 0:e.map(a=>a.table))||[],...((t=r.selections)==null?void 0:t.map(a=>a.selection))||[],...((n=r.with)==null?void 0:n.expressions.map(a=>a.expression))||[]].flatMap(affectedTables);return[...new Set(s)]}return[]}class CRDialect extends SqliteDialect{constructor(t){super(t);ce(this,"database");this.database=async()=>typeof t.database=="function"?t.database():t.database}createDriver(){const t=this.database,n=mutex();let s,a;return{async init(){s=await t(),a={async executeQuery(c){return{rows:await s.execO(c.sql,c.parameters)}},async*streamQuery(){throw new Error("Sqlite driver doesn't support streaming")}}},async acquireConnection(){return await n.lock(),a},async beginTransaction(c){await c.executeQuery(CompiledQuery.raw("begin"))},async commitTransaction(c){await c.executeQuery(CompiledQuery.raw("commit"))},async rollbackTransaction(c){await c.executeQuery(CompiledQuery.raw("rollback"))},async releaseConnection(){n.unlock()},async destroy(){s==null||s.close()}}}}function mutex(){let r,e;return{async lock(){for(;r;)await r;r=new Promise(t=>e=t)},unlock(){const t=e;r=void 0,e=void 0,t==null||t()}}}function json(r,e){const t=Object.entries(e).flatMap(([n,s])=>[sql.lit(n),typeof s=="string"?r.ref(s):s]);return sql`json_object(${sql.join(t)})`.withPlugin({transformQuery({node:n}){return{...n,json:!0}}}).$castTo()}function group(r,e){const t=typeof e=="string"?r.ref(e).toOperationNode():e.toOperationNode();return new AggregateFunctionBuilder({aggregateFunctionNode:{...AggregateFunctionNode.create("json_group_array",[t]),json:!0}})}function groupJSON(r,e){return group(r,json(r,e))}var yn;class JSONPlugin{constructor(){T(this,yn,new WeakMap)}transformQuery({node:e,queryId:t}){return e.kind!=="SelectQueryNode"||i(this,yn).set(t,new Set(this.getColumns(e))),e}async transformResult({result:e,queryId:t}){if(!Array.isArray(e.rows))return e;const n=i(this,yn).get(t);return n&&e.rows.forEach(s=>this.parseObject(s,n)),e}getColumns(e){var n,s;const t=[];for(const a in e)e[a]&&typeof e[a]=="object"&&(e[a].json===!0&&typeof((n=e.alias)==null?void 0:n.name)=="string"&&t.push((s=e.alias)==null?void 0:s.name),t.push(...this.getColumns(e[a])));return t}parseObject(e,t){for(const n in e)t.has(n)&&(e[n]=JSON.parse(String(e[n]))),typeof e[n]=="object"&&this.parseObject(e[n],t)}}yn=new WeakMap;function covert(r){const t={any:"blob",string:"text",number:"real",unknown:"blob",instance:"blob",bigint:"integer",integer:"integer",boolean:"boolean"}[r];if(t)return t;throw new Error(`Type "${r}" is not allowed in the database schema!`)}async function apply(r,{schema:e}){var t;for(const n in e){const s=e[n];let a=r.schema.createTable(n).ifNotExists();for(const c in s.schema){const{type:d}=s.schema[c];a=a.addColumn(c,(t=s.ordered)!=null&&t.find(([h])=>h===c)?"blob":covert(d))}s.primary&&(a=a.addPrimaryKeyConstraint("primary_key",s.primary)),await a.execute();for(const c of s.indices||[])await r.schema.createIndex(`${n}_${c.join("_")}`).ifNotExists().on(n).columns(c).execute();s.crr&&await sql`SELECT crsql_as_crr(${n})`.execute(r);for(const c of s.ordered||[])await sql`SELECT crsql_fract_as_ordered(${n},${sql.join(c)})`.execute(r);await r.schema.createTable("__crstore_sync").ifNotExists().addColumn("version","integer").execute(),await sql`INSERT INTO __crstore_sync (version) SELECT 0
      WHERE NOT EXISTS (SELECT * FROM __crstore_sync)
    `.execute(r)}}function primary(r,...e){return r.primary=e,r}function crr(r){return r.crr=!0,r}function ordered(r,e,...t){return r.ordered||(r.ordered=[]),r.ordered.push([e,...t]),r}function index(r,...e){return r.indices||(r.indices=[]),r.indices.push(e),r}const wasmUrl=""+new URL("../assets/crsqlite.0980e00c.wasm",import.meta.url).href;var Module=(()=>{var r=import.meta.url;return function(e={}){var t;t||(t=typeof e<"u"?e:{});var n,s;t.ready=new Promise(function(o,u){n=o,s=u});var a=Object.assign({},t),c="./this.program",d=(o,u)=>{throw u},h=typeof window=="object",p=typeof importScripts=="function",N="",O;(h||p)&&(p?N=self.location.href:typeof document<"u"&&document.currentScript&&(N=document.currentScript.src),r&&(N=r),N.indexOf("blob:")!==0?N=N.substr(0,N.replace(/[?#].*/,"").lastIndexOf("/")+1):N="",p&&(O=o=>{var u=new XMLHttpRequest;return u.open("GET",o,!1),u.responseType="arraybuffer",u.send(null),new Uint8Array(u.response)}));var A=t.print||console.log.bind(console),R=t.printErr||console.warn.bind(console);Object.assign(t,a),a=null,t.thisProgram&&(c=t.thisProgram),t.quit&&(d=t.quit);var x;t.wasmBinary&&(x=t.wasmBinary);var m=t.noExitRuntime||!0;typeof WebAssembly!="object"&&Qe("no native wasm support detected");var w,y=!1,_,g=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function W(o,u,l){var f=u+l;for(l=u;o[l]&&!(l>=f);)++l;if(16<l-u&&o.buffer&&g)return g.decode(o.subarray(u,l));for(f="";u<l;){var b=o[u++];if(b&128){var E=o[u++]&63;if((b&224)==192)f+=String.fromCharCode((b&31)<<6|E);else{var v=o[u++]&63;b=(b&240)==224?(b&15)<<12|E<<6|v:(b&7)<<18|E<<12|v<<6|o[u++]&63,65536>b?f+=String.fromCharCode(b):(b-=65536,f+=String.fromCharCode(55296|b>>10,56320|b&1023))}}else f+=String.fromCharCode(b)}return f}function z(o,u){return o?W(Q,o,u):""}function X(o,u,l,f){if(!(0<f))return 0;var b=l;f=l+f-1;for(var E=0;E<o.length;++E){var v=o.charCodeAt(E);if(55296<=v&&57343>=v){var D=o.charCodeAt(++E);v=65536+((v&1023)<<10)|D&1023}if(127>=v){if(l>=f)break;u[l++]=v}else{if(2047>=v){if(l+1>=f)break;u[l++]=192|v>>6}else{if(65535>=v){if(l+2>=f)break;u[l++]=224|v>>12}else{if(l+3>=f)break;u[l++]=240|v>>18,u[l++]=128|v>>12&63}u[l++]=128|v>>6&63}u[l++]=128|v&63}}return u[l]=0,l-b}function Z(o,u,l){return X(o,Q,u,l)}function j(o){for(var u=0,l=0;l<o.length;++l){var f=o.charCodeAt(l);127>=f?u++:2047>=f?u+=2:55296<=f&&57343>=f?(u+=4,++l):u+=3}return u}var le,Q,U,P,V,te,ne;function B(){var o=w.buffer;t.HEAP8=le=new Int8Array(o),t.HEAP16=U=new Int16Array(o),t.HEAP32=P=new Int32Array(o),t.HEAPU8=Q=new Uint8Array(o),t.HEAPU16=new Uint16Array(o),t.HEAPU32=V=new Uint32Array(o),t.HEAPF32=te=new Float32Array(o),t.HEAPF64=ne=new Float64Array(o)}var G=[],ae=[],je=[],Le=[],lt=0;function At(){var o=t.preRun.shift();G.unshift(o)}var Ye=0,ze=null;function Qe(o){throw t.onAbort&&t.onAbort(o),o="Aborted("+o+")",R(o),y=!0,_=1,o=new WebAssembly.RuntimeError(o+". Build with -sASSERTIONS for more info."),s(o),o}function cr(o){return o.startsWith("data:application/octet-stream;base64,")}var vt;if(t.locateFile){if(vt="crsqlite.wasm",!cr(vt)){var Tn=vt;vt=t.locateFile?t.locateFile(Tn,N):N+Tn}}else vt=new URL(""+new URL("../assets/crsqlite.0980e00c.wasm",import.meta.url).href,self.location).href;function Wt(o){try{if(o==vt&&x)return new Uint8Array(x);if(O)return O(o);throw"both async and sync fetching of the wasm failed"}catch(u){Qe(u)}}function It(o){return x||!h&&!p||typeof fetch!="function"?Promise.resolve().then(function(){return Wt(o)}):fetch(o,{credentials:"same-origin"}).then(function(u){if(!u.ok)throw"failed to load wasm binary file at '"+o+"'";return u.arrayBuffer()}).catch(function(){return Wt(o)})}function bt(o,u,l){return It(o).then(function(f){return WebAssembly.instantiate(f,u)}).then(function(f){return f}).then(l,function(f){R("failed to asynchronously prepare wasm: "+f),Qe(f)})}function Lt(o,u){var l=vt;return x||typeof WebAssembly.instantiateStreaming!="function"||cr(l)||typeof fetch!="function"?bt(l,o,u):fetch(l,{credentials:"same-origin"}).then(function(f){return WebAssembly.instantiateStreaming(f,o).then(u,function(b){return R("wasm streaming compile failed: "+b),R("falling back to ArrayBuffer instantiation"),bt(l,o,u)})})}var Y,Oe;function Mr(o){this.name="ExitStatus",this.message="Program terminated with exit("+o+")",this.status=o}function dr(o){for(;0<o.length;)o.shift()(t)}function Te(o,u="i8"){switch(u.endsWith("*")&&(u="*"),u){case"i1":return le[o>>0];case"i8":return le[o>>0];case"i16":return U[o>>1];case"i32":return P[o>>2];case"i64":return P[o>>2];case"float":return te[o>>2];case"double":return ne[o>>3];case"*":return V[o>>2];default:Qe("invalid type for getValue: "+u)}}function ot(o,u,l="i8"){switch(l.endsWith("*")&&(l="*"),l){case"i1":le[o>>0]=u;break;case"i8":le[o>>0]=u;break;case"i16":U[o>>1]=u;break;case"i32":P[o>>2]=u;break;case"i64":Oe=[u>>>0,(Y=u,1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],P[o>>2]=Oe[0],P[o+4>>2]=Oe[1];break;case"float":te[o>>2]=u;break;case"double":ne[o>>3]=u;break;case"*":V[o>>2]=u;break;default:Qe("invalid type for setValue: "+l)}}var vn=(o,u)=>{for(var l=0,f=o.length-1;0<=f;f--){var b=o[f];b==="."?o.splice(f,1):b===".."?(o.splice(f,1),l++):l&&(o.splice(f,1),l--)}if(u)for(;l;l--)o.unshift("..");return o},M=o=>{var u=o.charAt(0)==="/",l=o.substr(-1)==="/";return(o=vn(o.split("/").filter(f=>!!f),!u).join("/"))||u||(o="."),o&&l&&(o+="/"),(u?"/":"")+o},he=o=>{var u=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(o).slice(1);return o=u[0],u=u[1],!o&&!u?".":(u&&(u=u.substr(0,u.length-1)),o+u)},de=o=>{if(o==="/")return"/";o=M(o),o=o.replace(/\/$/,"");var u=o.lastIndexOf("/");return u===-1?o:o.substr(u+1)};function Ae(){if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function"){var o=new Uint8Array(1);return()=>(crypto.getRandomValues(o),o[0])}return()=>Qe("randomDevice")}function We(){for(var o="",u=!1,l=arguments.length-1;-1<=l&&!u;l--){if(u=0<=l?arguments[l]:"/",typeof u!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!u)return"";o=u+"/"+o,u=u.charAt(0)==="/"}return o=vn(o.split("/").filter(f=>!!f),!u).join("/"),(u?"/":"")+o||"."}var $r=[];function Ur(o,u){$r[o]={input:[],Ob:[],Zb:u},fi(o,To)}var To={open:function(o){var u=$r[o.node.bc];if(!u)throw new F(43);o.Pb=u,o.seekable=!1},close:function(o){o.Pb.Zb.ec(o.Pb)},ec:function(o){o.Pb.Zb.ec(o.Pb)},read:function(o,u,l,f){if(!o.Pb||!o.Pb.Zb.vc)throw new F(60);for(var b=0,E=0;E<f;E++){try{var v=o.Pb.Zb.vc(o.Pb)}catch{throw new F(29)}if(v===void 0&&b===0)throw new F(6);if(v==null)break;b++,u[l+E]=v}return b&&(o.node.timestamp=Date.now()),b},write:function(o,u,l,f){if(!o.Pb||!o.Pb.Zb.pc)throw new F(60);try{for(var b=0;b<f;b++)o.Pb.Zb.pc(o.Pb,u[l+b])}catch{throw new F(29)}return f&&(o.node.timestamp=Date.now()),b}},vo={vc:function(o){if(!o.input.length){var u=null;if(typeof window<"u"&&typeof window.prompt=="function"?(u=window.prompt("Input: "),u!==null&&(u+=`
`)):typeof readline=="function"&&(u=readline(),u!==null&&(u+=`
`)),!u)return null;var l=Array(j(u)+1);u=X(u,l,0,l.length),l.length=u,o.input=l}return o.input.shift()},pc:function(o,u){u===null||u===10?(A(W(o.Ob,0)),o.Ob=[]):u!=0&&o.Ob.push(u)},ec:function(o){o.Ob&&0<o.Ob.length&&(A(W(o.Ob,0)),o.Ob=[])}},Io={pc:function(o,u){u===null||u===10?(R(W(o.Ob,0)),o.Ob=[]):u!=0&&o.Ob.push(u)},ec:function(o){o.Ob&&0<o.Ob.length&&(R(W(o.Ob,0)),o.Ob=[])}},ee={Sb:null,Rb:function(){return ee.createNode(null,"/",16895,0)},createNode:function(o,u,l,f){if((l&61440)===24576||(l&61440)===4096)throw new F(63);return ee.Sb||(ee.Sb={dir:{node:{Qb:ee.Ab.Qb,Nb:ee.Ab.Nb,$b:ee.Ab.$b,fc:ee.Ab.fc,yc:ee.Ab.yc,lc:ee.Ab.lc,jc:ee.Ab.jc,xc:ee.Ab.xc,kc:ee.Ab.kc},stream:{Wb:ee.Jb.Wb}},file:{node:{Qb:ee.Ab.Qb,Nb:ee.Ab.Nb},stream:{Wb:ee.Jb.Wb,read:ee.Jb.read,write:ee.Jb.write,rc:ee.Jb.rc,hc:ee.Jb.hc,ic:ee.Jb.ic}},link:{node:{Qb:ee.Ab.Qb,Nb:ee.Ab.Nb,cc:ee.Ab.cc},stream:{}},sc:{node:{Qb:ee.Ab.Qb,Nb:ee.Ab.Nb},stream:xo}}),l=Bi(o,u,l,f),(l.mode&61440)===16384?(l.Ab=ee.Sb.dir.node,l.Jb=ee.Sb.dir.stream,l.Kb={}):(l.mode&61440)===32768?(l.Ab=ee.Sb.file.node,l.Jb=ee.Sb.file.stream,l.Mb=0,l.Kb=null):(l.mode&61440)===40960?(l.Ab=ee.Sb.link.node,l.Jb=ee.Sb.link.stream):(l.mode&61440)===8192&&(l.Ab=ee.Sb.sc.node,l.Jb=ee.Sb.sc.stream),l.timestamp=Date.now(),o&&(o.Kb[u]=l,o.timestamp=l.timestamp),l},Qc:function(o){return o.Kb?o.Kb.subarray?o.Kb.subarray(0,o.Mb):new Uint8Array(o.Kb):new Uint8Array(0)},tc:function(o,u){var l=o.Kb?o.Kb.length:0;l>=u||(u=Math.max(u,l*(1048576>l?2:1.125)>>>0),l!=0&&(u=Math.max(u,256)),l=o.Kb,o.Kb=new Uint8Array(u),0<o.Mb&&o.Kb.set(l.subarray(0,o.Mb),0))},Mc:function(o,u){if(o.Mb!=u)if(u==0)o.Kb=null,o.Mb=0;else{var l=o.Kb;o.Kb=new Uint8Array(u),l&&o.Kb.set(l.subarray(0,Math.min(u,o.Mb))),o.Mb=u}},Ab:{Qb:function(o){var u={};return u.Ec=(o.mode&61440)===8192?o.id:1,u.nc=o.id,u.mode=o.mode,u.Kc=1,u.uid=0,u.Hc=0,u.bc=o.bc,(o.mode&61440)===16384?u.size=4096:(o.mode&61440)===32768?u.size=o.Mb:(o.mode&61440)===40960?u.size=o.link.length:u.size=0,u.Ac=new Date(o.timestamp),u.Jc=new Date(o.timestamp),u.Dc=new Date(o.timestamp),u.Bc=4096,u.Cc=Math.ceil(u.size/u.Bc),u},Nb:function(o,u){u.mode!==void 0&&(o.mode=u.mode),u.timestamp!==void 0&&(o.timestamp=u.timestamp),u.size!==void 0&&ee.Mc(o,u.size)},$b:function(){throw ci[44]},fc:function(o,u,l,f){return ee.createNode(o,u,l,f)},yc:function(o,u,l){if((o.mode&61440)===16384){try{var f=Jt(u,l)}catch{}if(f)for(var b in f.Kb)throw new F(55)}delete o.parent.Kb[o.name],o.parent.timestamp=Date.now(),o.name=l,u.Kb[l]=o,u.timestamp=o.parent.timestamp,o.parent=u},lc:function(o,u){delete o.Kb[u],o.timestamp=Date.now()},jc:function(o,u){var l=Jt(o,u),f;for(f in l.Kb)throw new F(55);delete o.Kb[u],o.timestamp=Date.now()},xc:function(o){var u=[".",".."],l;for(l in o.Kb)o.Kb.hasOwnProperty(l)&&u.push(l);return u},kc:function(o,u,l){return o=ee.createNode(o,u,41471,0),o.link=l,o},cc:function(o){if((o.mode&61440)!==40960)throw new F(28);return o.link}},Jb:{read:function(o,u,l,f,b){var E=o.node.Kb;if(b>=o.node.Mb)return 0;if(o=Math.min(o.node.Mb-b,f),8<o&&E.subarray)u.set(E.subarray(b,b+o),l);else for(f=0;f<o;f++)u[l+f]=E[b+f];return o},write:function(o,u,l,f,b,E){if(u.buffer===le.buffer&&(E=!1),!f)return 0;if(o=o.node,o.timestamp=Date.now(),u.subarray&&(!o.Kb||o.Kb.subarray)){if(E)return o.Kb=u.subarray(l,l+f),o.Mb=f;if(o.Mb===0&&b===0)return o.Kb=u.slice(l,l+f),o.Mb=f;if(b+f<=o.Mb)return o.Kb.set(u.subarray(l,l+f),b),f}if(ee.tc(o,b+f),o.Kb.subarray&&u.subarray)o.Kb.set(u.subarray(l,l+f),b);else for(E=0;E<f;E++)o.Kb[b+E]=u[l+E];return o.Mb=Math.max(o.Mb,b+f),f},Wb:function(o,u,l){if(l===1?u+=o.position:l===2&&(o.node.mode&61440)===32768&&(u+=o.node.Mb),0>u)throw new F(28);return u},rc:function(o,u,l){ee.tc(o.node,u+l),o.node.Mb=Math.max(o.node.Mb,u+l)},hc:function(o,u,l,f,b){if((o.node.mode&61440)!==32768)throw new F(43);if(o=o.node.Kb,b&2||o.buffer!==le.buffer){if((0<l||l+u<o.length)&&(o.subarray?o=o.subarray(l,l+u):o=Array.prototype.slice.call(o,l,l+u)),l=!0,u=65536*Math.ceil(u/65536),(b=Gs(65536,u))?(Q.fill(0,b,b+u),u=b):u=0,!u)throw new F(48);le.set(o,u)}else l=!1,u=o.byteOffset;return{Lc:u,zc:l}},ic:function(o,u,l,f){return ee.Jb.write(o,u,0,f,l,!1),0}}},li=null,qi={},qt=[],So=1,Dt=null,Di=!0,F=null,ci={},Ze=(o,u={})=>{if(o=We(o),!o)return{path:"",node:null};if(u=Object.assign({uc:!0,qc:0},u),8<u.qc)throw new F(32);o=o.split("/").filter(v=>!!v);for(var l=li,f="/",b=0;b<o.length;b++){var E=b===o.length-1;if(E&&u.parent)break;if(l=Jt(l,o[b]),f=M(f+"/"+o[b]),l.Xb&&(!E||E&&u.uc)&&(l=l.Xb.root),!E||u.Vb){for(E=0;(l.mode&61440)===40960;)if(l=Vi(f),f=We(he(f),l),l=Ze(f,{qc:u.qc+1}).node,40<E++)throw new F(32)}}return{path:f,node:l}},In=o=>{for(var u;;){if(o===o.parent)return o=o.Rb.wc,u?o[o.length-1]!=="/"?o+"/"+u:o+u:o;u=u?o.name+"/"+u:o.name,o=o.parent}},di=(o,u)=>{for(var l=0,f=0;f<u.length;f++)l=(l<<5)-l+u.charCodeAt(f)|0;return(o+l>>>0)%Dt.length},Fi=o=>{var u=di(o.parent.id,o.name);if(Dt[u]===o)Dt[u]=o.Yb;else for(u=Dt[u];u;){if(u.Yb===o){u.Yb=o.Yb;break}u=u.Yb}},Jt=(o,u)=>{var l;if(l=(l=fr(o,"x"))?l:o.Ab.$b?0:2)throw new F(l,o);for(l=Dt[di(o.id,u)];l;l=l.Yb){var f=l.name;if(l.parent.id===o.id&&f===u)return l}return o.Ab.$b(o,u)},Bi=(o,u,l,f)=>(o=new Hs(o,u,l,f),u=di(o.parent.id,o.name),o.Yb=Dt[u],Dt[u]=o),Co={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},zi=o=>{var u=["r","w","rw"][o&3];return o&512&&(u+="w"),u},fr=(o,u)=>{if(Di)return 0;if(!u.includes("r")||o.mode&292){if(u.includes("w")&&!(o.mode&146)||u.includes("x")&&!(o.mode&73))return 2}else return 2;return 0},Qi=(o,u)=>{try{return Jt(o,u),20}catch{}return fr(o,"wx")},Pi=(o,u,l)=>{try{var f=Jt(o,u)}catch(b){return b.Lb}if(o=fr(o,"wx"))return o;if(l){if((f.mode&61440)!==16384)return 54;if(f===f.parent||In(f)==="/")return 10}else if((f.mode&61440)===16384)return 31;return 0},Ro=(o=0)=>{for(;4096>=o;o++)if(!qt[o])return o;throw new F(33)},Mi=(o,u)=>(Hr||(Hr=function(){this.dc={}},Hr.prototype={},Object.defineProperties(Hr.prototype,{object:{get:function(){return this.node},set:function(l){this.node=l}},flags:{get:function(){return this.dc.flags},set:function(l){this.dc.flags=l}},position:{get:function(){return this.dc.position},set:function(l){this.dc.position=l}}})),o=Object.assign(new Hr,o),u=Ro(u),o.Tb=u,qt[u]=o),xo={open:o=>{o.Jb=qi[o.node.bc].Jb,o.Jb.open&&o.Jb.open(o)},Wb:()=>{throw new F(70)}},fi=(o,u)=>{qi[o]={Jb:u}},$i=(o,u)=>{var l=u==="/",f=!u;if(l&&li)throw new F(10);if(!l&&!f){var b=Ze(u,{uc:!1});if(u=b.path,b=b.node,b.Xb)throw new F(10);if((b.mode&61440)!==16384)throw new F(54)}u={type:o,Sc:{},wc:u,Ic:[]},o=o.Rb(u),o.Rb=u,u.root=o,l?li=o:b&&(b.Xb=u,b.Rb&&b.Rb.Ic.push(u))},hi=(o,u,l)=>{var f=Ze(o,{parent:!0}).node;if(o=de(o),!o||o==="."||o==="..")throw new F(28);var b=Qi(f,o);if(b)throw new F(b);if(!f.Ab.fc)throw new F(63);return f.Ab.fc(f,o,u,l)},wt=(o,u)=>hi(o,(u!==void 0?u:511)&1023|16384,0),Sn=(o,u,l)=>{typeof l>"u"&&(l=u,u=438),hi(o,u|8192,l)},pi=(o,u)=>{if(!We(o))throw new F(44);var l=Ze(u,{parent:!0}).node;if(!l)throw new F(44);u=de(u);var f=Qi(l,u);if(f)throw new F(f);if(!l.Ab.kc)throw new F(63);l.Ab.kc(l,u,o)},Ui=o=>{var u=Ze(o,{parent:!0}).node;o=de(o);var l=Jt(u,o),f=Pi(u,o,!0);if(f)throw new F(f);if(!u.Ab.jc)throw new F(63);if(l.Xb)throw new F(10);u.Ab.jc(u,o),Fi(l)},Vi=o=>{if(o=Ze(o).node,!o)throw new F(44);if(!o.Ab.cc)throw new F(28);return We(In(o.parent),o.Ab.cc(o))},Cn=(o,u)=>{if(o=Ze(o,{Vb:!u}).node,!o)throw new F(44);if(!o.Ab.Qb)throw new F(63);return o.Ab.Qb(o)},Hi=o=>Cn(o,!0),Ji=(o,u)=>{if(o=typeof o=="string"?Ze(o,{Vb:!0}).node:o,!o.Ab.Nb)throw new F(63);o.Ab.Nb(o,{mode:u&4095|o.mode&-4096,timestamp:Date.now()})},ji=(o,u)=>{if(0>u)throw new F(28);if(o=typeof o=="string"?Ze(o,{Vb:!0}).node:o,!o.Ab.Nb)throw new F(63);if((o.mode&61440)===16384)throw new F(31);if((o.mode&61440)!==32768)throw new F(28);var l=fr(o,"w");if(l)throw new F(l);o.Ab.Nb(o,{size:u,timestamp:Date.now()})},Rn=(o,u,l)=>{if(o==="")throw new F(44);if(typeof u=="string"){var f=Co[u];if(typeof f>"u")throw Error("Unknown file open mode: "+u);u=f}if(l=u&64?(typeof l>"u"?438:l)&4095|32768:0,typeof o=="object")var b=o;else{o=M(o);try{b=Ze(o,{Vb:!(u&131072)}).node}catch{}}if(f=!1,u&64)if(b){if(u&128)throw new F(20)}else b=hi(o,l,0),f=!0;if(!b)throw new F(44);if((b.mode&61440)===8192&&(u&=-513),u&65536&&(b.mode&61440)!==16384)throw new F(54);if(!f&&(l=b?(b.mode&61440)===40960?32:(b.mode&61440)===16384&&(zi(u)!=="r"||u&512)?31:fr(b,zi(u)):44))throw new F(l);return u&512&&!f&&ji(b,0),u&=-131713,b=Mi({node:b,path:In(b),flags:u,seekable:!0,position:0,Jb:b.Jb,Pc:[],error:!1}),b.Jb.open&&b.Jb.open(b),!t.logReadFiles||u&1||(xn||(xn={}),o in xn||(xn[o]=1)),b},Ki=(o,u,l)=>{if(o.Tb===null)throw new F(8);if(!o.seekable||!o.Jb.Wb)throw new F(70);if(l!=0&&l!=1&&l!=2)throw new F(28);o.position=o.Jb.Wb(o,u,l),o.Pc=[]},Gi=()=>{F||(F=function(o,u){this.name="ErrnoError",this.node=u,this.Nc=function(l){this.Lb=l},this.Nc(o),this.message="FS error"},F.prototype=Error(),F.prototype.constructor=F,[44].forEach(o=>{ci[o]=new F(o),ci[o].stack="<generic error, no stack>"}))},Xi,ko=(o,u)=>{var l=0;return o&&(l|=365),u&&(l|=146),l},Vr=(o,u,l)=>{o=M("/dev/"+o);var f=ko(!!u,!!l);mi||(mi=64);var b=mi++<<8|0;fi(b,{open:E=>{E.seekable=!1},close:()=>{l&&l.buffer&&l.buffer.length&&l(10)},read:(E,v,D,S)=>{for(var C=0,L=0;L<S;L++){try{var q=u()}catch{throw new F(29)}if(q===void 0&&C===0)throw new F(6);if(q==null)break;C++,v[D+L]=q}return C&&(E.node.timestamp=Date.now()),C},write:(E,v,D,S)=>{for(var C=0;C<S;C++)try{l(v[D+C])}catch{throw new F(29)}return S&&(E.node.timestamp=Date.now()),C}}),Sn(o,f,b)},mi,we={},Hr,xn;function jt(o,u,l){if(u.charAt(0)==="/")return u;if(o=o===-100?"/":ct(o).path,u.length==0){if(!l)throw new F(44);return o}return M(o+"/"+u)}function kn(o,u,l){try{var f=o(u)}catch(E){if(E&&E.node&&M(u)!==M(In(E.node)))return-54;throw E}P[l>>2]=f.Ec,P[l+8>>2]=f.nc,P[l+12>>2]=f.mode,V[l+16>>2]=f.Kc,P[l+20>>2]=f.uid,P[l+24>>2]=f.Hc,P[l+28>>2]=f.bc,Oe=[f.size>>>0,(Y=f.size,1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],P[l+40>>2]=Oe[0],P[l+44>>2]=Oe[1],P[l+48>>2]=4096,P[l+52>>2]=f.Cc,o=f.Ac.getTime(),u=f.Jc.getTime();var b=f.Dc.getTime();return Oe=[Math.floor(o/1e3)>>>0,(Y=Math.floor(o/1e3),1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],P[l+56>>2]=Oe[0],P[l+60>>2]=Oe[1],V[l+64>>2]=o%1e3*1e3,Oe=[Math.floor(u/1e3)>>>0,(Y=Math.floor(u/1e3),1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],P[l+72>>2]=Oe[0],P[l+76>>2]=Oe[1],V[l+80>>2]=u%1e3*1e3,Oe=[Math.floor(b/1e3)>>>0,(Y=Math.floor(b/1e3),1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],P[l+88>>2]=Oe[0],P[l+92>>2]=Oe[1],V[l+96>>2]=b%1e3*1e3,Oe=[f.nc>>>0,(Y=f.nc,1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],P[l+104>>2]=Oe[0],P[l+108>>2]=Oe[1],0}var An=void 0;function Wn(){return An+=4,P[An-4>>2]}function ct(o){if(o=qt[o],!o)throw new F(8);return o}function yi(o){return V[o>>2]+4294967296*P[o+4>>2]}var Ao=[0,31,60,91,121,152,182,213,244,274,305,335],Wo=[0,31,59,90,120,151,181,212,243,273,304,334];function Yi(o){var u=j(o)+1,l=gi(u);return l&&X(o,le,l,u),l}var Ni={};function Zi(){if(!bi){var o={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:c||"./this.program"},u;for(u in Ni)Ni[u]===void 0?delete o[u]:o[u]=Ni[u];var l=[];for(u in o)l.push(u+"="+o[u]);bi=l}return bi}var bi;function es(){}function ts(){}function rs(){}function ns(){}function ss(){}function os(){}function as(){}function us(){}function ls(){}function cs(){}function ds(){}function fs(){}function hs(){}function ps(){}function ms(){}function ys(){}function Ns(){}function bs(){}function ws(){}function Es(){}function gs(){}function _s(){}function Os(){}function Ts(){}function vs(){}function Is(){}function Ss(){}function Cs(){}function Rs(){}function xs(){}function ks(){}function As(){}function Ws(){}function Ls(){}function qs(){}function Ds(){}function Fs(){}function Bs(){}function zs(o){_=o,m||0<lt||(t.onExit&&t.onExit(o),y=!0),d(o,new Mr(o))}function wi(o){o instanceof Mr||o=="unwind"||d(1,o)}function Ln(o){try{o()}catch(u){Qe(u)}}function Lo(o){var u={},l;for(l in o)(function(f){var b=o[f];u[f]=typeof b=="function"?function(){qn.push(f);try{return b.apply(null,arguments)}finally{y||(qn.pop()===f||Qe(),Et&&Ft===1&&qn.length===0&&(Ft=0,Ln(ro),typeof Fibers<"u"&&Fibers.Tc()))}}:b})(l);return u}var Ft=0,Et=null,Qs=0,qn=[],Ps={},Ms={},qo=0,Ei=null,Do=[];function Fo(){return new Promise((o,u)=>{Ei={resolve:o,reject:u}})}function Bo(){var o=gi(12300),u=o+12;P[o>>2]=u,P[o+4>>2]=u+12288,u=qn[0];var l=Ps[u];return l===void 0&&(l=qo++,Ps[u]=l,Ms[l]=u),P[o+8>>2]=l,o}function $s(o){if(!y){if(Ft===0){var u=!1,l=!1;o((f=0)=>{if(!y&&(Qs=f,u=!0,l)){Ft=2,Ln(()=>no(Et)),f=!1;try{var b=(0,t.asm[Ms[P[Et+8>>2]]])()}catch(D){b=D,f=!0}var E=!1;if(!Et){var v=Ei;v&&(Ei=null,(f?v.reject:v.resolve)(b),E=!0)}if(f&&!E)throw b}}),l=!0,u||(Ft=1,Et=Bo(),Ln(()=>eo(Et)))}else Ft===2?(Ft=0,Ln(io),Js(Et),Et=null,Do.forEach(f=>{if(!y)try{if(f(),!(m||0<lt))try{_=f=_,zs(f)}catch(b){wi(b)}}catch(b){wi(b)}})):Qe("invalid state: "+Ft);return Qs}}function Us(o){return $s(u=>{o().then(u)})}var Vs={};function St(o,u,l,f,b){function E(q){return--lt,S!==0&&Zs(S),u==="string"?z(q):u==="boolean"?!!q:q}var v={string:q=>{var $=0;if(q!=null&&q!==0){var ue=(q.length<<2)+1;$=_i(ue),Z(q,$,ue)}return $},array:q=>{var $=_i(q.length);return le.set(q,$),$}};o=t["_"+o];var D=[],S=0;if(f)for(var C=0;C<f.length;C++){var L=v[l[C]];L?(S===0&&(S=Ys()),D[C]=L(f[C])):D[C]=f[C]}return l=Et,f=o.apply(null,D),lt+=1,b=b&&b.async,Et!=l?Fo().then(E):(f=E(f),b?Promise.resolve(f):f)}function Hs(o,u,l,f){o||(o=this),this.parent=o,this.Rb=o.Rb,this.Xb=null,this.id=So++,this.name=u,this.mode=l,this.Ab={},this.Jb={},this.bc=f}Object.defineProperties(Hs.prototype,{read:{get:function(){return(this.mode&365)===365},set:function(o){o?this.mode|=365:this.mode&=-366}},write:{get:function(){return(this.mode&146)===146},set:function(o){o?this.mode|=146:this.mode&=-147}}}),Gi(),Dt=Array(4096),$i(ee,"/"),wt("/tmp"),wt("/home"),wt("/home/web_user"),(()=>{wt("/dev"),fi(259,{read:()=>0,write:(u,l,f,b)=>b}),Sn("/dev/null",259),Ur(1280,vo),Ur(1536,Io),Sn("/dev/tty",1280),Sn("/dev/tty1",1536);var o=Ae();Vr("random",o),Vr("urandom",o),wt("/dev/shm"),wt("/dev/shm/tmp")})(),(()=>{wt("/proc");var o=wt("/proc/self");wt("/proc/self/fd"),$i({Rb:()=>{var u=Bi(o,"fd",16895,73);return u.Ab={$b:(l,f)=>{var b=qt[+f];if(!b)throw new F(8);return l={parent:null,Rb:{wc:"fake"},Ab:{cc:()=>b.path}},l.parent=l}},u}},"/proc/self/fd")})(),function(){function o(f,b){const E=[];for(let v=0;f[b+v]!=0;++v){if(1e3<v)throw Error("C-string never terminated after 1k characters");E.push(f[b+v])}return String.fromCharCode(...E)}const u=new Map,l=new Map;t.updateHook=function(f,b){const E=u.size;return u.set(E,b),St("update_hook","void",["number","number"],[f,E])},t.createFunction=function(f,b,E,v,D,S){const C=u.size;return u.set(C,{f:S,Ub:D}),St("create_function","number","number string number number number number".split(" "),[f,b,E,v,C,0])},t.createAggregate=function(f,b,E,v,D,S,C){const L=u.size;return u.set(L,{step:S,Fc:C,Ub:D}),St("create_function","number","number string number number number number".split(" "),[f,b,E,v,L,1])},t.getFunctionUserData=function(f){return l.get(f)},ns=function(f,b,E,v,D,S){f=u.get(f);const C=le;D=BigInt(S)<<32n|BigInt(D)&4294967295n,f(b,o(C,E),o(C,v),D)},ts=function(f,b,E,v){f=u.get(f),l.set(b,f.Ub),f.f(b,new Uint32Array(Q.buffer,v,E)),l.delete(b)},rs=function(f,b,E,v){f=u.get(f),l.set(b,f.Ub),f.step(b,new Uint32Array(Q.buffer,v,E)),l.delete(b)},es=function(f,b){f=u.get(f),l.set(b,f.Ub),f.Fc(b),l.delete(b)}}(),function(){function o(S,C){const L=`get${S}`,q=`set${S}`;return new Proxy(new DataView(Q.buffer,C,S==="Int32"?4:8),{get($,ue){if(ue===L)return function(_e,qe){if(!qe)throw Error("must be little endian");return $[ue](_e,qe)};if(ue===q)return function(_e,qe,xe){if(!xe)throw Error("must be little endian");return $[ue](_e,qe,xe)};if(typeof ue=="string"&&ue.match(/^(get)|(set)/))throw Error("invalid type");return $[ue]}})}const u=typeof Vs=="object",l=new Map,f=new Map,b=new Map,E=u?new Set:null,v=u?new Set:null,D=new Map;gs=function(S,C,L,q){D.set(z(S),{size:C,ac:Array.from(new Uint32Array(Q.buffer,q,L))})},t.createModule=function(S,C,L,q){u&&(L.handleAsync=Us);const $=l.size;return l.set($,{module:L,Ub:q}),q=0,L.xCreate&&(q|=1),L.xConnect&&(q|=2),L.xBestIndex&&(q|=4),L.xDisconnect&&(q|=8),L.xDestroy&&(q|=16),L.xOpen&&(q|=32),L.xClose&&(q|=64),L.xFilter&&(q|=128),L.xNext&&(q|=256),L.xEof&&(q|=512),L.xColumn&&(q|=1024),L.xRowid&&(q|=2048),L.xUpdate&&(q|=4096),L.xBegin&&(q|=8192),L.xSync&&(q|=16384),L.xCommit&&(q|=32768),L.xRollback&&(q|=65536),L.xFindFunction&&(q|=131072),L.xRename&&(q|=262144),St("create_module","number",["number","string","number","number"],[S,C,$,q])},ds=function(S,C,L,q,$,ue){if(C=l.get(C),f.set($,C),u){E.delete($);for(const _e of E)f.delete(_e)}return q=Array.from(new Uint32Array(Q.buffer,q,L)).map(_e=>z(_e)),C.module.xCreate(S,C.Ub,q,$,o("Int32",ue))},cs=function(S,C,L,q,$,ue){if(C=l.get(C),f.set($,C),u){E.delete($);for(const _e of E)f.delete(_e)}return q=Array.from(new Uint32Array(Q.buffer,q,L)).map(_e=>z(_e)),C.module.xConnect(S,C.Ub,q,$,o("Int32",ue))},os=function(S,C){var L=f.get(S),q=D.get("sqlite3_index_info").ac;const $={};$.nConstraint=Te(C+q[0],"i32"),$.aConstraint=[];for(var ue=Te(C+q[1],"i32"),_e=D.get("sqlite3_index_constraint").size,qe=0;qe<$.nConstraint;++qe){var xe=$.aConstraint,et=xe.push,Pe=ue+qe*_e,hr=D.get("sqlite3_index_constraint").ac,Bt={};Bt.iColumn=Te(Pe+hr[0],"i32"),Bt.op=Te(Pe+hr[1],"i8"),Bt.usable=!!Te(Pe+hr[2],"i8"),et.call(xe,Bt)}for($.nOrderBy=Te(C+q[2],"i32"),$.aOrderBy=[],ue=Te(C+q[3],"i32"),_e=D.get("sqlite3_index_orderby").size,qe=0;qe<$.nOrderBy;++qe)xe=$.aOrderBy,et=xe.push,Pe=ue+qe*_e,hr=D.get("sqlite3_index_orderby").ac,Bt={},Bt.iColumn=Te(Pe+hr[0],"i32"),Bt.desc=!!Te(Pe+hr[1],"i8"),et.call(xe,Bt);for($.aConstraintUsage=[],ue=0;ue<$.nConstraint;++ue)$.aConstraintUsage.push({argvIndex:0,omit:!1});for($.idxNum=Te(C+q[5],"i32"),$.idxStr=null,$.orderByConsumed=!!Te(C+q[8],"i8"),$.estimatedCost=Te(C+q[9],"double"),$.estimatedRows=Te(C+q[10],"i64"),$.idxFlags=Te(C+q[11],"i32"),$.colUsed=Te(C+q[12],"i64"),S=L.module.xBestIndex(S,$),L=D.get("sqlite3_index_info").ac,q=Te(C+L[4],"i32"),ue=D.get("sqlite3_index_constraint_usage").size,et=0;et<$.nConstraint;++et)_e=q+et*ue,xe=$.aConstraintUsage[et],Pe=D.get("sqlite3_index_constraint_usage").ac,ot(_e+Pe[0],xe.argvIndex,"i32"),ot(_e+Pe[1],xe.omit?1:0,"i8");return ot(C+L[5],$.idxNum,"i32"),typeof $.idxStr=="string"&&(q=j($.idxStr),ue=St("sqlite3_malloc","number",["number"],[q+1]),Z($.idxStr,ue,q+1),ot(C+L[6],ue,"i32"),ot(C+L[7],1,"i32")),ot(C+L[8],$.orderByConsumed,"i32"),ot(C+L[9],$.estimatedCost,"double"),ot(C+L[10],$.estimatedRows,"i64"),ot(C+L[11],$.idxFlags,"i32"),S},hs=function(S){const C=f.get(S);return u?E.add(S):f.delete(S),C.module.xDisconnect(S)},fs=function(S){const C=f.get(S);return u?E.add(S):f.delete(S),C.module.xDestroy(S)},Ns=function(S,C){const L=f.get(S);if(b.set(C,L),u){v.delete(C);for(const q of v)b.delete(q)}return L.module.xOpen(S,C)},as=function(S){const C=b.get(S);return u?v.add(S):b.delete(S),C.module.xClose(S)},ps=function(S){return b.get(S).module.xEof(S)?1:0},ms=function(S,C,L,q,$){const ue=b.get(S);return L=L?z(L):null,$=new Uint32Array(Q.buffer,$,q),ue.module.xFilter(S,C,L,$)},ys=function(S){return b.get(S).module.xNext(S)},us=function(S,C,L){return b.get(S).module.xColumn(S,C,L)},Es=function(S,C){return b.get(S).module.xRowid(S,o("BigInt64",C))},Os=function(S,C,L,q){const $=f.get(S);return L=new Uint32Array(Q.buffer,L,C),$.module.xUpdate(S,L,o("BigInt64",q))},ss=function(S){return f.get(S).module.xBegin(S)},_s=function(S){return f.get(S).module.xSync(S)},ls=function(S){return f.get(S).module.xCommit(S)},ws=function(S){return f.get(S).module.xRollback(S)},bs=function(S,C){const L=f.get(S);return C=z(C),L.module.xRename(S,C)}}(),function(){function o(E,v){const D=`get${E}`,S=`set${E}`;return new Proxy(new DataView(Q.buffer,v,E==="Int32"?4:8),{get(C,L){if(L===D)return function(q,$){if(!$)throw Error("must be little endian");return C[L](q,$)};if(L===S)return function(q,$,ue){if(!ue)throw Error("must be little endian");return C[L](q,$,ue)};if(typeof L=="string"&&L.match(/^(get)|(set)/))throw Error("invalid type");return C[L]}})}const u=typeof Vs=="object",l=new Map,f=new Map;t.registerVFS=function(E,v){if(St("sqlite3_vfs_find","number",["string"],[E.name]))throw Error(`VFS '${E.name}' already registered`);u&&(E.handleAsync=Us);var D=E.Rc??64;const S=t._malloc(4);return v=St("register_vfs","number",["string","number","number","number"],[E.name,D,v?1:0,S]),v||(D=Te(S,"i32"),l.set(D,E)),t._free(S),v};const b=u?new Set:null;Is=function(E){const v=f.get(E);return u?b.add(E):f.delete(E),v.xClose(E)},Ws=function(E,v,D,S){return f.get(E).xRead(E,Q.subarray(v,v+D),Te(S,"i64"))},Bs=function(E,v,D,S){return f.get(E).xWrite(E,Q.subarray(v,v+D),Te(S,"i64"))},Ds=function(E,v){return f.get(E).xTruncate(E,Te(v,"i64"))},qs=function(E,v){return f.get(E).xSync(E,v)},xs=function(E,v){const D=f.get(E);return v=o("BigInt64",v),D.xFileSize(E,v)},ks=function(E,v){return f.get(E).xLock(E,v)},Fs=function(E,v){return f.get(E).xUnlock(E,v)},vs=function(E,v){const D=f.get(E);return v=o("Int32",v),D.xCheckReservedLock(E,v)},Rs=function(E,v,D){const S=f.get(E);return D=new DataView(Q.buffer,D),S.xFileControl(E,v,D)},Ls=function(E){return f.get(E).xSectorSize(E)},Cs=function(E){return f.get(E).xDeviceCharacteristics(E)},As=function(E,v,D,S,C){if(E=l.get(E),f.set(D,E),u){b.delete(D);for(var L of b)f.delete(L)}if(L=null,S&64){L=1;const q=[];for(;L;){const $=Q[v++];if($)q.push($);else switch(Q[v]||(L=null),L){case 1:q.push(63),L=2;break;case 2:q.push(61),L=3;break;case 3:q.push(38),L=2}}L=new TextDecoder().decode(new Uint8Array(q))}else v&&(L=z(v));return C=o("Int32",C),E.xOpen(L,D,S,C)},Ss=function(E,v,D){return l.get(E).xDelete(z(v),D)},Ts=function(E,v,D,S){return E=l.get(E),S=o("Int32",S),E.xAccess(z(v),D,S)}}();var zo={a:function(o,u,l,f){Qe("Assertion failed: "+z(o)+", at: "+[u?z(u):"unknown filename",l,f?z(f):"unknown function"])},K:function(o,u){try{return o=z(o),Ji(o,u),0}catch(l){if(typeof we>"u"||l.name!=="ErrnoError")throw l;return-l.Lb}},N:function(o,u,l){try{if(u=z(u),u=jt(o,u),l&-8)return-28;var f=Ze(u,{Vb:!0}).node;return f?(o="",l&4&&(o+="r"),l&2&&(o+="w"),l&1&&(o+="x"),o&&fr(f,o)?-2:0):-44}catch(b){if(typeof we>"u"||b.name!=="ErrnoError")throw b;return-b.Lb}},L:function(o,u){try{var l=qt[o];if(!l)throw new F(8);return Ji(l.node,u),0}catch(f){if(typeof we>"u"||f.name!=="ErrnoError")throw f;return-f.Lb}},J:function(o){try{var u=qt[o];if(!u)throw new F(8);var l=u.node,f=typeof l=="string"?Ze(l,{Vb:!0}).node:l;if(!f.Ab.Nb)throw new F(63);return f.Ab.Nb(f,{timestamp:Date.now()}),0}catch(b){if(typeof we>"u"||b.name!=="ErrnoError")throw b;return-b.Lb}},b:function(o,u,l){An=l;try{var f=ct(o);switch(u){case 0:var b=Wn();return 0>b?-28:Mi(f,b).Tb;case 1:case 2:return 0;case 3:return f.flags;case 4:return b=Wn(),f.flags|=b,0;case 5:return b=Wn(),U[b+0>>1]=2,0;case 6:case 7:return 0;case 16:case 8:return-28;case 9:return P[js()>>2]=28,-1;default:return-28}}catch(E){if(typeof we>"u"||E.name!=="ErrnoError")throw E;return-E.Lb}},I:function(o,u){try{var l=ct(o);return kn(Cn,l.path,u)}catch(f){if(typeof we>"u"||f.name!=="ErrnoError")throw f;return-f.Lb}},k:function(o,u,l){try{if(u=l+2097152>>>0<4194305-!!u?(u>>>0)+4294967296*l:NaN,isNaN(u))return-61;var f=qt[o];if(!f)throw new F(8);if(!(f.flags&2097155))throw new F(28);return ji(f.node,u),0}catch(b){if(typeof we>"u"||b.name!=="ErrnoError")throw b;return-b.Lb}},C:function(o,u){try{if(u===0)return-28;var l=j("/")+1;return u<l?-68:(Z("/",o,u),l)}catch(f){if(typeof we>"u"||f.name!=="ErrnoError")throw f;return-f.Lb}},G:function(o,u){try{return o=z(o),kn(Hi,o,u)}catch(l){if(typeof we>"u"||l.name!=="ErrnoError")throw l;return-l.Lb}},z:function(o,u,l){try{return u=z(u),u=jt(o,u),u=M(u),u[u.length-1]==="/"&&(u=u.substr(0,u.length-1)),wt(u,l),0}catch(f){if(typeof we>"u"||f.name!=="ErrnoError")throw f;return-f.Lb}},E:function(o,u,l,f){try{u=z(u);var b=f&256;return u=jt(o,u,f&4096),kn(b?Hi:Cn,u,l)}catch(E){if(typeof we>"u"||E.name!=="ErrnoError")throw E;return-E.Lb}},v:function(o,u,l,f){An=f;try{u=z(u),u=jt(o,u);var b=f?Wn():0;return Rn(u,l,b).Tb}catch(E){if(typeof we>"u"||E.name!=="ErrnoError")throw E;return-E.Lb}},s:function(o,u,l,f){try{if(u=z(u),u=jt(o,u),0>=f)return-28;var b=Vi(u),E=Math.min(f,j(b)),v=le[l+E];return Z(b,l,f+1),le[l+E]=v,E}catch(D){if(typeof we>"u"||D.name!=="ErrnoError")throw D;return-D.Lb}},r:function(o){try{return o=z(o),Ui(o),0}catch(u){if(typeof we>"u"||u.name!=="ErrnoError")throw u;return-u.Lb}},H:function(o,u){try{return o=z(o),kn(Cn,o,u)}catch(l){if(typeof we>"u"||l.name!=="ErrnoError")throw l;return-l.Lb}},o:function(o,u,l){try{if(u=z(u),u=jt(o,u),l===0){o=u;var f=Ze(o,{parent:!0}).node;if(!f)throw new F(44);var b=de(o),E=Jt(f,b),v=Pi(f,b,!1);if(v)throw new F(v);if(!f.Ab.lc)throw new F(63);if(E.Xb)throw new F(10);f.Ab.lc(f,b),Fi(E)}else l===512?Ui(u):Qe("Invalid flags passed to unlinkat");return 0}catch(D){if(typeof we>"u"||D.name!=="ErrnoError")throw D;return-D.Lb}},n:function(o,u,l){try{if(u=z(u),u=jt(o,u,!0),l){var f=yi(l),b=P[l+8>>2];E=1e3*f+b/1e6,l+=16,f=yi(l),b=P[l+8>>2],v=1e3*f+b/1e6}else var E=Date.now(),v=E;o=E;var D=Ze(u,{Vb:!0}).node;return D.Ab.Nb(D,{timestamp:Math.max(o,v)}),0}catch(S){if(typeof we>"u"||S.name!=="ErrnoError")throw S;return-S.Lb}},y:function(o,u){o=new Date(1e3*yi(o)),P[u>>2]=o.getSeconds(),P[u+4>>2]=o.getMinutes(),P[u+8>>2]=o.getHours(),P[u+12>>2]=o.getDate(),P[u+16>>2]=o.getMonth(),P[u+20>>2]=o.getFullYear()-1900,P[u+24>>2]=o.getDay();var l=o.getFullYear();P[u+28>>2]=(l%4!==0||l%100===0&&l%400!==0?Wo:Ao)[o.getMonth()]+o.getDate()-1|0,P[u+36>>2]=-(60*o.getTimezoneOffset()),l=new Date(o.getFullYear(),6,1).getTimezoneOffset();var f=new Date(o.getFullYear(),0,1).getTimezoneOffset();P[u+32>>2]=(l!=f&&o.getTimezoneOffset()==Math.min(f,l))|0},w:function(o,u,l,f,b,E,v){try{var D=ct(f);if(u&2&&!(l&2)&&(D.flags&2097155)!==2)throw new F(2);if((D.flags&2097155)===1)throw new F(2);if(!D.Jb.hc)throw new F(43);var S=D.Jb.hc(D,o,b,u,l),C=S.Lc;return P[E>>2]=S.zc,V[v>>2]=C,0}catch(L){if(typeof we>"u"||L.name!=="ErrnoError")throw L;return-L.Lb}},x:function(o,u,l,f,b,E){try{var v=ct(b);if(l&2){if((v.node.mode&61440)!==32768)throw new F(43);f&2||v.Jb.ic&&v.Jb.ic(v,Q.slice(o,o+u),E,u,f)}}catch(D){if(typeof we>"u"||D.name!=="ErrnoError")throw D;return-D.Lb}},p:function(o,u,l){function f(S){return(S=S.toTimeString().match(/\(([A-Za-z ]+)\)$/))?S[1]:"GMT"}var b=new Date().getFullYear(),E=new Date(b,0,1),v=new Date(b,6,1);b=E.getTimezoneOffset();var D=v.getTimezoneOffset();V[o>>2]=60*Math.max(b,D),P[u>>2]=+(b!=D),o=f(E),u=f(v),o=Yi(o),u=Yi(u),D<b?(V[l>>2]=o,V[l+4>>2]=u):(V[l>>2]=u,V[l+4>>2]=o)},e:function(){return Date.now()},d:()=>performance.now(),l:function(o){var u=Q.length;if(o>>>=0,2147483648<o)return!1;for(var l=1;4>=l;l*=2){var f=u*(1+.2/l);f=Math.min(f,o+100663296);var b=Math,E=b.min;f=Math.max(o,f),f+=(65536-f%65536)%65536;e:{var v=w.buffer;try{w.grow(E.call(b,2147483648,f)-v.byteLength+65535>>>16),B();var D=1;break e}catch{}D=void 0}if(D)return!0}return!1},A:function(o,u){var l=0;return Zi().forEach(function(f,b){var E=u+l;for(b=V[o+4*b>>2]=E,E=0;E<f.length;++E)le[b++>>0]=f.charCodeAt(E);le[b>>0]=0,l+=f.length+1}),0},B:function(o,u){var l=Zi();V[o>>2]=l.length;var f=0;return l.forEach(function(b){f+=b.length+1}),V[u>>2]=f,0},f:function(o){try{var u=ct(o);if(u.Tb===null)throw new F(8);u.mc&&(u.mc=null);try{u.Jb.close&&u.Jb.close(u)}catch(l){throw l}finally{qt[u.Tb]=null}return u.Tb=null,0}catch(l){if(typeof we>"u"||l.name!=="ErrnoError")throw l;return l.Lb}},m:function(o,u){try{var l=ct(o);return le[u>>0]=l.Pb?2:(l.mode&61440)===16384?3:(l.mode&61440)===40960?7:4,0}catch(f){if(typeof we>"u"||f.name!=="ErrnoError")throw f;return f.Lb}},t:function(o,u,l,f){try{e:{var b=ct(o);o=u;for(var E,v=u=0;v<l;v++){var D=V[o>>2],S=V[o+4>>2];o+=8;var C=b,L=D,q=S,$=E,ue=le;if(0>q||0>$)throw new F(28);if(C.Tb===null)throw new F(8);if((C.flags&2097155)===1)throw new F(8);if((C.node.mode&61440)===16384)throw new F(31);if(!C.Jb.read)throw new F(28);var _e=typeof $<"u";if(!_e)$=C.position;else if(!C.seekable)throw new F(70);var qe=C.Jb.read(C,ue,L,q,$);_e||(C.position+=qe);var xe=qe;if(0>xe){var et=-1;break e}if(u+=xe,xe<S)break;typeof E<"u"&&(E+=xe)}et=u}return V[f>>2]=et,0}catch(Pe){if(typeof we>"u"||Pe.name!=="ErrnoError")throw Pe;return Pe.Lb}},i:function(o,u,l,f,b){try{if(u=l+2097152>>>0<4194305-!!u?(u>>>0)+4294967296*l:NaN,isNaN(u))return 61;var E=ct(o);return Ki(E,u,f),Oe=[E.position>>>0,(Y=E.position,1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],P[b>>2]=Oe[0],P[b+4>>2]=Oe[1],E.mc&&u===0&&f===0&&(E.mc=null),0}catch(v){if(typeof we>"u"||v.name!=="ErrnoError")throw v;return v.Lb}},D:function(o){try{var u=ct(o);return $s(function(l){var f=u.node.Rb;f.type.Oc?f.type.Oc(f,!1,function(b){l(b?function(){return 29}:0)}):l(0)})}catch(l){if(typeof we>"u"||l.name!=="ErrnoError")throw l;return l.Lb}},q:function(o,u,l,f){try{e:{var b=ct(o);o=u;for(var E,v=u=0;v<l;v++){var D=V[o>>2],S=V[o+4>>2];o+=8;var C=b,L=D,q=S,$=E,ue=le;if(0>q||0>$)throw new F(28);if(C.Tb===null)throw new F(8);if(!(C.flags&2097155))throw new F(8);if((C.node.mode&61440)===16384)throw new F(31);if(!C.Jb.write)throw new F(28);C.seekable&&C.flags&1024&&Ki(C,0,2);var _e=typeof $<"u";if(!_e)$=C.position;else if(!C.seekable)throw new F(70);var qe=C.Jb.write(C,ue,L,q,$,void 0);_e||(C.position+=qe);var xe=qe;if(0>xe){var et=-1;break e}u+=xe,typeof E<"u"&&(E+=xe)}et=u}return V[f>>2]=et,0}catch(Pe){if(typeof we>"u"||Pe.name!=="ErrnoError")throw Pe;return Pe.Lb}},X:es,qa:ts,fa:rs,M:ns,ka:ss,F:os,h:as,na:us,ia:ls,da:cs,ea:ds,j:fs,u:hs,oa:ps,g:ms,pa:ys,ca:Ns,ga:bs,ha:ws,ma:Es,c:gs,ja:_s,la:Os,aa:Ts,V:vs,$:Is,ba:Ss,S:Cs,U:Rs,Z:xs,Y:ks,R:As,Q:Ws,T:Ls,_:qs,O:Ds,W:Fs,P:Bs};(function(){function o(l){if(l=l.exports,l=Lo(l),t.asm=l,w=t.asm.ra,B(),ae.unshift(t.asm.sa),Ye--,t.monitorRunDependencies&&t.monitorRunDependencies(Ye),Ye==0&&ze){var f=ze;ze=null,f()}return l}var u={a:zo};if(Ye++,t.monitorRunDependencies&&t.monitorRunDependencies(Ye),t.instantiateWasm)try{return t.instantiateWasm(u,o)}catch(l){R("Module.instantiateWasm callback failed with error: "+l),s(l)}return Lt(u,function(l){o(l.instance)}).catch(s),{}})(),t._sqlite3_malloc=function(){return(t._sqlite3_malloc=t.asm.ta).apply(null,arguments)},t._sqlite3_free=function(){return(t._sqlite3_free=t.asm.ua).apply(null,arguments)},t._sqlite3_bind_blob=function(){return(t._sqlite3_bind_blob=t.asm.va).apply(null,arguments)},t._sqlite3_bind_int=function(){return(t._sqlite3_bind_int=t.asm.wa).apply(null,arguments)},t._sqlite3_bind_int64=function(){return(t._sqlite3_bind_int64=t.asm.xa).apply(null,arguments)},t._sqlite3_bind_text=function(){return(t._sqlite3_bind_text=t.asm.ya).apply(null,arguments)},t._sqlite3_close=function(){return(t._sqlite3_close=t.asm.za).apply(null,arguments)},t._sqlite3_column_type=function(){return(t._sqlite3_column_type=t.asm.Aa).apply(null,arguments)},t._sqlite3_column_count=function(){return(t._sqlite3_column_count=t.asm.Ba).apply(null,arguments)},t._sqlite3_column_text=function(){return(t._sqlite3_column_text=t.asm.Ca).apply(null,arguments)},t._sqlite3_column_blob=function(){return(t._sqlite3_column_blob=t.asm.Da).apply(null,arguments)},t._sqlite3_column_bytes=function(){return(t._sqlite3_column_bytes=t.asm.Ea).apply(null,arguments)},t._sqlite3_column_double=function(){return(t._sqlite3_column_double=t.asm.Fa).apply(null,arguments)},t._sqlite3_column_int=function(){return(t._sqlite3_column_int=t.asm.Ga).apply(null,arguments)},t._sqlite3_column_int64=function(){return(t._sqlite3_column_int64=t.asm.Ha).apply(null,arguments)},t._sqlite3_column_name=function(){return(t._sqlite3_column_name=t.asm.Ia).apply(null,arguments)},t._sqlite3_declare_vtab=function(){return(t._sqlite3_declare_vtab=t.asm.Ja).apply(null,arguments)},t._sqlite3_errmsg=function(){return(t._sqlite3_errmsg=t.asm.Ka).apply(null,arguments)},t._sqlite3_exec=function(){return(t._sqlite3_exec=t.asm.La).apply(null,arguments)},t._sqlite3_finalize=function(){return(t._sqlite3_finalize=t.asm.Ma).apply(null,arguments)},t._sqlite3_prepare_v2=function(){return(t._sqlite3_prepare_v2=t.asm.Na).apply(null,arguments)},t._sqlite3_result_int=function(){return(t._sqlite3_result_int=t.asm.Oa).apply(null,arguments)},t._sqlite3_result_blob=function(){return(t._sqlite3_result_blob=t.asm.Pa).apply(null,arguments)},t._sqlite3_result_int64=function(){return(t._sqlite3_result_int64=t.asm.Qa).apply(null,arguments)},t._sqlite3_result_double=function(){return(t._sqlite3_result_double=t.asm.Ra).apply(null,arguments)},t._sqlite3_result_null=function(){return(t._sqlite3_result_null=t.asm.Sa).apply(null,arguments)},t._sqlite3_result_error=function(){return(t._sqlite3_result_error=t.asm.Ta).apply(null,arguments)},t._sqlite3_result_text=function(){return(t._sqlite3_result_text=t.asm.Ua).apply(null,arguments)},t._sqlite3_sql=function(){return(t._sqlite3_sql=t.asm.Va).apply(null,arguments)},t._sqlite3_reset=function(){return(t._sqlite3_reset=t.asm.Wa).apply(null,arguments)},t._sqlite3_step=function(){return(t._sqlite3_step=t.asm.Xa).apply(null,arguments)},t._sqlite3_value_text=function(){return(t._sqlite3_value_text=t.asm.Ya).apply(null,arguments)},t._sqlite3_value_type=function(){return(t._sqlite3_value_type=t.asm.Za).apply(null,arguments)},t._sqlite3_value_bytes=function(){return(t._sqlite3_value_bytes=t.asm._a).apply(null,arguments)},t._sqlite3_value_blob=function(){return(t._sqlite3_value_blob=t.asm.$a).apply(null,arguments)},t._sqlite3_value_int=function(){return(t._sqlite3_value_int=t.asm.ab).apply(null,arguments)},t._sqlite3_value_int64=function(){return(t._sqlite3_value_int64=t.asm.bb).apply(null,arguments)},t._sqlite3_value_double=function(){return(t._sqlite3_value_double=t.asm.cb).apply(null,arguments)},t._RegisterExtensionFunctions=function(){return(t._RegisterExtensionFunctions=t.asm.db).apply(null,arguments)};var Js=t._free=function(){return(Js=t._free=t.asm.eb).apply(null,arguments)};function js(){return(js=t.asm.fb).apply(null,arguments)}t._create_function=function(){return(t._create_function=t.asm.gb).apply(null,arguments)},t._update_hook=function(){return(t._update_hook=t.asm.hb).apply(null,arguments)},t._create_module=function(){return(t._create_module=t.asm.ib).apply(null,arguments)},t._register_vfs=function(){return(t._register_vfs=t.asm.jb).apply(null,arguments)},t._sqlite3_vfs_find=function(){return(t._sqlite3_vfs_find=t.asm.kb).apply(null,arguments)},t._getSqliteFree=function(){return(t._getSqliteFree=t.asm.lb).apply(null,arguments)};var Ks=t._main=function(){return(Ks=t._main=t.asm.mb).apply(null,arguments)};t._sqlite3_bind_null=function(){return(t._sqlite3_bind_null=t.asm.nb).apply(null,arguments)},t._sqlite3_clear_bindings=function(){return(t._sqlite3_clear_bindings=t.asm.ob).apply(null,arguments)},t._sqlite3_data_count=function(){return(t._sqlite3_data_count=t.asm.pb).apply(null,arguments)},t._sqlite3_bind_double=function(){return(t._sqlite3_bind_double=t.asm.qb).apply(null,arguments)},t._sqlite3_bind_parameter_count=function(){return(t._sqlite3_bind_parameter_count=t.asm.rb).apply(null,arguments)},t._sqlite3_bind_parameter_name=function(){return(t._sqlite3_bind_parameter_name=t.asm.sb).apply(null,arguments)},t._sqlite3_libversion=function(){return(t._sqlite3_libversion=t.asm.tb).apply(null,arguments)},t._sqlite3_libversion_number=function(){return(t._sqlite3_libversion_number=t.asm.ub).apply(null,arguments)},t._sqlite3_changes=function(){return(t._sqlite3_changes=t.asm.vb).apply(null,arguments)},t._sqlite3_open_v2=function(){return(t._sqlite3_open_v2=t.asm.wb).apply(null,arguments)},t._sqlite3_get_autocommit=function(){return(t._sqlite3_get_autocommit=t.asm.xb).apply(null,arguments)};var gi=t._malloc=function(){return(gi=t._malloc=t.asm.yb).apply(null,arguments)};function Gs(){return(Gs=t.asm.zb).apply(null,arguments)}function Xs(){return(Xs=t.asm.Bb).apply(null,arguments)}function Ys(){return(Ys=t.asm.Cb).apply(null,arguments)}function Zs(){return(Zs=t.asm.Db).apply(null,arguments)}function _i(){return(_i=t.asm.Eb).apply(null,arguments)}function eo(){return(eo=t.asm.Fb).apply(null,arguments)}function ro(){return(ro=t.asm.Gb).apply(null,arguments)}function no(){return(no=t.asm.Hb).apply(null,arguments)}function io(){return(io=t.asm.Ib).apply(null,arguments)}t.UTF8ToString=z,t.stringToUTF8=Z,t.lengthBytesUTF8=j,t.getTempRet0=Xs,t.ccall=St,t.cwrap=function(o,u,l,f){var b=!l||l.every(E=>E==="number"||E==="boolean");return u!=="string"&&b&&!f?t["_"+o]:function(){return St(o,u,l,arguments,f)}},t.setValue=ot,t.getValue=Te;var Dn;ze=function o(){Dn||so(),Dn||(ze=o)};function so(){function o(){if(!Dn&&(Dn=!0,t.calledRun=!0,!y)){if(t.noFSInit||Xi||(Xi=!0,Gi(),t.stdin=t.stdin,t.stdout=t.stdout,t.stderr=t.stderr,t.stdin?Vr("stdin",t.stdin):pi("/dev/tty","/dev/stdin"),t.stdout?Vr("stdout",null,t.stdout):pi("/dev/tty","/dev/stdout"),t.stderr?Vr("stderr",null,t.stderr):pi("/dev/tty1","/dev/stderr"),Rn("/dev/stdin",0),Rn("/dev/stdout",1),Rn("/dev/stderr",1)),Di=!1,dr(ae),dr(je),n(t),t.onRuntimeInitialized&&t.onRuntimeInitialized(),oo){var u=Ks;try{var l=u(0,0);_=l,zs(l)}catch(f){wi(f)}}if(t.postRun)for(typeof t.postRun=="function"&&(t.postRun=[t.postRun]);t.postRun.length;)u=t.postRun.shift(),Le.unshift(u);dr(Le)}}if(!(0<Ye)){if(t.preRun)for(typeof t.preRun=="function"&&(t.preRun=[t.preRun]);t.preRun.length;)At();dr(G),0<Ye||(t.setStatus?(t.setStatus("Running..."),setTimeout(function(){setTimeout(function(){t.setStatus("")},1),o()},1)):o())}}if(t.preInit)for(typeof t.preInit=="function"&&(t.preInit=[t.preInit]);0<t.preInit.length;)t.preInit.pop()();var oo=!0;return t.noInitialRun&&(oo=!1),so(),e.ready}})();const SQLiteAsyncESMFactory=Module,SQLITE_OK=0,SQLITE_BUSY=5,SQLITE_IOERR=10,SQLITE_NOTFOUND=12,SQLITE_CANTOPEN=14,SQLITE_MISUSE=21,SQLITE_RANGE=25,SQLITE_NOTICE=27,SQLITE_ROW=100,SQLITE_DONE=101,SQLITE_IOERR_LOCK=3850,SQLITE_IOERR_SHORT_READ=522,SQLITE_OPEN_READONLY=1,SQLITE_OPEN_READWRITE=2,SQLITE_OPEN_CREATE=4,SQLITE_OPEN_DELETEONCLOSE=8,SQLITE_OPEN_URI=64,SQLITE_LOCK_NONE=0,SQLITE_LOCK_SHARED=1,SQLITE_LOCK_RESERVED=2,SQLITE_LOCK_PENDING=3,SQLITE_LOCK_EXCLUSIVE=4,SQLITE_IOCAP_SAFE_APPEND=512,SQLITE_IOCAP_SEQUENTIAL=1024,SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN=2048,SQLITE_IOCAP_BATCH_ATOMIC=16384,SQLITE_INTEGER=1,SQLITE_FLOAT=2,SQLITE_TEXT=3,SQLITE_BLOB=4,SQLITE_NULL=5,SQLITE_UTF8=1,MAX_INT64=0x7fffffffffffffffn,MIN_INT64=-0x8000000000000000n;class SQLiteError extends Error{constructor(e,t){super(e),this.code=t}}const async=!0;function Factory(r){const e={},t=r._getSqliteFree(),n=r._malloc(8),s=[n,n+4];function a(m){if(typeof m!="string")return 0;const w=r.lengthBytesUTF8(m),y=r._sqlite3_malloc(w+1);return r.stringToUTF8(m,y,w+1),y}function c(m,w){return BigInt(w)<<32n|BigInt(m)&0xffffffffn}const d=function(){const m=BigInt(Number.MAX_SAFE_INTEGER)>>32n,w=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(y,_){return _>m||_<w?c(y,_):_*4294967296+(y&2147483647)-(y&2147483648)}}(),h=new Set;function p(m){if(!h.has(m))throw new SQLiteError("not a database",SQLITE_MISUSE)}const N=new Map;function O(m){if(!N.has(m))throw new SQLiteError("not a statement",SQLITE_MISUSE)}e.bind_collection=function(m,w){O(m);const y=Array.isArray(w),_=e.bind_parameter_count(m);for(let g=1;g<=_;++g){const W=y?g-1:e.bind_parameter_name(m,g),z=w[W];z!==void 0&&e.bind(m,g,z)}return SQLITE_OK},e.bind=function(m,w,y){switch(O(m),typeof y){case"number":return y===(y|0)?e.bind_int(m,w,y):e.bind_double(m,w,y);case"string":return e.bind_text(m,w,y);default:if(y instanceof Uint8Array||Array.isArray(y))return e.bind_blob(m,w,y);if(y===null)return e.bind_null(m,w);if(typeof y=="bigint")return e.bind_int64(m,w,y);if(y===void 0)return SQLITE_NOTICE;throw new Error("Unknown binding type "+typeof y)}},e.bind_blob=function(){const m="sqlite3_bind_blob",w=r.cwrap(m,...decl("nnnnn:n"));return function(y,_,g){O(y);const W=g.byteLength??g.length,z=r._sqlite3_malloc(W);r.HEAPU8.subarray(z).set(g);const X=w(y,_,z,W,t);return x(m,X,N.get(y))}}(),e.bind_parameter_count=function(){const m="sqlite3_bind_parameter_count",w=r.cwrap(m,...decl("n:n"));return function(y){return O(y),w(y)}}(),e.bind_double=function(){const m="sqlite3_bind_double",w=r.cwrap(m,...decl("nnn:n"));return function(y,_,g){O(y);const W=w(y,_,g);return x(m,W,N.get(y))}}(),e.bind_int=function(){const m="sqlite3_bind_int",w=r.cwrap(m,...decl("nnn:n"));return function(y,_,g){if(O(y),g>2147483647||g<-2147483648)return SQLITE_RANGE;const W=w(y,_,g);return x(m,W,N.get(y))}}(),e.bind_int64=function(){const m="sqlite3_bind_int64",w=r.cwrap(m,...decl("nnnn:n"));return function(y,_,g){if(O(y),g>MAX_INT64||g<MIN_INT64)return SQLITE_RANGE;const W=g&0xffffffffn,z=g>>32n,X=w(y,_,Number(W),Number(z));return x(m,X,N.get(y))}}(),e.bind_null=function(){const m="sqlite3_bind_null",w=r.cwrap(m,...decl("nn:n"));return function(y,_){O(y);const g=w(y,_);return x(m,g,N.get(y))}}(),e.bind_parameter_name=function(){const m="sqlite3_bind_parameter_name",w=r.cwrap(m,...decl("n:s"));return function(y,_){return O(y),w(y,_)}}(),e.bind_text=function(){const m="sqlite3_bind_text",w=r.cwrap(m,...decl("nnnnn:n"));return function(y,_,g){O(y);const W=a(g),z=w(y,_,W,-1,t);return x(m,z,N.get(y))}}(),e.changes=function(){const m="sqlite3_changes",w=r.cwrap(m,...decl("n:n"));return function(y){return p(y),w(y)}}(),e.close=function(){const m="sqlite3_close",w=r.cwrap(m,...decl("n:n"),{async});return async function(y){p(y);const _=await w(y);return h.delete(y),x(m,_,y)}}(),e.column=function(m,w){O(m);const y=e.column_type(m,w);switch(y){case SQLITE_BLOB:return e.column_blob(m,w);case SQLITE_FLOAT:return e.column_double(m,w);case SQLITE_INTEGER:const _=e.column_int(m,w),g=r.getTempRet0();return d(_,g);case SQLITE_NULL:return null;case SQLITE_TEXT:return e.column_text(m,w);default:throw new SQLiteError("unknown type",y)}},e.column_blob=function(){const m="sqlite3_column_blob",w=r.cwrap(m,...decl("nn:n"));return function(y,_){O(y);const g=e.column_bytes(y,_),W=w(y,_),z=r.HEAPU8.subarray(W,W+g),X=new ArrayBuffer(z.byteLength),Z=new Uint8Array(X);return Z.set(z),Z}}(),e.column_bytes=function(){const m="sqlite3_column_bytes",w=r.cwrap(m,...decl("nn:n"));return function(y,_){return O(y),w(y,_)}}(),e.column_count=function(){const m="sqlite3_column_count",w=r.cwrap(m,...decl("n:n"));return function(y){return O(y),w(y)}}(),e.column_double=function(){const m="sqlite3_column_double",w=r.cwrap(m,...decl("nn:n"));return function(y,_){return O(y),w(y,_)}}(),e.column_int=function(){const m="sqlite3_column_int64",w=r.cwrap(m,...decl("nn:n"));return function(y,_){return O(y),w(y,_)}}(),e.column_int64=function(){const m="sqlite3_column_int64",w=r.cwrap(m,...decl("nn:n"));return function(y,_){O(y);const g=w(y,_),W=r.getTempRet0();return c(g,W)}}(),e.column_name=function(){const m="sqlite3_column_name",w=r.cwrap(m,...decl("nn:s"));return function(y,_){return O(y),w(y,_)}}(),e.column_names=function(m){const w=[],y=e.column_count(m);for(let _=0;_<y;++_)w.push(e.column_name(m,_));return w},e.column_text=function(){const m="sqlite3_column_text",w=r.cwrap(m,...decl("nn:s"));return function(y,_){return O(y),w(y,_)}}(),e.column_type=function(){const m="sqlite3_column_type",w=r.cwrap(m,...decl("nn:n"));return function(y,_){return O(y),w(y,_)}}(),e.update_hook=function(m,w){return p(m),r.updateHook(m,w),SQLITE_OK},e.create_function=function(m,w,y,_,g,W,z,X){if(p(m),W&&!z&&!X){const Z=r.createFunction(m,w,y,_,g,W);return x("sqlite3_create_function",Z,m)}if(!W&&z&&X){const Z=r.createAggregate(m,w,y,_,g,z,X);return x("sqlite3_create_function",Z,m)}throw new SQLiteError("invalid function combination",SQLITE_MISUSE)},e.create_module=function(m,w,y,_){p(m);const g=r.createModule(m,w,y,_);return x("sqlite3_create_module",g,m)},e.data_count=function(){const m="sqlite3_data_count",w=r.cwrap(m,...decl("n:n"));return function(y){return O(y),w(y)}}(),e.declare_vtab=function(){const m="sqlite3_declare_vtab",w=r.cwrap(m,...decl("ns:n"));return function(y,_){const g=w(y,_);return x("sqlite3_declare_vtab",g)}}(),e.exec=async function(m,w,y){for await(const _ of e.statements(m,w)){let g;for(;await e.step(_)===SQLITE_ROW;)if(y){g=g??e.column_names(_);const W=e.row(_);await y(W,g)}}return SQLITE_OK},e.finalize=function(){const m="sqlite3_finalize",w=r.cwrap(m,...decl("n:n"),{async});return async function(y){O(y);const _=await w(y),g=N.get(y);return N.delete(y),x(m,_,g)}}(),e.get_autocommit=function(){const m="sqlite3_get_autocommit",w=r.cwrap(m,...decl("n:n"));return function(y){return w(y)}}(),e.libversion=function(){const m="sqlite3_libversion",w=r.cwrap(m,...decl(":s"));return function(){return w()}}(),e.libversion_number=function(){const m="sqlite3_libversion_number",w=r.cwrap(m,...decl(":n"));return function(){return w()}}(),e.open_v2=function(){const m="sqlite3_open_v2",w=r.cwrap(m,...decl("snnn:n"),{async});return async function(y,_,g){_=_||SQLITE_OPEN_CREATE|SQLITE_OPEN_READWRITE,g=a(g);const W=await w(y,s[0],_,g),z=r.getValue(s[0],"i32");return h.add(z),r._sqlite3_free(g),r.ccall("RegisterExtensionFunctions","void",["number"],[z]),x(m,W),z}}(),e.prepare_v2=function(){const m="sqlite3_prepare_v2",w=r.cwrap(m,...decl("nnnnn:n"),{async});return async function(y,_){const g=await w(y,_,-1,s[0],s[1]);x(m,g,y);const W=r.getValue(s[0],"i32");return W?(N.set(W,y),{stmt:W,sql:r.getValue(s[1],"i32")}):null}}(),e.reset=function(){const m="sqlite3_reset",w=r.cwrap(m,...decl("n:n"),{async});return async function(y){O(y);const _=await w(y);return x(m,_,N.get(y))}}(),e.result=function(m,w){switch(typeof w){case"number":w===(w|0)?e.result_int(m,w):e.result_double(m,w);break;case"string":e.result_text(m,w);break;default:if(w instanceof Uint8Array||Array.isArray(w))e.result_blob(m,w);else if(w===null)e.result_null(m);else{if(typeof w=="bigint")return e.result_int64(m,w);console.warn("unknown result converted to null",w),e.result_null(m)}break}},e.result_blob=function(){const m="sqlite3_result_blob",w=r.cwrap(m,...decl("nnnn:n"));return function(y,_){const g=_.byteLength??_.length,W=r._sqlite3_malloc(g);r.HEAPU8.subarray(W).set(_),w(y,W,g,t)}}(),e.result_double=function(){const m="sqlite3_result_double",w=r.cwrap(m,...decl("nn:n"));return function(y,_){w(y,_)}}(),e.result_int=function(){const m="sqlite3_result_int",w=r.cwrap(m,...decl("nn:n"));return function(y,_){w(y,_)}}(),e.result_int64=function(){const m="sqlite3_result_int64",w=r.cwrap(m,...decl("nnn:n"));return function(y,_){if(_>MAX_INT64||_<MIN_INT64)return SQLITE_RANGE;const g=_&0xffffffffn,W=_>>32n;w(y,Number(g),Number(W))}}(),e.result_null=function(){const m="sqlite3_result_null",w=r.cwrap(m,...decl("n:n"));return function(y){w(y)}}(),e.result_text=function(){const m="sqlite3_result_text",w=r.cwrap(m,...decl("nnnn:n"));return function(y,_){const g=a(_);w(y,g,-1,t)}}(),e.row=function(m){const w=[],y=e.data_count(m);for(let _=0;_<y;++_){const g=e.column(m,_);w.push((g==null?void 0:g.buffer)===r.HEAPU8.buffer?g.slice():g)}return w},e.sql=function(){const m="sqlite3_sql",w=r.cwrap(m,...decl("n:s"));return function(y){return O(y),w(y)}}(),e.statements=function(m,w){return async function*(){const y=e.str_new(m,w);let _={stmt:null,sql:e.str_value(y)};try{for(;_=await e.prepare_v2(m,_.sql);)yield _.stmt,e.finalize(_.stmt),_.stmt=null}finally{_!=null&&_.stmt&&e.finalize(_.stmt),e.str_finish(y)}}()},e.step=function(){const m="sqlite3_step",w=r.cwrap(m,...decl("n:n"),{async});return async function(y){O(y);const _=await w(y);return x(m,_,N.get(y),[SQLITE_ROW,SQLITE_DONE])}}();let A=0;const R=new Map;e.str_new=function(m,w=""){const y=r.lengthBytesUTF8(w),_=A++&4294967295,g={offset:r._sqlite3_malloc(y+1),bytes:y};return R.set(_,g),r.stringToUTF8(w,g.offset,g.bytes+1),_},e.str_appendall=function(m,w){if(!R.has(m))throw new SQLiteError("not a string",SQLITE_MISUSE);const y=R.get(m),_=r.lengthBytesUTF8(w),g=y.bytes+_,W=r._sqlite3_malloc(g+1);r.HEAPU8.subarray(W,W+g+1).set(r.HEAPU8.subarray(y.offset,y.offset+y.bytes)),r.stringToUTF8(w,W+y.bytes,_+1),r._sqlite3_free(y.offset),y.offset=W,y.bytes=g,R.set(m,y)},e.str_finish=function(m){if(!R.has(m))throw new SQLiteError("not a string",SQLITE_MISUSE);const w=R.get(m);R.delete(m),r._sqlite3_free(w.offset)},e.str_value=function(m){if(!R.has(m))throw new SQLiteError("not a string",SQLITE_MISUSE);return R.get(m).offset},e.user_data=function(m){return r.getFunctionUserData(m)},e.value=function(m){const w=e.value_type(m);switch(w){case SQLITE_BLOB:return e.value_blob(m);case SQLITE_FLOAT:return e.value_double(m);case SQLITE_INTEGER:const y=e.value_int(m),_=r.getTempRet0();return d(y,_);case SQLITE_NULL:return null;case SQLITE_TEXT:return e.value_text(m);default:throw new SQLiteError("unknown type",w)}},e.value_blob=function(){const m="sqlite3_value_blob",w=r.cwrap(m,...decl("n:n"));return function(y){const _=e.value_bytes(y),g=w(y);return r.HEAPU8.subarray(g,g+_)}}(),e.value_bytes=function(){const m="sqlite3_value_bytes",w=r.cwrap(m,...decl("n:n"));return function(y){return w(y)}}(),e.value_double=function(){const m="sqlite3_value_double",w=r.cwrap(m,...decl("n:n"));return function(y){return w(y)}}(),e.value_int=function(){const m="sqlite3_value_int64",w=r.cwrap(m,...decl("n:n"));return function(y){return w(y)}}(),e.value_int64=function(){const m="sqlite3_value_int64",w=r.cwrap(m,...decl("n:n"));return function(y){const _=w(y),g=r.getTempRet0();return c(_,g)}}(),e.value_text=function(){const m="sqlite3_value_text",w=r.cwrap(m,...decl("n:s"));return function(y){return w(y)}}(),e.value_type=function(){const m="sqlite3_value_type",w=r.cwrap(m,...decl("n:n"));return function(y){return w(y)}}(),e.vfs_register=function(m,w){const y=r.registerVFS(m,w);return x("sqlite3_vfs_register",y)};function x(m,w,y=null,_=[SQLITE_OK]){if(_.includes(w))return w;const g=y?r.ccall("sqlite3_errmsg","string",["number"],[y]):m;throw new SQLiteError(g,w)}return e}function decl(r){const e=[],t=r.match(/([ns@]*):([ns@])/);switch(t[2]){case"n":e.push("number");break;case"s":e.push("string");break}const n=[];for(let s of t[1])switch(s){case"n":n.push("number");break;case"s":n.push("string");break}return e.push(n),e}class Base{constructor(){ce(this,"mxPathName",64)}xClose(e){return SQLITE_IOERR}xRead(e,t,n){return SQLITE_IOERR}xWrite(e,t,n){return SQLITE_IOERR}xTruncate(e,t){return SQLITE_IOERR}xSync(e,t){return SQLITE_OK}xFileSize(e,t){return SQLITE_IOERR}xLock(e,t){return SQLITE_OK}xUnlock(e,t){return SQLITE_OK}xCheckReservedLock(e,t){return t.setInt32(0,0,!0),SQLITE_OK}xFileControl(e,t,n){return SQLITE_NOTFOUND}xSectorSize(e){return 512}xDeviceCharacteristics(e){return 0}xOpen(e,t,n,s){return SQLITE_CANTOPEN}xDelete(e,t){return SQLITE_IOERR}xAccess(e,t,n){return SQLITE_IOERR}handleAsync(e){return e()}}const LOCK_TYPE_MASK=SQLITE_LOCK_NONE|SQLITE_LOCK_SHARED|SQLITE_LOCK_RESERVED|SQLITE_LOCK_PENDING|SQLITE_LOCK_EXCLUSIVE;var Ve,zr,Nn,bn,Ri,ri,bo,ni,wo;class WebLocksBase{constructor(){T(this,bn);T(this,ri);T(this,ni);T(this,Ve,SQLITE_LOCK_NONE);ce(this,"timeoutMillis",0);T(this,zr,new Map);T(this,Nn,Promise.resolve(0))}get state(){return i(this,Ve)}async lock(e){return ie(this,bn,Ri).call(this,ie(this,ri,bo),e)}async unlock(e){return ie(this,bn,Ri).call(this,ie(this,ni,wo),e)}async isSomewhereReserved(){throw new Error("unimplemented")}async _NONEtoSHARED(){}async _SHAREDtoEXCLUSIVE(){await this._SHAREDtoRESERVED(),await this._RESERVEDtoEXCLUSIVE()}async _SHAREDtoRESERVED(){}async _RESERVEDtoEXCLUSIVE(){}async _EXCLUSIVEtoRESERVED(){}async _EXCLUSIVEtoSHARED(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED()}async _EXCLUSIVEtoNONE(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _RESERVEDtoSHARED(){}async _RESERVEDtoNONE(){await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _SHAREDtoNONE(){}_acquireWebLock(e,t){return new Promise(async(n,s)=>{try{await navigator.locks.request(e,t,a=>{if(n(a),a)return new Promise(c=>i(this,zr).set(e,c))})}catch(a){s(a)}})}_releaseWebLock(e){var t;(t=i(this,zr).get(e))==null||t(),i(this,zr).delete(e)}async _pollWebLock(e){var n;return(n=(await navigator.locks.query()).held.find(({name:s})=>s===e))==null?void 0:n.mode}_getTimeoutSignal(){if(this.timeoutMillis){const e=new AbortController;return setTimeout(()=>e.abort(),this.timeoutMillis),e.signal}}}Ve=new WeakMap,zr=new WeakMap,Nn=new WeakMap,bn=new WeakSet,Ri=async function(e,t){const n=t&LOCK_TYPE_MASK;try{const s=()=>e.call(this,n);return await k(this,Nn,i(this,Nn).then(s,s)),k(this,Ve,n),SQLITE_OK}catch(s){return s.name==="AbortError"?SQLITE_BUSY:(console.error(s),SQLITE_IOERR_LOCK)}},ri=new WeakSet,bo=async function(e){if(e===i(this,Ve))return SQLITE_OK;switch(i(this,Ve)){case SQLITE_LOCK_NONE:switch(e){case SQLITE_LOCK_SHARED:return this._NONEtoSHARED();default:throw new Error(`unexpected transition ${i(this,Ve)} -> ${e}`)}case SQLITE_LOCK_SHARED:switch(e){case SQLITE_LOCK_RESERVED:return this._SHAREDtoRESERVED();case SQLITE_LOCK_EXCLUSIVE:return this._SHAREDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${i(this,Ve)} -> ${e}`)}case SQLITE_LOCK_RESERVED:switch(e){case SQLITE_LOCK_EXCLUSIVE:return this._RESERVEDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${i(this,Ve)} -> ${e}`)}default:throw new Error(`unexpected transition ${i(this,Ve)} -> ${e}`)}},ni=new WeakSet,wo=async function(e){if(e===i(this,Ve))return SQLITE_OK;switch(i(this,Ve)){case SQLITE_LOCK_EXCLUSIVE:switch(e){case SQLITE_LOCK_SHARED:return this._EXCLUSIVEtoSHARED();case SQLITE_LOCK_NONE:return this._EXCLUSIVEtoNONE();default:throw new Error(`unexpected transition ${i(this,Ve)} -> ${e}`)}case SQLITE_LOCK_RESERVED:switch(e){case SQLITE_LOCK_SHARED:return this._RESERVEDtoSHARED();case SQLITE_LOCK_NONE:return this._RESERVEDtoNONE();default:throw new Error(`unexpected transition ${i(this,Ve)} -> ${e}`)}case SQLITE_LOCK_SHARED:switch(e){case SQLITE_LOCK_NONE:return this._SHAREDtoNONE();default:throw new Error(`unexpected transition ${i(this,Ve)} -> ${e}`)}default:throw new Error(`unexpected transition ${i(this,Ve)} -> ${e}`)}};class WebLocksExclusive extends WebLocksBase{constructor(e){super(),this._lockName=e+"-outer",this._reservedName=e+"-reserved"}async isSomewhereReserved(){return await this._pollWebLock(this._reservedName)==="exclusive"}async _NONEtoSHARED(){await this._acquireWebLock(this._lockName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _SHAREDtoRESERVED(){await this._acquireWebLock(this._reservedName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _RESERVEDtoSHARED(){this._releaseWebLock(this._reservedName)}async _SHAREDtoNONE(){this._releaseWebLock(this._lockName)}}const RETRYABLE_EXCEPTIONS=new Set(["TransactionInactiveError","InvalidStateError"]);let nextTxId=0;const mapTxToId=new WeakMap;function log$2(...r){}var Qr,wn,rt,En,ur,gn,ii,Eo,si,go;class IDBContext{constructor(e,t={durability:"default"}){T(this,ii);T(this,si);T(this,Qr,void 0);T(this,wn,void 0);T(this,rt,null);T(this,En,null);T(this,ur,null);T(this,gn,Promise.resolve());k(this,Qr,Promise.resolve(e)),k(this,wn,t)}async close(){(await i(this,Qr)).close()}async run(e,t){return k(this,gn,i(this,gn).then(()=>ie(this,ii,Eo).call(this,e,t)))}async sync(){return await new Promise(e=>this.run("readwrite",e)),i(this,En)}}Qr=new WeakMap,wn=new WeakMap,rt=new WeakMap,En=new WeakMap,ur=new WeakMap,gn=new WeakMap,ii=new WeakSet,Eo=async function(e,t){var a,c;const n=await i(this,Qr),s=Array.from(n.objectStoreNames);e!=="readonly"&&((a=i(this,rt))==null?void 0:a.mode)==="readonly"?k(this,rt,null):((c=i(this,ur))==null?void 0:c.readyState)==="pending"&&await new Promise(d=>{i(this,ur).addEventListener("success",d),i(this,ur).addEventListener("error",d)});for(let d=0;d<2;++d){i(this,rt)||(k(this,rt,n.transaction(s,e,i(this,wn))),k(this,En,new Promise(h=>{i(this,rt).addEventListener("complete",p=>{i(this,rt)===p.target&&k(this,rt,null),h(),log$2(`transaction ${mapTxToId.get(p.target)} complete`)})})),mapTxToId.set(i(this,rt),nextTxId++));try{const h=Object.fromEntries(s.map(p=>{const N=i(this,rt).objectStore(p),O=new Store(N,A=>ie(this,si,go).call(this,A));return[p,O]}));return await t(h)}catch(h){if(d||!RETRYABLE_EXCEPTIONS.has(h.name)){try{i(this,rt).abort()}catch{}throw h}k(this,rt,null)}}},si=new WeakSet,go=function(e){return k(this,ur,e),new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)})};class Store{constructor(e,t){this.store=e,this.addRequest=t}get(e){log$2(`get ${this.store.name}`,e);const t=this.store.get(e);return this.addRequest(t)}getAll(e,t){log$2(`getAll ${this.store.name}`,e,t);const n=this.store.getAll(e,t);return this.addRequest(n)}getKey(e){log$2(`getKey ${this.store.name}`,e);const t=this.store.getKey(e);return this.addRequest(t)}getAllKeys(e,t){log$2(`getAllKeys ${this.store.name}`,e,t);const n=this.store.getAllKeys(e,t);return this.addRequest(n)}put(e,t){log$2(`put ${this.store.name}`,e,t);const n=this.store.put(e,t);return this.addRequest(n)}delete(e){log$2(`delete ${this.store.name}`,e);const t=this.store.delete(e);return this.addRequest(t)}clear(){log$2(`clear ${this.store.name}`);const e=this.store.clear();return this.addRequest(e)}index(e){return new Index(this.store.index(e),t=>this.addRequest(t))}}class Index{constructor(e,t){this.index=e,this.addRequest=t}getAllKeys(e,t){log$2(`IDBIndex.getAllKeys ${this.index.objectStore.name}<${this.index.name}>`,e,t);const n=this.index.getAllKeys(e,t);return this.addRequest(n)}}const SECTOR_SIZE=512,DEFAULT_OPTIONS={durability:"default",purge:"deferred",purgeAtLeast:16};function log$1(...r){}var Vt,Je,Ce,lr,oi,_o,Ht,pr,ai,Oo;class IDBBatchAtomicVFS extends Base{constructor(t="wa-sqlite",n=DEFAULT_OPTIONS){super();T(this,oi);T(this,Ht);T(this,ai);T(this,Vt,void 0);T(this,Je,new Map);T(this,Ce,void 0);T(this,lr,new Set);this.name=t,k(this,Vt,Object.assign({},DEFAULT_OPTIONS,n)),k(this,Ce,new IDBContext(openDatabase(t),{durability:i(this,Vt).durability}))}async close(){var t;for(const n of i(this,Je).keys())await this.xClose(n);(t=i(this,Ce))==null||t.close(),k(this,Ce,null)}xOpen(t,n,s,a){return this.handleAsync(async()=>{t===null&&(t=`null_${n}`),log$1(`xOpen ${t} 0x${n.toString(16)} 0x${s.toString(16)}`);try{const c=new URL(t,"http://localhost/"),d={path:c.pathname,flags:s,block0:null,locks:new WebLocksExclusive(c.pathname)};return i(this,Je).set(n,d),await i(this,Ce).run("readwrite",async({blocks:h})=>{if(d.block0=await h.get(ie(this,Ht,pr).call(this,d,0)),!d.block0)if(s&SQLITE_OPEN_CREATE)d.block0={path:d.path,offset:0,version:0,data:new Uint8Array(0),fileSize:0},h.put(d.block0);else throw new Error(`file not found: ${d.path}`)}),a.setInt32(0,s&SQLITE_OPEN_READONLY,!0),SQLITE_OK}catch(c){return console.error(c),SQLITE_CANTOPEN}})}xClose(t){return this.handleAsync(async()=>{try{const n=i(this,Je).get(t);return n&&(log$1(`xClose ${n.path}`),i(this,Je).delete(t),n.flags&SQLITE_OPEN_DELETEONCLOSE&&i(this,Ce).run("readwrite",({blocks:s})=>{s.delete(IDBKeyRange.bound([n.path],[n.path,[]]))})),SQLITE_OK}catch(n){return console.error(n),SQLITE_IOERR}})}xRead(t,n,s){return this.handleAsync(async()=>{const a=i(this,Je).get(t);log$1(`xRead ${a.path} ${n.byteLength} ${s}`);try{return await i(this,Ce).run("readonly",async({blocks:d})=>{let h=0;for(;h<n.byteLength;){const p=s+h,N=p<a.block0.data.byteLength?a.block0:await d.get(ie(this,Ht,pr).call(this,a,-p));if(!N||N.data.byteLength-N.offset<=p)return n.fill(0,h),SQLITE_IOERR_SHORT_READ;const O=n.subarray(h),A=p+N.offset,R=Math.min(Math.max(N.data.byteLength-A,0),O.byteLength);O.set(N.data.subarray(A,A+R)),h+=R}return SQLITE_OK})}catch(c){return console.error(c),SQLITE_IOERR}})}xWrite(t,n,s){const a=i(this,Je).get(t);log$1(`xWrite ${a.path} ${n.byteLength} ${s}`);try{const c=a.block0.fileSize;a.block0.fileSize=Math.max(a.block0.fileSize,s+n.byteLength);const d=s===0?a.block0:{path:a.path,offset:-s,version:a.block0.version,data:null};return d.data=n.slice(),a.changedPages?(c===a.block0.fileSize&&a.changedPages.add(-s),s!==0&&i(this,Ce).run("readwrite",({blocks:h})=>h.put(d))):i(this,Ce).run("readwrite",({blocks:h})=>h.put(d)),SQLITE_OK}catch(c){return console.error(c),SQLITE_IOERR}}xTruncate(t,n){const s=i(this,Je).get(t);log$1(`xTruncate ${s.path} ${n}`);try{Object.assign(s.block0,{fileSize:n,data:s.block0.data.slice(0,n)});const a=Object.assign({},s.block0);return i(this,Ce).run("readwrite",({blocks:c})=>{c.delete(ie(this,Ht,pr).call(this,s,-1/0,-n)),c.put(a)}),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}}xSync(t,n){const s=i(this,Je).get(t);log$1(`xSync ${s.path} ${n}`);try{return i(this,Vt).durability!=="relaxed"?this.handleAsync(async()=>(await i(this,Ce).sync(),SQLITE_OK)):SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}}xFileSize(t,n){const s=i(this,Je).get(t);return log$1(`xFileSize ${s.path}`),n.setBigInt64(0,BigInt(s.block0.fileSize),!0),SQLITE_OK}xLock(t,n){return this.handleAsync(async()=>{const s=i(this,Je).get(t);log$1(`xLock ${s.path} ${n}`);try{const a=await s.locks.lock(n);return a===SQLITE_OK&&s.locks.state===SQLITE_LOCK_SHARED&&(s.block0=await i(this,Ce).run("readonly",({blocks:c})=>c.get(ie(this,Ht,pr).call(this,s,0)))),a}catch(a){return console.error(a),SQLITE_IOERR}})}xUnlock(t,n){return this.handleAsync(async()=>{const s=i(this,Je).get(t);log$1(`xUnlock ${s.path} ${n}`);try{return s.locks.unlock(n)}catch(a){return console.error(a),SQLITE_IOERR}})}xCheckReservedLock(t,n){return this.handleAsync(async()=>{const s=i(this,Je).get(t);log$1(`xCheckReservedLock ${s.path}`);const a=await s.locks.isSomewhereReserved();return n.setInt32(0,a?1:0,!0),SQLITE_OK})}xSectorSize(t){return SECTOR_SIZE}xDeviceCharacteristics(t){return SQLITE_IOCAP_BATCH_ATOMIC|SQLITE_IOCAP_SAFE_APPEND|SQLITE_IOCAP_SEQUENTIAL|SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN}xFileControl(t,n,s){const a=i(this,Je).get(t);switch(log$1(`xFileControl ${a.path} ${n}`),n){case 11:return a.overwrite=!0,SQLITE_OK;case 21:if(a.overwrite)try{return this.handleAsync(async()=>(await ie(this,ai,Oo).call(this,a),SQLITE_OK))}catch(c){return console.error(c),SQLITE_IOERR}return SQLITE_OK;case 22:return a.overwrite=!1,SQLITE_OK;case 31:return this.handleAsync(async()=>{try{return a.block0.version--,a.changedPages=new Set,i(this,Ce).run("readwrite",async({blocks:c})=>{const d=await c.index("version").getAllKeys(IDBKeyRange.bound([a.path],[a.path,a.block0.version]));for(const h of d)c.delete(h)}),SQLITE_OK}catch(c){return console.error(c),SQLITE_IOERR}});case 32:try{const c=Object.assign({},a.block0);c.data=c.data.slice();const d=a.changedPages;return a.changedPages=null,i(this,Ce).run("readwrite",async({blocks:h})=>{h.put(c);const p=await h.get([a.path,"purge",0])??{path:a.path,offset:"purge",version:0,data:new Map,count:0};p.count+=d.size;for(const N of d)p.data.set(N,c.version);h.put(p),ie(this,oi,_o).call(this,a.path,p.count)}),SQLITE_OK}catch(c){return console.error(c),SQLITE_IOERR}case 33:return this.handleAsync(async()=>{try{return a.changedPages=null,a.block0=await i(this,Ce).run("readonly",({blocks:c})=>c.get([a.path,0,a.block0.version+1])),SQLITE_OK}catch(c){return console.error(c),SQLITE_IOERR}});default:return SQLITE_NOTFOUND}}xAccess(t,n,s){return this.handleAsync(async()=>{try{const a=new URL(t,"file://localhost/").pathname;log$1(`xAccess ${a} ${n}`);const c=await i(this,Ce).run("readonly",({blocks:d})=>d.getKey(ie(this,Ht,pr).call(this,{path:a},0)));return s.setInt32(0,c?1:0,!0),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}})}xDelete(t,n){return this.handleAsync(async()=>{const s=new URL(t,"file://localhost/").pathname;try{return i(this,Ce).run("readwrite",({blocks:a})=>a.delete(IDBKeyRange.bound([s],[s,[]]))),n&&await i(this,Ce).sync(),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}})}async purge(t){const n=Date.now();await i(this,Ce).run("readwrite",async({blocks:s})=>{const a=await s.get([t,"purge",0]);if(a){for(const[c,d]of a.data)s.delete(IDBKeyRange.bound([t,c,d],[t,c,1/0],!0,!1));await s.delete([t,"purge",0])}log$1(`purge ${t} ${(a==null?void 0:a.data.size)??0} pages in ${Date.now()-n} ms`)})}}Vt=new WeakMap,Je=new WeakMap,Ce=new WeakMap,lr=new WeakMap,oi=new WeakSet,_o=function(t,n){i(this,Vt).purge==="manual"||i(this,lr).has(t)||n<i(this,Vt).purgeAtLeast||(globalThis.requestIdleCallback?globalThis.requestIdleCallback(()=>{this.purge(t),i(this,lr).delete(t)}):setTimeout(()=>{this.purge(t),i(this,lr).delete(t)}),i(this,lr).add(t))},Ht=new WeakSet,pr=function(t,n,s=0){const a=!n||-n<t.block0.data.length?-1/0:t.block0.version;return IDBKeyRange.bound([t.path,n,a],[t.path,s,1/0])},ai=new WeakSet,Oo=async function(t){const n=t.block0.data.length;if(n<18)return;const s=new DataView(t.block0.data.buffer,t.block0.data.byteOffset);let a=s.getUint16(16);if(a===1&&(a=65536),a===n)return;const c=Math.max(n,a),d=c/n,h=c/a,N=s.getUint32(28)*a,O=t.block0.version;await i(this,Ce).run("readwrite",async({blocks:A})=>{const R=await A.index("version").getAllKeys(IDBKeyRange.bound([t.path,O+1],[t.path,1/0]));for(const x of R)A.delete(x);A.delete([t.path,"purge",0]);for(let x=0;x<N;x+=c){const m=await A.getAll(IDBKeyRange.lowerBound([t.path,-(x+c),1/0]),d);for(const w of m)A.delete([w.path,w.offset,w.version]);if(h===1){const w=new Uint8Array(a);for(const _ of m)w.set(_.data,-(x+_.offset));const y={path:t.path,offset:-x,version:O,data:w};y.offset===0&&(y.fileSize=N,t.block0=y),A.put(y)}else{const w=m[0];for(let y=0;y<h;++y){const _=-(x+y*a);if(-_>=N)break;const g={path:w.path,offset:_,version:O,data:w.data.subarray(y*a,(y+1)*a)};g.offset===0&&(g.fileSize=N,t.block0=g),A.put(g)}}}})};function openDatabase(r){return new Promise((e,t)=>{const n=globalThis.indexedDB.open(r,5);n.addEventListener("upgradeneeded",function(){n.result.createObjectStore("blocks",{keyPath:["path","offset","version"]}).createIndex("version",["path","version"])}),n.addEventListener("success",()=>{e(n.result)}),n.addEventListener("error",()=>{t(n.error)})})}const E_CANCELED=new Error("request for lock canceled");var __awaiter$2=function(r,e,t,n){function s(a){return a instanceof t?a:new t(function(c){c(a)})}return new(t||(t=Promise))(function(a,c){function d(N){try{p(n.next(N))}catch(O){c(O)}}function h(N){try{p(n.throw(N))}catch(O){c(O)}}function p(N){N.done?a(N.value):s(N.value).then(d,h)}p((n=n.apply(r,e||[])).next())})};class Semaphore{constructor(e,t=E_CANCELED){this._value=e,this._cancelError=t,this._weightedQueues=[],this._weightedWaiters=[]}acquire(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((t,n)=>{this._weightedQueues[e-1]||(this._weightedQueues[e-1]=[]),this._weightedQueues[e-1].push({resolve:t,reject:n}),this._dispatch()})}runExclusive(e,t=1){return __awaiter$2(this,void 0,void 0,function*(){const[n,s]=yield this.acquire(t);try{return yield e(n)}finally{s()}})}waitForUnlock(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise(t=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),this._weightedWaiters[e-1].push(t),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatch()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatch()}cancel(){this._weightedQueues.forEach(e=>e.forEach(t=>t.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var e;for(let t=this._value;t>0;t--){const n=(e=this._weightedQueues[t-1])===null||e===void 0?void 0:e.shift();if(!n)continue;const s=this._value,a=t;this._value-=t,t=this._value+1,n.resolve([s,this._newReleaser(a)])}this._drainUnlockWaiters()}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){for(let e=this._value;e>0;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(t=>t()),this._weightedWaiters[e-1]=[])}}var __awaiter$1=function(r,e,t,n){function s(a){return a instanceof t?a:new t(function(c){c(a)})}return new(t||(t=Promise))(function(a,c){function d(N){try{p(n.next(N))}catch(O){c(O)}}function h(N){try{p(n.throw(N))}catch(O){c(O)}}function p(N){N.done?a(N.value):s(N.value).then(d,h)}p((n=n.apply(r,e||[])).next())})};class Mutex{constructor(e){this._semaphore=new Semaphore(1,e)}acquire(){return __awaiter$1(this,void 0,void 0,function*(){const[,e]=yield this._semaphore.acquire();return e})}runExclusive(e){return this._semaphore.runExclusive(()=>e())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}const isDebug=globalThis.__vlcn_wa_crsqlite_dbg;function log(...r){isDebug&&console.log("crsqlite-wasm: ",...r)}const re=/insert\s|update\s|delete\s/,txRe=/begin\s|commit\s|rollback\s|savepoint\s/;function computeCacheKey(r,e,t){const n=r.toLowerCase();if(txRe.exec(n)==null)return re.exec(n)!=null?(log("received write"),null):t!=null?n+"|"+e+"|"+t.map(a=>a!=null?a.toString():"null").join("|"):n}class Stmt{constructor(e,t,n,s,a,c,d){ce(this,"originDB");ce(this,"cache");ce(this,"api");ce(this,"base");ce(this,"str");ce(this,"sql");ce(this,"mode","o");ce(this,"finalized",!1);ce(this,"bindings",[]);this.originDB=e,this.cache=n,this.api=s,this.base=a,this.str=c,this.sql=d,t.set(a,new WeakRef(this))}run(e,...t){return serialize(this.cache,computeCacheKey(this.sql,this.mode,t.length>0?t:this.bindings),()=>(t.length>0&&this.bind(t),this.api.step(this.base).then(()=>this.api.reset(this.base))),(e==null?void 0:e.__mutex)||this.originDB.__mutex)}get(e,...t){return serialize(this.cache,computeCacheKey(this.sql,this.mode,t.length>0?t:this.bindings),async()=>{t.length>0&&this.bind(t);let n=null,s=this.mode==="o"?this.api.column_names(this.base):null;if(await this.api.step(this.base)==SQLITE_ROW){const a=this.api.row(this.base);if(s!=null){const c={};for(let d=0;d<s.length;++d)c[s[d]]=a[d];n=c}else n=a}return await this.api.reset(this.base),n},(e==null?void 0:e.__mutex)||this.originDB.__mutex)}all(e,...t){return serialize(this.cache,computeCacheKey(this.sql,this.mode,t.length>0?t:this.bindings),async()=>{t.length>0&&this.bind(t);const n=[];let s=this.mode==="o"?this.api.column_names(this.base):null;for(;await this.api.step(this.base)==SQLITE_ROW;)if(s!=null){const a={};for(let c=0;c<s.length;++c)a[s[c]]=this.api.column(this.base,c);n.push(a)}else{n.push(this.api.row(this.base));continue}return await this.api.reset(this.base),n},(e==null?void 0:e.__mutex)||this.originDB.__mutex)}async*iterate(e,...t){for(this.bind(t);await serialize(this.cache,void 0,()=>this.api.step(this.base),(e==null?void 0:e.__mutex)||this.originDB.__mutex)==SQLITE_ROW;)yield this.api.row(this.base);await serialize(this.cache,void 0,()=>this.api.reset(this.base),(e==null?void 0:e.__mutex)||this.originDB.__mutex)}raw(e){return e?this.mode="a":this.mode="o",this}bind(e){this.bindings=e;for(let t=0;t<e.length;++t)this.api.bind(this.base,t+1,e[t]);return this}finalize(e){return serialize(this.cache,void 0,()=>{if(!this.finalized)return this.finalized=!0,this.api.str_finish(this.str),this.api.finalize(this.base)},(e==null?void 0:e.__mutex)||this.originDB.__mutex)}}class TX{constructor(e,t,n,s,a){ce(this,"api");ce(this,"db");ce(this,"__mutex");ce(this,"assertOpen");ce(this,"stmtFinalizer");ce(this,"cache",new Map);this.api=e,this.db=t,this.__mutex=n,this.assertOpen=s,this.stmtFinalizer=a}execMany(e){return this.assertOpen(),serialize(this.cache,null,()=>this.api.exec(this.db,e.join("")),this.__mutex)}exec(e,t){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"a",t),()=>this.statements(e,!1,t),this.__mutex)}execO(e,t){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"o",t),()=>this.statements(e,!0,t),this.__mutex)}execA(e,t){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"a",t),()=>this.statements(e,!1,t),this.__mutex)}prepare(e){return this.assertOpen(),serialize(this.cache,void 0,async()=>{const t=this.api.str_new(this.db,e),n=await this.api.prepare_v2(this.db,this.api.str_value(t));if(n==null)throw this.api.str_finish(t),new Error(`Could not prepare ${e}`);return new Stmt(this,this.stmtFinalizer,this.cache,this.api,n.stmt,t,e)},this.__mutex)}tx(e){return this.assertOpen(),serializeTx(async t=>{await t.exec("SAVEPOINT crsql_transaction");try{await e(t)}catch(n){throw await t.exec("ROLLBACK"),n}await t.exec("RELEASE crsql_transaction")},this.__mutex,this)}imperativeTx(){return this.__mutex.acquire().then(e=>{const t=new Mutex;return[e,new TX(this.api,this.db,t,this.assertOpen,this.stmtFinalizer)]})}async statements(e,t,n){const s=[],a=this.api.str_new(this.db,e);let c={stmt:null,sql:this.api.str_value(a)};try{for(;c=await this.api.prepare_v2(this.db,c.sql);){const p=c.stmt,N=[],O=this.api.column_names(p);for(n&&this.bind(p,n);await this.api.step(p)===SQLITE_ROW;){const A=this.api.row(p);N.push(A)}O.length&&s.push({columns:O,rows:N}),this.api.finalize(c.stmt),c.stmt=null}}finally{c!=null&&c.stmt&&this.api.finalize(c.stmt),this.api.str_finish(a)}const d=s[0];if(d==null)return null;if(!t)return d.rows;const h=[];for(const p of d.rows){const N={};for(let O=0;O<d.columns.length;++O)N[d.columns[O]]=p[O];h.push(N)}return h}bind(e,t){for(let n=0;n<t.length;++n){const s=t[n];this.api.bind(e,n+1,typeof s=="boolean"?s&&1||0:s)}}}const topLevelMutex=new Mutex;topLevelMutex.name="topLevelMutex";function serialize(r,e,t,n){if(e===null)log("Cache clear"),r==null||r.clear();else if(e!==void 0){const a=r==null?void 0:r.get(e);if(a)return log("Cache hit",e),a}log("Enqueueing query ",e);const s=n.runExclusive(t);return e&&(r==null||r.set(e,s),s.finally(()=>r==null?void 0:r.delete(e)).catch(a=>{console.error(a)})),s}function serializeTx(r,e,t){return e.runExclusive(()=>{const n=new Mutex,s=new TX(t.api,t.db,n,t.assertOpen,t.stmtFinalizer);return r(s)})}function cryb64(r,e=0){let t=3735928559^e,n=1103547991^e;for(let s=0,a;s<r.length;s++)a=r.charCodeAt(s),t=Math.imul(t^a,2654435761),n=Math.imul(n^a,1597334677);return t=Math.imul(t^t>>>16,2246822507),t^=Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(t^t>>>13,3266489909),4294967296n*BigInt(n)+BigInt(t)}function firstPick(r){const e=r[0];if(e!=null)return e[Object.keys(e)[0]]}var Pr,kt,_n,Nt,On,ui;class DB{constructor(e,t,n){ce(this,"api");ce(this,"db");ce(this,"filename");ce(this,"__mutex",topLevelMutex);ce(this,"stmtFinalizer",new Map);T(this,Pr,null);ce(this,"cache",new Map);T(this,kt,null);T(this,_n,!1);T(this,Nt,void 0);T(this,On,()=>{if(i(this,_n))throw new Error("The DB is closed")});T(this,ui,(e,t,n,s)=>{i(this,kt)!=null&&i(this,kt).forEach(a=>{try{a(e,t,n,s)}catch(c){console.error("Failed notifying a DB update listener"),console.error(c)}})});this.api=e,this.db=t,this.filename=n,k(this,Nt,new TX(e,t,topLevelMutex,i(this,On),this.stmtFinalizer))}get siteid(){return i(this,Pr)}_setSiteid(e){if(i(this,Pr))throw new Error("Site id already set");k(this,Pr,e)}async automigrateTo(e,t){const n=cryb64(t),s=firstPick(await this.execA("SELECT value FROM crsql_master WHERE key = 'schema_name'")),a=firstPick(await this.execA("SELECT value FROM crsql_master WHERE key = 'schema_version'"));if(s===e&&BigInt(a||0)===n)return"noop";const c=s===void 0||s!==e?"apply":"migrate";return await this.tx(async d=>{if(a==null||s!==e){if(s!==e){const h=await d.execA("SELECT name FROM sqlite_master WHERE type = 'table' AND name NOT LIKE '%crsql_%'");for(const p of h)await d.exec(`DROP TABLE [${p[0]}]`)}await d.exec(t)}else await d.exec("SELECT crsql_automigrate(?, 'SELECT crsql_finalize();')",[t]);await d.exec("INSERT OR REPLACE INTO crsql_master (key, value) VALUES (?, ?)",["schema_version",n]),await d.exec("INSERT OR REPLACE INTO crsql_master (key, value) VALUES (?, ?)",["schema_name",e])}),await this.exec("VACUUM;"),c}execMany(e){return i(this,Nt).execMany(e)}exec(e,t){return i(this,Nt).exec(e,t)}execO(e,t){return i(this,Nt).execO(e,t)}execA(e,t){return i(this,Nt).execA(e,t)}prepare(e){return i(this,Nt).prepare(e)}tx(e){return i(this,Nt).tx(e)}imperativeTx(){return i(this,Nt).imperativeTx()}async close(){for(const e of this.stmtFinalizer.values()){const t=e.deref();t&&await t.finalize(this)}return this.exec("SELECT crsql_finalize()").then(()=>(k(this,_n,!0),serialize(this.cache,void 0,()=>this.api.close(this.db),this.__mutex)))}createFunction(e,t,n){i(this,On).call(this),this.api.create_function(this.db,e,t.length,SQLITE_UTF8,0,(s,a)=>{const c=[];for(let h=0;h<t.length;++h)c.push(this.api.value(a[h]));const d=t(...c);d!==void 0&&this.api.result(s,d)})}onUpdate(e){return i(this,kt)==null&&(this.api.update_hook(this.db,i(this,ui)),k(this,kt,new Set)),i(this,kt).add(e),()=>{var t;return(t=i(this,kt))==null?void 0:t.delete(e)}}}Pr=new WeakMap,kt=new WeakMap,_n=new WeakMap,Nt=new WeakMap,On=new WeakMap,ui=new WeakMap;let api=null;class SQLite3{constructor(e){ce(this,"base");this.base=e}open(e,t="c"){return serialize(null,void 0,()=>this.base.open_v2(e||":memory:",SQLITE_OPEN_CREATE|SQLITE_OPEN_READWRITE|SQLITE_OPEN_URI,e!=null?"idb-batch-atomic":void 0),topLevelMutex).then(n=>{const s=new DB(this.base,n,e||":memory:");return s.execA("select quote(crsql_siteid());").then(a=>(s._setSiteid(a[0][0].replace(/'|X/g,"")),s))})}}async function initWasm(r){if(api!=null)return api;const e=await SQLiteAsyncESMFactory({locateFile(n){return r?r(n):new URL(""+new URL("../assets/crsqlite.0980e00c.wasm",import.meta.url).href,self.location).href}}),t=Factory(e);return t.vfs_register(new IDBBatchAtomicVFS("idb-batch-atomic",{durability:"relaxed"})),api=new SQLite3(t),api}async function load(r,e){return{database:await(await initWasm(()=>e.wasm||wasmUrl)).open(r),browser:!0}}const connections$1=new Map,defaultPaths={};async function init(r,e,t=defaultPaths){if(connections$1.has(r))return connections$1.get(r);const{database:n,browser:s}=await load(r,t),a=s?CRDialect:SqliteDialect,c=new Kysely({dialect:new a({database:n}),plugins:[new JSONPlugin]}),d=c.destroy.bind(c);await c.transaction().execute(p=>apply(p,e));const h=Object.assign(c,{resolveChanges,applyOperation,insertChanges,updateVersion,selectVersion,selectClient,changesSince,async destroy(){return connections$1.delete(r),await finalize.bind(c)().execute(),d()}});return connections$1.set(r,h),h}const raf=globalThis.requestAnimationFrame||globalThis.setTimeout,error=Symbol("error");function queue(r,e){const t=new Map;let n;async function s(){return n||(n=new Promise(a=>raf(async()=>{const c=await r,d=new Map;await c.transaction().execute(async h=>{const p=e&&(await selectVersion.bind(h)().execute()).current;for(const[N,O]of t.entries()){const A=await O(h).catch(R=>({[error]:R}));d.set(N,A)}e==null||e(await changesSince.bind(h)(p).execute())}),t.clear(),n=void 0,a(d)})))}return{enqueue(a,c,...d){return t.set(a,h=>c(h,...d)),s().then(h=>h.get(a)).then(h=>{if(h&&typeof h=="object"&&error in h)throw h[error];return h})}}}const empty=[],ready=r=>r!==empty;function database(r,{ssr:e=!1,name:t="crstore.db",paths:n=defaultPaths,error:s=void 0,push:a=void 0,pull:c=void 0,online:d=()=>{var h;return!!((h=globalThis.navigator)!=null&&h.onLine)}}={}){var le;const p=!e&&!1?new Promise(()=>{}):init(t,r,n),N="BroadcastChannel"in globalThis?new globalThis.BroadcastChannel(`${t}-sync`):null,O=Q=>X(Q.data,Q.data[0]),A=queue(p,X),R=queue(p);N==null||N.addEventListener("message",O),(le=globalThis.addEventListener)==null||le.call(globalThis,"online",g);const x=new Map;let m=()=>{};g();async function w(Q,U){return R.enqueue(U,P=>P.getExecutor().executeQuery(Q,U)).then(P=>P.rows)}function y(Q,U,P){const V=async(te,ne)=>{try{if(P&&P.client===ne)return;await U(te,ne)}catch(B){s==null||s(B)}};return Q.forEach(te=>{var ne;x.has(te)||x.set(te,new Set),(ne=x.get(te))==null||ne.add(V)}),P?p.then(async te=>{const ne=await te.changesSince(P.version,P.client).execute();ne.length&&V(ne)}):V([]),()=>Q.forEach(te=>{var ne;return(ne=x.get(te))==null?void 0:ne.delete(V)})}async function _(){if(!a||!d())return;const Q=await p,{current:U,synced:P}=await Q.selectVersion().execute();if(U<=P)return;const V=await Q.changesSince(P,null).execute();await a(V),await Q.updateVersion(U).execute()}async function g(){var V,te;if((V=globalThis.removeEventListener)==null||V.call(globalThis,"offline",m),m(),!c||!d())return;const Q=await p,{synced:U}=await Q.selectVersion().execute(),P=await Q.selectClient().execute();await _(),m=c({version:U,client:P},{async onData(ne){ne.length&&(await Q.insertChanges(ne).execute(),await X(ne,ne[0]))}}).unsubscribe,(te=globalThis.addEventListener)==null||te.call(globalThis,"offline",m)}async function W(Q,...U){return A.enqueue({},Q,...U)}async function z(Q){if(!Q.length)return;const U=await p;await X(await U.resolveChanges(Q).execute(),Q[0])}async function X(Q,U){var ne;if(!Q.length)return;const P=new Set,V=affectedTables(Q);(ne=x.get("*"))==null||ne.forEach(B=>P.add(B)),V.forEach(B=>{var G;return(G=x.get(B))==null?void 0:G.forEach(ae=>P.add(ae))});const te=[...P].map(B=>B(Q,U));U||(N==null||N.postMessage(Q),await _()),await Promise.all(te)}async function Z(){var Q,U;m(),N==null||N.close(),x.clear(),(Q=globalThis.removeEventListener)==null||Q.call(globalThis,"online",g),(U=globalThis.removeEventListener)==null||U.call(globalThis,"offline",m),N==null||N.removeEventListener("message",O),await p.then(P=>P.destroy())}const j=Object.assign(store.bind({connection:p,subscribe:y,update:W,refresh:w},[]),{with:(...Q)=>store.bind({connection:p,subscribe:y,update:W,refresh:w},Q)});return{close:Z,merge:z,update:W,subscribe:y,connection:p,store:j}}function store(r,e,t={}){const{connection:n,update:s,refresh:a}=this,c=derived(r,R=>R);let d=null,h=null;const{subscribe:p,set:N}=writable(empty,()=>{let R=()=>{};return n.then(x=>{if(!R)return;let m=()=>{};const w=c.subscribe(y=>{const _=e(x,...y).toOperationNode(),g=affectedTables(_),W=x.getExecutor();h={queryId:Math.random().toString(36).slice(2)},d=W.compileQuery(W.transformQuery(_,h),h),m(),m=this.subscribe(g,O)});R=()=>(w(),m())}),()=>(R==null||R(),R=null)});async function O(){await n,!(!d||!h)&&N(await a(d,h))}const A={};for(const R in t)A[R]=(...x)=>s(t[R],...x);return{...A,set:N,subscribe:p,update(R,...x){return R?s(R,...x):O()},then(R,x){let m=[];const w=p(y=>m=y);return O().then(()=>(w(),R(m)),x)}}}const APPEND=1,source=r=>r.selectFrom(e=>e.selectFrom("sources").select(["owner","source"]).orderBy("sources.primary","desc").as("ordered")).select(["owner",e=>group(e,"source").as("sources")]).groupBy("owner").$castTo(),asset=r=>r.selectFrom(e=>e.selectFrom("assets").select(["owner","art","thumbnail"]).orderBy("assets.primary","desc").as("ordered")).select(["owner",e=>group(e,"art").as("arts"),e=>group(e,"thumbnail").as("thumbnails")]).groupBy("owner").$castTo(),artist$1=r=>r.selectFrom("artists").leftJoin("source","source.owner","artists.id").leftJoin("asset","asset.owner","artists.id").select(["artists.id","artists.title","artists.following",e=>e.fn.coalesce("asset.arts",e.val("[]")).as("arts"),e=>e.fn.coalesce("asset.thumbnails",e.val("[]")).as("thumbnails"),e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources")]).$castTo(),album$1=r=>r.selectFrom("albums").leftJoin("source","source.owner","albums.id").leftJoin("asset","asset.owner","albums.id").leftJoin("attribution","attribution.album","albums.id").innerJoin("artist","artist.id","attribution.artist").select(["albums.id","albums.title","albums.year",e=>e.fn.coalesce("asset.arts",e.val("[]")).as("arts"),e=>e.fn.coalesce("asset.thumbnails",e.val("[]")).as("thumbnails"),e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources"),e=>groupJSON(e,{id:"artist.id",title:"artist.title",arts:"artist.arts",thumbnails:"artist.thumbnails",sources:"artist.sources"}).filterWhere("artist.id","is not",null).as("artists")]).groupBy("albums.id").$castTo(),track$2=r=>r.selectFrom("tracks").leftJoin("source","source.owner","tracks.id").innerJoin("album","album.id","tracks.album").select(["tracks.id","tracks.title","tracks.duration","album.artists",e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources"),e=>json(e,{id:"album.id",title:"album.title",year:"album.year",arts:"album.arts",thumbnails:"album.thumbnails",sources:"album.sources"}).as("album")]).$castTo(),localDevice=sql`crsql_siteid()`,uuid=()=>Math.random()*2**32>>>0,sanitize=r=>r.replace(/-/g," ").split(/\s+/g).map(e=>`"${e.replace(/"/g,'""')}"`).join(" "),position={first:null,before:r=>r.selectFrom("queue").select("id").where("position","=",1).limit(1),shift:r=>e=>e.selectFrom("queue").select("id").whereRef(t=>t.selectFrom("queue").select(sql`position + 1`.as("position")).where("id","=",r),"=","position").limit(1),next:r=>r.selectFrom("devices").select("playback").where("id","=",localDevice).limit(1),last:r=>r.selectFrom("playback").select("id").where("device","=",localDevice).orderBy("order","desc").orderBy("id","desc").limit(1),random:r=>e=>e.selectFrom(t=>t.selectFrom("queue").select(["id","position"]).$if(!!r.length,n=>n.unionAll(sql`VALUES ${sql.raw(r.map(s=>`(${s}, 1)`).join(","))}`)).unionAll(sql`SELECT null,1 WHERE NOT EXISTS (SELECT 1 FROM queue WHERE position >= 0)`).as("data")).select("id").where("position",">=",0).orderBy(sql`random()`).limit(1)};async function pushTracks(r,e){e.length&&(await pushAlbums(r,e.map(t=>({...t.album,artists:t.artists}))),await r.insertInto("tracks").onConflict(t=>t.doNothing()).values(e.map(t=>({id:t.id,title:t.title,duration:t.duration,album:t.album.id}))).execute(),await pushResources(r,e))}async function pushAlbums(r,e){e.length&&(await pushArtists(r,e.flatMap(t=>t.artists)),e.find(t=>t.artists.length)&&await r.insertInto("attribution").onConflict(t=>t.doNothing()).values(e.flatMap(t=>t.artists.map(({id:n})=>({album:t.id,artist:n})))).execute(),await r.insertInto("albums").onConflict(t=>t.doNothing()).values(e.map(t=>({id:t.id,title:t.title,year:t.year}))).execute(),await pushResources(r,e))}async function pushArtists(r,e){e.length&&(await r.insertInto("artists").onConflict(t=>t.doNothing()).values(e.map(t=>({id:t.id,title:t.title,following:0}))).execute(),await pushResources(r,e))}async function pushResources(r,e){e.length&&(e.find(t=>t.sources.length)&&await r.insertInto("sources").onConflict(t=>t.doNothing()).values(e.flatMap(({id:t,sources:n})=>n.map((s,a)=>({owner:t,source:s,primary:+!a&&sql`NOT EXISTS (SELECT 1 FROM sources WHERE owner = ${t} AND "primary" = 1)`})))).execute(),e.find(t=>{var n;return(n=t.arts)==null?void 0:n.length})&&await r.insertInto("assets").onConflict(t=>t.doNothing()).values(e.flatMap(({id:t,arts:n,thumbnails:s})=>{if(!n)return[];const a=n.find((c,d)=>!!(s!=null&&s[d]))||n[0];return n.map((c,d)=>({owner:t,art:c,thumbnail:s==null?void 0:s[d],primary:+(c===a)&&sql`NOT EXISTS (SELECT 1 FROM assets WHERE owner = ${t} AND "primary" = 1)`}))})).execute())}const preceding$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).with("update",t=>t.selectFrom("playback").select(n=>n.selectFrom("devices").select("id").as("_"))).selectFrom("queue").innerJoin("track","track.id","queue.track").where("position","<",0).select("queue.id as entry").select(fields).$castTo()),upcoming$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).with("update",t=>t.selectFrom("playback").select(n=>n.selectFrom("devices").select("id").as("_"))).selectFrom("queue").innerJoin("track","track.id","queue.track").where("position",">",0).select("queue.id as entry").select(fields).$castTo()),playback$2=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("devices").innerJoin("playback","playback.id","devices.playback").innerJoin("track","track.id","playback.track").select(["direction","repeat","infinite","device","progress"]).select(t=>json(t,{entry:"playback.id",id:"track.id",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).as("track")).select(sql`device = crsql_siteid()`.as("local")).select(fields).$castTo(),{async push(e,t,n="next"){if(!t.length)return;await pushTracks(e,t);const{direction:s,playback:a}=await e.selectFrom("devices").where("id","=",localDevice).select(["direction","playback"]).executeTakeFirstOrThrow(),c=t.map(uuid),d=s!=1?Number.isInteger(n)?n:n==="first"?position.first:n==="next"?position.next:position.last:Number.isInteger(n)?position.shift(+n):n==="first"?position.last:n==="next"?position.before:position.first;await e.insertInto("playback_fractindex").values(t.map((h,p)=>({id:c[p],track:h.id,device:localDevice,after_id:n==="random"?position.random(c.slice(0,p)):p>0&&s!=1?c[p-1]:d}))).execute(),!~a&&n==="random"&&await e.updateTable("devices").set({playback:h=>h.selectFrom("queue").select("id").$castTo().limit(1)}).execute()},async purge(e,t){t.length&&await e.deleteFrom("playback").where("id","in",t).execute()},async clear(e,t=localDevice){await e.deleteFrom("playback").where("device","=",t).execute(),await e.updateTable("devices").set({playback:-1,progress:0}).where("id","=",t).execute()},async sync(e,t){await e.updateTable("devices").where("id","=",localDevice).set({progress:t}).execute()},async rearrange(e,t,n=null){const{direction:s}=await e.selectFrom("devices").where("id","=",localDevice).select(["direction"]).executeTakeFirstOrThrow(),a=s!=1?n:n!=null?position.shift(n):position.last;await e.updateTable("playback_fractindex").set({after_id:a}).where("id","=",t).execute()},async redirect(e,t){const n=["forward","backward","shuffled"],{direction:s}=await e.selectFrom("devices").select("direction").where("id","=",localDevice).executeTakeFirstOrThrow(),a=n.indexOf(t);s!==a&&await e.updateTable("devices").set({direction:a}).where("id","=",localDevice).execute()},async repeat(e,t){const n=["none","single","all"];await e.updateTable("devices").set({repeat:n.indexOf(t)}).where("id","=",localDevice).execute()},async infinite(e,t){await e.updateTable("devices").set({infinite:t==null?sql`!infinite`:+t}).where("id","=",localDevice).execute()},async replicate(e,t){const n=uuid();await e.updateTable("devices").where("id","=",localDevice).set({playback:n,progress:s=>s.selectFrom("devices").where("id","=",t).select("progress")}).execute(),await e.deleteFrom("playback").where("device","=",localDevice).execute(),await e.insertInto("playback").expression(s=>s.selectFrom("playback").select(a=>a.case().when(c=>c.selectFrom("devices").whereRef("id","=","playback.device").select("devices.playback"),"=",a.ref("playback.id")).then(n).else(sql`ABS(RANDOM() % 4294967296)`).end().as("id")).select(sql`${localDevice}`.as("device")).select(["track","order","temp"]).where("device","=",t)).execute()}}),fields=["track.id","track.title","track.duration","track.album","track.artists","track.sources"];class StructError extends TypeError{constructor(e,t){let n;const{message:s,explanation:a,...c}=e,{path:d}=e,h=d.length===0?s:`At path: ${d.join(".")} -- ${s}`;super(a??h),a!=null&&(this.cause=h),Object.assign(this,c),this.name=this.constructor.name,this.failures=()=>n??(n=[e,...t()])}}function isIterable(r){return isObject$1(r)&&typeof r[Symbol.iterator]=="function"}function isObject$1(r){return typeof r=="object"&&r!=null}function print(r){return typeof r=="symbol"?r.toString():typeof r=="string"?JSON.stringify(r):`${r}`}function shiftIterator(r){const{done:e,value:t}=r.next();return e?void 0:t}function toFailure(r,e,t,n){if(r===!0)return;r===!1?r={}:typeof r=="string"&&(r={message:r});const{path:s,branch:a}=e,{type:c}=t,{refinement:d,message:h=`Expected a value of type \`${c}\`${d?` with refinement \`${d}\``:""}, but received: \`${print(n)}\``}=r;return{value:n,type:c,refinement:d,key:s[s.length-1],path:s,branch:a,...r,message:h}}function*toFailures(r,e,t,n){isIterable(r)||(r=[r]);for(const s of r){const a=toFailure(s,e,t,n);a&&(yield a)}}function*run(r,e,t={}){const{path:n=[],branch:s=[r],coerce:a=!1,mask:c=!1}=t,d={path:n,branch:s};if(a&&(r=e.coercer(r,d),c&&e.type!=="type"&&isObject$1(e.schema)&&isObject$1(r)&&!Array.isArray(r)))for(const p in r)e.schema[p]===void 0&&delete r[p];let h="valid";for(const p of e.validator(r,d))p.explanation=t.message,h="not_valid",yield[p,void 0];for(let[p,N,O]of e.entries(r,d)){const A=run(N,O,{path:p===void 0?n:[...n,p],branch:p===void 0?s:[...s,N],coerce:a,mask:c,message:t.message});for(const R of A)R[0]?(h=R[0].refinement!=null?"not_refined":"not_valid",yield[R[0],void 0]):a&&(N=R[1],p===void 0?r=N:r instanceof Map?r.set(p,N):r instanceof Set?r.add(N):isObject$1(r)&&(N!==void 0||p in r)&&(r[p]=N))}if(h!=="not_valid")for(const p of e.refiner(r,d))p.explanation=t.message,h="not_refined",yield[p,void 0];h==="valid"&&(yield[void 0,r])}class Struct{constructor(e){const{type:t,schema:n,validator:s,refiner:a,coercer:c=h=>h,entries:d=function*(){}}=e;this.type=t,this.schema=n,this.entries=d,this.coercer=c,s?this.validator=(h,p)=>{const N=s(h,p);return toFailures(N,p,this,h)}:this.validator=()=>[],a?this.refiner=(h,p)=>{const N=a(h,p);return toFailures(N,p,this,h)}:this.refiner=()=>[]}assert(e,t){return assert(e,this,t)}create(e,t){return create(e,this,t)}is(e){return is(e,this)}mask(e,t){return mask(e,this,t)}validate(e,t={}){return validate(e,this,t)}}function assert(r,e,t){const n=validate(r,e,{message:t});if(n[0])throw n[0]}function create(r,e,t){const n=validate(r,e,{coerce:!0,message:t});if(n[0])throw n[0];return n[1]}function mask(r,e,t){const n=validate(r,e,{coerce:!0,mask:!0,message:t});if(n[0])throw n[0];return n[1]}function is(r,e){return!validate(r,e)[0]}function validate(r,e,t={}){const n=run(r,e,t),s=shiftIterator(n);return s[0]?[new StructError(s[0],function*(){for(const c of n)c[0]&&(yield c[0])}),void 0]:[void 0,s[1]]}function assign(...r){const e=r[0].type==="type",t=r.map(s=>s.schema),n=Object.assign({},...t);return e?type(n):object(n)}function define(r,e){return new Struct({type:r,schema:null,validator:e})}function omit(r,e){const{schema:t}=r,n={...t};for(const s of e)delete n[s];switch(r.type){case"type":return type(n);default:return object(n)}}function any(){return define("any",()=>!0)}function array(r){return new Struct({type:"array",schema:r,*entries(e){if(r&&Array.isArray(e))for(const[t,n]of e.entries())yield[t,n,r]},coercer(e){return Array.isArray(e)?e.slice():e},validator(e){return Array.isArray(e)||`Expected an array value, but received: ${print(e)}`}})}function instance$1(r){return define("instance",e=>e instanceof r||`Expected a \`${r.name}\` instance, but received: ${print(e)}`)}function integer(){return define("integer",r=>typeof r=="number"&&!isNaN(r)&&Number.isInteger(r)||`Expected an integer, but received: ${print(r)}`)}function literal(r){const e=print(r),t=typeof r;return new Struct({type:"literal",schema:t==="string"||t==="number"||t==="boolean"?r:null,validator(n){return n===r||`Expected the literal \`${e}\`, but received: ${print(n)}`}})}function never(){return define("never",()=>!1)}function nullable(r){return new Struct({...r,validator:(e,t)=>e===null||r.validator(e,t),refiner:(e,t)=>e===null||r.refiner(e,t)})}function number(){return define("number",r=>typeof r=="number"&&!isNaN(r)||`Expected a number, but received: ${print(r)}`)}function object(r){const e=r?Object.keys(r):[],t=never();return new Struct({type:"object",schema:r||null,*entries(n){if(r&&isObject$1(n)){const s=new Set(Object.keys(n));for(const a of e)s.delete(a),yield[a,n[a],r[a]];for(const a of s)yield[a,n[a],t]}},validator(n){return isObject$1(n)||`Expected an object, but received: ${print(n)}`},coercer(n){return isObject$1(n)?{...n}:n}})}function optional(r){return new Struct({...r,validator:(e,t)=>e===void 0||r.validator(e,t),refiner:(e,t)=>e===void 0||r.refiner(e,t)})}function string(){return define("string",r=>typeof r=="string"||`Expected a string, but received: ${print(r)}`)}function type(r){const e=Object.keys(r);return new Struct({type:"type",schema:r,*entries(t){if(isObject$1(t))for(const n of e)yield[n,t[n],r[n]]},validator(t){return isObject$1(t)||`Expected an object, but received: ${print(t)}`},coercer(t){return isObject$1(t)?{...t}:t}})}function union(r){const e=r.map(t=>t.type).join(" | ");return new Struct({type:"union",schema:null,coercer(t){for(const n of r){const[s,a]=n.validate(t,{coerce:!0});if(!s)return a}return t},validator(t,n){const s=[];for(const a of r){const[...c]=run(t,a,n),[d]=c;if(d[0])for(const[h]of c)h&&s.push(h);else return[]}return[`Expected the value to satisfy a union of \`${e}\`, but received: ${print(t)}`,...s]}})}const track$1=object({title:string(),duration:number()}),album=object({title:string(),year:integer()}),artist=object({title:string()}),playlist=object({title:string(),relevancy:number(),shared:nullable(string()),remote:nullable(string())});type({title:optional(string()),album:optional(type({title:optional(string())})),artists:optional(array(type({title:optional(string())})))});const media=object({sources:array(string()),arts:optional(array(string())),thumbnails:optional(array(nullable(string())))}),collection=r=>object({size:integer(),duration:number(),tracks:array(r)}),unique=r=>assign(r,object({id:integer()})),artistInfo=assign(artist,media),albumInfo=assign(album,assign(media,object({artists:array(artistInfo)}))),trackInfo=assign(track$1,assign(omit(media,["arts","thumbnails"]),object({album:omit(albumInfo,["artists"]),artists:array(artistInfo)}))),playlistInfo=playlist,track=assign(unique(trackInfo),object({entry:optional(number()),album:unique(trackInfo.schema.album),artists:array(unique(trackInfo.schema.artists.schema))}));assign(unique(albumInfo),object({artists:array(unique(albumInfo.schema.artists.schema)),collection:optional(collection(track))}));assign(unique(artistInfo),object({following:optional(union([literal(0),literal(1)])),collection:optional(collection(track))}));assign(unique(playlistInfo),object({collection:optional(collection(track))}));function has(r,e){return r!==null&&typeof r=="object"&&e in r&&r[e]!==void 0}function getDefaultExportFromCjs(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var murmurhash={exports:{}};(function(r){(function(){const e=a=>new TextEncoder().encode(a);function t(a,c){typeof a=="string"&&(a=e(a));let d=a.length,h=c^d,p=0,N;for(;d>=4;)N=a[p]&255|(a[++p]&255)<<8|(a[++p]&255)<<16|(a[++p]&255)<<24,N=(N&65535)*1540483477+(((N>>>16)*1540483477&65535)<<16),N^=N>>>24,N=(N&65535)*1540483477+(((N>>>16)*1540483477&65535)<<16),h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)^N,d-=4,++p;switch(d){case 3:h^=(a[p+2]&255)<<16;case 2:h^=(a[p+1]&255)<<8;case 1:h^=a[p]&255,h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)}return h^=h>>>13,h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16),h^=h>>>15,h>>>0}function n(a,c){typeof a=="string"&&(a=e(a));let d,h,p,N,O,A,R,x;for(d=a.length&3,h=a.length-d,p=c,O=3432918353,A=461845907,x=0;x<h;)R=a[x]&255|(a[++x]&255)<<8|(a[++x]&255)<<16|(a[++x]&255)<<24,++x,R=(R&65535)*O+(((R>>>16)*O&65535)<<16)&4294967295,R=R<<15|R>>>17,R=(R&65535)*A+(((R>>>16)*A&65535)<<16)&4294967295,p^=R,p=p<<13|p>>>19,N=(p&65535)*5+(((p>>>16)*5&65535)<<16)&4294967295,p=(N&65535)+27492+(((N>>>16)+58964&65535)<<16);switch(R=0,d){case 3:R^=(a[x+2]&255)<<16;case 2:R^=(a[x+1]&255)<<8;case 1:R^=a[x]&255,R=(R&65535)*O+(((R>>>16)*O&65535)<<16)&4294967295,R=R<<15|R>>>17,R=(R&65535)*A+(((R>>>16)*A&65535)<<16)&4294967295,p^=R}return p^=a.length,p^=p>>>16,p=(p&65535)*2246822507+(((p>>>16)*2246822507&65535)<<16)&4294967295,p^=p>>>13,p=(p&65535)*3266489909+(((p>>>16)*3266489909&65535)<<16)&4294967295,p^=p>>>16,p>>>0}const s=n;s.v2=t,s.v3=n,r.exports=s})()})(murmurhash);var murmurhashExports=murmurhash.exports;const hash=getDefaultExportFromCjs(murmurhashExports);function titled(r){return has(r,"title")?r.title:r}function compare$1(r,e){return typeof r=="string"&&typeof e=="string"?r.localeCompare(e):typeof r=="number"&&typeof e=="number"?r-e:has(r,"title")&&has(e,"title")?compare$1(clean(titled(r)),clean(titled(e))):0}function normalize(r){if(typeof r=="string")return clean(r);if(typeof r!="object")return r;const e={...r};for(const t in e)Array.isArray(e[t])?e[t]=e[t].map(normalize).sort(compare$1):e[t]=normalize(e[t]);return e}function stringify(r){return r=normalize(r),typeof r=="string"?r:typeof r!="object"?clean(String(r)):has(r,"artists")&&has(r,"title")&&has(r,"album")?`${r.artists.map(titled)} - ${r.title} - ${titled(r.album)}`:has(r,"artists")&&has(r,"title")?`${r.artists.map(titled)} - ${r.title}`:has(r,"title")?r.title:Array.isArray(r)?r.map(titled).toString():JSON.stringify(r)}function identify(r){return has(r,"id")?+r.id:hash(stringify(r))}const playlists$2=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",t=>track$2(t).innerJoin("library","library.track","tracks.id").select(["library.playlist","library.id as entry"]).orderBy("library.order").orderBy("library.id")).selectFrom("track").fullJoin("playlists","playlists.id","track.playlist").where("playlists.id",">=",0).select(["playlists.id","playlists.title","playlists.relevancy","playlists.shared","playlists.remote",t=>json(t,{size:t.fn.count("track.duration"),duration:t.fn.coalesce(t.fn.sum("track.duration"),t.val(0)),tracks:groupJSON(t,{id:"track.id",entry:"track.entry",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("playlists.id").orderBy("playlists.order").orderBy("playlists.id").$castTo(),{async create(e,t){await e.insertInto("playlists").onConflict(n=>n.doNothing()).values({id:identify(t),order:APPEND,relevancy:1,...t}).execute()},async edit(e,t,n){await e.updateTable("playlists").where("id","=",t).set(n).execute()},async rearrange(e,t,n){await e.updateTable("playlists_fractindex").set({after_id:n||null}).where("id","=",t).execute()},async delete(e,t){await e.deleteFrom("playlists").where("id","=",t).execute()},get(e,t){return e.selectFrom("playlists").selectAll().where("id","=",t).executeTakeFirstOrThrow()}}),resources$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).selectFrom("source").leftJoin("asset","asset.owner","source.owner").select([t=>t.fn.coalesce("asset.arts",t.val("[]")).as("arts"),t=>t.fn.coalesce("asset.thumbnails",t.val("[]")).as("thumbnails"),t=>t.fn.coalesce("source.sources",t.val("[]")).as("sources")]).$castTo(),{async prioritize(e,t,n){const s=t==="art"?"assets":"sources";await e.updateTable(s).set({primary:sql`${sql.ref(t)} = ${n}`}).where("owner","=",a=>a.selectFrom(s).where(t,"=",n).select("owner")).execute()},get(e,t){return e.with("source",source).with("asset",asset).selectFrom("source").leftJoin("asset","asset.owner","source.owner").select([n=>n.fn.coalesce("asset.arts",n.val("[]")).as("arts"),n=>n.fn.coalesce("asset.thumbnails",n.val("[]")).as("thumbnails"),n=>n.fn.coalesce("source.sources",n.val("[]")).as("sources")]).where("source.owner","=",t).$castTo().executeTakeFirstOrThrow()}}),settings$2=({store:r})=>r(e=>e.selectFrom("settings").select(["key",sql`json_extract(value, '$')`.as("value")]),{async store(e,t,n,s="settings"){s!=="settings"&&(await e.schema.createTable(s).ifNotExists().addColumn("key","text",a=>a.primaryKey()).addColumn("value","text").execute(),await e.schema.createIndex(s+"_value").ifNotExists().on(s).column("value").execute()),await e.insertInto(s).onConflict(a=>a.doUpdateSet({value:JSON.stringify(n)})).values({key:t,value:JSON.stringify(n)}).execute()},async extract(e,t,n="settings"){return e.selectFrom(n).select("value").where("key","=",t).executeTakeFirstOrThrow().then(s=>JSON.parse(s.value))},async lookup(e,t,n="settings"){return e.selectFrom(n).select("key").where("value","=",JSON.stringify(t)).executeTakeFirstOrThrow().then(s=>s.key)}}),history$2=({store:r})=>r(e=>e.selectFrom("history").orderBy("date","desc").selectAll(),{async log(e,t){t.trim()&&await e.insertInto("history").onConflict(n=>n.doUpdateSet({date:Date.now()})).values({query:t,date:Date.now()}).execute()},async clear(e){await e.deleteFrom("history").execute()},get(e){return e.selectFrom("history").selectAll().orderBy("date","desc").execute()}}),artists$2=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("artist").leftJoin("attribution","attribution.artist","artist.id").leftJoin("albums","albums.id","attribution.album").leftJoin("tracks","tracks.album","albums.id").leftJoin("track","track.id","tracks.id").select(["artist.id","artist.title","artist.following","artist.arts","artist.thumbnails","artist.sources",t=>json(t,{size:t.fn.count("track.duration"),duration:t.fn.coalesce(t.fn.sum("track.duration"),t.val(0)),tracks:groupJSON(t,{id:"track.id",entry:"track.id",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("artist.id").orderBy(t=>t.fn.count("track.duration"),"desc").orderBy("artist.title").$castTo(),{async push(e,t){await pushArtists(e,t)},async edit(e,t,n){await e.updateTable("artists").where("id","=",t).set(n)},async follow(e,t){await e.updateTable("artists").set({following:1}).where("id","=",t).execute()},async unfollow(e,t){await e.updateTable("artists").set({following:0}).where("id","=",t).execute()},async search(e,t,n=10,s=0){return t?e.with("source",source).with("asset",asset).with("artist",artist$1).selectFrom("artists_fts").where("artists_fts","match",sanitize(t)).orderBy("rank").innerJoin("artist","artist.id","artists_fts.rowid").selectAll().limit(n).offset(s).$castTo().execute():[]},get(e,t){return e.with("source",source).with("asset",asset).with("artist",artist$1).selectFrom("artist").where("artist.id","=",t).selectAll().$castTo().executeTakeFirstOrThrow()}}),library$2=({store:r})=>r(e=>e.selectFrom("library").selectAll(),{async push(e,t,n){t.length&&(await pushTracks(e,t),n!=null&&await e.insertInto("library").onConflict(s=>s.doNothing()).values(t.map(({id:s})=>({id:uuid(),order:APPEND,date:~~(Date.now()/1e3),track:s,playlist:n}))).execute())},async rearrange(e,t,n){await e.updateTable("library_fractindex").set({after_id:n||null}).where("id","=",t).execute()},async purge(e,t){const n=t.map(s=>e.deleteFrom("library").where("id","=",s).execute());await Promise.all(n)},async get(e,t){return t.length?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources","library.id as entry"]).where("library.id","in",t).$castTo().execute():[]},async sample(e,t){const n=t,s=n*Math.sqrt(2*Math.PI)/2,a=sql`POW(ABS(RANDOM()) / 9223372036854775808,
        ${s} /
        EXP(-0.5 * POW(row_number() OVER (ORDER BY date DESC) / ${n},2)) *
        playlists.relevancy
      )`;return await e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").innerJoin("playlists","playlists.id","library.playlist").innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources"]).where("relevancy",">",0).orderBy(a,"desc").limit(t).execute()},async banned(e){return await e.selectFrom("library").leftJoin("playlists","playlists.id","library.playlist").select("library.track").where("relevancy","<",0).execute().then(t=>t.map(n=>n.track))}}),id=integer,boolean=integer,tracks$2=assign(unique(track$1),object({album:id()}));crr(tracks$2);index(tracks$2,"album");primary(tracks$2,"id");const albums$2=unique(album);crr(albums$2);primary(albums$2,"id");const artists$1=assign(unique(artist),object({following:boolean()}));crr(artists$1);primary(artists$1,"id");const attribution=object({album:id(),artist:id()});crr(attribution);index(attribution,"artist");primary(attribution,"album","artist");const sources=object({source:string(),owner:id(),primary:boolean()});crr(sources);primary(sources,"owner","source");const assets=object({art:string(),thumbnail:nullable(string()),owner:id(),primary:boolean()});crr(assets);primary(assets,"owner","art");const playlists$1=assign(unique(playlist),object({order:string()}));crr(playlists$1);primary(playlists$1,"id");ordered(playlists$1,"order");index(playlists$1,"order","id");const library$1=object({id:id(),playlist:id(),track:id(),date:integer(),order:string()});crr(library$1);primary(library$1,"id");index(library$1,"date");index(library$1,"track");index(library$1,"playlist");index(library$1,"order","id");ordered(library$1,"order","playlist");const playback$1=object({id:id(),device:instance$1(Uint8Array),track:id(),order:string(),temp:any()});crr(playback$1);primary(playback$1,"id");index(playback$1,"device");index(playback$1,"order","id");ordered(playback$1,"order","device");const devices=object({id:instance$1(Uint8Array),playback:id(),direction:integer(),infinite:integer(),progress:number(),repeat:integer()});crr(devices);primary(devices,"id");const settings$1=object({key:string(),value:string()});crr(settings$1);index(settings$1,"value");primary(settings$1,"key");const history$1=object({query:string(),date:integer()});crr(history$1);index(history$1,"date");primary(history$1,"query");const schema=object({tracks:tracks$2,albums:albums$2,attribution,artists:artists$1,sources,assets,library:library$1,playlists:playlists$1,playback:playback$1,devices,settings:settings$1,history:history$1}),tracks$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").where("playlist",">=",0).innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources","library.id as entry","library.date"]).orderBy("library.date","desc").orderBy("library.id").$castTo(),{async edit(e,t,n){const s=await e.updateTable("tracks").where("id","=",t).set({...n,album:void 0}).returning("album").executeTakeFirst();s!=null&&s.album&&n.album&&await e.updateTable("albums").where("id","=",s.album).set(n.album).execute()},async search(e,t,n=10,s=0){return t?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("tracks_fts").where("tracks_fts","match",sanitize(t)).orderBy("rank").innerJoin("track","track.id","rowid").selectAll().limit(n).offset(s).$castTo().execute():[]},get(e,t){return e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("track").selectAll().where("id","=",t).$castTo().executeTakeFirstOrThrow()}}),albums$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("album").selectAll().orderBy("album.title"),{async push(e,t){await pushAlbums(e,t)},async search(e,t,n=10,s=0){return t?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("albums_fts").where("albums_fts","match",sanitize(t)).orderBy("rank").innerJoin("album","album.id","albums_fts.rowid").selectAll().limit(n).offset(s).$castTo().execute():[]},get(e,t){return e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("album").selectAll().where("album.id","=",t).$castTo().executeTakeFirstOrThrow()}}),feed$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",t=>track$2(t).innerJoin("library","library.track","tracks.id").select(["library.playlist","library.id as entry"]).orderBy("library.order").orderBy("library.id")).selectFrom("track").fullJoin("playlists","playlists.id","track.playlist").where("playlists.id","<",0).select(["playlists.id","playlists.title","playlists.relevancy","playlists.shared","playlists.remote",t=>json(t,{size:t.fn.count("track.duration"),duration:t.fn.coalesce(t.fn.sum("track.duration"),t.val(0)),tracks:groupJSON(t,{id:"track.id",entry:"track.entry",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("playlists.id").orderBy("playlists.order").orderBy("playlists.id").$castTo(),{async clear(e,t){await e.deleteFrom("library").where("playlist","=",t).execute()},async get(e,t,n=-1){return e.selectFrom("library").where("playlist","=",t).select("id").limit(n).execute().then(s=>s.map(a=>a.id))}}),connections=new Map,stores=r=>({playlists:playlists$2(r),resources:resources$1(r),preceding:preceding$1(r),playback:playback$2(r),upcoming:upcoming$1(r),settings:settings$2(r),history:history$2(r),artists:artists$2(r),library:library$2(r),albums:albums$1(r),tracks:tracks$1(r),feed:feed$1(r)});function connect(r){if(!connections.has(r.name)){const e=database(r.local?nocrr(schema):schema,r);connections.set(r.name,{...e,...stores(e)});const t=Object.assign({"../sql/cascade.sql":__vite_glob_0_0,"../sql/fts.sql":__vite_glob_0_1,"../sql/playback.sql":__vite_glob_0_2,"../sql/playlists.sql":__vite_glob_0_3});r.local&&delete t["../sql/fts.sql"];const n=Object.values(t).flatMap(s=>s.split(/\r?\n\r?\n/)).map(s=>sql.raw(s));e.update(s=>Promise.all(n.map(a=>a.execute(s))))}return connections.get(r.name)}function nocrr(r){return{...r,schema:Object.fromEntries(Object.entries(r.schema).map(([e,t])=>[e,{...t,crr:!1}]))}}function identity(r){return r}function pipeFromArray(r){return r.length===0?identity:r.length===1?r[0]:function(t){return r.reduce((n,s)=>s(n),t)}}function observable(r){const e={subscribe(t){let n=null,s=!1,a=!1,c=!1;function d(){if(n===null){c=!0;return}a||(a=!0,typeof n=="function"?n():n&&n.unsubscribe())}return n=r({next(h){var p;s||(p=t.next)==null||p.call(t,h)},error(h){var p;s||(s=!0,(p=t.error)==null||p.call(t,h),d())},complete(){var h;s||(s=!0,(h=t.complete)==null||h.call(t),d())}}),c&&d(),{unsubscribe:d}},pipe(...t){return pipeFromArray(t)(e)}};return e}function share(r){return e=>{let t=0,n=null;const s=[];function a(){n||(n=e.subscribe({next(d){var h;for(const p of s)(h=p.next)==null||h.call(p,d)},error(d){var h;for(const p of s)(h=p.error)==null||h.call(p,d)},complete(){var d;for(const h of s)(d=h.complete)==null||d.call(h)}}))}function c(){if(t===0&&n){const d=n;n=null,d.unsubscribe()}}return{subscribe(d){return t++,s.push(d),a(),{unsubscribe(){t--,c();const h=s.findIndex(p=>p===d);h>-1&&s.splice(h,1)}}}}}}class ObservableAbortError extends Error{constructor(e){super(e),this.name="ObservableAbortError",Object.setPrototypeOf(this,ObservableAbortError.prototype)}}function observableToPromise(r){let e;return{promise:new Promise((n,s)=>{let a=!1;function c(){a||(a=!0,s(new ObservableAbortError("This operation was aborted.")),d.unsubscribe())}const d=r.subscribe({next(h){a=!0,n(h),c()},error(h){a=!0,s(h),c()},complete(){a=!0,c()}});e=c}),abort:e}}function createChain(r){return observable(e=>{function t(s=0,a=r.op){const c=r.links[s];if(!c)throw new Error("No more links to execute - did you forget to add an ending link?");return c({op:a,next(h){return t(s+1,h)}})}return t().subscribe(e)})}class TRPCClientError extends Error{static from(e,t={}){return e instanceof Error?e.name==="TRPCClientError"?e:new TRPCClientError(e.message,{...t,cause:e,result:null}):new TRPCClientError(e.error.message??"",{...t,cause:void 0,result:e})}constructor(e,t){var s,a;const n=t==null?void 0:t.cause;super(e,{cause:n}),this.meta=t==null?void 0:t.meta,this.cause=n,this.shape=(s=t==null?void 0:t.result)==null?void 0:s.error,this.data=(a=t==null?void 0:t.result)==null?void 0:a.error.data,this.name="TRPCClientError",Object.setPrototypeOf(this,TRPCClientError.prototype)}}function isObject(r){return!!r&&!Array.isArray(r)&&typeof r=="object"}function transformResultInner(r,e){if("error"in r){const n=e.transformer.deserialize(r.error);return{ok:!1,error:{...r,error:n}}}return{ok:!0,result:{...r.result,...(!r.result.type||r.result.type==="data")&&{type:"data",data:e.transformer.deserialize(r.result.data)}}}}function transformResult(r,e){let t;try{t=transformResultInner(r,e)}catch{throw new TRPCClientError("Unable to transform response from server")}if(!t.ok&&(!isObject(t.error.error)||typeof t.error.error.code!="number"))throw new TRPCClientError("Badly formatted response from server");if(t.ok&&!isObject(t.result))throw new TRPCClientError("Badly formatted response from server");return t}function invert(r){const e=Object.create(null);for(const t in r){const n=r[t];e[n]=t}return e}const TRPC_ERROR_CODES_BY_KEY={PARSE_ERROR:-32700,BAD_REQUEST:-32600,INTERNAL_SERVER_ERROR:-32603,UNAUTHORIZED:-32001,FORBIDDEN:-32003,NOT_FOUND:-32004,METHOD_NOT_SUPPORTED:-32005,TIMEOUT:-32008,CONFLICT:-32009,PRECONDITION_FAILED:-32012,PAYLOAD_TOO_LARGE:-32013,UNPROCESSABLE_CONTENT:-32022,TOO_MANY_REQUESTS:-32029,CLIENT_CLOSED_REQUEST:-32099};invert(TRPC_ERROR_CODES_BY_KEY);invert(TRPC_ERROR_CODES_BY_KEY);const noop=()=>{};function createInnerProxy(r,e){return new Proxy(noop,{get(n,s){if(!(typeof s!="string"||s==="then"))return createInnerProxy(r,[...e,s])},apply(n,s,a){const c=e[e.length-1]==="apply";return r({args:c?a.length>=2?a[1]:[]:a,path:c?e.slice(0,-1):e})}})}const createRecursiveProxy=r=>createInnerProxy(r,[]),createFlatProxy=r=>new Proxy(noop,{get(e,t){if(!(typeof t!="string"||t==="then"))return r(t)}});/* istanbul ignore next -- @preserve */const retryDelay=r=>r===0?0:Math.min(1e3*2**r,3e4);function createWSClient(r){const{url:e,WebSocket:t=WebSocket,retryDelayMs:n=retryDelay,onOpen:s,onClose:a}=r;/* istanbul ignore next -- @preserve */if(!t)throw new Error("No WebSocket implementation found - you probably don't want to use this on the server, but if you do you need to pass a `WebSocket`-ponyfill");let c=[];const d=Object.create(null);let h=0,p=null,N=null,O=W(),A="connecting";function R(){A!=="open"||p||(p=setTimeout(()=>{p=null,c.length===1?O.send(JSON.stringify(c.pop())):O.send(JSON.stringify(c)),c=[]}))}function x(){if(N||A==="closed")return;const X=n(h++);w(X)}function m(){A="connecting";const X=O;O=W(),y(X)}function w(X){N||(A="connecting",N=setTimeout(m,X))}function y(X){Object.values(d).some(j=>j.ws===X)||X.close()}function _(){Object.values(d).forEach(X=>{X.type==="subscription"&&X.callbacks.complete()})}function g(X){c.some(Z=>Z.id===X.op.id)||z(X.op,X.callbacks)}function W(){const X=typeof e=="function"?e():e,Z=new t(X);clearTimeout(N),N=null,Z.addEventListener("open",()=>{/* istanbul ignore next -- @preserve */Z===O&&(h=0,A="open",s==null||s(),R())}),Z.addEventListener("error",()=>{Z===O&&x()});const j=Q=>{if(Q.method==="reconnect"&&Z===O){A==="open"&&(a==null||a()),m();for(const U of Object.values(d))U.type==="subscription"&&g(U)}},le=Q=>{var P,V;const U=Q.id!==null&&d[Q.id];if(U){if((V=(P=U.callbacks).next)==null||V.call(P,Q),U.ws!==O&&Z===O){const te=U.ws;U.ws=O,y(te)}"result"in Q&&Q.result.type==="stopped"&&Z===O&&U.callbacks.complete()}};return Z.addEventListener("message",({data:Q})=>{const U=JSON.parse(Q);"method"in U?j(U):le(U),(Z!==O||A==="closed")&&y(Z)}),Z.addEventListener("close",({code:Q})=>{var U,P,V,te;A==="open"&&(a==null||a({code:Q})),O===Z&&x();for(const[ne,B]of Object.entries(d))if(B.ws===Z){if(A==="closed"){delete d[ne],(P=(U=B.callbacks).complete)==null||P.call(U);continue}B.type==="subscription"?g(B):(delete d[ne],(te=(V=B.callbacks).error)==null||te.call(V,TRPCClientError.from(new TRPCWebSocketClosedError("WebSocket closed prematurely"))))}}),Z}function z(X,Z){const{type:j,input:le,path:Q,id:U}=X,P={id:U,method:j,params:{input:le,path:Q}};return d[U]={ws:O,type:j,callbacks:Z,op:X},c.push(P),R(),()=>{var te,ne;const V=(te=d[U])==null?void 0:te.callbacks;delete d[U],c=c.filter(B=>B.id!==U),(ne=V==null?void 0:V.complete)==null||ne.call(V),O.readyState===t.OPEN&&X.type==="subscription"&&(c.push({id:U,method:"subscription.stop"}),R())}}return{close:()=>{A="closed",a==null||a(),_(),y(O),clearTimeout(N),N=null},request:z,getConnection(){return O}}}class TRPCWebSocketClosedError extends Error{constructor(e){super(e),this.name="TRPCWebSocketClosedError",Object.setPrototypeOf(this,TRPCWebSocketClosedError.prototype)}}function wsLink(r){return e=>{const{client:t}=r;return({op:n})=>observable(s=>{const{type:a,path:c,id:d,context:h}=n,p=e.transformer.serialize(n.input),N=t.request({type:a,path:c,input:p,id:d,context:h},{error(O){s.error(O),N()},complete(){s.complete()},next(O){const A=transformResult(O,e);if(!A.ok){s.error(TRPCClientError.from(A.error));return}s.next({result:A.result}),n.type!=="subscription"&&(N(),s.complete())}});return()=>{N()}})}}class TRPCUntypedClient{$request({type:e,input:t,path:n,context:s={}}){return createChain({links:this.links,op:{id:++this.requestId,type:e,path:n,input:t,context:s}}).pipe(share())}requestAsPromise(e){const t=this.$request(e),{promise:n,abort:s}=observableToPromise(t);return new Promise((c,d)=>{var h;(h=e.signal)==null||h.addEventListener("abort",s),n.then(p=>{c(p.result.data)}).catch(p=>{d(TRPCClientError.from(p))})})}query(e,t,n){return this.requestAsPromise({type:"query",path:e,input:t,context:n==null?void 0:n.context,signal:n==null?void 0:n.signal})}mutation(e,t,n){return this.requestAsPromise({type:"mutation",path:e,input:t,context:n==null?void 0:n.context,signal:n==null?void 0:n.signal})}subscription(e,t,n){return this.$request({type:"subscription",path:e,input:t,context:n==null?void 0:n.context}).subscribe({next(a){var c,d,h;a.result.type==="started"?(c=n.onStarted)==null||c.call(n):a.result.type==="stopped"?(d=n.onStopped)==null||d.call(n):(h=n.onData)==null||h.call(n,a.result.data)},error(a){var c;(c=n.onError)==null||c.call(n,a)},complete(){var a;(a=n.onComplete)==null||a.call(n)}})}constructor(e){this.requestId=0;const t=(()=>{const n=e.transformer;return n?"input"in n?e.transformer:{input:n,output:n}:{input:{serialize:s=>s,deserialize:s=>s},output:{serialize:s=>s,deserialize:s=>s}}})();this.runtime={transformer:{serialize:n=>t.input.serialize(n),deserialize:n=>t.output.deserialize(n)},combinedTransformer:t},this.links=e.links.map(n=>n(this.runtime))}}const clientCallTypeMap={query:"query",mutate:"mutation",subscribe:"subscription"},clientCallTypeToProcedureType=r=>clientCallTypeMap[r];function createTRPCClientProxy(r){return createFlatProxy(e=>r.hasOwnProperty(e)?r[e]:createRecursiveProxy(({path:t,args:n})=>{const s=[e,...t],a=clientCallTypeToProcedureType(s.pop()),c=s.join(".");return r[a](c,...n)}))}function createTRPCProxyClient(r){const e=new TRPCUntypedClient(r);return createTRPCClientProxy(e)}var ao;const{sync,search:search$1,streams,expand,desource,transcribe}=createTRPCProxyClient({links:[(ao=globalThis.localStorage)!=null&&ao.getItem("remote")?wsLink({client:createWSClient({url:()=>localStorage.getItem("remote")})}):()=>()=>observable(()=>{})]}),{playlists,resources,preceding,playback,upcoming,settings,history,artists,library,albums,tracks,update,feed}=connect({name:"library.db",push:sync.push.mutate,pull:sync.pull.subscribe}),search=writable(""),extra=writable(null);function format(r,e=!1){if(!e){r=Math.round(+r),r<=0&&(r=0);const d=~~(r/3600);r-=d*3600;const h=~~(r/60);r-=h*60;const p=r,N=O=>O.toString().padStart(2,"0");return d?`${d}:${N(h)}:${N(p)}`:`${h}:${N(p)}`}const t=new Intl.RelativeTimeFormat("en"),n=Math.floor((Date.now()-+r)/1e3),s=Math.floor(n/60),a=Math.floor(s/60),c=Math.floor(a/24);return n<=1?"just now":n<60?t.format(-n,"seconds"):s<60?t.format(-s,"minutes"):a<24?t.format(-a,"hours"):t.format(-c,"days")}function compare(r){const e=new Date;return+r>+e?"In The Future":r.getFullYear()===e.getFullYear()?r.getMonth()===e.getMonth()?e.getDate()-r.getDate()===0?"Today":e.getDate()-r.getDate()===1?"Yesterday":e.getDate()-r.getDate()<7&&e.getDay()>r.getDay()?"This Week":e.getDate()-r.getDate()<7||e.getDate()-r.getDate()<14&&e.getDay()>=r.getDay()?"Last Week":"This Month":e.getMonth()-r.getMonth()===1?"Last Month":`In ${r.toLocaleString("default",{month:"long"})}`:r.getFullYear().toString()}const get_default_slot_changes=r=>({}),get_default_slot_context=r=>({slot:"after"});function create_default_slot_6(r){let e;return{c(){e=text(r[4])},l(t){e=claim_text(t,r[4])},m(t,n){insert_hydration(t,e,n)},p(t,n){n&16&&set_data(e,t[4])},d(t){t&&detach(e)}}}function create_default_slot_5(r){let e,t,n,s;return n=new Text({props:{secondary:!0,$$slots:{default:[create_default_slot_6]},$$scope:{ctx:r}}}),{c(){e=text(r[5]),t=space(),create_component(n.$$.fragment)},l(a){e=claim_text(a,r[5]),t=claim_space(a),claim_component(n.$$.fragment,a)},m(a,c){insert_hydration(a,e,c),insert_hydration(a,t,c),mount_component(n,a,c),s=!0},p(a,c){(!s||c&32)&&set_data(e,a[5]);const d={};c&1040&&(d.$$scope={dirty:c,ctx:a}),n.$set(d)},i(a){s||(transition_in(n.$$.fragment,a),s=!0)},o(a){transition_out(n.$$.fragment,a),s=!1},d(a){a&&detach(e),a&&detach(t),destroy_component(n,a)}}}function create_default_slot_4(r){var n;let e=((n=r[3])==null?void 0:n.artists.map(func).join(", "))+"",t;return{c(){t=text(e)},l(s){t=claim_text(s,e)},m(s,a){insert_hydration(s,t,a)},p(s,a){var c;a&8&&e!==(e=((c=s[3])==null?void 0:c.artists.map(func).join(", "))+"")&&set_data(t,e)},d(s){s&&detach(t)}}}function create_if_block(r){let e,t;return e=new When({props:{lg:!0,$$slots:{default:[create_default_slot_2]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),t=!0},p(n,s){const a={};s&1032&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}function create_default_slot_3(r){var n;let e=((n=r[3])==null?void 0:n.album.title)+"",t;return{c(){t=text(e)},l(s){t=claim_text(s,e)},m(s,a){insert_hydration(s,t,a)},p(s,a){var c;a&8&&e!==(e=((c=s[3])==null?void 0:c.album.title)+"")&&set_data(t,e)},d(s){s&&detach(t)}}}function create_default_slot_2(r){let e,t;return e=new Text({props:{secondary:!0,sm:!0,loading:!r[3],$$slots:{default:[create_default_slot_3]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),t=!0},p(n,s){const a={};s&8&&(a.loading=!n[3]),s&1032&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}function create_default_slot_1(r){let e,t,n,s,a,c,d=`scaleX(${r[1]})`,h;e=new Text({props:{accent:!0,loading:!r[3],$$slots:{default:[create_default_slot_5]},$$scope:{ctx:r}}}),n=new Text({props:{secondary:!0,sm:!0,loading:!r[3],$$slots:{default:[create_default_slot_4]},$$scope:{ctx:r}}});let p=!r[0]&&create_if_block(r);return{c(){create_component(e.$$.fragment),t=space(),create_component(n.$$.fragment),s=space(),p&&p.c(),a=space(),c=element("div"),this.h()},l(N){claim_component(e.$$.fragment,N),t=claim_space(N),claim_component(n.$$.fragment,N),s=claim_space(N),p&&p.l(N),a=claim_space(N),c=claim_element(N,"DIV",{class:!0}),children(c).forEach(detach),this.h()},h(){attr(c,"class","absolute bottom-0 left-0 h-0.5 w-full origin-left transform-gpu bg-highlight-200 transition-transform duration-1000"),set_style(c,"transform",d)},m(N,O){mount_component(e,N,O),insert_hydration(N,t,O),mount_component(n,N,O),insert_hydration(N,s,O),p&&p.m(N,O),insert_hydration(N,a,O),insert_hydration(N,c,O),h=!0},p(N,O){const A={};O&8&&(A.loading=!N[3]),O&1072&&(A.$$scope={dirty:O,ctx:N}),e.$set(A);const R={};O&8&&(R.loading=!N[3]),O&1032&&(R.$$scope={dirty:O,ctx:N}),n.$set(R),N[0]?p&&(group_outros(),transition_out(p,1,1,()=>{p=null}),check_outros()):p?(p.p(N,O),O&1&&transition_in(p,1)):(p=create_if_block(N),p.c(),transition_in(p,1),p.m(a.parentNode,a)),O&2&&d!==(d=`scaleX(${N[1]})`)&&set_style(c,"transform",d)},i(N){h||(transition_in(e.$$.fragment,N),transition_in(n.$$.fragment,N),transition_in(p),h=!0)},o(N){transition_out(e.$$.fragment,N),transition_out(n.$$.fragment,N),transition_out(p),h=!1},d(N){destroy_component(e,N),N&&detach(t),destroy_component(n,N),N&&detach(s),p&&p.d(N),N&&detach(a),N&&detach(c)}}}function create_default_slot(r){var a;let e,t,n=`hue-rotate(${((a=r[3])==null?void 0:a.id)||0}deg)`,s;return t=new Icon({props:{name:"note"}}),{c(){e=element("div"),create_component(t.$$.fragment),this.h()},l(c){e=claim_element(c,"DIV",{class:!0});var d=children(e);claim_component(t.$$.fragment,d),d.forEach(detach),this.h()},h(){attr(e,"class","flex h-full w-full items-center justify-center bg-gradient-to-r from-rose-400 to-red-400 text-white"),set_style(e,"filter",n)},m(c,d){insert_hydration(c,e,d),mount_component(t,e,null),s=!0},p(c,d){var h;d&8&&n!==(n=`hue-rotate(${((h=c[3])==null?void 0:h.id)||0}deg)`)&&set_style(e,"filter",n)},i(c){s||(transition_in(t.$$.fragment,c),s=!0)},o(c){transition_out(t.$$.fragment,c),s=!1},d(c){c&&detach(e),destroy_component(t)}}}function create_before_slot(r){var n,s;let e,t;return e=new Image({props:{src:r[3]?((n=r[3].album.arts)==null?void 0:n[0])||"":void 0,thumbnail:r[3]?((s=r[3].album.thumbnails)==null?void 0:s[0])||"":void 0,slot:"before",$$slots:{default:[create_default_slot]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(a){claim_component(e.$$.fragment,a)},m(a,c){mount_component(e,a,c),t=!0},p(a,c){var h,p;const d={};c&8&&(d.src=a[3]?((h=a[3].album.arts)==null?void 0:h[0])||"":void 0),c&8&&(d.thumbnail=a[3]?((p=a[3].album.thumbnails)==null?void 0:p[0])||"":void 0),c&1032&&(d.$$scope={dirty:c,ctx:a}),e.$set(d)},i(a){t||(transition_in(e.$$.fragment,a),t=!0)},o(a){transition_out(e.$$.fragment,a),t=!1},d(a){destroy_component(e,a)}}}function create_after_slot(r){let e;const t=r[7].default,n=create_slot(t,r,r[10],get_default_slot_context);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,a){n&&n.p&&(!e||a&1024)&&update_slot_base(n,t,s,s[10],e?get_slot_changes(t,s[10],a,get_default_slot_changes):get_all_dirty_from_scope(s[10]),get_default_slot_context)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}function create_fragment(r){let e,t;return e=new Card({props:{sm:!0,flat:!0,flow:!r[0],interactive:!0,selected:r[2],$$slots:{after:[create_after_slot],before:[create_before_slot],default:[create_default_slot_1]},$$scope:{ctx:r}}}),e.$on("contextmenu",r[8]),e.$on("click",r[9]),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),t=!0},p(n,[s]){const a={};s&1&&(a.flow=!n[0]),s&4&&(a.selected=n[2]),s&1083&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}const func=r=>r.title;function instance(r,e,t){let n,s,a,{$$slots:c={},$$scope:d}=e,{sm:h=!1}=e,{progress:p=0}=e,{selected:N=!1}=e,{track:O=void 0}=e;function A(x){bubble.call(this,r,x)}function R(x){bubble.call(this,r,x)}return r.$$set=x=>{"sm"in x&&t(0,h=x.sm),"progress"in x&&t(1,p=x.progress),"selected"in x&&t(2,N=x.selected),"track"in x&&t(3,O=x.track),"$$scope"in x&&t(10,d=x.$$scope)},r.$$.update=()=>{r.$$.dirty&8&&t(5,[n=void 0,...s]=(O==null?void 0:O.title.split("("))||[],n,(t(6,s),t(3,O))),r.$$.dirty&64&&t(4,a=s.length?"("+s.join("("):"")},[h,p,N,O,a,n,s,c,A,R,d]}class Track extends SvelteComponent{constructor(e){super(),init$1(this,e,instance,create_fragment,safe_not_equal,{sm:0,progress:1,selected:2,track:3})}}export{Card as C,Image as I,Portal as P,Realm as R,Track as T,Virtual as V,When as W,streams as a,search$1 as b,capitalize as c,albums as d,extra as e,artists as f,expand as g,history as h,initRealm as i,playback as j,feed as k,library as l,intersection as m,Text as n,format as o,playlists as p,hold as q,ready as r,search as s,tracks as t,compare as u,upcoming as v,desource as w};
