var Qo=Object.defineProperty;var Po=(r,e,t)=>e in r?Qo(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var le=(r,e,t)=>(Po(r,typeof e!="symbol"?e+"":e,t),t),vi=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var i=(r,e,t)=>(vi(r,e,"read from private field"),t?t.call(r):e.get(r)),T=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},A=(r,e,t,n)=>(vi(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var te=(r,e,t)=>(vi(r,e,"access private method"),t);import{T as run_all,s as safe_not_equal,w as create_slot,f as element,g as claim_element,h as children,d as detach,j as attr,E as toggle_class,i as insert_hydration,x as update_slot_base,y as get_all_dirty_from_scope,z as get_slot_changes,L as setContext,e as empty$1,G as noop$2,A as getContext,a as space,c as claim_space,k as set_style,u as append_hydration,C as listen,J as action_destroyer,v as component_subscribe,W as createEventDispatcher,o as onMount,t as tick,F as set_store_value,p as binding_callbacks,H as compute_slots,X as assign$1,a1 as set_dynamic_element_data,M as bubble,a0 as src_url_equal,l as text,m as claim_text,n as set_data}from"./scheduler.c5d52407.js";import{t as transition_out,a as transition_in,S as SvelteComponent,i as init$1,g as group_outros,c as check_outros,b as create_component,d as claim_component,m as mount_component,e as destroy_component}from"./index.0fc8bad8.js";import{w as writable,d as derived}from"./paths.87873d95.js";import{l as lock,b as unlock,a as getScrollParent,p as position$1,I as Icon,g as get_spread_update}from"./Spinner.svelte_svelte_type_style_lang.9e9001e5.js";const globals=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function ensure_array_like(r){return(r==null?void 0:r.length)!==void 0?r:Array.from(r)}function outro_and_destroy_block(r,e){transition_out(r,1,1,()=>{e.delete(r.key)})}function update_keyed_each(r,e,t,n,s,a,c,f,h,m,N,g){let C=r.length,k=a.length,O=C;const p={};for(;O--;)p[r[O].key]=O;const b=[],y=new Map,_=new Map,R=[];for(O=k;O--;){const J=g(s,a,O),ce=t(J);let H=c.get(ce);H?n&&R.push(()=>H.p(J,e)):(H=m(ce,J),H.c()),y.set(ce,b[O]=H),ce in p&&_.set(ce,Math.abs(O-p[ce]))}const U=new Set,$=new Set;function W(J){transition_in(J,1),J.m(f,N),c.set(J.key,J),N=J.first,k--}for(;C&&k;){const J=b[k-1],ce=r[C-1],H=J.key,z=ce.key;J===ce?(N=J.first,C--,k--):y.has(z)?!c.has(H)||U.has(H)?W(J):$.has(z)?C--:_.get(H)>_.get(z)?($.add(H),W(J)):(U.add(z),C--):(h(ce,c),C--)}for(;C--;){const J=r[C];y.has(J.key)||h(J,c)}for(;k;)W(b[k-1]);return run_all(R),b}let observing=0,observer=null;const dispatch=r=>r.forEach(e=>{var t;(t=e.target)==null||t.dispatchEvent(new CustomEvent("resize",{detail:e}))});function resize(r){return observer||(observer=new ResizeObserver(dispatch)),observer.observe(r),observing+=1,{destroy(){observer==null||observer.unobserve(r),observing-=1,observing<=0&&(observer==null||observer.disconnect(),observer=null)}}}function drag(r,e="touchstart"){function t(c){do{if(c!=null&&c.draggable)return c;c=(c==null?void 0:c.parentElement)||null}while(c);return null}function n(c){const f=t(c.target);f&&(lock(),c.preventDefault(),f.dispatchEvent(new DragEvent("dragstart",{bubbles:!0})))}function s(c){c.preventDefault(),addEventListener("pointercancel",a),addEventListener("pointerup",a)}function a(){unlock(),removeEventListener("pointercancel",a),removeEventListener("pointerup",a),r.dispatchEvent(new DragEvent("dragend",{bubbles:!0}))}return r.addEventListener(e,n),r.addEventListener("dragstart",s),{destroy(){r.removeEventListener(e,n),r.removeEventListener("dragstart",s)}}}function hold(r,{touch:e=!0,mouse:t=!1,duration:n=300}={}){function s(a){const c=setTimeout(()=>{var m;f();const h=a instanceof TouchEvent?TouchEvent:MouseEvent;(m=a.target)==null||m.dispatchEvent(new h("hold",a))},n),f=()=>{clearTimeout(c),e&&(r.removeEventListener("touchcancel",f),r.removeEventListener("touchmove",f),r.removeEventListener("touchend",f)),t&&(r.removeEventListener("mousemove",f),r.removeEventListener("mouseup",f))};e&&(r.addEventListener("touchcancel",f,{once:!0}),r.addEventListener("touchend",f,{once:!0}),r.addEventListener("touchmove",f,{once:!0,passive:!0})),t&&(r.addEventListener("mousemove",f,{once:!0}),r.addEventListener("mouseup",f,{once:!0}))}return e&&r.addEventListener("touchstart",s,{passive:!0}),t&&r.addEventListener("mousedown",s),{destroy(){r.removeEventListener("touchstart",s),r.removeEventListener("mousedown",s)}}}function create_fragment$7(r){let e,t,n;const s=r[6].default,a=create_slot(s,r,r[5],null);return{c(){e=element("div"),a&&a.c(),this.h()},l(c){e=claim_element(c,"DIV",{class:!0});var f=children(e);a&&a.l(f),f.forEach(detach),this.h()},h(){attr(e,"class",t=r[0]?"contents":"hidden"),toggle_class(e,"sm:contents",!r[0]&&r[1]),toggle_class(e,"md:contents",!r[0]&&r[2]),toggle_class(e,"lg:contents",!r[0]&&r[3]),toggle_class(e,"xl:contents",!r[0]&&r[4]),toggle_class(e,"sm:hidden",r[0]&&r[1]),toggle_class(e,"md:hidden",r[0]&&r[2]),toggle_class(e,"lg:hidden",r[0]&&r[3]),toggle_class(e,"xl:hidden",r[0]&&r[4])},m(c,f){insert_hydration(c,e,f),a&&a.m(e,null),n=!0},p(c,[f]){a&&a.p&&(!n||f&32)&&update_slot_base(a,s,c,c[5],n?get_slot_changes(s,c[5],f,null):get_all_dirty_from_scope(c[5]),null),(!n||f&1&&t!==(t=c[0]?"contents":"hidden"))&&attr(e,"class",t),(!n||f&3)&&toggle_class(e,"sm:contents",!c[0]&&c[1]),(!n||f&5)&&toggle_class(e,"md:contents",!c[0]&&c[2]),(!n||f&9)&&toggle_class(e,"lg:contents",!c[0]&&c[3]),(!n||f&17)&&toggle_class(e,"xl:contents",!c[0]&&c[4]),(!n||f&3)&&toggle_class(e,"sm:hidden",c[0]&&c[1]),(!n||f&5)&&toggle_class(e,"md:hidden",c[0]&&c[2]),(!n||f&9)&&toggle_class(e,"lg:hidden",c[0]&&c[3]),(!n||f&17)&&toggle_class(e,"xl:hidden",c[0]&&c[4])},i(c){n||(transition_in(a,c),n=!0)},o(c){transition_out(a,c),n=!1},d(c){c&&detach(e),a&&a.d(c)}}}function instance$8(r,e,t){let{$$slots:n={},$$scope:s}=e,{not:a=!1}=e,{sm:c=!1}=e,{md:f=!1}=e,{lg:h=!1}=e,{xl:m=!1}=e;return r.$$set=N=>{"not"in N&&t(0,a=N.not),"sm"in N&&t(1,c=N.sm),"md"in N&&t(2,f=N.md),"lg"in N&&t(3,h=N.lg),"xl"in N&&t(4,m=N.xl),"$$scope"in N&&t(5,s=N.$$scope)},[a,c,f,h,m,s,n]}class When extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$8,create_fragment$7,safe_not_equal,{not:0,sm:1,md:2,lg:3,xl:4})}}function create_fragment$6(r){let e;const t=r[1].default,n=create_slot(t,r,r[0],null);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,[a]){n&&n.p&&(!e||a&1)&&update_slot_base(n,t,s,s[0],e?get_slot_changes(t,s[0],a,null):get_all_dirty_from_scope(s[0]),null)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}const initRealm=()=>({ssr:"",claimed:new Set,mounted:new Set,claim:new Set,destroy:new Set,mount:new Set,target:void 0});function instance$7(r,e,t){let{$$slots:n={},$$scope:s}=e;return setContext("realm",{}),r.$$set=c=>{"$$scope"in c&&t(0,s=c.$$scope)},[s,n]}class Realm extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$7,create_fragment$6,safe_not_equal,{})}}function create_key_block(r){let e;const t=r[4].default,n=create_slot(t,r,r[3],null);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,a){n&&n.p&&(!e||a&8)&&update_slot_base(n,t,s,s[3],e?get_slot_changes(t,s[3],a,null):get_all_dirty_from_scope(s[3]),null)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}function create_fragment$5(r){let e=r[0],t,n,s=create_key_block(r);return{c(){s.c(),t=empty$1()},l(a){s.l(a),t=empty$1()},m(a,c){s.m(a,c),insert_hydration(a,t,c),n=!0},p(a,[c]){c&1&&safe_not_equal(e,e=a[0])?(group_outros(),transition_out(s,1,1,noop$2),check_outros(),s=create_key_block(a),s.c(),transition_in(s,1),s.m(t.parentNode,t)):s.p(a,c)},i(a){n||(transition_in(s),n=!0)},o(a){transition_out(s),n=!1},d(a){a&&detach(t),s.d(a)}}}function instance$6($$self,$$props,$$invalidate){let{$$slots:slots={},$$scope}=$$props,{to=""}=$$props,{unique=""}=$$props;const realm=getContext("realm");if(!realm)throw new Error("A portal should exists within a realm!");realm[to]||(realm[to]=initRealm());const target=eval("slots");if(target.default){const[r]=target.default;target.default[0]=(...e)=>{const t=r(...e),n=realm[to];let s=!0,a=!0;function c(m){if(!m||n.claimed.has(unique))return a=!1;t.l(m),unique&&n.claimed.add(unique)}function f(m,N){if(n.mounted.has(unique))return s=!1;a&&t.m(m,N),unique&&n.mounted.add(unique)}function h(m){s&&n.mounted.delete(unique),a&&n.claimed.delete(unique),s&&t.d(m),n.claim.delete(c),n.mount.delete(f),n.destroy.delete(h)}return n.claim.add(c),n.mount.add(f),n.destroy.add(h),{...t,d:h,l:()=>{},m:()=>n.target&&f.apply(null,n.target)}}}return $$self.$$set=r=>{"to"in r&&$$invalidate(0,to=r.to),"unique"in r&&$$invalidate(1,unique=r.unique),"$$scope"in r&&$$invalidate(3,$$scope=r.$$scope)},$$self.$$.update=()=>{$$self.$$.dirty&5&&(realm[to]||$$invalidate(2,realm[to]=initRealm(),realm))},[to,unique,realm,$$scope,slots]}class Portal extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$6,create_fragment$5,safe_not_equal,{to:0,unique:1})}}function minmax(r,e,t,n){return r<e?n??e:r>t?n??t:r}const{Map:Map_1,window:window_1}=globals,get_default_slot_changes_1=r=>({item:r[0]&2048}),get_default_slot_context_1=r=>({item:r[11].data,index:NaN});function get_each_context(r,e,t){const n=r.slice();return n[52]=e[t],n[54]=t,n}const get_default_slot_changes$1=r=>({item:r[0]&16384,index:r[0]&16640}),get_default_slot_context$1=r=>({item:r[52],index:r[8]+r[54]});function create_each_block(r,e){let t,n,s,a;const c=e[40].default,f=create_slot(c,e,e[42],get_default_slot_context$1);return{key:r,first:null,c(){t=element("div"),f&&f.c(),n=space(),this.h()},l(h){t=claim_element(h,"DIV",{draggable:!0,style:!0});var m=children(t);f&&f.l(m),n=claim_space(m),m.forEach(detach),this.h()},h(){var h,m;attr(t,"draggable",s=e[2]&&e[1](e[52])!=null?"true":void 0),set_style(t,"overflow-anchor","none"),toggle_class(t,"invisible",((h=e[11])==null?void 0:h.owner)===e[3]&&((m=e[11])==null?void 0:m.key)===e[1](e[52])),this.first=t},m(h,m){insert_hydration(h,t,m),f&&f.m(t,null),append_hydration(t,n),a=!0},p(h,m){var N,g;e=h,f&&f.p&&(!a||m[0]&16640|m[1]&2048)&&update_slot_base(f,c,e,e[42],a?get_slot_changes(c,e[42],m,get_default_slot_changes$1):get_all_dirty_from_scope(e[42]),get_default_slot_context$1),(!a||m[0]&16390&&s!==(s=e[2]&&e[1](e[52])!=null?"true":void 0))&&attr(t,"draggable",s),(!a||m[0]&18442)&&toggle_class(t,"invisible",((N=e[11])==null?void 0:N.owner)===e[3]&&((g=e[11])==null?void 0:g.key)===e[1](e[52]))},i(h){a||(transition_in(f,h),a=!0)},o(h){transition_out(f,h),a=!1},d(h){h&&detach(t),f&&f.d(h)}}}function create_if_block$3(r){let e,t;return e=new Portal({props:{to:"overlay",$$slots:{default:[create_default_slot$1]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),t=!0},p(n,s){const a={};s[0]&2297|s[1]&2048&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}function create_if_block_1$2(r){let e,t=`translate3d(
          ${r[11].back?r[11].back.x:r[7].x+Math.max(r[11].offset.x,-r[4].width/r[6]+r[0])}px,
          ${r[11].back?r[11].back.y:r[7].y+Math.max(r[11].offset.y,-r[5]+r[0])}px, 0)`,n=`${r[4].width/r[6]-r[0]}px`,s=`${r[5]-r[0]}px`,a;const c=r[40].default,f=create_slot(c,r,r[42],get_default_slot_context_1);return{c(){e=element("div"),f&&f.c(),this.h()},l(h){e=claim_element(h,"DIV",{class:!0});var m=children(e);f&&f.l(m),m.forEach(detach),this.h()},h(){attr(e,"class","absolute will-change-transform contain-[size_layout]"),toggle_class(e,"transition-transform",r[11].back),set_style(e,"transform",t),set_style(e,"width",n),set_style(e,"height",s)},m(h,m){insert_hydration(h,e,m),f&&f.m(e,null),a=!0},p(h,m){f&&f.p&&(!a||m[0]&2048|m[1]&2048)&&update_slot_base(f,c,h,h[42],a?get_slot_changes(c,h[42],m,get_default_slot_changes_1):get_all_dirty_from_scope(h[42]),get_default_slot_context_1),(!a||m[0]&2048)&&toggle_class(e,"transition-transform",h[11].back),m[0]&2289&&t!==(t=`translate3d(
          ${h[11].back?h[11].back.x:h[7].x+Math.max(h[11].offset.x,-h[4].width/h[6]+h[0])}px,
          ${h[11].back?h[11].back.y:h[7].y+Math.max(h[11].offset.y,-h[5]+h[0])}px, 0)`)&&set_style(e,"transform",t),m[0]&81&&n!==(n=`${h[4].width/h[6]-h[0]}px`)&&set_style(e,"width",n),m[0]&33&&s!==(s=`${h[5]-h[0]}px`)&&set_style(e,"height",s)},i(h){a||(transition_in(f,h),a=!0)},o(h){transition_out(f,h),a=!1},d(h){h&&detach(e),f&&f.d(h)}}}function create_default_slot$1(r){var s;let e,t,n=((s=r[11])==null?void 0:s.owner)===r[3]&&create_if_block_1$2(r);return{c(){n&&n.c(),e=empty$1()},l(a){n&&n.l(a),e=empty$1()},m(a,c){n&&n.m(a,c),insert_hydration(a,e,c),t=!0},p(a,c){var f;((f=a[11])==null?void 0:f.owner)===a[3]?n?(n.p(a,c),c[0]&2056&&transition_in(n,1)):(n=create_if_block_1$2(a),n.c(),transition_in(n,1),n.m(e.parentNode,e)):n&&(group_outros(),transition_out(n,1,1,()=>{n=null}),check_outros())},i(a){t||(transition_in(n),t=!0)},o(a){transition_out(n),t=!1},d(a){a&&detach(e),n&&n.d(a)}}}function create_fragment$4(r){let e,t,n=[],s=new Map_1,a=`translate3d(0,${Math.ceil(r[8]/r[6])*r[5]}px,0)`,c=`${r[0]}px`,f,h=`${r[10]}px`,m,N,g,C=ensure_array_like(r[14]);const k=p=>p[12][(p[8]+p[54])%p[9]]??p[54];for(let p=0;p<C.length;p+=1){let b=get_each_context(r,C,p),y=k(b);s.set(y,n[p]=create_each_block(y,b))}let O=r[2]&&create_if_block$3(r);return{c(){e=element("div"),t=element("div");for(let p=0;p<n.length;p+=1)n[p].c();f=space(),O&&O.c(),this.h()},l(p){e=claim_element(p,"DIV",{class:!0});var b=children(e);t=claim_element(b,"DIV",{class:!0});var y=children(t);for(let _=0;_<n.length;_+=1)n[_].l(y);y.forEach(detach),f=claim_space(b),O&&O.l(b),b.forEach(detach),this.h()},h(){attr(t,"class","grid auto-rows-max will-change-transform contain-layout"),toggle_class(t,"pointer-events-none",!!r[11]),set_style(t,"transform",a),set_style(t,"grid-template-columns",r[13]),set_style(t,"gap",c),attr(e,"class","shrink-0 contain-[size_layout]"),set_style(e,"height",h)},m(p,b){insert_hydration(p,e,b),append_hydration(e,t);for(let y=0;y<n.length;y+=1)n[y]&&n[y].m(t,null);r[41](t),append_hydration(e,f),O&&O.m(e,null),m=!0,N||(g=[listen(window_1,"dragstart",r[15]),listen(window_1,"dragend",r[16]),action_destroyer(drag.call(null,t,"hold")),action_destroyer(hold.call(null,t))],N=!0)},p(p,b){b[0]&23310|b[1]&2048&&(C=ensure_array_like(p[14]),group_outros(),n=update_keyed_each(n,b,k,1,p,C,s,t,outro_and_destroy_block,create_each_block,null,get_each_context),check_outros()),(!m||b[0]&2048)&&toggle_class(t,"pointer-events-none",!!p[11]),b[0]&352&&a!==(a=`translate3d(0,${Math.ceil(p[8]/p[6])*p[5]}px,0)`)&&set_style(t,"transform",a),b[0]&8192&&set_style(t,"grid-template-columns",p[13]),b[0]&1&&c!==(c=`${p[0]}px`)&&set_style(t,"gap",c),p[2]?O?(O.p(p,b),b[0]&4&&transition_in(O,1)):(O=create_if_block$3(p),O.c(),transition_in(O,1),O.m(e,null)):O&&(group_outros(),transition_out(O,1,1,()=>{O=null}),check_outros()),b[0]&1024&&h!==(h=`${p[10]}px`)&&set_style(e,"height",h)},i(p){if(!m){for(let b=0;b<C.length;b+=1)transition_in(n[b]);transition_in(O),m=!0}},o(p){for(let b=0;b<n.length;b+=1)transition_out(n[b]);transition_out(O),m=!1},d(p){p&&detach(e);for(let b=0;b<n.length;b+=1)n[b].d();r[41](null),O&&O.d(),N=!1,run_all(g)}}}let transfer=writable(null);function instance$5(r,e,t){let n,s,a,c,f,h,m,N,g,C,k,O,p,b,y,_,R,U,$,W;component_subscribe(r,transfer,V=>t(11,W=V));let{$$slots:J={},$$scope:ce}=e;const H=createEventDispatcher();let{gap:z=0}=e,{items:Q}=e,{move:L=!1}=e,{fixed:X=!1}=e,{overthrow:Z=1}=e,{prerender:oe=1}=e,{columns:he=1}=e,{key:M=V=>V}=e,{animate:ie=!1}=e,{sortable:Me=!1}=e,{container:Ee=void 0}=e,fe=null,tt={x:0,y:0},Fe=new DOMRect,qe=new DOMRect,Ue=!0,Ct=1,De=0,hr=0;function On(V){!C&&V.length&&tick().then(qt);const ae=new Map,ke=Array.from({length:N}),Re=new Set(g);for(let $e=0;$e<V.length;$e++){const Kt=M(V[$e]);if(Kt==null||(ae.set(Kt,$e),$e<f||$e>=h))continue;const ct=C==null?void 0:C.get(Kt);if(ct==null||ct<f||ct>=h||(ke[$e%N]=g[ct%N],Re.delete(g[ct%N]),ct===$e||!ie)||(W==null?void 0:W.owner)===fe&&Kt===(W==null?void 0:W.key))continue;const li=~~(ct/De)-~~($e/De),ci=~~(ct%De)-~~($e%De);ui(ct,ci,li)}const ht=[...Re];return t(12,g=ke.map($e=>$e??ht.shift())),ae}function ui(V,ae,ke){const Re=fe==null?void 0:fe.children.item(V-f),ht=[`translate3d(${ae*100}%,${ke*100}%,0)`,"translate3d(0,0,0)"];Re==null||Re.animate({transform:ht,zIndex:["100","100"]},{easing:"ease",composite:"accumulate",duration:k})}function qt(){var Re;if(!Ee||!fe)return;t(4,qe=(Re=fe.parentElement)==null?void 0:Re.getBoundingClientRect()),t(26,Fe=Ee.getBoundingClientRect()),t(4,qe.y+=tt.y,qe),t(28,hr=qe.y-Fe.y-Fe.height/2),t(4,qe.width+=z,qe);const V=fe.firstElementChild;if(!V)return;const{width:ae,height:ke}=V.getBoundingClientRect();!ae||!ke||(t(6,De=~~(qe.width/(ae+z))),t(5,Ct=ke+z))}let Rt,Y,pe={x:0,y:0};async function Tn({target:V}){if(qt(),await tick(),!Me||!fe||!V||W||V.parentElement!==fe||Q[$]==null||M(Q[$])==null)return;Y=$,Rt=L?-1:Y;const ae=V.getBoundingClientRect();ae.x-=pe.x,ae.y-=pe.y,set_store_value(transfer,W={group:Me===!0?fe:Me,key:M(Q[$]),data:Q[$],owner:fe,offset:ae},W)}function jt(V,ae=!1){if(!Me||!W||X||M(Q[V])==null)return;if(!Number.isInteger(V)){Rt!=null&&W.owner!==fe&&(jt(Rt,!0),Rt=void 0);return}if(M(Q[V])===W.key)return;V<0&&!Q.length&&(V=0);const ke=Q.findIndex(Re=>M(Re)===(W==null?void 0:W.key));ke!==V&&(!ae&&Rt==null&&(Rt=ke,Y=ke),~ke&&Q.splice(ke,1),~V&&Q.splice(V,0,W.data),requestAnimationFrame(()=>t(17,Q))),!ae&&fe&&set_store_value(transfer,W.owner=fe,W)}async function ve(){if(!Me||!W||Y==null)return;const V=Q.findIndex(ae=>M(ae)===(W==null?void 0:W.key));if(W.owner===fe&&~V){const ae=fe.children.item(V-f);ae&&(set_store_value(transfer,W.back=ae.getBoundingClientRect(),W),set_store_value(transfer,W.group=Math.random().toString(),W),await new Promise(ke=>setTimeout(ke,150)))}if(Y!==V){const ae=W.data,ke=Q[V-1],Re=(+!!~Y<<1)+ +!!~V,ht=[void 0,"push","purge","rearrange"][Re];ht&&H("edit",{action:ht,index:V,after:ke,item:ae})}Y=void 0,Rt=void 0,W.owner===fe&&set_store_value(transfer,W=null,W)}onMount(()=>{function V(Re){const ht=Re.currentTarget;t(25,tt.x=ht.scrollLeft,tt),t(25,tt.y=ht.scrollTop,tt)}Ee||t(18,Ee=getScrollParent(fe));const ae=Me&&position$1.subscribe(Re=>t(7,pe=Re));Ee.addEventListener("scroll",V,{passive:!0}),Ee.addEventListener("resize",qt);const{destroy:ke}=resize(Ee);return t(27,Ue=!1),()=>{Ee==null||Ee.removeEventListener("scroll",V),Ee==null||Ee.removeEventListener("resize",qt),ae&&ae(),ke()}});function lt(V){binding_callbacks[V?"unshift":"push"](()=>{fe=V,t(3,fe)})}return r.$$set=V=>{"gap"in V&&t(0,z=V.gap),"items"in V&&t(17,Q=V.items),"move"in V&&t(19,L=V.move),"fixed"in V&&t(20,X=V.fixed),"overthrow"in V&&t(21,Z=V.overthrow),"prerender"in V&&t(22,oe=V.prerender),"columns"in V&&t(23,he=V.columns),"key"in V&&t(1,M=V.key),"animate"in V&&t(24,ie=V.animate),"sortable"in V&&t(2,Me=V.sortable),"container"in V&&t(18,Ee=V.container),"$$scope"in V&&t(42,ce=V.$$scope)},r.$$.update=()=>{r.$$.dirty[0]&67108960&&t(38,n=Math.ceil(Fe.height/Ct)*De),r.$$.dirty[0]&96|r.$$.dirty[1]&128&&t(39,s=n/De*Ct),r.$$.dirty[0]&131072|r.$$.dirty[1]&128&&t(36,a=Math.max(Math.ceil(Q.length/n)-2,1)),r.$$.dirty[0]&301989888|r.$$.dirty[1]&288&&t(37,c=minmax(~~((tt.y-hr)/s),1,a)),r.$$.dirty[0]&2097152|r.$$.dirty[1]&192&&t(8,f=Math.max(c-Z,0)*n),r.$$.dirty[0]&6291456|r.$$.dirty[1]&192&&t(35,h=Math.max((c+Z+1)*n,oe)),r.$$.dirty[0]&131328|r.$$.dirty[1]&16&&t(14,m=Q.slice(f,h)),r.$$.dirty[0]&2097152|r.$$.dirty[1]&128&&t(9,N=(Z*2+1)*n),r.$$.dirty[0]&512&&t(12,g=Array.from({length:N}).map((V,ae)=>ae)),r.$$.dirty[0]&131072&&(C=On(Q)),r.$$.dirty[0]&16777216&&(k=ie===!0?300:ie||0),r.$$.dirty[0]&131169&&t(10,O=Math.ceil(Q.length/De)*Ct-z),r.$$.dirty[0]&8388608&&t(13,p=Number.isInteger(he)?`repeat(${he},1fr)`:`repeat(auto-fill,minmax(min(100%,${he}),1fr))`),r.$$.dirty[0]&1024&&Number.isFinite(O)&&(requestAnimationFrame(qt),t(27,Ue=!1)),r.$$.dirty[0]&134217728|r.$$.dirty[1]&96&&!Ue&&c===a&&(H("end"),t(27,Ue=!0)),r.$$.dirty[0]&12&&t(30,b=Me===!0?fe:Me),r.$$.dirty[0]&100663441&&t(34,y=minmax(pe.y+z/2,Fe.top,Fe.bottom,NaN)+tt.y-qe.y),r.$$.dirty[0]&33554577&&t(33,_=minmax(pe.x+z/2,qe.left,qe.right-z-1,NaN)+tt.x-qe.x),r.$$.dirty[0]&32|r.$$.dirty[1]&8&&t(32,R=Math.floor(y/Ct)),r.$$.dirty[0]&80|r.$$.dirty[1]&4&&t(31,U=Math.floor(_/(qe.width/De))),r.$$.dirty[0]&131136|r.$$.dirty[1]&3&&t(29,$=minmax(R*De+U,0,Q.length-1)),r.$$.dirty[0]&1610614784&&(W==null?void 0:W.group)===b&&jt($)},[z,M,Me,fe,qe,Ct,De,pe,f,N,O,W,g,p,m,Tn,ve,Q,Ee,L,X,Z,oe,he,ie,tt,Fe,Ue,hr,$,b,U,R,_,y,h,a,c,n,s,J,lt,ce]}class Virtual extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$5,create_fragment$4,safe_not_equal,{gap:0,items:17,move:19,fixed:20,overthrow:21,prerender:22,columns:23,key:1,animate:24,sortable:2,container:18},null,[-1,-1])}}const get_after_slot_changes=r=>({}),get_after_slot_context=r=>({}),get_before_slot_changes=r=>({}),get_before_slot_context=r=>({});function create_if_block_1$1(r){let e,t;const n=r[9].before,s=create_slot(n,r,r[8],get_before_slot_context);return{c(){e=element("div"),s&&s.c(),this.h()},l(a){e=claim_element(a,"DIV",{class:!0});var c=children(e);s&&s.l(c),c.forEach(detach),this.h()},h(){attr(e,"class","z-20 flex items-center")},m(a,c){insert_hydration(a,e,c),s&&s.m(e,null),t=!0},p(a,c){s&&s.p&&(!t||c&256)&&update_slot_base(s,n,a,a[8],t?get_slot_changes(n,a[8],c,get_before_slot_changes):get_all_dirty_from_scope(a[8]),get_before_slot_context)},i(a){t||(transition_in(s,a),t=!0)},o(a){transition_out(s,a),t=!1},d(a){a&&detach(e),s&&s.d(a)}}}function create_if_block$2(r){let e;return{c(){e=element("hr"),this.h()},l(t){e=claim_element(t,"HR",{"aria-hidden":!0,class:!0}),this.h()},h(){attr(e,"aria-hidden",""),attr(e,"class","absolute bottom-0 h-[1px] w-full border-none bg-content/10 group-last-of-type:opacity-0")},m(t,n){insert_hydration(t,e,n)},d(t){t&&detach(e)}}}function create_dynamic_element(r){let e,t,n,s,a,c,f,h,m,N,g,C,k,O,p,b,y,_,R,U,$,W,J,ce,H=r[7].before&&create_if_block_1$1(r);const z=r[9].default,Q=create_slot(z,r,r[8],null);let L=r[2]&&(r[1]||r[0])&&create_if_block$2();O=new Icon({props:{name:"circle"}}),y=new Icon({props:{name:"target"}});const X=r[9].after,Z=create_slot(X,r,r[8],get_after_slot_context);let oe=[{role:U=r[5]?"link":"button"},{tabindex:"0"},{href:r[5]},{draggable:"false"},{class:$="group relative z-10 flex w-full items-center gap-4 overflow-hidden px-4 outline-2 -outline-offset-2 outline-primary-600 contain-inline-size focus-visible:outline "+(r[4]?"cursor-pointer touch-manipulation select-none "+(r[2]?"":"transition-transform active:scale-95"):"")+" "+(r[0]?"focus-visible:z-50":r[1]?"rounded-lg py-1 focus-visible:z-50":"rounded-2xl py-4")+" "+(r[2]?"bg-surface":"bg-surface-100 shadow-[0_0_20px_-4px] shadow-black/20 dark:shadow-none")}],he={};for(let M=0;M<oe.length;M+=1)he=assign$1(he,oe[M]);return{c(){e=element(r[4]?r[5]?"a":"button":"article"),t=element("div"),n=space(),s=element("div"),c=space(),H&&H.c(),f=space(),h=element("div"),Q&&Q.c(),m=space(),L&&L.c(),g=space(),C=element("div"),k=element("div"),create_component(O.$$.fragment),p=space(),b=element("div"),create_component(y.$$.fragment),_=space(),R=element("div"),Z&&Z.c(),this.h()},l(M){e=claim_element(M,((r[4]?r[5]?"a":"button":"article")||"null").toUpperCase(),{role:!0,tabindex:!0,href:!0,draggable:!0,class:!0});var ie=children(e);t=claim_element(ie,"DIV",{"aria-hidden":!0,class:!0}),children(t).forEach(detach),n=claim_space(ie),s=claim_element(ie,"DIV",{"aria-hidden":!0,class:!0}),children(s).forEach(detach),c=claim_space(ie),H&&H.l(ie),f=claim_space(ie),h=claim_element(ie,"DIV",{class:!0});var Me=children(h);Q&&Q.l(Me),m=claim_space(Me),L&&L.l(Me),Me.forEach(detach),g=claim_space(ie),C=claim_element(ie,"DIV",{class:!0});var Ee=children(C);k=claim_element(Ee,"DIV",{class:!0});var fe=children(k);claim_component(O.$$.fragment,fe),fe.forEach(detach),p=claim_space(Ee),b=claim_element(Ee,"DIV",{class:!0});var tt=children(b);claim_component(y.$$.fragment,tt),tt.forEach(detach),_=claim_space(Ee),R=claim_element(Ee,"DIV",{class:!0});var Fe=children(R);Z&&Z.l(Fe),Fe.forEach(detach),Ee.forEach(detach),ie.forEach(detach),this.h()},h(){attr(t,"aria-hidden",""),attr(t,"class","pointer-events-none absolute inset-0 -z-10 bg-primary-200/30 opacity-0 transition-opacity"),toggle_class(t,"opacity-100",r[6]===!0),attr(s,"aria-hidden",""),attr(s,"class",a="pointer-events-none absolute inset-0 z-0 bg-highlight opacity-0 "+(r[4]?"group-hover:opacity-30 "+(r[2]?"dark:group-hover:opacity-50":"dark:group-hover:opacity-10"):"")),attr(h,"class",N="z-10 grid w-full grid-cols-1 items-baseline overflow-hidden contain-inline-size "+(r[1]||r[0]?"justify-start gap-0.5":"place-items-center justify-center gap-2")+" "+((r[1]||r[0])&&r[3]?"lg:auto-cols-fr lg:grid-flow-col lg:gap-4":"")),attr(k,"class","flex justify-center text-primary-600 opacity-0 transition-opacity"),toggle_class(k,"opacity-100",r[6]),attr(b,"class","flex scale-0 justify-center text-primary-600 transition-transform"),toggle_class(b,"scale-100",r[6]===!0),attr(R,"class","opacity-0 transition-opacity"),toggle_class(R,"opacity-100",!r[6]),attr(C,"class","z-20 grid items-center [&>*]:col-start-1 [&>*]:row-start-1"),set_dynamic_element_data(r[4]?r[5]?"a":"button":"article")(e,he)},m(M,ie){insert_hydration(M,e,ie),append_hydration(e,t),append_hydration(e,n),append_hydration(e,s),append_hydration(e,c),H&&H.m(e,null),append_hydration(e,f),append_hydration(e,h),Q&&Q.m(h,null),append_hydration(h,m),L&&L.m(h,null),append_hydration(e,g),append_hydration(e,C),append_hydration(C,k),mount_component(O,k,null),append_hydration(C,p),append_hydration(C,b),mount_component(y,b,null),append_hydration(C,_),append_hydration(C,R),Z&&Z.m(R,null),W=!0,J||(ce=[listen(e,"click",r[10]),listen(e,"contextmenu",r[11])],J=!0)},p(M,ie){(!W||ie&64)&&toggle_class(t,"opacity-100",M[6]===!0),(!W||ie&20&&a!==(a="pointer-events-none absolute inset-0 z-0 bg-highlight opacity-0 "+(M[4]?"group-hover:opacity-30 "+(M[2]?"dark:group-hover:opacity-50":"dark:group-hover:opacity-10"):"")))&&attr(s,"class",a),M[7].before?H?(H.p(M,ie),ie&128&&transition_in(H,1)):(H=create_if_block_1$1(M),H.c(),transition_in(H,1),H.m(e,f)):H&&(group_outros(),transition_out(H,1,1,()=>{H=null}),check_outros()),Q&&Q.p&&(!W||ie&256)&&update_slot_base(Q,z,M,M[8],W?get_slot_changes(z,M[8],ie,null):get_all_dirty_from_scope(M[8]),null),M[2]&&(M[1]||M[0])?L||(L=create_if_block$2(),L.c(),L.m(h,null)):L&&(L.d(1),L=null),(!W||ie&11&&N!==(N="z-10 grid w-full grid-cols-1 items-baseline overflow-hidden contain-inline-size "+(M[1]||M[0]?"justify-start gap-0.5":"place-items-center justify-center gap-2")+" "+((M[1]||M[0])&&M[3]?"lg:auto-cols-fr lg:grid-flow-col lg:gap-4":"")))&&attr(h,"class",N),(!W||ie&64)&&toggle_class(k,"opacity-100",M[6]),(!W||ie&64)&&toggle_class(b,"scale-100",M[6]===!0),Z&&Z.p&&(!W||ie&256)&&update_slot_base(Z,X,M,M[8],W?get_slot_changes(X,M[8],ie,get_after_slot_changes):get_all_dirty_from_scope(M[8]),get_after_slot_context),(!W||ie&64)&&toggle_class(R,"opacity-100",!M[6]),set_dynamic_element_data(M[4]?M[5]?"a":"button":"article")(e,he=get_spread_update(oe,[(!W||ie&32&&U!==(U=M[5]?"link":"button"))&&{role:U},{tabindex:"0"},(!W||ie&32)&&{href:M[5]},{draggable:"false"},(!W||ie&23&&$!==($="group relative z-10 flex w-full items-center gap-4 overflow-hidden px-4 outline-2 -outline-offset-2 outline-primary-600 contain-inline-size focus-visible:outline "+(M[4]?"cursor-pointer touch-manipulation select-none "+(M[2]?"":"transition-transform active:scale-95"):"")+" "+(M[0]?"focus-visible:z-50":M[1]?"rounded-lg py-1 focus-visible:z-50":"rounded-2xl py-4")+" "+(M[2]?"bg-surface":"bg-surface-100 shadow-[0_0_20px_-4px] shadow-black/20 dark:shadow-none")))&&{class:$}]))},i(M){W||(transition_in(H),transition_in(Q,M),transition_in(O.$$.fragment,M),transition_in(y.$$.fragment,M),transition_in(Z,M),W=!0)},o(M){transition_out(H),transition_out(Q,M),transition_out(O.$$.fragment,M),transition_out(y.$$.fragment,M),transition_out(Z,M),W=!1},d(M){M&&detach(e),H&&H.d(),Q&&Q.d(M),L&&L.d(),destroy_component(O),destroy_component(y),Z&&Z.d(M),J=!1,run_all(ce)}}}function create_fragment$3(r){let e=r[4]?r[5]?"a":"button":"article",t,n,s=(r[4]?r[5]?"a":"button":"article")&&create_dynamic_element(r);return{c(){s&&s.c(),t=empty$1()},l(a){s&&s.l(a),t=empty$1()},m(a,c){s&&s.m(a,c),insert_hydration(a,t,c),n=!0},p(a,[c]){!a[4]||a[5],e?safe_not_equal(e,a[4]?a[5]?"a":"button":"article")?(s.d(1),s=create_dynamic_element(a),e=a[4]?a[5]?"a":"button":"article",s.c(),s.m(t.parentNode,t)):s.p(a,c):(s=create_dynamic_element(a),e=a[4]?a[5]?"a":"button":"article",s.c(),s.m(t.parentNode,t))},i(a){n||(transition_in(s,a),n=!0)},o(a){transition_out(s,a),n=!1},d(a){a&&detach(t),s&&s.d(a)}}}function instance$4(r,e,t){let{$$slots:n={},$$scope:s}=e;const a=compute_slots(n);let{xs:c=!1}=e,{sm:f=!1}=e,{flat:h=!1}=e,{flow:m=!1}=e,{interactive:N=!1}=e,{href:g=void 0}=e,{selected:C=!1}=e;function k(p){bubble.call(this,r,p)}function O(p){bubble.call(this,r,p)}return r.$$set=p=>{"xs"in p&&t(0,c=p.xs),"sm"in p&&t(1,f=p.sm),"flat"in p&&t(2,h=p.flat),"flow"in p&&t(3,m=p.flow),"interactive"in p&&t(4,N=p.interactive),"href"in p&&t(5,g=p.href),"selected"in p&&t(6,C=p.selected),"$$scope"in p&&t(8,s=p.$$scope)},[c,f,h,m,N,g,C,a,s,n,k,O]}class Card extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$4,create_fragment$3,safe_not_equal,{xs:0,sm:1,flat:2,flow:3,interactive:4,href:5,selected:6})}}function create_fragment$2(r){let e,t,n;const s=r[6].default,a=create_slot(s,r,r[5],null);return{c(){e=element("span"),a&&a.c(),this.h()},l(c){e=claim_element(c,"SPAN",{class:!0});var f=children(e);a&&a.l(f),f.forEach(detach),this.h()},h(){attr(e,"class",t="w-max max-w-full overflow-hidden text-ellipsis whitespace-nowrap rounded-md text-left [&>*]:align-bottom "+(r[1]?"animate-pulse bg-highlight text-transparent":"")+" "+(r[2]?"font-medium":"font-normal")),toggle_class(e,"text-content-200",r[0]),toggle_class(e,"ml-4",r[3]),toggle_class(e,"text-sm",r[4])},m(c,f){insert_hydration(c,e,f),a&&a.m(e,null),n=!0},p(c,[f]){a&&a.p&&(!n||f&32)&&update_slot_base(a,s,c,c[5],n?get_slot_changes(s,c[5],f,null):get_all_dirty_from_scope(c[5]),null),(!n||f&6&&t!==(t="w-max max-w-full overflow-hidden text-ellipsis whitespace-nowrap rounded-md text-left [&>*]:align-bottom "+(c[1]?"animate-pulse bg-highlight text-transparent":"")+" "+(c[2]?"font-medium":"font-normal")))&&attr(e,"class",t),(!n||f&7)&&toggle_class(e,"text-content-200",c[0]),(!n||f&14)&&toggle_class(e,"ml-4",c[3]),(!n||f&22)&&toggle_class(e,"text-sm",c[4])},i(c){n||(transition_in(a,c),n=!0)},o(c){transition_out(a,c),n=!1},d(c){c&&detach(e),a&&a.d(c)}}}function instance$3(r,e,t){let{$$slots:n={},$$scope:s}=e,{secondary:a=!1}=e,{loading:c=!1}=e,{accent:f=!1}=e,{indent:h=!1}=e,{sm:m=!1}=e;return r.$$set=N=>{"secondary"in N&&t(0,a=N.secondary),"loading"in N&&t(1,c=N.loading),"accent"in N&&t(2,f=N.accent),"indent"in N&&t(3,h=N.indent),"sm"in N&&t(4,m=N.sm),"$$scope"in N&&t(5,s=N.$$scope)},[a,c,f,h,m,s,n]}class Text extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$3,create_fragment$2,safe_not_equal,{secondary:0,loading:1,accent:2,indent:3,sm:4})}}function create_if_block_1(r){let e;const t=r[7].default,n=create_slot(t,r,r[6],null);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,a){n&&n.p&&(!e||a&64)&&update_slot_base(n,t,s,s[6],e?get_slot_changes(t,s[6],a,null):get_all_dirty_from_scope(s[6]),null)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}function create_if_block$1(r){let e,t,n,s,a,c;return{c(){e=element("img"),this.h()},l(f){e=claim_element(f,"IMG",{alt:!0,src:!0,class:!0,loading:!0,width:!0,height:!0,draggable:!0}),this.h()},h(){attr(e,"alt",r[3]),src_url_equal(e.src,t=r[2]<100/devicePixelRatio?r[0]:r[1])||attr(e,"src",t),attr(e,"class","opacity-0 transition-opacity duration-500"),attr(e,"loading","lazy"),attr(e,"width",n=r[2]+"px"),attr(e,"height",s=r[2]+"px"),attr(e,"draggable","false"),toggle_class(e,"opacity-100",r[5]==="ok")},m(f,h){insert_hydration(f,e,h),r[8](e),a||(c=[listen(e,"load",r[9]),listen(e,"error",r[10])],a=!0)},p(f,h){h&8&&attr(e,"alt",f[3]),h&7&&!src_url_equal(e.src,t=f[2]<100/devicePixelRatio?f[0]:f[1])&&attr(e,"src",t),h&4&&n!==(n=f[2]+"px")&&attr(e,"width",n),h&4&&s!==(s=f[2]+"px")&&attr(e,"height",s),h&32&&toggle_class(e,"opacity-100",f[5]==="ok")},i:noop$2,o:noop$2,d(f){f&&detach(e),r[8](null),a=!1,run_all(c)}}}function create_fragment$1(r){let e,t,n,s,a=`${r[2]}px`,c=`${r[2]}px`,f;const h=[create_if_block$1,create_if_block_1],m=[];function N(g,C){return g[1]&&g[5]!=="error"?0:g[5]==="error"?1:-1}return~(t=N(r))&&(n=m[t]=h[t](r)),{c(){e=element("div"),n&&n.c(),this.h()},l(g){e=claim_element(g,"DIV",{class:!0});var C=children(e);n&&n.l(C),C.forEach(detach),this.h()},h(){attr(e,"class",s="overflow-hidden "+(r[2]>200?"rounded-2xl":"rounded")+" bg-highlight-100"),toggle_class(e,"animate-pulse",r[5]==="loading"),set_style(e,"height",a),set_style(e,"width",c)},m(g,C){insert_hydration(g,e,C),~t&&m[t].m(e,null),f=!0},p(g,[C]){let k=t;t=N(g),t===k?~t&&m[t].p(g,C):(n&&(group_outros(),transition_out(m[k],1,1,()=>{m[k]=null}),check_outros()),~t?(n=m[t],n?n.p(g,C):(n=m[t]=h[t](g),n.c()),transition_in(n,1),n.m(e,null)):n=null),(!f||C&4&&s!==(s="overflow-hidden "+(g[2]>200?"rounded-2xl":"rounded")+" bg-highlight-100"))&&attr(e,"class",s),(!f||C&36)&&toggle_class(e,"animate-pulse",g[5]==="loading"),C&4&&a!==(a=`${g[2]}px`)&&set_style(e,"height",a),C&4&&c!==(c=`${g[2]}px`)&&set_style(e,"width",c)},i(g){f||(transition_in(n),f=!0)},o(g){transition_out(n),f=!1},d(g){g&&detach(e),~t&&m[t].d()}}}function instance$2(r,e,t){let n,{$$slots:s={},$$scope:a}=e,{thumbnail:c=void 0}=e,{src:f=void 0}=e,{size:h=48}=e,{alt:m=""}=e,N;onMount(()=>(N!=null&&N.complete&&t(4,N.style.opacity="1",N),!1));function g(O){binding_callbacks[O?"unshift":"push"](()=>{N=O,t(4,N)})}const C=()=>t(5,n="ok"),k=()=>t(5,n="error");return r.$$set=O=>{"thumbnail"in O&&t(0,c=O.thumbnail),"src"in O&&t(1,f=O.src),"size"in O&&t(2,h=O.size),"alt"in O&&t(3,m=O.alt),"$$scope"in O&&t(6,a=O.$$scope)},r.$$.update=()=>{r.$$.dirty&2&&t(5,n=f===""||f===null?"error":"loading")},[c,f,h,m,N,n,a,s,g,C,k]}class Image extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$2,create_fragment$1,safe_not_equal,{thumbnail:0,src:1,size:2,alt:3})}}function capitalize(r,e=!0){return r&&(e?r.replace(/\b\w/g,t=>t.toUpperCase()):r.replace(/\b\w/,t=>t.toUpperCase()))}function clean(r){return r.normalize().trim().toLowerCase().replace(/\s+/g," ")}const __vite_glob_0_0=`CREATE TRIGGER IF NOT EXISTS cascade_playlists_library
AFTER DELETE ON playlists
FOR EACH ROW
BEGIN
  DELETE FROM library WHERE playlist = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_library_tracks
AFTER DELETE ON library
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM library 
    WHERE track = OLD.track 
  UNION ALL SELECT 1 FROM playback
    WHERE track = OLD.track
  LIMIT 1
)
BEGIN
  DELETE FROM tracks WHERE id = OLD.track;
END;

CREATE TRIGGER IF NOT EXISTS cascade_playback_tracks
AFTER DELETE ON playback
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM library
    WHERE track = OLD.track
  UNION ALL SELECT 1 FROM playback
    WHERE track = OLD.track
  LIMIT 1
)
BEGIN
  DELETE FROM tracks WHERE id = OLD.track;
END;

CREATE TRIGGER IF NOT EXISTS cascade_tracks_albums
AFTER DELETE ON tracks
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM tracks WHERE album = OLD.album LIMIT 1
)
BEGIN
  DELETE FROM albums WHERE id = OLD.album;
END;

CREATE TRIGGER IF NOT EXISTS cascade_albums_attribution
AFTER DELETE ON albums
FOR EACH ROW
BEGIN
  DELETE FROM attribution WHERE album = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_attribution_artists
AFTER DELETE ON attribution
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM attribution
    WHERE artist = OLD.artist
)
BEGIN
  DELETE FROM artists WHERE id = OLD.artist;
END;

CREATE TRIGGER IF NOT EXISTS cascade_tracks_resources
AFTER DELETE ON tracks
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_albums_resources
AFTER DELETE ON albums
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
  DELETE FROM assets WHERE owner = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_artists_resources
AFTER DELETE ON artists
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
  DELETE FROM assets WHERE owner = OLD.id;
END;
`,__vite_glob_0_1=`CREATE VIRTUAL TABLE IF NOT EXISTS tracks_fts USING fts5 (
  title,
  album,
  artists,
  content='',
  tokenize='trigram'
);

CREATE VIRTUAL TABLE IF NOT EXISTS albums_fts USING fts5 (
  title,
  artists,
  content='',
  tokenize='trigram'
);

CREATE VIRTUAL TABLE IF NOT EXISTS artists_fts USING fts5 (
  title,
  content='',
  tokenize='trigram'
);

---------------------------- Artists Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_artists_insert AFTER INSERT ON artists BEGIN
  -- Update artists index
  INSERT INTO artists_fts(rowid,title) VALUES (NEW.id, NEW.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title,
      CASE WHEN EXISTS (SELECT 1 FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id) THEN albums.title ELSE NULL END,
      (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS fts_artists_update AFTER UPDATE OF title ON artists WHEN (OLD.title IS NOT NEW.title) BEGIN
  -- Update artists index
  INSERT INTO artists_fts(artists_fts,rowid,title) VALUES ('delete', OLD.id, OLD.title);
  INSERT INTO artists_fts(rowid,title) VALUES (NEW.id, NEW.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(CASE WHEN artists.id = OLD.id THEN OLD.title ELSE title END) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = OLD.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(CASE WHEN artists.id = OLD.id THEN OLD.title ELSE title END) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = OLD.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS fts_artists_delete BEFORE DELETE ON artists BEGIN
  -- Update artists index
  INSERT INTO artists_fts(artists_fts,rowid,title) VALUES ('delete', OLD.id, OLD.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = OLD.id;
END;

---------------------------- Albums Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_albums_insert AFTER INSERT ON albums BEGIN
  -- Update albums index
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT NEW.id, NEW.title, group_concat(artists.title)
    FROM attribution
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE attribution.album = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, NULL, NULL
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS albums_fts_update AFTER UPDATE OF title ON albums WHEN (OLD.title IS NOT NEW.title) BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', OLD.id, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
    WHERE attribution.album = OLD.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT NEW.id, NEW.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
    WHERE attribution.album = OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = OLD.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, NEW.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS albums_fts_delete BEFORE DELETE ON albums BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', OLD.id, OLD.title, group_concat(artists.title)
    FROM attribution
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE attribution.album = OLD.id
    GROUP BY OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = OLD.id;
END;

---------------------------- Attribution Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_attribution_insert AFTER INSERT ON attribution
  WHEN EXISTS (SELECT 1 FROM artists WHERE id = NEW.artist) AND EXISTS (SELECT 1 FROM albums WHERE id = NEW.album)
BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, NULL, NULL
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT  tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
END;

CREATE TRIGGER IF NOT EXISTS fts_attribution_delete BEFORE DELETE ON attribution BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = OLD.album AND attribution.artist = OLD.artist;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = OLD.album AND attribution.artist = OLD.artist;
END;

---------------------------- Tracks Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_tracks_insert AFTER INSERT ON tracks BEGIN
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT NEW.id, NEW.title, albums.title, group_concat(artists.title)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE albums.id = NEW.album;
END;

CREATE TRIGGER IF NOT EXISTS fts_tracks_update AFTER UPDATE OF title ON tracks WHEN (OLD.title IS NOT NEW.title) BEGIN
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', OLD.id, OLD.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
    WHERE albums.id = OLD.album;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT NEW.id, NEW.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
    WHERE albums.id = NEW.album;
END;

CREATE TRIGGER IF NOT EXISTS fts_tracks_delete BEFORE DELETE ON tracks BEGIN
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', OLD.id, OLD.title, albums.title, group_concat(artists.title)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE albums.id = OLD.album
    GROUP BY OLD.id;
END;`,__vite_glob_0_2=`INSERT OR IGNORE INTO devices VALUES (crsql_siteid(), -1, 0, 0, 0, 0);

CREATE VIEW IF NOT EXISTS queue AS
  WITH ordered AS
    (SELECT playback.*, row_number() OVER (
      ORDER BY
        CASE WHEN "direction" != 1 THEN "order" ELSE NULL END ASC,
        CASE WHEN "direction" = 1 THEN "order" ELSE NULL END DESC,
        CASE WHEN "direction" != 1 THEN "playback"."id" ELSE NULL END ASC,
        CASE WHEN "direction" = 1 THEN "playback"."id" ELSE NULL END DESC
    ) as position FROM devices INNER JOIN playback ON playback.device = devices.id
    WHERE devices.id = crsql_siteid())
  SELECT id, device, track, 
    (position - 
      (SELECT position FROM ordered WHERE id = (SELECT playback FROM devices WHERE id = device))
    ) as position
  FROM ordered;

CREATE TRIGGER IF NOT EXISTS playback_started
BEFORE INSERT ON playback
FOR EACH ROW
WHEN NEW.device = crsql_siteid()
BEGIN
  UPDATE devices SET playback = NEW.id WHERE id = NEW.device AND playback IS -1;
END;

CREATE TRIGGER IF NOT EXISTS playback_finised
BEFORE UPDATE OF progress ON devices
FOR EACH ROW
WHEN NEW.progress >= 1 AND NEW.id = crsql_siteid()
BEGIN
  INSERT INTO library SELECT ABS(RANDOM() % 4294967296), -1, track, UNIXEPOCH(), -1 FROM playback WHERE id = NEW.playback;
  UPDATE devices SET 
    playback = CASE WHEN NEW.repeat = 2 AND NOT EXISTS (SELECT 1 FROM queue WHERE position > 0)
      THEN IFNULL((SELECT id FROM queue LIMIT 1), playback)
      WHEN NEW.repeat = 1 THEN playback
      ELSE IFNULL((SELECT id FROM queue WHERE position = 1), playback)
    END,
    progress = 0
  WHERE id = NEW.id;
  SELECT RAISE(IGNORE);
END;

CREATE TRIGGER IF NOT EXISTS playback_backtracked
BEFORE UPDATE OF progress ON devices
FOR EACH ROW
WHEN NEW.progress < 0 AND NEW.id = crsql_siteid()
BEGIN
  UPDATE devices SET 
    playback = IFNULL((SELECT id FROM queue WHERE position = -1), playback),
    progress = 0
  WHERE id = NEW.id;
  SELECT RAISE(IGNORE);
END;

CREATE TRIGGER IF NOT EXISTS playback_shuffled
AFTER UPDATE OF direction ON devices
FOR EACH ROW
WHEN NEW.direction = 2 AND NEW.id = crsql_siteid()
BEGIN
  UPDATE playback SET "temp"="order" WHERE
    (SELECT id FROM queue WHERE position = 0) != id AND device = NEW.id;
  UPDATE playback SET
    "order"=(SELECT "order" FROM playback WHERE "temp" IS NULL)||trim(hex(randomblob(2)),'0')
  WHERE "temp" IS NOT NULL;
END;

CREATE TRIGGER IF NOT EXISTS playback_unshuffled
AFTER UPDATE OF direction ON devices
FOR EACH ROW
WHEN OLD.direction = 2 AND NEW.direction != 2 AND NEW.id = crsql_siteid()
BEGIN
  UPDATE playback SET
    "order"="temp",
    "temp"=NULL
  WHERE "temp" IS NOT NULL AND device = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS playback_purged
BEFORE DELETE ON playback
FOR EACH ROW
WHEN (OLD.id = (SELECT playback FROM devices WHERE id = crsql_siteid()))
BEGIN
  UPDATE devices SET 
    playback = (SELECT id FROM queue WHERE position = 1),
    progress = 0
  WHERE id = OLD.device;
END;`,__vite_glob_0_3=`INSERT OR IGNORE INTO playlists (id, title, "order", relevancy, shared, remote) VALUES
  (-1, 'Listened', 1, 0, NULL, NULL),
  (-2, 'Recommended', 1, -1, NULL, NULL),
  (-3, 'Blocked', 1, -1, NULL, NULL),
  (-4, 'Followed', 1, 0, NULL, NULL);`;function isUndefined(r){return typeof r>"u"||r===void 0}function isString(r){return typeof r=="string"}function isNumber(r){return typeof r=="number"}function isBoolean(r){return typeof r=="boolean"}function isNull(r){return r===null}function isDate(r){return r instanceof Date}function isBigInt(r){return typeof r=="bigint"}function isFunction(r){return typeof r=="function"}function isObject$2(r){return typeof r=="object"&&r!==null}function freeze(r){return Object.freeze(r)}function isReadonlyArray(r){return Array.isArray(r)}function noop$1(r){return r}const AlterTableNode=freeze({is(r){return r.kind==="AlterTableNode"},create(r){return freeze({kind:"AlterTableNode",table:r})},cloneWithTableProps(r,e){return freeze({...r,...e})},cloneWithColumnAlteration(r,e){return freeze({...r,columnAlterations:r.columnAlterations?[...r.columnAlterations,e]:[e]})}}),IdentifierNode=freeze({is(r){return r.kind==="IdentifierNode"},create(r){return freeze({kind:"IdentifierNode",name:r})}}),CreateIndexNode=freeze({is(r){return r.kind==="CreateIndexNode"},create(r){return freeze({kind:"CreateIndexNode",name:IdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})},cloneWithColumns(r,e){return freeze({...r,columns:[...r.columns||[],...e]})}}),CreateSchemaNode=freeze({is(r){return r.kind==="CreateSchemaNode"},create(r,e){return freeze({kind:"CreateSchemaNode",schema:IdentifierNode.create(r),...e})},cloneWith(r,e){return freeze({...r,...e})}}),ON_COMMIT_ACTIONS=["preserve rows","delete rows","drop"],CreateTableNode=freeze({is(r){return r.kind==="CreateTableNode"},create(r){return freeze({kind:"CreateTableNode",table:r,columns:freeze([])})},cloneWithColumn(r,e){return freeze({...r,columns:freeze([...r.columns,e])})},cloneWithConstraint(r,e){return freeze({...r,constraints:r.constraints?freeze([...r.constraints,e]):freeze([e])})},cloneWithFrontModifier(r,e){return freeze({...r,frontModifiers:r.frontModifiers?freeze([...r.frontModifiers,e]):freeze([e])})},cloneWithEndModifier(r,e){return freeze({...r,endModifiers:r.endModifiers?freeze([...r.endModifiers,e]):freeze([e])})},cloneWith(r,e){return freeze({...r,...e})}}),SchemableIdentifierNode=freeze({is(r){return r.kind==="SchemableIdentifierNode"},create(r){return freeze({kind:"SchemableIdentifierNode",identifier:IdentifierNode.create(r)})},createWithSchema(r,e){return freeze({kind:"SchemableIdentifierNode",schema:IdentifierNode.create(r),identifier:IdentifierNode.create(e)})}}),DropIndexNode=freeze({is(r){return r.kind==="DropIndexNode"},create(r,e){return freeze({kind:"DropIndexNode",name:SchemableIdentifierNode.create(r),...e})},cloneWith(r,e){return freeze({...r,...e})}}),DropSchemaNode=freeze({is(r){return r.kind==="DropSchemaNode"},create(r,e){return freeze({kind:"DropSchemaNode",schema:IdentifierNode.create(r),...e})},cloneWith(r,e){return freeze({...r,...e})}}),DropTableNode=freeze({is(r){return r.kind==="DropTableNode"},create(r,e){return freeze({kind:"DropTableNode",table:r,...e})},cloneWith(r,e){return freeze({...r,...e})}}),AliasNode=freeze({is(r){return r.kind==="AliasNode"},create(r,e){return freeze({kind:"AliasNode",node:r,alias:e})}}),TableNode=freeze({is(r){return r.kind==="TableNode"},create(r){return freeze({kind:"TableNode",table:SchemableIdentifierNode.create(r)})},createWithSchema(r,e){return freeze({kind:"TableNode",table:SchemableIdentifierNode.createWithSchema(r,e)})}});function isOperationNodeSource(r){return isObject$2(r)&&isFunction(r.toOperationNode)}function isExpression(r){return isObject$2(r)&&"expressionType"in r&&isOperationNodeSource(r)}function isAliasedExpression(r){return isObject$2(r)&&"expression"in r&&isString(r.alias)&&isOperationNodeSource(r)}const SelectModifierNode=freeze({is(r){return r.kind==="SelectModifierNode"},create(r){return freeze({kind:"SelectModifierNode",modifier:r})},createWithExpression(r){return freeze({kind:"SelectModifierNode",rawModifier:r})}}),AndNode=freeze({is(r){return r.kind==="AndNode"},create(r,e){return freeze({kind:"AndNode",left:r,right:e})}}),OrNode=freeze({is(r){return r.kind==="OrNode"},create(r,e){return freeze({kind:"OrNode",left:r,right:e})}}),OnNode=freeze({is(r){return r.kind==="OnNode"},create(r){return freeze({kind:"OnNode",on:r})},cloneWithOperation(r,e,t){return freeze({...r,on:e==="And"?AndNode.create(r.on,t):OrNode.create(r.on,t)})}}),JoinNode=freeze({is(r){return r.kind==="JoinNode"},create(r,e){return freeze({kind:"JoinNode",joinType:r,table:e,on:void 0})},createWithOn(r,e,t){return freeze({kind:"JoinNode",joinType:r,table:e,on:OnNode.create(t)})},cloneWithOn(r,e){return freeze({...r,on:r.on?OnNode.cloneWithOperation(r.on,"And",e):OnNode.create(e)})},cloneWithOrOn(r,e){return freeze({...r,on:r.on?OnNode.cloneWithOperation(r.on,"Or",e):OnNode.create(e)})}}),BinaryOperationNode=freeze({is(r){return r.kind==="BinaryOperationNode"},create(r,e,t){return freeze({kind:"BinaryOperationNode",leftOperand:r,operator:e,rightOperand:t})}}),RawNode=freeze({is(r){return r.kind==="RawNode"},create(r,e){return freeze({kind:"RawNode",sqlFragments:freeze(r),parameters:freeze(e)})},createWithSql(r){return RawNode.create([r],[])},createWithChild(r){return RawNode.create(["",""],[r])},createWithChildren(r){return RawNode.create(new Array(r.length+1).fill(""),r)}}),COMPARISON_OPERATORS=["=","==","!=","<>",">",">=","<","<=","in","not in","is","is not","like","not like","match","ilike","not ilike","@>","<@","?","?&","!<","!>","<=>","!~","~","~*","!~*","@@","@@@","!!","<->"],ARITHMETIC_OPERATORS=["+","-","*","/","%","^","&","|","#","<<",">>"],BINARY_OPERATORS=[...COMPARISON_OPERATORS,...ARITHMETIC_OPERATORS,"&&","||"],UNARY_FILTER_OPERATORS=["exists","not exists"],UNARY_OPERATORS=["not","-",...UNARY_FILTER_OPERATORS],OPERATORS=[...BINARY_OPERATORS,...UNARY_OPERATORS],OperatorNode=freeze({is(r){return r.kind==="OperatorNode"},create(r){return freeze({kind:"OperatorNode",operator:r})}});function isBinaryOperator(r){return isString(r)&&BINARY_OPERATORS.includes(r)}function isComparisonOperator(r){return isString(r)&&COMPARISON_OPERATORS.includes(r)}const ParensNode=freeze({is(r){return r.kind==="ParensNode"},create(r){return freeze({kind:"ParensNode",node:r})}}),ColumnNode=freeze({is(r){return r.kind==="ColumnNode"},create(r){return freeze({kind:"ColumnNode",column:IdentifierNode.create(r)})}}),SelectAllNode=freeze({is(r){return r.kind==="SelectAllNode"},create(){return freeze({kind:"SelectAllNode"})}}),ReferenceNode=freeze({is(r){return r.kind==="ReferenceNode"},create(r,e){return freeze({kind:"ReferenceNode",table:r,column:e})},createSelectAll(r){return freeze({kind:"ReferenceNode",table:r,column:SelectAllNode.create()})}}),OrderByItemNode=freeze({is(r){return r.kind==="OrderByItemNode"},create(r,e){return freeze({kind:"OrderByItemNode",orderBy:r,direction:e})}});function isOrderByDirection(r){return r==="asc"||r==="desc"}function parseOrderBy(r,e){return OrderByItemNode.create(parseOrderByExpression(r),parseOrderByDirectionExpression(e))}function parseOrderByExpression(r){return parseReferenceExpression(r)}function parseOrderByDirectionExpression(r){if(r)return r==="asc"||r==="desc"?RawNode.createWithSql(r):r.toOperationNode()}function parseSimpleReferenceExpression(r){return isString(r)?parseStringReference(r):r.toOperationNode()}function parseReferenceExpressionOrList(r){return isReadonlyArray(r)?r.map(e=>parseReferenceExpression(e)):[parseReferenceExpression(r)]}function parseReferenceExpression(r){return isExpressionOrFactory(r)?parseExpression(r):parseSimpleReferenceExpression(r)}function parseStringReference(r){const e=".";if(r.includes(e)){const t=r.split(e).map(trim$2);if(t.length===3)return parseStringReferenceWithTableAndSchema(t);if(t.length===2)return parseStringReferenceWithTable(t);throw new Error(`invalid column reference ${r}`)}else return ColumnNode.create(r)}function parseAliasedStringReference(r){const e=" as ";if(r.includes(e)){const[t,n]=r.split(e).map(trim$2);return AliasNode.create(parseStringReference(t),IdentifierNode.create(n))}else return parseStringReference(r)}function parseColumnName(r){return ColumnNode.create(r)}function parseOrderedColumnName(r){const e=" ";if(r.includes(e)){const[t,n]=r.split(e).map(trim$2);if(!isOrderByDirection(n))throw new Error(`invalid order direction "${n}" next to "${t}"`);return parseOrderBy(t,n)}else return parseColumnName(r)}function parseStringReferenceWithTableAndSchema(r){const[e,t,n]=r;return ReferenceNode.create(TableNode.createWithSchema(e,t),ColumnNode.create(n))}function parseStringReferenceWithTable(r){const[e,t]=r;return ReferenceNode.create(TableNode.create(e),ColumnNode.create(t))}function trim$2(r){return r.trim()}const PrimitiveValueListNode=freeze({is(r){return r.kind==="PrimitiveValueListNode"},create(r){return freeze({kind:"PrimitiveValueListNode",values:freeze([...r])})}}),ValueListNode=freeze({is(r){return r.kind==="ValueListNode"},create(r){return freeze({kind:"ValueListNode",values:freeze(r)})}}),ValueNode=freeze({is(r){return r.kind==="ValueNode"},create(r){return freeze({kind:"ValueNode",value:r})},createImmediate(r){return freeze({kind:"ValueNode",value:r,immediate:!0})}});function parseValueExpressionOrList(r){return isReadonlyArray(r)?parseValueExpressionList(r):parseValueExpression(r)}function parseValueExpression(r){return isExpressionOrFactory(r)?parseExpression(r):ValueNode.create(r)}function parseValueExpressionList(r){return r.some(isExpressionOrFactory)?ValueListNode.create(r.map(e=>parseValueExpression(e))):PrimitiveValueListNode.create(r)}const OrderByNode=freeze({is(r){return r.kind==="OrderByNode"},create(r){return freeze({kind:"OrderByNode",items:freeze([r])})},cloneWithItem(r,e){return freeze({...r,items:freeze([...r.items,e])})}}),PartitionByNode=freeze({is(r){return r.kind==="PartitionByNode"},create(r){return freeze({kind:"PartitionByNode",items:freeze(r)})},cloneWithItems(r,e){return freeze({...r,items:freeze([...r.items,...e])})}}),OverNode=freeze({is(r){return r.kind==="OverNode"},create(){return freeze({kind:"OverNode"})},cloneWithOrderByItem(r,e){return freeze({...r,orderBy:r.orderBy?OrderByNode.cloneWithItem(r.orderBy,e):OrderByNode.create(e)})},cloneWithPartitionByItems(r,e){return freeze({...r,partitionBy:r.partitionBy?PartitionByNode.cloneWithItems(r.partitionBy,e):PartitionByNode.create(e)})}}),FromNode=freeze({is(r){return r.kind==="FromNode"},create(r){return freeze({kind:"FromNode",froms:freeze(r)})},cloneWithFroms(r,e){return freeze({...r,froms:freeze([...r.froms,...e])})}}),GroupByNode=freeze({is(r){return r.kind==="GroupByNode"},create(r){return freeze({kind:"GroupByNode",items:freeze(r)})},cloneWithItems(r,e){return freeze({...r,items:freeze([...r.items,...e])})}}),HavingNode=freeze({is(r){return r.kind==="HavingNode"},create(r){return freeze({kind:"HavingNode",having:r})},cloneWithOperation(r,e,t){return freeze({...r,having:e==="And"?AndNode.create(r.having,t):OrNode.create(r.having,t)})}}),SelectQueryNode=freeze({is(r){return r.kind==="SelectQueryNode"},create(r,e){return freeze({kind:"SelectQueryNode",from:FromNode.create(r),...e&&{with:e}})},cloneWithSelections(r,e){return freeze({...r,selections:r.selections?freeze([...r.selections,...e]):freeze(e)})},cloneWithDistinctOn(r,e){return freeze({...r,distinctOn:r.distinctOn?freeze([...r.distinctOn,...e]):freeze(e)})},cloneWithFrontModifier(r,e){return freeze({...r,frontModifiers:r.frontModifiers?freeze([...r.frontModifiers,e]):freeze([e])})},cloneWithEndModifier(r,e){return freeze({...r,endModifiers:r.endModifiers?freeze([...r.endModifiers,e]):freeze([e])})},cloneWithOrderByItem(r,e){return freeze({...r,orderBy:r.orderBy?OrderByNode.cloneWithItem(r.orderBy,e):OrderByNode.create(e)})},cloneWithGroupByItems(r,e){return freeze({...r,groupBy:r.groupBy?GroupByNode.cloneWithItems(r.groupBy,e):GroupByNode.create(e)})},cloneWithLimit(r,e){return freeze({...r,limit:e})},cloneWithOffset(r,e){return freeze({...r,offset:e})},cloneWithHaving(r,e){return freeze({...r,having:r.having?HavingNode.cloneWithOperation(r.having,"And",e):HavingNode.create(e)})},cloneWithOrHaving(r,e){return freeze({...r,having:r.having?HavingNode.cloneWithOperation(r.having,"Or",e):HavingNode.create(e)})},cloneWithSetOperation(r,e){return freeze({...r,setOperations:r.setOperations?freeze([...r.setOperations,e]):freeze([e])})},cloneWithoutSelections(r){return freeze({...r,selections:[]})},cloneWithoutLimit(r){return freeze({...r,limit:void 0})},cloneWithoutOffset(r){return freeze({...r,offset:void 0})},cloneWithoutOrderBy(r){return freeze({...r,orderBy:void 0})}}),UnaryOperationNode=freeze({is(r){return r.kind==="UnaryOperationNode"},create(r,e){return freeze({kind:"UnaryOperationNode",operator:r,operand:e})}});function parseExists(r){return parseUnaryOperation("exists",r)}function parseNotExists(r){return parseUnaryOperation("not exists",r)}function parseUnaryOperation(r,e){return UnaryOperationNode.create(OperatorNode.create(r),parseReferenceExpression(e))}function preventAwait(r,e){Object.defineProperties(r.prototype,{then:{enumerable:!1,value:()=>{throw new Error(e)}}})}var Ie;const mt=class mt{constructor(e){T(this,Ie,void 0);A(this,Ie,freeze(e))}on(...e){return new mt({...i(this,Ie),joinNode:JoinNode.cloneWithOn(i(this,Ie).joinNode,parseOn(e))})}orOn(...e){return new mt({...i(this,Ie),joinNode:JoinNode.cloneWithOrOn(i(this,Ie).joinNode,parseOn(e))})}onRef(e,t,n){return new mt({...i(this,Ie),joinNode:JoinNode.cloneWithOn(i(this,Ie).joinNode,parseReferentialComparison(e,t,n))})}orOnRef(e,t,n){return new mt({...i(this,Ie),joinNode:JoinNode.cloneWithOrOn(i(this,Ie).joinNode,parseReferentialComparison(e,t,n))})}onExists(e){return new mt({...i(this,Ie),joinNode:JoinNode.cloneWithOn(i(this,Ie).joinNode,parseExists(e))})}onNotExists(e){return new mt({...i(this,Ie),joinNode:JoinNode.cloneWithOn(i(this,Ie).joinNode,parseNotExists(e))})}orOnExists(e){return new mt({...i(this,Ie),joinNode:JoinNode.cloneWithOrOn(i(this,Ie).joinNode,parseExists(e))})}orOnNotExists(e){return new mt({...i(this,Ie),joinNode:JoinNode.cloneWithOrOn(i(this,Ie).joinNode,parseNotExists(e))})}onTrue(){return new mt({...i(this,Ie),joinNode:JoinNode.cloneWithOn(i(this,Ie).joinNode,RawNode.createWithSql("true"))})}$call(e){return e(this)}toOperationNode(){return i(this,Ie).joinNode}};Ie=new WeakMap;let JoinBuilder=mt;preventAwait(JoinBuilder,"don't await JoinBuilder instances. They are never executed directly and are always just a part of a query.");const PartitionByItemNode=freeze({is(r){return r.kind==="PartitionByItemNode"},create(r){return freeze({kind:"PartitionByItemNode",partitionBy:r})}});function parsePartitionBy(r){return parseReferenceExpressionOrList(r).map(PartitionByItemNode.create)}var tr;const Fn=class Fn{constructor(e){T(this,tr,void 0);A(this,tr,freeze(e))}orderBy(e,t){return new Fn({overNode:OverNode.cloneWithOrderByItem(i(this,tr).overNode,parseOrderBy(e,t))})}partitionBy(e){return new Fn({overNode:OverNode.cloneWithPartitionByItems(i(this,tr).overNode,parsePartitionBy(e))})}$call(e){return e(this)}toOperationNode(){return i(this,tr).overNode}};tr=new WeakMap;let OverBuilder=Fn;preventAwait(OverBuilder,"don't await OverBuilder instances. They are never executed directly and are always just a part of a query.");const SelectionNode=freeze({is(r){return r.kind==="SelectionNode"},create(r){return freeze({kind:"SelectionNode",selection:r})},createSelectAll(){return freeze({kind:"SelectionNode",selection:SelectAllNode.create()})},createSelectAllFromTable(r){return freeze({kind:"SelectionNode",selection:ReferenceNode.createSelectAll(r)})}});var wr;class DynamicReferenceBuilder{constructor(e){T(this,wr,void 0);A(this,wr,e)}get dynamicReference(){return i(this,wr)}get refType(){}toOperationNode(){return parseSimpleReferenceExpression(i(this,wr))}}wr=new WeakMap;function isDynamicReferenceBuilder(r){return isObject$2(r)&&isOperationNodeSource(r)&&isString(r.dynamicReference)}function parseSelectArg(r){return isFunction(r)?parseSelectArg(r(expressionBuilder())):isReadonlyArray(r)?r.map(e=>parseSelectExpression(e)):[parseSelectExpression(r)]}function parseSelectExpression(r){return isString(r)?SelectionNode.create(parseAliasedStringReference(r)):isDynamicReferenceBuilder(r)?SelectionNode.create(r.toOperationNode()):SelectionNode.create(parseAliasedExpression(r))}function parseSelectAll(r){return r?Array.isArray(r)?r.map(parseSelectAllArg):[parseSelectAllArg(r)]:[SelectionNode.createSelectAll()]}function parseSelectAllArg(r){if(isString(r))return SelectionNode.createSelectAllFromTable(parseTable(r));throw new Error(`invalid value selectAll expression: ${JSON.stringify(r)}`)}const ValuesNode=freeze({is(r){return r.kind==="ValuesNode"},create(r){return freeze({kind:"ValuesNode",values:freeze(r)})}}),DefaultInsertValueNode=freeze({is(r){return r.kind==="DefaultInsertValueNode"},create(){return freeze({kind:"DefaultInsertValueNode"})}});function parseInsertExpression(r){const e=isFunction(r)?r(expressionBuilder()):r,t=isReadonlyArray(e)?e:freeze([e]);return parseInsertColumnsAndValues(t)}function parseInsertColumnsAndValues(r){const e=parseColumnNamesAndIndexes(r);return[freeze([...e.keys()].map(ColumnNode.create)),ValuesNode.create(r.map(t=>parseRowValues(t,e)))]}function parseColumnNamesAndIndexes(r){const e=new Map;for(const t of r){const n=Object.keys(t);for(const s of n)!e.has(s)&&t[s]!==void 0&&e.set(s,e.size)}return e}function parseRowValues(r,e){const t=Object.keys(r),n=Array.from({length:e.size});let s=!1;for(const c of t){const f=e.get(c);if(isUndefined(f))continue;const h=r[c];(isUndefined(h)||isExpressionOrFactory(h))&&(s=!0),n[f]=h}if(t.length<e.size||s){const c=DefaultInsertValueNode.create();return ValueListNode.create(n.map(f=>isUndefined(f)?c:parseValueExpression(f)))}return PrimitiveValueListNode.create(n)}const InsertQueryNode=freeze({is(r){return r.kind==="InsertQueryNode"},create(r,e,t){return freeze({kind:"InsertQueryNode",into:r,...e&&{with:e},replace:t})},cloneWith(r,e){return freeze({...r,...e})}}),UpdateQueryNode=freeze({is(r){return r.kind==="UpdateQueryNode"},create(r,e){return freeze({kind:"UpdateQueryNode",table:r,...e&&{with:e}})},cloneWithFromItems(r,e){return freeze({...r,from:r.from?FromNode.cloneWithFroms(r.from,e):FromNode.create(e)})},cloneWithUpdates(r,e){return freeze({...r,updates:r.updates?freeze([...r.updates,...e]):e})}}),UsingNode=freeze({is(r){return r.kind==="UsingNode"},create(r){return freeze({kind:"UsingNode",tables:freeze(r)})},cloneWithTables(r,e){return freeze({...r,tables:freeze([...r.tables,...e])})}}),DeleteQueryNode=freeze({is(r){return r.kind==="DeleteQueryNode"},create(r,e){return freeze({kind:"DeleteQueryNode",from:FromNode.create(r),...e&&{with:e}})},cloneWithOrderByItem(r,e){return freeze({...r,orderBy:r.orderBy?OrderByNode.cloneWithItem(r.orderBy,e):OrderByNode.create(e)})},cloneWithLimit(r,e){return freeze({...r,limit:e})},cloneWithUsing(r,e){return freeze({...r,using:r.using!==void 0?UsingNode.cloneWithTables(r.using,e):UsingNode.create(e)})}}),WhereNode=freeze({is(r){return r.kind==="WhereNode"},create(r){return freeze({kind:"WhereNode",where:r})},cloneWithOperation(r,e,t){return freeze({...r,where:e==="And"?AndNode.create(r.where,t):OrNode.create(r.where,t)})}}),ReturningNode=freeze({is(r){return r.kind==="ReturningNode"},create(r){return freeze({kind:"ReturningNode",selections:freeze(r)})},cloneWithSelections(r,e){return freeze({...r,selections:r.selections?freeze([...r.selections,...e]):freeze(e)})}}),ExplainNode=freeze({is(r){return r.kind==="ExplainNode"},create(r,e){return freeze({kind:"ExplainNode",format:r,options:e})}}),QueryNode=freeze({is(r){return SelectQueryNode.is(r)||InsertQueryNode.is(r)||UpdateQueryNode.is(r)||DeleteQueryNode.is(r)},cloneWithWhere(r,e){return freeze({...r,where:r.where?WhereNode.cloneWithOperation(r.where,"And",e):WhereNode.create(e)})},cloneWithOrWhere(r,e){return freeze({...r,where:r.where?WhereNode.cloneWithOperation(r.where,"Or",e):WhereNode.create(e)})},cloneWithJoin(r,e){return freeze({...r,joins:r.joins?freeze([...r.joins,e]):freeze([e])})},cloneWithReturning(r,e){return freeze({...r,returning:r.returning?ReturningNode.cloneWithSelections(r.returning,e):ReturningNode.create(e)})},cloneWithoutWhere(r){return freeze({...r,where:void 0})},cloneWithExplain(r,e,t){return freeze({...r,explain:ExplainNode.create(e,t==null?void 0:t.toOperationNode())})}}),ColumnUpdateNode=freeze({is(r){return r.kind==="ColumnUpdateNode"},create(r,e){return freeze({kind:"ColumnUpdateNode",column:r,value:e})}});function parseUpdateExpression(r){const e=isFunction(r)?r(expressionBuilder()):r;return Object.entries(e).filter(([t,n])=>n!==void 0).map(([t,n])=>ColumnUpdateNode.create(ColumnNode.create(t),parseValueExpression(n)))}const OnDuplicateKeyNode=freeze({is(r){return r.kind==="OnDuplicateKeyNode"},create(r){return freeze({kind:"OnDuplicateKeyNode",updates:r})}});var Xr,Yr;class InsertResult{constructor(e,t){T(this,Xr,void 0);T(this,Yr,void 0);A(this,Xr,e),A(this,Yr,t)}get insertId(){return i(this,Xr)}get numInsertedOrUpdatedRows(){return i(this,Yr)}}Xr=new WeakMap,Yr=new WeakMap;for(const r of["insertId","numInsertedOrUpdatedRows"])Object.defineProperty(InsertResult.prototype,r,{enumerable:!0});class NoResultError extends Error{constructor(t){super("no result");le(this,"node");this.node=t}}function isNoResultErrorConstructor(r){return Object.prototype.hasOwnProperty.call(r,"prototype")}const OnConflictNode=freeze({is(r){return r.kind==="OnConflictNode"},create(){return freeze({kind:"OnConflictNode"})},cloneWith(r,e){return freeze({...r,...e})},cloneWithIndexWhere(r,e){return freeze({...r,indexWhere:r.indexWhere?WhereNode.cloneWithOperation(r.indexWhere,"And",e):WhereNode.create(e)})},cloneWithIndexOrWhere(r,e){return freeze({...r,indexWhere:r.indexWhere?WhereNode.cloneWithOperation(r.indexWhere,"Or",e):WhereNode.create(e)})},cloneWithUpdateWhere(r,e){return freeze({...r,updateWhere:r.updateWhere?WhereNode.cloneWithOperation(r.updateWhere,"And",e):WhereNode.create(e)})},cloneWithUpdateOrWhere(r,e){return freeze({...r,updateWhere:r.updateWhere?WhereNode.cloneWithOperation(r.updateWhere,"Or",e):WhereNode.create(e)})},cloneWithoutIndexWhere(r){return freeze({...r,indexWhere:void 0})},cloneWithoutUpdateWhere(r){return freeze({...r,updateWhere:void 0})}});var se;const Ye=class Ye{constructor(e){T(this,se,void 0);A(this,se,freeze(e))}column(e){const t=ColumnNode.create(e);return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWith(i(this,se).onConflictNode,{columns:i(this,se).onConflictNode.columns?freeze([...i(this,se).onConflictNode.columns,t]):freeze([t])})})}columns(e){const t=e.map(ColumnNode.create);return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWith(i(this,se).onConflictNode,{columns:i(this,se).onConflictNode.columns?freeze([...i(this,se).onConflictNode.columns,...t]):freeze(t)})})}constraint(e){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWith(i(this,se).onConflictNode,{constraint:IdentifierNode.create(e)})})}expression(e){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWith(i(this,se).onConflictNode,{indexExpression:e.toOperationNode()})})}where(...e){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,se).onConflictNode,parseWhere(e))})}whereRef(e,t,n){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,se).onConflictNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWithIndexOrWhere(i(this,se).onConflictNode,parseWhere(e))})}orWhereRef(e,t,n){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWithIndexOrWhere(i(this,se).onConflictNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,se).onConflictNode,parseExists(e))})}whereNotExists(e){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,se).onConflictNode,parseNotExists(e))})}orWhereExists(e){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWithIndexOrWhere(i(this,se).onConflictNode,parseExists(e))})}orWhereNotExists(e){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWithIndexOrWhere(i(this,se).onConflictNode,parseNotExists(e))})}clearWhere(){return new Ye({...i(this,se),onConflictNode:OnConflictNode.cloneWithoutIndexWhere(i(this,se).onConflictNode)})}doNothing(){return new OnConflictDoNothingBuilder({...i(this,se),onConflictNode:OnConflictNode.cloneWith(i(this,se).onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new OnConflictUpdateBuilder({...i(this,se),onConflictNode:OnConflictNode.cloneWith(i(this,se).onConflictNode,{updates:parseUpdateExpression(e)})})}$call(e){return e(this)}};se=new WeakMap;let OnConflictBuilder=Ye;preventAwait(OnConflictBuilder,"don't await OnConflictBuilder instances.");var Zr;class OnConflictDoNothingBuilder{constructor(e){T(this,Zr,void 0);A(this,Zr,freeze(e))}toOperationNode(){return i(this,Zr).onConflictNode}}Zr=new WeakMap;preventAwait(OnConflictDoNothingBuilder,"don't await OnConflictDoNothingBuilder instances.");var Se;const yt=class yt{constructor(e){T(this,Se,void 0);A(this,Se,freeze(e))}where(...e){return new yt({...i(this,Se),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,Se).onConflictNode,parseWhere(e))})}whereRef(e,t,n){return new yt({...i(this,Se),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,Se).onConflictNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new yt({...i(this,Se),onConflictNode:OnConflictNode.cloneWithUpdateOrWhere(i(this,Se).onConflictNode,parseWhere(e))})}orWhereRef(e,t,n){return new yt({...i(this,Se),onConflictNode:OnConflictNode.cloneWithUpdateOrWhere(i(this,Se).onConflictNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new yt({...i(this,Se),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,Se).onConflictNode,parseExists(e))})}whereNotExists(e){return new yt({...i(this,Se),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,Se).onConflictNode,parseNotExists(e))})}orWhereExists(e){return new yt({...i(this,Se),onConflictNode:OnConflictNode.cloneWithUpdateOrWhere(i(this,Se).onConflictNode,parseExists(e))})}orWhereNotExists(e){return new yt({...i(this,Se),onConflictNode:OnConflictNode.cloneWithUpdateOrWhere(i(this,Se).onConflictNode,parseNotExists(e))})}clearWhere(){return new yt({...i(this,Se),onConflictNode:OnConflictNode.cloneWithoutUpdateWhere(i(this,Se).onConflictNode)})}$call(e){return e(this)}toOperationNode(){return i(this,Se).onConflictNode}};Se=new WeakMap;let OnConflictUpdateBuilder=yt;preventAwait(OnConflictUpdateBuilder,"don't await OnConflictUpdateBuilder instances.");var ne;const ze=class ze{constructor(e){T(this,ne,void 0);A(this,ne,freeze(e))}values(e){const[t,n]=parseInsertExpression(e);return new ze({...i(this,ne),queryNode:InsertQueryNode.cloneWith(i(this,ne).queryNode,{columns:t,values:n})})}columns(e){return new ze({...i(this,ne),queryNode:InsertQueryNode.cloneWith(i(this,ne).queryNode,{columns:freeze(e.map(ColumnNode.create))})})}expression(e){return new ze({...i(this,ne),queryNode:InsertQueryNode.cloneWith(i(this,ne).queryNode,{values:parseExpression(e)})})}ignore(){return new ze({...i(this,ne),queryNode:InsertQueryNode.cloneWith(i(this,ne).queryNode,{ignore:!0})})}onConflict(e){return new ze({...i(this,ne),queryNode:InsertQueryNode.cloneWith(i(this,ne).queryNode,{onConflict:e(new OnConflictBuilder({onConflictNode:OnConflictNode.create()})).toOperationNode()})})}onDuplicateKeyUpdate(e){return new ze({...i(this,ne),queryNode:InsertQueryNode.cloneWith(i(this,ne).queryNode,{onDuplicateKey:OnDuplicateKeyNode.create(parseUpdateExpression(e))})})}returning(e){return new ze({...i(this,ne),queryNode:QueryNode.cloneWithReturning(i(this,ne).queryNode,parseSelectArg(e))})}returningAll(){return new ze({...i(this,ne),queryNode:QueryNode.cloneWithReturning(i(this,ne).queryNode,parseSelectAll())})}$call(e){return e(this)}call(e){return this.$call(e)}$if(e,t){return e?t(this):new ze({...i(this,ne)})}if(e,t){return e?t(this):new ze({...i(this,ne)})}$castTo(){return new ze(i(this,ne))}castTo(){return this.$castTo()}$narrowType(){return new ze(i(this,ne))}$assertType(){return new ze(i(this,ne))}assertType(){return new ze(i(this,ne))}withPlugin(e){return new ze({...i(this,ne),executor:i(this,ne).executor.withPlugin(e)})}toOperationNode(){return i(this,ne).executor.transformQuery(i(this,ne).queryNode,i(this,ne).queryId)}compile(){return i(this,ne).executor.compileQuery(this.toOperationNode(),i(this,ne).queryId)}async execute(){const e=this.compile(),t=e.query,n=await i(this,ne).executor.executeQuery(e,i(this,ne).queryId);return i(this,ne).executor.adapter.supportsReturning&&t.returning?n.rows:[new InsertResult(n.insertId,n.numAffectedRows??n.numUpdatedOrDeletedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,ne).executor.stream(t,e,i(this,ne).queryId);for await(const s of n)yield*s.rows}async explain(e,t){return await new ze({...i(this,ne),queryNode:QueryNode.cloneWithExplain(i(this,ne).queryNode,e,t)}).execute()}};ne=new WeakMap;let InsertQueryBuilder=ze;preventAwait(InsertQueryBuilder,"don't await InsertQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var en;class DeleteResult{constructor(e){T(this,en,void 0);A(this,en,e)}get numDeletedRows(){return i(this,en)}}en=new WeakMap;Object.defineProperty(DeleteResult.prototype,"numDeletedRows",{enumerable:!0});const LimitNode=freeze({is(r){return r.kind==="LimitNode"},create(r){return freeze({kind:"LimitNode",limit:ValueNode.create(r)})}});var K;const me=class me{constructor(e){T(this,K,void 0);A(this,K,freeze(e))}where(...e){return new me({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseWhere(e))})}whereRef(e,t,n){return new me({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new me({...i(this,K),queryNode:QueryNode.cloneWithOrWhere(i(this,K).queryNode,parseWhere(e))})}orWhereRef(e,t,n){return new me({...i(this,K),queryNode:QueryNode.cloneWithOrWhere(i(this,K).queryNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new me({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseExists(e))})}whereNotExists(e){return new me({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseNotExists(e))})}orWhereExists(e){return new me({...i(this,K),queryNode:QueryNode.cloneWithOrWhere(i(this,K).queryNode,parseExists(e))})}orWhereNotExists(e){return new me({...i(this,K),queryNode:QueryNode.cloneWithOrWhere(i(this,K).queryNode,parseNotExists(e))})}clearWhere(){return new me({...i(this,K),queryNode:QueryNode.cloneWithoutWhere(i(this,K).queryNode)})}using(e){return new me({...i(this,K),queryNode:DeleteQueryNode.cloneWithUsing(i(this,K).queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new me({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new me({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new me({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new me({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("FullJoin",e))})}returning(e){return new me({...i(this,K),queryNode:QueryNode.cloneWithReturning(i(this,K).queryNode,parseSelectArg(e))})}returningAll(e){return new me({...i(this,K),queryNode:QueryNode.cloneWithReturning(i(this,K).queryNode,parseSelectAll(e))})}orderBy(e,t){return new me({...i(this,K),queryNode:DeleteQueryNode.cloneWithOrderByItem(i(this,K).queryNode,parseOrderBy(e,t))})}limit(e){return new me({...i(this,K),queryNode:DeleteQueryNode.cloneWithLimit(i(this,K).queryNode,LimitNode.create(e))})}$call(e){return e(this)}call(e){return this.$call(e)}$if(e,t){return e?t(this):new me({...i(this,K)})}if(e,t){return this.$if(e,t)}$castTo(){return new me(i(this,K))}castTo(){return this.$castTo()}$narrowType(){return new me(i(this,K))}$assertType(){return new me(i(this,K))}assertType(){return new me(i(this,K))}withPlugin(e){return new me({...i(this,K),executor:i(this,K).executor.withPlugin(e)})}toOperationNode(){return i(this,K).executor.transformQuery(i(this,K).queryNode,i(this,K).queryId)}compile(){return i(this,K).executor.compileQuery(this.toOperationNode(),i(this,K).queryId)}async execute(){const e=this.compile(),t=e.query,n=await i(this,K).executor.executeQuery(e,i(this,K).queryId);return i(this,K).executor.adapter.supportsReturning&&t.returning?n.rows:[new DeleteResult(n.numAffectedRows??n.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,K).executor.stream(t,e,i(this,K).queryId);for await(const s of n)yield*s.rows}async explain(e,t){return await new me({...i(this,K),queryNode:QueryNode.cloneWithExplain(i(this,K).queryNode,e,t)}).execute()}};K=new WeakMap;let DeleteQueryBuilder=me;preventAwait(DeleteQueryBuilder,"don't await DeleteQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var tn;class UpdateResult{constructor(e){T(this,tn,void 0);A(this,tn,e)}get numUpdatedRows(){return i(this,tn)}}tn=new WeakMap;Object.defineProperty(UpdateResult.prototype,"numUpdatedRows",{enumerable:!0});var G;const be=class be{constructor(e){T(this,G,void 0);A(this,G,freeze(e))}where(...e){return new be({...i(this,G),queryNode:QueryNode.cloneWithWhere(i(this,G).queryNode,parseWhere(e))})}whereRef(e,t,n){return new be({...i(this,G),queryNode:QueryNode.cloneWithWhere(i(this,G).queryNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new be({...i(this,G),queryNode:QueryNode.cloneWithOrWhere(i(this,G).queryNode,parseWhere(e))})}orWhereRef(e,t,n){return new be({...i(this,G),queryNode:QueryNode.cloneWithOrWhere(i(this,G).queryNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new be({...i(this,G),queryNode:QueryNode.cloneWithWhere(i(this,G).queryNode,parseExists(e))})}whereNotExists(e){return new be({...i(this,G),queryNode:QueryNode.cloneWithWhere(i(this,G).queryNode,parseNotExists(e))})}orWhereExists(e){return new be({...i(this,G),queryNode:QueryNode.cloneWithOrWhere(i(this,G).queryNode,parseExists(e))})}orWhereNotExists(e){return new be({...i(this,G),queryNode:QueryNode.cloneWithOrWhere(i(this,G).queryNode,parseNotExists(e))})}clearWhere(){return new be({...i(this,G),queryNode:QueryNode.cloneWithoutWhere(i(this,G).queryNode)})}from(e){return new be({...i(this,G),queryNode:UpdateQueryNode.cloneWithFromItems(i(this,G).queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new be({...i(this,G),queryNode:QueryNode.cloneWithJoin(i(this,G).queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new be({...i(this,G),queryNode:QueryNode.cloneWithJoin(i(this,G).queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new be({...i(this,G),queryNode:QueryNode.cloneWithJoin(i(this,G).queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new be({...i(this,G),queryNode:QueryNode.cloneWithJoin(i(this,G).queryNode,parseJoin("FullJoin",e))})}set(e){return new be({...i(this,G),queryNode:UpdateQueryNode.cloneWithUpdates(i(this,G).queryNode,parseUpdateExpression(e))})}returning(e){return new be({...i(this,G),queryNode:QueryNode.cloneWithReturning(i(this,G).queryNode,parseSelectArg(e))})}returningAll(){return new be({...i(this,G),queryNode:QueryNode.cloneWithReturning(i(this,G).queryNode,parseSelectAll())})}$call(e){return e(this)}call(e){return this.$call(e)}$if(e,t){return e?t(this):new be({...i(this,G)})}if(e,t){return this.$if(e,t)}$castTo(){return new be(i(this,G))}castTo(){return this.$castTo()}$narrowType(){return new be(i(this,G))}$assertType(){return new be(i(this,G))}assertType(){return new be(i(this,G))}withPlugin(e){return new be({...i(this,G),executor:i(this,G).executor.withPlugin(e)})}toOperationNode(){return i(this,G).executor.transformQuery(i(this,G).queryNode,i(this,G).queryId)}compile(){return i(this,G).executor.compileQuery(this.toOperationNode(),i(this,G).queryId)}async execute(){const e=this.compile(),t=e.query,n=await i(this,G).executor.executeQuery(e,i(this,G).queryId);return i(this,G).executor.adapter.supportsReturning&&t.returning?n.rows:[new UpdateResult(n.numAffectedRows??n.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,G).executor.stream(t,e,i(this,G).queryId);for await(const s of n)yield*s.rows}async explain(e,t){return await new be({...i(this,G),queryNode:QueryNode.cloneWithExplain(i(this,G).queryNode,e,t)}).execute()}};G=new WeakMap;let UpdateQueryBuilder=be;preventAwait(UpdateQueryBuilder,"don't await UpdateQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");const CommonTableExpressionNode=freeze({is(r){return r.kind==="CommonTableExpressionNode"},create(r,e){return freeze({kind:"CommonTableExpressionNode",name:r,expression:e})}}),CommonTableExpressionNameNode=freeze({is(r){return r.kind==="CommonTableExpressionNameNode"},create(r,e){return freeze({kind:"CommonTableExpressionNameNode",table:TableNode.create(r),columns:e?freeze(e.map(ColumnNode.create)):void 0})}});function parseCommonTableExpression(r,e){const t=e(createQueryCreator());return CommonTableExpressionNode.create(parseCommonTableExpressionName(r),t.toOperationNode())}function parseCommonTableExpressionName(r){if(r.includes("(")){const e=r.split(/[\(\)]/),t=e[0],n=e[1].split(",").map(s=>s.trim());return CommonTableExpressionNameNode.create(t,n)}else return CommonTableExpressionNameNode.create(r)}const WithNode=freeze({is(r){return r.kind==="WithNode"},create(r,e){return freeze({kind:"WithNode",expressions:freeze([r]),...e})},cloneWithExpression(r,e){return freeze({...r,expressions:freeze([...r.expressions,e])})}}),CHARS=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];function randomString(r){let e="";for(let t=0;t<r;++t)e+=randomChar();return e}function randomChar(){return CHARS[~~(Math.random()*CHARS.length)]}function createQueryId(){return new LazyQueryId}var Er;class LazyQueryId{constructor(){T(this,Er,void 0)}get queryId(){return i(this,Er)===void 0&&A(this,Er,randomString(8)),i(this,Er)}}Er=new WeakMap;function requireAllProps(r){return r}var Bn;class OperationNodeTransformer{constructor(){le(this,"nodeStack",[]);T(this,Bn,freeze({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this)}))}transformNode(e){if(!e)return e;this.nodeStack.push(e);const t=this.transformNodeImpl(e);return this.nodeStack.pop(),freeze(t)}transformNodeImpl(e){return i(this,Bn)[e.kind](e)}transformNodeList(e){return e&&freeze(e.map(t=>this.transformNode(t)))}transformSelectQuery(e){return{kind:"SelectQueryNode",from:this.transformNode(e.from),selections:this.transformNodeList(e.selections),distinctOn:this.transformNodeList(e.distinctOn),joins:this.transformNodeList(e.joins),groupBy:this.transformNode(e.groupBy),orderBy:this.transformNode(e.orderBy),where:this.transformNode(e.where),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),limit:this.transformNode(e.limit),offset:this.transformNode(e.offset),with:this.transformNode(e.with),having:this.transformNode(e.having),explain:this.transformNode(e.explain),setOperations:this.transformNodeList(e.setOperations)}}transformSelection(e){return{kind:"SelectionNode",selection:this.transformNode(e.selection)}}transformColumn(e){return{kind:"ColumnNode",column:this.transformNode(e.column)}}transformAlias(e){return{kind:"AliasNode",node:this.transformNode(e.node),alias:this.transformNode(e.alias)}}transformTable(e){return{kind:"TableNode",table:this.transformNode(e.table)}}transformFrom(e){return{kind:"FromNode",froms:this.transformNodeList(e.froms)}}transformReference(e){return{kind:"ReferenceNode",table:this.transformNode(e.table),column:this.transformNode(e.column)}}transformAnd(e){return{kind:"AndNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformOr(e){return{kind:"OrNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformValueList(e){return{kind:"ValueListNode",values:this.transformNodeList(e.values)}}transformParens(e){return{kind:"ParensNode",node:this.transformNode(e.node)}}transformJoin(e){return{kind:"JoinNode",joinType:e.joinType,table:this.transformNode(e.table),on:this.transformNode(e.on)}}transformRaw(e){return{kind:"RawNode",sqlFragments:freeze([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters)}}transformWhere(e){return{kind:"WhereNode",where:this.transformNode(e.where)}}transformInsertQuery(e){return{kind:"InsertQueryNode",into:this.transformNode(e.into),columns:this.transformNodeList(e.columns),values:this.transformNode(e.values),returning:this.transformNode(e.returning),onConflict:this.transformNode(e.onConflict),onDuplicateKey:this.transformNode(e.onDuplicateKey),with:this.transformNode(e.with),ignore:e.ignore,replace:e.replace,explain:this.transformNode(e.explain)}}transformValues(e){return{kind:"ValuesNode",values:this.transformNodeList(e.values)}}transformDeleteQuery(e){return{kind:"DeleteQueryNode",from:this.transformNode(e.from),using:this.transformNode(e.using),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),returning:this.transformNode(e.returning),with:this.transformNode(e.with),orderBy:this.transformNode(e.orderBy),limit:this.transformNode(e.limit),explain:this.transformNode(e.explain)}}transformReturning(e){return{kind:"ReturningNode",selections:this.transformNodeList(e.selections)}}transformCreateTable(e){return{kind:"CreateTableNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),constraints:this.transformNodeList(e.constraints),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers)}}transformColumnDefinition(e){return{kind:"ColumnDefinitionNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),references:this.transformNode(e.references),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo),check:this.transformNode(e.check),generated:this.transformNode(e.generated),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers)}}transformAddColumn(e){return{kind:"AddColumnNode",column:this.transformNode(e.column)}}transformDropTable(e){return{kind:"DropTableNode",table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformOrderBy(e){return{kind:"OrderByNode",items:this.transformNodeList(e.items)}}transformOrderByItem(e){return{kind:"OrderByItemNode",orderBy:this.transformNode(e.orderBy),direction:this.transformNode(e.direction)}}transformGroupBy(e){return{kind:"GroupByNode",items:this.transformNodeList(e.items)}}transformGroupByItem(e){return{kind:"GroupByItemNode",groupBy:this.transformNode(e.groupBy)}}transformUpdateQuery(e){return{kind:"UpdateQueryNode",table:this.transformNode(e.table),from:this.transformNode(e.from),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),updates:this.transformNodeList(e.updates),returning:this.transformNode(e.returning),with:this.transformNode(e.with),explain:this.transformNode(e.explain)}}transformColumnUpdate(e){return{kind:"ColumnUpdateNode",column:this.transformNode(e.column),value:this.transformNode(e.value)}}transformLimit(e){return{kind:"LimitNode",limit:this.transformNode(e.limit)}}transformOffset(e){return{kind:"OffsetNode",offset:this.transformNode(e.offset)}}transformOnConflict(e){return{kind:"OnConflictNode",columns:this.transformNodeList(e.columns),constraint:this.transformNode(e.constraint),indexExpression:this.transformNode(e.indexExpression),indexWhere:this.transformNode(e.indexWhere),updates:this.transformNodeList(e.updates),updateWhere:this.transformNode(e.updateWhere),doNothing:e.doNothing}}transformOnDuplicateKey(e){return{kind:"OnDuplicateKeyNode",updates:this.transformNodeList(e.updates)}}transformCreateIndex(e){return{kind:"CreateIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists,where:this.transformNode(e.where)}}transformList(e){return{kind:"ListNode",items:this.transformNodeList(e.items)}}transformDropIndex(e){return{kind:"DropIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformPrimaryKeyConstraint(e){return{kind:"PrimaryKeyConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)}}transformUniqueConstraint(e){return{kind:"UniqueConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)}}transformForeignKeyConstraint(e){return{kind:"ForeignKeyConstraintNode",columns:this.transformNodeList(e.columns),references:this.transformNode(e.references),name:this.transformNode(e.name),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformSetOperation(e){return{kind:"SetOperationNode",operator:e.operator,expression:this.transformNode(e.expression),all:e.all}}transformReferences(e){return{kind:"ReferencesNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformCheckConstraint(e){return{kind:"CheckConstraintNode",expression:this.transformNode(e.expression),name:this.transformNode(e.name)}}transformWith(e){return{kind:"WithNode",expressions:this.transformNodeList(e.expressions),recursive:e.recursive}}transformCommonTableExpression(e){return{kind:"CommonTableExpressionNode",name:this.transformNode(e.name),expression:this.transformNode(e.expression)}}transformCommonTableExpressionName(e){return{kind:"CommonTableExpressionNameNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns)}}transformHaving(e){return{kind:"HavingNode",having:this.transformNode(e.having)}}transformCreateSchema(e){return{kind:"CreateSchemaNode",schema:this.transformNode(e.schema),ifNotExists:e.ifNotExists}}transformDropSchema(e){return{kind:"DropSchemaNode",schema:this.transformNode(e.schema),ifExists:e.ifExists,cascade:e.cascade}}transformAlterTable(e){return{kind:"AlterTableNode",table:this.transformNode(e.table),renameTo:this.transformNode(e.renameTo),setSchema:this.transformNode(e.setSchema),columnAlterations:this.transformNodeList(e.columnAlterations),addConstraint:this.transformNode(e.addConstraint),dropConstraint:this.transformNode(e.dropConstraint)}}transformDropColumn(e){return{kind:"DropColumnNode",column:this.transformNode(e.column)}}transformRenameColumn(e){return{kind:"RenameColumnNode",column:this.transformNode(e.column),renameTo:this.transformNode(e.renameTo)}}transformAlterColumn(e){return{kind:"AlterColumnNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),dataTypeExpression:this.transformNode(e.dataTypeExpression),setDefault:this.transformNode(e.setDefault),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull}}transformModifyColumn(e){return{kind:"ModifyColumnNode",column:this.transformNode(e.column)}}transformAddConstraint(e){return{kind:"AddConstraintNode",constraint:this.transformNode(e.constraint)}}transformDropConstraint(e){return{kind:"DropConstraintNode",constraintName:this.transformNode(e.constraintName),ifExists:e.ifExists,modifier:e.modifier}}transformCreateView(e){return{kind:"CreateViewNode",name:this.transformNode(e.name),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns),as:this.transformNode(e.as)}}transformDropView(e){return{kind:"DropViewNode",name:this.transformNode(e.name),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade}}transformGenerated(e){return{kind:"GeneratedNode",byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression)}}transformDefaultValue(e){return{kind:"DefaultValueNode",defaultValue:this.transformNode(e.defaultValue)}}transformOn(e){return{kind:"OnNode",on:this.transformNode(e.on)}}transformSelectModifier(e){return{kind:"SelectModifierNode",modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier)}}transformCreateType(e){return{kind:"CreateTypeNode",name:this.transformNode(e.name),enum:this.transformNode(e.enum)}}transformDropType(e){return{kind:"DropTypeNode",name:this.transformNode(e.name),ifExists:e.ifExists}}transformExplain(e){return{kind:"ExplainNode",format:e.format,options:this.transformNode(e.options)}}transformSchemableIdentifier(e){return{kind:"SchemableIdentifierNode",schema:this.transformNode(e.schema),identifier:this.transformNode(e.identifier)}}transformAggregateFunction(e){return{kind:"AggregateFunctionNode",aggregated:this.transformNodeList(e.aggregated),distinct:e.distinct,filter:this.transformNode(e.filter),func:e.func,over:this.transformNode(e.over)}}transformOver(e){return{kind:"OverNode",orderBy:this.transformNode(e.orderBy),partitionBy:this.transformNode(e.partitionBy)}}transformPartitionBy(e){return{kind:"PartitionByNode",items:this.transformNodeList(e.items)}}transformPartitionByItem(e){return{kind:"PartitionByItemNode",partitionBy:this.transformNode(e.partitionBy)}}transformBinaryOperation(e){return{kind:"BinaryOperationNode",leftOperand:this.transformNode(e.leftOperand),operator:this.transformNode(e.operator),rightOperand:this.transformNode(e.rightOperand)}}transformUnaryOperation(e){return{kind:"UnaryOperationNode",operator:this.transformNode(e.operator),operand:this.transformNode(e.operand)}}transformUsing(e){return{kind:"UsingNode",tables:this.transformNodeList(e.tables)}}transformFunction(e){return{kind:"FunctionNode",func:e.func,arguments:this.transformNodeList(e.arguments)}}transformCase(e){return{kind:"CaseNode",value:this.transformNode(e.value),when:this.transformNodeList(e.when),else:this.transformNode(e.else),isStatement:e.isStatement}}transformWhen(e){return{kind:"WhenNode",condition:this.transformNode(e.condition),result:this.transformNode(e.result)}}transformDataType(e){return e}transformSelectAll(e){return e}transformIdentifier(e){return e}transformValue(e){return e}transformPrimitiveValueList(e){return e}transformOperator(e){return e}transformDefaultInsertValue(e){return e}}Bn=new WeakMap;const ROOT_OPERATION_NODES=freeze({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0});var gr,rr,zn,co,Qn,fo,nr,Hr,rn,Ii,Pn,ho;class WithSchemaTransformer extends OperationNodeTransformer{constructor(t){super();T(this,zn);T(this,Qn);T(this,nr);T(this,rn);T(this,Pn);T(this,gr,void 0);T(this,rr,new Set);A(this,gr,t)}transformNodeImpl(t){if(!te(this,zn,co).call(this,t))return super.transformNodeImpl(t);const n=te(this,Qn,fo).call(this,t);for(const a of n)i(this,rr).add(a);const s=super.transformNodeImpl(t);for(const a of n)i(this,rr).delete(a);return s}transformSchemableIdentifier(t){const n=super.transformSchemableIdentifier(t);return n.schema||!i(this,rr).has(t.identifier.name)?n:{...n,schema:IdentifierNode.create(i(this,gr))}}transformReferences(t){const n=super.transformReferences(t);return n.table.table.schema?n:{...n,table:TableNode.createWithSchema(i(this,gr),n.table.table.identifier.name)}}}gr=new WeakMap,rr=new WeakMap,zn=new WeakSet,co=function(t){return t.kind in ROOT_OPERATION_NODES},Qn=new WeakSet,fo=function(t){const n=new Set;if("name"in t&&t.name&&SchemableIdentifierNode.is(t.name)&&te(this,rn,Ii).call(this,t.name,n),"from"in t&&t.from)for(const s of t.from.froms)te(this,nr,Hr).call(this,s,n);if("into"in t&&t.into&&te(this,nr,Hr).call(this,t.into,n),"table"in t&&t.table&&te(this,nr,Hr).call(this,t.table,n),"joins"in t&&t.joins)for(const s of t.joins)te(this,nr,Hr).call(this,s.table,n);return"with"in t&&t.with&&te(this,Pn,ho).call(this,t.with,n),n},nr=new WeakSet,Hr=function(t,n){const s=TableNode.is(t)?t:AliasNode.is(t)&&TableNode.is(t.node)?t.node:null;s&&te(this,rn,Ii).call(this,s.table,n)},rn=new WeakSet,Ii=function(t,n){i(this,rr).has(t.identifier.name)||n.add(t.identifier.name)},Pn=new WeakSet,ho=function(t,n){for(const s of t.expressions)n.delete(s.name.table.table.identifier.name)};var nn;class WithSchemaPlugin{constructor(e){T(this,nn,void 0);A(this,nn,new WithSchemaTransformer(e))}transformQuery(e){return i(this,nn).transformNode(e.node)}async transformResult(e){return e.result}}nn=new WeakMap;var we;const Yt=class Yt{constructor(e){T(this,we,void 0);A(this,we,freeze(e))}selectFrom(e){return new SelectQueryBuilder({queryId:createQueryId(),executor:i(this,we).executor,queryNode:SelectQueryNode.create(parseTableExpressionOrList(e),i(this,we).withNode)})}insertInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:i(this,we).executor,queryNode:InsertQueryNode.create(parseTable(e),i(this,we).withNode)})}replaceInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:i(this,we).executor,queryNode:InsertQueryNode.create(parseTable(e),i(this,we).withNode,!0)})}deleteFrom(e){return new DeleteQueryBuilder({queryId:createQueryId(),executor:i(this,we).executor,queryNode:DeleteQueryNode.create(parseTableExpressionOrList(e),i(this,we).withNode)})}updateTable(e){return new UpdateQueryBuilder({queryId:createQueryId(),executor:i(this,we).executor,queryNode:UpdateQueryNode.create(parseTableExpression(e),i(this,we).withNode)})}with(e,t){const n=parseCommonTableExpression(e,t);return new Yt({...i(this,we),withNode:i(this,we).withNode?WithNode.cloneWithExpression(i(this,we).withNode,n):WithNode.create(n)})}withRecursive(e,t){const n=parseCommonTableExpression(e,t);return new Yt({...i(this,we),withNode:i(this,we).withNode?WithNode.cloneWithExpression(i(this,we).withNode,n):WithNode.create(n,{recursive:!0})})}withPlugin(e){return new Yt({...i(this,we),executor:i(this,we).executor.withPlugin(e)})}withoutPlugins(){return new Yt({...i(this,we),executor:i(this,we).executor.withoutPlugins()})}withSchema(e){return new Yt({...i(this,we),executor:i(this,we).executor.withPluginAtFront(new WithSchemaPlugin(e))})}};we=new WeakMap;let QueryCreator=Yt;var sn,_r,Or;class Deferred{constructor(){T(this,sn,void 0);T(this,_r,void 0);T(this,Or,void 0);le(this,"resolve",e=>{i(this,_r)&&i(this,_r).call(this,e)});le(this,"reject",e=>{i(this,Or)&&i(this,Or).call(this,e)});A(this,sn,new Promise((e,t)=>{A(this,Or,t),A(this,_r,e)}))}get promise(){return i(this,sn)}}sn=new WeakMap,_r=new WeakMap,Or=new WeakMap;const LOGGED_MESSAGES=new Set;function logOnce(r){LOGGED_MESSAGES.has(r)||(LOGGED_MESSAGES.add(r),console.log(r))}const NO_PLUGINS=freeze([]);var ir,on,Si;class QueryExecutorBase{constructor(e=NO_PLUGINS){T(this,on);T(this,ir,void 0);A(this,ir,e)}get plugins(){return i(this,ir)}transformQuery(e,t){for(const n of i(this,ir)){const s=n.transformQuery({node:e,queryId:t});if(s.kind===e.kind)e=s;else throw new Error(["KyselyPlugin.transformQuery must return a node","of the same kind that was given to it.",`The plugin was given a ${e.kind}`,`but it returned a ${s.kind}`].join(" "))}return e}async executeQuery(e,t){return await this.provideConnection(async n=>{const s=await n.executeQuery(e),a=await te(this,on,Si).call(this,s,t);return warnOfOutdatedDriverOrPlugins(s,a),a})}async*stream(e,t,n){const s=new Deferred,a=new Deferred;this.provideConnection(async f=>(s.resolve(f),await a.promise)).catch(f=>s.reject(f));const c=await s.promise;try{for await(const f of c.streamQuery(e,t))yield await te(this,on,Si).call(this,f,n)}finally{a.resolve()}}}ir=new WeakMap,on=new WeakSet,Si=async function(e,t){for(const n of i(this,ir))e=await n.transformResult({result:e,queryId:t});return e};function warnOfOutdatedDriverOrPlugins(r,e){const{numAffectedRows:t}=r;t===void 0&&r.numUpdatedOrDeletedRows===void 0||t!==void 0&&e.numAffectedRows!==void 0||logOnce("kysely:warning: outdated driver/plugin detected! QueryResult.numUpdatedOrDeletedRows is deprecated and will be removed in a future release.")}class NoopQueryExecutor extends QueryExecutorBase{get adapter(){throw new Error("this query cannot be compiled to SQL")}compileQuery(){throw new Error("this query cannot be compiled to SQL")}provideConnection(){throw new Error("this query cannot be executed")}withConnectionProvider(){throw new Error("this query cannot have a connection provider")}withPlugin(e){return new NoopQueryExecutor([...this.plugins,e])}withPlugins(e){return new NoopQueryExecutor([...this.plugins,...e])}withPluginAtFront(e){return new NoopQueryExecutor([e,...this.plugins])}withoutPlugins(){return new NoopQueryExecutor([])}}const NOOP_QUERY_EXECUTOR=new NoopQueryExecutor;function createSelectQueryBuilder(){return new SelectQueryBuilder({queryId:createQueryId(),executor:NOOP_QUERY_EXECUTOR,queryNode:SelectQueryNode.create(parseTableExpressionOrList([]))})}function createQueryCreator(){return new QueryCreator({executor:NOOP_QUERY_EXECUTOR})}function createJoinBuilder(r,e){return new JoinBuilder({joinNode:JoinNode.create(r,parseTableExpression(e))})}function createOverBuilder(){return new OverBuilder({overNode:OverNode.create()})}const WhenNode=freeze({is(r){return r.kind==="WhenNode"},create(r){return freeze({kind:"WhenNode",condition:r})},cloneWithResult(r,e){return freeze({...r,result:e})}}),CaseNode=freeze({is(r){return r.kind==="CaseNode"},create(r){return freeze({kind:"CaseNode",value:r})},cloneWithWhen(r,e){return freeze({...r,when:freeze(r.when?[...r.when,e]:[e])})},cloneWithThen(r,e){return freeze({...r,when:r.when?freeze([...r.when.slice(0,-1),WhenNode.cloneWithResult(r.when[r.when.length-1],e)]):void 0})},cloneWith(r,e){return freeze({...r,...e})}});function parseValueBinaryOperation(r,e,t){if(!isBinaryOperator(e)&&!isOperationNodeSource(e))throw new Error(`invalid binary operator ${JSON.stringify(e)}`);return isIsComparison(e,t)?parseIs(r,e,t):BinaryOperationNode.create(parseReferenceExpression(r),parseOperator(e),parseValueExpressionOrList(t))}function parseReferentialBinaryOperation(r,e,t){if(!isBinaryOperator(e)&&!isOperationNodeSource(e))throw new Error(`invalid binary operator ${JSON.stringify(e)}`);return BinaryOperationNode.create(parseReferenceExpression(r),parseOperator(e),parseReferenceExpression(t))}function parseValueComparison(r,e,t){if(!isComparisonOperator(e)&&!isOperationNodeSource(e))throw new Error(`invalid comparison operator ${JSON.stringify(e)}`);return parseValueBinaryOperation(r,e,t)}function parseReferentialComparison(r,e,t){if(!isComparisonOperator(e)&&!isOperationNodeSource(e))throw new Error(`invalid comparison operator ${JSON.stringify(e)}`);return parseReferentialBinaryOperation(r,e,t)}function parseWhere(r){return parseFilter("where",r)}function parseHaving(r){return parseFilter("having",r)}function parseOn(r){return parseFilter("on",r)}function parseWhen(r){return parseFilter("when",r)}function parseFilter(r,e){if(e.length===3)return parseValueComparison(e[0],e[1],e[2]);if(e.length===1)return parseOneArgFilterExpression(r,e[0]);throw createFilterExpressionError(r,e)}function isIsComparison(r,e){return(r==="is"||r==="is not")&&(isNull(e)||isBoolean(e))}function parseIs(r,e,t){return BinaryOperationNode.create(parseReferenceExpression(r),parseOperator(e),ValueNode.createImmediate(t))}function parseOperator(r){if(isString(r)&&OPERATORS.includes(r))return OperatorNode.create(r);if(isOperationNodeSource(r))return r.toOperationNode();throw new Error(`invalid operator ${JSON.stringify(r)}`)}function parseOneArgFilterExpression(r,e){if(isFunction(e)){if(r==="when")throw new Error("when method doesn't accept a callback as an argument");return CALLBACK_PARSERS[r](e)}else if(isOperationNodeSource(e)){const t=e.toOperationNode();if(RawNode.is(t)||BinaryOperationNode.is(t)||UnaryOperationNode.is(t)||ParensNode.is(t)||CaseNode.is(t))return t}else if(r==="when")return ValueNode.create(e);throw createFilterExpressionError(r,e)}function createFilterExpressionError(r,e){return new Error(`invalid arguments passed to a '${r}' method: ${JSON.stringify(e)}`)}const CALLBACK_PARSERS=freeze({where(r){const e=createSelectQueryBuilder(),t=expressionBuilder(),s=r(Object.assign(e,t)).toOperationNode();if(SelectQueryNode.is(s)){if(!s.where)throw new Error("no `where` methods called inside a group callback");return ParensNode.create(s.where.where)}else return s},having(r){const e=createSelectQueryBuilder(),t=expressionBuilder(),s=r(Object.assign(e,t)).toOperationNode();if(SelectQueryNode.is(s)){if(!s.having)throw new Error("no `having` methods called inside a group callback");return ParensNode.create(s.having.having)}else return s},on(r){const e=createJoinBuilder("InnerJoin","table"),t=expressionBuilder(),s=r(Object.assign(e,t)).toOperationNode();if(JoinNode.is(s)){if(!s.on)throw new Error("no `on` methods called inside a group callback");return ParensNode.create(s.on.on)}else return s}});function parseJoin(r,e){if(e.length===3)return parseSingleOnJoin(r,e[0],e[1],e[2]);if(e.length===2)return parseCallbackJoin(r,e[0],e[1]);throw new Error("not implemented")}function parseCallbackJoin(r,e,t){return t(createJoinBuilder(r,e)).toOperationNode()}function parseSingleOnJoin(r,e,t,n){return JoinNode.createWithOn(r,parseTableExpression(e),parseReferentialComparison(t,"=",n))}const OffsetNode=freeze({is(r){return r.kind==="OffsetNode"},create(r){return freeze({kind:"OffsetNode",offset:ValueNode.create(r)})}}),GroupByItemNode=freeze({is(r){return r.kind==="GroupByItemNode"},create(r){return freeze({kind:"GroupByItemNode",groupBy:r})}});function parseGroupBy(r){return r=isFunction(r)?r(expressionBuilder()):r,parseReferenceExpressionOrList(r).map(GroupByItemNode.create)}const SetOperationNode=freeze({is(r){return r.kind==="SetOperationNode"},create(r,e,t){return freeze({kind:"SetOperationNode",operator:r,expression:e,all:t})}});function parseSetOperation(r,e,t){return SetOperationNode.create(r,e.toOperationNode(),t)}var I;const j=class j{constructor(e){T(this,I,void 0);A(this,I,freeze(e))}get expressionType(){}where(...e){return new j({...i(this,I),queryNode:QueryNode.cloneWithWhere(i(this,I).queryNode,parseWhere(e))})}whereRef(e,t,n){return new j({...i(this,I),queryNode:QueryNode.cloneWithWhere(i(this,I).queryNode,parseReferentialComparison(e,t,n))})}orWhere(...e){return new j({...i(this,I),queryNode:QueryNode.cloneWithOrWhere(i(this,I).queryNode,parseWhere(e))})}orWhereRef(e,t,n){return new j({...i(this,I),queryNode:QueryNode.cloneWithOrWhere(i(this,I).queryNode,parseReferentialComparison(e,t,n))})}whereExists(e){return new j({...i(this,I),queryNode:QueryNode.cloneWithWhere(i(this,I).queryNode,parseExists(e))})}whereNotExists(e){return new j({...i(this,I),queryNode:QueryNode.cloneWithWhere(i(this,I).queryNode,parseNotExists(e))})}orWhereExists(e){return new j({...i(this,I),queryNode:QueryNode.cloneWithOrWhere(i(this,I).queryNode,parseExists(e))})}orWhereNotExists(e){return new j({...i(this,I),queryNode:QueryNode.cloneWithOrWhere(i(this,I).queryNode,parseNotExists(e))})}having(...e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseHaving(e))})}havingRef(e,t,n){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseReferentialComparison(e,t,n))})}orHaving(...e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithOrHaving(i(this,I).queryNode,parseHaving(e))})}orHavingRef(e,t,n){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithOrHaving(i(this,I).queryNode,parseReferentialComparison(e,t,n))})}havingExists(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseExists(e))})}havingNotExist(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseNotExists(e))})}havingNotExists(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithHaving(i(this,I).queryNode,parseNotExists(e))})}orHavingExists(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithOrHaving(i(this,I).queryNode,parseExists(e))})}orHavingNotExists(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithOrHaving(i(this,I).queryNode,parseNotExists(e))})}select(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithSelections(i(this,I).queryNode,parseSelectArg(e))})}distinctOn(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithDistinctOn(i(this,I).queryNode,parseReferenceExpressionOrList(e))})}modifyFront(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithFrontModifier(i(this,I).queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}modifyEnd(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}distinct(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithFrontModifier(i(this,I).queryNode,SelectModifierNode.create("Distinct"))})}forUpdate(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("ForUpdate"))})}forShare(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("ForShare"))})}forKeyShare(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("ForKeyShare"))})}forNoKeyUpdate(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("ForNoKeyUpdate"))})}skipLocked(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("SkipLocked"))})}noWait(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,I).queryNode,SelectModifierNode.create("NoWait"))})}selectAll(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithSelections(i(this,I).queryNode,parseSelectAll(e))})}innerJoin(...e){return new j({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new j({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new j({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new j({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("FullJoin",e))})}innerJoinLateral(...e){return new j({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("LateralInnerJoin",e))})}leftJoinLateral(...e){return new j({...i(this,I),queryNode:QueryNode.cloneWithJoin(i(this,I).queryNode,parseJoin("LateralLeftJoin",e))})}orderBy(e,t){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithOrderByItem(i(this,I).queryNode,parseOrderBy(e,t))})}groupBy(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithGroupByItems(i(this,I).queryNode,parseGroupBy(e))})}limit(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithLimit(i(this,I).queryNode,LimitNode.create(e))})}offset(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithOffset(i(this,I).queryNode,OffsetNode.create(e))})}union(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("union",e,!1))})}unionAll(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("union",e,!0))})}intersect(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("intersect",e,!1))})}intersectAll(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("intersect",e,!0))})}except(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("except",e,!1))})}exceptAll(e){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithSetOperation(i(this,I).queryNode,parseSetOperation("except",e,!0))})}as(e){return new AliasedSelectQueryBuilder(this,e)}clearSelect(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithoutSelections(i(this,I).queryNode)})}clearWhere(){return new j({...i(this,I),queryNode:QueryNode.cloneWithoutWhere(i(this,I).queryNode)})}clearLimit(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithoutLimit(i(this,I).queryNode)})}clearOffset(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithoutOffset(i(this,I).queryNode)})}clearOrderBy(){return new j({...i(this,I),queryNode:SelectQueryNode.cloneWithoutOrderBy(i(this,I).queryNode)})}$call(e){return e(this)}call(e){return this.$call(e)}$if(e,t){return e?t(this):new j({...i(this,I)})}if(e,t){return this.$if(e,t)}$castTo(){return new j(i(this,I))}castTo(){return this.$castTo()}$narrowType(){return new j(i(this,I))}$assertType(){return new j(i(this,I))}assertType(){return new j(i(this,I))}withPlugin(e){return new j({...i(this,I),executor:i(this,I).executor.withPlugin(e)})}toOperationNode(){return i(this,I).executor.transformQuery(i(this,I).queryNode,i(this,I).queryId)}compile(){return i(this,I).executor.compileQuery(this.toOperationNode(),i(this,I).queryId)}async execute(){const e=this.compile();return(await i(this,I).executor.executeQuery(e,i(this,I).queryId)).rows}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,I).executor.stream(t,e,i(this,I).queryId);for await(const s of n)yield*s.rows}async explain(e,t){return await new j({...i(this,I),queryNode:QueryNode.cloneWithExplain(i(this,I).queryNode,e,t)}).execute()}};I=new WeakMap;let SelectQueryBuilder=j;preventAwait(SelectQueryBuilder,"don't await SelectQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");var Tr,vr;class AliasedSelectQueryBuilder{constructor(e,t){T(this,Tr,void 0);T(this,vr,void 0);A(this,Tr,e),A(this,vr,t)}get expression(){return i(this,Tr)}get alias(){return i(this,vr)}toOperationNode(){return AliasNode.create(i(this,Tr).toOperationNode(),IdentifierNode.create(i(this,vr)))}}Tr=new WeakMap,vr=new WeakMap;var Ir;const Ai=class Ai{constructor(e){T(this,Ir,void 0);A(this,Ir,e)}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}$castTo(){return new Ai(i(this,Ir))}toOperationNode(){return i(this,Ir)}};Ir=new WeakMap;let ExpressionWrapper=Ai;var Sr,Pt;class AliasedExpressionWrapper{constructor(e,t){T(this,Sr,void 0);T(this,Pt,void 0);A(this,Sr,e),A(this,Pt,t)}get expression(){return i(this,Sr)}get alias(){return i(this,Pt)}toOperationNode(){return AliasNode.create(i(this,Sr).toOperationNode(),isOperationNodeSource(i(this,Pt))?i(this,Pt).toOperationNode():IdentifierNode.create(i(this,Pt)))}}Sr=new WeakMap,Pt=new WeakMap;const AggregateFunctionNode=freeze({is(r){return r.kind==="AggregateFunctionNode"},create(r,e=[]){return freeze({kind:"AggregateFunctionNode",func:r,aggregated:e})},cloneWithDistinct(r){return freeze({...r,distinct:!0})},cloneWithFilter(r,e){return freeze({...r,filter:r.filter?WhereNode.cloneWithOperation(r.filter,"And",e):WhereNode.create(e)})},cloneWithOrFilter(r,e){return freeze({...r,filter:r.filter?WhereNode.cloneWithOperation(r.filter,"Or",e):WhereNode.create(e)})},cloneWithOver(r,e){return freeze({...r,over:e})}}),FunctionNode=freeze({is(r){return r.kind==="FunctionNode"},create(r,e){return freeze({kind:"FunctionNode",func:r,arguments:e})}});var _e;const dt=class dt{constructor(e){T(this,_e,void 0);A(this,_e,freeze(e))}get expressionType(){}as(e){return new AliasedAggregateFunctionBuilder(this,e)}distinct(){return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithDistinct(i(this,_e).aggregateFunctionNode)})}filterWhere(...e){return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,_e).aggregateFunctionNode,parseWhere(e))})}filterWhereExists(e){return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,_e).aggregateFunctionNode,parseExists(e))})}filterWhereNotExists(e){return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,_e).aggregateFunctionNode,parseNotExists(e))})}filterWhereRef(e,t,n){return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,_e).aggregateFunctionNode,parseReferentialComparison(e,t,n))})}orFilterWhere(...e){return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithOrFilter(i(this,_e).aggregateFunctionNode,parseWhere(e))})}orFilterWhereExists(e){return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithOrFilter(i(this,_e).aggregateFunctionNode,parseExists(e))})}orFilterWhereNotExists(e){return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithOrFilter(i(this,_e).aggregateFunctionNode,parseNotExists(e))})}orFilterWhereRef(e,t,n){return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithOrFilter(i(this,_e).aggregateFunctionNode,parseReferentialComparison(e,t,n))})}over(e){const t=createOverBuilder();return new dt({...i(this,_e),aggregateFunctionNode:AggregateFunctionNode.cloneWithOver(i(this,_e).aggregateFunctionNode,(e?e(t):t).toOperationNode())})}$call(e){return e(this)}toOperationNode(){return i(this,_e).aggregateFunctionNode}};_e=new WeakMap;let AggregateFunctionBuilder=dt;preventAwait(AggregateFunctionBuilder,"don't await AggregateFunctionBuilder instances. They are never executed directly and are always just a part of a query.");var Cr,Rr;class AliasedAggregateFunctionBuilder{constructor(e,t){T(this,Cr,void 0);T(this,Rr,void 0);A(this,Cr,e),A(this,Rr,t)}get expression(){return i(this,Cr)}get alias(){return i(this,Rr)}toOperationNode(){return AliasNode.create(i(this,Cr).toOperationNode(),IdentifierNode.create(i(this,Rr)))}}Cr=new WeakMap,Rr=new WeakMap;function createFunctionModule(){const r=(t,n)=>new ExpressionWrapper(FunctionNode.create(t,parseReferenceExpressionOrList(n))),e=(t,n)=>new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create(t,n?parseReferenceExpressionOrList(n):void 0)});return Object.assign(r,{agg:e,avg(t){return e("avg",[t])},coalesce(t,...n){return r("coalesce",[t,...n])},count(t){return e("count",[t])},countAll(t){return new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create("count",parseSelectAll(t))})},max(t){return e("max",[t])},min(t){return e("min",[t])},sum(t){return e("sum",[t])}})}var xr;class CaseBuilder{constructor(e){T(this,xr,void 0);A(this,xr,freeze(e))}when(...e){return new CaseThenBuilder({...i(this,xr),node:CaseNode.cloneWithWhen(i(this,xr).node,WhenNode.create(parseWhen(e)))})}}xr=new WeakMap;var kr;class CaseThenBuilder{constructor(e){T(this,kr,void 0);A(this,kr,freeze(e))}then(e){return new CaseWhenBuilder({...i(this,kr),node:CaseNode.cloneWithThen(i(this,kr).node,parseValueExpression(e))})}}kr=new WeakMap;var vt;class CaseWhenBuilder{constructor(e){T(this,vt,void 0);A(this,vt,freeze(e))}when(...e){return new CaseThenBuilder({...i(this,vt),node:CaseNode.cloneWithWhen(i(this,vt).node,WhenNode.create(parseWhen(e)))})}else(e){return new CaseEndBuilder({...i(this,vt),node:CaseNode.cloneWith(i(this,vt).node,{else:parseValueExpression(e)})})}end(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,vt).node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,vt).node,{isStatement:!0}))}}vt=new WeakMap;var Ar;class CaseEndBuilder{constructor(e){T(this,Ar,void 0);A(this,Ar,freeze(e))}end(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,Ar).node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,Ar).node,{isStatement:!0}))}}Ar=new WeakMap;function createExpressionBuilder(r=NOOP_QUERY_EXECUTOR){function e(t,n){return new ExpressionWrapper(parseUnaryOperation(t,n))}return{get fn(){return createFunctionModule()},selectFrom(t){return new SelectQueryBuilder({queryId:createQueryId(),executor:r,queryNode:SelectQueryNode.create(parseTableExpressionOrList(t))})},case(t){return new CaseBuilder({node:CaseNode.create(isUndefined(t)?void 0:parseReferenceExpression(t))})},ref(t){return new ExpressionWrapper(parseStringReference(t))},val(t){return new ExpressionWrapper(parseValueExpressionOrList(t))},cmpr(t,n,s){return new ExpressionWrapper(parseValueBinaryOperation(t,n,s))},bxp(t,n,s){return new ExpressionWrapper(parseValueBinaryOperation(t,n,s))},unary:e,not(t){return e("not",t)},exists(t){return e("exists",t)},neg(t){return e("-",t)},and(t){if(t.length===0)return new ExpressionWrapper(ValueNode.createImmediate(!0));if(t.length===1)return new ExpressionWrapper(t[0].toOperationNode());let n=AndNode.create(t[0].toOperationNode(),t[1].toOperationNode());for(let s=2;s<t.length;++s)n=AndNode.create(n,t[s].toOperationNode());return new ExpressionWrapper(ParensNode.create(n))},or(t){if(t.length===0)return new ExpressionWrapper(ValueNode.createImmediate(!1));if(t.length===1)return new ExpressionWrapper(t[0].toOperationNode());let n=OrNode.create(t[0].toOperationNode(),t[1].toOperationNode());for(let s=2;s<t.length;++s)n=OrNode.create(n,t[s].toOperationNode());return new ExpressionWrapper(ParensNode.create(n))},withSchema(t){return createExpressionBuilder(r.withPluginAtFront(new WithSchemaPlugin(t)))}}}function expressionBuilder(r){return createExpressionBuilder()}function parseExpression(r){if(isOperationNodeSource(r))return r.toOperationNode();if(isFunction(r))return r(expressionBuilder()).toOperationNode();throw new Error(`invalid expression: ${JSON.stringify(r)}`)}function parseAliasedExpression(r){if(isOperationNodeSource(r))return r.toOperationNode();if(isFunction(r))return r(expressionBuilder()).toOperationNode();throw new Error(`invalid aliased expression: ${JSON.stringify(r)}`)}function isExpressionOrFactory(r){return isExpression(r)||isAliasedExpression(r)||isFunction(r)}function parseTableExpressionOrList(r){return isReadonlyArray(r)?r.map(e=>parseTableExpression(e)):[parseTableExpression(r)]}function parseTableExpression(r){return isString(r)?parseAliasedTable(r):parseAliasedExpression(r)}function parseAliasedTable(r){const e=" as ";if(r.includes(e)){const[t,n]=r.split(e).map(trim$1);return AliasNode.create(parseTable(t),IdentifierNode.create(n))}else return parseTable(r)}function parseTable(r){const e=".";if(r.includes(e)){const[t,n]=r.split(e).map(trim$1);return TableNode.createWithSchema(t,n)}else return TableNode.create(r)}function trim$1(r){return r.trim()}const AddColumnNode=freeze({is(r){return r.kind==="AddColumnNode"},create(r){return freeze({kind:"AddColumnNode",column:r})}}),AlterColumnNode=freeze({is(r){return r.kind==="AlterColumnNode"},create(r){return freeze({kind:"AlterColumnNode",column:ColumnNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}}),ColumnDefinitionNode=freeze({is(r){return r.kind==="ColumnDefinitionNode"},create(r,e){return freeze({kind:"ColumnDefinitionNode",column:ColumnNode.create(r),dataType:e})},cloneWithFrontModifier(r,e){return freeze({...r,frontModifiers:r.frontModifiers?freeze([...r.frontModifiers,e]):[e]})},cloneWithEndModifier(r,e){return freeze({...r,endModifiers:r.endModifiers?freeze([...r.endModifiers,e]):[e]})},cloneWith(r,e){return freeze({...r,...e})}}),DropColumnNode=freeze({is(r){return r.kind==="DropColumnNode"},create(r){return freeze({kind:"DropColumnNode",column:ColumnNode.create(r)})}}),RenameColumnNode=freeze({is(r){return r.kind==="RenameColumnNode"},create(r,e){return freeze({kind:"RenameColumnNode",column:ColumnNode.create(r),renameTo:ColumnNode.create(e)})}}),CheckConstraintNode=freeze({is(r){return r.kind==="CheckConstraintNode"},create(r,e){return freeze({kind:"CheckConstraintNode",expression:r,name:e?IdentifierNode.create(e):void 0})}}),ON_MODIFY_FOREIGN_ACTIONS=["no action","restrict","cascade","set null","set default"],ReferencesNode=freeze({is(r){return r.kind==="ReferencesNode"},create(r,e){return freeze({kind:"ReferencesNode",table:r,columns:freeze([...e])})},cloneWithOnDelete(r,e){return freeze({...r,onDelete:e})},cloneWithOnUpdate(r,e){return freeze({...r,onUpdate:e})}});function parseDefaultValueExpression(r){return isOperationNodeSource(r)?r.toOperationNode():ValueNode.createImmediate(r)}const GeneratedNode=freeze({is(r){return r.kind==="GeneratedNode"},create(r){return freeze({kind:"GeneratedNode",...r})},createWithExpression(r){return freeze({kind:"GeneratedNode",always:!0,expression:r})},cloneWith(r,e){return freeze({...r,...e})}}),DefaultValueNode=freeze({is(r){return r.kind==="DefaultValueNode"},create(r){return freeze({kind:"DefaultValueNode",defaultValue:r})}});function parseOnModifyForeignAction(r){if(ON_MODIFY_FOREIGN_ACTIONS.includes(r))return r;throw new Error(`invalid OnModifyForeignAction ${r}`)}var ye;const Qe=class Qe{constructor(e){T(this,ye,void 0);A(this,ye,e)}autoIncrement(){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{autoIncrement:!0}))}primaryKey(){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{primaryKey:!0}))}references(e){const t=parseStringReference(e);if(!ReferenceNode.is(t)||SelectAllNode.is(t.column))throw new Error(`invalid call references('${e}'). The reference must have format table.column or schema.table.column`);return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{references:ReferencesNode.create(t.table,[t.column])}))}onDelete(e){if(!i(this,ye).references)throw new Error("on delete constraint can only be added for foreign keys");return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{references:ReferencesNode.cloneWithOnDelete(i(this,ye).references,parseOnModifyForeignAction(e))}))}onUpdate(e){if(!i(this,ye).references)throw new Error("on update constraint can only be added for foreign keys");return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{references:ReferencesNode.cloneWithOnUpdate(i(this,ye).references,parseOnModifyForeignAction(e))}))}unique(){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{unique:!0}))}notNull(){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{notNull:!0}))}unsigned(){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{unsigned:!0}))}defaultTo(e){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{defaultTo:DefaultValueNode.create(parseDefaultValueExpression(e))}))}check(e){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{check:CheckConstraintNode.create(e.toOperationNode())}))}generatedAlwaysAs(e){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{generated:GeneratedNode.createWithExpression(e.toOperationNode())}))}generatedAlwaysAsIdentity(){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{generated:GeneratedNode.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{generated:GeneratedNode.create({identity:!0,byDefault:!0})}))}stored(){if(!i(this,ye).generated)throw new Error("stored() can only be called after generatedAlwaysAs");return new Qe(ColumnDefinitionNode.cloneWith(i(this,ye),{generated:GeneratedNode.cloneWith(i(this,ye).generated,{stored:!0})}))}modifyFront(e){return new Qe(ColumnDefinitionNode.cloneWithFrontModifier(i(this,ye),e.toOperationNode()))}modifyEnd(e){return new Qe(ColumnDefinitionNode.cloneWithEndModifier(i(this,ye),e.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return i(this,ye)}};ye=new WeakMap;let ColumnDefinitionBuilder=Qe;preventAwait(ColumnDefinitionBuilder,"don't await ColumnDefinitionBuilder instances directly.");const ModifyColumnNode=freeze({is(r){return r.kind==="ModifyColumnNode"},create(r){return freeze({kind:"ModifyColumnNode",column:r})}}),DataTypeNode=freeze({is(r){return r.kind==="DataTypeNode"},create(r){return freeze({kind:"DataTypeNode",dataType:r})}});function parseDataTypeExpression(r){return isOperationNodeSource(r)?r.toOperationNode():DataTypeNode.create(r)}const ForeignKeyConstraintNode=freeze({is(r){return r.kind==="ForeignKeyConstraintNode"},create(r,e,t,n){return freeze({kind:"ForeignKeyConstraintNode",columns:r,references:ReferencesNode.create(e,t),name:n?IdentifierNode.create(n):void 0})},cloneWith(r,e){return freeze({...r,...e})}});var sr;const Mn=class Mn{constructor(e){T(this,sr,void 0);A(this,sr,e)}onDelete(e){return new Mn(ForeignKeyConstraintNode.cloneWith(i(this,sr),{onDelete:parseOnModifyForeignAction(e)}))}onUpdate(e){return new Mn(ForeignKeyConstraintNode.cloneWith(i(this,sr),{onUpdate:parseOnModifyForeignAction(e)}))}$call(e){return e(this)}toOperationNode(){return i(this,sr)}};sr=new WeakMap;let ForeignKeyConstraintBuilder=Mn;preventAwait(ForeignKeyConstraintBuilder,"don't await ForeignKeyConstraintBuilder instances directly.");const AddConstraintNode=freeze({is(r){return r.kind==="AddConstraintNode"},create(r){return freeze({kind:"AddConstraintNode",constraint:r})}}),UniqueConstraintNode=freeze({is(r){return r.kind==="UniqueConstraintNode"},create(r,e){return freeze({kind:"UniqueConstraintNode",columns:freeze(r.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0})}}),DropConstraintNode=freeze({is(r){return r.kind==="DropConstraintNode"},create(r){return freeze({kind:"DropConstraintNode",constraintName:IdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}});class AlterColumnBuilder{constructor(e){le(this,"alterColumnNode");this.alterColumnNode=e}setDataType(e){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{dataType:parseDataTypeExpression(e)}))}setDefault(e){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{setDefault:parseDefaultValueExpression(e)}))}dropDefault(){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{dropDefault:!0}))}setNotNull(){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{setNotNull:!0}))}dropNotNull(){return new AlteredColumnBuilder(AlterColumnNode.cloneWith(this.alterColumnNode,{dropNotNull:!0}))}$call(e){return e(this)}}class AlteredColumnBuilder extends AlterColumnBuilder{toOperationNode(){return this.alterColumnNode}}var Nt;class AlterTableExecutor{constructor(e){T(this,Nt,void 0);A(this,Nt,freeze(e))}toOperationNode(){return i(this,Nt).executor.transformQuery(i(this,Nt).node,i(this,Nt).queryId)}compile(){return i(this,Nt).executor.compileQuery(this.toOperationNode(),i(this,Nt).queryId)}async execute(){await i(this,Nt).executor.executeQuery(this.compile(),i(this,Nt).queryId)}}Nt=new WeakMap;preventAwait(AlterTableExecutor,"don't await AlterTableExecutor instances directly. To execute the query you need to call `execute`");var Ge;const Un=class Un{constructor(e){T(this,Ge,void 0);A(this,Ge,freeze(e))}onDelete(e){return new Un({...i(this,Ge),constraintBuilder:i(this,Ge).constraintBuilder.onDelete(e)})}onUpdate(e){return new Un({...i(this,Ge),constraintBuilder:i(this,Ge).constraintBuilder.onUpdate(e)})}$call(e){return e(this)}toOperationNode(){return i(this,Ge).executor.transformQuery(AlterTableNode.cloneWithTableProps(i(this,Ge).node,{addConstraint:AddConstraintNode.create(i(this,Ge).constraintBuilder.toOperationNode())}),i(this,Ge).queryId)}compile(){return i(this,Ge).executor.compileQuery(this.toOperationNode(),i(this,Ge).queryId)}async execute(){await i(this,Ge).executor.executeQuery(this.compile(),i(this,Ge).queryId)}};Ge=new WeakMap;let AlterTableAddForeignKeyConstraintBuilder=Un;preventAwait(AlterTableAddForeignKeyConstraintBuilder,"don't await AlterTableAddForeignKeyConstraintBuilder instances directly. To execute the query you need to call `execute`");var Le;const Jr=class Jr{constructor(e){T(this,Le,void 0);A(this,Le,freeze(e))}ifExists(){return new Jr({...i(this,Le),node:AlterTableNode.cloneWithTableProps(i(this,Le).node,{dropConstraint:DropConstraintNode.cloneWith(i(this,Le).node.dropConstraint,{ifExists:!0})})})}cascade(){return new Jr({...i(this,Le),node:AlterTableNode.cloneWithTableProps(i(this,Le).node,{dropConstraint:DropConstraintNode.cloneWith(i(this,Le).node.dropConstraint,{modifier:"cascade"})})})}restrict(){return new Jr({...i(this,Le),node:AlterTableNode.cloneWithTableProps(i(this,Le).node,{dropConstraint:DropConstraintNode.cloneWith(i(this,Le).node.dropConstraint,{modifier:"restrict"})})})}$call(e){return e(this)}toOperationNode(){return i(this,Le).executor.transformQuery(i(this,Le).node,i(this,Le).queryId)}compile(){return i(this,Le).executor.compileQuery(this.toOperationNode(),i(this,Le).queryId)}async execute(){await i(this,Le).executor.executeQuery(this.compile(),i(this,Le).queryId)}};Le=new WeakMap;let AlterTableDropConstraintBuilder=Jr;preventAwait(AlterTableDropConstraintBuilder,"don't await AlterTableDropConstraintBuilder instances directly. To execute the query you need to call `execute`");var Oe;class AlterTableBuilder{constructor(e){T(this,Oe,void 0);A(this,Oe,freeze(e))}renameTo(e){return new AlterTableExecutor({...i(this,Oe),node:AlterTableNode.cloneWithTableProps(i(this,Oe).node,{renameTo:parseTable(e)})})}setSchema(e){return new AlterTableExecutor({...i(this,Oe),node:AlterTableNode.cloneWithTableProps(i(this,Oe).node,{setSchema:IdentifierNode.create(e)})})}alterColumn(e,t){const n=t(new AlterColumnBuilder(AlterColumnNode.create(e)));return new AlterTableColumnAlteringBuilder({...i(this,Oe),node:AlterTableNode.cloneWithColumnAlteration(i(this,Oe).node,n.toOperationNode())})}dropColumn(e){return new AlterTableColumnAlteringBuilder({...i(this,Oe),node:AlterTableNode.cloneWithColumnAlteration(i(this,Oe).node,DropColumnNode.create(e))})}renameColumn(e,t){return new AlterTableColumnAlteringBuilder({...i(this,Oe),node:AlterTableNode.cloneWithColumnAlteration(i(this,Oe).node,RenameColumnNode.create(e,t))})}addColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...i(this,Oe),node:AlterTableNode.cloneWithColumnAlteration(i(this,Oe).node,AddColumnNode.create(s.toOperationNode()))})}modifyColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...i(this,Oe),node:AlterTableNode.cloneWithColumnAlteration(i(this,Oe).node,ModifyColumnNode.create(s.toOperationNode()))})}addUniqueConstraint(e,t){return new AlterTableExecutor({...i(this,Oe),node:AlterTableNode.cloneWithTableProps(i(this,Oe).node,{addConstraint:AddConstraintNode.create(UniqueConstraintNode.create(t,e))})})}addCheckConstraint(e,t){return new AlterTableExecutor({...i(this,Oe),node:AlterTableNode.cloneWithTableProps(i(this,Oe).node,{addConstraint:AddConstraintNode.create(CheckConstraintNode.create(t.toOperationNode(),e))})})}addForeignKeyConstraint(e,t,n,s){return new AlterTableAddForeignKeyConstraintBuilder({...i(this,Oe),constraintBuilder:new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(t.map(ColumnNode.create),parseTable(n),s.map(ColumnNode.create),e))})}dropConstraint(e){return new AlterTableDropConstraintBuilder({...i(this,Oe),node:AlterTableNode.cloneWithTableProps(i(this,Oe).node,{dropConstraint:DropConstraintNode.create(e)})})}$call(e){return e(this)}call(e){return this.$call(e)}}Oe=new WeakMap;var Ae;const Zt=class Zt{constructor(e){T(this,Ae,void 0);A(this,Ae,freeze(e))}alterColumn(e,t){const n=t(new AlterColumnBuilder(AlterColumnNode.create(e)));return new Zt({...i(this,Ae),node:AlterTableNode.cloneWithColumnAlteration(i(this,Ae).node,n.toOperationNode())})}dropColumn(e){return new Zt({...i(this,Ae),node:AlterTableNode.cloneWithColumnAlteration(i(this,Ae).node,DropColumnNode.create(e))})}renameColumn(e,t){return new Zt({...i(this,Ae),node:AlterTableNode.cloneWithColumnAlteration(i(this,Ae).node,RenameColumnNode.create(e,t))})}addColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new Zt({...i(this,Ae),node:AlterTableNode.cloneWithColumnAlteration(i(this,Ae).node,AddColumnNode.create(s.toOperationNode()))})}modifyColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new Zt({...i(this,Ae),node:AlterTableNode.cloneWithColumnAlteration(i(this,Ae).node,ModifyColumnNode.create(s.toOperationNode()))})}toOperationNode(){return i(this,Ae).executor.transformQuery(i(this,Ae).node,i(this,Ae).queryId)}compile(){return i(this,Ae).executor.compileQuery(this.toOperationNode(),i(this,Ae).queryId)}async execute(){await i(this,Ae).executor.executeQuery(this.compile(),i(this,Ae).queryId)}};Ae=new WeakMap;let AlterTableColumnAlteringBuilder=Zt;preventAwait(AlterTableBuilder,"don't await AlterTableBuilder instances");preventAwait(AlterColumnBuilder,"don't await AlterColumnBuilder instances");preventAwait(AlterTableColumnAlteringBuilder,"don't await AlterTableColumnAlteringBuilder instances directly. To execute the query you need to call `execute`");class ImmediateValueTransformer extends OperationNodeTransformer{transformValue(e){return{...super.transformValue(e),immediate:!0}}}var Ne;const Tt=class Tt{constructor(e){T(this,Ne,void 0);A(this,Ne,freeze(e))}ifNotExists(){return new Tt({...i(this,Ne),node:CreateIndexNode.cloneWith(i(this,Ne).node,{ifNotExists:!0})})}unique(){return new Tt({...i(this,Ne),node:CreateIndexNode.cloneWith(i(this,Ne).node,{unique:!0})})}on(e){return new Tt({...i(this,Ne),node:CreateIndexNode.cloneWith(i(this,Ne).node,{table:parseTable(e)})})}column(e){return new Tt({...i(this,Ne),node:CreateIndexNode.cloneWithColumns(i(this,Ne).node,[parseOrderedColumnName(e)])})}columns(e){return new Tt({...i(this,Ne),node:CreateIndexNode.cloneWithColumns(i(this,Ne).node,e.map(parseOrderedColumnName))})}expression(e){return new Tt({...i(this,Ne),node:CreateIndexNode.cloneWithColumns(i(this,Ne).node,[e.toOperationNode()])})}using(e){return new Tt({...i(this,Ne),node:CreateIndexNode.cloneWith(i(this,Ne).node,{using:RawNode.createWithSql(e)})})}where(...e){const t=new ImmediateValueTransformer;return new Tt({...i(this,Ne),node:QueryNode.cloneWithWhere(i(this,Ne).node,t.transformNode(parseWhere(e)))})}$call(e){return e(this)}toOperationNode(){return i(this,Ne).executor.transformQuery(i(this,Ne).node,i(this,Ne).queryId)}compile(){return i(this,Ne).executor.compileQuery(this.toOperationNode(),i(this,Ne).queryId)}async execute(){await i(this,Ne).executor.executeQuery(this.compile(),i(this,Ne).queryId)}};Ne=new WeakMap;let CreateIndexBuilder=Tt;preventAwait(CreateIndexBuilder,"don't await CreateIndexBuilder instances directly. To execute the query you need to call `execute`");var ot;const Wi=class Wi{constructor(e){T(this,ot,void 0);A(this,ot,freeze(e))}ifNotExists(){return new Wi({...i(this,ot),node:CreateSchemaNode.cloneWith(i(this,ot).node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,ot).executor.transformQuery(i(this,ot).node,i(this,ot).queryId)}compile(){return i(this,ot).executor.compileQuery(this.toOperationNode(),i(this,ot).queryId)}async execute(){await i(this,ot).executor.executeQuery(this.compile(),i(this,ot).queryId)}};ot=new WeakMap;let CreateSchemaBuilder=Wi;preventAwait(CreateSchemaBuilder,"don't await CreateSchemaBuilder instances directly. To execute the query you need to call `execute`");const PrimaryConstraintNode=freeze({is(r){return r.kind==="PrimaryKeyConstraintNode"},create(r,e){return freeze({kind:"PrimaryKeyConstraintNode",columns:freeze(r.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0})}});function parseOnCommitAction(r){if(ON_COMMIT_ACTIONS.includes(r))return r;throw new Error(`invalid OnCommitAction ${r}`)}var de;const ft=class ft{constructor(e){T(this,de,void 0);A(this,de,freeze(e))}temporary(){return new ft({...i(this,de),node:CreateTableNode.cloneWith(i(this,de).node,{temporary:!0})})}onCommit(e){return new ft({...i(this,de),node:CreateTableNode.cloneWith(i(this,de).node,{onCommit:parseOnCommitAction(e)})})}ifNotExists(){return new ft({...i(this,de),node:CreateTableNode.cloneWith(i(this,de).node,{ifNotExists:!0})})}addColumn(e,t,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new ft({...i(this,de),node:CreateTableNode.cloneWithColumn(i(this,de).node,s.toOperationNode())})}addPrimaryKeyConstraint(e,t){return new ft({...i(this,de),node:CreateTableNode.cloneWithConstraint(i(this,de).node,PrimaryConstraintNode.create(t,e))})}addUniqueConstraint(e,t){return new ft({...i(this,de),node:CreateTableNode.cloneWithConstraint(i(this,de).node,UniqueConstraintNode.create(t,e))})}addCheckConstraint(e,t){return new ft({...i(this,de),node:CreateTableNode.cloneWithConstraint(i(this,de).node,CheckConstraintNode.create(t.toOperationNode(),e))})}addForeignKeyConstraint(e,t,n,s,a=noop$1){const c=a(new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(t.map(ColumnNode.create),parseTable(n),s.map(ColumnNode.create),e)));return new ft({...i(this,de),node:CreateTableNode.cloneWithConstraint(i(this,de).node,c.toOperationNode())})}modifyFront(e){return new ft({...i(this,de),node:CreateTableNode.cloneWithFrontModifier(i(this,de).node,e.toOperationNode())})}modifyEnd(e){return new ft({...i(this,de),node:CreateTableNode.cloneWithEndModifier(i(this,de).node,e.toOperationNode())})}$call(e){return e(this)}call(e){return this.$call(e)}toOperationNode(){return i(this,de).executor.transformQuery(i(this,de).node,i(this,de).queryId)}compile(){return i(this,de).executor.compileQuery(this.toOperationNode(),i(this,de).queryId)}async execute(){await i(this,de).executor.executeQuery(this.compile(),i(this,de).queryId)}};de=new WeakMap;let CreateTableBuilder=ft;preventAwait(CreateTableBuilder,"don't await CreateTableBuilder instances directly. To execute the query you need to call `execute`");var He;const jr=class jr{constructor(e){T(this,He,void 0);A(this,He,freeze(e))}on(e){return new jr({...i(this,He),node:DropIndexNode.cloneWith(i(this,He).node,{table:parseTable(e)})})}ifExists(){return new jr({...i(this,He),node:DropIndexNode.cloneWith(i(this,He).node,{ifExists:!0})})}cascade(){return new jr({...i(this,He),node:DropIndexNode.cloneWith(i(this,He).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,He).executor.transformQuery(i(this,He).node,i(this,He).queryId)}compile(){return i(this,He).executor.compileQuery(this.toOperationNode(),i(this,He).queryId)}async execute(){await i(this,He).executor.executeQuery(this.compile(),i(this,He).queryId)}};He=new WeakMap;let DropIndexBuilder=jr;preventAwait(DropIndexBuilder,"don't await DropIndexBuilder instances directly. To execute the query you need to call `execute`");var Ze;const $n=class $n{constructor(e){T(this,Ze,void 0);A(this,Ze,freeze(e))}ifExists(){return new $n({...i(this,Ze),node:DropSchemaNode.cloneWith(i(this,Ze).node,{ifExists:!0})})}cascade(){return new $n({...i(this,Ze),node:DropSchemaNode.cloneWith(i(this,Ze).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,Ze).executor.transformQuery(i(this,Ze).node,i(this,Ze).queryId)}compile(){return i(this,Ze).executor.compileQuery(this.toOperationNode(),i(this,Ze).queryId)}async execute(){await i(this,Ze).executor.executeQuery(this.compile(),i(this,Ze).queryId)}};Ze=new WeakMap;let DropSchemaBuilder=$n;preventAwait(DropSchemaBuilder,"don't await DropSchemaBuilder instances directly. To execute the query you need to call `execute`");var et;const Vn=class Vn{constructor(e){T(this,et,void 0);A(this,et,freeze(e))}ifExists(){return new Vn({...i(this,et),node:DropTableNode.cloneWith(i(this,et).node,{ifExists:!0})})}cascade(){return new Vn({...i(this,et),node:DropTableNode.cloneWith(i(this,et).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,et).executor.transformQuery(i(this,et).node,i(this,et).queryId)}compile(){return i(this,et).executor.compileQuery(this.toOperationNode(),i(this,et).queryId)}async execute(){await i(this,et).executor.executeQuery(this.compile(),i(this,et).queryId)}};et=new WeakMap;let DropTableBuilder=Vn;preventAwait(DropTableBuilder,"don't await DropTableBuilder instances directly. To execute the query you need to call `execute`");const CreateViewNode=freeze({is(r){return r.kind==="CreateViewNode"},create(r){return freeze({kind:"CreateViewNode",name:SchemableIdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}});var Hn;class ImmediateValuePlugin{constructor(){T(this,Hn,new ImmediateValueTransformer)}transformQuery(e){return i(this,Hn).transformNode(e.node)}transformResult(e){return Promise.resolve(e.result)}}Hn=new WeakMap;var Ce;const Qt=class Qt{constructor(e){T(this,Ce,void 0);A(this,Ce,freeze(e))}temporary(){return new Qt({...i(this,Ce),node:CreateViewNode.cloneWith(i(this,Ce).node,{temporary:!0})})}materialized(){return new Qt({...i(this,Ce),node:CreateViewNode.cloneWith(i(this,Ce).node,{materialized:!0})})}ifNotExists(){return new Qt({...i(this,Ce),node:CreateViewNode.cloneWith(i(this,Ce).node,{ifNotExists:!0})})}orReplace(){return new Qt({...i(this,Ce),node:CreateViewNode.cloneWith(i(this,Ce).node,{orReplace:!0})})}columns(e){return new Qt({...i(this,Ce),node:CreateViewNode.cloneWith(i(this,Ce).node,{columns:e.map(parseColumnName)})})}as(e){const t=e.withPlugin(new ImmediateValuePlugin).toOperationNode();return new Qt({...i(this,Ce),node:CreateViewNode.cloneWith(i(this,Ce).node,{as:t})})}$call(e){return e(this)}toOperationNode(){return i(this,Ce).executor.transformQuery(i(this,Ce).node,i(this,Ce).queryId)}compile(){return i(this,Ce).executor.compileQuery(this.toOperationNode(),i(this,Ce).queryId)}async execute(){await i(this,Ce).executor.executeQuery(this.compile(),i(this,Ce).queryId)}};Ce=new WeakMap;let CreateViewBuilder=Qt;preventAwait(CreateViewBuilder,"don't await CreateViewBuilder instances directly. To execute the query you need to call `execute`");const DropViewNode=freeze({is(r){return r.kind==="DropViewNode"},create(r){return freeze({kind:"DropViewNode",name:SchemableIdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}});var Je;const Kr=class Kr{constructor(e){T(this,Je,void 0);A(this,Je,freeze(e))}materialized(){return new Kr({...i(this,Je),node:DropViewNode.cloneWith(i(this,Je).node,{materialized:!0})})}ifExists(){return new Kr({...i(this,Je),node:DropViewNode.cloneWith(i(this,Je).node,{ifExists:!0})})}cascade(){return new Kr({...i(this,Je),node:DropViewNode.cloneWith(i(this,Je).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,Je).executor.transformQuery(i(this,Je).node,i(this,Je).queryId)}compile(){return i(this,Je).executor.compileQuery(this.toOperationNode(),i(this,Je).queryId)}async execute(){await i(this,Je).executor.executeQuery(this.compile(),i(this,Je).queryId)}};Je=new WeakMap;let DropViewBuilder=Kr;preventAwait(DropViewBuilder,"don't await DropViewBuilder instances directly. To execute the query you need to call `execute`");const CreateTypeNode=freeze({is(r){return r.kind==="CreateTypeNode"},create(r){return freeze({kind:"CreateTypeNode",name:r})},cloneWithEnum(r,e){return freeze({...r,enum:ValueListNode.create(e.map(t=>ValueNode.createImmediate(t)))})}});var at;const Li=class Li{constructor(e){T(this,at,void 0);A(this,at,freeze(e))}toOperationNode(){return i(this,at).executor.transformQuery(i(this,at).node,i(this,at).queryId)}asEnum(e){return new Li({...i(this,at),node:CreateTypeNode.cloneWithEnum(i(this,at).node,e)})}$call(e){return e(this)}compile(){return i(this,at).executor.compileQuery(this.toOperationNode(),i(this,at).queryId)}async execute(){await i(this,at).executor.executeQuery(this.compile(),i(this,at).queryId)}};at=new WeakMap;let CreateTypeBuilder=Li;preventAwait(CreateTypeBuilder,"don't await CreateTypeBuilder instances directly. To execute the query you need to call `execute`");const DropTypeNode=freeze({is(r){return r.kind==="DropTypeNode"},create(r){return freeze({kind:"DropTypeNode",name:r})},cloneWith(r,e){return freeze({...r,...e})}});var ut;const qi=class qi{constructor(e){T(this,ut,void 0);A(this,ut,freeze(e))}ifExists(){return new qi({...i(this,ut),node:DropTypeNode.cloneWith(i(this,ut).node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,ut).executor.transformQuery(i(this,ut).node,i(this,ut).queryId)}compile(){return i(this,ut).executor.compileQuery(this.toOperationNode(),i(this,ut).queryId)}async execute(){await i(this,ut).executor.executeQuery(this.compile(),i(this,ut).queryId)}};ut=new WeakMap;let DropTypeBuilder=qi;preventAwait(DropTypeBuilder,"don't await DropTypeBuilder instances directly. To execute the query you need to call `execute`");function parseSchemableIdentifier(r){const e=".";if(r.includes(e)){const t=r.split(e).map(trim);if(t.length===2)return SchemableIdentifierNode.createWithSchema(t[0],t[1]);throw new Error(`invalid schemable identifier ${r}`)}else return SchemableIdentifierNode.create(r)}function trim(r){return r.trim()}var Pe;const Gr=class Gr{constructor(e){T(this,Pe,void 0);A(this,Pe,e)}createTable(e){return new CreateTableBuilder({queryId:createQueryId(),executor:i(this,Pe),node:CreateTableNode.create(parseTable(e))})}dropTable(e){return new DropTableBuilder({queryId:createQueryId(),executor:i(this,Pe),node:DropTableNode.create(parseTable(e))})}createIndex(e){return new CreateIndexBuilder({queryId:createQueryId(),executor:i(this,Pe),node:CreateIndexNode.create(e)})}dropIndex(e){return new DropIndexBuilder({queryId:createQueryId(),executor:i(this,Pe),node:DropIndexNode.create(e)})}createSchema(e){return new CreateSchemaBuilder({queryId:createQueryId(),executor:i(this,Pe),node:CreateSchemaNode.create(e)})}dropSchema(e){return new DropSchemaBuilder({queryId:createQueryId(),executor:i(this,Pe),node:DropSchemaNode.create(e)})}alterTable(e){return new AlterTableBuilder({queryId:createQueryId(),executor:i(this,Pe),node:AlterTableNode.create(parseTable(e))})}createView(e){return new CreateViewBuilder({queryId:createQueryId(),executor:i(this,Pe),node:CreateViewNode.create(e)})}dropView(e){return new DropViewBuilder({queryId:createQueryId(),executor:i(this,Pe),node:DropViewNode.create(e)})}createType(e){return new CreateTypeBuilder({queryId:createQueryId(),executor:i(this,Pe),node:CreateTypeNode.create(parseSchemableIdentifier(e))})}dropType(e){return new DropTypeBuilder({queryId:createQueryId(),executor:i(this,Pe),node:DropTypeNode.create(parseSchemableIdentifier(e))})}withPlugin(e){return new Gr(i(this,Pe).withPlugin(e))}withoutPlugins(){return new Gr(i(this,Pe).withoutPlugins())}withSchema(e){return new Gr(i(this,Pe).withPluginAtFront(new WithSchemaPlugin(e)))}};Pe=new WeakMap;let SchemaModule=Gr;class DynamicModule{ref(e){return new DynamicReferenceBuilder(e)}}var Wr;class DefaultConnectionProvider{constructor(e){T(this,Wr,void 0);A(this,Wr,e)}async provideConnection(e){const t=await i(this,Wr).acquireConnection();try{return await e(t)}finally{await i(this,Wr).releaseConnection(t)}}}Wr=new WeakMap;var It,St,kt;const er=class er extends QueryExecutorBase{constructor(t,n,s,a=[]){super(a);T(this,It,void 0);T(this,St,void 0);T(this,kt,void 0);A(this,It,t),A(this,St,n),A(this,kt,s)}get adapter(){return i(this,St)}compileQuery(t){return i(this,It).compileQuery(t)}provideConnection(t){return i(this,kt).provideConnection(t)}withPlugins(t){return new er(i(this,It),i(this,St),i(this,kt),[...this.plugins,...t])}withPlugin(t){return new er(i(this,It),i(this,St),i(this,kt),[...this.plugins,t])}withPluginAtFront(t){return new er(i(this,It),i(this,St),i(this,kt),[t,...this.plugins])}withConnectionProvider(t){return new er(i(this,It),i(this,St),t,[...this.plugins])}withoutPlugins(){return new er(i(this,It),i(this,St),i(this,kt),[])}};It=new WeakMap,St=new WeakMap,kt=new WeakMap;let DefaultQueryExecutor=er;function performanceNow(){return typeof performance<"u"&&isFunction(performance.now)?performance.now():Date.now()}var bt,Mt,At,or,an,Jn,po,jn,mo,Kn,yo,Gn,No,un,Ci;class RuntimeDriver{constructor(e,t){T(this,Jn);T(this,jn);T(this,Kn);T(this,Gn);T(this,un);T(this,bt,void 0);T(this,Mt,void 0);T(this,At,void 0);T(this,or,void 0);T(this,an,new WeakSet);A(this,bt,e),A(this,Mt,t)}async init(){i(this,At)||A(this,At,i(this,bt).init().catch(e=>(A(this,At,void 0),Promise.reject(e)))),await i(this,At)}async acquireConnection(){await this.init();const e=await i(this,bt).acquireConnection();return i(this,an).has(e)||(te(this,Jn,po).call(this)&&te(this,jn,mo).call(this,e),i(this,an).add(e)),e}async releaseConnection(e){await i(this,bt).releaseConnection(e)}beginTransaction(e,t){return i(this,bt).beginTransaction(e,t)}commitTransaction(e){return i(this,bt).commitTransaction(e)}rollbackTransaction(e){return i(this,bt).rollbackTransaction(e)}async destroy(){i(this,At)&&(await i(this,At),i(this,or)||A(this,or,i(this,bt).destroy().catch(e=>(A(this,or,void 0),Promise.reject(e)))),await i(this,or))}}bt=new WeakMap,Mt=new WeakMap,At=new WeakMap,or=new WeakMap,an=new WeakMap,Jn=new WeakSet,po=function(){return i(this,Mt).isLevelEnabled("query")||i(this,Mt).isLevelEnabled("error")},jn=new WeakSet,mo=function(e){const t=e.executeQuery;e.executeQuery=async n=>{const s=performanceNow();try{return await t.call(e,n)}catch(a){throw await te(this,Kn,yo).call(this,a,n,s),a}finally{await te(this,Gn,No).call(this,n,s)}}},Kn=new WeakSet,yo=async function(e,t,n){await i(this,Mt).error(()=>({level:"error",error:e,query:t,queryDurationMillis:te(this,un,Ci).call(this,n)}))},Gn=new WeakSet,No=async function(e,t){await i(this,Mt).query(()=>({level:"query",query:e,queryDurationMillis:te(this,un,Ci).call(this,t)}))},un=new WeakSet,Ci=function(e){return performanceNow()-e};var ln,Ut,Xn,bo;class SingleConnectionProvider{constructor(e){T(this,Xn);T(this,ln,void 0);T(this,Ut,void 0);A(this,ln,e)}async provideConnection(e){for(;i(this,Ut);)await i(this,Ut);const t=te(this,Xn,bo).call(this,e);return A(this,Ut,t.then(()=>{A(this,Ut,void 0)}).catch(()=>{A(this,Ut,void 0)})),t}}ln=new WeakMap,Ut=new WeakMap,Xn=new WeakSet,bo=async function(e){return await e(i(this,ln))};const TRANSACTION_ISOLATION_LEVELS=["read uncommitted","read committed","repeatable read","serializable"];freeze(["query","error"]);var $t,ar;class Log{constructor(e){T(this,$t,void 0);T(this,ar,void 0);isFunction(e)?(A(this,ar,e),A(this,$t,freeze({query:!0,error:!0}))):(A(this,ar,defaultLogger),A(this,$t,freeze({query:e.includes("query"),error:e.includes("error")})))}isLevelEnabled(e){return i(this,$t)[e]}async query(e){i(this,$t).query&&await i(this,ar).call(this,e())}async error(e){i(this,$t).error&&await i(this,ar).call(this,e())}}$t=new WeakMap,ar=new WeakMap;function defaultLogger(r){r.level==="query"?(console.log(`kysely:query: ${r.query.sql}`),console.log(`kysely:query: duration: ${r.queryDurationMillis.toFixed(1)}ms`)):r.level==="error"&&(r.error instanceof Error?console.error(`kysely:error: ${r.error.stack??r.error.message}`):console.error(`kysely:error: ${r}`))}function isCompilable(r){return isObject$2(r)&&isFunction(r.compile)}var je;const Nr=class Nr extends QueryCreator{constructor(t){let n,s;if(isKyselyProps(t))n={executor:t.executor},s={...t};else{const a=t.dialect,c=a.createDriver(),f=a.createQueryCompiler(),h=a.createAdapter(),m=new Log(t.log??[]),N=new RuntimeDriver(c,m),g=new DefaultConnectionProvider(N),C=new DefaultQueryExecutor(f,h,g,t.plugins??[]);n={executor:C},s={config:t,executor:C,dialect:a,driver:N}}super(n);T(this,je,void 0);A(this,je,freeze(s))}get schema(){return new SchemaModule(i(this,je).executor)}get dynamic(){return new DynamicModule}get introspection(){return i(this,je).dialect.createIntrospector(this.withoutPlugins())}case(t){return new CaseBuilder({node:CaseNode.create(isUndefined(t)?void 0:parseExpression(t))})}get fn(){return createFunctionModule()}transaction(){return new TransactionBuilder({...i(this,je)})}connection(){return new ConnectionBuilder({...i(this,je)})}withPlugin(t){return new Nr({...i(this,je),executor:i(this,je).executor.withPlugin(t)})}withoutPlugins(){return new Nr({...i(this,je),executor:i(this,je).executor.withoutPlugins()})}withSchema(t){return new Nr({...i(this,je),executor:i(this,je).executor.withPluginAtFront(new WithSchemaPlugin(t))})}withTables(){return new Nr({...i(this,je)})}async destroy(){await i(this,je).driver.destroy()}get isTransaction(){return!1}getExecutor(){return i(this,je).executor}executeQuery(t,n=createQueryId()){const s=isCompilable(t)?t.compile():t;return this.getExecutor().executeQuery(s,n)}};je=new WeakMap;let Kysely=Nr;var wt;const br=class br extends Kysely{constructor(t){super(t);T(this,wt,void 0);A(this,wt,t)}get isTransaction(){return!0}transaction(){throw new Error("calling the transaction method for a Transaction is not supported")}connection(){throw new Error("calling the connection method for a Transaction is not supported")}async destroy(){throw new Error("calling the destroy method for a Transaction is not supported")}withPlugin(t){return new br({...i(this,wt),executor:i(this,wt).executor.withPlugin(t)})}withoutPlugins(){return new br({...i(this,wt),executor:i(this,wt).executor.withoutPlugins()})}withSchema(t){return new br({...i(this,wt),executor:i(this,wt).executor.withPluginAtFront(new WithSchemaPlugin(t))})}withTables(){return new br({...i(this,wt)})}};wt=new WeakMap;let Transaction=br;function isKyselyProps(r){return isObject$2(r)&&isObject$2(r.config)&&isObject$2(r.driver)&&isObject$2(r.executor)&&isObject$2(r.dialect)}var ur;class ConnectionBuilder{constructor(e){T(this,ur,void 0);A(this,ur,freeze(e))}async execute(e){return i(this,ur).executor.provideConnection(async t=>{const n=i(this,ur).executor.withConnectionProvider(new SingleConnectionProvider(t)),s=new Kysely({...i(this,ur),executor:n});return await e(s)})}}ur=new WeakMap;preventAwait(ConnectionBuilder,"don't await ConnectionBuilder instances directly. To execute the query you need to call the `execute` method");var Et;const Di=class Di{constructor(e){T(this,Et,void 0);A(this,Et,freeze(e))}setIsolationLevel(e){return new Di({...i(this,Et),isolationLevel:e})}async execute(e){const{isolationLevel:t,...n}=i(this,Et),s={isolationLevel:t};return validateTransactionSettings(s),i(this,Et).executor.provideConnection(async a=>{const c=i(this,Et).executor.withConnectionProvider(new SingleConnectionProvider(a)),f=new Transaction({...n,executor:c});try{await i(this,Et).driver.beginTransaction(a,s);const h=await e(f);return await i(this,Et).driver.commitTransaction(a),h}catch(h){throw await i(this,Et).driver.rollbackTransaction(a),h}})}};Et=new WeakMap;let TransactionBuilder=Di;preventAwait(TransactionBuilder,"don't await TransactionBuilder instances directly. To execute the transaction you need to call the `execute` method");function validateTransactionSettings(r){if(r.isolationLevel&&!TRANSACTION_ISOLATION_LEVELS.includes(r.isolationLevel))throw new Error(`invalid transaction isolation level ${r.isolationLevel}`)}var it,Lr,Dn,cn,Ri,dn,xi;const Yn=class Yn{constructor(e){T(this,Lr);T(this,cn);T(this,dn);T(this,it,void 0);A(this,it,freeze(e))}get expressionType(){}as(e){return new AliasedRawBuilder(this,e)}$castTo(){return new Yn({...i(this,it)})}castTo(){return this.$castTo()}withPlugin(e){return new Yn({...i(this,it),plugins:i(this,it).plugins!==void 0?freeze([...i(this,it).plugins,e]):freeze([e])})}toOperationNode(){return te(this,cn,Ri).call(this,te(this,Lr,Dn).call(this))}compile(e){return te(this,dn,xi).call(this,te(this,Lr,Dn).call(this,e))}async execute(e){const t=te(this,Lr,Dn).call(this,e);return t.executeQuery(te(this,dn,xi).call(this,t),i(this,it).queryId)}};it=new WeakMap,Lr=new WeakSet,Dn=function(e){const t=e!==void 0?e.getExecutor():NOOP_QUERY_EXECUTOR;return i(this,it).plugins!==void 0?t.withPlugins(i(this,it).plugins):t},cn=new WeakSet,Ri=function(e){return e.transformQuery(i(this,it).rawNode,i(this,it).queryId)},dn=new WeakSet,xi=function(e){return e.compileQuery(te(this,cn,Ri).call(this,e),i(this,it).queryId)};let RawBuilder=Yn;preventAwait(RawBuilder,"don't await RawBuilder instances directly. To execute the query you need to call `execute`");var qr,Vt;class AliasedRawBuilder{constructor(e,t){T(this,qr,void 0);T(this,Vt,void 0);A(this,qr,e),A(this,Vt,t)}get expression(){return i(this,qr)}get alias(){return i(this,Vt)}toOperationNode(){return AliasNode.create(i(this,qr).toOperationNode(),isOperationNodeSource(i(this,Vt))?i(this,Vt).toOperationNode():IdentifierNode.create(i(this,Vt)))}}qr=new WeakMap,Vt=new WeakMap;const sql=Object.assign((r,...e)=>new RawBuilder({queryId:createQueryId(),rawNode:RawNode.create(r,(e==null?void 0:e.map(parseValueExpression))??[])}),{ref(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseStringReference(r))})},val(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseValueExpression(r))})},value(r){return this.val(r)},table(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseTable(r))})},id(...r){const e=new Array(r.length+1).fill(".");return e[0]="",e[e.length-1]="",new RawBuilder({queryId:createQueryId(),rawNode:RawNode.create(e,r.map(IdentifierNode.create))})},lit(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(ValueNode.createImmediate(r))})},literal(r){return this.lit(r)},raw(r){return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithSql(r)})},join(r,e=sql`, `){const t=new Array(2*r.length-1),n=e.toOperationNode();for(let s=0;s<r.length;++s)t[2*s]=parseValueExpression(r[s]),s!==r.length-1&&(t[2*s+1]=n);return new RawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChildren(t)})}});var Zn;class OperationNodeVisitor{constructor(){le(this,"nodeStack",[]);T(this,Zn,freeze({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this)}));le(this,"visitNode",e=>{this.nodeStack.push(e),i(this,Zn)[e.kind](e),this.nodeStack.pop()})}get parentNode(){return this.nodeStack[this.nodeStack.length-2]}}Zn=new WeakMap;var Dr,lr;class DefaultQueryCompiler extends OperationNodeVisitor{constructor(){super(...arguments);T(this,Dr,"");T(this,lr,[])}get numParameters(){return i(this,lr).length}compileQuery(t){return A(this,Dr,""),A(this,lr,[]),this.visitNode(t),freeze({query:t,sql:this.getSql(),parameters:[...i(this,lr)]})}getSql(){return i(this,Dr)}visitSelectQuery(t){const n=this.parentNode!==void 0&&!InsertQueryNode.is(this.parentNode)&&!CreateViewNode.is(this.parentNode)&&!SetOperationNode.is(this.parentNode);this.parentNode===void 0&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("select "),t.distinctOn&&(this.compileDistinctOn(t.distinctOn),this.append(" ")),t.frontModifiers&&t.frontModifiers.length>0&&(this.compileList(t.frontModifiers," "),this.append(" ")),t.selections&&(this.compileList(t.selections),this.append(" ")),this.visitNode(t.from),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.groupBy&&(this.append(" "),this.visitNode(t.groupBy)),t.having&&(this.append(" "),this.visitNode(t.having)),t.setOperations&&(this.append(" "),this.compileList(t.setOperations," ")),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.offset&&(this.append(" "),this.visitNode(t.offset)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," ")),n&&this.append(")")}visitFrom(t){this.append("from "),this.compileList(t.froms)}visitSelection(t){this.visitNode(t.selection)}visitColumn(t){this.visitNode(t.column)}compileDistinctOn(t){this.append("distinct on ("),this.compileList(t),this.append(")")}compileList(t,n=", "){const s=t.length-1;for(let a=0;a<=s;a++)this.visitNode(t[a]),a<s&&this.append(n)}visitWhere(t){this.append("where "),this.visitNode(t.where)}visitHaving(t){this.append("having "),this.visitNode(t.having)}visitInsertQuery(t){const n=this.nodeStack.find(QueryNode.is)!==t;!n&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append(t.replace?"replace":"insert"),t.ignore&&this.append(" ignore"),this.append(" into "),this.visitNode(t.into),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.values&&(this.append(" "),this.visitNode(t.values)),t.onConflict&&(this.append(" "),this.visitNode(t.onConflict)),t.onDuplicateKey&&(this.append(" "),this.visitNode(t.onDuplicateKey)),t.returning&&(this.append(" "),this.visitNode(t.returning)),n&&this.append(")")}visitValues(t){this.append("values "),this.compileList(t.values)}visitDeleteQuery(t){const n=this.nodeStack.find(QueryNode.is)!==t;!n&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("delete "),this.visitNode(t.from),t.using&&(this.append(" "),this.visitNode(t.using)),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.returning&&(this.append(" "),this.visitNode(t.returning)),n&&this.append(")")}visitReturning(t){this.append("returning "),this.compileList(t.selections)}visitAlias(t){this.visitNode(t.node),this.append(" as "),this.visitNode(t.alias)}visitReference(t){this.visitNode(t.table),this.append("."),this.visitNode(t.column)}visitSelectAll(t){this.append("*")}visitIdentifier(t){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(t),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(t){if(!isString(t.name))throw new Error("a non-string identifier was passed to compileUnwrappedIdentifier.");this.append(this.sanitizeIdentifier(t.name))}visitAnd(t){this.visitNode(t.left),this.append(" and "),this.visitNode(t.right)}visitOr(t){this.visitNode(t.left),this.append(" or "),this.visitNode(t.right)}visitValue(t){t.immediate?this.appendImmediateValue(t.value):this.appendValue(t.value)}visitValueList(t){this.append("("),this.compileList(t.values),this.append(")")}visitPrimitiveValueList(t){this.append("(");const{values:n}=t;for(let s=0;s<n.length;++s)this.appendValue(n[s]),s!==n.length-1&&this.append(", ");this.append(")")}visitParens(t){this.append("("),this.visitNode(t.node),this.append(")")}visitJoin(t){this.append(JOIN_TYPE_SQL[t.joinType]),this.append(" "),this.visitNode(t.table),t.on&&(this.append(" "),this.visitNode(t.on))}visitOn(t){this.append("on "),this.visitNode(t.on)}visitRaw(t){const{sqlFragments:n,parameters:s}=t;for(let a=0;a<n.length;++a)this.append(n[a]),s.length>a&&this.visitNode(s[a])}visitOperator(t){this.append(t.operator)}visitTable(t){this.visitNode(t.table)}visitSchemableIdentifier(t){t.schema&&(this.visitNode(t.schema),this.append(".")),this.visitNode(t.identifier)}visitCreateTable(t){this.append("create "),t.frontModifiers&&t.frontModifiers.length>0&&(this.compileList(t.frontModifiers," "),this.append(" ")),t.temporary&&this.append("temporary "),this.append("table "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.table),this.append(" ("),this.compileList([...t.columns,...t.constraints??[]]),this.append(")"),t.onCommit&&(this.append(" on commit "),this.append(t.onCommit)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," "))}visitColumnDefinition(t){this.visitNode(t.column),this.append(" "),this.visitNode(t.dataType),t.unsigned&&this.append(" unsigned"),t.frontModifiers&&t.frontModifiers.length>0&&(this.append(" "),this.compileList(t.frontModifiers," ")),t.generated&&(this.append(" "),this.visitNode(t.generated)),t.defaultTo&&(this.append(" "),this.visitNode(t.defaultTo)),t.notNull&&this.append(" not null"),t.unique&&this.append(" unique"),t.primaryKey&&this.append(" primary key"),t.autoIncrement&&(this.append(" "),this.append(this.getAutoIncrement())),t.references&&(this.append(" "),this.visitNode(t.references)),t.check&&(this.append(" "),this.visitNode(t.check)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," "))}getAutoIncrement(){return"auto_increment"}visitReferences(t){this.append("references "),this.visitNode(t.table),this.append(" ("),this.compileList(t.columns),this.append(")"),t.onDelete&&(this.append(" on delete "),this.append(t.onDelete)),t.onUpdate&&(this.append(" on update "),this.append(t.onUpdate))}visitDropTable(t){this.append("drop table "),t.ifExists&&this.append("if exists "),this.visitNode(t.table),t.cascade&&this.append(" cascade")}visitDataType(t){this.append(t.dataType)}visitOrderBy(t){this.append("order by "),this.compileList(t.items)}visitOrderByItem(t){this.visitNode(t.orderBy),t.direction&&(this.append(" "),this.visitNode(t.direction))}visitGroupBy(t){this.append("group by "),this.compileList(t.items)}visitGroupByItem(t){this.visitNode(t.groupBy)}visitUpdateQuery(t){const n=this.nodeStack.find(QueryNode.is)!==t;!n&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("update "),this.visitNode(t.table),this.append(" set "),t.updates&&this.compileList(t.updates),t.from&&(this.append(" "),this.visitNode(t.from)),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.returning&&(this.append(" "),this.visitNode(t.returning)),n&&this.append(")")}visitColumnUpdate(t){this.visitNode(t.column),this.append(" = "),this.visitNode(t.value)}visitLimit(t){this.append("limit "),this.visitNode(t.limit)}visitOffset(t){this.append("offset "),this.visitNode(t.offset)}visitOnConflict(t){this.append("on conflict"),t.columns?(this.append(" ("),this.compileList(t.columns),this.append(")")):t.constraint?(this.append(" on constraint "),this.visitNode(t.constraint)):t.indexExpression&&(this.append(" ("),this.visitNode(t.indexExpression),this.append(")")),t.indexWhere&&(this.append(" "),this.visitNode(t.indexWhere)),t.doNothing===!0?this.append(" do nothing"):t.updates&&(this.append(" do update set "),this.compileList(t.updates),t.updateWhere&&(this.append(" "),this.visitNode(t.updateWhere)))}visitOnDuplicateKey(t){this.append("on duplicate key update "),this.compileList(t.updates)}visitCreateIndex(t){this.append("create "),t.unique&&this.append("unique "),this.append("index "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.name),t.table&&(this.append(" on "),this.visitNode(t.table)),t.using&&(this.append(" using "),this.visitNode(t.using)),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.where&&(this.append(" "),this.visitNode(t.where))}visitDropIndex(t){this.append("drop index "),t.ifExists&&this.append("if exists "),this.visitNode(t.name),t.table&&(this.append(" on "),this.visitNode(t.table)),t.cascade&&this.append(" cascade")}visitCreateSchema(t){this.append("create schema "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.schema)}visitDropSchema(t){this.append("drop schema "),t.ifExists&&this.append("if exists "),this.visitNode(t.schema),t.cascade&&this.append(" cascade")}visitPrimaryKeyConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("primary key ("),this.compileList(t.columns),this.append(")")}visitUniqueConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("unique ("),this.compileList(t.columns),this.append(")")}visitCheckConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("check ("),this.visitNode(t.expression),this.append(")")}visitForeignKeyConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("foreign key ("),this.compileList(t.columns),this.append(") "),this.visitNode(t.references),t.onDelete&&(this.append(" on delete "),this.append(t.onDelete)),t.onUpdate&&(this.append(" on update "),this.append(t.onUpdate))}visitList(t){this.compileList(t.items)}visitWith(t){this.append("with "),t.recursive&&this.append("recursive "),this.compileList(t.expressions)}visitCommonTableExpression(t){this.visitNode(t.name),this.append(" as "),this.visitNode(t.expression)}visitCommonTableExpressionName(t){this.visitNode(t.table),t.columns&&(this.append("("),this.compileList(t.columns),this.append(")"))}visitAlterTable(t){this.append("alter table "),this.visitNode(t.table),this.append(" "),t.renameTo&&(this.append("rename to "),this.visitNode(t.renameTo)),t.setSchema&&(this.append("set schema "),this.visitNode(t.setSchema)),t.addConstraint&&this.visitNode(t.addConstraint),t.dropConstraint&&this.visitNode(t.dropConstraint),t.columnAlterations&&this.compileList(t.columnAlterations)}visitAddColumn(t){this.append("add column "),this.visitNode(t.column)}visitRenameColumn(t){this.append("rename column "),this.visitNode(t.column),this.append(" to "),this.visitNode(t.renameTo)}visitDropColumn(t){this.append("drop column "),this.visitNode(t.column)}visitAlterColumn(t){this.append("alter column "),this.visitNode(t.column),this.append(" "),t.dataType&&(this.append("type "),this.visitNode(t.dataType),t.dataTypeExpression&&(this.append("using "),this.visitNode(t.dataTypeExpression))),t.setDefault&&(this.append("set default "),this.visitNode(t.setDefault)),t.dropDefault&&this.append("drop default"),t.setNotNull&&this.append("set not null"),t.dropNotNull&&this.append("drop not null")}visitModifyColumn(t){this.append("modify column "),this.visitNode(t.column)}visitAddConstraint(t){this.append("add "),this.visitNode(t.constraint)}visitDropConstraint(t){this.append("drop constraint "),t.ifExists&&this.append("if exists "),this.visitNode(t.constraintName),t.modifier==="cascade"?this.append(" cascade"):t.modifier==="restrict"&&this.append(" restrict")}visitSetOperation(t){this.append(t.operator),this.append(" "),t.all&&this.append("all "),this.visitNode(t.expression)}visitCreateView(t){this.append("create "),t.orReplace&&this.append("or replace "),t.materialized&&this.append("materialized "),t.temporary&&this.append("temporary "),this.append("view "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.name),this.append(" "),t.columns&&(this.append("("),this.compileList(t.columns),this.append(") ")),t.as&&(this.append("as "),this.visitNode(t.as))}visitDropView(t){this.append("drop "),t.materialized&&this.append("materialized "),this.append("view "),t.ifExists&&this.append("if exists "),this.visitNode(t.name),t.cascade&&this.append(" cascade")}visitGenerated(t){this.append("generated "),t.always&&this.append("always "),t.byDefault&&this.append("by default "),this.append("as "),t.identity&&this.append("identity"),t.expression&&(this.append("("),this.visitNode(t.expression),this.append(")")),t.stored&&this.append(" stored")}visitDefaultValue(t){this.append("default "),this.visitNode(t.defaultValue)}visitSelectModifier(t){t.rawModifier?this.visitNode(t.rawModifier):this.append(SELECT_MODIFIER_SQL[t.modifier])}visitCreateType(t){this.append("create type "),this.visitNode(t.name),t.enum&&(this.append(" as enum "),this.visitNode(t.enum))}visitDropType(t){this.append("drop type "),t.ifExists&&this.append("if exists "),this.visitNode(t.name)}visitExplain(t){this.append("explain"),(t.options||t.format)&&(this.append(" "),this.append(this.getLeftExplainOptionsWrapper()),t.options&&(this.visitNode(t.options),t.format&&this.append(this.getExplainOptionsDelimiter())),t.format&&(this.append("format"),this.append(this.getExplainOptionAssignment()),this.append(t.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(t){this.append("default")}visitAggregateFunction(t){this.append(t.func),this.append("("),t.distinct&&this.append("distinct "),this.compileList(t.aggregated),this.append(")"),t.filter&&(this.append(" filter("),this.visitNode(t.filter),this.append(")")),t.over&&(this.append(" "),this.visitNode(t.over))}visitOver(t){this.append("over("),t.partitionBy&&(this.visitNode(t.partitionBy),t.orderBy&&this.append(" ")),t.orderBy&&this.visitNode(t.orderBy),this.append(")")}visitPartitionBy(t){this.append("partition by "),this.compileList(t.items)}visitPartitionByItem(t){this.visitNode(t.partitionBy)}visitBinaryOperation(t){this.visitNode(t.leftOperand),this.append(" "),this.visitNode(t.operator),this.append(" "),this.visitNode(t.rightOperand)}visitUnaryOperation(t){this.visitNode(t.operator),this.isMinusOperator(t.operator)||this.append(" "),this.visitNode(t.operand)}isMinusOperator(t){return OperatorNode.is(t)&&t.operator==="-"}visitUsing(t){this.append("using "),this.compileList(t.tables)}visitFunction(t){this.append(t.func),this.append("("),this.compileList(t.arguments),this.append(")")}visitCase(t){this.append("case"),t.value&&(this.append(" "),this.visitNode(t.value)),t.when&&(this.append(" "),this.compileList(t.when," ")),t.else&&(this.append(" else "),this.visitNode(t.else)),this.append(" end"),t.isStatement&&this.append(" case")}visitWhen(t){this.append("when "),this.visitNode(t.condition),t.result&&(this.append(" then "),this.visitNode(t.result))}append(t){A(this,Dr,i(this,Dr)+t)}appendValue(t){this.addParameter(t),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getCurrentParameterPlaceholder(){return"$"+this.numParameters}getLeftExplainOptionsWrapper(){return"("}getExplainOptionAssignment(){return" "}getExplainOptionsDelimiter(){return", "}getRightExplainOptionsWrapper(){return")"}sanitizeIdentifier(t){const n=this.getLeftIdentifierWrapper(),s=this.getRightIdentifierWrapper();let a="";for(const c of t)a+=c,c===n?a+=n:c===s&&(a+=s);return a}addParameter(t){i(this,lr).push(t)}appendImmediateValue(t){if(isString(t))this.append(`'${t}'`);else if(isNumber(t)||isBoolean(t))this.append(t.toString());else if(isNull(t))this.append("null");else if(isDate(t))this.appendImmediateValue(t.toISOString());else if(isBigInt(t))this.appendImmediateValue(t.toString());else throw new Error(`invalid immediate value ${t}`)}}Dr=new WeakMap,lr=new WeakMap;const SELECT_MODIFIER_SQL=freeze({ForKeyShare:"for key share",ForNoKeyUpdate:"for no key update",ForUpdate:"for update",ForShare:"for share",NoWait:"nowait",SkipLocked:"skip locked",Distinct:"distinct"}),JOIN_TYPE_SQL=freeze({InnerJoin:"inner join",LeftJoin:"left join",RightJoin:"right join",FullJoin:"full join",LateralInnerJoin:"inner join lateral",LateralLeftJoin:"left join lateral"}),CompiledQuery=freeze({raw(r){return freeze({sql:r,query:RawNode.createWithSql(r),parameters:freeze([])})}});var Wt,fn,Fr,Br;class SqliteDriver{constructor(e){T(this,Wt,void 0);T(this,fn,new ConnectionMutex);T(this,Fr,void 0);T(this,Br,void 0);A(this,Wt,freeze({...e}))}async init(){A(this,Fr,isFunction(i(this,Wt).database)?await i(this,Wt).database():i(this,Wt).database),A(this,Br,new SqliteConnection(i(this,Fr))),i(this,Wt).onCreateConnection&&await i(this,Wt).onCreateConnection(i(this,Br))}async acquireConnection(){return await i(this,fn).lock(),i(this,Br)}async beginTransaction(e){await e.executeQuery(CompiledQuery.raw("begin"))}async commitTransaction(e){await e.executeQuery(CompiledQuery.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(CompiledQuery.raw("rollback"))}async releaseConnection(){i(this,fn).unlock()}async destroy(){var e;(e=i(this,Fr))==null||e.close()}}Wt=new WeakMap,fn=new WeakMap,Fr=new WeakMap,Br=new WeakMap;var hn;class SqliteConnection{constructor(e){T(this,hn,void 0);A(this,hn,e)}executeQuery(e){const{sql:t,parameters:n}=e,s=i(this,hn).prepare(t);if(s.reader)return Promise.resolve({rows:s.all(n)});{const{changes:a,lastInsertRowid:c}=s.run(n),f=a!=null?BigInt(a):void 0;return Promise.resolve({numUpdatedOrDeletedRows:f,numAffectedRows:f,insertId:c!=null?BigInt(c):void 0,rows:[]})}}async*streamQuery(){throw new Error("Sqlite driver doesn't support streaming")}}hn=new WeakMap;var cr,zr;class ConnectionMutex{constructor(){T(this,cr,void 0);T(this,zr,void 0)}async lock(){for(;i(this,cr);)await i(this,cr);A(this,cr,new Promise(e=>{A(this,zr,e)}))}unlock(){const e=i(this,zr);A(this,cr,void 0),A(this,zr,void 0),e==null||e()}}cr=new WeakMap,zr=new WeakMap;const ID_WRAP_REGEX=/"/g;class SqliteQueryCompiler extends DefaultQueryCompiler{getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}sanitizeIdentifier(e){return e.replace(ID_WRAP_REGEX,'""')}visitDefaultInsertValue(e){this.append("null")}}const DEFAULT_MIGRATION_TABLE="kysely_migration",DEFAULT_MIGRATION_LOCK_TABLE="kysely_migration_lock";freeze({__noMigrations__:!0});var Qr,ei,wo;class SqliteIntrospector{constructor(e){T(this,ei);T(this,Qr,void 0);A(this,Qr,e)}async getSchemas(){return[]}async getTables(e={withInternalKyselyTables:!1}){let t=i(this,Qr).selectFrom("sqlite_schema").where("type","in",["table","view"]).where("name","not like","sqlite_%").select("name").orderBy("name").$castTo();e.withInternalKyselyTables||(t=t.where("name","!=",DEFAULT_MIGRATION_TABLE).where("name","!=",DEFAULT_MIGRATION_LOCK_TABLE));const n=await t.execute();return Promise.all(n.map(({name:s})=>te(this,ei,wo).call(this,s)))}async getMetadata(e){return{tables:await this.getTables(e)}}}Qr=new WeakMap,ei=new WeakSet,wo=async function(e){var c,f,h,m,N,g;const t=i(this,Qr),n=await t.selectFrom("sqlite_master").where("name","=",e).select(["sql","type"]).$castTo().executeTakeFirstOrThrow(),s=(g=(N=(m=(h=(f=(c=n.sql)==null?void 0:c.split(/[\(\),]/))==null?void 0:f.find(C=>C.toLowerCase().includes("autoincrement")))==null?void 0:h.trimStart())==null?void 0:m.split(/\s+/))==null?void 0:N[0])==null?void 0:g.replace(/["`]/g,""),a=await t.selectFrom(sql`pragma_table_info(${e})`.as("table_info")).select(["name","type","notnull","dflt_value"]).orderBy("cid").execute();return{name:e,isView:n.type==="view",columns:a.map(C=>({name:C.name,dataType:C.type,isNullable:!C.notnull,isAutoIncrementing:C.name===s,hasDefaultValue:C.dflt_value!=null}))}};class SqliteAdapter{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(){}async releaseMigrationLock(){}}var pn;class SqliteDialect{constructor(e){T(this,pn,void 0);A(this,pn,freeze({...e}))}createDriver(){return new SqliteDriver(i(this,pn))}createQueryCompiler(){return new SqliteQueryCompiler}createAdapter(){return new SqliteAdapter}createIntrospector(e){return new SqliteIntrospector(e)}}pn=new WeakMap;function toBytes(r){return Uint8Array.from([...r].map(e=>e.charCodeAt(0)))}function fromBytes(r){return String.fromCharCode(...r)}function encode(r){return r.length?[fromBytes(r[0].site_id),...r.flatMap(e=>[e.cid,e.pk,e.table,e.val,e.db_version,e.col_version])]:[]}function decode(r){if(!r[0])return[];const e=toBytes(r[0]),t=[];for(let n=1;n<r.length;n+=6)t.push({site_id:e,cid:r[n],pk:r[n+1],table:r[n+2],val:r[n+3],db_version:r[n+4],col_version:r[n+5]});return t}function selectVersion(){const r=sql`SELECT 
    crsql_dbversion() as current,
    IFNULL(MAX(version), 0) as synced
  FROM "__crstore_sync"`;return{execute:()=>r.execute(this).then(e=>e.rows[0])}}function updateVersion(r){return this.updateTable("__crstore_sync").set({version:r??sql`crsql_dbversion()`})}function selectClient(){const r=sql`SELECT crsql_siteid() as client`;return{execute:()=>r.execute(this).then(e=>fromBytes(e.rows[0].client))}}function changesSince(r,e){let t=this.selectFrom("crsql_changes").select(sql`crsql_siteid()`.as("site_id")).select(["cid","pk","table","val","db_version","col_version"]).where("db_version",">",r).$if(!r,n=>n.where("cid","!=","__crsql_del")).$if(e===null,n=>n.where("site_id","is",null)).$if(typeof e=="string",n=>n.where("site_id","is not",toBytes(e))).$castTo();return{execute:()=>t.execute().then(encode)}}function insertChanges(r){const e=async t=>{r.length&&(await t.insertInto("crsql_changes").values(decode(r)).execute(),await updateVersion.bind(t)().execute())};return{execute:()=>this.isTransaction?e(this):this.transaction().execute(e)}}function resolveChanges(r){return{execute:()=>applyOperation.bind(this)(e=>insertChanges.bind(e)(r).execute()).execute().then(e=>e.changes)}}function applyOperation(r,...e){return{execute:()=>this.transaction().execute(async t=>{const{current:n}=await selectVersion.bind(t)().execute(),s=await r(t,...e),a=await changesSince.bind(t)(n).execute();return{result:s,changes:a}})}}function finalize(){const r=sql`select crsql_finalize();`;return{execute:()=>r.execute(this)}}function affectedTables(r){var e,t,n;if(Array.isArray(r)){const s=new Set;for(let a=3;a<r.length;a+=6)s.add(r[a]);return[...s]}if(r.kind==="TableNode")return[r.table.identifier.name];if(r.kind==="ReferenceNode")return[r.table.table.identifier.name];if(r.kind==="AliasNode")return affectedTables(r.node);if(r.kind==="SelectQueryNode"){const s=[...r.from.froms,...((e=r.joins)==null?void 0:e.map(a=>a.table))||[],...((t=r.selections)==null?void 0:t.map(a=>a.selection))||[],...((n=r.with)==null?void 0:n.expressions.map(a=>a.expression))||[]].flatMap(affectedTables);return[...new Set(s)]}return[]}class CRDialect extends SqliteDialect{constructor(t){super(t);le(this,"database");this.database=async()=>typeof t.database=="function"?t.database():t.database}createDriver(){const t=this.database,n=mutex();let s,a;return{async init(){s=await t(),a={async executeQuery(c){return{rows:await s.execO(c.sql,c.parameters)}},async*streamQuery(){throw new Error("Sqlite driver doesn't support streaming")}}},async acquireConnection(){return await n.lock(),a},async beginTransaction(c){await c.executeQuery(CompiledQuery.raw("begin"))},async commitTransaction(c){await c.executeQuery(CompiledQuery.raw("commit"))},async rollbackTransaction(c){await c.executeQuery(CompiledQuery.raw("rollback"))},async releaseConnection(){n.unlock()},async destroy(){s==null||s.close()}}}}function mutex(){let r,e;return{async lock(){for(;r;)await r;r=new Promise(t=>e=t)},unlock(){const t=e;r=void 0,e=void 0,t==null||t()}}}function json(r,e){const t=Object.entries(e).flatMap(([n,s])=>[sql.lit(n),typeof s=="string"?r.ref(s):s]);return sql`json_object(${sql.join(t)})`.withPlugin({transformQuery({node:n}){return{...n,json:!0}}}).$castTo()}function group(r,e){const t=typeof e=="string"?r.ref(e).toOperationNode():e.toOperationNode();return new AggregateFunctionBuilder({aggregateFunctionNode:{...AggregateFunctionNode.create("json_group_array",[t]),json:!0}})}function groupJSON(r,e){return group(r,json(r,e))}var mn;class JSONPlugin{constructor(){T(this,mn,new WeakMap)}transformQuery({node:e,queryId:t}){return e.kind!=="SelectQueryNode"||i(this,mn).set(t,new Set(this.getColumns(e))),e}async transformResult({result:e,queryId:t}){if(!Array.isArray(e.rows))return e;const n=i(this,mn).get(t);return n&&e.rows.forEach(s=>this.parseObject(s,n)),e}getColumns(e){var n,s;const t=[];for(const a in e)e[a]&&typeof e[a]=="object"&&(e[a].json===!0&&typeof((n=e.alias)==null?void 0:n.name)=="string"&&t.push((s=e.alias)==null?void 0:s.name),t.push(...this.getColumns(e[a])));return t}parseObject(e,t){for(const n in e)t.has(n)&&(e[n]=JSON.parse(String(e[n]))),typeof e[n]=="object"&&this.parseObject(e[n],t)}}mn=new WeakMap;function covert(r){const t={any:"blob",string:"text",number:"real",unknown:"blob",instance:"blob",bigint:"integer",integer:"integer",boolean:"boolean"}[r];if(t)return t;throw new Error(`Type "${r}" is not allowed in the database schema!`)}async function apply(r,{schema:e}){var t;for(const n in e){const s=e[n];let a=r.schema.createTable(n).ifNotExists();for(const c in s.schema){const{type:f}=s.schema[c];a=a.addColumn(c,(t=s.ordered)!=null&&t.find(([h])=>h===c)?"blob":covert(f))}s.primary&&(a=a.addPrimaryKeyConstraint("primary_key",s.primary)),await a.execute();for(const c of s.indices||[])await r.schema.createIndex(`${n}_${c.join("_")}`).ifNotExists().on(n).columns(c).execute();s.crr&&await sql`SELECT crsql_as_crr(${n})`.execute(r);for(const c of s.ordered||[])await sql`SELECT crsql_fract_as_ordered(${n},${sql.join(c)})`.execute(r);await r.schema.createTable("__crstore_sync").ifNotExists().addColumn("version","integer").execute(),await sql`INSERT INTO __crstore_sync (version) SELECT 0
      WHERE NOT EXISTS (SELECT * FROM __crstore_sync)
    `.execute(r)}}function primary(r,...e){return r.primary=e,r}function crr(r){return r.crr=!0,r}function ordered(r,e,...t){return r.ordered||(r.ordered=[]),r.ordered.push([e,...t]),r}function index(r,...e){return r.indices||(r.indices=[]),r.indices.push(e),r}const wasmUrl=""+new URL("../assets/crsqlite.0980e00c.wasm",import.meta.url).href;var Module=(()=>{var r=import.meta.url;return function(e={}){var t;t||(t=typeof e<"u"?e:{});var n,s;t.ready=new Promise(function(o,u){n=o,s=u});var a=Object.assign({},t),c="./this.program",f=(o,u)=>{throw u},h=typeof window=="object",m=typeof importScripts=="function",N="",g;(h||m)&&(m?N=self.location.href:typeof document<"u"&&document.currentScript&&(N=document.currentScript.src),r&&(N=r),N.indexOf("blob:")!==0?N=N.substr(0,N.replace(/[?#].*/,"").lastIndexOf("/")+1):N="",m&&(g=o=>{var u=new XMLHttpRequest;return u.open("GET",o,!1),u.responseType="arraybuffer",u.send(null),new Uint8Array(u.response)}));var C=t.print||console.log.bind(console),k=t.printErr||console.warn.bind(console);Object.assign(t,a),a=null,t.thisProgram&&(c=t.thisProgram),t.quit&&(f=t.quit);var O;t.wasmBinary&&(O=t.wasmBinary);var p=t.noExitRuntime||!0;typeof WebAssembly!="object"&&Ue("no native wasm support detected");var b,y=!1,_,R=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function U(o,u,l){var d=u+l;for(l=u;o[l]&&!(l>=d);)++l;if(16<l-u&&o.buffer&&R)return R.decode(o.subarray(u,l));for(d="";u<l;){var w=o[u++];if(w&128){var E=o[u++]&63;if((w&224)==192)d+=String.fromCharCode((w&31)<<6|E);else{var v=o[u++]&63;w=(w&240)==224?(w&15)<<12|E<<6|v:(w&7)<<18|E<<12|v<<6|o[u++]&63,65536>w?d+=String.fromCharCode(w):(w-=65536,d+=String.fromCharCode(55296|w>>10,56320|w&1023))}}else d+=String.fromCharCode(w)}return d}function $(o,u){return o?U(z,o,u):""}function W(o,u,l,d){if(!(0<d))return 0;var w=l;d=l+d-1;for(var E=0;E<o.length;++E){var v=o.charCodeAt(E);if(55296<=v&&57343>=v){var F=o.charCodeAt(++E);v=65536+((v&1023)<<10)|F&1023}if(127>=v){if(l>=d)break;u[l++]=v}else{if(2047>=v){if(l+1>=d)break;u[l++]=192|v>>6}else{if(65535>=v){if(l+2>=d)break;u[l++]=224|v>>12}else{if(l+3>=d)break;u[l++]=240|v>>18,u[l++]=128|v>>12&63}u[l++]=128|v>>6&63}u[l++]=128|v&63}}return u[l]=0,l-w}function J(o,u,l){return W(o,z,u,l)}function ce(o){for(var u=0,l=0;l<o.length;++l){var d=o.charCodeAt(l);127>=d?u++:2047>=d?u+=2:55296<=d&&57343>=d?(u+=4,++l):u+=3}return u}var H,z,Q,L,X,Z,oe;function he(){var o=b.buffer;t.HEAP8=H=new Int8Array(o),t.HEAP16=Q=new Int16Array(o),t.HEAP32=L=new Int32Array(o),t.HEAPU8=z=new Uint8Array(o),t.HEAPU16=new Uint16Array(o),t.HEAPU32=X=new Uint32Array(o),t.HEAPF32=Z=new Float32Array(o),t.HEAPF64=oe=new Float64Array(o)}var M=[],ie=[],Me=[],Ee=[],fe=0;function tt(){var o=t.preRun.shift();M.unshift(o)}var Fe=0,qe=null;function Ue(o){throw t.onAbort&&t.onAbort(o),o="Aborted("+o+")",k(o),y=!0,_=1,o=new WebAssembly.RuntimeError(o+". Build with -sASSERTIONS for more info."),s(o),o}function Ct(o){return o.startsWith("data:application/octet-stream;base64,")}var De;if(t.locateFile){if(De="crsqlite.wasm",!Ct(De)){var hr=De;De=t.locateFile?t.locateFile(hr,N):N+hr}}else De=new URL(""+new URL("../assets/crsqlite.0980e00c.wasm",import.meta.url).href,self.location).href;function On(o){try{if(o==De&&O)return new Uint8Array(O);if(g)return g(o);throw"both async and sync fetching of the wasm failed"}catch(u){Ue(u)}}function ui(o){return O||!h&&!m||typeof fetch!="function"?Promise.resolve().then(function(){return On(o)}):fetch(o,{credentials:"same-origin"}).then(function(u){if(!u.ok)throw"failed to load wasm binary file at '"+o+"'";return u.arrayBuffer()}).catch(function(){return On(o)})}function qt(o,u,l){return ui(o).then(function(d){return WebAssembly.instantiate(d,u)}).then(function(d){return d}).then(l,function(d){k("failed to asynchronously prepare wasm: "+d),Ue(d)})}function Rt(o,u){var l=De;return O||typeof WebAssembly.instantiateStreaming!="function"||Ct(l)||typeof fetch!="function"?qt(l,o,u):fetch(l,{credentials:"same-origin"}).then(function(d){return WebAssembly.instantiateStreaming(d,o).then(u,function(w){return k("wasm streaming compile failed: "+w),k("falling back to ArrayBuffer instantiation"),qt(l,o,u)})})}var Y,pe;function Tn(o){this.name="ExitStatus",this.message="Program terminated with exit("+o+")",this.status=o}function jt(o){for(;0<o.length;)o.shift()(t)}function ve(o,u="i8"){switch(u.endsWith("*")&&(u="*"),u){case"i1":return H[o>>0];case"i8":return H[o>>0];case"i16":return Q[o>>1];case"i32":return L[o>>2];case"i64":return L[o>>2];case"float":return Z[o>>2];case"double":return oe[o>>3];case"*":return X[o>>2];default:Ue("invalid type for getValue: "+u)}}function lt(o,u,l="i8"){switch(l.endsWith("*")&&(l="*"),l){case"i1":H[o>>0]=u;break;case"i8":H[o>>0]=u;break;case"i16":Q[o>>1]=u;break;case"i32":L[o>>2]=u;break;case"i64":pe=[u>>>0,(Y=u,1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],L[o>>2]=pe[0],L[o+4>>2]=pe[1];break;case"float":Z[o>>2]=u;break;case"double":oe[o>>3]=u;break;case"*":X[o>>2]=u;break;default:Ue("invalid type for setValue: "+l)}}var V=(o,u)=>{for(var l=0,d=o.length-1;0<=d;d--){var w=o[d];w==="."?o.splice(d,1):w===".."?(o.splice(d,1),l++):l&&(o.splice(d,1),l--)}if(u)for(;l;l--)o.unshift("..");return o},ae=o=>{var u=o.charAt(0)==="/",l=o.substr(-1)==="/";return(o=V(o.split("/").filter(d=>!!d),!u).join("/"))||u||(o="."),o&&l&&(o+="/"),(u?"/":"")+o},ke=o=>{var u=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(o).slice(1);return o=u[0],u=u[1],!o&&!u?".":(u&&(u=u.substr(0,u.length-1)),o+u)},Re=o=>{if(o==="/")return"/";o=ae(o),o=o.replace(/\/$/,"");var u=o.lastIndexOf("/");return u===-1?o:o.substr(u+1)};function ht(){if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function"){var o=new Uint8Array(1);return()=>(crypto.getRandomValues(o),o[0])}return()=>Ue("randomDevice")}function $e(){for(var o="",u=!1,l=arguments.length-1;-1<=l&&!u;l--){if(u=0<=l?arguments[l]:"/",typeof u!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!u)return"";o=u+"/"+o,u=u.charAt(0)==="/"}return o=V(o.split("/").filter(d=>!!d),!u).join("/"),(u?"/":"")+o||"."}var Kt=[];function ct(o,u){Kt[o]={input:[],Ob:[],Zb:u},pi(o,li)}var li={open:function(o){var u=Kt[o.node.bc];if(!u)throw new B(43);o.Pb=u,o.seekable=!1},close:function(o){o.Pb.Zb.ec(o.Pb)},ec:function(o){o.Pb.Zb.ec(o.Pb)},read:function(o,u,l,d){if(!o.Pb||!o.Pb.Zb.vc)throw new B(60);for(var w=0,E=0;E<d;E++){try{var v=o.Pb.Zb.vc(o.Pb)}catch{throw new B(29)}if(v===void 0&&w===0)throw new B(6);if(v==null)break;w++,u[l+E]=v}return w&&(o.node.timestamp=Date.now()),w},write:function(o,u,l,d){if(!o.Pb||!o.Pb.Zb.pc)throw new B(60);try{for(var w=0;w<d;w++)o.Pb.Zb.pc(o.Pb,u[l+w])}catch{throw new B(29)}return d&&(o.node.timestamp=Date.now()),w}},ci={vc:function(o){if(!o.input.length){var u=null;if(typeof window<"u"&&typeof window.prompt=="function"?(u=window.prompt("Input: "),u!==null&&(u+=`
`)):typeof readline=="function"&&(u=readline(),u!==null&&(u+=`
`)),!u)return null;var l=Array(ce(u)+1);u=W(u,l,0,l.length),l.length=u,o.input=l}return o.input.shift()},pc:function(o,u){u===null||u===10?(C(U(o.Ob,0)),o.Ob=[]):u!=0&&o.Ob.push(u)},ec:function(o){o.Ob&&0<o.Ob.length&&(C(U(o.Ob,0)),o.Ob=[])}},Io={pc:function(o,u){u===null||u===10?(k(U(o.Ob,0)),o.Ob=[]):u!=0&&o.Ob.push(u)},ec:function(o){o.Ob&&0<o.Ob.length&&(k(U(o.Ob,0)),o.Ob=[])}},ee={Sb:null,Rb:function(){return ee.createNode(null,"/",16895,0)},createNode:function(o,u,l,d){if((l&61440)===24576||(l&61440)===4096)throw new B(63);return ee.Sb||(ee.Sb={dir:{node:{Qb:ee.Ab.Qb,Nb:ee.Ab.Nb,$b:ee.Ab.$b,fc:ee.Ab.fc,yc:ee.Ab.yc,lc:ee.Ab.lc,jc:ee.Ab.jc,xc:ee.Ab.xc,kc:ee.Ab.kc},stream:{Wb:ee.Jb.Wb}},file:{node:{Qb:ee.Ab.Qb,Nb:ee.Ab.Nb},stream:{Wb:ee.Jb.Wb,read:ee.Jb.read,write:ee.Jb.write,rc:ee.Jb.rc,hc:ee.Jb.hc,ic:ee.Jb.ic}},link:{node:{Qb:ee.Ab.Qb,Nb:ee.Ab.Nb,cc:ee.Ab.cc},stream:{}},sc:{node:{Qb:ee.Ab.Qb,Nb:ee.Ab.Nb},stream:xo}}),l=Qi(o,u,l,d),(l.mode&61440)===16384?(l.Ab=ee.Sb.dir.node,l.Jb=ee.Sb.dir.stream,l.Kb={}):(l.mode&61440)===32768?(l.Ab=ee.Sb.file.node,l.Jb=ee.Sb.file.stream,l.Mb=0,l.Kb=null):(l.mode&61440)===40960?(l.Ab=ee.Sb.link.node,l.Jb=ee.Sb.link.stream):(l.mode&61440)===8192&&(l.Ab=ee.Sb.sc.node,l.Jb=ee.Sb.sc.stream),l.timestamp=Date.now(),o&&(o.Kb[u]=l,o.timestamp=l.timestamp),l},Qc:function(o){return o.Kb?o.Kb.subarray?o.Kb.subarray(0,o.Mb):new Uint8Array(o.Kb):new Uint8Array(0)},tc:function(o,u){var l=o.Kb?o.Kb.length:0;l>=u||(u=Math.max(u,l*(1048576>l?2:1.125)>>>0),l!=0&&(u=Math.max(u,256)),l=o.Kb,o.Kb=new Uint8Array(u),0<o.Mb&&o.Kb.set(l.subarray(0,o.Mb),0))},Mc:function(o,u){if(o.Mb!=u)if(u==0)o.Kb=null,o.Mb=0;else{var l=o.Kb;o.Kb=new Uint8Array(u),l&&o.Kb.set(l.subarray(0,Math.min(u,o.Mb))),o.Mb=u}},Ab:{Qb:function(o){var u={};return u.Ec=(o.mode&61440)===8192?o.id:1,u.nc=o.id,u.mode=o.mode,u.Kc=1,u.uid=0,u.Hc=0,u.bc=o.bc,(o.mode&61440)===16384?u.size=4096:(o.mode&61440)===32768?u.size=o.Mb:(o.mode&61440)===40960?u.size=o.link.length:u.size=0,u.Ac=new Date(o.timestamp),u.Jc=new Date(o.timestamp),u.Dc=new Date(o.timestamp),u.Bc=4096,u.Cc=Math.ceil(u.size/u.Bc),u},Nb:function(o,u){u.mode!==void 0&&(o.mode=u.mode),u.timestamp!==void 0&&(o.timestamp=u.timestamp),u.size!==void 0&&ee.Mc(o,u.size)},$b:function(){throw fi[44]},fc:function(o,u,l,d){return ee.createNode(o,u,l,d)},yc:function(o,u,l){if((o.mode&61440)===16384){try{var d=Gt(u,l)}catch{}if(d)for(var w in d.Kb)throw new B(55)}delete o.parent.Kb[o.name],o.parent.timestamp=Date.now(),o.name=l,u.Kb[l]=o,u.timestamp=o.parent.timestamp,o.parent=u},lc:function(o,u){delete o.Kb[u],o.timestamp=Date.now()},jc:function(o,u){var l=Gt(o,u),d;for(d in l.Kb)throw new B(55);delete o.Kb[u],o.timestamp=Date.now()},xc:function(o){var u=[".",".."],l;for(l in o.Kb)o.Kb.hasOwnProperty(l)&&u.push(l);return u},kc:function(o,u,l){return o=ee.createNode(o,u,41471,0),o.link=l,o},cc:function(o){if((o.mode&61440)!==40960)throw new B(28);return o.link}},Jb:{read:function(o,u,l,d,w){var E=o.node.Kb;if(w>=o.node.Mb)return 0;if(o=Math.min(o.node.Mb-w,d),8<o&&E.subarray)u.set(E.subarray(w,w+o),l);else for(d=0;d<o;d++)u[l+d]=E[w+d];return o},write:function(o,u,l,d,w,E){if(u.buffer===H.buffer&&(E=!1),!d)return 0;if(o=o.node,o.timestamp=Date.now(),u.subarray&&(!o.Kb||o.Kb.subarray)){if(E)return o.Kb=u.subarray(l,l+d),o.Mb=d;if(o.Mb===0&&w===0)return o.Kb=u.slice(l,l+d),o.Mb=d;if(w+d<=o.Mb)return o.Kb.set(u.subarray(l,l+d),w),d}if(ee.tc(o,w+d),o.Kb.subarray&&u.subarray)o.Kb.set(u.subarray(l,l+d),w);else for(E=0;E<d;E++)o.Kb[w+E]=u[l+E];return o.Mb=Math.max(o.Mb,w+d),d},Wb:function(o,u,l){if(l===1?u+=o.position:l===2&&(o.node.mode&61440)===32768&&(u+=o.node.Mb),0>u)throw new B(28);return u},rc:function(o,u,l){ee.tc(o.node,u+l),o.node.Mb=Math.max(o.node.Mb,u+l)},hc:function(o,u,l,d,w){if((o.node.mode&61440)!==32768)throw new B(43);if(o=o.node.Kb,w&2||o.buffer!==H.buffer){if((0<l||l+u<o.length)&&(o.subarray?o=o.subarray(l,l+u):o=Array.prototype.slice.call(o,l,l+u)),l=!0,u=65536*Math.ceil(u/65536),(w=Ys(65536,u))?(z.fill(0,w,w+u),u=w):u=0,!u)throw new B(48);H.set(o,u)}else l=!1,u=o.byteOffset;return{Lc:u,zc:l}},ic:function(o,u,l,d){return ee.Jb.write(o,u,0,d,l,!1),0}}},di=null,Fi={},Dt=[],So=1,Ft=null,Bi=!0,B=null,fi={},rt=(o,u={})=>{if(o=$e(o),!o)return{path:"",node:null};if(u=Object.assign({uc:!0,qc:0},u),8<u.qc)throw new B(32);o=o.split("/").filter(v=>!!v);for(var l=di,d="/",w=0;w<o.length;w++){var E=w===o.length-1;if(E&&u.parent)break;if(l=Gt(l,o[w]),d=ae(d+"/"+o[w]),l.Xb&&(!E||E&&u.uc)&&(l=l.Xb.root),!E||u.Vb){for(E=0;(l.mode&61440)===40960;)if(l=Ji(d),d=$e(ke(d),l),l=rt(d,{qc:u.qc+1}).node,40<E++)throw new B(32)}}return{path:d,node:l}},vn=o=>{for(var u;;){if(o===o.parent)return o=o.Rb.wc,u?o[o.length-1]!=="/"?o+"/"+u:o+u:o;u=u?o.name+"/"+u:o.name,o=o.parent}},hi=(o,u)=>{for(var l=0,d=0;d<u.length;d++)l=(l<<5)-l+u.charCodeAt(d)|0;return(o+l>>>0)%Ft.length},zi=o=>{var u=hi(o.parent.id,o.name);if(Ft[u]===o)Ft[u]=o.Yb;else for(u=Ft[u];u;){if(u.Yb===o){u.Yb=o.Yb;break}u=u.Yb}},Gt=(o,u)=>{var l;if(l=(l=pr(o,"x"))?l:o.Ab.$b?0:2)throw new B(l,o);for(l=Ft[hi(o.id,u)];l;l=l.Yb){var d=l.name;if(l.parent.id===o.id&&d===u)return l}return o.Ab.$b(o,u)},Qi=(o,u,l,d)=>(o=new js(o,u,l,d),u=hi(o.parent.id,o.name),o.Yb=Ft[u],Ft[u]=o),Co={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},Pi=o=>{var u=["r","w","rw"][o&3];return o&512&&(u+="w"),u},pr=(o,u)=>{if(Bi)return 0;if(!u.includes("r")||o.mode&292){if(u.includes("w")&&!(o.mode&146)||u.includes("x")&&!(o.mode&73))return 2}else return 2;return 0},Mi=(o,u)=>{try{return Gt(o,u),20}catch{}return pr(o,"wx")},Ui=(o,u,l)=>{try{var d=Gt(o,u)}catch(w){return w.Lb}if(o=pr(o,"wx"))return o;if(l){if((d.mode&61440)!==16384)return 54;if(d===d.parent||vn(d)==="/")return 10}else if((d.mode&61440)===16384)return 31;return 0},Ro=(o=0)=>{for(;4096>=o;o++)if(!Dt[o])return o;throw new B(33)},$i=(o,u)=>(Vr||(Vr=function(){this.dc={}},Vr.prototype={},Object.defineProperties(Vr.prototype,{object:{get:function(){return this.node},set:function(l){this.node=l}},flags:{get:function(){return this.dc.flags},set:function(l){this.dc.flags=l}},position:{get:function(){return this.dc.position},set:function(l){this.dc.position=l}}})),o=Object.assign(new Vr,o),u=Ro(u),o.Tb=u,Dt[u]=o),xo={open:o=>{o.Jb=Fi[o.node.bc].Jb,o.Jb.open&&o.Jb.open(o)},Wb:()=>{throw new B(70)}},pi=(o,u)=>{Fi[o]={Jb:u}},Vi=(o,u)=>{var l=u==="/",d=!u;if(l&&di)throw new B(10);if(!l&&!d){var w=rt(u,{uc:!1});if(u=w.path,w=w.node,w.Xb)throw new B(10);if((w.mode&61440)!==16384)throw new B(54)}u={type:o,Sc:{},wc:u,Ic:[]},o=o.Rb(u),o.Rb=u,u.root=o,l?di=o:w&&(w.Xb=u,w.Rb&&w.Rb.Ic.push(u))},mi=(o,u,l)=>{var d=rt(o,{parent:!0}).node;if(o=Re(o),!o||o==="."||o==="..")throw new B(28);var w=Mi(d,o);if(w)throw new B(w);if(!d.Ab.fc)throw new B(63);return d.Ab.fc(d,o,u,l)},_t=(o,u)=>mi(o,(u!==void 0?u:511)&1023|16384,0),In=(o,u,l)=>{typeof l>"u"&&(l=u,u=438),mi(o,u|8192,l)},yi=(o,u)=>{if(!$e(o))throw new B(44);var l=rt(u,{parent:!0}).node;if(!l)throw new B(44);u=Re(u);var d=Mi(l,u);if(d)throw new B(d);if(!l.Ab.kc)throw new B(63);l.Ab.kc(l,u,o)},Hi=o=>{var u=rt(o,{parent:!0}).node;o=Re(o);var l=Gt(u,o),d=Ui(u,o,!0);if(d)throw new B(d);if(!u.Ab.jc)throw new B(63);if(l.Xb)throw new B(10);u.Ab.jc(u,o),zi(l)},Ji=o=>{if(o=rt(o).node,!o)throw new B(44);if(!o.Ab.cc)throw new B(28);return $e(vn(o.parent),o.Ab.cc(o))},Sn=(o,u)=>{if(o=rt(o,{Vb:!u}).node,!o)throw new B(44);if(!o.Ab.Qb)throw new B(63);return o.Ab.Qb(o)},ji=o=>Sn(o,!0),Ki=(o,u)=>{if(o=typeof o=="string"?rt(o,{Vb:!0}).node:o,!o.Ab.Nb)throw new B(63);o.Ab.Nb(o,{mode:u&4095|o.mode&-4096,timestamp:Date.now()})},Gi=(o,u)=>{if(0>u)throw new B(28);if(o=typeof o=="string"?rt(o,{Vb:!0}).node:o,!o.Ab.Nb)throw new B(63);if((o.mode&61440)===16384)throw new B(31);if((o.mode&61440)!==32768)throw new B(28);var l=pr(o,"w");if(l)throw new B(l);o.Ab.Nb(o,{size:u,timestamp:Date.now()})},Cn=(o,u,l)=>{if(o==="")throw new B(44);if(typeof u=="string"){var d=Co[u];if(typeof d>"u")throw Error("Unknown file open mode: "+u);u=d}if(l=u&64?(typeof l>"u"?438:l)&4095|32768:0,typeof o=="object")var w=o;else{o=ae(o);try{w=rt(o,{Vb:!(u&131072)}).node}catch{}}if(d=!1,u&64)if(w){if(u&128)throw new B(20)}else w=mi(o,l,0),d=!0;if(!w)throw new B(44);if((w.mode&61440)===8192&&(u&=-513),u&65536&&(w.mode&61440)!==16384)throw new B(54);if(!d&&(l=w?(w.mode&61440)===40960?32:(w.mode&61440)===16384&&(Pi(u)!=="r"||u&512)?31:pr(w,Pi(u)):44))throw new B(l);return u&512&&!d&&Gi(w,0),u&=-131713,w=$i({node:w,path:vn(w),flags:u,seekable:!0,position:0,Jb:w.Jb,Pc:[],error:!1}),w.Jb.open&&w.Jb.open(w),!t.logReadFiles||u&1||(Rn||(Rn={}),o in Rn||(Rn[o]=1)),w},Xi=(o,u,l)=>{if(o.Tb===null)throw new B(8);if(!o.seekable||!o.Jb.Wb)throw new B(70);if(l!=0&&l!=1&&l!=2)throw new B(28);o.position=o.Jb.Wb(o,u,l),o.Pc=[]},Yi=()=>{B||(B=function(o,u){this.name="ErrnoError",this.node=u,this.Nc=function(l){this.Lb=l},this.Nc(o),this.message="FS error"},B.prototype=Error(),B.prototype.constructor=B,[44].forEach(o=>{fi[o]=new B(o),fi[o].stack="<generic error, no stack>"}))},Zi,ko=(o,u)=>{var l=0;return o&&(l|=365),u&&(l|=146),l},$r=(o,u,l)=>{o=ae("/dev/"+o);var d=ko(!!u,!!l);Ni||(Ni=64);var w=Ni++<<8|0;pi(w,{open:E=>{E.seekable=!1},close:()=>{l&&l.buffer&&l.buffer.length&&l(10)},read:(E,v,F,S)=>{for(var x=0,q=0;q<S;q++){try{var D=u()}catch{throw new B(29)}if(D===void 0&&x===0)throw new B(6);if(D==null)break;x++,v[F+q]=D}return x&&(E.node.timestamp=Date.now()),x},write:(E,v,F,S)=>{for(var x=0;x<S;x++)try{l(v[F+x])}catch{throw new B(29)}return S&&(E.node.timestamp=Date.now()),x}}),In(o,d,w)},Ni,ge={},Vr,Rn;function Xt(o,u,l){if(u.charAt(0)==="/")return u;if(o=o===-100?"/":pt(o).path,u.length==0){if(!l)throw new B(44);return o}return ae(o+"/"+u)}function xn(o,u,l){try{var d=o(u)}catch(E){if(E&&E.node&&ae(u)!==ae(vn(E.node)))return-54;throw E}L[l>>2]=d.Ec,L[l+8>>2]=d.nc,L[l+12>>2]=d.mode,X[l+16>>2]=d.Kc,L[l+20>>2]=d.uid,L[l+24>>2]=d.Hc,L[l+28>>2]=d.bc,pe=[d.size>>>0,(Y=d.size,1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],L[l+40>>2]=pe[0],L[l+44>>2]=pe[1],L[l+48>>2]=4096,L[l+52>>2]=d.Cc,o=d.Ac.getTime(),u=d.Jc.getTime();var w=d.Dc.getTime();return pe=[Math.floor(o/1e3)>>>0,(Y=Math.floor(o/1e3),1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],L[l+56>>2]=pe[0],L[l+60>>2]=pe[1],X[l+64>>2]=o%1e3*1e3,pe=[Math.floor(u/1e3)>>>0,(Y=Math.floor(u/1e3),1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],L[l+72>>2]=pe[0],L[l+76>>2]=pe[1],X[l+80>>2]=u%1e3*1e3,pe=[Math.floor(w/1e3)>>>0,(Y=Math.floor(w/1e3),1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],L[l+88>>2]=pe[0],L[l+92>>2]=pe[1],X[l+96>>2]=w%1e3*1e3,pe=[d.nc>>>0,(Y=d.nc,1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],L[l+104>>2]=pe[0],L[l+108>>2]=pe[1],0}var kn=void 0;function An(){return kn+=4,L[kn-4>>2]}function pt(o){if(o=Dt[o],!o)throw new B(8);return o}function bi(o){return X[o>>2]+4294967296*L[o+4>>2]}var Ao=[0,31,60,91,121,152,182,213,244,274,305,335],Wo=[0,31,59,90,120,151,181,212,243,273,304,334];function es(o){var u=ce(o)+1,l=Oi(u);return l&&W(o,H,l,u),l}var wi={};function ts(){if(!Ei){var o={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:c||"./this.program"},u;for(u in wi)wi[u]===void 0?delete o[u]:o[u]=wi[u];var l=[];for(u in o)l.push(u+"="+o[u]);Ei=l}return Ei}var Ei;function rs(){}function ns(){}function ss(){}function os(){}function as(){}function us(){}function ls(){}function cs(){}function ds(){}function fs(){}function hs(){}function ps(){}function ms(){}function ys(){}function Ns(){}function bs(){}function ws(){}function Es(){}function gs(){}function _s(){}function Os(){}function Ts(){}function vs(){}function Is(){}function Ss(){}function Cs(){}function Rs(){}function xs(){}function ks(){}function As(){}function Ws(){}function Ls(){}function qs(){}function Ds(){}function Fs(){}function Bs(){}function zs(){}function Qs(){}function Ps(o){_=o,p||0<fe||(t.onExit&&t.onExit(o),y=!0),f(o,new Tn(o))}function gi(o){o instanceof Tn||o=="unwind"||f(1,o)}function Wn(o){try{o()}catch(u){Ue(u)}}function Lo(o){var u={},l;for(l in o)(function(d){var w=o[d];u[d]=typeof w=="function"?function(){Ln.push(d);try{return w.apply(null,arguments)}finally{y||(Ln.pop()===d||Ue(),Ot&&Bt===1&&Ln.length===0&&(Bt=0,Wn(io),typeof Fibers<"u"&&Fibers.Tc()))}}:w})(l);return u}var Bt=0,Ot=null,Ms=0,Ln=[],Us={},$s={},qo=0,_i=null,Do=[];function Fo(){return new Promise((o,u)=>{_i={resolve:o,reject:u}})}function Bo(){var o=Oi(12300),u=o+12;L[o>>2]=u,L[o+4>>2]=u+12288,u=Ln[0];var l=Us[u];return l===void 0&&(l=qo++,Us[u]=l,$s[l]=u),L[o+8>>2]=l,o}function Vs(o){if(!y){if(Bt===0){var u=!1,l=!1;o((d=0)=>{if(!y&&(Ms=d,u=!0,l)){Bt=2,Wn(()=>so(Ot)),d=!1;try{var w=(0,t.asm[$s[L[Ot+8>>2]]])()}catch(F){w=F,d=!0}var E=!1;if(!Ot){var v=_i;v&&(_i=null,(d?v.reject:v.resolve)(w),E=!0)}if(d&&!E)throw w}}),l=!0,u||(Bt=1,Ot=Bo(),Wn(()=>no(Ot)))}else Bt===2?(Bt=0,Wn(oo),Ks(Ot),Ot=null,Do.forEach(d=>{if(!y)try{if(d(),!(p||0<fe))try{_=d=_,Ps(d)}catch(w){gi(w)}}catch(w){gi(w)}})):Ue("invalid state: "+Bt);return Ms}}function Hs(o){return Vs(u=>{o().then(u)})}var Js={};function xt(o,u,l,d,w){function E(D){return--fe,S!==0&&ro(S),u==="string"?$(D):u==="boolean"?!!D:D}var v={string:D=>{var P=0;if(D!=null&&D!==0){var ue=(D.length<<2)+1;P=Ti(ue),J(D,P,ue)}return P},array:D=>{var P=Ti(D.length);return H.set(D,P),P}};o=t["_"+o];var F=[],S=0;if(d)for(var x=0;x<d.length;x++){var q=v[l[x]];q?(S===0&&(S=eo()),F[x]=q(d[x])):F[x]=d[x]}return l=Ot,d=o.apply(null,F),fe+=1,w=w&&w.async,Ot!=l?Fo().then(E):(d=E(d),w?Promise.resolve(d):d)}function js(o,u,l,d){o||(o=this),this.parent=o,this.Rb=o.Rb,this.Xb=null,this.id=So++,this.name=u,this.mode=l,this.Ab={},this.Jb={},this.bc=d}Object.defineProperties(js.prototype,{read:{get:function(){return(this.mode&365)===365},set:function(o){o?this.mode|=365:this.mode&=-366}},write:{get:function(){return(this.mode&146)===146},set:function(o){o?this.mode|=146:this.mode&=-147}}}),Yi(),Ft=Array(4096),Vi(ee,"/"),_t("/tmp"),_t("/home"),_t("/home/web_user"),(()=>{_t("/dev"),pi(259,{read:()=>0,write:(u,l,d,w)=>w}),In("/dev/null",259),ct(1280,ci),ct(1536,Io),In("/dev/tty",1280),In("/dev/tty1",1536);var o=ht();$r("random",o),$r("urandom",o),_t("/dev/shm"),_t("/dev/shm/tmp")})(),(()=>{_t("/proc");var o=_t("/proc/self");_t("/proc/self/fd"),Vi({Rb:()=>{var u=Qi(o,"fd",16895,73);return u.Ab={$b:(l,d)=>{var w=Dt[+d];if(!w)throw new B(8);return l={parent:null,Rb:{wc:"fake"},Ab:{cc:()=>w.path}},l.parent=l}},u}},"/proc/self/fd")})(),function(){function o(d,w){const E=[];for(let v=0;d[w+v]!=0;++v){if(1e3<v)throw Error("C-string never terminated after 1k characters");E.push(d[w+v])}return String.fromCharCode(...E)}const u=new Map,l=new Map;t.updateHook=function(d,w){const E=u.size;return u.set(E,w),xt("update_hook","void",["number","number"],[d,E])},t.createFunction=function(d,w,E,v,F,S){const x=u.size;return u.set(x,{f:S,Ub:F}),xt("create_function","number","number string number number number number".split(" "),[d,w,E,v,x,0])},t.createAggregate=function(d,w,E,v,F,S,x){const q=u.size;return u.set(q,{step:S,Fc:x,Ub:F}),xt("create_function","number","number string number number number number".split(" "),[d,w,E,v,q,1])},t.getFunctionUserData=function(d){return l.get(d)},os=function(d,w,E,v,F,S){d=u.get(d);const x=H;F=BigInt(S)<<32n|BigInt(F)&4294967295n,d(w,o(x,E),o(x,v),F)},ns=function(d,w,E,v){d=u.get(d),l.set(w,d.Ub),d.f(w,new Uint32Array(z.buffer,v,E)),l.delete(w)},ss=function(d,w,E,v){d=u.get(d),l.set(w,d.Ub),d.step(w,new Uint32Array(z.buffer,v,E)),l.delete(w)},rs=function(d,w){d=u.get(d),l.set(w,d.Ub),d.Fc(w),l.delete(w)}}(),function(){function o(S,x){const q=`get${S}`,D=`set${S}`;return new Proxy(new DataView(z.buffer,x,S==="Int32"?4:8),{get(P,ue){if(ue===q)return function(Te,Be){if(!Be)throw Error("must be little endian");return P[ue](Te,Be)};if(ue===D)return function(Te,Be,We){if(!We)throw Error("must be little endian");return P[ue](Te,Be,We)};if(typeof ue=="string"&&ue.match(/^(get)|(set)/))throw Error("invalid type");return P[ue]}})}const u=typeof Js=="object",l=new Map,d=new Map,w=new Map,E=u?new Set:null,v=u?new Set:null,F=new Map;Os=function(S,x,q,D){F.set($(S),{size:x,ac:Array.from(new Uint32Array(z.buffer,D,q))})},t.createModule=function(S,x,q,D){u&&(q.handleAsync=Hs);const P=l.size;return l.set(P,{module:q,Ub:D}),D=0,q.xCreate&&(D|=1),q.xConnect&&(D|=2),q.xBestIndex&&(D|=4),q.xDisconnect&&(D|=8),q.xDestroy&&(D|=16),q.xOpen&&(D|=32),q.xClose&&(D|=64),q.xFilter&&(D|=128),q.xNext&&(D|=256),q.xEof&&(D|=512),q.xColumn&&(D|=1024),q.xRowid&&(D|=2048),q.xUpdate&&(D|=4096),q.xBegin&&(D|=8192),q.xSync&&(D|=16384),q.xCommit&&(D|=32768),q.xRollback&&(D|=65536),q.xFindFunction&&(D|=131072),q.xRename&&(D|=262144),xt("create_module","number",["number","string","number","number"],[S,x,P,D])},hs=function(S,x,q,D,P,ue){if(x=l.get(x),d.set(P,x),u){E.delete(P);for(const Te of E)d.delete(Te)}return D=Array.from(new Uint32Array(z.buffer,D,q)).map(Te=>$(Te)),x.module.xCreate(S,x.Ub,D,P,o("Int32",ue))},fs=function(S,x,q,D,P,ue){if(x=l.get(x),d.set(P,x),u){E.delete(P);for(const Te of E)d.delete(Te)}return D=Array.from(new Uint32Array(z.buffer,D,q)).map(Te=>$(Te)),x.module.xConnect(S,x.Ub,D,P,o("Int32",ue))},us=function(S,x){var q=d.get(S),D=F.get("sqlite3_index_info").ac;const P={};P.nConstraint=ve(x+D[0],"i32"),P.aConstraint=[];for(var ue=ve(x+D[1],"i32"),Te=F.get("sqlite3_index_constraint").size,Be=0;Be<P.nConstraint;++Be){var We=P.aConstraint,nt=We.push,Ve=ue+Be*Te,mr=F.get("sqlite3_index_constraint").ac,zt={};zt.iColumn=ve(Ve+mr[0],"i32"),zt.op=ve(Ve+mr[1],"i8"),zt.usable=!!ve(Ve+mr[2],"i8"),nt.call(We,zt)}for(P.nOrderBy=ve(x+D[2],"i32"),P.aOrderBy=[],ue=ve(x+D[3],"i32"),Te=F.get("sqlite3_index_orderby").size,Be=0;Be<P.nOrderBy;++Be)We=P.aOrderBy,nt=We.push,Ve=ue+Be*Te,mr=F.get("sqlite3_index_orderby").ac,zt={},zt.iColumn=ve(Ve+mr[0],"i32"),zt.desc=!!ve(Ve+mr[1],"i8"),nt.call(We,zt);for(P.aConstraintUsage=[],ue=0;ue<P.nConstraint;++ue)P.aConstraintUsage.push({argvIndex:0,omit:!1});for(P.idxNum=ve(x+D[5],"i32"),P.idxStr=null,P.orderByConsumed=!!ve(x+D[8],"i8"),P.estimatedCost=ve(x+D[9],"double"),P.estimatedRows=ve(x+D[10],"i64"),P.idxFlags=ve(x+D[11],"i32"),P.colUsed=ve(x+D[12],"i64"),S=q.module.xBestIndex(S,P),q=F.get("sqlite3_index_info").ac,D=ve(x+q[4],"i32"),ue=F.get("sqlite3_index_constraint_usage").size,nt=0;nt<P.nConstraint;++nt)Te=D+nt*ue,We=P.aConstraintUsage[nt],Ve=F.get("sqlite3_index_constraint_usage").ac,lt(Te+Ve[0],We.argvIndex,"i32"),lt(Te+Ve[1],We.omit?1:0,"i8");return lt(x+q[5],P.idxNum,"i32"),typeof P.idxStr=="string"&&(D=ce(P.idxStr),ue=xt("sqlite3_malloc","number",["number"],[D+1]),J(P.idxStr,ue,D+1),lt(x+q[6],ue,"i32"),lt(x+q[7],1,"i32")),lt(x+q[8],P.orderByConsumed,"i32"),lt(x+q[9],P.estimatedCost,"double"),lt(x+q[10],P.estimatedRows,"i64"),lt(x+q[11],P.idxFlags,"i32"),S},ms=function(S){const x=d.get(S);return u?E.add(S):d.delete(S),x.module.xDisconnect(S)},ps=function(S){const x=d.get(S);return u?E.add(S):d.delete(S),x.module.xDestroy(S)},ws=function(S,x){const q=d.get(S);if(w.set(x,q),u){v.delete(x);for(const D of v)w.delete(D)}return q.module.xOpen(S,x)},ls=function(S){const x=w.get(S);return u?v.add(S):w.delete(S),x.module.xClose(S)},ys=function(S){return w.get(S).module.xEof(S)?1:0},Ns=function(S,x,q,D,P){const ue=w.get(S);return q=q?$(q):null,P=new Uint32Array(z.buffer,P,D),ue.module.xFilter(S,x,q,P)},bs=function(S){return w.get(S).module.xNext(S)},cs=function(S,x,q){return w.get(S).module.xColumn(S,x,q)},_s=function(S,x){return w.get(S).module.xRowid(S,o("BigInt64",x))},vs=function(S,x,q,D){const P=d.get(S);return q=new Uint32Array(z.buffer,q,x),P.module.xUpdate(S,q,o("BigInt64",D))},as=function(S){return d.get(S).module.xBegin(S)},Ts=function(S){return d.get(S).module.xSync(S)},ds=function(S){return d.get(S).module.xCommit(S)},gs=function(S){return d.get(S).module.xRollback(S)},Es=function(S,x){const q=d.get(S);return x=$(x),q.module.xRename(S,x)}}(),function(){function o(E,v){const F=`get${E}`,S=`set${E}`;return new Proxy(new DataView(z.buffer,v,E==="Int32"?4:8),{get(x,q){if(q===F)return function(D,P){if(!P)throw Error("must be little endian");return x[q](D,P)};if(q===S)return function(D,P,ue){if(!ue)throw Error("must be little endian");return x[q](D,P,ue)};if(typeof q=="string"&&q.match(/^(get)|(set)/))throw Error("invalid type");return x[q]}})}const u=typeof Js=="object",l=new Map,d=new Map;t.registerVFS=function(E,v){if(xt("sqlite3_vfs_find","number",["string"],[E.name]))throw Error(`VFS '${E.name}' already registered`);u&&(E.handleAsync=Hs);var F=E.Rc??64;const S=t._malloc(4);return v=xt("register_vfs","number",["string","number","number","number"],[E.name,F,v?1:0,S]),v||(F=ve(S,"i32"),l.set(F,E)),t._free(S),v};const w=u?new Set:null;Cs=function(E){const v=d.get(E);return u?w.add(E):d.delete(E),v.xClose(E)},qs=function(E,v,F,S){return d.get(E).xRead(E,z.subarray(v,v+F),ve(S,"i64"))},Qs=function(E,v,F,S){return d.get(E).xWrite(E,z.subarray(v,v+F),ve(S,"i64"))},Bs=function(E,v){return d.get(E).xTruncate(E,ve(v,"i64"))},Fs=function(E,v){return d.get(E).xSync(E,v)},As=function(E,v){const F=d.get(E);return v=o("BigInt64",v),F.xFileSize(E,v)},Ws=function(E,v){return d.get(E).xLock(E,v)},zs=function(E,v){return d.get(E).xUnlock(E,v)},Ss=function(E,v){const F=d.get(E);return v=o("Int32",v),F.xCheckReservedLock(E,v)},ks=function(E,v,F){const S=d.get(E);return F=new DataView(z.buffer,F),S.xFileControl(E,v,F)},Ds=function(E){return d.get(E).xSectorSize(E)},xs=function(E){return d.get(E).xDeviceCharacteristics(E)},Ls=function(E,v,F,S,x){if(E=l.get(E),d.set(F,E),u){w.delete(F);for(var q of w)d.delete(q)}if(q=null,S&64){q=1;const D=[];for(;q;){const P=z[v++];if(P)D.push(P);else switch(z[v]||(q=null),q){case 1:D.push(63),q=2;break;case 2:D.push(61),q=3;break;case 3:D.push(38),q=2}}q=new TextDecoder().decode(new Uint8Array(D))}else v&&(q=$(v));return x=o("Int32",x),E.xOpen(q,F,S,x)},Rs=function(E,v,F){return l.get(E).xDelete($(v),F)},Is=function(E,v,F,S){return E=l.get(E),S=o("Int32",S),E.xAccess($(v),F,S)}}();var zo={a:function(o,u,l,d){Ue("Assertion failed: "+$(o)+", at: "+[u?$(u):"unknown filename",l,d?$(d):"unknown function"])},K:function(o,u){try{return o=$(o),Ki(o,u),0}catch(l){if(typeof ge>"u"||l.name!=="ErrnoError")throw l;return-l.Lb}},N:function(o,u,l){try{if(u=$(u),u=Xt(o,u),l&-8)return-28;var d=rt(u,{Vb:!0}).node;return d?(o="",l&4&&(o+="r"),l&2&&(o+="w"),l&1&&(o+="x"),o&&pr(d,o)?-2:0):-44}catch(w){if(typeof ge>"u"||w.name!=="ErrnoError")throw w;return-w.Lb}},L:function(o,u){try{var l=Dt[o];if(!l)throw new B(8);return Ki(l.node,u),0}catch(d){if(typeof ge>"u"||d.name!=="ErrnoError")throw d;return-d.Lb}},J:function(o){try{var u=Dt[o];if(!u)throw new B(8);var l=u.node,d=typeof l=="string"?rt(l,{Vb:!0}).node:l;if(!d.Ab.Nb)throw new B(63);return d.Ab.Nb(d,{timestamp:Date.now()}),0}catch(w){if(typeof ge>"u"||w.name!=="ErrnoError")throw w;return-w.Lb}},b:function(o,u,l){kn=l;try{var d=pt(o);switch(u){case 0:var w=An();return 0>w?-28:$i(d,w).Tb;case 1:case 2:return 0;case 3:return d.flags;case 4:return w=An(),d.flags|=w,0;case 5:return w=An(),Q[w+0>>1]=2,0;case 6:case 7:return 0;case 16:case 8:return-28;case 9:return L[Gs()>>2]=28,-1;default:return-28}}catch(E){if(typeof ge>"u"||E.name!=="ErrnoError")throw E;return-E.Lb}},I:function(o,u){try{var l=pt(o);return xn(Sn,l.path,u)}catch(d){if(typeof ge>"u"||d.name!=="ErrnoError")throw d;return-d.Lb}},k:function(o,u,l){try{if(u=l+2097152>>>0<4194305-!!u?(u>>>0)+4294967296*l:NaN,isNaN(u))return-61;var d=Dt[o];if(!d)throw new B(8);if(!(d.flags&2097155))throw new B(28);return Gi(d.node,u),0}catch(w){if(typeof ge>"u"||w.name!=="ErrnoError")throw w;return-w.Lb}},C:function(o,u){try{if(u===0)return-28;var l=ce("/")+1;return u<l?-68:(J("/",o,u),l)}catch(d){if(typeof ge>"u"||d.name!=="ErrnoError")throw d;return-d.Lb}},G:function(o,u){try{return o=$(o),xn(ji,o,u)}catch(l){if(typeof ge>"u"||l.name!=="ErrnoError")throw l;return-l.Lb}},z:function(o,u,l){try{return u=$(u),u=Xt(o,u),u=ae(u),u[u.length-1]==="/"&&(u=u.substr(0,u.length-1)),_t(u,l),0}catch(d){if(typeof ge>"u"||d.name!=="ErrnoError")throw d;return-d.Lb}},E:function(o,u,l,d){try{u=$(u);var w=d&256;return u=Xt(o,u,d&4096),xn(w?ji:Sn,u,l)}catch(E){if(typeof ge>"u"||E.name!=="ErrnoError")throw E;return-E.Lb}},v:function(o,u,l,d){kn=d;try{u=$(u),u=Xt(o,u);var w=d?An():0;return Cn(u,l,w).Tb}catch(E){if(typeof ge>"u"||E.name!=="ErrnoError")throw E;return-E.Lb}},s:function(o,u,l,d){try{if(u=$(u),u=Xt(o,u),0>=d)return-28;var w=Ji(u),E=Math.min(d,ce(w)),v=H[l+E];return J(w,l,d+1),H[l+E]=v,E}catch(F){if(typeof ge>"u"||F.name!=="ErrnoError")throw F;return-F.Lb}},r:function(o){try{return o=$(o),Hi(o),0}catch(u){if(typeof ge>"u"||u.name!=="ErrnoError")throw u;return-u.Lb}},H:function(o,u){try{return o=$(o),xn(Sn,o,u)}catch(l){if(typeof ge>"u"||l.name!=="ErrnoError")throw l;return-l.Lb}},o:function(o,u,l){try{if(u=$(u),u=Xt(o,u),l===0){o=u;var d=rt(o,{parent:!0}).node;if(!d)throw new B(44);var w=Re(o),E=Gt(d,w),v=Ui(d,w,!1);if(v)throw new B(v);if(!d.Ab.lc)throw new B(63);if(E.Xb)throw new B(10);d.Ab.lc(d,w),zi(E)}else l===512?Hi(u):Ue("Invalid flags passed to unlinkat");return 0}catch(F){if(typeof ge>"u"||F.name!=="ErrnoError")throw F;return-F.Lb}},n:function(o,u,l){try{if(u=$(u),u=Xt(o,u,!0),l){var d=bi(l),w=L[l+8>>2];E=1e3*d+w/1e6,l+=16,d=bi(l),w=L[l+8>>2],v=1e3*d+w/1e6}else var E=Date.now(),v=E;o=E;var F=rt(u,{Vb:!0}).node;return F.Ab.Nb(F,{timestamp:Math.max(o,v)}),0}catch(S){if(typeof ge>"u"||S.name!=="ErrnoError")throw S;return-S.Lb}},y:function(o,u){o=new Date(1e3*bi(o)),L[u>>2]=o.getSeconds(),L[u+4>>2]=o.getMinutes(),L[u+8>>2]=o.getHours(),L[u+12>>2]=o.getDate(),L[u+16>>2]=o.getMonth(),L[u+20>>2]=o.getFullYear()-1900,L[u+24>>2]=o.getDay();var l=o.getFullYear();L[u+28>>2]=(l%4!==0||l%100===0&&l%400!==0?Wo:Ao)[o.getMonth()]+o.getDate()-1|0,L[u+36>>2]=-(60*o.getTimezoneOffset()),l=new Date(o.getFullYear(),6,1).getTimezoneOffset();var d=new Date(o.getFullYear(),0,1).getTimezoneOffset();L[u+32>>2]=(l!=d&&o.getTimezoneOffset()==Math.min(d,l))|0},w:function(o,u,l,d,w,E,v){try{var F=pt(d);if(u&2&&!(l&2)&&(F.flags&2097155)!==2)throw new B(2);if((F.flags&2097155)===1)throw new B(2);if(!F.Jb.hc)throw new B(43);var S=F.Jb.hc(F,o,w,u,l),x=S.Lc;return L[E>>2]=S.zc,X[v>>2]=x,0}catch(q){if(typeof ge>"u"||q.name!=="ErrnoError")throw q;return-q.Lb}},x:function(o,u,l,d,w,E){try{var v=pt(w);if(l&2){if((v.node.mode&61440)!==32768)throw new B(43);d&2||v.Jb.ic&&v.Jb.ic(v,z.slice(o,o+u),E,u,d)}}catch(F){if(typeof ge>"u"||F.name!=="ErrnoError")throw F;return-F.Lb}},p:function(o,u,l){function d(S){return(S=S.toTimeString().match(/\(([A-Za-z ]+)\)$/))?S[1]:"GMT"}var w=new Date().getFullYear(),E=new Date(w,0,1),v=new Date(w,6,1);w=E.getTimezoneOffset();var F=v.getTimezoneOffset();X[o>>2]=60*Math.max(w,F),L[u>>2]=+(w!=F),o=d(E),u=d(v),o=es(o),u=es(u),F<w?(X[l>>2]=o,X[l+4>>2]=u):(X[l>>2]=u,X[l+4>>2]=o)},e:function(){return Date.now()},d:()=>performance.now(),l:function(o){var u=z.length;if(o>>>=0,2147483648<o)return!1;for(var l=1;4>=l;l*=2){var d=u*(1+.2/l);d=Math.min(d,o+100663296);var w=Math,E=w.min;d=Math.max(o,d),d+=(65536-d%65536)%65536;e:{var v=b.buffer;try{b.grow(E.call(w,2147483648,d)-v.byteLength+65535>>>16),he();var F=1;break e}catch{}F=void 0}if(F)return!0}return!1},A:function(o,u){var l=0;return ts().forEach(function(d,w){var E=u+l;for(w=X[o+4*w>>2]=E,E=0;E<d.length;++E)H[w++>>0]=d.charCodeAt(E);H[w>>0]=0,l+=d.length+1}),0},B:function(o,u){var l=ts();X[o>>2]=l.length;var d=0;return l.forEach(function(w){d+=w.length+1}),X[u>>2]=d,0},f:function(o){try{var u=pt(o);if(u.Tb===null)throw new B(8);u.mc&&(u.mc=null);try{u.Jb.close&&u.Jb.close(u)}catch(l){throw l}finally{Dt[u.Tb]=null}return u.Tb=null,0}catch(l){if(typeof ge>"u"||l.name!=="ErrnoError")throw l;return l.Lb}},m:function(o,u){try{var l=pt(o);return H[u>>0]=l.Pb?2:(l.mode&61440)===16384?3:(l.mode&61440)===40960?7:4,0}catch(d){if(typeof ge>"u"||d.name!=="ErrnoError")throw d;return d.Lb}},t:function(o,u,l,d){try{e:{var w=pt(o);o=u;for(var E,v=u=0;v<l;v++){var F=X[o>>2],S=X[o+4>>2];o+=8;var x=w,q=F,D=S,P=E,ue=H;if(0>D||0>P)throw new B(28);if(x.Tb===null)throw new B(8);if((x.flags&2097155)===1)throw new B(8);if((x.node.mode&61440)===16384)throw new B(31);if(!x.Jb.read)throw new B(28);var Te=typeof P<"u";if(!Te)P=x.position;else if(!x.seekable)throw new B(70);var Be=x.Jb.read(x,ue,q,D,P);Te||(x.position+=Be);var We=Be;if(0>We){var nt=-1;break e}if(u+=We,We<S)break;typeof E<"u"&&(E+=We)}nt=u}return X[d>>2]=nt,0}catch(Ve){if(typeof ge>"u"||Ve.name!=="ErrnoError")throw Ve;return Ve.Lb}},i:function(o,u,l,d,w){try{if(u=l+2097152>>>0<4194305-!!u?(u>>>0)+4294967296*l:NaN,isNaN(u))return 61;var E=pt(o);return Xi(E,u,d),pe=[E.position>>>0,(Y=E.position,1<=+Math.abs(Y)?0<Y?(Math.min(+Math.floor(Y/4294967296),4294967295)|0)>>>0:~~+Math.ceil((Y-+(~~Y>>>0))/4294967296)>>>0:0)],L[w>>2]=pe[0],L[w+4>>2]=pe[1],E.mc&&u===0&&d===0&&(E.mc=null),0}catch(v){if(typeof ge>"u"||v.name!=="ErrnoError")throw v;return v.Lb}},D:function(o){try{var u=pt(o);return Vs(function(l){var d=u.node.Rb;d.type.Oc?d.type.Oc(d,!1,function(w){l(w?function(){return 29}:0)}):l(0)})}catch(l){if(typeof ge>"u"||l.name!=="ErrnoError")throw l;return l.Lb}},q:function(o,u,l,d){try{e:{var w=pt(o);o=u;for(var E,v=u=0;v<l;v++){var F=X[o>>2],S=X[o+4>>2];o+=8;var x=w,q=F,D=S,P=E,ue=H;if(0>D||0>P)throw new B(28);if(x.Tb===null)throw new B(8);if(!(x.flags&2097155))throw new B(8);if((x.node.mode&61440)===16384)throw new B(31);if(!x.Jb.write)throw new B(28);x.seekable&&x.flags&1024&&Xi(x,0,2);var Te=typeof P<"u";if(!Te)P=x.position;else if(!x.seekable)throw new B(70);var Be=x.Jb.write(x,ue,q,D,P,void 0);Te||(x.position+=Be);var We=Be;if(0>We){var nt=-1;break e}u+=We,typeof E<"u"&&(E+=We)}nt=u}return X[d>>2]=nt,0}catch(Ve){if(typeof ge>"u"||Ve.name!=="ErrnoError")throw Ve;return Ve.Lb}},X:rs,qa:ns,fa:ss,M:os,ka:as,F:us,h:ls,na:cs,ia:ds,da:fs,ea:hs,j:ps,u:ms,oa:ys,g:Ns,pa:bs,ca:ws,ga:Es,ha:gs,ma:_s,c:Os,ja:Ts,la:vs,aa:Is,V:Ss,$:Cs,ba:Rs,S:xs,U:ks,Z:As,Y:Ws,R:Ls,Q:qs,T:Ds,_:Fs,O:Bs,W:zs,P:Qs};(function(){function o(l){if(l=l.exports,l=Lo(l),t.asm=l,b=t.asm.ra,he(),ie.unshift(t.asm.sa),Fe--,t.monitorRunDependencies&&t.monitorRunDependencies(Fe),Fe==0&&qe){var d=qe;qe=null,d()}return l}var u={a:zo};if(Fe++,t.monitorRunDependencies&&t.monitorRunDependencies(Fe),t.instantiateWasm)try{return t.instantiateWasm(u,o)}catch(l){k("Module.instantiateWasm callback failed with error: "+l),s(l)}return Rt(u,function(l){o(l.instance)}).catch(s),{}})(),t._sqlite3_malloc=function(){return(t._sqlite3_malloc=t.asm.ta).apply(null,arguments)},t._sqlite3_free=function(){return(t._sqlite3_free=t.asm.ua).apply(null,arguments)},t._sqlite3_bind_blob=function(){return(t._sqlite3_bind_blob=t.asm.va).apply(null,arguments)},t._sqlite3_bind_int=function(){return(t._sqlite3_bind_int=t.asm.wa).apply(null,arguments)},t._sqlite3_bind_int64=function(){return(t._sqlite3_bind_int64=t.asm.xa).apply(null,arguments)},t._sqlite3_bind_text=function(){return(t._sqlite3_bind_text=t.asm.ya).apply(null,arguments)},t._sqlite3_close=function(){return(t._sqlite3_close=t.asm.za).apply(null,arguments)},t._sqlite3_column_type=function(){return(t._sqlite3_column_type=t.asm.Aa).apply(null,arguments)},t._sqlite3_column_count=function(){return(t._sqlite3_column_count=t.asm.Ba).apply(null,arguments)},t._sqlite3_column_text=function(){return(t._sqlite3_column_text=t.asm.Ca).apply(null,arguments)},t._sqlite3_column_blob=function(){return(t._sqlite3_column_blob=t.asm.Da).apply(null,arguments)},t._sqlite3_column_bytes=function(){return(t._sqlite3_column_bytes=t.asm.Ea).apply(null,arguments)},t._sqlite3_column_double=function(){return(t._sqlite3_column_double=t.asm.Fa).apply(null,arguments)},t._sqlite3_column_int=function(){return(t._sqlite3_column_int=t.asm.Ga).apply(null,arguments)},t._sqlite3_column_int64=function(){return(t._sqlite3_column_int64=t.asm.Ha).apply(null,arguments)},t._sqlite3_column_name=function(){return(t._sqlite3_column_name=t.asm.Ia).apply(null,arguments)},t._sqlite3_declare_vtab=function(){return(t._sqlite3_declare_vtab=t.asm.Ja).apply(null,arguments)},t._sqlite3_errmsg=function(){return(t._sqlite3_errmsg=t.asm.Ka).apply(null,arguments)},t._sqlite3_exec=function(){return(t._sqlite3_exec=t.asm.La).apply(null,arguments)},t._sqlite3_finalize=function(){return(t._sqlite3_finalize=t.asm.Ma).apply(null,arguments)},t._sqlite3_prepare_v2=function(){return(t._sqlite3_prepare_v2=t.asm.Na).apply(null,arguments)},t._sqlite3_result_int=function(){return(t._sqlite3_result_int=t.asm.Oa).apply(null,arguments)},t._sqlite3_result_blob=function(){return(t._sqlite3_result_blob=t.asm.Pa).apply(null,arguments)},t._sqlite3_result_int64=function(){return(t._sqlite3_result_int64=t.asm.Qa).apply(null,arguments)},t._sqlite3_result_double=function(){return(t._sqlite3_result_double=t.asm.Ra).apply(null,arguments)},t._sqlite3_result_null=function(){return(t._sqlite3_result_null=t.asm.Sa).apply(null,arguments)},t._sqlite3_result_error=function(){return(t._sqlite3_result_error=t.asm.Ta).apply(null,arguments)},t._sqlite3_result_text=function(){return(t._sqlite3_result_text=t.asm.Ua).apply(null,arguments)},t._sqlite3_sql=function(){return(t._sqlite3_sql=t.asm.Va).apply(null,arguments)},t._sqlite3_reset=function(){return(t._sqlite3_reset=t.asm.Wa).apply(null,arguments)},t._sqlite3_step=function(){return(t._sqlite3_step=t.asm.Xa).apply(null,arguments)},t._sqlite3_value_text=function(){return(t._sqlite3_value_text=t.asm.Ya).apply(null,arguments)},t._sqlite3_value_type=function(){return(t._sqlite3_value_type=t.asm.Za).apply(null,arguments)},t._sqlite3_value_bytes=function(){return(t._sqlite3_value_bytes=t.asm._a).apply(null,arguments)},t._sqlite3_value_blob=function(){return(t._sqlite3_value_blob=t.asm.$a).apply(null,arguments)},t._sqlite3_value_int=function(){return(t._sqlite3_value_int=t.asm.ab).apply(null,arguments)},t._sqlite3_value_int64=function(){return(t._sqlite3_value_int64=t.asm.bb).apply(null,arguments)},t._sqlite3_value_double=function(){return(t._sqlite3_value_double=t.asm.cb).apply(null,arguments)},t._RegisterExtensionFunctions=function(){return(t._RegisterExtensionFunctions=t.asm.db).apply(null,arguments)};var Ks=t._free=function(){return(Ks=t._free=t.asm.eb).apply(null,arguments)};function Gs(){return(Gs=t.asm.fb).apply(null,arguments)}t._create_function=function(){return(t._create_function=t.asm.gb).apply(null,arguments)},t._update_hook=function(){return(t._update_hook=t.asm.hb).apply(null,arguments)},t._create_module=function(){return(t._create_module=t.asm.ib).apply(null,arguments)},t._register_vfs=function(){return(t._register_vfs=t.asm.jb).apply(null,arguments)},t._sqlite3_vfs_find=function(){return(t._sqlite3_vfs_find=t.asm.kb).apply(null,arguments)},t._getSqliteFree=function(){return(t._getSqliteFree=t.asm.lb).apply(null,arguments)};var Xs=t._main=function(){return(Xs=t._main=t.asm.mb).apply(null,arguments)};t._sqlite3_bind_null=function(){return(t._sqlite3_bind_null=t.asm.nb).apply(null,arguments)},t._sqlite3_clear_bindings=function(){return(t._sqlite3_clear_bindings=t.asm.ob).apply(null,arguments)},t._sqlite3_data_count=function(){return(t._sqlite3_data_count=t.asm.pb).apply(null,arguments)},t._sqlite3_bind_double=function(){return(t._sqlite3_bind_double=t.asm.qb).apply(null,arguments)},t._sqlite3_bind_parameter_count=function(){return(t._sqlite3_bind_parameter_count=t.asm.rb).apply(null,arguments)},t._sqlite3_bind_parameter_name=function(){return(t._sqlite3_bind_parameter_name=t.asm.sb).apply(null,arguments)},t._sqlite3_libversion=function(){return(t._sqlite3_libversion=t.asm.tb).apply(null,arguments)},t._sqlite3_libversion_number=function(){return(t._sqlite3_libversion_number=t.asm.ub).apply(null,arguments)},t._sqlite3_changes=function(){return(t._sqlite3_changes=t.asm.vb).apply(null,arguments)},t._sqlite3_open_v2=function(){return(t._sqlite3_open_v2=t.asm.wb).apply(null,arguments)},t._sqlite3_get_autocommit=function(){return(t._sqlite3_get_autocommit=t.asm.xb).apply(null,arguments)};var Oi=t._malloc=function(){return(Oi=t._malloc=t.asm.yb).apply(null,arguments)};function Ys(){return(Ys=t.asm.zb).apply(null,arguments)}function Zs(){return(Zs=t.asm.Bb).apply(null,arguments)}function eo(){return(eo=t.asm.Cb).apply(null,arguments)}function ro(){return(ro=t.asm.Db).apply(null,arguments)}function Ti(){return(Ti=t.asm.Eb).apply(null,arguments)}function no(){return(no=t.asm.Fb).apply(null,arguments)}function io(){return(io=t.asm.Gb).apply(null,arguments)}function so(){return(so=t.asm.Hb).apply(null,arguments)}function oo(){return(oo=t.asm.Ib).apply(null,arguments)}t.UTF8ToString=$,t.stringToUTF8=J,t.lengthBytesUTF8=ce,t.getTempRet0=Zs,t.ccall=xt,t.cwrap=function(o,u,l,d){var w=!l||l.every(E=>E==="number"||E==="boolean");return u!=="string"&&w&&!d?t["_"+o]:function(){return xt(o,u,l,arguments,d)}},t.setValue=lt,t.getValue=ve;var qn;qe=function o(){qn||ao(),qn||(qe=o)};function ao(){function o(){if(!qn&&(qn=!0,t.calledRun=!0,!y)){if(t.noFSInit||Zi||(Zi=!0,Yi(),t.stdin=t.stdin,t.stdout=t.stdout,t.stderr=t.stderr,t.stdin?$r("stdin",t.stdin):yi("/dev/tty","/dev/stdin"),t.stdout?$r("stdout",null,t.stdout):yi("/dev/tty","/dev/stdout"),t.stderr?$r("stderr",null,t.stderr):yi("/dev/tty1","/dev/stderr"),Cn("/dev/stdin",0),Cn("/dev/stdout",1),Cn("/dev/stderr",1)),Bi=!1,jt(ie),jt(Me),n(t),t.onRuntimeInitialized&&t.onRuntimeInitialized(),uo){var u=Xs;try{var l=u(0,0);_=l,Ps(l)}catch(d){gi(d)}}if(t.postRun)for(typeof t.postRun=="function"&&(t.postRun=[t.postRun]);t.postRun.length;)u=t.postRun.shift(),Ee.unshift(u);jt(Ee)}}if(!(0<Fe)){if(t.preRun)for(typeof t.preRun=="function"&&(t.preRun=[t.preRun]);t.preRun.length;)tt();jt(M),0<Fe||(t.setStatus?(t.setStatus("Running..."),setTimeout(function(){setTimeout(function(){t.setStatus("")},1),o()},1)):o())}}if(t.preInit)for(typeof t.preInit=="function"&&(t.preInit=[t.preInit]);0<t.preInit.length;)t.preInit.pop()();var uo=!0;return t.noInitialRun&&(uo=!1),ao(),e.ready}})();const SQLiteAsyncESMFactory=Module,SQLITE_OK=0,SQLITE_BUSY=5,SQLITE_IOERR=10,SQLITE_NOTFOUND=12,SQLITE_CANTOPEN=14,SQLITE_MISUSE=21,SQLITE_RANGE=25,SQLITE_NOTICE=27,SQLITE_ROW=100,SQLITE_DONE=101,SQLITE_IOERR_LOCK=3850,SQLITE_IOERR_SHORT_READ=522,SQLITE_OPEN_READONLY=1,SQLITE_OPEN_READWRITE=2,SQLITE_OPEN_CREATE=4,SQLITE_OPEN_DELETEONCLOSE=8,SQLITE_OPEN_URI=64,SQLITE_LOCK_NONE=0,SQLITE_LOCK_SHARED=1,SQLITE_LOCK_RESERVED=2,SQLITE_LOCK_PENDING=3,SQLITE_LOCK_EXCLUSIVE=4,SQLITE_IOCAP_SAFE_APPEND=512,SQLITE_IOCAP_SEQUENTIAL=1024,SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN=2048,SQLITE_IOCAP_BATCH_ATOMIC=16384,SQLITE_INTEGER=1,SQLITE_FLOAT=2,SQLITE_TEXT=3,SQLITE_BLOB=4,SQLITE_NULL=5,SQLITE_UTF8=1,MAX_INT64=0x7fffffffffffffffn,MIN_INT64=-0x8000000000000000n;class SQLiteError extends Error{constructor(e,t){super(e),this.code=t}}const async=!0;function Factory(r){const e={},t=r._getSqliteFree(),n=r._malloc(8),s=[n,n+4];function a(p){if(typeof p!="string")return 0;const b=r.lengthBytesUTF8(p),y=r._sqlite3_malloc(b+1);return r.stringToUTF8(p,y,b+1),y}function c(p,b){return BigInt(b)<<32n|BigInt(p)&0xffffffffn}const f=function(){const p=BigInt(Number.MAX_SAFE_INTEGER)>>32n,b=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(y,_){return _>p||_<b?c(y,_):_*4294967296+(y&2147483647)-(y&2147483648)}}(),h=new Set;function m(p){if(!h.has(p))throw new SQLiteError("not a database",SQLITE_MISUSE)}const N=new Map;function g(p){if(!N.has(p))throw new SQLiteError("not a statement",SQLITE_MISUSE)}e.bind_collection=function(p,b){g(p);const y=Array.isArray(b),_=e.bind_parameter_count(p);for(let R=1;R<=_;++R){const U=y?R-1:e.bind_parameter_name(p,R),$=b[U];$!==void 0&&e.bind(p,R,$)}return SQLITE_OK},e.bind=function(p,b,y){switch(g(p),typeof y){case"number":return y===(y|0)?e.bind_int(p,b,y):e.bind_double(p,b,y);case"string":return e.bind_text(p,b,y);default:if(y instanceof Uint8Array||Array.isArray(y))return e.bind_blob(p,b,y);if(y===null)return e.bind_null(p,b);if(typeof y=="bigint")return e.bind_int64(p,b,y);if(y===void 0)return SQLITE_NOTICE;throw new Error("Unknown binding type "+typeof y)}},e.bind_blob=function(){const p="sqlite3_bind_blob",b=r.cwrap(p,...decl("nnnnn:n"));return function(y,_,R){g(y);const U=R.byteLength??R.length,$=r._sqlite3_malloc(U);r.HEAPU8.subarray($).set(R);const W=b(y,_,$,U,t);return O(p,W,N.get(y))}}(),e.bind_parameter_count=function(){const p="sqlite3_bind_parameter_count",b=r.cwrap(p,...decl("n:n"));return function(y){return g(y),b(y)}}(),e.bind_double=function(){const p="sqlite3_bind_double",b=r.cwrap(p,...decl("nnn:n"));return function(y,_,R){g(y);const U=b(y,_,R);return O(p,U,N.get(y))}}(),e.bind_int=function(){const p="sqlite3_bind_int",b=r.cwrap(p,...decl("nnn:n"));return function(y,_,R){if(g(y),R>2147483647||R<-2147483648)return SQLITE_RANGE;const U=b(y,_,R);return O(p,U,N.get(y))}}(),e.bind_int64=function(){const p="sqlite3_bind_int64",b=r.cwrap(p,...decl("nnnn:n"));return function(y,_,R){if(g(y),R>MAX_INT64||R<MIN_INT64)return SQLITE_RANGE;const U=R&0xffffffffn,$=R>>32n,W=b(y,_,Number(U),Number($));return O(p,W,N.get(y))}}(),e.bind_null=function(){const p="sqlite3_bind_null",b=r.cwrap(p,...decl("nn:n"));return function(y,_){g(y);const R=b(y,_);return O(p,R,N.get(y))}}(),e.bind_parameter_name=function(){const p="sqlite3_bind_parameter_name",b=r.cwrap(p,...decl("n:s"));return function(y,_){return g(y),b(y,_)}}(),e.bind_text=function(){const p="sqlite3_bind_text",b=r.cwrap(p,...decl("nnnnn:n"));return function(y,_,R){g(y);const U=a(R),$=b(y,_,U,-1,t);return O(p,$,N.get(y))}}(),e.changes=function(){const p="sqlite3_changes",b=r.cwrap(p,...decl("n:n"));return function(y){return m(y),b(y)}}(),e.close=function(){const p="sqlite3_close",b=r.cwrap(p,...decl("n:n"),{async});return async function(y){m(y);const _=await b(y);return h.delete(y),O(p,_,y)}}(),e.column=function(p,b){g(p);const y=e.column_type(p,b);switch(y){case SQLITE_BLOB:return e.column_blob(p,b);case SQLITE_FLOAT:return e.column_double(p,b);case SQLITE_INTEGER:const _=e.column_int(p,b),R=r.getTempRet0();return f(_,R);case SQLITE_NULL:return null;case SQLITE_TEXT:return e.column_text(p,b);default:throw new SQLiteError("unknown type",y)}},e.column_blob=function(){const p="sqlite3_column_blob",b=r.cwrap(p,...decl("nn:n"));return function(y,_){g(y);const R=e.column_bytes(y,_),U=b(y,_),$=r.HEAPU8.subarray(U,U+R),W=new ArrayBuffer($.byteLength),J=new Uint8Array(W);return J.set($),J}}(),e.column_bytes=function(){const p="sqlite3_column_bytes",b=r.cwrap(p,...decl("nn:n"));return function(y,_){return g(y),b(y,_)}}(),e.column_count=function(){const p="sqlite3_column_count",b=r.cwrap(p,...decl("n:n"));return function(y){return g(y),b(y)}}(),e.column_double=function(){const p="sqlite3_column_double",b=r.cwrap(p,...decl("nn:n"));return function(y,_){return g(y),b(y,_)}}(),e.column_int=function(){const p="sqlite3_column_int64",b=r.cwrap(p,...decl("nn:n"));return function(y,_){return g(y),b(y,_)}}(),e.column_int64=function(){const p="sqlite3_column_int64",b=r.cwrap(p,...decl("nn:n"));return function(y,_){g(y);const R=b(y,_),U=r.getTempRet0();return c(R,U)}}(),e.column_name=function(){const p="sqlite3_column_name",b=r.cwrap(p,...decl("nn:s"));return function(y,_){return g(y),b(y,_)}}(),e.column_names=function(p){const b=[],y=e.column_count(p);for(let _=0;_<y;++_)b.push(e.column_name(p,_));return b},e.column_text=function(){const p="sqlite3_column_text",b=r.cwrap(p,...decl("nn:s"));return function(y,_){return g(y),b(y,_)}}(),e.column_type=function(){const p="sqlite3_column_type",b=r.cwrap(p,...decl("nn:n"));return function(y,_){return g(y),b(y,_)}}(),e.update_hook=function(p,b){return m(p),r.updateHook(p,b),SQLITE_OK},e.create_function=function(p,b,y,_,R,U,$,W){if(m(p),U&&!$&&!W){const J=r.createFunction(p,b,y,_,R,U);return O("sqlite3_create_function",J,p)}if(!U&&$&&W){const J=r.createAggregate(p,b,y,_,R,$,W);return O("sqlite3_create_function",J,p)}throw new SQLiteError("invalid function combination",SQLITE_MISUSE)},e.create_module=function(p,b,y,_){m(p);const R=r.createModule(p,b,y,_);return O("sqlite3_create_module",R,p)},e.data_count=function(){const p="sqlite3_data_count",b=r.cwrap(p,...decl("n:n"));return function(y){return g(y),b(y)}}(),e.declare_vtab=function(){const p="sqlite3_declare_vtab",b=r.cwrap(p,...decl("ns:n"));return function(y,_){const R=b(y,_);return O("sqlite3_declare_vtab",R)}}(),e.exec=async function(p,b,y){for await(const _ of e.statements(p,b)){let R;for(;await e.step(_)===SQLITE_ROW;)if(y){R=R??e.column_names(_);const U=e.row(_);await y(U,R)}}return SQLITE_OK},e.finalize=function(){const p="sqlite3_finalize",b=r.cwrap(p,...decl("n:n"),{async});return async function(y){g(y);const _=await b(y),R=N.get(y);return N.delete(y),O(p,_,R)}}(),e.get_autocommit=function(){const p="sqlite3_get_autocommit",b=r.cwrap(p,...decl("n:n"));return function(y){return b(y)}}(),e.libversion=function(){const p="sqlite3_libversion",b=r.cwrap(p,...decl(":s"));return function(){return b()}}(),e.libversion_number=function(){const p="sqlite3_libversion_number",b=r.cwrap(p,...decl(":n"));return function(){return b()}}(),e.open_v2=function(){const p="sqlite3_open_v2",b=r.cwrap(p,...decl("snnn:n"),{async});return async function(y,_,R){_=_||SQLITE_OPEN_CREATE|SQLITE_OPEN_READWRITE,R=a(R);const U=await b(y,s[0],_,R),$=r.getValue(s[0],"i32");return h.add($),r._sqlite3_free(R),r.ccall("RegisterExtensionFunctions","void",["number"],[$]),O(p,U),$}}(),e.prepare_v2=function(){const p="sqlite3_prepare_v2",b=r.cwrap(p,...decl("nnnnn:n"),{async});return async function(y,_){const R=await b(y,_,-1,s[0],s[1]);O(p,R,y);const U=r.getValue(s[0],"i32");return U?(N.set(U,y),{stmt:U,sql:r.getValue(s[1],"i32")}):null}}(),e.reset=function(){const p="sqlite3_reset",b=r.cwrap(p,...decl("n:n"),{async});return async function(y){g(y);const _=await b(y);return O(p,_,N.get(y))}}(),e.result=function(p,b){switch(typeof b){case"number":b===(b|0)?e.result_int(p,b):e.result_double(p,b);break;case"string":e.result_text(p,b);break;default:if(b instanceof Uint8Array||Array.isArray(b))e.result_blob(p,b);else if(b===null)e.result_null(p);else{if(typeof b=="bigint")return e.result_int64(p,b);console.warn("unknown result converted to null",b),e.result_null(p)}break}},e.result_blob=function(){const p="sqlite3_result_blob",b=r.cwrap(p,...decl("nnnn:n"));return function(y,_){const R=_.byteLength??_.length,U=r._sqlite3_malloc(R);r.HEAPU8.subarray(U).set(_),b(y,U,R,t)}}(),e.result_double=function(){const p="sqlite3_result_double",b=r.cwrap(p,...decl("nn:n"));return function(y,_){b(y,_)}}(),e.result_int=function(){const p="sqlite3_result_int",b=r.cwrap(p,...decl("nn:n"));return function(y,_){b(y,_)}}(),e.result_int64=function(){const p="sqlite3_result_int64",b=r.cwrap(p,...decl("nnn:n"));return function(y,_){if(_>MAX_INT64||_<MIN_INT64)return SQLITE_RANGE;const R=_&0xffffffffn,U=_>>32n;b(y,Number(R),Number(U))}}(),e.result_null=function(){const p="sqlite3_result_null",b=r.cwrap(p,...decl("n:n"));return function(y){b(y)}}(),e.result_text=function(){const p="sqlite3_result_text",b=r.cwrap(p,...decl("nnnn:n"));return function(y,_){const R=a(_);b(y,R,-1,t)}}(),e.row=function(p){const b=[],y=e.data_count(p);for(let _=0;_<y;++_){const R=e.column(p,_);b.push((R==null?void 0:R.buffer)===r.HEAPU8.buffer?R.slice():R)}return b},e.sql=function(){const p="sqlite3_sql",b=r.cwrap(p,...decl("n:s"));return function(y){return g(y),b(y)}}(),e.statements=function(p,b){return async function*(){const y=e.str_new(p,b);let _={stmt:null,sql:e.str_value(y)};try{for(;_=await e.prepare_v2(p,_.sql);)yield _.stmt,e.finalize(_.stmt),_.stmt=null}finally{_!=null&&_.stmt&&e.finalize(_.stmt),e.str_finish(y)}}()},e.step=function(){const p="sqlite3_step",b=r.cwrap(p,...decl("n:n"),{async});return async function(y){g(y);const _=await b(y);return O(p,_,N.get(y),[SQLITE_ROW,SQLITE_DONE])}}();let C=0;const k=new Map;e.str_new=function(p,b=""){const y=r.lengthBytesUTF8(b),_=C++&4294967295,R={offset:r._sqlite3_malloc(y+1),bytes:y};return k.set(_,R),r.stringToUTF8(b,R.offset,R.bytes+1),_},e.str_appendall=function(p,b){if(!k.has(p))throw new SQLiteError("not a string",SQLITE_MISUSE);const y=k.get(p),_=r.lengthBytesUTF8(b),R=y.bytes+_,U=r._sqlite3_malloc(R+1);r.HEAPU8.subarray(U,U+R+1).set(r.HEAPU8.subarray(y.offset,y.offset+y.bytes)),r.stringToUTF8(b,U+y.bytes,_+1),r._sqlite3_free(y.offset),y.offset=U,y.bytes=R,k.set(p,y)},e.str_finish=function(p){if(!k.has(p))throw new SQLiteError("not a string",SQLITE_MISUSE);const b=k.get(p);k.delete(p),r._sqlite3_free(b.offset)},e.str_value=function(p){if(!k.has(p))throw new SQLiteError("not a string",SQLITE_MISUSE);return k.get(p).offset},e.user_data=function(p){return r.getFunctionUserData(p)},e.value=function(p){const b=e.value_type(p);switch(b){case SQLITE_BLOB:return e.value_blob(p);case SQLITE_FLOAT:return e.value_double(p);case SQLITE_INTEGER:const y=e.value_int(p),_=r.getTempRet0();return f(y,_);case SQLITE_NULL:return null;case SQLITE_TEXT:return e.value_text(p);default:throw new SQLiteError("unknown type",b)}},e.value_blob=function(){const p="sqlite3_value_blob",b=r.cwrap(p,...decl("n:n"));return function(y){const _=e.value_bytes(y),R=b(y);return r.HEAPU8.subarray(R,R+_)}}(),e.value_bytes=function(){const p="sqlite3_value_bytes",b=r.cwrap(p,...decl("n:n"));return function(y){return b(y)}}(),e.value_double=function(){const p="sqlite3_value_double",b=r.cwrap(p,...decl("n:n"));return function(y){return b(y)}}(),e.value_int=function(){const p="sqlite3_value_int64",b=r.cwrap(p,...decl("n:n"));return function(y){return b(y)}}(),e.value_int64=function(){const p="sqlite3_value_int64",b=r.cwrap(p,...decl("n:n"));return function(y){const _=b(y),R=r.getTempRet0();return c(_,R)}}(),e.value_text=function(){const p="sqlite3_value_text",b=r.cwrap(p,...decl("n:s"));return function(y){return b(y)}}(),e.value_type=function(){const p="sqlite3_value_type",b=r.cwrap(p,...decl("n:n"));return function(y){return b(y)}}(),e.vfs_register=function(p,b){const y=r.registerVFS(p,b);return O("sqlite3_vfs_register",y)};function O(p,b,y=null,_=[SQLITE_OK]){if(_.includes(b))return b;const R=y?r.ccall("sqlite3_errmsg","string",["number"],[y]):p;throw new SQLiteError(R,b)}return e}function decl(r){const e=[],t=r.match(/([ns@]*):([ns@])/);switch(t[2]){case"n":e.push("number");break;case"s":e.push("string");break}const n=[];for(let s of t[1])switch(s){case"n":n.push("number");break;case"s":n.push("string");break}return e.push(n),e}class Base{constructor(){le(this,"mxPathName",64)}xClose(e){return SQLITE_IOERR}xRead(e,t,n){return SQLITE_IOERR}xWrite(e,t,n){return SQLITE_IOERR}xTruncate(e,t){return SQLITE_IOERR}xSync(e,t){return SQLITE_OK}xFileSize(e,t){return SQLITE_IOERR}xLock(e,t){return SQLITE_OK}xUnlock(e,t){return SQLITE_OK}xCheckReservedLock(e,t){return t.setInt32(0,0,!0),SQLITE_OK}xFileControl(e,t,n){return SQLITE_NOTFOUND}xSectorSize(e){return 512}xDeviceCharacteristics(e){return 0}xOpen(e,t,n,s){return SQLITE_CANTOPEN}xDelete(e,t){return SQLITE_IOERR}xAccess(e,t,n){return SQLITE_IOERR}handleAsync(e){return e()}}const LOCK_TYPE_MASK=SQLITE_LOCK_NONE|SQLITE_LOCK_SHARED|SQLITE_LOCK_RESERVED|SQLITE_LOCK_PENDING|SQLITE_LOCK_EXCLUSIVE;var Ke,Pr,yn,Nn,ki,ti,Eo,ri,go;class WebLocksBase{constructor(){T(this,Nn);T(this,ti);T(this,ri);T(this,Ke,SQLITE_LOCK_NONE);le(this,"timeoutMillis",0);T(this,Pr,new Map);T(this,yn,Promise.resolve(0))}get state(){return i(this,Ke)}async lock(e){return te(this,Nn,ki).call(this,te(this,ti,Eo),e)}async unlock(e){return te(this,Nn,ki).call(this,te(this,ri,go),e)}async isSomewhereReserved(){throw new Error("unimplemented")}async _NONEtoSHARED(){}async _SHAREDtoEXCLUSIVE(){await this._SHAREDtoRESERVED(),await this._RESERVEDtoEXCLUSIVE()}async _SHAREDtoRESERVED(){}async _RESERVEDtoEXCLUSIVE(){}async _EXCLUSIVEtoRESERVED(){}async _EXCLUSIVEtoSHARED(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED()}async _EXCLUSIVEtoNONE(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _RESERVEDtoSHARED(){}async _RESERVEDtoNONE(){await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _SHAREDtoNONE(){}_acquireWebLock(e,t){return new Promise(async(n,s)=>{try{await navigator.locks.request(e,t,a=>{if(n(a),a)return new Promise(c=>i(this,Pr).set(e,c))})}catch(a){s(a)}})}_releaseWebLock(e){var t;(t=i(this,Pr).get(e))==null||t(),i(this,Pr).delete(e)}async _pollWebLock(e){var n;return(n=(await navigator.locks.query()).held.find(({name:s})=>s===e))==null?void 0:n.mode}_getTimeoutSignal(){if(this.timeoutMillis){const e=new AbortController;return setTimeout(()=>e.abort(),this.timeoutMillis),e.signal}}}Ke=new WeakMap,Pr=new WeakMap,yn=new WeakMap,Nn=new WeakSet,ki=async function(e,t){const n=t&LOCK_TYPE_MASK;try{const s=()=>e.call(this,n);return await A(this,yn,i(this,yn).then(s,s)),A(this,Ke,n),SQLITE_OK}catch(s){return s.name==="AbortError"?SQLITE_BUSY:(console.error(s),SQLITE_IOERR_LOCK)}},ti=new WeakSet,Eo=async function(e){if(e===i(this,Ke))return SQLITE_OK;switch(i(this,Ke)){case SQLITE_LOCK_NONE:switch(e){case SQLITE_LOCK_SHARED:return this._NONEtoSHARED();default:throw new Error(`unexpected transition ${i(this,Ke)} -> ${e}`)}case SQLITE_LOCK_SHARED:switch(e){case SQLITE_LOCK_RESERVED:return this._SHAREDtoRESERVED();case SQLITE_LOCK_EXCLUSIVE:return this._SHAREDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${i(this,Ke)} -> ${e}`)}case SQLITE_LOCK_RESERVED:switch(e){case SQLITE_LOCK_EXCLUSIVE:return this._RESERVEDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${i(this,Ke)} -> ${e}`)}default:throw new Error(`unexpected transition ${i(this,Ke)} -> ${e}`)}},ri=new WeakSet,go=async function(e){if(e===i(this,Ke))return SQLITE_OK;switch(i(this,Ke)){case SQLITE_LOCK_EXCLUSIVE:switch(e){case SQLITE_LOCK_SHARED:return this._EXCLUSIVEtoSHARED();case SQLITE_LOCK_NONE:return this._EXCLUSIVEtoNONE();default:throw new Error(`unexpected transition ${i(this,Ke)} -> ${e}`)}case SQLITE_LOCK_RESERVED:switch(e){case SQLITE_LOCK_SHARED:return this._RESERVEDtoSHARED();case SQLITE_LOCK_NONE:return this._RESERVEDtoNONE();default:throw new Error(`unexpected transition ${i(this,Ke)} -> ${e}`)}case SQLITE_LOCK_SHARED:switch(e){case SQLITE_LOCK_NONE:return this._SHAREDtoNONE();default:throw new Error(`unexpected transition ${i(this,Ke)} -> ${e}`)}default:throw new Error(`unexpected transition ${i(this,Ke)} -> ${e}`)}};class WebLocksExclusive extends WebLocksBase{constructor(e){super(),this._lockName=e+"-outer",this._reservedName=e+"-reserved"}async isSomewhereReserved(){return await this._pollWebLock(this._reservedName)==="exclusive"}async _NONEtoSHARED(){await this._acquireWebLock(this._lockName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _SHAREDtoRESERVED(){await this._acquireWebLock(this._reservedName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _RESERVEDtoSHARED(){this._releaseWebLock(this._reservedName)}async _SHAREDtoNONE(){this._releaseWebLock(this._lockName)}}const RETRYABLE_EXCEPTIONS=new Set(["TransactionInactiveError","InvalidStateError"]);let nextTxId=0;const mapTxToId=new WeakMap;function log$2(...r){}var Mr,bn,st,wn,dr,En,ni,_o,ii,Oo;class IDBContext{constructor(e,t={durability:"default"}){T(this,ni);T(this,ii);T(this,Mr,void 0);T(this,bn,void 0);T(this,st,null);T(this,wn,null);T(this,dr,null);T(this,En,Promise.resolve());A(this,Mr,Promise.resolve(e)),A(this,bn,t)}async close(){(await i(this,Mr)).close()}async run(e,t){return A(this,En,i(this,En).then(()=>te(this,ni,_o).call(this,e,t)))}async sync(){return await new Promise(e=>this.run("readwrite",e)),i(this,wn)}}Mr=new WeakMap,bn=new WeakMap,st=new WeakMap,wn=new WeakMap,dr=new WeakMap,En=new WeakMap,ni=new WeakSet,_o=async function(e,t){var a,c;const n=await i(this,Mr),s=Array.from(n.objectStoreNames);e!=="readonly"&&((a=i(this,st))==null?void 0:a.mode)==="readonly"?A(this,st,null):((c=i(this,dr))==null?void 0:c.readyState)==="pending"&&await new Promise(f=>{i(this,dr).addEventListener("success",f),i(this,dr).addEventListener("error",f)});for(let f=0;f<2;++f){i(this,st)||(A(this,st,n.transaction(s,e,i(this,bn))),A(this,wn,new Promise(h=>{i(this,st).addEventListener("complete",m=>{i(this,st)===m.target&&A(this,st,null),h(),log$2(`transaction ${mapTxToId.get(m.target)} complete`)})})),mapTxToId.set(i(this,st),nextTxId++));try{const h=Object.fromEntries(s.map(m=>{const N=i(this,st).objectStore(m),g=new Store(N,C=>te(this,ii,Oo).call(this,C));return[m,g]}));return await t(h)}catch(h){if(f||!RETRYABLE_EXCEPTIONS.has(h.name)){try{i(this,st).abort()}catch{}throw h}A(this,st,null)}}},ii=new WeakSet,Oo=function(e){return A(this,dr,e),new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)})};class Store{constructor(e,t){this.store=e,this.addRequest=t}get(e){log$2(`get ${this.store.name}`,e);const t=this.store.get(e);return this.addRequest(t)}getAll(e,t){log$2(`getAll ${this.store.name}`,e,t);const n=this.store.getAll(e,t);return this.addRequest(n)}getKey(e){log$2(`getKey ${this.store.name}`,e);const t=this.store.getKey(e);return this.addRequest(t)}getAllKeys(e,t){log$2(`getAllKeys ${this.store.name}`,e,t);const n=this.store.getAllKeys(e,t);return this.addRequest(n)}put(e,t){log$2(`put ${this.store.name}`,e,t);const n=this.store.put(e,t);return this.addRequest(n)}delete(e){log$2(`delete ${this.store.name}`,e);const t=this.store.delete(e);return this.addRequest(t)}clear(){log$2(`clear ${this.store.name}`);const e=this.store.clear();return this.addRequest(e)}index(e){return new Index(this.store.index(e),t=>this.addRequest(t))}}class Index{constructor(e,t){this.index=e,this.addRequest=t}getAllKeys(e,t){log$2(`IDBIndex.getAllKeys ${this.index.objectStore.name}<${this.index.name}>`,e,t);const n=this.index.getAllKeys(e,t);return this.addRequest(n)}}const SECTOR_SIZE=512,DEFAULT_OPTIONS={durability:"default",purge:"deferred",purgeAtLeast:16};function log$1(...r){}var Ht,Xe,xe,fr,si,To,Jt,yr,oi,vo;class IDBBatchAtomicVFS extends Base{constructor(t="wa-sqlite",n=DEFAULT_OPTIONS){super();T(this,si);T(this,Jt);T(this,oi);T(this,Ht,void 0);T(this,Xe,new Map);T(this,xe,void 0);T(this,fr,new Set);this.name=t,A(this,Ht,Object.assign({},DEFAULT_OPTIONS,n)),A(this,xe,new IDBContext(openDatabase(t),{durability:i(this,Ht).durability}))}async close(){var t;for(const n of i(this,Xe).keys())await this.xClose(n);(t=i(this,xe))==null||t.close(),A(this,xe,null)}xOpen(t,n,s,a){return this.handleAsync(async()=>{t===null&&(t=`null_${n}`),log$1(`xOpen ${t} 0x${n.toString(16)} 0x${s.toString(16)}`);try{const c=new URL(t,"http://localhost/"),f={path:c.pathname,flags:s,block0:null,locks:new WebLocksExclusive(c.pathname)};return i(this,Xe).set(n,f),await i(this,xe).run("readwrite",async({blocks:h})=>{if(f.block0=await h.get(te(this,Jt,yr).call(this,f,0)),!f.block0)if(s&SQLITE_OPEN_CREATE)f.block0={path:f.path,offset:0,version:0,data:new Uint8Array(0),fileSize:0},h.put(f.block0);else throw new Error(`file not found: ${f.path}`)}),a.setInt32(0,s&SQLITE_OPEN_READONLY,!0),SQLITE_OK}catch(c){return console.error(c),SQLITE_CANTOPEN}})}xClose(t){return this.handleAsync(async()=>{try{const n=i(this,Xe).get(t);return n&&(log$1(`xClose ${n.path}`),i(this,Xe).delete(t),n.flags&SQLITE_OPEN_DELETEONCLOSE&&i(this,xe).run("readwrite",({blocks:s})=>{s.delete(IDBKeyRange.bound([n.path],[n.path,[]]))})),SQLITE_OK}catch(n){return console.error(n),SQLITE_IOERR}})}xRead(t,n,s){return this.handleAsync(async()=>{const a=i(this,Xe).get(t);log$1(`xRead ${a.path} ${n.byteLength} ${s}`);try{return await i(this,xe).run("readonly",async({blocks:f})=>{let h=0;for(;h<n.byteLength;){const m=s+h,N=m<a.block0.data.byteLength?a.block0:await f.get(te(this,Jt,yr).call(this,a,-m));if(!N||N.data.byteLength-N.offset<=m)return n.fill(0,h),SQLITE_IOERR_SHORT_READ;const g=n.subarray(h),C=m+N.offset,k=Math.min(Math.max(N.data.byteLength-C,0),g.byteLength);g.set(N.data.subarray(C,C+k)),h+=k}return SQLITE_OK})}catch(c){return console.error(c),SQLITE_IOERR}})}xWrite(t,n,s){const a=i(this,Xe).get(t);log$1(`xWrite ${a.path} ${n.byteLength} ${s}`);try{const c=a.block0.fileSize;a.block0.fileSize=Math.max(a.block0.fileSize,s+n.byteLength);const f=s===0?a.block0:{path:a.path,offset:-s,version:a.block0.version,data:null};return f.data=n.slice(),a.changedPages?(c===a.block0.fileSize&&a.changedPages.add(-s),s!==0&&i(this,xe).run("readwrite",({blocks:h})=>h.put(f))):i(this,xe).run("readwrite",({blocks:h})=>h.put(f)),SQLITE_OK}catch(c){return console.error(c),SQLITE_IOERR}}xTruncate(t,n){const s=i(this,Xe).get(t);log$1(`xTruncate ${s.path} ${n}`);try{Object.assign(s.block0,{fileSize:n,data:s.block0.data.slice(0,n)});const a=Object.assign({},s.block0);return i(this,xe).run("readwrite",({blocks:c})=>{c.delete(te(this,Jt,yr).call(this,s,-1/0,-n)),c.put(a)}),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}}xSync(t,n){const s=i(this,Xe).get(t);log$1(`xSync ${s.path} ${n}`);try{return i(this,Ht).durability!=="relaxed"?this.handleAsync(async()=>(await i(this,xe).sync(),SQLITE_OK)):SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}}xFileSize(t,n){const s=i(this,Xe).get(t);return log$1(`xFileSize ${s.path}`),n.setBigInt64(0,BigInt(s.block0.fileSize),!0),SQLITE_OK}xLock(t,n){return this.handleAsync(async()=>{const s=i(this,Xe).get(t);log$1(`xLock ${s.path} ${n}`);try{const a=await s.locks.lock(n);return a===SQLITE_OK&&s.locks.state===SQLITE_LOCK_SHARED&&(s.block0=await i(this,xe).run("readonly",({blocks:c})=>c.get(te(this,Jt,yr).call(this,s,0)))),a}catch(a){return console.error(a),SQLITE_IOERR}})}xUnlock(t,n){return this.handleAsync(async()=>{const s=i(this,Xe).get(t);log$1(`xUnlock ${s.path} ${n}`);try{return s.locks.unlock(n)}catch(a){return console.error(a),SQLITE_IOERR}})}xCheckReservedLock(t,n){return this.handleAsync(async()=>{const s=i(this,Xe).get(t);log$1(`xCheckReservedLock ${s.path}`);const a=await s.locks.isSomewhereReserved();return n.setInt32(0,a?1:0,!0),SQLITE_OK})}xSectorSize(t){return SECTOR_SIZE}xDeviceCharacteristics(t){return SQLITE_IOCAP_BATCH_ATOMIC|SQLITE_IOCAP_SAFE_APPEND|SQLITE_IOCAP_SEQUENTIAL|SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN}xFileControl(t,n,s){const a=i(this,Xe).get(t);switch(log$1(`xFileControl ${a.path} ${n}`),n){case 11:return a.overwrite=!0,SQLITE_OK;case 21:if(a.overwrite)try{return this.handleAsync(async()=>(await te(this,oi,vo).call(this,a),SQLITE_OK))}catch(c){return console.error(c),SQLITE_IOERR}return SQLITE_OK;case 22:return a.overwrite=!1,SQLITE_OK;case 31:return this.handleAsync(async()=>{try{return a.block0.version--,a.changedPages=new Set,i(this,xe).run("readwrite",async({blocks:c})=>{const f=await c.index("version").getAllKeys(IDBKeyRange.bound([a.path],[a.path,a.block0.version]));for(const h of f)c.delete(h)}),SQLITE_OK}catch(c){return console.error(c),SQLITE_IOERR}});case 32:try{const c=Object.assign({},a.block0);c.data=c.data.slice();const f=a.changedPages;return a.changedPages=null,i(this,xe).run("readwrite",async({blocks:h})=>{h.put(c);const m=await h.get([a.path,"purge",0])??{path:a.path,offset:"purge",version:0,data:new Map,count:0};m.count+=f.size;for(const N of f)m.data.set(N,c.version);h.put(m),te(this,si,To).call(this,a.path,m.count)}),SQLITE_OK}catch(c){return console.error(c),SQLITE_IOERR}case 33:return this.handleAsync(async()=>{try{return a.changedPages=null,a.block0=await i(this,xe).run("readonly",({blocks:c})=>c.get([a.path,0,a.block0.version+1])),SQLITE_OK}catch(c){return console.error(c),SQLITE_IOERR}});default:return SQLITE_NOTFOUND}}xAccess(t,n,s){return this.handleAsync(async()=>{try{const a=new URL(t,"file://localhost/").pathname;log$1(`xAccess ${a} ${n}`);const c=await i(this,xe).run("readonly",({blocks:f})=>f.getKey(te(this,Jt,yr).call(this,{path:a},0)));return s.setInt32(0,c?1:0,!0),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}})}xDelete(t,n){return this.handleAsync(async()=>{const s=new URL(t,"file://localhost/").pathname;try{return i(this,xe).run("readwrite",({blocks:a})=>a.delete(IDBKeyRange.bound([s],[s,[]]))),n&&await i(this,xe).sync(),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}})}async purge(t){const n=Date.now();await i(this,xe).run("readwrite",async({blocks:s})=>{const a=await s.get([t,"purge",0]);if(a){for(const[c,f]of a.data)s.delete(IDBKeyRange.bound([t,c,f],[t,c,1/0],!0,!1));await s.delete([t,"purge",0])}log$1(`purge ${t} ${(a==null?void 0:a.data.size)??0} pages in ${Date.now()-n} ms`)})}}Ht=new WeakMap,Xe=new WeakMap,xe=new WeakMap,fr=new WeakMap,si=new WeakSet,To=function(t,n){i(this,Ht).purge==="manual"||i(this,fr).has(t)||n<i(this,Ht).purgeAtLeast||(globalThis.requestIdleCallback?globalThis.requestIdleCallback(()=>{this.purge(t),i(this,fr).delete(t)}):setTimeout(()=>{this.purge(t),i(this,fr).delete(t)}),i(this,fr).add(t))},Jt=new WeakSet,yr=function(t,n,s=0){const a=!n||-n<t.block0.data.length?-1/0:t.block0.version;return IDBKeyRange.bound([t.path,n,a],[t.path,s,1/0])},oi=new WeakSet,vo=async function(t){const n=t.block0.data.length;if(n<18)return;const s=new DataView(t.block0.data.buffer,t.block0.data.byteOffset);let a=s.getUint16(16);if(a===1&&(a=65536),a===n)return;const c=Math.max(n,a),f=c/n,h=c/a,N=s.getUint32(28)*a,g=t.block0.version;await i(this,xe).run("readwrite",async({blocks:C})=>{const k=await C.index("version").getAllKeys(IDBKeyRange.bound([t.path,g+1],[t.path,1/0]));for(const O of k)C.delete(O);C.delete([t.path,"purge",0]);for(let O=0;O<N;O+=c){const p=await C.getAll(IDBKeyRange.lowerBound([t.path,-(O+c),1/0]),f);for(const b of p)C.delete([b.path,b.offset,b.version]);if(h===1){const b=new Uint8Array(a);for(const _ of p)b.set(_.data,-(O+_.offset));const y={path:t.path,offset:-O,version:g,data:b};y.offset===0&&(y.fileSize=N,t.block0=y),C.put(y)}else{const b=p[0];for(let y=0;y<h;++y){const _=-(O+y*a);if(-_>=N)break;const R={path:b.path,offset:_,version:g,data:b.data.subarray(y*a,(y+1)*a)};R.offset===0&&(R.fileSize=N,t.block0=R),C.put(R)}}}})};function openDatabase(r){return new Promise((e,t)=>{const n=globalThis.indexedDB.open(r,5);n.addEventListener("upgradeneeded",function(){n.result.createObjectStore("blocks",{keyPath:["path","offset","version"]}).createIndex("version",["path","version"])}),n.addEventListener("success",()=>{e(n.result)}),n.addEventListener("error",()=>{t(n.error)})})}const E_CANCELED=new Error("request for lock canceled");var __awaiter$2=function(r,e,t,n){function s(a){return a instanceof t?a:new t(function(c){c(a)})}return new(t||(t=Promise))(function(a,c){function f(N){try{m(n.next(N))}catch(g){c(g)}}function h(N){try{m(n.throw(N))}catch(g){c(g)}}function m(N){N.done?a(N.value):s(N.value).then(f,h)}m((n=n.apply(r,e||[])).next())})};class Semaphore{constructor(e,t=E_CANCELED){this._value=e,this._cancelError=t,this._weightedQueues=[],this._weightedWaiters=[]}acquire(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((t,n)=>{this._weightedQueues[e-1]||(this._weightedQueues[e-1]=[]),this._weightedQueues[e-1].push({resolve:t,reject:n}),this._dispatch()})}runExclusive(e,t=1){return __awaiter$2(this,void 0,void 0,function*(){const[n,s]=yield this.acquire(t);try{return yield e(n)}finally{s()}})}waitForUnlock(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise(t=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),this._weightedWaiters[e-1].push(t),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatch()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatch()}cancel(){this._weightedQueues.forEach(e=>e.forEach(t=>t.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var e;for(let t=this._value;t>0;t--){const n=(e=this._weightedQueues[t-1])===null||e===void 0?void 0:e.shift();if(!n)continue;const s=this._value,a=t;this._value-=t,t=this._value+1,n.resolve([s,this._newReleaser(a)])}this._drainUnlockWaiters()}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){for(let e=this._value;e>0;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(t=>t()),this._weightedWaiters[e-1]=[])}}var __awaiter$1=function(r,e,t,n){function s(a){return a instanceof t?a:new t(function(c){c(a)})}return new(t||(t=Promise))(function(a,c){function f(N){try{m(n.next(N))}catch(g){c(g)}}function h(N){try{m(n.throw(N))}catch(g){c(g)}}function m(N){N.done?a(N.value):s(N.value).then(f,h)}m((n=n.apply(r,e||[])).next())})};class Mutex{constructor(e){this._semaphore=new Semaphore(1,e)}acquire(){return __awaiter$1(this,void 0,void 0,function*(){const[,e]=yield this._semaphore.acquire();return e})}runExclusive(e){return this._semaphore.runExclusive(()=>e())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}const isDebug=globalThis.__vlcn_wa_crsqlite_dbg;function log(...r){isDebug&&console.log("crsqlite-wasm: ",...r)}const re=/insert\s|update\s|delete\s/,txRe=/begin\s|commit\s|rollback\s|savepoint\s/;function computeCacheKey(r,e,t){const n=r.toLowerCase();if(txRe.exec(n)==null)return re.exec(n)!=null?(log("received write"),null):t!=null?n+"|"+e+"|"+t.map(a=>a!=null?a.toString():"null").join("|"):n}class Stmt{constructor(e,t,n,s,a,c,f){le(this,"originDB");le(this,"cache");le(this,"api");le(this,"base");le(this,"str");le(this,"sql");le(this,"mode","o");le(this,"finalized",!1);le(this,"bindings",[]);this.originDB=e,this.cache=n,this.api=s,this.base=a,this.str=c,this.sql=f,t.set(a,new WeakRef(this))}run(e,...t){return serialize(this.cache,computeCacheKey(this.sql,this.mode,t.length>0?t:this.bindings),()=>(t.length>0&&this.bind(t),this.api.step(this.base).then(()=>this.api.reset(this.base))),(e==null?void 0:e.__mutex)||this.originDB.__mutex)}get(e,...t){return serialize(this.cache,computeCacheKey(this.sql,this.mode,t.length>0?t:this.bindings),async()=>{t.length>0&&this.bind(t);let n=null,s=this.mode==="o"?this.api.column_names(this.base):null;if(await this.api.step(this.base)==SQLITE_ROW){const a=this.api.row(this.base);if(s!=null){const c={};for(let f=0;f<s.length;++f)c[s[f]]=a[f];n=c}else n=a}return await this.api.reset(this.base),n},(e==null?void 0:e.__mutex)||this.originDB.__mutex)}all(e,...t){return serialize(this.cache,computeCacheKey(this.sql,this.mode,t.length>0?t:this.bindings),async()=>{t.length>0&&this.bind(t);const n=[];let s=this.mode==="o"?this.api.column_names(this.base):null;for(;await this.api.step(this.base)==SQLITE_ROW;)if(s!=null){const a={};for(let c=0;c<s.length;++c)a[s[c]]=this.api.column(this.base,c);n.push(a)}else{n.push(this.api.row(this.base));continue}return await this.api.reset(this.base),n},(e==null?void 0:e.__mutex)||this.originDB.__mutex)}async*iterate(e,...t){for(this.bind(t);await serialize(this.cache,void 0,()=>this.api.step(this.base),(e==null?void 0:e.__mutex)||this.originDB.__mutex)==SQLITE_ROW;)yield this.api.row(this.base);await serialize(this.cache,void 0,()=>this.api.reset(this.base),(e==null?void 0:e.__mutex)||this.originDB.__mutex)}raw(e){return e?this.mode="a":this.mode="o",this}bind(e){this.bindings=e;for(let t=0;t<e.length;++t)this.api.bind(this.base,t+1,e[t]);return this}finalize(e){return serialize(this.cache,void 0,()=>{if(!this.finalized)return this.finalized=!0,this.api.str_finish(this.str),this.api.finalize(this.base)},(e==null?void 0:e.__mutex)||this.originDB.__mutex)}}class TX{constructor(e,t,n,s,a){le(this,"api");le(this,"db");le(this,"__mutex");le(this,"assertOpen");le(this,"stmtFinalizer");le(this,"cache",new Map);this.api=e,this.db=t,this.__mutex=n,this.assertOpen=s,this.stmtFinalizer=a}execMany(e){return this.assertOpen(),serialize(this.cache,null,()=>this.api.exec(this.db,e.join("")),this.__mutex)}exec(e,t){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"a",t),()=>this.statements(e,!1,t),this.__mutex)}execO(e,t){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"o",t),()=>this.statements(e,!0,t),this.__mutex)}execA(e,t){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"a",t),()=>this.statements(e,!1,t),this.__mutex)}prepare(e){return this.assertOpen(),serialize(this.cache,void 0,async()=>{const t=this.api.str_new(this.db,e),n=await this.api.prepare_v2(this.db,this.api.str_value(t));if(n==null)throw this.api.str_finish(t),new Error(`Could not prepare ${e}`);return new Stmt(this,this.stmtFinalizer,this.cache,this.api,n.stmt,t,e)},this.__mutex)}tx(e){return this.assertOpen(),serializeTx(async t=>{await t.exec("SAVEPOINT crsql_transaction");try{await e(t)}catch(n){throw await t.exec("ROLLBACK"),n}await t.exec("RELEASE crsql_transaction")},this.__mutex,this)}imperativeTx(){return this.__mutex.acquire().then(e=>{const t=new Mutex;return[e,new TX(this.api,this.db,t,this.assertOpen,this.stmtFinalizer)]})}async statements(e,t,n){const s=[],a=this.api.str_new(this.db,e);let c={stmt:null,sql:this.api.str_value(a)};try{for(;c=await this.api.prepare_v2(this.db,c.sql);){const m=c.stmt,N=[],g=this.api.column_names(m);for(n&&this.bind(m,n);await this.api.step(m)===SQLITE_ROW;){const C=this.api.row(m);N.push(C)}g.length&&s.push({columns:g,rows:N}),this.api.finalize(c.stmt),c.stmt=null}}finally{c!=null&&c.stmt&&this.api.finalize(c.stmt),this.api.str_finish(a)}const f=s[0];if(f==null)return null;if(!t)return f.rows;const h=[];for(const m of f.rows){const N={};for(let g=0;g<f.columns.length;++g)N[f.columns[g]]=m[g];h.push(N)}return h}bind(e,t){for(let n=0;n<t.length;++n){const s=t[n];this.api.bind(e,n+1,typeof s=="boolean"?s&&1||0:s)}}}const topLevelMutex=new Mutex;topLevelMutex.name="topLevelMutex";function serialize(r,e,t,n){if(e===null)log("Cache clear"),r==null||r.clear();else if(e!==void 0){const a=r==null?void 0:r.get(e);if(a)return log("Cache hit",e),a}log("Enqueueing query ",e);const s=n.runExclusive(t);return e&&(r==null||r.set(e,s),s.finally(()=>r==null?void 0:r.delete(e)).catch(a=>{console.error(a)})),s}function serializeTx(r,e,t){return e.runExclusive(()=>{const n=new Mutex,s=new TX(t.api,t.db,n,t.assertOpen,t.stmtFinalizer);return r(s)})}function cryb64(r,e=0){let t=3735928559^e,n=1103547991^e;for(let s=0,a;s<r.length;s++)a=r.charCodeAt(s),t=Math.imul(t^a,2654435761),n=Math.imul(n^a,1597334677);return t=Math.imul(t^t>>>16,2246822507),t^=Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(t^t>>>13,3266489909),4294967296n*BigInt(n)+BigInt(t)}function firstPick(r){const e=r[0];if(e!=null)return e[Object.keys(e)[0]]}var Ur,Lt,gn,gt,_n,ai;class DB{constructor(e,t,n){le(this,"api");le(this,"db");le(this,"filename");le(this,"__mutex",topLevelMutex);le(this,"stmtFinalizer",new Map);T(this,Ur,null);le(this,"cache",new Map);T(this,Lt,null);T(this,gn,!1);T(this,gt,void 0);T(this,_n,()=>{if(i(this,gn))throw new Error("The DB is closed")});T(this,ai,(e,t,n,s)=>{i(this,Lt)!=null&&i(this,Lt).forEach(a=>{try{a(e,t,n,s)}catch(c){console.error("Failed notifying a DB update listener"),console.error(c)}})});this.api=e,this.db=t,this.filename=n,A(this,gt,new TX(e,t,topLevelMutex,i(this,_n),this.stmtFinalizer))}get siteid(){return i(this,Ur)}_setSiteid(e){if(i(this,Ur))throw new Error("Site id already set");A(this,Ur,e)}async automigrateTo(e,t){const n=cryb64(t),s=firstPick(await this.execA("SELECT value FROM crsql_master WHERE key = 'schema_name'")),a=firstPick(await this.execA("SELECT value FROM crsql_master WHERE key = 'schema_version'"));if(s===e&&BigInt(a||0)===n)return"noop";const c=s===void 0||s!==e?"apply":"migrate";return await this.tx(async f=>{if(a==null||s!==e){if(s!==e){const h=await f.execA("SELECT name FROM sqlite_master WHERE type = 'table' AND name NOT LIKE '%crsql_%'");for(const m of h)await f.exec(`DROP TABLE [${m[0]}]`)}await f.exec(t)}else await f.exec("SELECT crsql_automigrate(?, 'SELECT crsql_finalize();')",[t]);await f.exec("INSERT OR REPLACE INTO crsql_master (key, value) VALUES (?, ?)",["schema_version",n]),await f.exec("INSERT OR REPLACE INTO crsql_master (key, value) VALUES (?, ?)",["schema_name",e])}),await this.exec("VACUUM;"),c}execMany(e){return i(this,gt).execMany(e)}exec(e,t){return i(this,gt).exec(e,t)}execO(e,t){return i(this,gt).execO(e,t)}execA(e,t){return i(this,gt).execA(e,t)}prepare(e){return i(this,gt).prepare(e)}tx(e){return i(this,gt).tx(e)}imperativeTx(){return i(this,gt).imperativeTx()}async close(){for(const e of this.stmtFinalizer.values()){const t=e.deref();t&&await t.finalize(this)}return this.exec("SELECT crsql_finalize()").then(()=>(A(this,gn,!0),serialize(this.cache,void 0,()=>this.api.close(this.db),this.__mutex)))}createFunction(e,t,n){i(this,_n).call(this),this.api.create_function(this.db,e,t.length,SQLITE_UTF8,0,(s,a)=>{const c=[];for(let h=0;h<t.length;++h)c.push(this.api.value(a[h]));const f=t(...c);f!==void 0&&this.api.result(s,f)})}onUpdate(e){return i(this,Lt)==null&&(this.api.update_hook(this.db,i(this,ai)),A(this,Lt,new Set)),i(this,Lt).add(e),()=>{var t;return(t=i(this,Lt))==null?void 0:t.delete(e)}}}Ur=new WeakMap,Lt=new WeakMap,gn=new WeakMap,gt=new WeakMap,_n=new WeakMap,ai=new WeakMap;let api=null;class SQLite3{constructor(e){le(this,"base");this.base=e}open(e,t="c"){return serialize(null,void 0,()=>this.base.open_v2(e||":memory:",SQLITE_OPEN_CREATE|SQLITE_OPEN_READWRITE|SQLITE_OPEN_URI,e!=null?"idb-batch-atomic":void 0),topLevelMutex).then(n=>{const s=new DB(this.base,n,e||":memory:");return s.execA("select quote(crsql_siteid());").then(a=>(s._setSiteid(a[0][0].replace(/'|X/g,"")),s))})}}async function initWasm(r){if(api!=null)return api;const e=await SQLiteAsyncESMFactory({locateFile(n){return r?r(n):new URL(""+new URL("../assets/crsqlite.0980e00c.wasm",import.meta.url).href,self.location).href}}),t=Factory(e);return t.vfs_register(new IDBBatchAtomicVFS("idb-batch-atomic",{durability:"relaxed"})),api=new SQLite3(t),api}async function load(r,e){return{database:await(await initWasm(()=>e.wasm||wasmUrl)).open(r),browser:!0}}const connections$1=new Map,defaultPaths={};async function init(r,e,t=defaultPaths){if(connections$1.has(r))return connections$1.get(r);const{database:n,browser:s}=await load(r,t),a=s?CRDialect:SqliteDialect,c=new Kysely({dialect:new a({database:n}),plugins:[new JSONPlugin]}),f=c.destroy.bind(c);await c.transaction().execute(m=>apply(m,e));const h=Object.assign(c,{resolveChanges,applyOperation,insertChanges,updateVersion,selectVersion,selectClient,changesSince,async destroy(){return connections$1.delete(r),await finalize.bind(c)().execute(),f()}});return connections$1.set(r,h),h}const raf=globalThis.requestAnimationFrame||globalThis.setTimeout,error=Symbol("error");function queue(r,e){const t=new Map;let n;async function s(){return n||(n=new Promise(a=>raf(async()=>{const c=await r,f=new Map;await c.transaction().execute(async h=>{const m=e&&(await selectVersion.bind(h)().execute()).current;for(const[N,g]of t.entries()){const C=await g(h).catch(k=>({[error]:k}));f.set(N,C)}e==null||e(await changesSince.bind(h)(m).execute())}),t.clear(),n=void 0,a(f)})))}return{enqueue(a,c,...f){return t.set(a,h=>c(h,...f)),s().then(h=>h.get(a)).then(h=>{if(h&&typeof h=="object"&&error in h)throw h[error];return h})}}}const empty=[],ready=r=>r!==empty;function database(r,{ssr:e=!1,name:t="crstore.db",paths:n=defaultPaths,error:s=void 0,push:a=void 0,pull:c=void 0,online:f=()=>{var h;return!!((h=globalThis.navigator)!=null&&h.onLine)}}={}){var H;const m=!e&&!1?new Promise(()=>{}):init(t,r,n),N="BroadcastChannel"in globalThis?new globalThis.BroadcastChannel(`${t}-sync`):null,g=z=>W(z.data,z.data[0]),C=queue(m,W),k=queue(m);N==null||N.addEventListener("message",g),(H=globalThis.addEventListener)==null||H.call(globalThis,"online",R);const O=new Map;let p=()=>{};R();async function b(z,Q){return k.enqueue(Q,L=>L.getExecutor().executeQuery(z,Q)).then(L=>L.rows)}function y(z,Q,L){const X=async(Z,oe)=>{try{if(L&&L.client===oe)return;await Q(Z,oe)}catch(he){s==null||s(he)}};return z.forEach(Z=>{var oe;O.has(Z)||O.set(Z,new Set),(oe=O.get(Z))==null||oe.add(X)}),L?m.then(async Z=>{const oe=await Z.changesSince(L.version,L.client).execute();oe.length&&X(oe)}):X([]),()=>z.forEach(Z=>{var oe;return(oe=O.get(Z))==null?void 0:oe.delete(X)})}async function _(){if(!a||!f())return;const z=await m,{current:Q,synced:L}=await z.selectVersion().execute();if(Q<=L)return;const X=await z.changesSince(L,null).execute();await a(X),await z.updateVersion(Q).execute()}async function R(){var X,Z;if((X=globalThis.removeEventListener)==null||X.call(globalThis,"offline",p),p(),!c||!f())return;const z=await m,{synced:Q}=await z.selectVersion().execute(),L=await z.selectClient().execute();await _(),p=c({version:Q,client:L},{async onData(oe){oe.length&&(await z.insertChanges(oe).execute(),await W(oe,oe[0]))}}).unsubscribe,(Z=globalThis.addEventListener)==null||Z.call(globalThis,"offline",p)}async function U(z,...Q){return C.enqueue({},z,...Q)}async function $(z){if(!z.length)return;const Q=await m;await W(await Q.resolveChanges(z).execute(),z[0])}async function W(z,Q){var oe;if(!z.length)return;const L=new Set,X=affectedTables(z);(oe=O.get("*"))==null||oe.forEach(he=>L.add(he)),X.forEach(he=>{var M;return(M=O.get(he))==null?void 0:M.forEach(ie=>L.add(ie))});const Z=[...L].map(he=>he(z,Q));Q||(N==null||N.postMessage(z),await _()),await Promise.all(Z)}async function J(){var z,Q;p(),N==null||N.close(),O.clear(),(z=globalThis.removeEventListener)==null||z.call(globalThis,"online",R),(Q=globalThis.removeEventListener)==null||Q.call(globalThis,"offline",p),N==null||N.removeEventListener("message",g),await m.then(L=>L.destroy())}const ce=Object.assign(store.bind({connection:m,subscribe:y,update:U,refresh:b},[]),{with:(...z)=>store.bind({connection:m,subscribe:y,update:U,refresh:b},z)});return{close:J,merge:$,update:U,subscribe:y,connection:m,store:ce}}function store(r,e,t={}){const{connection:n,update:s,refresh:a}=this,c=derived(r,k=>k);let f=null,h=null;const{subscribe:m,set:N}=writable(empty,()=>{let k=()=>{};return n.then(O=>{if(!k)return;let p=()=>{};const b=c.subscribe(y=>{const _=e(O,...y).toOperationNode(),R=affectedTables(_),U=O.getExecutor();h={queryId:Math.random().toString(36).slice(2)},f=U.compileQuery(U.transformQuery(_,h),h),p(),p=this.subscribe(R,g)});k=()=>(b(),p())}),()=>(k==null||k(),k=null)});async function g(){await n,!(!f||!h)&&N(await a(f,h))}const C={};for(const k in t)C[k]=(...O)=>s(t[k],...O);return{...C,set:N,subscribe:m,update(k,...O){return k?s(k,...O):g()},then(k,O){let p=[];const b=m(y=>p=y);return g().then(()=>(b(),k(p)),O)}}}const APPEND=1,source=r=>r.selectFrom(e=>e.selectFrom("sources").select(["owner","source"]).orderBy("sources.primary","desc").as("ordered")).select(["owner",e=>group(e,"source").as("sources")]).groupBy("owner").$castTo(),asset=r=>r.selectFrom(e=>e.selectFrom("assets").select(["owner","art","thumbnail"]).orderBy("assets.primary","desc").as("ordered")).select(["owner",e=>group(e,"art").as("arts"),e=>group(e,"thumbnail").as("thumbnails")]).groupBy("owner").$castTo(),artist$1=r=>r.selectFrom("artists").leftJoin("source","source.owner","artists.id").leftJoin("asset","asset.owner","artists.id").select(["artists.id","artists.title","artists.following",e=>e.fn.coalesce("asset.arts",e.val("[]")).as("arts"),e=>e.fn.coalesce("asset.thumbnails",e.val("[]")).as("thumbnails"),e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources")]).$castTo(),album$1=r=>r.selectFrom("albums").leftJoin("source","source.owner","albums.id").leftJoin("asset","asset.owner","albums.id").leftJoin("attribution","attribution.album","albums.id").innerJoin("artist","artist.id","attribution.artist").select(["albums.id","albums.title","albums.year",e=>e.fn.coalesce("asset.arts",e.val("[]")).as("arts"),e=>e.fn.coalesce("asset.thumbnails",e.val("[]")).as("thumbnails"),e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources"),e=>groupJSON(e,{id:"artist.id",title:"artist.title",arts:"artist.arts",thumbnails:"artist.thumbnails",sources:"artist.sources"}).filterWhere("artist.id","is not",null).as("artists")]).groupBy("albums.id").$castTo(),track$2=r=>r.selectFrom("tracks").leftJoin("source","source.owner","tracks.id").innerJoin("album","album.id","tracks.album").select(["tracks.id","tracks.title","tracks.duration","album.artists",e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources"),e=>json(e,{id:"album.id",title:"album.title",year:"album.year",arts:"album.arts",thumbnails:"album.thumbnails",sources:"album.sources"}).as("album")]).$castTo(),localDevice=sql`crsql_siteid()`,uuid=()=>Math.random()*2**32>>>0,sanitize=r=>r.replace(/-/g," ").split(/\s+/g).map(e=>`"${e.replace(/"/g,'""')}"`).join(" "),position={first:null,before:r=>r.selectFrom("queue").select("id").where("position","=",1).limit(1),shift:r=>e=>e.selectFrom("queue").select("id").whereRef(t=>t.selectFrom("queue").select(sql`position + 1`.as("position")).where("id","=",r),"=","position").limit(1),next:r=>r.selectFrom("devices").select("playback").where("id","=",localDevice).limit(1),last:r=>r.selectFrom("playback").select("id").where("device","=",localDevice).orderBy("order","desc").orderBy("id","desc").limit(1),random:r=>e=>e.selectFrom(t=>t.selectFrom("queue").select(["id","position"]).$if(!!r.length,n=>n.unionAll(sql`VALUES ${sql.raw(r.map(s=>`(${s}, 1)`).join(","))}`)).unionAll(sql`SELECT null,1 WHERE NOT EXISTS (SELECT 1 FROM queue WHERE position >= 0)`).as("data")).select("id").where("position",">=",0).orderBy(sql`random()`).limit(1)};async function pushTracks(r,e){e.length&&(await pushAlbums(r,e.map(t=>({...t.album,artists:t.artists}))),await r.insertInto("tracks").onConflict(t=>t.doNothing()).values(e.map(t=>({id:t.id,title:t.title,duration:t.duration,album:t.album.id}))).execute(),await pushResources(r,e))}async function pushAlbums(r,e){e.length&&(await pushArtists(r,e.flatMap(t=>t.artists)),e.find(t=>t.artists.length)&&await r.insertInto("attribution").onConflict(t=>t.doNothing()).values(e.flatMap(t=>t.artists.map(({id:n})=>({album:t.id,artist:n})))).execute(),await r.insertInto("albums").onConflict(t=>t.doNothing()).values(e.map(t=>({id:t.id,title:t.title,year:t.year}))).execute(),await pushResources(r,e))}async function pushArtists(r,e){e.length&&(await r.insertInto("artists").onConflict(t=>t.doNothing()).values(e.map(t=>({id:t.id,title:t.title,following:0}))).execute(),await pushResources(r,e))}async function pushResources(r,e){e.length&&(e.find(t=>t.sources.length)&&await r.insertInto("sources").onConflict(t=>t.doNothing()).values(e.flatMap(({id:t,sources:n})=>n.map((s,a)=>({owner:t,source:s,primary:+!a&&sql`NOT EXISTS (SELECT 1 FROM sources WHERE owner = ${t} AND "primary" = 1)`})))).execute(),e.find(t=>{var n;return(n=t.arts)==null?void 0:n.length})&&await r.insertInto("assets").onConflict(t=>t.doNothing()).values(e.flatMap(({id:t,arts:n,thumbnails:s})=>{if(!n)return[];const a=n.find((c,f)=>!!(s!=null&&s[f]))||n[0];return n.map((c,f)=>({owner:t,art:c,thumbnail:s==null?void 0:s[f],primary:+(c===a)&&sql`NOT EXISTS (SELECT 1 FROM assets WHERE owner = ${t} AND "primary" = 1)`}))})).execute())}const preceding$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).with("update",t=>t.selectFrom("playback").select(n=>n.selectFrom("devices").select("id").as("_"))).selectFrom("queue").innerJoin("track","track.id","queue.track").where("position","<",0).select("queue.id as entry").select(fields).$castTo()),upcoming$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).with("update",t=>t.selectFrom("playback").select(n=>n.selectFrom("devices").select("id").as("_"))).selectFrom("queue").innerJoin("track","track.id","queue.track").where("position",">",0).select("queue.id as entry").select(fields).$castTo()),playback$2=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("devices").innerJoin("playback","playback.id","devices.playback").innerJoin("track","track.id","playback.track").select(["direction","repeat","infinite","device","progress"]).select(t=>json(t,{entry:"playback.id",id:"track.id",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).as("track")).select(sql`device = crsql_siteid()`.as("local")).select(fields).$castTo(),{async push(e,t,n="next"){if(!t.length)return;await pushTracks(e,t);const{direction:s,playback:a}=await e.selectFrom("devices").where("id","=",localDevice).select(["direction","playback"]).executeTakeFirstOrThrow(),c=t.map(uuid),f=s!=1?Number.isInteger(n)?n:n==="first"?position.first:n==="next"?position.next:position.last:Number.isInteger(n)?position.shift(+n):n==="first"?position.last:n==="next"?position.before:position.first;await e.insertInto("playback_fractindex").values(t.map((h,m)=>({id:c[m],track:h.id,device:localDevice,after_id:n==="random"?position.random(c.slice(0,m)):m>0&&s!=1?c[m-1]:f}))).execute(),!~a&&n==="random"&&await e.updateTable("devices").set({playback:h=>h.selectFrom("queue").select("id").$castTo().limit(1)}).execute()},async purge(e,t){t.length&&await e.deleteFrom("playback").where("id","in",t).execute()},async clear(e,t=localDevice){await e.deleteFrom("playback").where("device","=",t).execute(),await e.updateTable("devices").set({playback:-1,progress:0}).where("id","=",t).execute()},async sync(e,t){await e.updateTable("devices").where("id","=",localDevice).set({progress:t}).execute()},async rearrange(e,t,n=null){const{direction:s}=await e.selectFrom("devices").where("id","=",localDevice).select(["direction"]).executeTakeFirstOrThrow(),a=s!=1?n:n!=null?position.shift(n):position.last;await e.updateTable("playback_fractindex").set({after_id:a}).where("id","=",t).execute()},async redirect(e,t){const n=["forward","backward","shuffled"],{direction:s}=await e.selectFrom("devices").select("direction").where("id","=",localDevice).executeTakeFirstOrThrow(),a=n.indexOf(t);s!==a&&await e.updateTable("devices").set({direction:a}).where("id","=",localDevice).execute()},async repeat(e,t){const n=["none","single","all"];await e.updateTable("devices").set({repeat:n.indexOf(t)}).where("id","=",localDevice).execute()},async infinite(e,t){await e.updateTable("devices").set({infinite:t==null?sql`!infinite`:+t}).where("id","=",localDevice).execute()},async replicate(e,t){const n=uuid();await e.updateTable("devices").where("id","=",localDevice).set({playback:n,progress:s=>s.selectFrom("devices").where("id","=",t).select("progress")}).execute(),await e.deleteFrom("playback").where("device","=",localDevice).execute(),await e.insertInto("playback").expression(s=>s.selectFrom("playback").select(a=>a.case().when(c=>c.selectFrom("devices").whereRef("id","=","playback.device").select("devices.playback"),"=",a.ref("playback.id")).then(n).else(sql`ABS(RANDOM() % 4294967296)`).end().as("id")).select(sql`${localDevice}`.as("device")).select(["track","order","temp"]).where("device","=",t)).execute()}}),fields=["track.id","track.title","track.duration","track.album","track.artists","track.sources"];class StructError extends TypeError{constructor(e,t){let n;const{message:s,explanation:a,...c}=e,{path:f}=e,h=f.length===0?s:`At path: ${f.join(".")} -- ${s}`;super(a??h),a!=null&&(this.cause=h),Object.assign(this,c),this.name=this.constructor.name,this.failures=()=>n??(n=[e,...t()])}}function isIterable(r){return isObject$1(r)&&typeof r[Symbol.iterator]=="function"}function isObject$1(r){return typeof r=="object"&&r!=null}function print(r){return typeof r=="symbol"?r.toString():typeof r=="string"?JSON.stringify(r):`${r}`}function shiftIterator(r){const{done:e,value:t}=r.next();return e?void 0:t}function toFailure(r,e,t,n){if(r===!0)return;r===!1?r={}:typeof r=="string"&&(r={message:r});const{path:s,branch:a}=e,{type:c}=t,{refinement:f,message:h=`Expected a value of type \`${c}\`${f?` with refinement \`${f}\``:""}, but received: \`${print(n)}\``}=r;return{value:n,type:c,refinement:f,key:s[s.length-1],path:s,branch:a,...r,message:h}}function*toFailures(r,e,t,n){isIterable(r)||(r=[r]);for(const s of r){const a=toFailure(s,e,t,n);a&&(yield a)}}function*run(r,e,t={}){const{path:n=[],branch:s=[r],coerce:a=!1,mask:c=!1}=t,f={path:n,branch:s};if(a&&(r=e.coercer(r,f),c&&e.type!=="type"&&isObject$1(e.schema)&&isObject$1(r)&&!Array.isArray(r)))for(const m in r)e.schema[m]===void 0&&delete r[m];let h="valid";for(const m of e.validator(r,f))m.explanation=t.message,h="not_valid",yield[m,void 0];for(let[m,N,g]of e.entries(r,f)){const C=run(N,g,{path:m===void 0?n:[...n,m],branch:m===void 0?s:[...s,N],coerce:a,mask:c,message:t.message});for(const k of C)k[0]?(h=k[0].refinement!=null?"not_refined":"not_valid",yield[k[0],void 0]):a&&(N=k[1],m===void 0?r=N:r instanceof Map?r.set(m,N):r instanceof Set?r.add(N):isObject$1(r)&&(N!==void 0||m in r)&&(r[m]=N))}if(h!=="not_valid")for(const m of e.refiner(r,f))m.explanation=t.message,h="not_refined",yield[m,void 0];h==="valid"&&(yield[void 0,r])}class Struct{constructor(e){const{type:t,schema:n,validator:s,refiner:a,coercer:c=h=>h,entries:f=function*(){}}=e;this.type=t,this.schema=n,this.entries=f,this.coercer=c,s?this.validator=(h,m)=>{const N=s(h,m);return toFailures(N,m,this,h)}:this.validator=()=>[],a?this.refiner=(h,m)=>{const N=a(h,m);return toFailures(N,m,this,h)}:this.refiner=()=>[]}assert(e,t){return assert(e,this,t)}create(e,t){return create(e,this,t)}is(e){return is(e,this)}mask(e,t){return mask(e,this,t)}validate(e,t={}){return validate(e,this,t)}}function assert(r,e,t){const n=validate(r,e,{message:t});if(n[0])throw n[0]}function create(r,e,t){const n=validate(r,e,{coerce:!0,message:t});if(n[0])throw n[0];return n[1]}function mask(r,e,t){const n=validate(r,e,{coerce:!0,mask:!0,message:t});if(n[0])throw n[0];return n[1]}function is(r,e){return!validate(r,e)[0]}function validate(r,e,t={}){const n=run(r,e,t),s=shiftIterator(n);return s[0]?[new StructError(s[0],function*(){for(const c of n)c[0]&&(yield c[0])}),void 0]:[void 0,s[1]]}function assign(...r){const e=r[0].type==="type",t=r.map(s=>s.schema),n=Object.assign({},...t);return e?type(n):object(n)}function define(r,e){return new Struct({type:r,schema:null,validator:e})}function omit(r,e){const{schema:t}=r,n={...t};for(const s of e)delete n[s];switch(r.type){case"type":return type(n);default:return object(n)}}function any(){return define("any",()=>!0)}function array(r){return new Struct({type:"array",schema:r,*entries(e){if(r&&Array.isArray(e))for(const[t,n]of e.entries())yield[t,n,r]},coercer(e){return Array.isArray(e)?e.slice():e},validator(e){return Array.isArray(e)||`Expected an array value, but received: ${print(e)}`}})}function instance$1(r){return define("instance",e=>e instanceof r||`Expected a \`${r.name}\` instance, but received: ${print(e)}`)}function integer(){return define("integer",r=>typeof r=="number"&&!isNaN(r)&&Number.isInteger(r)||`Expected an integer, but received: ${print(r)}`)}function literal(r){const e=print(r),t=typeof r;return new Struct({type:"literal",schema:t==="string"||t==="number"||t==="boolean"?r:null,validator(n){return n===r||`Expected the literal \`${e}\`, but received: ${print(n)}`}})}function never(){return define("never",()=>!1)}function nullable(r){return new Struct({...r,validator:(e,t)=>e===null||r.validator(e,t),refiner:(e,t)=>e===null||r.refiner(e,t)})}function number(){return define("number",r=>typeof r=="number"&&!isNaN(r)||`Expected a number, but received: ${print(r)}`)}function object(r){const e=r?Object.keys(r):[],t=never();return new Struct({type:"object",schema:r||null,*entries(n){if(r&&isObject$1(n)){const s=new Set(Object.keys(n));for(const a of e)s.delete(a),yield[a,n[a],r[a]];for(const a of s)yield[a,n[a],t]}},validator(n){return isObject$1(n)||`Expected an object, but received: ${print(n)}`},coercer(n){return isObject$1(n)?{...n}:n}})}function optional(r){return new Struct({...r,validator:(e,t)=>e===void 0||r.validator(e,t),refiner:(e,t)=>e===void 0||r.refiner(e,t)})}function string(){return define("string",r=>typeof r=="string"||`Expected a string, but received: ${print(r)}`)}function type(r){const e=Object.keys(r);return new Struct({type:"type",schema:r,*entries(t){if(isObject$1(t))for(const n of e)yield[n,t[n],r[n]]},validator(t){return isObject$1(t)||`Expected an object, but received: ${print(t)}`},coercer(t){return isObject$1(t)?{...t}:t}})}function union(r){const e=r.map(t=>t.type).join(" | ");return new Struct({type:"union",schema:null,coercer(t){for(const n of r){const[s,a]=n.validate(t,{coerce:!0});if(!s)return a}return t},validator(t,n){const s=[];for(const a of r){const[...c]=run(t,a,n),[f]=c;if(f[0])for(const[h]of c)h&&s.push(h);else return[]}return[`Expected the value to satisfy a union of \`${e}\`, but received: ${print(t)}`,...s]}})}const track$1=object({title:string(),duration:number()}),album=object({title:string(),year:integer()}),artist=object({title:string()}),playlist=object({title:string(),relevancy:number(),shared:nullable(string()),remote:nullable(string())});type({title:optional(string()),album:optional(type({title:optional(string())})),artists:optional(array(type({title:optional(string())})))});const media=object({sources:array(string()),arts:optional(array(string())),thumbnails:optional(array(nullable(string())))}),collection=r=>object({size:integer(),duration:number(),tracks:array(r)}),unique=r=>assign(r,object({id:integer()})),artistInfo=assign(artist,media),albumInfo=assign(album,assign(media,object({artists:array(artistInfo)}))),trackInfo=assign(track$1,assign(omit(media,["arts","thumbnails"]),object({album:omit(albumInfo,["artists"]),artists:array(artistInfo)}))),playlistInfo=playlist,track=assign(unique(trackInfo),object({entry:optional(number()),album:unique(trackInfo.schema.album),artists:array(unique(trackInfo.schema.artists.schema))}));assign(unique(albumInfo),object({artists:array(unique(albumInfo.schema.artists.schema)),collection:optional(collection(track))}));assign(unique(artistInfo),object({following:optional(union([literal(0),literal(1)])),collection:optional(collection(track))}));assign(unique(playlistInfo),object({collection:optional(collection(track))}));function has(r,e){return r!==null&&typeof r=="object"&&e in r&&r[e]!==void 0}function getDefaultExportFromCjs(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var murmurhash={exports:{}};(function(r){(function(){const e=a=>new TextEncoder().encode(a);function t(a,c){typeof a=="string"&&(a=e(a));let f=a.length,h=c^f,m=0,N;for(;f>=4;)N=a[m]&255|(a[++m]&255)<<8|(a[++m]&255)<<16|(a[++m]&255)<<24,N=(N&65535)*1540483477+(((N>>>16)*1540483477&65535)<<16),N^=N>>>24,N=(N&65535)*1540483477+(((N>>>16)*1540483477&65535)<<16),h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)^N,f-=4,++m;switch(f){case 3:h^=(a[m+2]&255)<<16;case 2:h^=(a[m+1]&255)<<8;case 1:h^=a[m]&255,h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)}return h^=h>>>13,h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16),h^=h>>>15,h>>>0}function n(a,c){typeof a=="string"&&(a=e(a));let f,h,m,N,g,C,k,O;for(f=a.length&3,h=a.length-f,m=c,g=3432918353,C=461845907,O=0;O<h;)k=a[O]&255|(a[++O]&255)<<8|(a[++O]&255)<<16|(a[++O]&255)<<24,++O,k=(k&65535)*g+(((k>>>16)*g&65535)<<16)&4294967295,k=k<<15|k>>>17,k=(k&65535)*C+(((k>>>16)*C&65535)<<16)&4294967295,m^=k,m=m<<13|m>>>19,N=(m&65535)*5+(((m>>>16)*5&65535)<<16)&4294967295,m=(N&65535)+27492+(((N>>>16)+58964&65535)<<16);switch(k=0,f){case 3:k^=(a[O+2]&255)<<16;case 2:k^=(a[O+1]&255)<<8;case 1:k^=a[O]&255,k=(k&65535)*g+(((k>>>16)*g&65535)<<16)&4294967295,k=k<<15|k>>>17,k=(k&65535)*C+(((k>>>16)*C&65535)<<16)&4294967295,m^=k}return m^=a.length,m^=m>>>16,m=(m&65535)*2246822507+(((m>>>16)*2246822507&65535)<<16)&4294967295,m^=m>>>13,m=(m&65535)*3266489909+(((m>>>16)*3266489909&65535)<<16)&4294967295,m^=m>>>16,m>>>0}const s=n;s.v2=t,s.v3=n,r.exports=s})()})(murmurhash);var murmurhashExports=murmurhash.exports;const hash=getDefaultExportFromCjs(murmurhashExports);function titled(r){return has(r,"title")?r.title:r}function compare$1(r,e){return typeof r=="string"&&typeof e=="string"?r.localeCompare(e):typeof r=="number"&&typeof e=="number"?r-e:has(r,"title")&&has(e,"title")?compare$1(clean(titled(r)),clean(titled(e))):0}function normalize(r){if(typeof r=="string")return clean(r);if(typeof r!="object")return r;const e={...r};for(const t in e)Array.isArray(e[t])?e[t]=e[t].map(normalize).sort(compare$1):e[t]=normalize(e[t]);return e}function stringify(r){return r=normalize(r),typeof r=="string"?r:typeof r!="object"?clean(String(r)):has(r,"artists")&&has(r,"title")&&has(r,"album")?`${r.artists.map(titled)} - ${r.title} - ${titled(r.album)}`:has(r,"artists")&&has(r,"title")?`${r.artists.map(titled)} - ${r.title}`:has(r,"title")?r.title:Array.isArray(r)?r.map(titled).toString():JSON.stringify(r)}function identify(r){return has(r,"id")?+r.id:hash(stringify(r))}const playlists$2=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",t=>track$2(t).innerJoin("library","library.track","tracks.id").select(["library.playlist","library.id as entry"]).orderBy("library.order").orderBy("library.id")).selectFrom("track").fullJoin("playlists","playlists.id","track.playlist").where("playlists.id",">=",0).select(["playlists.id","playlists.title","playlists.relevancy","playlists.shared","playlists.remote",t=>json(t,{size:t.fn.count("track.duration"),duration:t.fn.coalesce(t.fn.sum("track.duration"),t.val(0)),tracks:groupJSON(t,{id:"track.id",entry:"track.entry",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("playlists.id").orderBy("playlists.order").orderBy("playlists.id").$castTo(),{async create(e,t){await e.insertInto("playlists").onConflict(n=>n.doNothing()).values({id:identify(t),order:APPEND,relevancy:1,...t}).execute()},async edit(e,t,n){await e.updateTable("playlists").where("id","=",t).set(n).execute()},async rearrange(e,t,n){await e.updateTable("playlists_fractindex").set({after_id:n||null}).where("id","=",t).execute()},async delete(e,t){await e.deleteFrom("playlists").where("id","=",t).execute()},get(e,t){return e.selectFrom("playlists").selectAll().where("id","=",t).executeTakeFirstOrThrow()}}),resources$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).selectFrom("source").leftJoin("asset","asset.owner","source.owner").select([t=>t.fn.coalesce("asset.arts",t.val("[]")).as("arts"),t=>t.fn.coalesce("asset.thumbnails",t.val("[]")).as("thumbnails"),t=>t.fn.coalesce("source.sources",t.val("[]")).as("sources")]).$castTo(),{async prioritize(e,t,n){const s=t==="art"?"assets":"sources";await e.updateTable(s).set({primary:sql`${sql.ref(t)} = ${n}`}).where("owner","=",a=>a.selectFrom(s).where(t,"=",n).select("owner")).execute()},get(e,t){return e.with("source",source).with("asset",asset).selectFrom("source").leftJoin("asset","asset.owner","source.owner").select([n=>n.fn.coalesce("asset.arts",n.val("[]")).as("arts"),n=>n.fn.coalesce("asset.thumbnails",n.val("[]")).as("thumbnails"),n=>n.fn.coalesce("source.sources",n.val("[]")).as("sources")]).where("source.owner","=",t).$castTo().executeTakeFirstOrThrow()}}),settings$2=({store:r})=>r(e=>e.selectFrom("settings").select(["key",sql`json_extract(value, '$')`.as("value")]),{async store(e,t,n,s="settings"){s!=="settings"&&(await e.schema.createTable(s).ifNotExists().addColumn("key","text",a=>a.primaryKey()).addColumn("value","text").execute(),await e.schema.createIndex(s+"_value").ifNotExists().on(s).column("value").execute()),await e.insertInto(s).onConflict(a=>a.doUpdateSet({value:JSON.stringify(n)})).values({key:t,value:JSON.stringify(n)}).execute()},async extract(e,t,n="settings"){return e.selectFrom(n).select("value").where("key","=",t).executeTakeFirstOrThrow().then(s=>JSON.parse(s.value))},async lookup(e,t,n="settings"){return e.selectFrom(n).select("key").where("value","=",JSON.stringify(t)).executeTakeFirstOrThrow().then(s=>s.key)}}),history$2=({store:r})=>r(e=>e.selectFrom("history").orderBy("date","desc").selectAll(),{async log(e,t){t.trim()&&await e.insertInto("history").onConflict(n=>n.doUpdateSet({date:Date.now()})).values({query:t,date:Date.now()}).execute()},async clear(e){await e.deleteFrom("history").execute()},get(e){return e.selectFrom("history").selectAll().orderBy("date","desc").execute()}}),artists$2=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("artist").leftJoin("attribution","attribution.artist","artist.id").leftJoin("albums","albums.id","attribution.album").leftJoin("tracks","tracks.album","albums.id").leftJoin("track","track.id","tracks.id").select(["artist.id","artist.title","artist.following","artist.arts","artist.thumbnails","artist.sources",t=>json(t,{size:t.fn.count("track.duration"),duration:t.fn.coalesce(t.fn.sum("track.duration"),t.val(0)),tracks:groupJSON(t,{id:"track.id",entry:"track.id",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("artist.id").orderBy(t=>t.fn.count("track.duration"),"desc").orderBy("artist.title").$castTo(),{async push(e,t){await pushArtists(e,t)},async edit(e,t,n){await e.updateTable("artists").where("id","=",t).set(n)},async follow(e,t){await e.updateTable("artists").set({following:1}).where("id","=",t).execute()},async unfollow(e,t){await e.updateTable("artists").set({following:0}).where("id","=",t).execute()},async search(e,t,n=10,s=0){return t?e.with("source",source).with("asset",asset).with("artist",artist$1).selectFrom("artists_fts").where("artists_fts","match",sanitize(t)).orderBy("rank").innerJoin("artist","artist.id","artists_fts.rowid").selectAll().limit(n).offset(s).$castTo().execute():[]},get(e,t){return e.with("source",source).with("asset",asset).with("artist",artist$1).selectFrom("artist").where("artist.id","=",t).selectAll().$castTo().executeTakeFirstOrThrow()}}),library$2=({store:r})=>r(e=>e.selectFrom("library").selectAll(),{async push(e,t,n){t.length&&(await pushTracks(e,t),n!=null&&await e.insertInto("library").onConflict(s=>s.doNothing()).values(t.map(({id:s})=>({id:uuid(),order:APPEND,date:~~(Date.now()/1e3),track:s,playlist:n}))).execute())},async rearrange(e,t,n){await e.updateTable("library_fractindex").set({after_id:n||null}).where("id","=",t).execute()},async purge(e,t){const n=t.map(s=>e.deleteFrom("library").where("id","=",s).execute());await Promise.all(n)},async get(e,t){return t.length?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources","library.id as entry"]).where("library.id","in",t).$castTo().execute():[]},async sample(e,t){const n=t,s=n*Math.sqrt(2*Math.PI)/2,a=sql`POW(ABS(RANDOM()) / 9223372036854775808,
        ${s} /
        EXP(-0.5 * POW(row_number() OVER (ORDER BY date DESC) / ${n},2)) *
        playlists.relevancy
      )`;return await e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").innerJoin("playlists","playlists.id","library.playlist").innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources"]).where("relevancy",">",0).orderBy(a,"desc").limit(t).execute()},async banned(e){return await e.selectFrom("library").leftJoin("playlists","playlists.id","library.playlist").select("library.track").where("relevancy","<",0).execute().then(t=>t.map(n=>n.track))}}),id=integer,boolean=integer,tracks$2=assign(unique(track$1),object({album:id()}));crr(tracks$2);index(tracks$2,"album");primary(tracks$2,"id");const albums$2=unique(album);crr(albums$2);primary(albums$2,"id");const artists$1=assign(unique(artist),object({following:boolean()}));crr(artists$1);primary(artists$1,"id");const attribution=object({album:id(),artist:id()});crr(attribution);index(attribution,"artist");primary(attribution,"album","artist");const sources=object({source:string(),owner:id(),primary:boolean()});crr(sources);primary(sources,"owner","source");const assets=object({art:string(),thumbnail:nullable(string()),owner:id(),primary:boolean()});crr(assets);primary(assets,"owner","art");const playlists$1=assign(unique(playlist),object({order:string()}));crr(playlists$1);primary(playlists$1,"id");ordered(playlists$1,"order");index(playlists$1,"order","id");const library$1=object({id:id(),playlist:id(),track:id(),date:integer(),order:string()});crr(library$1);primary(library$1,"id");index(library$1,"date");index(library$1,"track");index(library$1,"playlist");index(library$1,"order","id");ordered(library$1,"order","playlist");const playback$1=object({id:id(),device:instance$1(Uint8Array),track:id(),order:string(),temp:any()});crr(playback$1);primary(playback$1,"id");index(playback$1,"device");index(playback$1,"order","id");ordered(playback$1,"order","device");const devices=object({id:instance$1(Uint8Array),playback:id(),direction:integer(),infinite:integer(),progress:number(),repeat:integer()});crr(devices);primary(devices,"id");const settings$1=object({key:string(),value:string()});crr(settings$1);index(settings$1,"value");primary(settings$1,"key");const history$1=object({query:string(),date:integer()});crr(history$1);index(history$1,"date");primary(history$1,"query");const schema=object({tracks:tracks$2,albums:albums$2,attribution,artists:artists$1,sources,assets,library:library$1,playlists:playlists$1,playback:playback$1,devices,settings:settings$1,history:history$1}),tracks$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").where("playlist",">=",0).innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources","library.id as entry","library.date"]).orderBy("library.date","desc").orderBy("library.id").$castTo(),{async edit(e,t,n){const s=await e.updateTable("tracks").where("id","=",t).set({...n,album:void 0}).returning("album").executeTakeFirst();s!=null&&s.album&&n.album&&await e.updateTable("albums").where("id","=",s.album).set(n.album).execute()},async search(e,t,n=10,s=0){return t?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("tracks_fts").where("tracks_fts","match",sanitize(t)).orderBy("rank").innerJoin("track","track.id","rowid").selectAll().limit(n).offset(s).$castTo().execute():[]},get(e,t){return e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("track").selectAll().where("id","=",t).$castTo().executeTakeFirstOrThrow()}}),albums$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("album").selectAll().orderBy("album.title"),{async push(e,t){await pushAlbums(e,t)},async search(e,t,n=10,s=0){return t?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("albums_fts").where("albums_fts","match",sanitize(t)).orderBy("rank").innerJoin("album","album.id","albums_fts.rowid").selectAll().limit(n).offset(s).$castTo().execute():[]},get(e,t){return e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("album").selectAll().where("album.id","=",t).$castTo().executeTakeFirstOrThrow()}}),feed$1=({store:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",t=>track$2(t).innerJoin("library","library.track","tracks.id").select(["library.playlist","library.id as entry"]).orderBy("library.order").orderBy("library.id")).selectFrom("track").fullJoin("playlists","playlists.id","track.playlist").where("playlists.id","<",0).select(["playlists.id","playlists.title","playlists.relevancy","playlists.shared","playlists.remote",t=>json(t,{size:t.fn.count("track.duration"),duration:t.fn.coalesce(t.fn.sum("track.duration"),t.val(0)),tracks:groupJSON(t,{id:"track.id",entry:"track.entry",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("playlists.id").orderBy("playlists.order").orderBy("playlists.id").$castTo(),{async clear(e,t){await e.deleteFrom("library").where("playlist","=",t).execute()},async get(e,t,n=-1){return e.selectFrom("library").where("playlist","=",t).select("id").limit(n).execute().then(s=>s.map(a=>a.id))}}),connections=new Map,stores=r=>({playlists:playlists$2(r),resources:resources$1(r),preceding:preceding$1(r),playback:playback$2(r),upcoming:upcoming$1(r),settings:settings$2(r),history:history$2(r),artists:artists$2(r),library:library$2(r),albums:albums$1(r),tracks:tracks$1(r),feed:feed$1(r)});function connect(r){if(!connections.has(r.name)){const e=database(r.local?nocrr(schema):schema,r);connections.set(r.name,{...e,...stores(e)});const t=Object.assign({"../sql/cascade.sql":__vite_glob_0_0,"../sql/fts.sql":__vite_glob_0_1,"../sql/playback.sql":__vite_glob_0_2,"../sql/playlists.sql":__vite_glob_0_3});r.local&&delete t["../sql/fts.sql"];const n=Object.values(t).flatMap(s=>s.split(/\r?\n\r?\n/)).map(s=>sql.raw(s));e.update(s=>Promise.all(n.map(a=>a.execute(s))))}return connections.get(r.name)}function nocrr(r){return{...r,schema:Object.fromEntries(Object.entries(r.schema).map(([e,t])=>[e,{...t,crr:!1}]))}}function identity(r){return r}function pipeFromArray(r){return r.length===0?identity:r.length===1?r[0]:function(t){return r.reduce((n,s)=>s(n),t)}}function observable(r){const e={subscribe(t){let n=null,s=!1,a=!1,c=!1;function f(){if(n===null){c=!0;return}a||(a=!0,typeof n=="function"?n():n&&n.unsubscribe())}return n=r({next(h){var m;s||(m=t.next)==null||m.call(t,h)},error(h){var m;s||(s=!0,(m=t.error)==null||m.call(t,h),f())},complete(){var h;s||(s=!0,(h=t.complete)==null||h.call(t),f())}}),c&&f(),{unsubscribe:f}},pipe(...t){return pipeFromArray(t)(e)}};return e}function share(r){return e=>{let t=0,n=null;const s=[];function a(){n||(n=e.subscribe({next(f){var h;for(const m of s)(h=m.next)==null||h.call(m,f)},error(f){var h;for(const m of s)(h=m.error)==null||h.call(m,f)},complete(){var f;for(const h of s)(f=h.complete)==null||f.call(h)}}))}function c(){if(t===0&&n){const f=n;n=null,f.unsubscribe()}}return{subscribe(f){return t++,s.push(f),a(),{unsubscribe(){t--,c();const h=s.findIndex(m=>m===f);h>-1&&s.splice(h,1)}}}}}}class ObservableAbortError extends Error{constructor(e){super(e),this.name="ObservableAbortError",Object.setPrototypeOf(this,ObservableAbortError.prototype)}}function observableToPromise(r){let e;return{promise:new Promise((n,s)=>{let a=!1;function c(){a||(a=!0,s(new ObservableAbortError("This operation was aborted.")),f.unsubscribe())}const f=r.subscribe({next(h){a=!0,n(h),c()},error(h){a=!0,s(h),c()},complete(){a=!0,c()}});e=c}),abort:e}}function createChain(r){return observable(e=>{function t(s=0,a=r.op){const c=r.links[s];if(!c)throw new Error("No more links to execute - did you forget to add an ending link?");return c({op:a,next(h){return t(s+1,h)}})}return t().subscribe(e)})}function isObject(r){return!!r&&!Array.isArray(r)&&typeof r=="object"}function transformResultInner(r,e){if("error"in r){const n=e.transformer.deserialize(r.error);return{ok:!1,error:{...r,error:n}}}return{ok:!0,result:{...r.result,...(!r.result.type||r.result.type==="data")&&{type:"data",data:e.transformer.deserialize(r.result.data)}}}}class TransformResultError extends Error{constructor(){super("Unable to transform response from server")}}function transformResult(r,e){let t;try{t=transformResultInner(r,e)}catch{throw new TransformResultError}if(!t.ok&&(!isObject(t.error.error)||typeof t.error.error.code!="number"))throw new TransformResultError;if(t.ok&&!isObject(t.result))throw new TransformResultError;return t}function isTRPCClientError(r){return r instanceof TRPCClientError||r instanceof Error&&r.name==="TRPCClientError"}function isTRPCErrorResponse(r){return isObject(r)&&isObject(r.error)&&typeof r.error.code=="number"&&typeof r.error.message=="string"}class TRPCClientError extends Error{static from(e,t={}){const n=e;return isTRPCClientError(n)?(t.meta&&(n.meta={...n.meta,...t.meta}),n):isTRPCErrorResponse(n)?new TRPCClientError(n.error.message,{...t,result:n}):n instanceof Error?new TRPCClientError(n.message,{...t,cause:n}):new TRPCClientError("Unknown error",{...t,cause:n})}constructor(e,t){var s,a;const n=t==null?void 0:t.cause;super(e,{cause:n}),this.meta=t==null?void 0:t.meta,this.cause=n,this.shape=(s=t==null?void 0:t.result)==null?void 0:s.error,this.data=(a=t==null?void 0:t.result)==null?void 0:a.error.data,this.name="TRPCClientError",Object.setPrototypeOf(this,TRPCClientError.prototype)}}function invert(r){const e=Object.create(null);for(const t in r){const n=r[t];e[n]=t}return e}const TRPC_ERROR_CODES_BY_KEY={PARSE_ERROR:-32700,BAD_REQUEST:-32600,INTERNAL_SERVER_ERROR:-32603,NOT_IMPLEMENTED:-32603,UNAUTHORIZED:-32001,FORBIDDEN:-32003,NOT_FOUND:-32004,METHOD_NOT_SUPPORTED:-32005,TIMEOUT:-32008,CONFLICT:-32009,PRECONDITION_FAILED:-32012,PAYLOAD_TOO_LARGE:-32013,UNPROCESSABLE_CONTENT:-32022,TOO_MANY_REQUESTS:-32029,CLIENT_CLOSED_REQUEST:-32099};invert(TRPC_ERROR_CODES_BY_KEY);invert(TRPC_ERROR_CODES_BY_KEY);const noop=()=>{};function createInnerProxy(r,e){return new Proxy(noop,{get(n,s){if(!(typeof s!="string"||s==="then"))return createInnerProxy(r,[...e,s])},apply(n,s,a){const c=e[e.length-1]==="apply";return r({args:c?a.length>=2?a[1]:[]:a,path:c?e.slice(0,-1):e})}})}const createRecursiveProxy=r=>createInnerProxy(r,[]),createFlatProxy=r=>new Proxy(noop,{get(e,t){if(!(typeof t!="string"||t==="then"))return r(t)}});/* istanbul ignore next -- @preserve */const retryDelay=r=>r===0?0:Math.min(1e3*2**r,3e4);function createWSClient(r){const{url:e,WebSocket:t=WebSocket,retryDelayMs:n=retryDelay,onOpen:s,onClose:a}=r;/* istanbul ignore next -- @preserve */if(!t)throw new Error("No WebSocket implementation found - you probably don't want to use this on the server, but if you do you need to pass a `WebSocket`-ponyfill");let c=[];const f=Object.create(null);let h=0,m=null,N=null,g=U(),C="connecting";function k(){C!=="open"||m||(m=setTimeout(()=>{m=null,c.length===1?g.send(JSON.stringify(c.pop())):g.send(JSON.stringify(c)),c=[]}))}function O(){if(N!==null||C==="closed")return;const W=n(h++);b(W)}function p(){C="connecting";const W=g;g=U(),y(W)}function b(W){N||(C="connecting",N=setTimeout(p,W))}function y(W){Object.values(f).some(ce=>ce.ws===W)||W.close()}function _(){Object.values(f).forEach(W=>{W.type==="subscription"&&W.callbacks.complete()})}function R(W){c.some(J=>J.id===W.op.id)||$(W.op,W.callbacks)}function U(){const W=typeof e=="function"?e():e,J=new t(W);clearTimeout(N),N=null,J.addEventListener("open",()=>{/* istanbul ignore next -- @preserve */J===g&&(h=0,C="open",s==null||s(),k())}),J.addEventListener("error",()=>{J===g&&O()});const ce=z=>{if(z.method==="reconnect"&&J===g){C==="open"&&(a==null||a()),p();for(const Q of Object.values(f))Q.type==="subscription"&&R(Q)}},H=z=>{var L,X;const Q=z.id!==null&&f[z.id];if(Q){if((X=(L=Q.callbacks).next)==null||X.call(L,z),Q.ws!==g&&J===g){const Z=Q.ws;Q.ws=g,y(Z)}"result"in z&&z.result.type==="stopped"&&J===g&&Q.callbacks.complete()}};return J.addEventListener("message",({data:z})=>{const Q=JSON.parse(z);"method"in Q?ce(Q):H(Q),(J!==g||C==="closed")&&y(J)}),J.addEventListener("close",({code:z})=>{var Q,L,X,Z;C==="open"&&(a==null||a({code:z})),g===J&&O();for(const[oe,he]of Object.entries(f))if(he.ws===J){if(C==="closed"){delete f[oe],(L=(Q=he.callbacks).complete)==null||L.call(Q);continue}he.type==="subscription"?R(he):(delete f[oe],(Z=(X=he.callbacks).error)==null||Z.call(X,TRPCClientError.from(new TRPCWebSocketClosedError("WebSocket closed prematurely"))))}}),J}function $(W,J){const{type:ce,input:H,path:z,id:Q}=W,L={id:Q,method:ce,params:{input:H,path:z}};return f[Q]={ws:g,type:ce,callbacks:J,op:W},c.push(L),k(),()=>{var Z,oe;const X=(Z=f[Q])==null?void 0:Z.callbacks;delete f[Q],c=c.filter(he=>he.id!==Q),(oe=X==null?void 0:X.complete)==null||oe.call(X),g.readyState===t.OPEN&&W.type==="subscription"&&(c.push({id:Q,method:"subscription.stop"}),k())}}return{close:()=>{C="closed",a==null||a(),_(),y(g),clearTimeout(N),N=null},request:$,getConnection(){return g}}}class TRPCWebSocketClosedError extends Error{constructor(e){super(e),this.name="TRPCWebSocketClosedError",Object.setPrototypeOf(this,TRPCWebSocketClosedError.prototype)}}function wsLink(r){return e=>{const{client:t}=r;return({op:n})=>observable(s=>{const{type:a,path:c,id:f,context:h}=n,m=e.transformer.serialize(n.input),N=t.request({type:a,path:c,input:m,id:f,context:h},{error(g){s.error(g),N()},complete(){s.complete()},next(g){const C=transformResult(g,e);if(!C.ok){s.error(TRPCClientError.from(C.error));return}s.next({result:C.result}),n.type!=="subscription"&&(N(),s.complete())}});return()=>{N()}})}}class TRPCUntypedClient{$request({type:e,input:t,path:n,context:s={}}){return createChain({links:this.links,op:{id:++this.requestId,type:e,path:n,input:t,context:s}}).pipe(share())}requestAsPromise(e){const t=this.$request(e),{promise:n,abort:s}=observableToPromise(t);return new Promise((c,f)=>{var h;(h=e.signal)==null||h.addEventListener("abort",s),n.then(m=>{c(m.result.data)}).catch(m=>{f(TRPCClientError.from(m))})})}query(e,t,n){return this.requestAsPromise({type:"query",path:e,input:t,context:n==null?void 0:n.context,signal:n==null?void 0:n.signal})}mutation(e,t,n){return this.requestAsPromise({type:"mutation",path:e,input:t,context:n==null?void 0:n.context,signal:n==null?void 0:n.signal})}subscription(e,t,n){return this.$request({type:"subscription",path:e,input:t,context:n==null?void 0:n.context}).subscribe({next(a){var c,f,h;a.result.type==="started"?(c=n.onStarted)==null||c.call(n):a.result.type==="stopped"?(f=n.onStopped)==null||f.call(n):(h=n.onData)==null||h.call(n,a.result.data)},error(a){var c;(c=n.onError)==null||c.call(n,a)},complete(){var a;(a=n.onComplete)==null||a.call(n)}})}constructor(e){this.requestId=0;const t=(()=>{const n=e.transformer;return n?"input"in n?e.transformer:{input:n,output:n}:{input:{serialize:s=>s,deserialize:s=>s},output:{serialize:s=>s,deserialize:s=>s}}})();this.runtime={transformer:{serialize:n=>t.input.serialize(n),deserialize:n=>t.output.deserialize(n)},combinedTransformer:t},this.links=e.links.map(n=>n(this.runtime))}}const clientCallTypeMap={query:"query",mutate:"mutation",subscribe:"subscription"},clientCallTypeToProcedureType=r=>clientCallTypeMap[r];function createTRPCClientProxy(r){return createFlatProxy(e=>r.hasOwnProperty(e)?r[e]:e==="__untypedClient"?r:createRecursiveProxy(({path:t,args:n})=>{const s=[e,...t],a=clientCallTypeToProcedureType(s.pop()),c=s.join(".");return r[a](c,...n)}))}function createTRPCProxyClient(r){const e=new TRPCUntypedClient(r);return createTRPCClientProxy(e)}var lo;const{sync,search:search$1,streams,expand,desource,transcribe}=createTRPCProxyClient({links:[(lo=globalThis.localStorage)!=null&&lo.getItem("remote")?wsLink({client:createWSClient({url:()=>localStorage.getItem("remote")})}):()=>()=>observable(()=>{})]}),{playlists,resources,preceding,playback,upcoming,settings,history,artists,library,albums,tracks,update,feed}=connect({name:"library.db",push:sync.push.mutate,pull:sync.pull.subscribe}),search=writable(""),extra=writable(null);function format(r,e=!1){if(!e){r=Math.round(+r),r<=0&&(r=0);const f=~~(r/3600);r-=f*3600;const h=~~(r/60);r-=h*60;const m=r,N=g=>g.toString().padStart(2,"0");return f?`${f}:${N(h)}:${N(m)}`:`${h}:${N(m)}`}const t=new Intl.RelativeTimeFormat("en"),n=Math.floor((Date.now()-+r)/1e3),s=Math.floor(n/60),a=Math.floor(s/60),c=Math.floor(a/24);return n<=1?"just now":n<60?t.format(-n,"seconds"):s<60?t.format(-s,"minutes"):a<24?t.format(-a,"hours"):t.format(-c,"days")}function compare(r){const e=new Date;return+r>+e?"In The Future":r.getFullYear()===e.getFullYear()?r.getMonth()===e.getMonth()?e.getDate()-r.getDate()===0?"Today":e.getDate()-r.getDate()===1?"Yesterday":e.getDate()-r.getDate()<7&&e.getDay()>r.getDay()?"This Week":e.getDate()-r.getDate()<7||e.getDate()-r.getDate()<14&&e.getDay()>=r.getDay()?"Last Week":"This Month":e.getMonth()-r.getMonth()===1?"Last Month":`In ${r.toLocaleString("default",{month:"long"})}`:r.getFullYear().toString()}const get_default_slot_changes=r=>({}),get_default_slot_context=r=>({slot:"after"});function create_default_slot_6(r){let e;return{c(){e=text(r[4])},l(t){e=claim_text(t,r[4])},m(t,n){insert_hydration(t,e,n)},p(t,n){n&16&&set_data(e,t[4])},d(t){t&&detach(e)}}}function create_default_slot_5(r){let e,t,n,s;return n=new Text({props:{secondary:!0,$$slots:{default:[create_default_slot_6]},$$scope:{ctx:r}}}),{c(){e=text(r[5]),t=space(),create_component(n.$$.fragment)},l(a){e=claim_text(a,r[5]),t=claim_space(a),claim_component(n.$$.fragment,a)},m(a,c){insert_hydration(a,e,c),insert_hydration(a,t,c),mount_component(n,a,c),s=!0},p(a,c){(!s||c&32)&&set_data(e,a[5]);const f={};c&1040&&(f.$$scope={dirty:c,ctx:a}),n.$set(f)},i(a){s||(transition_in(n.$$.fragment,a),s=!0)},o(a){transition_out(n.$$.fragment,a),s=!1},d(a){a&&(detach(e),detach(t)),destroy_component(n,a)}}}function create_default_slot_4(r){var n;let e=((n=r[3])==null?void 0:n.artists.map(func).join(", "))+"",t;return{c(){t=text(e)},l(s){t=claim_text(s,e)},m(s,a){insert_hydration(s,t,a)},p(s,a){var c;a&8&&e!==(e=((c=s[3])==null?void 0:c.artists.map(func).join(", "))+"")&&set_data(t,e)},d(s){s&&detach(t)}}}function create_if_block(r){let e,t;return e=new When({props:{lg:!0,$$slots:{default:[create_default_slot_2]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),t=!0},p(n,s){const a={};s&1032&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}function create_default_slot_3(r){var n;let e=((n=r[3])==null?void 0:n.album.title)+"",t;return{c(){t=text(e)},l(s){t=claim_text(s,e)},m(s,a){insert_hydration(s,t,a)},p(s,a){var c;a&8&&e!==(e=((c=s[3])==null?void 0:c.album.title)+"")&&set_data(t,e)},d(s){s&&detach(t)}}}function create_default_slot_2(r){let e,t;return e=new Text({props:{secondary:!0,sm:!0,loading:!r[3],$$slots:{default:[create_default_slot_3]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),t=!0},p(n,s){const a={};s&8&&(a.loading=!n[3]),s&1032&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}function create_default_slot_1(r){let e,t,n,s,a,c,f=`scaleX(${r[1]})`,h;e=new Text({props:{accent:!0,loading:!r[3],$$slots:{default:[create_default_slot_5]},$$scope:{ctx:r}}}),n=new Text({props:{secondary:!0,sm:!0,loading:!r[3],$$slots:{default:[create_default_slot_4]},$$scope:{ctx:r}}});let m=!r[0]&&create_if_block(r);return{c(){create_component(e.$$.fragment),t=space(),create_component(n.$$.fragment),s=space(),m&&m.c(),a=space(),c=element("div"),this.h()},l(N){claim_component(e.$$.fragment,N),t=claim_space(N),claim_component(n.$$.fragment,N),s=claim_space(N),m&&m.l(N),a=claim_space(N),c=claim_element(N,"DIV",{class:!0}),children(c).forEach(detach),this.h()},h(){attr(c,"class","absolute bottom-0 left-0 h-0.5 w-full origin-left transform-gpu bg-highlight-200 transition-transform duration-1000"),set_style(c,"transform",f)},m(N,g){mount_component(e,N,g),insert_hydration(N,t,g),mount_component(n,N,g),insert_hydration(N,s,g),m&&m.m(N,g),insert_hydration(N,a,g),insert_hydration(N,c,g),h=!0},p(N,g){const C={};g&8&&(C.loading=!N[3]),g&1072&&(C.$$scope={dirty:g,ctx:N}),e.$set(C);const k={};g&8&&(k.loading=!N[3]),g&1032&&(k.$$scope={dirty:g,ctx:N}),n.$set(k),N[0]?m&&(group_outros(),transition_out(m,1,1,()=>{m=null}),check_outros()):m?(m.p(N,g),g&1&&transition_in(m,1)):(m=create_if_block(N),m.c(),transition_in(m,1),m.m(a.parentNode,a)),g&2&&f!==(f=`scaleX(${N[1]})`)&&set_style(c,"transform",f)},i(N){h||(transition_in(e.$$.fragment,N),transition_in(n.$$.fragment,N),transition_in(m),h=!0)},o(N){transition_out(e.$$.fragment,N),transition_out(n.$$.fragment,N),transition_out(m),h=!1},d(N){N&&(detach(t),detach(s),detach(a),detach(c)),destroy_component(e,N),destroy_component(n,N),m&&m.d(N)}}}function create_default_slot(r){var a;let e,t,n=`hue-rotate(${((a=r[3])==null?void 0:a.id)||0}deg)`,s;return t=new Icon({props:{name:"note"}}),{c(){e=element("div"),create_component(t.$$.fragment),this.h()},l(c){e=claim_element(c,"DIV",{class:!0});var f=children(e);claim_component(t.$$.fragment,f),f.forEach(detach),this.h()},h(){attr(e,"class","flex h-full w-full items-center justify-center bg-gradient-to-r from-rose-400 to-red-400 text-white"),set_style(e,"filter",n)},m(c,f){insert_hydration(c,e,f),mount_component(t,e,null),s=!0},p(c,f){var h;f&8&&n!==(n=`hue-rotate(${((h=c[3])==null?void 0:h.id)||0}deg)`)&&set_style(e,"filter",n)},i(c){s||(transition_in(t.$$.fragment,c),s=!0)},o(c){transition_out(t.$$.fragment,c),s=!1},d(c){c&&detach(e),destroy_component(t)}}}function create_before_slot(r){var n,s;let e,t;return e=new Image({props:{src:r[3]?((n=r[3].album.arts)==null?void 0:n[0])||"":void 0,thumbnail:r[3]?((s=r[3].album.thumbnails)==null?void 0:s[0])||"":void 0,slot:"before",$$slots:{default:[create_default_slot]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(a){claim_component(e.$$.fragment,a)},m(a,c){mount_component(e,a,c),t=!0},p(a,c){var h,m;const f={};c&8&&(f.src=a[3]?((h=a[3].album.arts)==null?void 0:h[0])||"":void 0),c&8&&(f.thumbnail=a[3]?((m=a[3].album.thumbnails)==null?void 0:m[0])||"":void 0),c&1032&&(f.$$scope={dirty:c,ctx:a}),e.$set(f)},i(a){t||(transition_in(e.$$.fragment,a),t=!0)},o(a){transition_out(e.$$.fragment,a),t=!1},d(a){destroy_component(e,a)}}}function create_after_slot(r){let e;const t=r[7].default,n=create_slot(t,r,r[10],get_default_slot_context);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,a){n&&n.p&&(!e||a&1024)&&update_slot_base(n,t,s,s[10],e?get_slot_changes(t,s[10],a,get_default_slot_changes):get_all_dirty_from_scope(s[10]),get_default_slot_context)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}function create_fragment(r){let e,t;return e=new Card({props:{sm:!0,flat:!0,flow:!r[0],interactive:!0,selected:r[2],$$slots:{after:[create_after_slot],before:[create_before_slot],default:[create_default_slot_1]},$$scope:{ctx:r}}}),e.$on("contextmenu",r[8]),e.$on("click",r[9]),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),t=!0},p(n,[s]){const a={};s&1&&(a.flow=!n[0]),s&4&&(a.selected=n[2]),s&1083&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}const func=r=>r.title;function instance(r,e,t){let n,s,a,{$$slots:c={},$$scope:f}=e,{sm:h=!1}=e,{progress:m=0}=e,{selected:N=!1}=e,{track:g=void 0}=e;function C(O){bubble.call(this,r,O)}function k(O){bubble.call(this,r,O)}return r.$$set=O=>{"sm"in O&&t(0,h=O.sm),"progress"in O&&t(1,m=O.progress),"selected"in O&&t(2,N=O.selected),"track"in O&&t(3,g=O.track),"$$scope"in O&&t(10,f=O.$$scope)},r.$$.update=()=>{r.$$.dirty&8&&t(5,[n=void 0,...s]=(g==null?void 0:g.title.split("("))||[],n,(t(6,s),t(3,g))),r.$$.dirty&64&&t(4,a=s.length?"("+s.join("("):"")},[h,m,N,g,a,n,s,c,C,k,f]}class Track extends SvelteComponent{constructor(e){super(),init$1(this,e,instance,create_fragment,safe_not_equal,{sm:0,progress:1,selected:2,track:3})}}export{Card as C,Image as I,Portal as P,Realm as R,Track as T,Virtual as V,When as W,extra as a,streams as b,capitalize as c,search$1 as d,ensure_array_like as e,albums as f,artists as g,history as h,initRealm as i,expand as j,playback as k,library as l,feed as m,Text as n,outro_and_destroy_block as o,playlists as p,format as q,ready as r,search as s,tracks as t,update_keyed_each as u,hold as v,compare as w,upcoming as x,desource as y};
