import{T as run_all,s as safe_not_equal,w as create_slot,f as element,g as claim_element,h as children,d as detach,j as attr,E as toggle_class,i as insert_hydration,x as update_slot_base,y as get_all_dirty_from_scope,z as get_slot_changes,L as setContext,e as empty$1,G as noop$2,A as getContext,a as space,c as claim_space,k as set_style,u as append_hydration,C as listen,J as action_destroyer,v as component_subscribe,W as createEventDispatcher,o as onMount,t as tick,F as set_store_value,p as binding_callbacks,H as compute_slots,X as assign$1,a1 as set_dynamic_element_data,M as bubble,a0 as src_url_equal,l as text,m as claim_text,n as set_data}from"./scheduler.yhBzS9E6.js";import{t as transition_out,a as transition_in,S as SvelteComponent,i as init$1,g as group_outros,c as check_outros,b as create_component,d as claim_component,m as mount_component,e as destroy_component}from"./index.f7836kWu.js";import{w as writable,d as derived}from"./paths.kHDvQc0-.js";import{l as lock,b as unlock,a as getScrollParent,p as position$1,I as Icon,g as get_spread_update}from"./Spinner.svelte_svelte_type_style_lang.wWhsP2Sr.js";const globals=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function ensure_array_like(t){return t?.length!==void 0?t:Array.from(t)}function outro_and_destroy_block(t,e){transition_out(t,1,1,()=>{e.delete(t.key)})}function update_keyed_each(t,e,r,n,s,a,u,d,f,y,b,w){let A=t.length,R=a.length,I=A;const h={};for(;I--;)h[t[I].key]=I;const N=[],m=new Map,E=new Map,v=[];for(I=R;I--;){const q=w(s,a,I),Y=r(q);let z=u.get(Y);z?n&&v.push(()=>z.p(q,e)):(z=y(Y,q),z.c()),m.set(Y,N[I]=z),Y in h&&E.set(Y,Math.abs(I-h[Y]))}const C=new Set,$=new Set;function T(q){transition_in(q,1),q.m(d,b),u.set(q.key,q),b=q.first,R--}for(;A&&R;){const q=N[R-1],Y=t[A-1],z=q.key,M=Y.key;q===Y?(b=q.first,A--,R--):m.has(M)?!u.has(z)||C.has(z)?T(q):$.has(M)?A--:E.get(z)>E.get(M)?($.add(z),T(q)):(C.add(M),A--):(f(Y,u),A--)}for(;A--;){const q=t[A];m.has(q.key)||f(q,u)}for(;R;)T(N[R-1]);return run_all(v),N}let observing=0,observer=null;const dispatch=t=>t.forEach(e=>{e.target?.dispatchEvent(new CustomEvent("resize",{detail:e}))});function resize(t){return observer||(observer=new ResizeObserver(dispatch)),observer.observe(t),observing+=1,{destroy(){observer?.unobserve(t),observing-=1,observing<=0&&(observer?.disconnect(),observer=null)}}}function drag(t,e="touchstart"){function r(u){do{if(u?.draggable)return u;u=u?.parentElement||null}while(u);return null}function n(u){const d=r(u.target);d&&(lock(),u.preventDefault(),d.dispatchEvent(new DragEvent("dragstart",{bubbles:!0})))}function s(u){u.preventDefault(),addEventListener("pointercancel",a),addEventListener("pointerup",a)}function a(){unlock(),removeEventListener("pointercancel",a),removeEventListener("pointerup",a),t.dispatchEvent(new DragEvent("dragend",{bubbles:!0}))}return t.addEventListener(e,n),t.addEventListener("dragstart",s),{destroy(){t.removeEventListener(e,n),t.removeEventListener("dragstart",s)}}}function hold(t,{touch:e=!0,mouse:r=!1,duration:n=300}={}){function s(a){const u=setTimeout(()=>{d();const f=a instanceof TouchEvent?TouchEvent:MouseEvent;a.target?.dispatchEvent(new f("hold",a))},n),d=()=>{clearTimeout(u),e&&(t.removeEventListener("touchcancel",d),t.removeEventListener("touchmove",d),t.removeEventListener("touchend",d)),r&&(t.removeEventListener("mousemove",d),t.removeEventListener("mouseup",d))};e&&(t.addEventListener("touchcancel",d,{once:!0}),t.addEventListener("touchend",d,{once:!0}),t.addEventListener("touchmove",d,{once:!0,passive:!0})),r&&(t.addEventListener("mousemove",d,{once:!0}),t.addEventListener("mouseup",d,{once:!0}))}return e&&t.addEventListener("touchstart",s,{passive:!0}),r&&t.addEventListener("mousedown",s),{destroy(){t.removeEventListener("touchstart",s),t.removeEventListener("mousedown",s)}}}function create_fragment$7(t){let e,r,n;const s=t[6].default,a=create_slot(s,t,t[5],null);return{c(){e=element("div"),a&&a.c(),this.h()},l(u){e=claim_element(u,"DIV",{class:!0});var d=children(e);a&&a.l(d),d.forEach(detach),this.h()},h(){attr(e,"class",r=t[0]?"contents":"hidden"),toggle_class(e,"sm:contents",!t[0]&&t[1]),toggle_class(e,"md:contents",!t[0]&&t[2]),toggle_class(e,"lg:contents",!t[0]&&t[3]),toggle_class(e,"xl:contents",!t[0]&&t[4]),toggle_class(e,"sm:hidden",t[0]&&t[1]),toggle_class(e,"md:hidden",t[0]&&t[2]),toggle_class(e,"lg:hidden",t[0]&&t[3]),toggle_class(e,"xl:hidden",t[0]&&t[4])},m(u,d){insert_hydration(u,e,d),a&&a.m(e,null),n=!0},p(u,[d]){a&&a.p&&(!n||d&32)&&update_slot_base(a,s,u,u[5],n?get_slot_changes(s,u[5],d,null):get_all_dirty_from_scope(u[5]),null),(!n||d&1&&r!==(r=u[0]?"contents":"hidden"))&&attr(e,"class",r),(!n||d&3)&&toggle_class(e,"sm:contents",!u[0]&&u[1]),(!n||d&5)&&toggle_class(e,"md:contents",!u[0]&&u[2]),(!n||d&9)&&toggle_class(e,"lg:contents",!u[0]&&u[3]),(!n||d&17)&&toggle_class(e,"xl:contents",!u[0]&&u[4]),(!n||d&3)&&toggle_class(e,"sm:hidden",u[0]&&u[1]),(!n||d&5)&&toggle_class(e,"md:hidden",u[0]&&u[2]),(!n||d&9)&&toggle_class(e,"lg:hidden",u[0]&&u[3]),(!n||d&17)&&toggle_class(e,"xl:hidden",u[0]&&u[4])},i(u){n||(transition_in(a,u),n=!0)},o(u){transition_out(a,u),n=!1},d(u){u&&detach(e),a&&a.d(u)}}}function instance$8(t,e,r){let{$$slots:n={},$$scope:s}=e,{not:a=!1}=e,{sm:u=!1}=e,{md:d=!1}=e,{lg:f=!1}=e,{xl:y=!1}=e;return t.$$set=b=>{"not"in b&&r(0,a=b.not),"sm"in b&&r(1,u=b.sm),"md"in b&&r(2,d=b.md),"lg"in b&&r(3,f=b.lg),"xl"in b&&r(4,y=b.xl),"$$scope"in b&&r(5,s=b.$$scope)},[a,u,d,f,y,s,n]}class When extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$8,create_fragment$7,safe_not_equal,{not:0,sm:1,md:2,lg:3,xl:4})}}function create_fragment$6(t){let e;const r=t[1].default,n=create_slot(r,t,t[0],null);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,[a]){n&&n.p&&(!e||a&1)&&update_slot_base(n,r,s,s[0],e?get_slot_changes(r,s[0],a,null):get_all_dirty_from_scope(s[0]),null)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}const initRealm=()=>({ssr:"",claimed:new Set,mounted:new Set,claim:new Set,destroy:new Set,mount:new Set,target:void 0});function instance$7(t,e,r){let{$$slots:n={},$$scope:s}=e;return setContext("realm",{}),t.$$set=u=>{"$$scope"in u&&r(0,s=u.$$scope)},[s,n]}class Realm extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$7,create_fragment$6,safe_not_equal,{})}}function create_key_block(t){let e;const r=t[4].default,n=create_slot(r,t,t[3],null);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,a){n&&n.p&&(!e||a&8)&&update_slot_base(n,r,s,s[3],e?get_slot_changes(r,s[3],a,null):get_all_dirty_from_scope(s[3]),null)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}function create_fragment$5(t){let e=t[0],r,n,s=create_key_block(t);return{c(){s.c(),r=empty$1()},l(a){s.l(a),r=empty$1()},m(a,u){s.m(a,u),insert_hydration(a,r,u),n=!0},p(a,[u]){u&1&&safe_not_equal(e,e=a[0])?(group_outros(),transition_out(s,1,1,noop$2),check_outros(),s=create_key_block(a),s.c(),transition_in(s,1),s.m(r.parentNode,r)):s.p(a,u)},i(a){n||(transition_in(s),n=!0)},o(a){transition_out(s),n=!1},d(a){a&&detach(r),s.d(a)}}}function instance$6($$self,$$props,$$invalidate){let{$$slots:slots={},$$scope}=$$props,{to=""}=$$props,{unique=""}=$$props;const realm=getContext("realm");if(!realm)throw new Error("A portal should exists within a realm!");realm[to]||(realm[to]=initRealm());const target=eval("slots");if(target.default){const[t]=target.default;target.default[0]=(...e)=>{const r=t(...e),n=realm[to];let s=!0,a=!0;function u(y){if(!y||n.claimed.has(unique))return a=!1;r.l(y),unique&&n.claimed.add(unique)}function d(y,b){if(n.mounted.has(unique))return s=!1;a&&r.m(y,b),unique&&n.mounted.add(unique)}function f(y){s&&n.mounted.delete(unique),a&&n.claimed.delete(unique),s&&r.d(y),n.claim.delete(u),n.mount.delete(d),n.destroy.delete(f)}return n.claim.add(u),n.mount.add(d),n.destroy.add(f),{...r,d:f,l:()=>{},m:()=>n.target&&d.apply(null,n.target)}}}return $$self.$$set=t=>{"to"in t&&$$invalidate(0,to=t.to),"unique"in t&&$$invalidate(1,unique=t.unique),"$$scope"in t&&$$invalidate(3,$$scope=t.$$scope)},$$self.$$.update=()=>{$$self.$$.dirty&5&&(realm[to]||$$invalidate(2,realm[to]=initRealm(),realm))},[to,unique,realm,$$scope,slots]}class Portal extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$6,create_fragment$5,safe_not_equal,{to:0,unique:1})}}function minmax(t,e,r,n){return t<e?n??e:t>r?n??r:t}const{Map:Map_1,window:window_1}=globals,get_default_slot_changes_1=t=>({item:t[0]&2048}),get_default_slot_context_1=t=>({item:t[11].data,index:NaN});function get_each_context(t,e,r){const n=t.slice();return n[52]=e[r],n[54]=r,n}const get_default_slot_changes$1=t=>({item:t[0]&16384,index:t[0]&16640}),get_default_slot_context$1=t=>({item:t[52],index:t[8]+t[54]});function create_each_block(t,e){let r,n,s,a;const u=e[40].default,d=create_slot(u,e,e[42],get_default_slot_context$1);return{key:t,first:null,c(){r=element("div"),d&&d.c(),n=space(),this.h()},l(f){r=claim_element(f,"DIV",{draggable:!0,style:!0});var y=children(r);d&&d.l(y),n=claim_space(y),y.forEach(detach),this.h()},h(){attr(r,"draggable",s=e[2]&&e[1](e[52])!=null?"true":void 0),set_style(r,"overflow-anchor","none"),toggle_class(r,"invisible",e[11]?.owner===e[3]&&e[11]?.key===e[1](e[52])),this.first=r},m(f,y){insert_hydration(f,r,y),d&&d.m(r,null),append_hydration(r,n),a=!0},p(f,y){e=f,d&&d.p&&(!a||y[0]&16640|y[1]&2048)&&update_slot_base(d,u,e,e[42],a?get_slot_changes(u,e[42],y,get_default_slot_changes$1):get_all_dirty_from_scope(e[42]),get_default_slot_context$1),(!a||y[0]&16390&&s!==(s=e[2]&&e[1](e[52])!=null?"true":void 0))&&attr(r,"draggable",s),(!a||y[0]&18442)&&toggle_class(r,"invisible",e[11]?.owner===e[3]&&e[11]?.key===e[1](e[52]))},i(f){a||(transition_in(d,f),a=!0)},o(f){transition_out(d,f),a=!1},d(f){f&&detach(r),d&&d.d(f)}}}function create_if_block$3(t){let e,r;return e=new Portal({props:{to:"overlay",$$slots:{default:[create_default_slot$1]},$$scope:{ctx:t}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),r=!0},p(n,s){const a={};s[0]&2297|s[1]&2048&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){r||(transition_in(e.$$.fragment,n),r=!0)},o(n){transition_out(e.$$.fragment,n),r=!1},d(n){destroy_component(e,n)}}}function create_if_block_1$2(t){let e,r=`translate3d(
          ${t[11].back?t[11].back.x:t[7].x+Math.max(t[11].offset.x,-t[4].width/t[6]+t[0])}px,
          ${t[11].back?t[11].back.y:t[7].y+Math.max(t[11].offset.y,-t[5]+t[0])}px, 0)`,n=`${t[4].width/t[6]-t[0]}px`,s=`${t[5]-t[0]}px`,a;const u=t[40].default,d=create_slot(u,t,t[42],get_default_slot_context_1);return{c(){e=element("div"),d&&d.c(),this.h()},l(f){e=claim_element(f,"DIV",{class:!0});var y=children(e);d&&d.l(y),y.forEach(detach),this.h()},h(){attr(e,"class","absolute will-change-transform contain-[size_layout]"),toggle_class(e,"transition-transform",t[11].back),set_style(e,"transform",r),set_style(e,"width",n),set_style(e,"height",s)},m(f,y){insert_hydration(f,e,y),d&&d.m(e,null),a=!0},p(f,y){d&&d.p&&(!a||y[0]&2048|y[1]&2048)&&update_slot_base(d,u,f,f[42],a?get_slot_changes(u,f[42],y,get_default_slot_changes_1):get_all_dirty_from_scope(f[42]),get_default_slot_context_1),(!a||y[0]&2048)&&toggle_class(e,"transition-transform",f[11].back),y[0]&2289&&r!==(r=`translate3d(
          ${f[11].back?f[11].back.x:f[7].x+Math.max(f[11].offset.x,-f[4].width/f[6]+f[0])}px,
          ${f[11].back?f[11].back.y:f[7].y+Math.max(f[11].offset.y,-f[5]+f[0])}px, 0)`)&&set_style(e,"transform",r),y[0]&81&&n!==(n=`${f[4].width/f[6]-f[0]}px`)&&set_style(e,"width",n),y[0]&33&&s!==(s=`${f[5]-f[0]}px`)&&set_style(e,"height",s)},i(f){a||(transition_in(d,f),a=!0)},o(f){transition_out(d,f),a=!1},d(f){f&&detach(e),d&&d.d(f)}}}function create_default_slot$1(t){let e,r,n=t[11]?.owner===t[3]&&create_if_block_1$2(t);return{c(){n&&n.c(),e=empty$1()},l(s){n&&n.l(s),e=empty$1()},m(s,a){n&&n.m(s,a),insert_hydration(s,e,a),r=!0},p(s,a){s[11]?.owner===s[3]?n?(n.p(s,a),a[0]&2056&&transition_in(n,1)):(n=create_if_block_1$2(s),n.c(),transition_in(n,1),n.m(e.parentNode,e)):n&&(group_outros(),transition_out(n,1,1,()=>{n=null}),check_outros())},i(s){r||(transition_in(n),r=!0)},o(s){transition_out(n),r=!1},d(s){s&&detach(e),n&&n.d(s)}}}function create_fragment$4(t){let e,r,n=[],s=new Map_1,a=`translate3d(0,${Math.ceil(t[8]/t[6])*t[5]}px,0)`,u=`${t[0]}px`,d,f=`${t[10]}px`,y,b,w,A=ensure_array_like(t[14]);const R=h=>h[12][(h[8]+h[54])%h[9]]??h[54];for(let h=0;h<A.length;h+=1){let N=get_each_context(t,A,h),m=R(N);s.set(m,n[h]=create_each_block(m,N))}let I=t[2]&&create_if_block$3(t);return{c(){e=element("div"),r=element("div");for(let h=0;h<n.length;h+=1)n[h].c();d=space(),I&&I.c(),this.h()},l(h){e=claim_element(h,"DIV",{class:!0});var N=children(e);r=claim_element(N,"DIV",{class:!0});var m=children(r);for(let E=0;E<n.length;E+=1)n[E].l(m);m.forEach(detach),d=claim_space(N),I&&I.l(N),N.forEach(detach),this.h()},h(){attr(r,"class","grid auto-rows-max will-change-transform contain-layout"),toggle_class(r,"pointer-events-none",!!t[11]),set_style(r,"transform",a),set_style(r,"grid-template-columns",t[13]),set_style(r,"gap",u),attr(e,"class","shrink-0 contain-[size_layout]"),set_style(e,"height",f)},m(h,N){insert_hydration(h,e,N),append_hydration(e,r);for(let m=0;m<n.length;m+=1)n[m]&&n[m].m(r,null);t[41](r),append_hydration(e,d),I&&I.m(e,null),y=!0,b||(w=[listen(window_1,"dragstart",t[15]),listen(window_1,"dragend",t[16]),action_destroyer(drag.call(null,r,"hold")),action_destroyer(hold.call(null,r))],b=!0)},p(h,N){N[0]&23310|N[1]&2048&&(A=ensure_array_like(h[14]),group_outros(),n=update_keyed_each(n,N,R,1,h,A,s,r,outro_and_destroy_block,create_each_block,null,get_each_context),check_outros()),(!y||N[0]&2048)&&toggle_class(r,"pointer-events-none",!!h[11]),N[0]&352&&a!==(a=`translate3d(0,${Math.ceil(h[8]/h[6])*h[5]}px,0)`)&&set_style(r,"transform",a),N[0]&8192&&set_style(r,"grid-template-columns",h[13]),N[0]&1&&u!==(u=`${h[0]}px`)&&set_style(r,"gap",u),h[2]?I?(I.p(h,N),N[0]&4&&transition_in(I,1)):(I=create_if_block$3(h),I.c(),transition_in(I,1),I.m(e,null)):I&&(group_outros(),transition_out(I,1,1,()=>{I=null}),check_outros()),N[0]&1024&&f!==(f=`${h[10]}px`)&&set_style(e,"height",f)},i(h){if(!y){for(let N=0;N<A.length;N+=1)transition_in(n[N]);transition_in(I),y=!0}},o(h){for(let N=0;N<n.length;N+=1)transition_out(n[N]);transition_out(I),y=!1},d(h){h&&detach(e);for(let N=0;N<n.length;N+=1)n[N].d();t[41](null),I&&I.d(),b=!1,run_all(w)}}}let transfer=writable(null);function instance$5(t,e,r){let n,s,a,u,d,f,y,b,w,A,R,I,h,N,m,E,v,C,$,T;component_subscribe(t,transfer,Q=>r(11,T=Q));let{$$slots:q={},$$scope:Y}=e;const z=createEventDispatcher();let{gap:M=0}=e,{items:W}=e,{move:V=!1}=e,{fixed:ae=!1}=e,{overthrow:G=1}=e,{prerender:me=1}=e,{columns:Oe=1}=e,{key:P=Q=>Q}=e,{animate:J=!1}=e,{sortable:te=!1}=e,{container:le=void 0}=e,X=null,ye={x:0,y:0},ge=new DOMRect,be=new DOMRect,ke=!0,Ae=1,U=0,ne=0;function He(Q){!A&&Q.length&&tick().then(se);const Z=new Map,oe=Array.from({length:b}),Ne=new Set(w);for(let ue=0;ue<Q.length;ue++){const We=P(Q[ue]);if(We==null||(Z.set(We,ue),ue<d||ue>=f))continue;const Te=A?.get(We);if(Te==null||Te<d||Te>=f||(oe[ue%b]=w[Te%b],Ne.delete(w[Te%b]),Te===ue||!J)||T?.owner===X&&We===T?.key)continue;const at=~~(Te/U)-~~(ue/U),lt=~~(Te%U)-~~(ue%U);Pe(Te,lt,at)}const he=[...Ne];return r(12,w=oe.map(ue=>ue??he.shift())),Z}function Pe(Q,Z,oe){const Ne=X?.children.item(Q-d),he=[`translate3d(${Z*100}%,${oe*100}%,0)`,"translate3d(0,0,0)"];Ne?.animate({transform:he,zIndex:["100","100"]},{easing:"ease",composite:"accumulate",duration:R})}function se(){if(!le||!X)return;r(4,be=X.parentElement?.getBoundingClientRect()),r(26,ge=le.getBoundingClientRect()),r(4,be.y+=ye.y,be),r(28,ne=be.y-ge.y-ge.height/2),r(4,be.width+=M,be);const Q=X.firstElementChild;if(!Q)return;const{width:Z,height:oe}=Q.getBoundingClientRect();!Z||!oe||(r(6,U=~~(be.width/(Z+M))),r(5,Ae=oe+M))}let de,Ce,j={x:0,y:0};async function je({target:Q}){if(se(),await tick(),!te||!X||!Q||T||Q.parentElement!==X||W[$]==null||P(W[$])==null)return;Ce=$,de=V?-1:Ce;const Z=Q.getBoundingClientRect();Z.x-=j.x,Z.y-=j.y,set_store_value(transfer,T={group:te===!0?X:te,key:P(W[$]),data:W[$],owner:X,offset:Z},T)}function Se(Q,Z=!1){if(!te||!T||ae||P(W[Q])==null)return;if(!Number.isInteger(Q)){de!=null&&T.owner!==X&&(Se(de,!0),de=void 0);return}if(P(W[Q])===T.key)return;Q<0&&!W.length&&(Q=0);const oe=W.findIndex(Ne=>P(Ne)===T?.key);oe!==Q&&(!Z&&de==null&&(de=oe,Ce=oe),~oe&&W.splice(oe,1),~Q&&W.splice(Q,0,T.data),requestAnimationFrame(()=>r(17,W))),!Z&&X&&set_store_value(transfer,T.owner=X,T)}async function ot(){if(!te||!T||Ce==null)return;const Q=W.findIndex(Z=>P(Z)===T?.key);if(T.owner===X&&~Q){const Z=X.children.item(Q-d);Z&&(set_store_value(transfer,T.back=Z.getBoundingClientRect(),T),set_store_value(transfer,T.group=Math.random().toString(),T),await new Promise(oe=>setTimeout(oe,150)))}if(Ce!==Q){const Z=T.data,oe=W[Q-1],Ne=(+!!~Ce<<1)+ +!!~Q,he=[void 0,"push","purge","rearrange"][Ne];he&&z("edit",{action:he,index:Q,after:oe,item:Z})}Ce=void 0,de=void 0,T.owner===X&&set_store_value(transfer,T=null,T)}onMount(()=>{function Q(Ne){const he=Ne.currentTarget;r(25,ye.x=he.scrollLeft,ye),r(25,ye.y=he.scrollTop,ye)}le||r(18,le=getScrollParent(X));const Z=te&&position$1.subscribe(Ne=>r(7,j=Ne));le.addEventListener("scroll",Q,{passive:!0}),le.addEventListener("resize",se);const{destroy:oe}=resize(le);return r(27,ke=!1),()=>{le?.removeEventListener("scroll",Q),le?.removeEventListener("resize",se),Z&&Z(),oe()}});function ze(Q){binding_callbacks[Q?"unshift":"push"](()=>{X=Q,r(3,X)})}return t.$$set=Q=>{"gap"in Q&&r(0,M=Q.gap),"items"in Q&&r(17,W=Q.items),"move"in Q&&r(19,V=Q.move),"fixed"in Q&&r(20,ae=Q.fixed),"overthrow"in Q&&r(21,G=Q.overthrow),"prerender"in Q&&r(22,me=Q.prerender),"columns"in Q&&r(23,Oe=Q.columns),"key"in Q&&r(1,P=Q.key),"animate"in Q&&r(24,J=Q.animate),"sortable"in Q&&r(2,te=Q.sortable),"container"in Q&&r(18,le=Q.container),"$$scope"in Q&&r(42,Y=Q.$$scope)},t.$$.update=()=>{t.$$.dirty[0]&67108960&&r(38,n=Math.ceil(ge.height/Ae)*U),t.$$.dirty[0]&96|t.$$.dirty[1]&128&&r(39,s=n/U*Ae),t.$$.dirty[0]&131072|t.$$.dirty[1]&128&&r(36,a=Math.max(Math.ceil(W.length/n)-2,1)),t.$$.dirty[0]&301989888|t.$$.dirty[1]&288&&r(37,u=minmax(~~((ye.y-ne)/s),1,a)),t.$$.dirty[0]&2097152|t.$$.dirty[1]&192&&r(8,d=Math.max(u-G,0)*n),t.$$.dirty[0]&6291456|t.$$.dirty[1]&192&&r(35,f=Math.max((u+G+1)*n,me)),t.$$.dirty[0]&131328|t.$$.dirty[1]&16&&r(14,y=W.slice(d,f)),t.$$.dirty[0]&2097152|t.$$.dirty[1]&128&&r(9,b=(G*2+1)*n),t.$$.dirty[0]&512&&r(12,w=Array.from({length:b}).map((Q,Z)=>Z)),t.$$.dirty[0]&131072&&(A=He(W)),t.$$.dirty[0]&16777216&&(R=J===!0?300:J||0),t.$$.dirty[0]&131169&&r(10,I=Math.ceil(W.length/U)*Ae-M),t.$$.dirty[0]&8388608&&r(13,h=Number.isInteger(Oe)?`repeat(${Oe},1fr)`:`repeat(auto-fill,minmax(min(100%,${Oe}),1fr))`),t.$$.dirty[0]&1024&&Number.isFinite(I)&&(requestAnimationFrame(se),r(27,ke=!1)),t.$$.dirty[0]&134217728|t.$$.dirty[1]&96&&!ke&&u===a&&(z("end"),r(27,ke=!0)),t.$$.dirty[0]&12&&r(30,N=te===!0?X:te),t.$$.dirty[0]&100663441&&r(34,m=minmax(j.y+M/2,ge.top,ge.bottom,NaN)+ye.y-be.y),t.$$.dirty[0]&33554577&&r(33,E=minmax(j.x+M/2,be.left,be.right-M-1,NaN)+ye.x-be.x),t.$$.dirty[0]&32|t.$$.dirty[1]&8&&r(32,v=Math.floor(m/Ae)),t.$$.dirty[0]&80|t.$$.dirty[1]&4&&r(31,C=Math.floor(E/(be.width/U))),t.$$.dirty[0]&131136|t.$$.dirty[1]&3&&r(29,$=minmax(v*U+C,0,W.length-1)),t.$$.dirty[0]&1610614784&&T?.group===N&&Se($)},[M,P,te,X,be,Ae,U,j,d,b,I,T,w,h,y,je,ot,W,le,V,ae,G,me,Oe,J,ye,ge,ke,ne,$,N,C,v,E,m,f,a,u,n,s,q,ze,Y]}class Virtual extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$5,create_fragment$4,safe_not_equal,{gap:0,items:17,move:19,fixed:20,overthrow:21,prerender:22,columns:23,key:1,animate:24,sortable:2,container:18},null,[-1,-1])}}const get_after_slot_changes=t=>({}),get_after_slot_context=t=>({}),get_before_slot_changes=t=>({}),get_before_slot_context=t=>({});function create_if_block_1$1(t){let e,r;const n=t[9].before,s=create_slot(n,t,t[8],get_before_slot_context);return{c(){e=element("div"),s&&s.c(),this.h()},l(a){e=claim_element(a,"DIV",{class:!0});var u=children(e);s&&s.l(u),u.forEach(detach),this.h()},h(){attr(e,"class","z-20 flex items-center")},m(a,u){insert_hydration(a,e,u),s&&s.m(e,null),r=!0},p(a,u){s&&s.p&&(!r||u&256)&&update_slot_base(s,n,a,a[8],r?get_slot_changes(n,a[8],u,get_before_slot_changes):get_all_dirty_from_scope(a[8]),get_before_slot_context)},i(a){r||(transition_in(s,a),r=!0)},o(a){transition_out(s,a),r=!1},d(a){a&&detach(e),s&&s.d(a)}}}function create_if_block$2(t){let e;return{c(){e=element("hr"),this.h()},l(r){e=claim_element(r,"HR",{"aria-hidden":!0,class:!0}),this.h()},h(){attr(e,"aria-hidden",""),attr(e,"class","absolute bottom-0 h-[1px] w-full border-none bg-content/10 group-last-of-type:opacity-0")},m(r,n){insert_hydration(r,e,n)},d(r){r&&detach(e)}}}function create_dynamic_element(t){let e,r,n,s,a,u,d,f,y,b,w,A,R,I,h,N,m,E,v,C,$,T,q,Y,z=t[7].before&&create_if_block_1$1(t);const M=t[9].default,W=create_slot(M,t,t[8],null);let V=t[2]&&(t[1]||t[0])&&create_if_block$2();I=new Icon({props:{name:"circle"}}),m=new Icon({props:{name:"target"}});const ae=t[9].after,G=create_slot(ae,t,t[8],get_after_slot_context);let me=[{role:C=t[5]?"link":"button"},{tabindex:"0"},{href:t[5]},{draggable:"false"},{class:$="group relative z-10 flex w-full items-center gap-4 overflow-hidden px-4 outline-2 -outline-offset-2 outline-primary-600 contain-inline-size focus-visible:outline "+(t[4]?"cursor-pointer touch-manipulation select-none "+(t[2]?"":"transition-transform active:scale-95"):"")+" "+(t[0]?"focus-visible:z-50":t[1]?"rounded-lg py-1 focus-visible:z-50":"rounded-2xl py-4")+" "+(t[2]?"bg-surface":"bg-surface-100 shadow-[0_0_20px_-4px] shadow-black/20 dark:shadow-none")}],Oe={};for(let P=0;P<me.length;P+=1)Oe=assign$1(Oe,me[P]);return{c(){e=element(t[4]?t[5]?"a":"button":"article"),r=element("div"),n=space(),s=element("div"),u=space(),z&&z.c(),d=space(),f=element("div"),W&&W.c(),y=space(),V&&V.c(),w=space(),A=element("div"),R=element("div"),create_component(I.$$.fragment),h=space(),N=element("div"),create_component(m.$$.fragment),E=space(),v=element("div"),G&&G.c(),this.h()},l(P){e=claim_element(P,((t[4]?t[5]?"a":"button":"article")||"null").toUpperCase(),{role:!0,tabindex:!0,href:!0,draggable:!0,class:!0});var J=children(e);r=claim_element(J,"DIV",{"aria-hidden":!0,class:!0}),children(r).forEach(detach),n=claim_space(J),s=claim_element(J,"DIV",{"aria-hidden":!0,class:!0}),children(s).forEach(detach),u=claim_space(J),z&&z.l(J),d=claim_space(J),f=claim_element(J,"DIV",{class:!0});var te=children(f);W&&W.l(te),y=claim_space(te),V&&V.l(te),te.forEach(detach),w=claim_space(J),A=claim_element(J,"DIV",{class:!0});var le=children(A);R=claim_element(le,"DIV",{class:!0});var X=children(R);claim_component(I.$$.fragment,X),X.forEach(detach),h=claim_space(le),N=claim_element(le,"DIV",{class:!0});var ye=children(N);claim_component(m.$$.fragment,ye),ye.forEach(detach),E=claim_space(le),v=claim_element(le,"DIV",{class:!0});var ge=children(v);G&&G.l(ge),ge.forEach(detach),le.forEach(detach),J.forEach(detach),this.h()},h(){attr(r,"aria-hidden",""),attr(r,"class","pointer-events-none absolute inset-0 -z-10 bg-primary-200/30 opacity-0 transition-opacity"),toggle_class(r,"opacity-100",t[6]===!0),attr(s,"aria-hidden",""),attr(s,"class",a="pointer-events-none absolute inset-0 z-0 bg-highlight opacity-0 "+(t[4]?"group-hover:opacity-30 "+(t[2]?"dark:group-hover:opacity-50":"dark:group-hover:opacity-10"):"")),attr(f,"class",b="z-10 grid w-full grid-cols-1 items-baseline overflow-hidden contain-inline-size "+(t[1]||t[0]?"justify-start gap-0.5":"place-items-center justify-center gap-2")+" "+((t[1]||t[0])&&t[3]?"lg:auto-cols-fr lg:grid-flow-col lg:gap-4":"")),attr(R,"class","flex justify-center text-primary-600 opacity-0 transition-opacity"),toggle_class(R,"opacity-100",t[6]),attr(N,"class","flex scale-0 justify-center text-primary-600 transition-transform"),toggle_class(N,"scale-100",t[6]===!0),attr(v,"class","opacity-0 transition-opacity"),toggle_class(v,"opacity-100",!t[6]),attr(A,"class","z-20 grid items-center [&>*]:col-start-1 [&>*]:row-start-1"),set_dynamic_element_data(t[4]?t[5]?"a":"button":"article")(e,Oe)},m(P,J){insert_hydration(P,e,J),append_hydration(e,r),append_hydration(e,n),append_hydration(e,s),append_hydration(e,u),z&&z.m(e,null),append_hydration(e,d),append_hydration(e,f),W&&W.m(f,null),append_hydration(f,y),V&&V.m(f,null),append_hydration(e,w),append_hydration(e,A),append_hydration(A,R),mount_component(I,R,null),append_hydration(A,h),append_hydration(A,N),mount_component(m,N,null),append_hydration(A,E),append_hydration(A,v),G&&G.m(v,null),T=!0,q||(Y=[listen(e,"click",t[10]),listen(e,"contextmenu",t[11])],q=!0)},p(P,J){(!T||J&64)&&toggle_class(r,"opacity-100",P[6]===!0),(!T||J&20&&a!==(a="pointer-events-none absolute inset-0 z-0 bg-highlight opacity-0 "+(P[4]?"group-hover:opacity-30 "+(P[2]?"dark:group-hover:opacity-50":"dark:group-hover:opacity-10"):"")))&&attr(s,"class",a),P[7].before?z?(z.p(P,J),J&128&&transition_in(z,1)):(z=create_if_block_1$1(P),z.c(),transition_in(z,1),z.m(e,d)):z&&(group_outros(),transition_out(z,1,1,()=>{z=null}),check_outros()),W&&W.p&&(!T||J&256)&&update_slot_base(W,M,P,P[8],T?get_slot_changes(M,P[8],J,null):get_all_dirty_from_scope(P[8]),null),P[2]&&(P[1]||P[0])?V||(V=create_if_block$2(),V.c(),V.m(f,null)):V&&(V.d(1),V=null),(!T||J&11&&b!==(b="z-10 grid w-full grid-cols-1 items-baseline overflow-hidden contain-inline-size "+(P[1]||P[0]?"justify-start gap-0.5":"place-items-center justify-center gap-2")+" "+((P[1]||P[0])&&P[3]?"lg:auto-cols-fr lg:grid-flow-col lg:gap-4":"")))&&attr(f,"class",b),(!T||J&64)&&toggle_class(R,"opacity-100",P[6]),(!T||J&64)&&toggle_class(N,"scale-100",P[6]===!0),G&&G.p&&(!T||J&256)&&update_slot_base(G,ae,P,P[8],T?get_slot_changes(ae,P[8],J,get_after_slot_changes):get_all_dirty_from_scope(P[8]),get_after_slot_context),(!T||J&64)&&toggle_class(v,"opacity-100",!P[6]),set_dynamic_element_data(P[4]?P[5]?"a":"button":"article")(e,Oe=get_spread_update(me,[(!T||J&32&&C!==(C=P[5]?"link":"button"))&&{role:C},{tabindex:"0"},(!T||J&32)&&{href:P[5]},{draggable:"false"},(!T||J&23&&$!==($="group relative z-10 flex w-full items-center gap-4 overflow-hidden px-4 outline-2 -outline-offset-2 outline-primary-600 contain-inline-size focus-visible:outline "+(P[4]?"cursor-pointer touch-manipulation select-none "+(P[2]?"":"transition-transform active:scale-95"):"")+" "+(P[0]?"focus-visible:z-50":P[1]?"rounded-lg py-1 focus-visible:z-50":"rounded-2xl py-4")+" "+(P[2]?"bg-surface":"bg-surface-100 shadow-[0_0_20px_-4px] shadow-black/20 dark:shadow-none")))&&{class:$}]))},i(P){T||(transition_in(z),transition_in(W,P),transition_in(I.$$.fragment,P),transition_in(m.$$.fragment,P),transition_in(G,P),T=!0)},o(P){transition_out(z),transition_out(W,P),transition_out(I.$$.fragment,P),transition_out(m.$$.fragment,P),transition_out(G,P),T=!1},d(P){P&&detach(e),z&&z.d(),W&&W.d(P),V&&V.d(),destroy_component(I),destroy_component(m),G&&G.d(P),q=!1,run_all(Y)}}}function create_fragment$3(t){let e=t[4]?t[5]?"a":"button":"article",r,n,s=(t[4]?t[5]?"a":"button":"article")&&create_dynamic_element(t);return{c(){s&&s.c(),r=empty$1()},l(a){s&&s.l(a),r=empty$1()},m(a,u){s&&s.m(a,u),insert_hydration(a,r,u),n=!0},p(a,[u]){!a[4]||a[5],e?safe_not_equal(e,a[4]?a[5]?"a":"button":"article")?(s.d(1),s=create_dynamic_element(a),e=a[4]?a[5]?"a":"button":"article",s.c(),s.m(r.parentNode,r)):s.p(a,u):(s=create_dynamic_element(a),e=a[4]?a[5]?"a":"button":"article",s.c(),s.m(r.parentNode,r))},i(a){n||(transition_in(s,a),n=!0)},o(a){transition_out(s,a),n=!1},d(a){a&&detach(r),s&&s.d(a)}}}function instance$4(t,e,r){let{$$slots:n={},$$scope:s}=e;const a=compute_slots(n);let{xs:u=!1}=e,{sm:d=!1}=e,{flat:f=!1}=e,{flow:y=!1}=e,{interactive:b=!1}=e,{href:w=void 0}=e,{selected:A=!1}=e;function R(h){bubble.call(this,t,h)}function I(h){bubble.call(this,t,h)}return t.$$set=h=>{"xs"in h&&r(0,u=h.xs),"sm"in h&&r(1,d=h.sm),"flat"in h&&r(2,f=h.flat),"flow"in h&&r(3,y=h.flow),"interactive"in h&&r(4,b=h.interactive),"href"in h&&r(5,w=h.href),"selected"in h&&r(6,A=h.selected),"$$scope"in h&&r(8,s=h.$$scope)},[u,d,f,y,b,w,A,a,s,n,R,I]}class Card extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$4,create_fragment$3,safe_not_equal,{xs:0,sm:1,flat:2,flow:3,interactive:4,href:5,selected:6})}}function create_fragment$2(t){let e,r,n;const s=t[6].default,a=create_slot(s,t,t[5],null);return{c(){e=element("span"),a&&a.c(),this.h()},l(u){e=claim_element(u,"SPAN",{class:!0});var d=children(e);a&&a.l(d),d.forEach(detach),this.h()},h(){attr(e,"class",r="w-max max-w-full overflow-hidden text-ellipsis whitespace-nowrap rounded-md text-left [&>*]:align-bottom "+(t[1]?"animate-pulse bg-highlight text-transparent":"")+" "+(t[2]?"font-medium":"font-normal")),toggle_class(e,"text-content-200",t[0]),toggle_class(e,"ml-4",t[3]),toggle_class(e,"text-sm",t[4])},m(u,d){insert_hydration(u,e,d),a&&a.m(e,null),n=!0},p(u,[d]){a&&a.p&&(!n||d&32)&&update_slot_base(a,s,u,u[5],n?get_slot_changes(s,u[5],d,null):get_all_dirty_from_scope(u[5]),null),(!n||d&6&&r!==(r="w-max max-w-full overflow-hidden text-ellipsis whitespace-nowrap rounded-md text-left [&>*]:align-bottom "+(u[1]?"animate-pulse bg-highlight text-transparent":"")+" "+(u[2]?"font-medium":"font-normal")))&&attr(e,"class",r),(!n||d&7)&&toggle_class(e,"text-content-200",u[0]),(!n||d&14)&&toggle_class(e,"ml-4",u[3]),(!n||d&22)&&toggle_class(e,"text-sm",u[4])},i(u){n||(transition_in(a,u),n=!0)},o(u){transition_out(a,u),n=!1},d(u){u&&detach(e),a&&a.d(u)}}}function instance$3(t,e,r){let{$$slots:n={},$$scope:s}=e,{secondary:a=!1}=e,{loading:u=!1}=e,{accent:d=!1}=e,{indent:f=!1}=e,{sm:y=!1}=e;return t.$$set=b=>{"secondary"in b&&r(0,a=b.secondary),"loading"in b&&r(1,u=b.loading),"accent"in b&&r(2,d=b.accent),"indent"in b&&r(3,f=b.indent),"sm"in b&&r(4,y=b.sm),"$$scope"in b&&r(5,s=b.$$scope)},[a,u,d,f,y,s,n]}class Text extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$3,create_fragment$2,safe_not_equal,{secondary:0,loading:1,accent:2,indent:3,sm:4})}}function create_if_block_1(t){let e;const r=t[7].default,n=create_slot(r,t,t[6],null);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,a){n&&n.p&&(!e||a&64)&&update_slot_base(n,r,s,s[6],e?get_slot_changes(r,s[6],a,null):get_all_dirty_from_scope(s[6]),null)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}function create_if_block$1(t){let e,r,n,s,a,u;return{c(){e=element("img"),this.h()},l(d){e=claim_element(d,"IMG",{alt:!0,src:!0,class:!0,loading:!0,width:!0,height:!0,draggable:!0}),this.h()},h(){attr(e,"alt",t[3]),src_url_equal(e.src,r=t[2]<100/devicePixelRatio?t[0]:t[1])||attr(e,"src",r),attr(e,"class","opacity-0 transition-opacity duration-500"),attr(e,"loading","lazy"),attr(e,"width",n=t[2]+"px"),attr(e,"height",s=t[2]+"px"),attr(e,"draggable","false"),toggle_class(e,"opacity-100",t[5]==="ok")},m(d,f){insert_hydration(d,e,f),t[8](e),a||(u=[listen(e,"load",t[9]),listen(e,"error",t[10])],a=!0)},p(d,f){f&8&&attr(e,"alt",d[3]),f&7&&!src_url_equal(e.src,r=d[2]<100/devicePixelRatio?d[0]:d[1])&&attr(e,"src",r),f&4&&n!==(n=d[2]+"px")&&attr(e,"width",n),f&4&&s!==(s=d[2]+"px")&&attr(e,"height",s),f&32&&toggle_class(e,"opacity-100",d[5]==="ok")},i:noop$2,o:noop$2,d(d){d&&detach(e),t[8](null),a=!1,run_all(u)}}}function create_fragment$1(t){let e,r,n,s,a=`${t[2]}px`,u=`${t[2]}px`,d;const f=[create_if_block$1,create_if_block_1],y=[];function b(w,A){return w[1]&&w[5]!=="error"?0:w[5]==="error"?1:-1}return~(r=b(t))&&(n=y[r]=f[r](t)),{c(){e=element("div"),n&&n.c(),this.h()},l(w){e=claim_element(w,"DIV",{class:!0});var A=children(e);n&&n.l(A),A.forEach(detach),this.h()},h(){attr(e,"class",s="overflow-hidden "+(t[2]>200?"rounded-2xl":"rounded")+" bg-highlight-100"),toggle_class(e,"animate-pulse",t[5]==="loading"),set_style(e,"height",a),set_style(e,"width",u)},m(w,A){insert_hydration(w,e,A),~r&&y[r].m(e,null),d=!0},p(w,[A]){let R=r;r=b(w),r===R?~r&&y[r].p(w,A):(n&&(group_outros(),transition_out(y[R],1,1,()=>{y[R]=null}),check_outros()),~r?(n=y[r],n?n.p(w,A):(n=y[r]=f[r](w),n.c()),transition_in(n,1),n.m(e,null)):n=null),(!d||A&4&&s!==(s="overflow-hidden "+(w[2]>200?"rounded-2xl":"rounded")+" bg-highlight-100"))&&attr(e,"class",s),(!d||A&36)&&toggle_class(e,"animate-pulse",w[5]==="loading"),A&4&&a!==(a=`${w[2]}px`)&&set_style(e,"height",a),A&4&&u!==(u=`${w[2]}px`)&&set_style(e,"width",u)},i(w){d||(transition_in(n),d=!0)},o(w){transition_out(n),d=!1},d(w){w&&detach(e),~r&&y[r].d()}}}function instance$2(t,e,r){let n,{$$slots:s={},$$scope:a}=e,{thumbnail:u=void 0}=e,{src:d=void 0}=e,{size:f=48}=e,{alt:y=""}=e,b;onMount(()=>(b?.complete&&r(4,b.style.opacity="1",b),!1));function w(I){binding_callbacks[I?"unshift":"push"](()=>{b=I,r(4,b)})}const A=()=>r(5,n="ok"),R=()=>r(5,n="error");return t.$$set=I=>{"thumbnail"in I&&r(0,u=I.thumbnail),"src"in I&&r(1,d=I.src),"size"in I&&r(2,f=I.size),"alt"in I&&r(3,y=I.alt),"$$scope"in I&&r(6,a=I.$$scope)},t.$$.update=()=>{t.$$.dirty&2&&r(5,n=d===""||d===null?"error":"loading")},[u,d,f,y,b,n,a,s,w,A,R]}class Image extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$2,create_fragment$1,safe_not_equal,{thumbnail:0,src:1,size:2,alt:3})}}function capitalize(t,e=!0){return t&&(e?t.replace(/\b\w/g,r=>r.toUpperCase()):t.replace(/\b\w/,r=>r.toUpperCase()))}function clean(t){return t.normalize().trim().toLowerCase().replace(/\s+/g," ")}const __vite_glob_0_0=`CREATE TRIGGER IF NOT EXISTS cascade_playlists_library
AFTER DELETE ON playlists
FOR EACH ROW
BEGIN
  DELETE FROM library WHERE playlist = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_library_tracks
AFTER DELETE ON library
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM library 
    WHERE track = OLD.track 
  UNION ALL SELECT 1 FROM playback
    WHERE track = OLD.track
  LIMIT 1
)
BEGIN
  DELETE FROM tracks WHERE id = OLD.track;
END;

CREATE TRIGGER IF NOT EXISTS cascade_playback_tracks
AFTER DELETE ON playback
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM library
    WHERE track = OLD.track
  UNION ALL SELECT 1 FROM playback
    WHERE track = OLD.track
  LIMIT 1
)
BEGIN
  DELETE FROM tracks WHERE id = OLD.track;
END;

CREATE TRIGGER IF NOT EXISTS cascade_tracks_albums
AFTER DELETE ON tracks
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM tracks WHERE album = OLD.album LIMIT 1
)
BEGIN
  DELETE FROM albums WHERE id = OLD.album;
END;

CREATE TRIGGER IF NOT EXISTS cascade_albums_attribution
AFTER DELETE ON albums
FOR EACH ROW
BEGIN
  DELETE FROM attribution WHERE album = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_attribution_artists
AFTER DELETE ON attribution
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM attribution
    WHERE artist = OLD.artist
)
BEGIN
  DELETE FROM artists WHERE id = OLD.artist;
END;

CREATE TRIGGER IF NOT EXISTS cascade_tracks_resources
AFTER DELETE ON tracks
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_albums_resources
AFTER DELETE ON albums
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
  DELETE FROM assets WHERE owner = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_artists_resources
AFTER DELETE ON artists
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
  DELETE FROM assets WHERE owner = OLD.id;
END;
`,__vite_glob_0_1=`CREATE VIRTUAL TABLE IF NOT EXISTS tracks_fts USING fts5 (
  title,
  album,
  artists,
  content='',
  tokenize='trigram'
);

CREATE VIRTUAL TABLE IF NOT EXISTS albums_fts USING fts5 (
  title,
  artists,
  content='',
  tokenize='trigram'
);

CREATE VIRTUAL TABLE IF NOT EXISTS artists_fts USING fts5 (
  title,
  content='',
  tokenize='trigram'
);

---------------------------- Artists Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_artists_insert AFTER INSERT ON artists BEGIN
  -- Update artists index
  INSERT INTO artists_fts(rowid,title) VALUES (NEW.id, NEW.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title,
      CASE WHEN EXISTS (SELECT 1 FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id) THEN albums.title ELSE NULL END,
      (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS fts_artists_update AFTER UPDATE OF title ON artists WHEN (OLD.title IS NOT NEW.title) BEGIN
  -- Update artists index
  INSERT INTO artists_fts(artists_fts,rowid,title) VALUES ('delete', OLD.id, OLD.title);
  INSERT INTO artists_fts(rowid,title) VALUES (NEW.id, NEW.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(CASE WHEN artists.id = OLD.id THEN OLD.title ELSE title END) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = OLD.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(CASE WHEN artists.id = OLD.id THEN OLD.title ELSE title END) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = OLD.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS fts_artists_delete BEFORE DELETE ON artists BEGIN
  -- Update artists index
  INSERT INTO artists_fts(artists_fts,rowid,title) VALUES ('delete', OLD.id, OLD.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = OLD.id;
END;

---------------------------- Albums Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_albums_insert AFTER INSERT ON albums BEGIN
  -- Update albums index
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT NEW.id, NEW.title, group_concat(artists.title)
    FROM attribution
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE attribution.album = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, NULL, NULL
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS albums_fts_update AFTER UPDATE OF title ON albums WHEN (OLD.title IS NOT NEW.title) BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', OLD.id, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
    WHERE attribution.album = OLD.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT NEW.id, NEW.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
    WHERE attribution.album = OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = OLD.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, NEW.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS albums_fts_delete BEFORE DELETE ON albums BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', OLD.id, OLD.title, group_concat(artists.title)
    FROM attribution
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE attribution.album = OLD.id
    GROUP BY OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = OLD.id;
END;

---------------------------- Attribution Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_attribution_insert AFTER INSERT ON attribution
  WHEN EXISTS (SELECT 1 FROM artists WHERE id = NEW.artist) AND EXISTS (SELECT 1 FROM albums WHERE id = NEW.album)
BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, NULL, NULL
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT  tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
END;

CREATE TRIGGER IF NOT EXISTS fts_attribution_delete BEFORE DELETE ON attribution BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = OLD.album AND attribution.artist = OLD.artist;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = OLD.album AND attribution.artist = OLD.artist;
END;

---------------------------- Tracks Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_tracks_insert AFTER INSERT ON tracks BEGIN
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT NEW.id, NEW.title, albums.title, group_concat(artists.title)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE albums.id = NEW.album;
END;

CREATE TRIGGER IF NOT EXISTS fts_tracks_update AFTER UPDATE OF title ON tracks WHEN (OLD.title IS NOT NEW.title) BEGIN
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', OLD.id, OLD.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
    WHERE albums.id = OLD.album;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT NEW.id, NEW.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
    WHERE albums.id = NEW.album;
END;

CREATE TRIGGER IF NOT EXISTS fts_tracks_delete BEFORE DELETE ON tracks BEGIN
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', OLD.id, OLD.title, albums.title, group_concat(artists.title)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE albums.id = OLD.album
    GROUP BY OLD.id;
END;`,__vite_glob_0_2=`INSERT OR IGNORE INTO devices VALUES (crsql_site_id(), -1, 0, 0, 0, 0);

CREATE VIEW IF NOT EXISTS queue AS
  WITH ordered AS
    (SELECT playback.*, row_number() OVER (
      ORDER BY
        CASE WHEN "direction" != 1 THEN "order" ELSE NULL END ASC,
        CASE WHEN "direction" = 1 THEN "order" ELSE NULL END DESC,
        CASE WHEN "direction" != 1 THEN "playback"."id" ELSE NULL END ASC,
        CASE WHEN "direction" = 1 THEN "playback"."id" ELSE NULL END DESC
    ) as position FROM devices INNER JOIN playback ON playback.device = devices.id
    WHERE devices.id = crsql_site_id())
  SELECT id, device, track, 
    (position - 
      (SELECT position FROM ordered WHERE id = (SELECT playback FROM devices WHERE id = device))
    ) as position
  FROM ordered;

CREATE TRIGGER IF NOT EXISTS playback_started
BEFORE INSERT ON playback
FOR EACH ROW
WHEN NEW.device = crsql_site_id()
BEGIN
  UPDATE devices SET playback = NEW.id WHERE id = NEW.device AND playback IS -1;
END;

CREATE TRIGGER IF NOT EXISTS playback_finised
BEFORE UPDATE OF progress ON devices
FOR EACH ROW
WHEN NEW.progress >= 1 AND NEW.id = crsql_site_id()
BEGIN
  INSERT INTO library SELECT ABS(RANDOM() % 4294967296), -1, track, UNIXEPOCH(), -1 FROM playback WHERE id = NEW.playback;
  UPDATE devices SET 
    playback = CASE WHEN NEW.repeat = 2 AND NOT EXISTS (SELECT 1 FROM queue WHERE position > 0)
      THEN IFNULL((SELECT id FROM queue LIMIT 1), playback)
      WHEN NEW.repeat = 1 THEN playback
      ELSE IFNULL((SELECT id FROM queue WHERE position = 1), playback)
    END,
    progress = 0
  WHERE id = NEW.id;
  SELECT RAISE(IGNORE);
END;

CREATE TRIGGER IF NOT EXISTS playback_backtracked
BEFORE UPDATE OF progress ON devices
FOR EACH ROW
WHEN NEW.progress < 0 AND NEW.id = crsql_site_id()
BEGIN
  UPDATE devices SET 
    playback = IFNULL((SELECT id FROM queue WHERE position = -1), playback),
    progress = 0
  WHERE id = NEW.id;
  SELECT RAISE(IGNORE);
END;

CREATE TRIGGER IF NOT EXISTS playback_shuffled
AFTER UPDATE OF direction ON devices
FOR EACH ROW
WHEN NEW.direction = 2 AND NEW.id = crsql_site_id()
BEGIN
  UPDATE playback SET "temp"="order" WHERE
    (SELECT id FROM queue WHERE position = 0) != id AND device = NEW.id;
  UPDATE playback SET
    "order"=(SELECT "order" FROM playback WHERE "temp" IS NULL)||trim(hex(randomblob(2)),'0')
  WHERE "temp" IS NOT NULL;
END;

CREATE TRIGGER IF NOT EXISTS playback_unshuffled
AFTER UPDATE OF direction ON devices
FOR EACH ROW
WHEN OLD.direction = 2 AND NEW.direction != 2 AND NEW.id = crsql_site_id()
BEGIN
  UPDATE playback SET
    "order"="temp",
    "temp"=NULL
  WHERE "temp" IS NOT NULL AND device = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS playback_purged
BEFORE DELETE ON playback
FOR EACH ROW
WHEN (OLD.id = (SELECT playback FROM devices WHERE id = crsql_site_id()))
BEGIN
  UPDATE devices SET 
    playback = (SELECT id FROM queue WHERE position = 1),
    progress = 0
  WHERE id = OLD.device;
END;`,__vite_glob_0_3=`INSERT OR IGNORE INTO playlists (id, title, "order", relevancy, shared, remote) VALUES
  (-1, 'Listened', 1, 0, NULL, NULL),
  (-2, 'Recommended', 1, -1, NULL, NULL),
  (-3, 'Blocked', 1, -1, NULL, NULL),
  (-4, 'Followed', 1, 0, NULL, NULL);`;function isUndefined(t){return typeof t>"u"||t===void 0}function isString(t){return typeof t=="string"}function isNumber(t){return typeof t=="number"}function isBoolean(t){return typeof t=="boolean"}function isNull(t){return t===null}function isDate(t){return t instanceof Date}function isBigInt(t){return typeof t=="bigint"}function isFunction(t){return typeof t=="function"}function isObject$3(t){return typeof t=="object"&&t!==null}function freeze(t){return Object.freeze(t)}function asArray(t){return isReadonlyArray(t)?t:[t]}function isReadonlyArray(t){return Array.isArray(t)}function noop$1(t){return t}const AlterTableNode=freeze({is(t){return t.kind==="AlterTableNode"},create(t){return freeze({kind:"AlterTableNode",table:t})},cloneWithTableProps(t,e){return freeze({...t,...e})},cloneWithColumnAlteration(t,e){return freeze({...t,columnAlterations:t.columnAlterations?[...t.columnAlterations,e]:[e]})}}),IdentifierNode=freeze({is(t){return t.kind==="IdentifierNode"},create(t){return freeze({kind:"IdentifierNode",name:t})}}),CreateIndexNode=freeze({is(t){return t.kind==="CreateIndexNode"},create(t){return freeze({kind:"CreateIndexNode",name:IdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})},cloneWithColumns(t,e){return freeze({...t,columns:[...t.columns||[],...e]})}}),CreateSchemaNode=freeze({is(t){return t.kind==="CreateSchemaNode"},create(t,e){return freeze({kind:"CreateSchemaNode",schema:IdentifierNode.create(t),...e})},cloneWith(t,e){return freeze({...t,...e})}}),ON_COMMIT_ACTIONS=["preserve rows","delete rows","drop"],CreateTableNode=freeze({is(t){return t.kind==="CreateTableNode"},create(t){return freeze({kind:"CreateTableNode",table:t,columns:freeze([])})},cloneWithColumn(t,e){return freeze({...t,columns:freeze([...t.columns,e])})},cloneWithConstraint(t,e){return freeze({...t,constraints:t.constraints?freeze([...t.constraints,e]):freeze([e])})},cloneWithFrontModifier(t,e){return freeze({...t,frontModifiers:t.frontModifiers?freeze([...t.frontModifiers,e]):freeze([e])})},cloneWithEndModifier(t,e){return freeze({...t,endModifiers:t.endModifiers?freeze([...t.endModifiers,e]):freeze([e])})},cloneWith(t,e){return freeze({...t,...e})}}),SchemableIdentifierNode=freeze({is(t){return t.kind==="SchemableIdentifierNode"},create(t){return freeze({kind:"SchemableIdentifierNode",identifier:IdentifierNode.create(t)})},createWithSchema(t,e){return freeze({kind:"SchemableIdentifierNode",schema:IdentifierNode.create(t),identifier:IdentifierNode.create(e)})}}),DropIndexNode=freeze({is(t){return t.kind==="DropIndexNode"},create(t,e){return freeze({kind:"DropIndexNode",name:SchemableIdentifierNode.create(t),...e})},cloneWith(t,e){return freeze({...t,...e})}}),DropSchemaNode=freeze({is(t){return t.kind==="DropSchemaNode"},create(t,e){return freeze({kind:"DropSchemaNode",schema:IdentifierNode.create(t),...e})},cloneWith(t,e){return freeze({...t,...e})}}),DropTableNode=freeze({is(t){return t.kind==="DropTableNode"},create(t,e){return freeze({kind:"DropTableNode",table:t,...e})},cloneWith(t,e){return freeze({...t,...e})}}),AliasNode=freeze({is(t){return t.kind==="AliasNode"},create(t,e){return freeze({kind:"AliasNode",node:t,alias:e})}}),TableNode=freeze({is(t){return t.kind==="TableNode"},create(t){return freeze({kind:"TableNode",table:SchemableIdentifierNode.create(t)})},createWithSchema(t,e){return freeze({kind:"TableNode",table:SchemableIdentifierNode.createWithSchema(t,e)})}});function isOperationNodeSource(t){return isObject$3(t)&&isFunction(t.toOperationNode)}function isExpression(t){return isObject$3(t)&&"expressionType"in t&&isOperationNodeSource(t)}function isAliasedExpression(t){return isObject$3(t)&&"expression"in t&&isString(t.alias)&&isOperationNodeSource(t)}const SelectModifierNode=freeze({is(t){return t.kind==="SelectModifierNode"},create(t,e){return freeze({kind:"SelectModifierNode",modifier:t,of:e})},createWithExpression(t){return freeze({kind:"SelectModifierNode",rawModifier:t})}}),AndNode=freeze({is(t){return t.kind==="AndNode"},create(t,e){return freeze({kind:"AndNode",left:t,right:e})}}),OrNode=freeze({is(t){return t.kind==="OrNode"},create(t,e){return freeze({kind:"OrNode",left:t,right:e})}}),OnNode=freeze({is(t){return t.kind==="OnNode"},create(t){return freeze({kind:"OnNode",on:t})},cloneWithOperation(t,e,r){return freeze({...t,on:e==="And"?AndNode.create(t.on,r):OrNode.create(t.on,r)})}}),JoinNode=freeze({is(t){return t.kind==="JoinNode"},create(t,e){return freeze({kind:"JoinNode",joinType:t,table:e,on:void 0})},createWithOn(t,e,r){return freeze({kind:"JoinNode",joinType:t,table:e,on:OnNode.create(r)})},cloneWithOn(t,e){return freeze({...t,on:t.on?OnNode.cloneWithOperation(t.on,"And",e):OnNode.create(e)})}}),BinaryOperationNode=freeze({is(t){return t.kind==="BinaryOperationNode"},create(t,e,r){return freeze({kind:"BinaryOperationNode",leftOperand:t,operator:e,rightOperand:r})}}),COMPARISON_OPERATORS=["=","==","!=","<>",">",">=","<","<=","in","not in","is","is not","like","not like","match","ilike","not ilike","@>","<@","&&","?","?&","!<","!>","<=>","!~","~","~*","!~*","@@","@@@","!!","<->","regexp","is distinct from","is not distinct from"],ARITHMETIC_OPERATORS=["+","-","*","/","%","^","&","|","#","<<",">>"],JSON_OPERATORS=["->","->>"],BINARY_OPERATORS=[...COMPARISON_OPERATORS,...ARITHMETIC_OPERATORS,"&&","||"],UNARY_FILTER_OPERATORS=["exists","not exists"],UNARY_OPERATORS=["not","-",...UNARY_FILTER_OPERATORS],OPERATORS=[...BINARY_OPERATORS,...JSON_OPERATORS,...UNARY_OPERATORS,"between","between symmetric"],OperatorNode=freeze({is(t){return t.kind==="OperatorNode"},create(t){return freeze({kind:"OperatorNode",operator:t})}});function isJSONOperator(t){return isString(t)&&JSON_OPERATORS.includes(t)}const ColumnNode=freeze({is(t){return t.kind==="ColumnNode"},create(t){return freeze({kind:"ColumnNode",column:IdentifierNode.create(t)})}}),SelectAllNode=freeze({is(t){return t.kind==="SelectAllNode"},create(){return freeze({kind:"SelectAllNode"})}}),ReferenceNode=freeze({is(t){return t.kind==="ReferenceNode"},create(t,e){return freeze({kind:"ReferenceNode",table:e,column:t})},createSelectAll(t){return freeze({kind:"ReferenceNode",table:t,column:SelectAllNode.create()})}});class DynamicReferenceBuilder{#e;get dynamicReference(){return this.#e}get refType(){}constructor(e){this.#e=e}toOperationNode(){return parseSimpleReferenceExpression(this.#e)}}function isDynamicReferenceBuilder(t){return isObject$3(t)&&isOperationNodeSource(t)&&isString(t.dynamicReference)}const OrderByItemNode=freeze({is(t){return t.kind==="OrderByItemNode"},create(t,e){return freeze({kind:"OrderByItemNode",orderBy:t,direction:e})}}),RawNode=freeze({is(t){return t.kind==="RawNode"},create(t,e){return freeze({kind:"RawNode",sqlFragments:freeze(t),parameters:freeze(e)})},createWithSql(t){return RawNode.create([t],[])},createWithChild(t){return RawNode.create(["",""],[t])},createWithChildren(t){return RawNode.create(new Array(t.length+1).fill(""),t)}});function isOrderByDirection(t){return t==="asc"||t==="desc"}function parseOrderBy(t){if(t.length===2)return[parseOrderByItem(t[0],t[1])];if(t.length===1){const[e]=t;return Array.isArray(e)?e.map(r=>parseOrderByItem(r)):[parseOrderByItem(e)]}throw new Error(`Invalid number of arguments at order by! expected 1-2, received ${t.length}`)}function parseOrderByItem(t,e){const r=parseOrderByExpression(t);if(OrderByItemNode.is(r)){if(e)throw new Error("Cannot specify direction twice!");return r}return OrderByItemNode.create(r,parseOrderByDirectionExpression(e))}function parseOrderByExpression(t){if(isExpressionOrFactory(t))return parseExpression(t);if(isDynamicReferenceBuilder(t))return t.toOperationNode();const[e,r]=t.split(" ");if(r){if(!isOrderByDirection(r))throw new Error(`Invalid order by direction: ${r}`);return OrderByItemNode.create(parseStringReference(e),parseOrderByDirectionExpression(r))}return parseStringReference(t)}function parseOrderByDirectionExpression(t){if(t)return t==="asc"||t==="desc"?RawNode.createWithSql(t):t.toOperationNode()}const JSONReferenceNode=freeze({is(t){return t.kind==="JSONReferenceNode"},create(t,e){return freeze({kind:"JSONReferenceNode",reference:t,traversal:e})},cloneWithTraversal(t,e){return freeze({...t,traversal:e})}}),JSONOperatorChainNode=freeze({is(t){return t.kind==="JSONOperatorChainNode"},create(t){return freeze({kind:"JSONOperatorChainNode",operator:t,values:freeze([])})},cloneWithValue(t,e){return freeze({...t,values:freeze([...t.values,e])})}}),JSONPathNode=freeze({is(t){return t.kind==="JSONPathNode"},create(t){return freeze({kind:"JSONPathNode",inOperator:t,pathLegs:freeze([])})},cloneWithLeg(t,e){return freeze({...t,pathLegs:freeze([...t.pathLegs,e])})}});function parseSimpleReferenceExpression(t){return isString(t)?parseStringReference(t):t.toOperationNode()}function parseReferenceExpressionOrList(t){return isReadonlyArray(t)?t.map(e=>parseReferenceExpression(e)):[parseReferenceExpression(t)]}function parseReferenceExpression(t){return isExpressionOrFactory(t)?parseExpression(t):parseSimpleReferenceExpression(t)}function parseJSONReference(t,e){const r=parseStringReference(t);if(isJSONOperator(e))return JSONReferenceNode.create(r,JSONOperatorChainNode.create(OperatorNode.create(e)));const n=e.slice(0,-1);if(isJSONOperator(n))return JSONReferenceNode.create(r,JSONPathNode.create(OperatorNode.create(n)));throw new Error(`Invalid JSON operator: ${e}`)}function parseStringReference(t){const e=".";if(!t.includes(e))return ReferenceNode.create(ColumnNode.create(t));const r=t.split(e).map(trim$2);if(r.length===3)return parseStringReferenceWithTableAndSchema(r);if(r.length===2)return parseStringReferenceWithTable(r);throw new Error(`invalid column reference ${t}`)}function parseAliasedStringReference(t){const e=" as ";if(t.includes(e)){const[r,n]=t.split(e).map(trim$2);return AliasNode.create(parseStringReference(r),IdentifierNode.create(n))}else return parseStringReference(t)}function parseColumnName(t){return ColumnNode.create(t)}function parseOrderedColumnName(t){const e=" ";if(t.includes(e)){const[r,n]=t.split(e).map(trim$2);if(!isOrderByDirection(n))throw new Error(`invalid order direction "${n}" next to "${r}"`);return parseOrderBy([r,n])[0]}else return parseColumnName(t)}function parseStringReferenceWithTableAndSchema(t){const[e,r,n]=t;return ReferenceNode.create(ColumnNode.create(n),TableNode.createWithSchema(e,r))}function parseStringReferenceWithTable(t){const[e,r]=t;return ReferenceNode.create(ColumnNode.create(r),TableNode.create(e))}function trim$2(t){return t.trim()}const PrimitiveValueListNode=freeze({is(t){return t.kind==="PrimitiveValueListNode"},create(t){return freeze({kind:"PrimitiveValueListNode",values:freeze([...t])})}}),ValueListNode=freeze({is(t){return t.kind==="ValueListNode"},create(t){return freeze({kind:"ValueListNode",values:freeze(t)})}}),ValueNode=freeze({is(t){return t.kind==="ValueNode"},create(t){return freeze({kind:"ValueNode",value:t})},createImmediate(t){return freeze({kind:"ValueNode",value:t,immediate:!0})}});function parseValueExpressionOrList(t){return isReadonlyArray(t)?parseValueExpressionList(t):parseValueExpression(t)}function parseValueExpression(t){return isExpressionOrFactory(t)?parseExpression(t):ValueNode.create(t)}function isSafeImmediateValue(t){return isNumber(t)||isBoolean(t)||isNull(t)}function parseSafeImmediateValue(t){if(!isSafeImmediateValue(t))throw new Error(`unsafe immediate value ${JSON.stringify(t)}`);return ValueNode.createImmediate(t)}function parseValueExpressionList(t){return t.some(isExpressionOrFactory)?ValueListNode.create(t.map(e=>parseValueExpression(e))):PrimitiveValueListNode.create(t)}const ParensNode=freeze({is(t){return t.kind==="ParensNode"},create(t){return freeze({kind:"ParensNode",node:t})}});function parseValueBinaryOperationOrExpression(t){if(t.length===3)return parseValueBinaryOperation(t[0],t[1],t[2]);if(t.length===1)return parseValueExpression(t[0]);throw new Error(`invalid arguments: ${JSON.stringify(t)}`)}function parseValueBinaryOperation(t,e,r){return isIsOperator(e)&&needsIsOperator(r)?BinaryOperationNode.create(parseReferenceExpression(t),parseOperator(e),ValueNode.createImmediate(r)):BinaryOperationNode.create(parseReferenceExpression(t),parseOperator(e),parseValueExpressionOrList(r))}function parseReferentialBinaryOperation(t,e,r){return BinaryOperationNode.create(parseReferenceExpression(t),parseOperator(e),parseReferenceExpression(r))}function parseFilterObject(t,e){return parseFilterList(Object.entries(t).filter(([,r])=>!isUndefined(r)).map(([r,n])=>parseValueBinaryOperation(r,needsIsOperator(n)?"is":"=",n)),e)}function parseFilterList(t,e){const r=e==="and"?AndNode.create:OrNode.create;if(t.length===0)return BinaryOperationNode.create(ValueNode.createImmediate(1),OperatorNode.create("="),ValueNode.createImmediate(e==="and"?1:0));let n=toOperationNode(t[0]);for(let s=1;s<t.length;++s)n=r(n,toOperationNode(t[s]));return t.length>1?ParensNode.create(n):n}function isIsOperator(t){return t==="is"||t==="is not"}function needsIsOperator(t){return isNull(t)||isBoolean(t)}function parseOperator(t){if(isString(t)&&OPERATORS.includes(t))return OperatorNode.create(t);if(isOperationNodeSource(t))return t.toOperationNode();throw new Error(`invalid operator ${JSON.stringify(t)}`)}function toOperationNode(t){return isOperationNodeSource(t)?t.toOperationNode():t}const OrderByNode=freeze({is(t){return t.kind==="OrderByNode"},create(t){return freeze({kind:"OrderByNode",items:freeze([...t])})},cloneWithItems(t,e){return freeze({...t,items:freeze([...t.items,...e])})}}),PartitionByNode=freeze({is(t){return t.kind==="PartitionByNode"},create(t){return freeze({kind:"PartitionByNode",items:freeze(t)})},cloneWithItems(t,e){return freeze({...t,items:freeze([...t.items,...e])})}}),OverNode=freeze({is(t){return t.kind==="OverNode"},create(){return freeze({kind:"OverNode"})},cloneWithOrderByItems(t,e){return freeze({...t,orderBy:t.orderBy?OrderByNode.cloneWithItems(t.orderBy,e):OrderByNode.create(e)})},cloneWithPartitionByItems(t,e){return freeze({...t,partitionBy:t.partitionBy?PartitionByNode.cloneWithItems(t.partitionBy,e):PartitionByNode.create(e)})}}),FromNode=freeze({is(t){return t.kind==="FromNode"},create(t){return freeze({kind:"FromNode",froms:freeze(t)})},cloneWithFroms(t,e){return freeze({...t,froms:freeze([...t.froms,...e])})}}),GroupByNode=freeze({is(t){return t.kind==="GroupByNode"},create(t){return freeze({kind:"GroupByNode",items:freeze(t)})},cloneWithItems(t,e){return freeze({...t,items:freeze([...t.items,...e])})}}),HavingNode=freeze({is(t){return t.kind==="HavingNode"},create(t){return freeze({kind:"HavingNode",having:t})},cloneWithOperation(t,e,r){return freeze({...t,having:e==="And"?AndNode.create(t.having,r):OrNode.create(t.having,r)})}}),SelectQueryNode=freeze({is(t){return t.kind==="SelectQueryNode"},create(t){return freeze({kind:"SelectQueryNode",...t&&{with:t}})},createFrom(t,e){return freeze({kind:"SelectQueryNode",from:FromNode.create(t),...e&&{with:e}})},cloneWithSelections(t,e){return freeze({...t,selections:t.selections?freeze([...t.selections,...e]):freeze(e)})},cloneWithDistinctOn(t,e){return freeze({...t,distinctOn:t.distinctOn?freeze([...t.distinctOn,...e]):freeze(e)})},cloneWithFrontModifier(t,e){return freeze({...t,frontModifiers:t.frontModifiers?freeze([...t.frontModifiers,e]):freeze([e])})},cloneWithEndModifier(t,e){return freeze({...t,endModifiers:t.endModifiers?freeze([...t.endModifiers,e]):freeze([e])})},cloneWithOrderByItems(t,e){return freeze({...t,orderBy:t.orderBy?OrderByNode.cloneWithItems(t.orderBy,e):OrderByNode.create(e)})},cloneWithGroupByItems(t,e){return freeze({...t,groupBy:t.groupBy?GroupByNode.cloneWithItems(t.groupBy,e):GroupByNode.create(e)})},cloneWithLimit(t,e){return freeze({...t,limit:e})},cloneWithOffset(t,e){return freeze({...t,offset:e})},cloneWithHaving(t,e){return freeze({...t,having:t.having?HavingNode.cloneWithOperation(t.having,"And",e):HavingNode.create(e)})},cloneWithSetOperations(t,e){return freeze({...t,setOperations:t.setOperations?freeze([...t.setOperations,...e]):freeze([...e])})},cloneWithoutSelections(t){return freeze({...t,selections:[]})},cloneWithoutLimit(t){return freeze({...t,limit:void 0})},cloneWithoutOffset(t){return freeze({...t,offset:void 0})},cloneWithoutOrderBy(t){return freeze({...t,orderBy:void 0})}});function preventAwait(t,e){Object.defineProperties(t.prototype,{then:{enumerable:!1,value:()=>{throw new Error(e)}}})}class JoinBuilder{#e;constructor(e){this.#e=freeze(e)}on(...e){return new JoinBuilder({...this.#e,joinNode:JoinNode.cloneWithOn(this.#e.joinNode,parseValueBinaryOperationOrExpression(e))})}onRef(e,r,n){return new JoinBuilder({...this.#e,joinNode:JoinNode.cloneWithOn(this.#e.joinNode,parseReferentialBinaryOperation(e,r,n))})}onTrue(){return new JoinBuilder({...this.#e,joinNode:JoinNode.cloneWithOn(this.#e.joinNode,RawNode.createWithSql("true"))})}$call(e){return e(this)}toOperationNode(){return this.#e.joinNode}}preventAwait(JoinBuilder,"don't await JoinBuilder instances. They are never executed directly and are always just a part of a query.");const PartitionByItemNode=freeze({is(t){return t.kind==="PartitionByItemNode"},create(t){return freeze({kind:"PartitionByItemNode",partitionBy:t})}});function parsePartitionBy(t){return parseReferenceExpressionOrList(t).map(PartitionByItemNode.create)}class OverBuilder{#e;constructor(e){this.#e=freeze(e)}orderBy(e,r){return new OverBuilder({overNode:OverNode.cloneWithOrderByItems(this.#e.overNode,parseOrderBy([e,r]))})}partitionBy(e){return new OverBuilder({overNode:OverNode.cloneWithPartitionByItems(this.#e.overNode,parsePartitionBy(e))})}$call(e){return e(this)}toOperationNode(){return this.#e.overNode}}preventAwait(OverBuilder,"don't await OverBuilder instances. They are never executed directly and are always just a part of a query.");const SelectionNode=freeze({is(t){return t.kind==="SelectionNode"},create(t){return freeze({kind:"SelectionNode",selection:t})},createSelectAll(){return freeze({kind:"SelectionNode",selection:SelectAllNode.create()})},createSelectAllFromTable(t){return freeze({kind:"SelectionNode",selection:ReferenceNode.createSelectAll(t)})}});function parseSelectArg(t){return isFunction(t)?parseSelectArg(t(expressionBuilder())):isReadonlyArray(t)?t.map(e=>parseSelectExpression(e)):[parseSelectExpression(t)]}function parseSelectExpression(t){return isString(t)?SelectionNode.create(parseAliasedStringReference(t)):isDynamicReferenceBuilder(t)?SelectionNode.create(t.toOperationNode()):SelectionNode.create(parseAliasedExpression(t))}function parseSelectAll(t){return t?Array.isArray(t)?t.map(parseSelectAllArg):[parseSelectAllArg(t)]:[SelectionNode.createSelectAll()]}function parseSelectAllArg(t){if(isString(t))return SelectionNode.createSelectAllFromTable(parseTable(t));throw new Error(`invalid value selectAll expression: ${JSON.stringify(t)}`)}const ValuesNode=freeze({is(t){return t.kind==="ValuesNode"},create(t){return freeze({kind:"ValuesNode",values:freeze(t)})}}),DefaultInsertValueNode=freeze({is(t){return t.kind==="DefaultInsertValueNode"},create(){return freeze({kind:"DefaultInsertValueNode"})}});function parseInsertExpression(t){const e=isFunction(t)?t(expressionBuilder()):t,r=isReadonlyArray(e)?e:freeze([e]);return parseInsertColumnsAndValues(r)}function parseInsertColumnsAndValues(t){const e=parseColumnNamesAndIndexes(t);return[freeze([...e.keys()].map(ColumnNode.create)),ValuesNode.create(t.map(r=>parseRowValues(r,e)))]}function parseColumnNamesAndIndexes(t){const e=new Map;for(const r of t){const n=Object.keys(r);for(const s of n)!e.has(s)&&r[s]!==void 0&&e.set(s,e.size)}return e}function parseRowValues(t,e){const r=Object.keys(t),n=Array.from({length:e.size});let s=!1;for(const u of r){const d=e.get(u);if(isUndefined(d))continue;const f=t[u];(isUndefined(f)||isExpressionOrFactory(f))&&(s=!0),n[d]=f}if(r.length<e.size||s){const u=DefaultInsertValueNode.create();return ValueListNode.create(n.map(d=>isUndefined(d)?u:parseValueExpression(d)))}return PrimitiveValueListNode.create(n)}const InsertQueryNode=freeze({is(t){return t.kind==="InsertQueryNode"},create(t,e,r){return freeze({kind:"InsertQueryNode",into:t,...e&&{with:e},replace:r})},cloneWith(t,e){return freeze({...t,...e})}}),UpdateQueryNode=freeze({is(t){return t.kind==="UpdateQueryNode"},create(t,e){return freeze({kind:"UpdateQueryNode",table:t,...e&&{with:e}})},cloneWithFromItems(t,e){return freeze({...t,from:t.from?FromNode.cloneWithFroms(t.from,e):FromNode.create(e)})},cloneWithUpdates(t,e){return freeze({...t,updates:t.updates?freeze([...t.updates,...e]):e})}}),UsingNode=freeze({is(t){return t.kind==="UsingNode"},create(t){return freeze({kind:"UsingNode",tables:freeze(t)})},cloneWithTables(t,e){return freeze({...t,tables:freeze([...t.tables,...e])})}}),DeleteQueryNode=freeze({is(t){return t.kind==="DeleteQueryNode"},create(t,e){return freeze({kind:"DeleteQueryNode",from:FromNode.create(t),...e&&{with:e}})},cloneWithOrderByItems(t,e){return freeze({...t,orderBy:t.orderBy?OrderByNode.cloneWithItems(t.orderBy,e):OrderByNode.create(e)})},cloneWithLimit(t,e){return freeze({...t,limit:e})},cloneWithUsing(t,e){return freeze({...t,using:t.using!==void 0?UsingNode.cloneWithTables(t.using,e):UsingNode.create(e)})}}),WhereNode=freeze({is(t){return t.kind==="WhereNode"},create(t){return freeze({kind:"WhereNode",where:t})},cloneWithOperation(t,e,r){return freeze({...t,where:e==="And"?AndNode.create(t.where,r):OrNode.create(t.where,r)})}}),ReturningNode=freeze({is(t){return t.kind==="ReturningNode"},create(t){return freeze({kind:"ReturningNode",selections:freeze(t)})},cloneWithSelections(t,e){return freeze({...t,selections:t.selections?freeze([...t.selections,...e]):freeze(e)})}}),ExplainNode=freeze({is(t){return t.kind==="ExplainNode"},create(t,e){return freeze({kind:"ExplainNode",format:t,options:e})}}),QueryNode=freeze({is(t){return SelectQueryNode.is(t)||InsertQueryNode.is(t)||UpdateQueryNode.is(t)||DeleteQueryNode.is(t)},cloneWithWhere(t,e){return freeze({...t,where:t.where?WhereNode.cloneWithOperation(t.where,"And",e):WhereNode.create(e)})},cloneWithJoin(t,e){return freeze({...t,joins:t.joins?freeze([...t.joins,e]):freeze([e])})},cloneWithReturning(t,e){return freeze({...t,returning:t.returning?ReturningNode.cloneWithSelections(t.returning,e):ReturningNode.create(e)})},cloneWithoutWhere(t){return freeze({...t,where:void 0})},cloneWithExplain(t,e,r){return freeze({...t,explain:ExplainNode.create(e,r?.toOperationNode())})}}),ColumnUpdateNode=freeze({is(t){return t.kind==="ColumnUpdateNode"},create(t,e){return freeze({kind:"ColumnUpdateNode",column:t,value:e})}});function parseUpdate(...t){return t.length===2?[ColumnUpdateNode.create(parseReferenceExpression(t[0]),parseValueExpression(t[1]))]:parseUpdateObjectExpression(t[0])}function parseUpdateObjectExpression(t){const e=isFunction(t)?t(expressionBuilder()):t;return Object.entries(e).filter(([r,n])=>n!==void 0).map(([r,n])=>ColumnUpdateNode.create(ColumnNode.create(r),parseValueExpression(n)))}const OnDuplicateKeyNode=freeze({is(t){return t.kind==="OnDuplicateKeyNode"},create(t){return freeze({kind:"OnDuplicateKeyNode",updates:t})}});class InsertResult{insertId;numInsertedOrUpdatedRows;constructor(e,r){this.insertId=e,this.numInsertedOrUpdatedRows=r}}class NoResultError extends Error{node;constructor(e){super("no result"),this.node=e}}function isNoResultErrorConstructor(t){return Object.prototype.hasOwnProperty.call(t,"prototype")}const OnConflictNode=freeze({is(t){return t.kind==="OnConflictNode"},create(){return freeze({kind:"OnConflictNode"})},cloneWith(t,e){return freeze({...t,...e})},cloneWithIndexWhere(t,e){return freeze({...t,indexWhere:t.indexWhere?WhereNode.cloneWithOperation(t.indexWhere,"And",e):WhereNode.create(e)})},cloneWithIndexOrWhere(t,e){return freeze({...t,indexWhere:t.indexWhere?WhereNode.cloneWithOperation(t.indexWhere,"Or",e):WhereNode.create(e)})},cloneWithUpdateWhere(t,e){return freeze({...t,updateWhere:t.updateWhere?WhereNode.cloneWithOperation(t.updateWhere,"And",e):WhereNode.create(e)})},cloneWithUpdateOrWhere(t,e){return freeze({...t,updateWhere:t.updateWhere?WhereNode.cloneWithOperation(t.updateWhere,"Or",e):WhereNode.create(e)})},cloneWithoutIndexWhere(t){return freeze({...t,indexWhere:void 0})},cloneWithoutUpdateWhere(t){return freeze({...t,updateWhere:void 0})}});class OnConflictBuilder{#e;constructor(e){this.#e=freeze(e)}column(e){const r=ColumnNode.create(e);return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{columns:this.#e.onConflictNode.columns?freeze([...this.#e.onConflictNode.columns,r]):freeze([r])})})}columns(e){const r=e.map(ColumnNode.create);return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{columns:this.#e.onConflictNode.columns?freeze([...this.#e.onConflictNode.columns,...r]):freeze(r)})})}constraint(e){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{constraint:IdentifierNode.create(e)})})}expression(e){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{indexExpression:e.toOperationNode()})})}where(...e){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithIndexWhere(this.#e.onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,n){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithIndexWhere(this.#e.onConflictNode,parseReferentialBinaryOperation(e,r,n))})}clearWhere(){return new OnConflictBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithoutIndexWhere(this.#e.onConflictNode)})}doNothing(){return new OnConflictDoNothingBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new OnConflictUpdateBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWith(this.#e.onConflictNode,{updates:parseUpdateObjectExpression(e)})})}$call(e){return e(this)}}preventAwait(OnConflictBuilder,"don't await OnConflictBuilder instances.");class OnConflictDoNothingBuilder{#e;constructor(e){this.#e=freeze(e)}toOperationNode(){return this.#e.onConflictNode}}preventAwait(OnConflictDoNothingBuilder,"don't await OnConflictDoNothingBuilder instances.");class OnConflictUpdateBuilder{#e;constructor(e){this.#e=freeze(e)}where(...e){return new OnConflictUpdateBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithUpdateWhere(this.#e.onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,n){return new OnConflictUpdateBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithUpdateWhere(this.#e.onConflictNode,parseReferentialBinaryOperation(e,r,n))})}clearWhere(){return new OnConflictUpdateBuilder({...this.#e,onConflictNode:OnConflictNode.cloneWithoutUpdateWhere(this.#e.onConflictNode)})}$call(e){return e(this)}toOperationNode(){return this.#e.onConflictNode}}preventAwait(OnConflictUpdateBuilder,"don't await OnConflictUpdateBuilder instances.");class InsertQueryBuilder{#e;constructor(e){this.#e=freeze(e)}values(e){const[r,n]=parseInsertExpression(e);return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{columns:r,values:n})})}columns(e){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{columns:freeze(e.map(ColumnNode.create))})})}expression(e){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{values:parseExpression(e)})})}defaultValues(){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{defaultValues:!0})})}ignore(){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{ignore:!0})})}onConflict(e){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{onConflict:e(new OnConflictBuilder({onConflictNode:OnConflictNode.create()})).toOperationNode()})})}onDuplicateKeyUpdate(e){return new InsertQueryBuilder({...this.#e,queryNode:InsertQueryNode.cloneWith(this.#e.queryNode,{onDuplicateKey:OnDuplicateKeyNode.create(parseUpdateObjectExpression(e))})})}returning(e){return new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectArg(e))})}returningAll(){return new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectAll())})}$call(e){return e(this)}$if(e,r){return e?r(this):new InsertQueryBuilder({...this.#e})}$castTo(){return new InsertQueryBuilder(this.#e)}$narrowType(){return new InsertQueryBuilder(this.#e)}$assertType(){return new InsertQueryBuilder(this.#e)}withPlugin(e){return new InsertQueryBuilder({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),r=e.query,n=await this.#e.executor.executeQuery(e,this.#e.queryId);return this.#e.executor.adapter.supportsReturning&&r.returning?n.rows:[new InsertResult(n.insertId,n.numAffectedRows??n.numUpdatedOrDeletedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const r=await this.executeTakeFirst();if(r===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return r}async*stream(e=100){const r=this.compile(),n=this.#e.executor.stream(r,e,this.#e.queryId);for await(const s of n)yield*s.rows}async explain(e,r){return await new InsertQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithExplain(this.#e.queryNode,e,r)}).execute()}}preventAwait(InsertQueryBuilder,"don't await InsertQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");class DeleteResult{numDeletedRows;constructor(e){this.numDeletedRows=e}}const LimitNode=freeze({is(t){return t.kind==="LimitNode"},create(t){return freeze({kind:"LimitNode",limit:t})}});class DeleteQueryBuilder{#e;constructor(e){this.#e=freeze(e)}where(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,n){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseReferentialBinaryOperation(e,r,n))})}clearWhere(){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithoutWhere(this.#e.queryNode)})}using(e){return new DeleteQueryBuilder({...this.#e,queryNode:DeleteQueryNode.cloneWithUsing(this.#e.queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("FullJoin",e))})}returning(e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectArg(e))})}returningAll(e){return new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectAll(e))})}orderBy(e,r){return new DeleteQueryBuilder({...this.#e,queryNode:DeleteQueryNode.cloneWithOrderByItems(this.#e.queryNode,parseOrderBy([e,r]))})}limit(e){return new DeleteQueryBuilder({...this.#e,queryNode:DeleteQueryNode.cloneWithLimit(this.#e.queryNode,LimitNode.create(parseValueExpression(e)))})}$call(e){return e(this)}$if(e,r){return e?r(this):new DeleteQueryBuilder({...this.#e})}$castTo(){return new DeleteQueryBuilder(this.#e)}$narrowType(){return new DeleteQueryBuilder(this.#e)}$assertType(){return new DeleteQueryBuilder(this.#e)}withPlugin(e){return new DeleteQueryBuilder({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),r=e.query,n=await this.#e.executor.executeQuery(e,this.#e.queryId);return this.#e.executor.adapter.supportsReturning&&r.returning?n.rows:[new DeleteResult(n.numAffectedRows??n.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const r=await this.executeTakeFirst();if(r===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return r}async*stream(e=100){const r=this.compile(),n=this.#e.executor.stream(r,e,this.#e.queryId);for await(const s of n)yield*s.rows}async explain(e,r){return await new DeleteQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithExplain(this.#e.queryNode,e,r)}).execute()}}preventAwait(DeleteQueryBuilder,"don't await DeleteQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");class UpdateResult{numUpdatedRows;numChangedRows;constructor(e,r){this.numUpdatedRows=e,this.numChangedRows=r}}class UpdateQueryBuilder{#e;constructor(e){this.#e=freeze(e)}where(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,n){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseReferentialBinaryOperation(e,r,n))})}clearWhere(){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithoutWhere(this.#e.queryNode)})}from(e){return new UpdateQueryBuilder({...this.#e,queryNode:UpdateQueryNode.cloneWithFromItems(this.#e.queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("FullJoin",e))})}set(...e){return new UpdateQueryBuilder({...this.#e,queryNode:UpdateQueryNode.cloneWithUpdates(this.#e.queryNode,parseUpdate(...e))})}returning(e){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectArg(e))})}returningAll(){return new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithReturning(this.#e.queryNode,parseSelectAll())})}$call(e){return e(this)}$if(e,r){return e?r(this):new UpdateQueryBuilder({...this.#e})}$castTo(){return new UpdateQueryBuilder(this.#e)}$narrowType(){return new UpdateQueryBuilder(this.#e)}$assertType(){return new UpdateQueryBuilder(this.#e)}withPlugin(e){return new UpdateQueryBuilder({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),r=e.query,n=await this.#e.executor.executeQuery(e,this.#e.queryId);return this.#e.executor.adapter.supportsReturning&&r.returning?n.rows:[new UpdateResult(n.numAffectedRows??n.numUpdatedOrDeletedRows??BigInt(0),n.numChangedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const r=await this.executeTakeFirst();if(r===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return r}async*stream(e=100){const r=this.compile(),n=this.#e.executor.stream(r,e,this.#e.queryId);for await(const s of n)yield*s.rows}async explain(e,r){return await new UpdateQueryBuilder({...this.#e,queryNode:QueryNode.cloneWithExplain(this.#e.queryNode,e,r)}).execute()}}preventAwait(UpdateQueryBuilder,"don't await UpdateQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");const CommonTableExpressionNameNode=freeze({is(t){return t.kind==="CommonTableExpressionNameNode"},create(t,e){return freeze({kind:"CommonTableExpressionNameNode",table:TableNode.create(t),columns:e?freeze(e.map(ColumnNode.create)):void 0})}}),CommonTableExpressionNode=freeze({is(t){return t.kind==="CommonTableExpressionNode"},create(t,e){return freeze({kind:"CommonTableExpressionNode",name:t,expression:e})},cloneWith(t,e){return freeze({...t,...e})}});class CTEBuilder{#e;constructor(e){this.#e=freeze(e)}materialized(){return new CTEBuilder({...this.#e,node:CommonTableExpressionNode.cloneWith(this.#e.node,{materialized:!0})})}notMaterialized(){return new CTEBuilder({...this.#e,node:CommonTableExpressionNode.cloneWith(this.#e.node,{materialized:!1})})}toOperationNode(){return this.#e.node}}preventAwait(CTEBuilder,"don't await CTEBuilder instances. They are never executed directly and are always just a part of a query.");function parseCommonTableExpression(t,e){const r=e(createQueryCreator()).toOperationNode();return isFunction(t)?t(cteBuilderFactory(r)).toOperationNode():CommonTableExpressionNode.create(parseCommonTableExpressionName(t),r)}function cteBuilderFactory(t){return e=>new CTEBuilder({node:CommonTableExpressionNode.create(parseCommonTableExpressionName(e),t)})}function parseCommonTableExpressionName(t){if(t.includes("(")){const e=t.split(/[\(\)]/),r=e[0],n=e[1].split(",").map(s=>s.trim());return CommonTableExpressionNameNode.create(r,n)}else return CommonTableExpressionNameNode.create(t)}const WithNode=freeze({is(t){return t.kind==="WithNode"},create(t,e){return freeze({kind:"WithNode",expressions:freeze([t]),...e})},cloneWithExpression(t,e){return freeze({...t,expressions:freeze([...t.expressions,e])})}}),CHARS=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];function randomString(t){let e="";for(let r=0;r<t;++r)e+=randomChar();return e}function randomChar(){return CHARS[~~(Math.random()*CHARS.length)]}function createQueryId(){return new LazyQueryId}class LazyQueryId{#e;get queryId(){return this.#e===void 0&&(this.#e=randomString(8)),this.#e}}function requireAllProps(t){return t}class OperationNodeTransformer{nodeStack=[];#e=freeze({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this),JSONReferenceNode:this.transformJSONReference.bind(this),JSONPathNode:this.transformJSONPath.bind(this),JSONPathLegNode:this.transformJSONPathLeg.bind(this),JSONOperatorChainNode:this.transformJSONOperatorChain.bind(this),TupleNode:this.transformTuple.bind(this),AddIndexNode:this.transformAddIndex.bind(this)});transformNode(e){if(!e)return e;this.nodeStack.push(e);const r=this.transformNodeImpl(e);return this.nodeStack.pop(),freeze(r)}transformNodeImpl(e){return this.#e[e.kind](e)}transformNodeList(e){return e&&freeze(e.map(r=>this.transformNode(r)))}transformSelectQuery(e){return{kind:"SelectQueryNode",from:this.transformNode(e.from),selections:this.transformNodeList(e.selections),distinctOn:this.transformNodeList(e.distinctOn),joins:this.transformNodeList(e.joins),groupBy:this.transformNode(e.groupBy),orderBy:this.transformNode(e.orderBy),where:this.transformNode(e.where),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),limit:this.transformNode(e.limit),offset:this.transformNode(e.offset),with:this.transformNode(e.with),having:this.transformNode(e.having),explain:this.transformNode(e.explain),setOperations:this.transformNodeList(e.setOperations)}}transformSelection(e){return{kind:"SelectionNode",selection:this.transformNode(e.selection)}}transformColumn(e){return{kind:"ColumnNode",column:this.transformNode(e.column)}}transformAlias(e){return{kind:"AliasNode",node:this.transformNode(e.node),alias:this.transformNode(e.alias)}}transformTable(e){return{kind:"TableNode",table:this.transformNode(e.table)}}transformFrom(e){return{kind:"FromNode",froms:this.transformNodeList(e.froms)}}transformReference(e){return{kind:"ReferenceNode",column:this.transformNode(e.column),table:this.transformNode(e.table)}}transformAnd(e){return{kind:"AndNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformOr(e){return{kind:"OrNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformValueList(e){return{kind:"ValueListNode",values:this.transformNodeList(e.values)}}transformParens(e){return{kind:"ParensNode",node:this.transformNode(e.node)}}transformJoin(e){return{kind:"JoinNode",joinType:e.joinType,table:this.transformNode(e.table),on:this.transformNode(e.on)}}transformRaw(e){return{kind:"RawNode",sqlFragments:freeze([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters)}}transformWhere(e){return{kind:"WhereNode",where:this.transformNode(e.where)}}transformInsertQuery(e){return{kind:"InsertQueryNode",into:this.transformNode(e.into),columns:this.transformNodeList(e.columns),values:this.transformNode(e.values),returning:this.transformNode(e.returning),onConflict:this.transformNode(e.onConflict),onDuplicateKey:this.transformNode(e.onDuplicateKey),with:this.transformNode(e.with),ignore:e.ignore,replace:e.replace,explain:this.transformNode(e.explain),defaultValues:e.defaultValues}}transformValues(e){return{kind:"ValuesNode",values:this.transformNodeList(e.values)}}transformDeleteQuery(e){return{kind:"DeleteQueryNode",from:this.transformNode(e.from),using:this.transformNode(e.using),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),returning:this.transformNode(e.returning),with:this.transformNode(e.with),orderBy:this.transformNode(e.orderBy),limit:this.transformNode(e.limit),explain:this.transformNode(e.explain)}}transformReturning(e){return{kind:"ReturningNode",selections:this.transformNodeList(e.selections)}}transformCreateTable(e){return{kind:"CreateTableNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),constraints:this.transformNodeList(e.constraints),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),selectQuery:this.transformNode(e.selectQuery)}}transformColumnDefinition(e){return{kind:"ColumnDefinitionNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),references:this.transformNode(e.references),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo),check:this.transformNode(e.check),generated:this.transformNode(e.generated),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),nullsNotDistinct:e.nullsNotDistinct}}transformAddColumn(e){return{kind:"AddColumnNode",column:this.transformNode(e.column)}}transformDropTable(e){return{kind:"DropTableNode",table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformOrderBy(e){return{kind:"OrderByNode",items:this.transformNodeList(e.items)}}transformOrderByItem(e){return{kind:"OrderByItemNode",orderBy:this.transformNode(e.orderBy),direction:this.transformNode(e.direction)}}transformGroupBy(e){return{kind:"GroupByNode",items:this.transformNodeList(e.items)}}transformGroupByItem(e){return{kind:"GroupByItemNode",groupBy:this.transformNode(e.groupBy)}}transformUpdateQuery(e){return{kind:"UpdateQueryNode",table:this.transformNode(e.table),from:this.transformNode(e.from),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),updates:this.transformNodeList(e.updates),returning:this.transformNode(e.returning),with:this.transformNode(e.with),explain:this.transformNode(e.explain)}}transformColumnUpdate(e){return{kind:"ColumnUpdateNode",column:this.transformNode(e.column),value:this.transformNode(e.value)}}transformLimit(e){return{kind:"LimitNode",limit:this.transformNode(e.limit)}}transformOffset(e){return{kind:"OffsetNode",offset:this.transformNode(e.offset)}}transformOnConflict(e){return{kind:"OnConflictNode",columns:this.transformNodeList(e.columns),constraint:this.transformNode(e.constraint),indexExpression:this.transformNode(e.indexExpression),indexWhere:this.transformNode(e.indexWhere),updates:this.transformNodeList(e.updates),updateWhere:this.transformNode(e.updateWhere),doNothing:e.doNothing}}transformOnDuplicateKey(e){return{kind:"OnDuplicateKeyNode",updates:this.transformNodeList(e.updates)}}transformCreateIndex(e){return{kind:"CreateIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists,where:this.transformNode(e.where),nullsNotDistinct:e.nullsNotDistinct}}transformList(e){return{kind:"ListNode",items:this.transformNodeList(e.items)}}transformDropIndex(e){return{kind:"DropIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformPrimaryKeyConstraint(e){return{kind:"PrimaryKeyConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)}}transformUniqueConstraint(e){return{kind:"UniqueConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name),nullsNotDistinct:e.nullsNotDistinct}}transformForeignKeyConstraint(e){return{kind:"ForeignKeyConstraintNode",columns:this.transformNodeList(e.columns),references:this.transformNode(e.references),name:this.transformNode(e.name),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformSetOperation(e){return{kind:"SetOperationNode",operator:e.operator,expression:this.transformNode(e.expression),all:e.all}}transformReferences(e){return{kind:"ReferencesNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformCheckConstraint(e){return{kind:"CheckConstraintNode",expression:this.transformNode(e.expression),name:this.transformNode(e.name)}}transformWith(e){return{kind:"WithNode",expressions:this.transformNodeList(e.expressions),recursive:e.recursive}}transformCommonTableExpression(e){return{kind:"CommonTableExpressionNode",name:this.transformNode(e.name),materialized:e.materialized,expression:this.transformNode(e.expression)}}transformCommonTableExpressionName(e){return{kind:"CommonTableExpressionNameNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns)}}transformHaving(e){return{kind:"HavingNode",having:this.transformNode(e.having)}}transformCreateSchema(e){return{kind:"CreateSchemaNode",schema:this.transformNode(e.schema),ifNotExists:e.ifNotExists}}transformDropSchema(e){return{kind:"DropSchemaNode",schema:this.transformNode(e.schema),ifExists:e.ifExists,cascade:e.cascade}}transformAlterTable(e){return{kind:"AlterTableNode",table:this.transformNode(e.table),renameTo:this.transformNode(e.renameTo),setSchema:this.transformNode(e.setSchema),columnAlterations:this.transformNodeList(e.columnAlterations),addConstraint:this.transformNode(e.addConstraint),dropConstraint:this.transformNode(e.dropConstraint),addIndex:this.transformNode(e.addIndex),dropIndex:this.transformNode(e.dropIndex)}}transformDropColumn(e){return{kind:"DropColumnNode",column:this.transformNode(e.column)}}transformRenameColumn(e){return{kind:"RenameColumnNode",column:this.transformNode(e.column),renameTo:this.transformNode(e.renameTo)}}transformAlterColumn(e){return{kind:"AlterColumnNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),dataTypeExpression:this.transformNode(e.dataTypeExpression),setDefault:this.transformNode(e.setDefault),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull}}transformModifyColumn(e){return{kind:"ModifyColumnNode",column:this.transformNode(e.column)}}transformAddConstraint(e){return{kind:"AddConstraintNode",constraint:this.transformNode(e.constraint)}}transformDropConstraint(e){return{kind:"DropConstraintNode",constraintName:this.transformNode(e.constraintName),ifExists:e.ifExists,modifier:e.modifier}}transformCreateView(e){return{kind:"CreateViewNode",name:this.transformNode(e.name),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns),as:this.transformNode(e.as)}}transformDropView(e){return{kind:"DropViewNode",name:this.transformNode(e.name),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade}}transformGenerated(e){return{kind:"GeneratedNode",byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression)}}transformDefaultValue(e){return{kind:"DefaultValueNode",defaultValue:this.transformNode(e.defaultValue)}}transformOn(e){return{kind:"OnNode",on:this.transformNode(e.on)}}transformSelectModifier(e){return{kind:"SelectModifierNode",modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier),of:this.transformNodeList(e.of)}}transformCreateType(e){return{kind:"CreateTypeNode",name:this.transformNode(e.name),enum:this.transformNode(e.enum)}}transformDropType(e){return{kind:"DropTypeNode",name:this.transformNode(e.name),ifExists:e.ifExists}}transformExplain(e){return{kind:"ExplainNode",format:e.format,options:this.transformNode(e.options)}}transformSchemableIdentifier(e){return{kind:"SchemableIdentifierNode",schema:this.transformNode(e.schema),identifier:this.transformNode(e.identifier)}}transformAggregateFunction(e){return{kind:"AggregateFunctionNode",aggregated:this.transformNodeList(e.aggregated),distinct:e.distinct,filter:this.transformNode(e.filter),func:e.func,over:this.transformNode(e.over)}}transformOver(e){return{kind:"OverNode",orderBy:this.transformNode(e.orderBy),partitionBy:this.transformNode(e.partitionBy)}}transformPartitionBy(e){return{kind:"PartitionByNode",items:this.transformNodeList(e.items)}}transformPartitionByItem(e){return{kind:"PartitionByItemNode",partitionBy:this.transformNode(e.partitionBy)}}transformBinaryOperation(e){return{kind:"BinaryOperationNode",leftOperand:this.transformNode(e.leftOperand),operator:this.transformNode(e.operator),rightOperand:this.transformNode(e.rightOperand)}}transformUnaryOperation(e){return{kind:"UnaryOperationNode",operator:this.transformNode(e.operator),operand:this.transformNode(e.operand)}}transformUsing(e){return{kind:"UsingNode",tables:this.transformNodeList(e.tables)}}transformFunction(e){return{kind:"FunctionNode",func:e.func,arguments:this.transformNodeList(e.arguments)}}transformCase(e){return{kind:"CaseNode",value:this.transformNode(e.value),when:this.transformNodeList(e.when),else:this.transformNode(e.else),isStatement:e.isStatement}}transformWhen(e){return{kind:"WhenNode",condition:this.transformNode(e.condition),result:this.transformNode(e.result)}}transformJSONReference(e){return{kind:"JSONReferenceNode",reference:this.transformNode(e.reference),traversal:this.transformNode(e.traversal)}}transformJSONPath(e){return{kind:"JSONPathNode",inOperator:this.transformNode(e.inOperator),pathLegs:this.transformNodeList(e.pathLegs)}}transformJSONPathLeg(e){return{kind:"JSONPathLegNode",type:e.type,value:e.value}}transformJSONOperatorChain(e){return{kind:"JSONOperatorChainNode",operator:this.transformNode(e.operator),values:this.transformNodeList(e.values)}}transformTuple(e){return{kind:"TupleNode",values:this.transformNodeList(e.values)}}transformAddIndex(e){return{kind:"AddIndexNode",name:this.transformNode(e.name),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists}}transformDataType(e){return e}transformSelectAll(e){return e}transformIdentifier(e){return e}transformValue(e){return e}transformPrimitiveValueList(e){return e}transformOperator(e){return e}transformDefaultInsertValue(e){return e}}const ROOT_OPERATION_NODES=freeze({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0});class WithSchemaTransformer extends OperationNodeTransformer{#e;#t=new Set;#r=new Set;constructor(e){super(),this.#e=e}transformNodeImpl(e){if(!this.#n(e))return super.transformNodeImpl(e);const r=this.#s(e);for(const a of r)this.#r.add(a);const n=this.#i(e);for(const a of n)this.#t.add(a);const s=super.transformNodeImpl(e);for(const a of n)this.#t.delete(a);for(const a of r)this.#r.delete(a);return s}transformSchemableIdentifier(e){const r=super.transformSchemableIdentifier(e);return r.schema||!this.#t.has(e.identifier.name)?r:{...r,schema:IdentifierNode.create(this.#e)}}transformReferences(e){const r=super.transformReferences(e);return r.table.table.schema?r:{...r,table:TableNode.createWithSchema(this.#e,r.table.table.identifier.name)}}#n(e){return e.kind in ROOT_OPERATION_NODES}#i(e){const r=new Set;if("name"in e&&e.name&&SchemableIdentifierNode.is(e.name)&&this.#a(e.name,r),"from"in e&&e.from)for(const n of e.from.froms)this.#o(n,r);if("into"in e&&e.into&&this.#o(e.into,r),"table"in e&&e.table&&this.#o(e.table,r),"joins"in e&&e.joins)for(const n of e.joins)this.#o(n.table,r);return r}#s(e){const r=new Set;return"with"in e&&e.with&&this.#u(e.with,r),r}#o(e,r){const n=TableNode.is(e)?e:AliasNode.is(e)&&TableNode.is(e.node)?e.node:null;n&&this.#a(n.table,r)}#a(e,r){const n=e.identifier.name;!this.#t.has(n)&&!this.#r.has(n)&&r.add(n)}#u(e,r){for(const n of e.expressions){const s=n.name.table.table.identifier.name;this.#r.has(s)||r.add(s)}}}class WithSchemaPlugin{#e;constructor(e){this.#e=new WithSchemaTransformer(e)}transformQuery(e){return this.#e.transformNode(e.node)}async transformResult(e){return e.result}}class QueryCreator{#e;constructor(e){this.#e=freeze(e)}selectFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:SelectQueryNode.createFrom(parseTableExpressionOrList(e),this.#e.withNode)})}selectNoFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:SelectQueryNode.cloneWithSelections(SelectQueryNode.create(this.#e.withNode),parseSelectArg(e))})}insertInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:InsertQueryNode.create(parseTable(e),this.#e.withNode)})}replaceInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:InsertQueryNode.create(parseTable(e),this.#e.withNode,!0)})}deleteFrom(e){return new DeleteQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:DeleteQueryNode.create(parseTableExpressionOrList(e),this.#e.withNode)})}updateTable(e){return new UpdateQueryBuilder({queryId:createQueryId(),executor:this.#e.executor,queryNode:UpdateQueryNode.create(parseTableExpression(e),this.#e.withNode)})}with(e,r){const n=parseCommonTableExpression(e,r);return new QueryCreator({...this.#e,withNode:this.#e.withNode?WithNode.cloneWithExpression(this.#e.withNode,n):WithNode.create(n)})}withRecursive(e,r){const n=parseCommonTableExpression(e,r);return new QueryCreator({...this.#e,withNode:this.#e.withNode?WithNode.cloneWithExpression(this.#e.withNode,n):WithNode.create(n,{recursive:!0})})}withPlugin(e){return new QueryCreator({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new QueryCreator({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new QueryCreator({...this.#e,executor:this.#e.executor.withPluginAtFront(new WithSchemaPlugin(e))})}}class Deferred{#e;#t;#r;constructor(){this.#e=new Promise((e,r)=>{this.#r=r,this.#t=e})}get promise(){return this.#e}resolve=e=>{this.#t&&this.#t(e)};reject=e=>{this.#r&&this.#r(e)}}const LOGGED_MESSAGES=new Set;function logOnce(t){LOGGED_MESSAGES.has(t)||(LOGGED_MESSAGES.add(t),console.log(t))}const NO_PLUGINS=freeze([]);class QueryExecutorBase{#e;constructor(e=NO_PLUGINS){this.#e=e}get plugins(){return this.#e}transformQuery(e,r){for(const n of this.#e){const s=n.transformQuery({node:e,queryId:r});if(s.kind===e.kind)e=s;else throw new Error(["KyselyPlugin.transformQuery must return a node","of the same kind that was given to it.",`The plugin was given a ${e.kind}`,`but it returned a ${s.kind}`].join(" "))}return e}async executeQuery(e,r){return await this.provideConnection(async n=>{const s=await n.executeQuery(e),a=await this.#t(s,r);return warnOfOutdatedDriverOrPlugins(s,a),a})}async*stream(e,r,n){const s=new Deferred,a=new Deferred;this.provideConnection(async d=>(s.resolve(d),await a.promise)).catch(d=>s.reject(d));const u=await s.promise;try{for await(const d of u.streamQuery(e,r))yield await this.#t(d,n)}finally{a.resolve()}}async#t(e,r){for(const n of this.#e)e=await n.transformResult({result:e,queryId:r});return e}}function warnOfOutdatedDriverOrPlugins(t,e){const{numAffectedRows:r}=t;r===void 0&&t.numUpdatedOrDeletedRows===void 0||r!==void 0&&e.numAffectedRows!==void 0||logOnce("kysely:warning: outdated driver/plugin detected! QueryResult.numUpdatedOrDeletedRows is deprecated and will be removed in a future release.")}class NoopQueryExecutor extends QueryExecutorBase{get adapter(){throw new Error("this query cannot be compiled to SQL")}compileQuery(){throw new Error("this query cannot be compiled to SQL")}provideConnection(){throw new Error("this query cannot be executed")}withConnectionProvider(){throw new Error("this query cannot have a connection provider")}withPlugin(e){return new NoopQueryExecutor([...this.plugins,e])}withPlugins(e){return new NoopQueryExecutor([...this.plugins,...e])}withPluginAtFront(e){return new NoopQueryExecutor([e,...this.plugins])}withoutPlugins(){return new NoopQueryExecutor([])}}const NOOP_QUERY_EXECUTOR=new NoopQueryExecutor;function createQueryCreator(){return new QueryCreator({executor:NOOP_QUERY_EXECUTOR})}function createJoinBuilder(t,e){return new JoinBuilder({joinNode:JoinNode.create(t,parseTableExpression(e))})}function createOverBuilder(){return new OverBuilder({overNode:OverNode.create()})}function parseJoin(t,e){if(e.length===3)return parseSingleOnJoin(t,e[0],e[1],e[2]);if(e.length===2)return parseCallbackJoin(t,e[0],e[1]);throw new Error("not implemented")}function parseCallbackJoin(t,e,r){return r(createJoinBuilder(t,e)).toOperationNode()}function parseSingleOnJoin(t,e,r,n){return JoinNode.createWithOn(t,parseTableExpression(e),parseReferentialBinaryOperation(r,"=",n))}const OffsetNode=freeze({is(t){return t.kind==="OffsetNode"},create(t){return freeze({kind:"OffsetNode",offset:t})}}),GroupByItemNode=freeze({is(t){return t.kind==="GroupByItemNode"},create(t){return freeze({kind:"GroupByItemNode",groupBy:t})}});function parseGroupBy(t){return t=isFunction(t)?t(expressionBuilder()):t,parseReferenceExpressionOrList(t).map(GroupByItemNode.create)}const SetOperationNode=freeze({is(t){return t.kind==="SetOperationNode"},create(t,e,r){return freeze({kind:"SetOperationNode",operator:t,expression:e,all:r})}});function parseSetOperations(t,e,r){return isFunction(e)&&(e=e(createExpressionBuilder())),isReadonlyArray(e)||(e=[e]),e.map(n=>SetOperationNode.create(t,parseExpression(n),r))}class ExpressionWrapper{#e;constructor(e){this.#e=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new OrWrapper(OrNode.create(this.#e,parseValueBinaryOperationOrExpression(e)))}and(...e){return new AndWrapper(AndNode.create(this.#e,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new ExpressionWrapper(this.#e)}$notNull(){return new ExpressionWrapper(this.#e)}toOperationNode(){return this.#e}}class AliasedExpressionWrapper{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),isOperationNodeSource(this.#t)?this.#t.toOperationNode():IdentifierNode.create(this.#t))}}class OrWrapper{#e;constructor(e){this.#e=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new OrWrapper(OrNode.create(this.#e,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new OrWrapper(this.#e)}toOperationNode(){return ParensNode.create(this.#e)}}class AndWrapper{#e;constructor(e){this.#e=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}and(...e){return new AndWrapper(AndNode.create(this.#e,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new AndWrapper(this.#e)}toOperationNode(){return ParensNode.create(this.#e)}}class SelectQueryBuilderImpl{#e;constructor(e){this.#e=freeze(e)}get expressionType(){}get isSelectQueryBuilder(){return!0}where(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,r,n){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithWhere(this.#e.queryNode,parseReferentialBinaryOperation(e,r,n))})}having(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithHaving(this.#e.queryNode,parseValueBinaryOperationOrExpression(e))})}havingRef(e,r,n){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithHaving(this.#e.queryNode,parseReferentialBinaryOperation(e,r,n))})}select(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSelections(this.#e.queryNode,parseSelectArg(e))})}distinctOn(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithDistinctOn(this.#e.queryNode,parseReferenceExpressionOrList(e))})}modifyFront(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithFrontModifier(this.#e.queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}modifyEnd(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}distinct(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithFrontModifier(this.#e.queryNode,SelectModifierNode.create("Distinct"))})}forUpdate(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("ForUpdate",e?asArray(e).map(parseTable):void 0))})}forShare(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("ForShare",e?asArray(e).map(parseTable):void 0))})}forKeyShare(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("ForKeyShare",e?asArray(e).map(parseTable):void 0))})}forNoKeyUpdate(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("ForNoKeyUpdate",e?asArray(e).map(parseTable):void 0))})}skipLocked(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("SkipLocked"))})}noWait(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithEndModifier(this.#e.queryNode,SelectModifierNode.create("NoWait"))})}selectAll(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSelections(this.#e.queryNode,parseSelectAll(e))})}innerJoin(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("FullJoin",e))})}innerJoinLateral(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LateralInnerJoin",e))})}leftJoinLateral(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithJoin(this.#e.queryNode,parseJoin("LateralLeftJoin",e))})}orderBy(...e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithOrderByItems(this.#e.queryNode,parseOrderBy(e))})}groupBy(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithGroupByItems(this.#e.queryNode,parseGroupBy(e))})}limit(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithLimit(this.#e.queryNode,LimitNode.create(parseValueExpression(e)))})}offset(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithOffset(this.#e.queryNode,OffsetNode.create(parseValueExpression(e)))})}union(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("union",e,!1))})}unionAll(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("union",e,!0))})}intersect(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("intersect",e,!1))})}intersectAll(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("intersect",e,!0))})}except(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("except",e,!1))})}exceptAll(e){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithSetOperations(this.#e.queryNode,parseSetOperations("except",e,!0))})}as(e){return new AliasedSelectQueryBuilderImpl(this,e)}clearSelect(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithoutSelections(this.#e.queryNode)})}clearWhere(){return new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithoutWhere(this.#e.queryNode)})}clearLimit(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithoutLimit(this.#e.queryNode)})}clearOffset(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithoutOffset(this.#e.queryNode)})}clearOrderBy(){return new SelectQueryBuilderImpl({...this.#e,queryNode:SelectQueryNode.cloneWithoutOrderBy(this.#e.queryNode)})}$call(e){return e(this)}$if(e,r){return e?r(this):new SelectQueryBuilderImpl({...this.#e})}$castTo(){return new SelectQueryBuilderImpl(this.#e)}$narrowType(){return new SelectQueryBuilderImpl(this.#e)}$assertType(){return new SelectQueryBuilderImpl(this.#e)}$asTuple(){return new ExpressionWrapper(this.toOperationNode())}withPlugin(e){return new SelectQueryBuilderImpl({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile();return(await this.#e.executor.executeQuery(e,this.#e.queryId)).rows}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const r=await this.executeTakeFirst();if(r===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return r}async*stream(e=100){const r=this.compile(),n=this.#e.executor.stream(r,e,this.#e.queryId);for await(const s of n)yield*s.rows}async explain(e,r){return await new SelectQueryBuilderImpl({...this.#e,queryNode:QueryNode.cloneWithExplain(this.#e.queryNode,e,r)}).execute()}}preventAwait(SelectQueryBuilderImpl,"don't await SelectQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");function createSelectQueryBuilder(t){return new SelectQueryBuilderImpl(t)}class AliasedSelectQueryBuilderImpl{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}get isAliasedSelectQueryBuilder(){return!0}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),IdentifierNode.create(this.#t))}}preventAwait(AliasedSelectQueryBuilderImpl,"don't await AliasedSelectQueryBuilder instances directly. AliasedSelectQueryBuilder should never be executed directly since it's always a part of another query.");const AggregateFunctionNode=freeze({is(t){return t.kind==="AggregateFunctionNode"},create(t,e=[]){return freeze({kind:"AggregateFunctionNode",func:t,aggregated:e})},cloneWithDistinct(t){return freeze({...t,distinct:!0})},cloneWithFilter(t,e){return freeze({...t,filter:t.filter?WhereNode.cloneWithOperation(t.filter,"And",e):WhereNode.create(e)})},cloneWithOrFilter(t,e){return freeze({...t,filter:t.filter?WhereNode.cloneWithOperation(t.filter,"Or",e):WhereNode.create(e)})},cloneWithOver(t,e){return freeze({...t,over:e})}}),FunctionNode=freeze({is(t){return t.kind==="FunctionNode"},create(t,e){return freeze({kind:"FunctionNode",func:t,arguments:e})}});class AggregateFunctionBuilder{#e;constructor(e){this.#e=freeze(e)}get expressionType(){}as(e){return new AliasedAggregateFunctionBuilder(this,e)}distinct(){return new AggregateFunctionBuilder({...this.#e,aggregateFunctionNode:AggregateFunctionNode.cloneWithDistinct(this.#e.aggregateFunctionNode)})}filterWhere(...e){return new AggregateFunctionBuilder({...this.#e,aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(this.#e.aggregateFunctionNode,parseValueBinaryOperationOrExpression(e))})}filterWhereRef(e,r,n){return new AggregateFunctionBuilder({...this.#e,aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(this.#e.aggregateFunctionNode,parseReferentialBinaryOperation(e,r,n))})}over(e){const r=createOverBuilder();return new AggregateFunctionBuilder({...this.#e,aggregateFunctionNode:AggregateFunctionNode.cloneWithOver(this.#e.aggregateFunctionNode,(e?e(r):r).toOperationNode())})}$call(e){return e(this)}$castTo(){return new AggregateFunctionBuilder(this.#e)}$notNull(){return new AggregateFunctionBuilder(this.#e)}toOperationNode(){return this.#e.aggregateFunctionNode}}preventAwait(AggregateFunctionBuilder,"don't await AggregateFunctionBuilder instances. They are never executed directly and are always just a part of a query.");class AliasedAggregateFunctionBuilder{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),IdentifierNode.create(this.#t))}}function createFunctionModule(){const t=(r,n)=>new ExpressionWrapper(FunctionNode.create(r,parseReferenceExpressionOrList(n??[]))),e=(r,n)=>new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create(r,n?parseReferenceExpressionOrList(n):void 0)});return Object.assign(t,{agg:e,avg(r){return e("avg",[r])},coalesce(...r){return t("coalesce",r)},count(r){return e("count",[r])},countAll(r){return new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create("count",parseSelectAll(r))})},max(r){return e("max",[r])},min(r){return e("min",[r])},sum(r){return e("sum",[r])},any(r){return t("any",[r])},jsonAgg(r){return new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create("json_agg",[isString(r)?parseTable(r):r.toOperationNode()])})},toJson(r){return new ExpressionWrapper(FunctionNode.create("to_json",[isString(r)?parseTable(r):r.toOperationNode()]))}})}const UnaryOperationNode=freeze({is(t){return t.kind==="UnaryOperationNode"},create(t,e){return freeze({kind:"UnaryOperationNode",operator:t,operand:e})}});function parseUnaryOperation(t,e){return UnaryOperationNode.create(OperatorNode.create(t),parseReferenceExpression(e))}const WhenNode=freeze({is(t){return t.kind==="WhenNode"},create(t){return freeze({kind:"WhenNode",condition:t})},cloneWithResult(t,e){return freeze({...t,result:e})}}),CaseNode=freeze({is(t){return t.kind==="CaseNode"},create(t){return freeze({kind:"CaseNode",value:t})},cloneWithWhen(t,e){return freeze({...t,when:freeze(t.when?[...t.when,e]:[e])})},cloneWithThen(t,e){return freeze({...t,when:t.when?freeze([...t.when.slice(0,-1),WhenNode.cloneWithResult(t.when[t.when.length-1],e)]):void 0})},cloneWith(t,e){return freeze({...t,...e})}});class CaseBuilder{#e;constructor(e){this.#e=freeze(e)}when(...e){return new CaseThenBuilder({...this.#e,node:CaseNode.cloneWithWhen(this.#e.node,WhenNode.create(parseValueBinaryOperationOrExpression(e)))})}}class CaseThenBuilder{#e;constructor(e){this.#e=freeze(e)}then(e){return new CaseWhenBuilder({...this.#e,node:CaseNode.cloneWithThen(this.#e.node,isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e))})}}class CaseWhenBuilder{#e;constructor(e){this.#e=freeze(e)}when(...e){return new CaseThenBuilder({...this.#e,node:CaseNode.cloneWithWhen(this.#e.node,WhenNode.create(parseValueBinaryOperationOrExpression(e)))})}else(e){return new CaseEndBuilder({...this.#e,node:CaseNode.cloneWith(this.#e.node,{else:isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e)})})}end(){return new ExpressionWrapper(CaseNode.cloneWith(this.#e.node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(this.#e.node,{isStatement:!0}))}}class CaseEndBuilder{#e;constructor(e){this.#e=freeze(e)}end(){return new ExpressionWrapper(CaseNode.cloneWith(this.#e.node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(this.#e.node,{isStatement:!0}))}}const JSONPathLegNode=freeze({is(t){return t.kind==="JSONPathLegNode"},create(t,e){return freeze({kind:"JSONPathLegNode",type:t,value:e})}});class JSONPathBuilder{#e;constructor(e){this.#e=e}at(e){return this.#t("ArrayLocation",e)}key(e){return this.#t("Member",e)}#t(e,r){return JSONReferenceNode.is(this.#e)?new TraversedJSONPathBuilder(JSONReferenceNode.cloneWithTraversal(this.#e,JSONPathNode.is(this.#e.traversal)?JSONPathNode.cloneWithLeg(this.#e.traversal,JSONPathLegNode.create(e,r)):JSONOperatorChainNode.cloneWithValue(this.#e.traversal,ValueNode.createImmediate(r)))):new TraversedJSONPathBuilder(JSONPathNode.cloneWithLeg(this.#e,JSONPathLegNode.create(e,r)))}}class TraversedJSONPathBuilder extends JSONPathBuilder{#e;constructor(e){super(e),this.#e=e}get expressionType(){}as(e){return new AliasedJSONPathBuilder(this,e)}$castTo(){return new JSONPathBuilder(this.#e)}$notNull(){return new JSONPathBuilder(this.#e)}toOperationNode(){return this.#e}}class AliasedJSONPathBuilder{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),isOperationNodeSource(this.#t)?this.#t.toOperationNode():IdentifierNode.create(this.#t))}}const TupleNode=freeze({is(t){return t.kind==="TupleNode"},create(t){return freeze({kind:"TupleNode",values:freeze(t)})}});function createExpressionBuilder(t=NOOP_QUERY_EXECUTOR){function e(s,a,u){return new ExpressionWrapper(parseValueBinaryOperation(s,a,u))}function r(s,a){return new ExpressionWrapper(parseUnaryOperation(s,a))}const n=Object.assign(e,{fn:void 0,eb:void 0,selectFrom(s){return createSelectQueryBuilder({queryId:createQueryId(),executor:t,queryNode:SelectQueryNode.createFrom(parseTableExpressionOrList(s))})},case(s){return new CaseBuilder({node:CaseNode.create(isUndefined(s)?void 0:parseReferenceExpression(s))})},ref(s,a){return isUndefined(a)?new ExpressionWrapper(parseStringReference(s)):new JSONPathBuilder(parseJSONReference(s,a))},jsonPath(){return new JSONPathBuilder(JSONPathNode.create())},table(s){return new ExpressionWrapper(parseTable(s))},val(s){return new ExpressionWrapper(parseValueExpression(s))},refTuple(...s){return new ExpressionWrapper(TupleNode.create(s.map(parseReferenceExpression)))},tuple(...s){return new ExpressionWrapper(TupleNode.create(s.map(parseValueExpression)))},lit(s){return new ExpressionWrapper(parseSafeImmediateValue(s))},unary:r,not(s){return r("not",s)},exists(s){return r("exists",s)},neg(s){return r("-",s)},between(s,a,u){return new ExpressionWrapper(BinaryOperationNode.create(parseReferenceExpression(s),OperatorNode.create("between"),AndNode.create(parseValueExpression(a),parseValueExpression(u))))},betweenSymmetric(s,a,u){return new ExpressionWrapper(BinaryOperationNode.create(parseReferenceExpression(s),OperatorNode.create("between symmetric"),AndNode.create(parseValueExpression(a),parseValueExpression(u))))},and(s){return isReadonlyArray(s)?new ExpressionWrapper(parseFilterList(s,"and")):new ExpressionWrapper(parseFilterObject(s,"and"))},or(s){return isReadonlyArray(s)?new ExpressionWrapper(parseFilterList(s,"or")):new ExpressionWrapper(parseFilterObject(s,"or"))},parens(...s){const a=parseValueBinaryOperationOrExpression(s);return ParensNode.is(a)?new ExpressionWrapper(a):new ExpressionWrapper(ParensNode.create(a))},withSchema(s){return createExpressionBuilder(t.withPluginAtFront(new WithSchemaPlugin(s)))}});return n.fn=createFunctionModule(),n.eb=n,n}function expressionBuilder(t){return createExpressionBuilder()}function parseExpression(t){if(isOperationNodeSource(t))return t.toOperationNode();if(isFunction(t))return t(expressionBuilder()).toOperationNode();throw new Error(`invalid expression: ${JSON.stringify(t)}`)}function parseAliasedExpression(t){if(isOperationNodeSource(t))return t.toOperationNode();if(isFunction(t))return t(expressionBuilder()).toOperationNode();throw new Error(`invalid aliased expression: ${JSON.stringify(t)}`)}function isExpressionOrFactory(t){return isExpression(t)||isAliasedExpression(t)||isFunction(t)}function parseTableExpressionOrList(t){return isReadonlyArray(t)?t.map(e=>parseTableExpression(e)):[parseTableExpression(t)]}function parseTableExpression(t){return isString(t)?parseAliasedTable(t):parseAliasedExpression(t)}function parseAliasedTable(t){const e=" as ";if(t.includes(e)){const[r,n]=t.split(e).map(trim$1);return AliasNode.create(parseTable(r),IdentifierNode.create(n))}else return parseTable(t)}function parseTable(t){const e=".";if(t.includes(e)){const[r,n]=t.split(e).map(trim$1);return TableNode.createWithSchema(r,n)}else return TableNode.create(t)}function trim$1(t){return t.trim()}const AddColumnNode=freeze({is(t){return t.kind==="AddColumnNode"},create(t){return freeze({kind:"AddColumnNode",column:t})}}),ColumnDefinitionNode=freeze({is(t){return t.kind==="ColumnDefinitionNode"},create(t,e){return freeze({kind:"ColumnDefinitionNode",column:ColumnNode.create(t),dataType:e})},cloneWithFrontModifier(t,e){return freeze({...t,frontModifiers:t.frontModifiers?freeze([...t.frontModifiers,e]):[e]})},cloneWithEndModifier(t,e){return freeze({...t,endModifiers:t.endModifiers?freeze([...t.endModifiers,e]):[e]})},cloneWith(t,e){return freeze({...t,...e})}}),DropColumnNode=freeze({is(t){return t.kind==="DropColumnNode"},create(t){return freeze({kind:"DropColumnNode",column:ColumnNode.create(t)})}}),RenameColumnNode=freeze({is(t){return t.kind==="RenameColumnNode"},create(t,e){return freeze({kind:"RenameColumnNode",column:ColumnNode.create(t),renameTo:ColumnNode.create(e)})}}),CheckConstraintNode=freeze({is(t){return t.kind==="CheckConstraintNode"},create(t,e){return freeze({kind:"CheckConstraintNode",expression:t,name:e?IdentifierNode.create(e):void 0})}}),ON_MODIFY_FOREIGN_ACTIONS=["no action","restrict","cascade","set null","set default"],ReferencesNode=freeze({is(t){return t.kind==="ReferencesNode"},create(t,e){return freeze({kind:"ReferencesNode",table:t,columns:freeze([...e])})},cloneWithOnDelete(t,e){return freeze({...t,onDelete:e})},cloneWithOnUpdate(t,e){return freeze({...t,onUpdate:e})}});function parseDefaultValueExpression(t){return isOperationNodeSource(t)?t.toOperationNode():ValueNode.createImmediate(t)}const GeneratedNode=freeze({is(t){return t.kind==="GeneratedNode"},create(t){return freeze({kind:"GeneratedNode",...t})},createWithExpression(t){return freeze({kind:"GeneratedNode",always:!0,expression:t})},cloneWith(t,e){return freeze({...t,...e})}}),DefaultValueNode=freeze({is(t){return t.kind==="DefaultValueNode"},create(t){return freeze({kind:"DefaultValueNode",defaultValue:t})}});function parseOnModifyForeignAction(t){if(ON_MODIFY_FOREIGN_ACTIONS.includes(t))return t;throw new Error(`invalid OnModifyForeignAction ${t}`)}class ColumnDefinitionBuilder{#e;constructor(e){this.#e=e}autoIncrement(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{autoIncrement:!0}))}primaryKey(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{primaryKey:!0}))}references(e){const r=parseStringReference(e);if(!r.table||SelectAllNode.is(r.column))throw new Error(`invalid call references('${e}'). The reference must have format table.column or schema.table.column`);return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{references:ReferencesNode.create(r.table,[r.column])}))}onDelete(e){if(!this.#e.references)throw new Error("on delete constraint can only be added for foreign keys");return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{references:ReferencesNode.cloneWithOnDelete(this.#e.references,parseOnModifyForeignAction(e))}))}onUpdate(e){if(!this.#e.references)throw new Error("on update constraint can only be added for foreign keys");return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{references:ReferencesNode.cloneWithOnUpdate(this.#e.references,parseOnModifyForeignAction(e))}))}unique(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{unique:!0}))}notNull(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{notNull:!0}))}unsigned(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{unsigned:!0}))}defaultTo(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{defaultTo:DefaultValueNode.create(parseDefaultValueExpression(e))}))}check(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{check:CheckConstraintNode.create(e.toOperationNode())}))}generatedAlwaysAs(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{generated:GeneratedNode.createWithExpression(e.toOperationNode())}))}generatedAlwaysAsIdentity(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{generated:GeneratedNode.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{generated:GeneratedNode.create({identity:!0,byDefault:!0})}))}stored(){if(!this.#e.generated)throw new Error("stored() can only be called after generatedAlwaysAs");return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{generated:GeneratedNode.cloneWith(this.#e.generated,{stored:!0})}))}modifyFront(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWithFrontModifier(this.#e,e.toOperationNode()))}nullsNotDistinct(){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWith(this.#e,{nullsNotDistinct:!0}))}modifyEnd(e){return new ColumnDefinitionBuilder(ColumnDefinitionNode.cloneWithEndModifier(this.#e,e.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return this.#e}}preventAwait(ColumnDefinitionBuilder,"don't await ColumnDefinitionBuilder instances directly.");const ModifyColumnNode=freeze({is(t){return t.kind==="ModifyColumnNode"},create(t){return freeze({kind:"ModifyColumnNode",column:t})}}),DataTypeNode=freeze({is(t){return t.kind==="DataTypeNode"},create(t){return freeze({kind:"DataTypeNode",dataType:t})}});function parseDataTypeExpression(t){return isOperationNodeSource(t)?t.toOperationNode():DataTypeNode.create(t)}const ForeignKeyConstraintNode=freeze({is(t){return t.kind==="ForeignKeyConstraintNode"},create(t,e,r,n){return freeze({kind:"ForeignKeyConstraintNode",columns:t,references:ReferencesNode.create(e,r),name:n?IdentifierNode.create(n):void 0})},cloneWith(t,e){return freeze({...t,...e})}});class ForeignKeyConstraintBuilder{#e;constructor(e){this.#e=e}onDelete(e){return new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.cloneWith(this.#e,{onDelete:parseOnModifyForeignAction(e)}))}onUpdate(e){return new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.cloneWith(this.#e,{onUpdate:parseOnModifyForeignAction(e)}))}$call(e){return e(this)}toOperationNode(){return this.#e}}preventAwait(ForeignKeyConstraintBuilder,"don't await ForeignKeyConstraintBuilder instances directly.");const AddConstraintNode=freeze({is(t){return t.kind==="AddConstraintNode"},create(t){return freeze({kind:"AddConstraintNode",constraint:t})}}),UniqueConstraintNode=freeze({is(t){return t.kind==="UniqueConstraintNode"},create(t,e,r){return freeze({kind:"UniqueConstraintNode",columns:freeze(t.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0,nullsNotDistinct:r})},cloneWith(t,e){return freeze({...t,...e})}}),DropConstraintNode=freeze({is(t){return t.kind==="DropConstraintNode"},create(t){return freeze({kind:"DropConstraintNode",constraintName:IdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})}}),AlterColumnNode=freeze({is(t){return t.kind==="AlterColumnNode"},create(t,e,r){return freeze({kind:"AlterColumnNode",column:ColumnNode.create(t),[e]:r})}});class AlterColumnBuilder{#e;constructor(e){this.#e=e}setDataType(e){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"dataType",parseDataTypeExpression(e)))}setDefault(e){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"setDefault",parseDefaultValueExpression(e)))}dropDefault(){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"dropDefault",!0))}setNotNull(){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"setNotNull",!0))}dropNotNull(){return new AlteredColumnBuilder(AlterColumnNode.create(this.#e,"dropNotNull",!0))}$call(e){return e(this)}}class AlteredColumnBuilder{#e;constructor(e){this.#e=e}toOperationNode(){return this.#e}}class AlterTableExecutor{#e;constructor(e){this.#e=freeze(e)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableExecutor,"don't await AlterTableExecutor instances directly. To execute the query you need to call `execute`");class AlterTableAddForeignKeyConstraintBuilder{#e;constructor(e){this.#e=freeze(e)}onDelete(e){return new AlterTableAddForeignKeyConstraintBuilder({...this.#e,constraintBuilder:this.#e.constraintBuilder.onDelete(e)})}onUpdate(e){return new AlterTableAddForeignKeyConstraintBuilder({...this.#e,constraintBuilder:this.#e.constraintBuilder.onUpdate(e)})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(AlterTableNode.cloneWithTableProps(this.#e.node,{addConstraint:AddConstraintNode.create(this.#e.constraintBuilder.toOperationNode())}),this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableAddForeignKeyConstraintBuilder,"don't await AlterTableAddForeignKeyConstraintBuilder instances directly. To execute the query you need to call `execute`");class AlterTableDropConstraintBuilder{#e;constructor(e){this.#e=freeze(e)}ifExists(){return new AlterTableDropConstraintBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropConstraint:DropConstraintNode.cloneWith(this.#e.node.dropConstraint,{ifExists:!0})})})}cascade(){return new AlterTableDropConstraintBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropConstraint:DropConstraintNode.cloneWith(this.#e.node.dropConstraint,{modifier:"cascade"})})})}restrict(){return new AlterTableDropConstraintBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropConstraint:DropConstraintNode.cloneWith(this.#e.node.dropConstraint,{modifier:"restrict"})})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableDropConstraintBuilder,"don't await AlterTableDropConstraintBuilder instances directly. To execute the query you need to call `execute`");const PrimaryConstraintNode=freeze({is(t){return t.kind==="PrimaryKeyConstraintNode"},create(t,e){return freeze({kind:"PrimaryKeyConstraintNode",columns:freeze(t.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0})}}),AddIndexNode=freeze({is(t){return t.kind==="AddIndexNode"},create(t){return freeze({kind:"AddIndexNode",name:IdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})},cloneWithColumns(t,e){return freeze({...t,columns:[...t.columns||[],...e]})}});class AlterTableAddIndexBuilder{#e;constructor(e){this.#e=freeze(e)}unique(){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWith(this.#e.node.addIndex,{unique:!0})})})}column(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWithColumns(this.#e.node.addIndex,[parseOrderedColumnName(e)])})})}columns(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWithColumns(this.#e.node.addIndex,e.map(parseOrderedColumnName))})})}expression(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWithColumns(this.#e.node.addIndex,[e.toOperationNode()])})})}using(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.cloneWith(this.#e.node.addIndex,{using:RawNode.createWithSql(e)})})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableAddIndexBuilder,"don't await AlterTableAddIndexBuilder instances directly. To execute the query you need to call `execute`");class UniqueConstraintNodeBuilder{#e;constructor(e){this.#e=e}toOperationNode(){return this.#e}nullsNotDistinct(){return new UniqueConstraintNodeBuilder(UniqueConstraintNode.cloneWith(this.#e,{nullsNotDistinct:!0}))}}preventAwait(UniqueConstraintNodeBuilder,"don't await UniqueConstraintNodeBuilder instances directly.");class AlterTableBuilder{#e;constructor(e){this.#e=freeze(e)}renameTo(e){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{renameTo:parseTable(e)})})}setSchema(e){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{setSchema:IdentifierNode.create(e)})})}alterColumn(e,r){const n=r(new AlterColumnBuilder(e));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,n.toOperationNode())})}dropColumn(e){return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,DropColumnNode.create(e))})}renameColumn(e,r){return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,RenameColumnNode.create(e,r))})}addColumn(e,r,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(r))));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,AddColumnNode.create(s.toOperationNode()))})}modifyColumn(e,r,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(r))));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,ModifyColumnNode.create(s.toOperationNode()))})}addUniqueConstraint(e,r,n=noop$1){const s=n(new UniqueConstraintNodeBuilder(UniqueConstraintNode.create(r,e)));return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addConstraint:AddConstraintNode.create(s.toOperationNode())})})}addCheckConstraint(e,r){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addConstraint:AddConstraintNode.create(CheckConstraintNode.create(r.toOperationNode(),e))})})}addForeignKeyConstraint(e,r,n,s){return new AlterTableAddForeignKeyConstraintBuilder({...this.#e,constraintBuilder:new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(r.map(ColumnNode.create),parseTable(n),s.map(ColumnNode.create),e))})}addPrimaryKeyConstraint(e,r){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addConstraint:AddConstraintNode.create(PrimaryConstraintNode.create(r,e))})})}dropConstraint(e){return new AlterTableDropConstraintBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropConstraint:DropConstraintNode.create(e)})})}addIndex(e){return new AlterTableAddIndexBuilder({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{addIndex:AddIndexNode.create(e)})})}dropIndex(e){return new AlterTableExecutor({...this.#e,node:AlterTableNode.cloneWithTableProps(this.#e.node,{dropIndex:DropIndexNode.create(e)})})}$call(e){return e(this)}}class AlterTableColumnAlteringBuilder{#e;constructor(e){this.#e=freeze(e)}alterColumn(e,r){const n=r(new AlterColumnBuilder(e));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,n.toOperationNode())})}dropColumn(e){return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,DropColumnNode.create(e))})}renameColumn(e,r){return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,RenameColumnNode.create(e,r))})}addColumn(e,r,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(r))));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,AddColumnNode.create(s.toOperationNode()))})}modifyColumn(e,r,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(r))));return new AlterTableColumnAlteringBuilder({...this.#e,node:AlterTableNode.cloneWithColumnAlteration(this.#e.node,ModifyColumnNode.create(s.toOperationNode()))})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(AlterTableBuilder,"don't await AlterTableBuilder instances");preventAwait(AlterColumnBuilder,"don't await AlterColumnBuilder instances");preventAwait(AlterTableColumnAlteringBuilder,"don't await AlterTableColumnAlteringBuilder instances directly. To execute the query you need to call `execute`");class ImmediateValueTransformer extends OperationNodeTransformer{transformValue(e){return{...super.transformValue(e),immediate:!0}}}class CreateIndexBuilder{#e;constructor(e){this.#e=freeze(e)}ifNotExists(){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{ifNotExists:!0})})}unique(){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{unique:!0})})}nullsNotDistinct(){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{nullsNotDistinct:!0})})}on(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{table:parseTable(e)})})}column(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWithColumns(this.#e.node,[parseOrderedColumnName(e)])})}columns(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWithColumns(this.#e.node,e.map(parseOrderedColumnName))})}expression(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWithColumns(this.#e.node,[e.toOperationNode()])})}using(e){return new CreateIndexBuilder({...this.#e,node:CreateIndexNode.cloneWith(this.#e.node,{using:RawNode.createWithSql(e)})})}where(...e){const r=new ImmediateValueTransformer;return new CreateIndexBuilder({...this.#e,node:QueryNode.cloneWithWhere(this.#e.node,r.transformNode(parseValueBinaryOperationOrExpression(e)))})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateIndexBuilder,"don't await CreateIndexBuilder instances directly. To execute the query you need to call `execute`");class CreateSchemaBuilder{#e;constructor(e){this.#e=freeze(e)}ifNotExists(){return new CreateSchemaBuilder({...this.#e,node:CreateSchemaNode.cloneWith(this.#e.node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateSchemaBuilder,"don't await CreateSchemaBuilder instances directly. To execute the query you need to call `execute`");function parseOnCommitAction(t){if(ON_COMMIT_ACTIONS.includes(t))return t;throw new Error(`invalid OnCommitAction ${t}`)}class CreateTableBuilder{#e;constructor(e){this.#e=freeze(e)}temporary(){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWith(this.#e.node,{temporary:!0})})}onCommit(e){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWith(this.#e.node,{onCommit:parseOnCommitAction(e)})})}ifNotExists(){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWith(this.#e.node,{ifNotExists:!0})})}addColumn(e,r,n=noop$1){const s=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(r))));return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithColumn(this.#e.node,s.toOperationNode())})}addPrimaryKeyConstraint(e,r){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithConstraint(this.#e.node,PrimaryConstraintNode.create(r,e))})}addUniqueConstraint(e,r,n=noop$1){const s=n(new UniqueConstraintNodeBuilder(UniqueConstraintNode.create(r,e)));return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithConstraint(this.#e.node,s.toOperationNode())})}addCheckConstraint(e,r){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithConstraint(this.#e.node,CheckConstraintNode.create(r.toOperationNode(),e))})}addForeignKeyConstraint(e,r,n,s,a=noop$1){const u=a(new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(r.map(ColumnNode.create),parseTable(n),s.map(ColumnNode.create),e)));return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithConstraint(this.#e.node,u.toOperationNode())})}modifyFront(e){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithFrontModifier(this.#e.node,e.toOperationNode())})}modifyEnd(e){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWithEndModifier(this.#e.node,e.toOperationNode())})}as(e){return new CreateTableBuilder({...this.#e,node:CreateTableNode.cloneWith(this.#e.node,{selectQuery:parseExpression(e)})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateTableBuilder,"don't await CreateTableBuilder instances directly. To execute the query you need to call `execute`");class DropIndexBuilder{#e;constructor(e){this.#e=freeze(e)}on(e){return new DropIndexBuilder({...this.#e,node:DropIndexNode.cloneWith(this.#e.node,{table:parseTable(e)})})}ifExists(){return new DropIndexBuilder({...this.#e,node:DropIndexNode.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new DropIndexBuilder({...this.#e,node:DropIndexNode.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropIndexBuilder,"don't await DropIndexBuilder instances directly. To execute the query you need to call `execute`");class DropSchemaBuilder{#e;constructor(e){this.#e=freeze(e)}ifExists(){return new DropSchemaBuilder({...this.#e,node:DropSchemaNode.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new DropSchemaBuilder({...this.#e,node:DropSchemaNode.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropSchemaBuilder,"don't await DropSchemaBuilder instances directly. To execute the query you need to call `execute`");class DropTableBuilder{#e;constructor(e){this.#e=freeze(e)}ifExists(){return new DropTableBuilder({...this.#e,node:DropTableNode.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new DropTableBuilder({...this.#e,node:DropTableNode.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropTableBuilder,"don't await DropTableBuilder instances directly. To execute the query you need to call `execute`");const CreateViewNode=freeze({is(t){return t.kind==="CreateViewNode"},create(t){return freeze({kind:"CreateViewNode",name:SchemableIdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})}});class ImmediateValuePlugin{#e=new ImmediateValueTransformer;transformQuery(e){return this.#e.transformNode(e.node)}transformResult(e){return Promise.resolve(e.result)}}class CreateViewBuilder{#e;constructor(e){this.#e=freeze(e)}temporary(){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{temporary:!0})})}materialized(){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{materialized:!0})})}ifNotExists(){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{ifNotExists:!0})})}orReplace(){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{orReplace:!0})})}columns(e){return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{columns:e.map(parseColumnName)})})}as(e){const r=e.withPlugin(new ImmediateValuePlugin).toOperationNode();return new CreateViewBuilder({...this.#e,node:CreateViewNode.cloneWith(this.#e.node,{as:r})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateViewBuilder,"don't await CreateViewBuilder instances directly. To execute the query you need to call `execute`");const DropViewNode=freeze({is(t){return t.kind==="DropViewNode"},create(t){return freeze({kind:"DropViewNode",name:SchemableIdentifierNode.create(t)})},cloneWith(t,e){return freeze({...t,...e})}});class DropViewBuilder{#e;constructor(e){this.#e=freeze(e)}materialized(){return new DropViewBuilder({...this.#e,node:DropViewNode.cloneWith(this.#e.node,{materialized:!0})})}ifExists(){return new DropViewBuilder({...this.#e,node:DropViewNode.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new DropViewBuilder({...this.#e,node:DropViewNode.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropViewBuilder,"don't await DropViewBuilder instances directly. To execute the query you need to call `execute`");const CreateTypeNode=freeze({is(t){return t.kind==="CreateTypeNode"},create(t){return freeze({kind:"CreateTypeNode",name:t})},cloneWithEnum(t,e){return freeze({...t,enum:ValueListNode.create(e.map(r=>ValueNode.createImmediate(r)))})}});class CreateTypeBuilder{#e;constructor(e){this.#e=freeze(e)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}asEnum(e){return new CreateTypeBuilder({...this.#e,node:CreateTypeNode.cloneWithEnum(this.#e.node,e)})}$call(e){return e(this)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(CreateTypeBuilder,"don't await CreateTypeBuilder instances directly. To execute the query you need to call `execute`");const DropTypeNode=freeze({is(t){return t.kind==="DropTypeNode"},create(t){return freeze({kind:"DropTypeNode",name:t})},cloneWith(t,e){return freeze({...t,...e})}});class DropTypeBuilder{#e;constructor(e){this.#e=freeze(e)}ifExists(){return new DropTypeBuilder({...this.#e,node:DropTypeNode.cloneWith(this.#e.node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile(),this.#e.queryId)}}preventAwait(DropTypeBuilder,"don't await DropTypeBuilder instances directly. To execute the query you need to call `execute`");function parseSchemableIdentifier(t){const e=".";if(t.includes(e)){const r=t.split(e).map(trim);if(r.length===2)return SchemableIdentifierNode.createWithSchema(r[0],r[1]);throw new Error(`invalid schemable identifier ${t}`)}else return SchemableIdentifierNode.create(t)}function trim(t){return t.trim()}class SchemaModule{#e;constructor(e){this.#e=e}createTable(e){return new CreateTableBuilder({queryId:createQueryId(),executor:this.#e,node:CreateTableNode.create(parseTable(e))})}dropTable(e){return new DropTableBuilder({queryId:createQueryId(),executor:this.#e,node:DropTableNode.create(parseTable(e))})}createIndex(e){return new CreateIndexBuilder({queryId:createQueryId(),executor:this.#e,node:CreateIndexNode.create(e)})}dropIndex(e){return new DropIndexBuilder({queryId:createQueryId(),executor:this.#e,node:DropIndexNode.create(e)})}createSchema(e){return new CreateSchemaBuilder({queryId:createQueryId(),executor:this.#e,node:CreateSchemaNode.create(e)})}dropSchema(e){return new DropSchemaBuilder({queryId:createQueryId(),executor:this.#e,node:DropSchemaNode.create(e)})}alterTable(e){return new AlterTableBuilder({queryId:createQueryId(),executor:this.#e,node:AlterTableNode.create(parseTable(e))})}createView(e){return new CreateViewBuilder({queryId:createQueryId(),executor:this.#e,node:CreateViewNode.create(e)})}dropView(e){return new DropViewBuilder({queryId:createQueryId(),executor:this.#e,node:DropViewNode.create(e)})}createType(e){return new CreateTypeBuilder({queryId:createQueryId(),executor:this.#e,node:CreateTypeNode.create(parseSchemableIdentifier(e))})}dropType(e){return new DropTypeBuilder({queryId:createQueryId(),executor:this.#e,node:DropTypeNode.create(parseSchemableIdentifier(e))})}withPlugin(e){return new SchemaModule(this.#e.withPlugin(e))}withoutPlugins(){return new SchemaModule(this.#e.withoutPlugins())}withSchema(e){return new SchemaModule(this.#e.withPluginAtFront(new WithSchemaPlugin(e)))}}class DynamicModule{ref(e){return new DynamicReferenceBuilder(e)}}class DefaultConnectionProvider{#e;constructor(e){this.#e=e}async provideConnection(e){const r=await this.#e.acquireConnection();try{return await e(r)}finally{await this.#e.releaseConnection(r)}}}class DefaultQueryExecutor extends QueryExecutorBase{#e;#t;#r;constructor(e,r,n,s=[]){super(s),this.#e=e,this.#t=r,this.#r=n}get adapter(){return this.#t}compileQuery(e){return this.#e.compileQuery(e)}provideConnection(e){return this.#r.provideConnection(e)}withPlugins(e){return new DefaultQueryExecutor(this.#e,this.#t,this.#r,[...this.plugins,...e])}withPlugin(e){return new DefaultQueryExecutor(this.#e,this.#t,this.#r,[...this.plugins,e])}withPluginAtFront(e){return new DefaultQueryExecutor(this.#e,this.#t,this.#r,[e,...this.plugins])}withConnectionProvider(e){return new DefaultQueryExecutor(this.#e,this.#t,e,[...this.plugins])}withoutPlugins(){return new DefaultQueryExecutor(this.#e,this.#t,this.#r,[])}}function performanceNow(){return typeof performance<"u"&&isFunction(performance.now)?performance.now():Date.now()}class RuntimeDriver{#e;#t;#r;#n;#i;#s=new WeakSet;constructor(e,r){this.#n=!1,this.#e=e,this.#t=r}async init(){if(this.#i)throw new Error("driver has already been destroyed");this.#r||(this.#r=this.#e.init().then(()=>{this.#n=!0}).catch(e=>(this.#r=void 0,Promise.reject(e)))),await this.#r}async acquireConnection(){if(this.#i)throw new Error("driver has already been destroyed");this.#n||await this.init();const e=await this.#e.acquireConnection();return this.#s.has(e)||(this.#o()&&this.#a(e),this.#s.add(e)),e}async releaseConnection(e){await this.#e.releaseConnection(e)}beginTransaction(e,r){return this.#e.beginTransaction(e,r)}commitTransaction(e){return this.#e.commitTransaction(e)}rollbackTransaction(e){return this.#e.rollbackTransaction(e)}async destroy(){this.#r&&(await this.#r,this.#i||(this.#i=this.#e.destroy().catch(e=>(this.#i=void 0,Promise.reject(e)))),await this.#i)}#o(){return this.#t.isLevelEnabled("query")||this.#t.isLevelEnabled("error")}#a(e){const r=e.executeQuery;e.executeQuery=async n=>{let s;const a=performanceNow();try{return await r.call(e,n)}catch(u){throw s=u,await this.#u(u,n,a),u}finally{s||await this.#l(n,a)}}}async#u(e,r,n){await this.#t.error(()=>({level:"error",error:e,query:r,queryDurationMillis:this.#c(n)}))}async#l(e,r){await this.#t.query(()=>({level:"query",query:e,queryDurationMillis:this.#c(r)}))}#c(e){return performanceNow()-e}}const ignoreError=()=>{};class SingleConnectionProvider{#e;#t;constructor(e){this.#e=e}async provideConnection(e){for(;this.#t;)await this.#t.catch(ignoreError);return this.#t=this.#r(e).finally(()=>{this.#t=void 0}),this.#t}async#r(e){return await e(this.#e)}}const TRANSACTION_ISOLATION_LEVELS=["read uncommitted","read committed","repeatable read","serializable","snapshot"];freeze(["query","error"]);class Log{#e;#t;constructor(e){isFunction(e)?(this.#t=e,this.#e=freeze({query:!0,error:!0})):(this.#t=defaultLogger,this.#e=freeze({query:e.includes("query"),error:e.includes("error")}))}isLevelEnabled(e){return this.#e[e]}async query(e){this.#e.query&&await this.#t(e())}async error(e){this.#e.error&&await this.#t(e())}}function defaultLogger(t){t.level==="query"?(console.log(`kysely:query: ${t.query.sql}`),console.log(`kysely:query: duration: ${t.queryDurationMillis.toFixed(1)}ms`)):t.level==="error"&&(t.error instanceof Error?console.error(`kysely:error: ${t.error.stack??t.error.message}`):console.error(`kysely:error: ${JSON.stringify({error:t.error,query:t.query.sql,queryDurationMillis:t.queryDurationMillis})}`))}function isCompilable(t){return isObject$3(t)&&isFunction(t.compile)}class Kysely extends QueryCreator{#e;constructor(e){let r,n;if(isKyselyProps(e))r={executor:e.executor},n={...e};else{const s=e.dialect,a=s.createDriver(),u=s.createQueryCompiler(),d=s.createAdapter(),f=new Log(e.log??[]),y=new RuntimeDriver(a,f),b=new DefaultConnectionProvider(y),w=new DefaultQueryExecutor(u,d,b,e.plugins??[]);r={executor:w},n={config:e,executor:w,dialect:s,driver:y}}super(r),this.#e=freeze(n)}get schema(){return new SchemaModule(this.#e.executor)}get dynamic(){return new DynamicModule}get introspection(){return this.#e.dialect.createIntrospector(this.withoutPlugins())}case(e){return new CaseBuilder({node:CaseNode.create(isUndefined(e)?void 0:parseExpression(e))})}get fn(){return createFunctionModule()}transaction(){return new TransactionBuilder({...this.#e})}connection(){return new ConnectionBuilder({...this.#e})}withPlugin(e){return new Kysely({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new Kysely({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new Kysely({...this.#e,executor:this.#e.executor.withPluginAtFront(new WithSchemaPlugin(e))})}withTables(){return new Kysely({...this.#e})}async destroy(){await this.#e.driver.destroy()}get isTransaction(){return!1}getExecutor(){return this.#e.executor}executeQuery(e,r=createQueryId()){const n=isCompilable(e)?e.compile():e;return this.getExecutor().executeQuery(n,r)}}class Transaction extends Kysely{#e;constructor(e){super(e),this.#e=e}get isTransaction(){return!0}transaction(){throw new Error("calling the transaction method for a Transaction is not supported")}connection(){throw new Error("calling the connection method for a Transaction is not supported")}async destroy(){throw new Error("calling the destroy method for a Transaction is not supported")}withPlugin(e){return new Transaction({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new Transaction({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new Transaction({...this.#e,executor:this.#e.executor.withPluginAtFront(new WithSchemaPlugin(e))})}withTables(){return new Transaction({...this.#e})}}function isKyselyProps(t){return isObject$3(t)&&isObject$3(t.config)&&isObject$3(t.driver)&&isObject$3(t.executor)&&isObject$3(t.dialect)}class ConnectionBuilder{#e;constructor(e){this.#e=freeze(e)}async execute(e){return this.#e.executor.provideConnection(async r=>{const n=this.#e.executor.withConnectionProvider(new SingleConnectionProvider(r)),s=new Kysely({...this.#e,executor:n});return await e(s)})}}preventAwait(ConnectionBuilder,"don't await ConnectionBuilder instances directly. To execute the query you need to call the `execute` method");class TransactionBuilder{#e;constructor(e){this.#e=freeze(e)}setIsolationLevel(e){return new TransactionBuilder({...this.#e,isolationLevel:e})}async execute(e){const{isolationLevel:r,...n}=this.#e,s={isolationLevel:r};return validateTransactionSettings(s),this.#e.executor.provideConnection(async a=>{const u=this.#e.executor.withConnectionProvider(new SingleConnectionProvider(a)),d=new Transaction({...n,executor:u});try{await this.#e.driver.beginTransaction(a,s);const f=await e(d);return await this.#e.driver.commitTransaction(a),f}catch(f){throw await this.#e.driver.rollbackTransaction(a),f}})}}preventAwait(TransactionBuilder,"don't await TransactionBuilder instances directly. To execute the transaction you need to call the `execute` method");function validateTransactionSettings(t){if(t.isolationLevel&&!TRANSACTION_ISOLATION_LEVELS.includes(t.isolationLevel))throw new Error(`invalid transaction isolation level ${t.isolationLevel}`)}class RawBuilderImpl{#e;constructor(e){this.#e=freeze(e)}get expressionType(){}get isRawBuilder(){return!0}as(e){return new AliasedRawBuilderImpl(this,e)}$castTo(){return new RawBuilderImpl({...this.#e})}$notNull(){return new RawBuilderImpl(this.#e)}withPlugin(e){return new RawBuilderImpl({...this.#e,plugins:this.#e.plugins!==void 0?freeze([...this.#e.plugins,e]):freeze([e])})}toOperationNode(){return this.#r(this.#t())}compile(e){return this.#n(this.#t(e))}async execute(e){const r=this.#t(e);return r.executeQuery(this.#n(r),this.#e.queryId)}#t(e){const r=e!==void 0?e.getExecutor():NOOP_QUERY_EXECUTOR;return this.#e.plugins!==void 0?r.withPlugins(this.#e.plugins):r}#r(e){return e.transformQuery(this.#e.rawNode,this.#e.queryId)}#n(e){return e.compileQuery(this.#r(e),this.#e.queryId)}}function createRawBuilder(t){return new RawBuilderImpl(t)}preventAwait(RawBuilderImpl,"don't await RawBuilder instances directly. To execute the query you need to call `execute`");class AliasedRawBuilderImpl{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}get rawBuilder(){return this.#e}toOperationNode(){return AliasNode.create(this.#e.toOperationNode(),isOperationNodeSource(this.#t)?this.#t.toOperationNode():IdentifierNode.create(this.#t))}}preventAwait(AliasedRawBuilderImpl,"don't await AliasedRawBuilder instances directly. AliasedRawBuilder should never be executed directly since it's always a part of another query.");const sql=Object.assign((t,...e)=>createRawBuilder({queryId:createQueryId(),rawNode:RawNode.create(t,e?.map(parseParameter)??[])}),{ref(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseStringReference(t))})},val(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseValueExpression(t))})},value(t){return this.val(t)},table(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseTable(t))})},id(...t){const e=new Array(t.length+1).fill(".");return e[0]="",e[e.length-1]="",createRawBuilder({queryId:createQueryId(),rawNode:RawNode.create(e,t.map(IdentifierNode.create))})},lit(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(ValueNode.createImmediate(t))})},literal(t){return this.lit(t)},raw(t){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithSql(t)})},join(t,e=sql`, `){const r=new Array(2*t.length-1),n=e.toOperationNode();for(let s=0;s<t.length;++s)r[2*s]=parseParameter(t[s]),s!==t.length-1&&(r[2*s+1]=n);return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChildren(r)})}});function parseParameter(t){return isOperationNodeSource(t)?t.toOperationNode():parseValueExpression(t)}class OperationNodeVisitor{nodeStack=[];get parentNode(){return this.nodeStack[this.nodeStack.length-2]}#e=freeze({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this),JSONReferenceNode:this.visitJSONReference.bind(this),JSONPathNode:this.visitJSONPath.bind(this),JSONPathLegNode:this.visitJSONPathLeg.bind(this),JSONOperatorChainNode:this.visitJSONOperatorChain.bind(this),TupleNode:this.visitTuple.bind(this),AddIndexNode:this.visitAddIndex.bind(this)});visitNode=e=>{this.nodeStack.push(e),this.#e[e.kind](e),this.nodeStack.pop()}}class DefaultQueryCompiler extends OperationNodeVisitor{#e="";#t=[];get numParameters(){return this.#t.length}compileQuery(e){return this.#e="",this.#t=[],this.visitNode(e),freeze({query:e,sql:this.getSql(),parameters:[...this.#t]})}getSql(){return this.#e}visitSelectQuery(e){const r=this.parentNode!==void 0&&!ParensNode.is(this.parentNode)&&!InsertQueryNode.is(this.parentNode)&&!CreateTableNode.is(this.parentNode)&&!CreateViewNode.is(this.parentNode)&&!SetOperationNode.is(this.parentNode);this.parentNode===void 0&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("select"),e.distinctOn&&(this.append(" "),this.compileDistinctOn(e.distinctOn)),e.frontModifiers?.length&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.selections&&(this.append(" "),this.compileList(e.selections)),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.groupBy&&(this.append(" "),this.visitNode(e.groupBy)),e.having&&(this.append(" "),this.visitNode(e.having)),e.setOperations&&(this.append(" "),this.compileList(e.setOperations," ")),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.offset&&(this.append(" "),this.visitNode(e.offset)),e.endModifiers?.length&&(this.append(" "),this.compileList(this.sortSelectModifiers([...e.endModifiers])," ")),r&&this.append(")")}visitFrom(e){this.append("from "),this.compileList(e.froms)}visitSelection(e){this.visitNode(e.selection)}visitColumn(e){this.visitNode(e.column)}compileDistinctOn(e){this.append("distinct on ("),this.compileList(e),this.append(")")}compileList(e,r=", "){const n=e.length-1;for(let s=0;s<=n;s++)this.visitNode(e[s]),s<n&&this.append(r)}visitWhere(e){this.append("where "),this.visitNode(e.where)}visitHaving(e){this.append("having "),this.visitNode(e.having)}visitInsertQuery(e){const r=this.nodeStack.find(QueryNode.is)!==e;!r&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append(e.replace?"replace":"insert"),e.ignore&&this.append(" ignore"),this.append(" into "),this.visitNode(e.into),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.values&&(this.append(" "),this.visitNode(e.values)),e.defaultValues&&(this.append(" "),this.append("default values")),e.onConflict&&(this.append(" "),this.visitNode(e.onConflict)),e.onDuplicateKey&&(this.append(" "),this.visitNode(e.onDuplicateKey)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&this.append(")")}visitValues(e){this.append("values "),this.compileList(e.values)}visitDeleteQuery(e){const r=this.nodeStack.find(QueryNode.is)!==e;!r&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("delete "),this.visitNode(e.from),e.using&&(this.append(" "),this.visitNode(e.using)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&this.append(")")}visitReturning(e){this.append("returning "),this.compileList(e.selections)}visitAlias(e){this.visitNode(e.node),this.append(" as "),this.visitNode(e.alias)}visitReference(e){e.table&&(this.visitNode(e.table),this.append(".")),this.visitNode(e.column)}visitSelectAll(e){this.append("*")}visitIdentifier(e){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(e),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(e){if(!isString(e.name))throw new Error("a non-string identifier was passed to compileUnwrappedIdentifier.");this.append(this.sanitizeIdentifier(e.name))}visitAnd(e){this.visitNode(e.left),this.append(" and "),this.visitNode(e.right)}visitOr(e){this.visitNode(e.left),this.append(" or "),this.visitNode(e.right)}visitValue(e){e.immediate?this.appendImmediateValue(e.value):this.appendValue(e.value)}visitValueList(e){this.append("("),this.compileList(e.values),this.append(")")}visitTuple(e){this.append("("),this.compileList(e.values),this.append(")")}visitPrimitiveValueList(e){this.append("(");const{values:r}=e;for(let n=0;n<r.length;++n)this.appendValue(r[n]),n!==r.length-1&&this.append(", ");this.append(")")}visitParens(e){this.append("("),this.visitNode(e.node),this.append(")")}visitJoin(e){this.append(JOIN_TYPE_SQL[e.joinType]),this.append(" "),this.visitNode(e.table),e.on&&(this.append(" "),this.visitNode(e.on))}visitOn(e){this.append("on "),this.visitNode(e.on)}visitRaw(e){const{sqlFragments:r,parameters:n}=e;for(let s=0;s<r.length;++s)this.append(r[s]),n.length>s&&this.visitNode(n[s])}visitOperator(e){this.append(e.operator)}visitTable(e){this.visitNode(e.table)}visitSchemableIdentifier(e){e.schema&&(this.visitNode(e.schema),this.append(".")),this.visitNode(e.identifier)}visitCreateTable(e){this.append("create "),e.frontModifiers&&e.frontModifiers.length>0&&(this.compileList(e.frontModifiers," "),this.append(" ")),e.temporary&&this.append("temporary "),this.append("table "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.table),e.selectQuery?(this.append(" as "),this.visitNode(e.selectQuery)):(this.append(" ("),this.compileList([...e.columns,...e.constraints??[]]),this.append(")"),e.onCommit&&(this.append(" on commit "),this.append(e.onCommit)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," ")))}visitColumnDefinition(e){this.visitNode(e.column),this.append(" "),this.visitNode(e.dataType),e.unsigned&&this.append(" unsigned"),e.frontModifiers&&e.frontModifiers.length>0&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.generated&&(this.append(" "),this.visitNode(e.generated)),e.defaultTo&&(this.append(" "),this.visitNode(e.defaultTo)),e.notNull&&this.append(" not null"),e.unique&&this.append(" unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.primaryKey&&this.append(" primary key"),e.autoIncrement&&(this.append(" "),this.append(this.getAutoIncrement())),e.references&&(this.append(" "),this.visitNode(e.references)),e.check&&(this.append(" "),this.visitNode(e.check)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," "))}getAutoIncrement(){return"auto_increment"}visitReferences(e){this.append("references "),this.visitNode(e.table),this.append(" ("),this.compileList(e.columns),this.append(")"),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate))}visitDropTable(e){this.append("drop table "),e.ifExists&&this.append("if exists "),this.visitNode(e.table),e.cascade&&this.append(" cascade")}visitDataType(e){this.append(e.dataType)}visitOrderBy(e){this.append("order by "),this.compileList(e.items)}visitOrderByItem(e){this.visitNode(e.orderBy),e.direction&&(this.append(" "),this.visitNode(e.direction))}visitGroupBy(e){this.append("group by "),this.compileList(e.items)}visitGroupByItem(e){this.visitNode(e.groupBy)}visitUpdateQuery(e){const r=this.nodeStack.find(QueryNode.is)!==e;!r&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("update "),this.visitNode(e.table),this.append(" set "),e.updates&&this.compileList(e.updates),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&this.append(")")}visitColumnUpdate(e){this.visitNode(e.column),this.append(" = "),this.visitNode(e.value)}visitLimit(e){this.append("limit "),this.visitNode(e.limit)}visitOffset(e){this.append("offset "),this.visitNode(e.offset)}visitOnConflict(e){this.append("on conflict"),e.columns?(this.append(" ("),this.compileList(e.columns),this.append(")")):e.constraint?(this.append(" on constraint "),this.visitNode(e.constraint)):e.indexExpression&&(this.append(" ("),this.visitNode(e.indexExpression),this.append(")")),e.indexWhere&&(this.append(" "),this.visitNode(e.indexWhere)),e.doNothing===!0?this.append(" do nothing"):e.updates&&(this.append(" do update set "),this.compileList(e.updates),e.updateWhere&&(this.append(" "),this.visitNode(e.updateWhere)))}visitOnDuplicateKey(e){this.append("on duplicate key update "),this.compileList(e.updates)}visitCreateIndex(e){this.append("create "),e.unique&&this.append("unique "),this.append("index "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.using&&(this.append(" using "),this.visitNode(e.using)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.where&&(this.append(" "),this.visitNode(e.where))}visitDropIndex(e){this.append("drop index "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.cascade&&this.append(" cascade")}visitCreateSchema(e){this.append("create schema "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.schema)}visitDropSchema(e){this.append("drop schema "),e.ifExists&&this.append("if exists "),this.visitNode(e.schema),e.cascade&&this.append(" cascade")}visitPrimaryKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("primary key ("),this.compileList(e.columns),this.append(")")}visitUniqueConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),this.append(" ("),this.compileList(e.columns),this.append(")")}visitCheckConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("check ("),this.visitNode(e.expression),this.append(")")}visitForeignKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("foreign key ("),this.compileList(e.columns),this.append(") "),this.visitNode(e.references),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate))}visitList(e){this.compileList(e.items)}visitWith(e){this.append("with "),e.recursive&&this.append("recursive "),this.compileList(e.expressions)}visitCommonTableExpression(e){this.visitNode(e.name),this.append(" as "),isBoolean(e.materialized)&&(e.materialized||this.append("not "),this.append("materialized ")),this.visitNode(e.expression)}visitCommonTableExpressionName(e){this.visitNode(e.table),e.columns&&(this.append("("),this.compileList(e.columns),this.append(")"))}visitAlterTable(e){this.append("alter table "),this.visitNode(e.table),this.append(" "),e.renameTo&&(this.append("rename to "),this.visitNode(e.renameTo)),e.setSchema&&(this.append("set schema "),this.visitNode(e.setSchema)),e.addConstraint&&this.visitNode(e.addConstraint),e.dropConstraint&&this.visitNode(e.dropConstraint),e.columnAlterations&&this.compileColumnAlterations(e.columnAlterations),e.addIndex&&this.visitNode(e.addIndex),e.dropIndex&&this.visitNode(e.dropIndex)}visitAddColumn(e){this.append("add column "),this.visitNode(e.column)}visitRenameColumn(e){this.append("rename column "),this.visitNode(e.column),this.append(" to "),this.visitNode(e.renameTo)}visitDropColumn(e){this.append("drop column "),this.visitNode(e.column)}visitAlterColumn(e){this.append("alter column "),this.visitNode(e.column),this.append(" "),e.dataType&&(this.announcesNewColumnDataType()&&this.append("type "),this.visitNode(e.dataType),e.dataTypeExpression&&(this.append("using "),this.visitNode(e.dataTypeExpression))),e.setDefault&&(this.append("set default "),this.visitNode(e.setDefault)),e.dropDefault&&this.append("drop default"),e.setNotNull&&this.append("set not null"),e.dropNotNull&&this.append("drop not null")}visitModifyColumn(e){this.append("modify column "),this.visitNode(e.column)}visitAddConstraint(e){this.append("add "),this.visitNode(e.constraint)}visitDropConstraint(e){this.append("drop constraint "),e.ifExists&&this.append("if exists "),this.visitNode(e.constraintName),e.modifier==="cascade"?this.append(" cascade"):e.modifier==="restrict"&&this.append(" restrict")}visitSetOperation(e){this.append(e.operator),this.append(" "),e.all&&this.append("all "),this.visitNode(e.expression)}visitCreateView(e){this.append("create "),e.orReplace&&this.append("or replace "),e.materialized&&this.append("materialized "),e.temporary&&this.append("temporary "),this.append("view "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),this.append(" "),e.columns&&(this.append("("),this.compileList(e.columns),this.append(") ")),e.as&&(this.append("as "),this.visitNode(e.as))}visitDropView(e){this.append("drop "),e.materialized&&this.append("materialized "),this.append("view "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.cascade&&this.append(" cascade")}visitGenerated(e){this.append("generated "),e.always&&this.append("always "),e.byDefault&&this.append("by default "),this.append("as "),e.identity&&this.append("identity"),e.expression&&(this.append("("),this.visitNode(e.expression),this.append(")")),e.stored&&this.append(" stored")}visitDefaultValue(e){this.append("default "),this.visitNode(e.defaultValue)}visitSelectModifier(e){e.rawModifier?this.visitNode(e.rawModifier):this.append(SELECT_MODIFIER_SQL[e.modifier]),e.of&&(this.append(" of "),this.compileList(e.of,", "))}visitCreateType(e){this.append("create type "),this.visitNode(e.name),e.enum&&(this.append(" as enum "),this.visitNode(e.enum))}visitDropType(e){this.append("drop type "),e.ifExists&&this.append("if exists "),this.visitNode(e.name)}visitExplain(e){this.append("explain"),(e.options||e.format)&&(this.append(" "),this.append(this.getLeftExplainOptionsWrapper()),e.options&&(this.visitNode(e.options),e.format&&this.append(this.getExplainOptionsDelimiter())),e.format&&(this.append("format"),this.append(this.getExplainOptionAssignment()),this.append(e.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(e){this.append("default")}visitAggregateFunction(e){this.append(e.func),this.append("("),e.distinct&&this.append("distinct "),this.compileList(e.aggregated),this.append(")"),e.filter&&(this.append(" filter("),this.visitNode(e.filter),this.append(")")),e.over&&(this.append(" "),this.visitNode(e.over))}visitOver(e){this.append("over("),e.partitionBy&&(this.visitNode(e.partitionBy),e.orderBy&&this.append(" ")),e.orderBy&&this.visitNode(e.orderBy),this.append(")")}visitPartitionBy(e){this.append("partition by "),this.compileList(e.items)}visitPartitionByItem(e){this.visitNode(e.partitionBy)}visitBinaryOperation(e){this.visitNode(e.leftOperand),this.append(" "),this.visitNode(e.operator),this.append(" "),this.visitNode(e.rightOperand)}visitUnaryOperation(e){this.visitNode(e.operator),this.isMinusOperator(e.operator)||this.append(" "),this.visitNode(e.operand)}isMinusOperator(e){return OperatorNode.is(e)&&e.operator==="-"}visitUsing(e){this.append("using "),this.compileList(e.tables)}visitFunction(e){this.append(e.func),this.append("("),this.compileList(e.arguments),this.append(")")}visitCase(e){this.append("case"),e.value&&(this.append(" "),this.visitNode(e.value)),e.when&&(this.append(" "),this.compileList(e.when," ")),e.else&&(this.append(" else "),this.visitNode(e.else)),this.append(" end"),e.isStatement&&this.append(" case")}visitWhen(e){this.append("when "),this.visitNode(e.condition),e.result&&(this.append(" then "),this.visitNode(e.result))}visitJSONReference(e){this.visitNode(e.reference),this.visitNode(e.traversal)}visitJSONPath(e){e.inOperator&&this.visitNode(e.inOperator),this.append("'$");for(const r of e.pathLegs)this.visitNode(r);this.append("'")}visitJSONPathLeg(e){const r=e.type==="ArrayLocation";this.append(r?"[":"."),this.append(String(e.value)),r&&this.append("]")}visitJSONOperatorChain(e){for(let r=0,n=e.values.length;r<n;r++)r===n-1?this.visitNode(e.operator):this.append("->"),this.visitNode(e.values[r])}visitAddIndex(e){this.append("add "),e.unique&&this.append("unique "),this.append("index "),this.visitNode(e.name),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.using&&(this.append(" using "),this.visitNode(e.using))}append(e){this.#e+=e}appendValue(e){this.addParameter(e),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getCurrentParameterPlaceholder(){return"$"+this.numParameters}getLeftExplainOptionsWrapper(){return"("}getExplainOptionAssignment(){return" "}getExplainOptionsDelimiter(){return", "}getRightExplainOptionsWrapper(){return")"}sanitizeIdentifier(e){const r=this.getLeftIdentifierWrapper(),n=this.getRightIdentifierWrapper();let s="";for(const a of e)s+=a,a===r?s+=r:a===n&&(s+=n);return s}addParameter(e){this.#t.push(e)}appendImmediateValue(e){if(isString(e))this.append(`'${e}'`);else if(isNumber(e)||isBoolean(e))this.append(e.toString());else if(isNull(e))this.append("null");else if(isDate(e))this.appendImmediateValue(e.toISOString());else if(isBigInt(e))this.appendImmediateValue(e.toString());else throw new Error(`invalid immediate value ${e}`)}sortSelectModifiers(e){return e.sort((r,n)=>r.modifier&&n.modifier?SELECT_MODIFIER_PRIORITY[r.modifier]-SELECT_MODIFIER_PRIORITY[n.modifier]:1),freeze(e)}compileColumnAlterations(e){this.compileList(e)}announcesNewColumnDataType(){return!0}}const SELECT_MODIFIER_SQL=freeze({ForKeyShare:"for key share",ForNoKeyUpdate:"for no key update",ForUpdate:"for update",ForShare:"for share",NoWait:"nowait",SkipLocked:"skip locked",Distinct:"distinct"}),SELECT_MODIFIER_PRIORITY=freeze({ForKeyShare:1,ForNoKeyUpdate:1,ForUpdate:1,ForShare:1,NoWait:2,SkipLocked:2,Distinct:0}),JOIN_TYPE_SQL=freeze({InnerJoin:"inner join",LeftJoin:"left join",RightJoin:"right join",FullJoin:"full join",LateralInnerJoin:"inner join lateral",LateralLeftJoin:"left join lateral"}),CompiledQuery=freeze({raw(t,e=[]){return freeze({sql:t,query:RawNode.createWithSql(t),parameters:freeze(e)})}});class DialectAdapterBase{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}}class SqliteDriver{#e;#t=new ConnectionMutex;#r;#n;constructor(e){this.#e=freeze({...e})}async init(){this.#r=isFunction(this.#e.database)?await this.#e.database():this.#e.database,this.#n=new SqliteConnection(this.#r),this.#e.onCreateConnection&&await this.#e.onCreateConnection(this.#n)}async acquireConnection(){return await this.#t.lock(),this.#n}async beginTransaction(e){await e.executeQuery(CompiledQuery.raw("begin"))}async commitTransaction(e){await e.executeQuery(CompiledQuery.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(CompiledQuery.raw("rollback"))}async releaseConnection(){this.#t.unlock()}async destroy(){this.#r?.close()}}class SqliteConnection{#e;constructor(e){this.#e=e}executeQuery(e){const{sql:r,parameters:n}=e,s=this.#e.prepare(r);if(s.reader)return Promise.resolve({rows:s.all(n)});{const{changes:a,lastInsertRowid:u}=s.run(n),d=a!=null?BigInt(a):void 0;return Promise.resolve({numUpdatedOrDeletedRows:d,numAffectedRows:d,insertId:u!=null?BigInt(u):void 0,rows:[]})}}async*streamQuery(e,r){const{sql:n,parameters:s,query:a}=e,u=this.#e.prepare(n);if(SelectQueryNode.is(a)){const d=u.iterate(s);for(const f of d)yield{rows:[f]}}else throw new Error("Sqlite driver only supports streaming of select queries")}}class ConnectionMutex{#e;#t;async lock(){for(;this.#e;)await this.#e;this.#e=new Promise(e=>{this.#t=e})}unlock(){const e=this.#t;this.#e=void 0,this.#t=void 0,e?.()}}const ID_WRAP_REGEX=/"/g;class SqliteQueryCompiler extends DefaultQueryCompiler{getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}sanitizeIdentifier(e){return e.replace(ID_WRAP_REGEX,'""')}visitDefaultInsertValue(e){this.append("null")}}const DEFAULT_MIGRATION_TABLE="kysely_migration",DEFAULT_MIGRATION_LOCK_TABLE="kysely_migration_lock";freeze({__noMigrations__:!0});class SqliteIntrospector{#e;constructor(e){this.#e=e}async getSchemas(){return[]}async getTables(e={withInternalKyselyTables:!1}){let r=this.#e.selectFrom("sqlite_master").where("type","in",["table","view"]).where("name","not like","sqlite_%").select("name").orderBy("name").$castTo();e.withInternalKyselyTables||(r=r.where("name","!=",DEFAULT_MIGRATION_TABLE).where("name","!=",DEFAULT_MIGRATION_LOCK_TABLE));const n=await r.execute();return Promise.all(n.map(({name:s})=>this.#t(s)))}async getMetadata(e){return{tables:await this.getTables(e)}}async#t(e){const r=this.#e,n=await r.selectFrom("sqlite_master").where("name","=",e).select(["sql","type"]).$castTo().executeTakeFirstOrThrow(),s=n.sql?.split(/[\(\),]/)?.find(u=>u.toLowerCase().includes("autoincrement"))?.trimStart()?.split(/\s+/)?.[0]?.replace(/["`]/g,""),a=await r.selectFrom(sql`pragma_table_info(${e})`.as("table_info")).select(["name","type","notnull","dflt_value"]).orderBy("cid").execute();return{name:e,isView:n.type==="view",columns:a.map(u=>({name:u.name,dataType:u.type,isNullable:!u.notnull,isAutoIncrementing:u.name===s,hasDefaultValue:u.dflt_value!=null}))}}}class SqliteAdapter extends DialectAdapterBase{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(e,r){}async releaseMigrationLock(e,r){}}class SqliteDialect{#e;constructor(e){this.#e=freeze({...e})}createDriver(){return new SqliteDriver(this.#e)}createQueryCompiler(){return new SqliteQueryCompiler}createAdapter(){return new SqliteAdapter}createIntrospector(e){return new SqliteIntrospector(e)}}function toBytes(t){return Uint8Array.from([...t].map(e=>e.charCodeAt(0)))}function fromBytes(t){return String.fromCharCode(...t)}function encode(t){return t.length?[fromBytes(t[0].site_id),...t.flatMap(e=>[e.cid,fromBytes(e.pk),e.table,JSON.stringify(e.val),e.db_version,e.col_version,e.cl,e.seq])]:[]}function decode(t){if(!t[0])return[];const e=toBytes(t[0]),r=[];for(let n=1;n<t.length;n+=8){const s=JSON.parse(t[n+3]);r.push({site_id:e,cid:t[n],pk:toBytes(t[n+1]),table:t[n+2],val:s&&typeof s=="object"?new Uint8Array(Object.values(s)):s,db_version:t[n+4],col_version:t[n+5],cl:t[n+6],seq:t[n+7]})}return r}function selectVersion(){const t=sql`SELECT 
    crsql_db_version() as current,
    IFNULL(MAX(version), 0) as synced
  FROM "__crstore_sync"`;return{execute:()=>t.execute(this).then(e=>e.rows[0])}}function updateVersion(t){return this.updateTable("__crstore_sync").set({version:t??sql`crsql_db_version()`})}function selectClient(){const t=sql`SELECT crsql_site_id() as client`;return{execute:()=>t.execute(this).then(e=>fromBytes(e.rows[0].client))}}function changesSince(t,e){let r=this.selectFrom("crsql_changes").select(sql`crsql_site_id()`.as("site_id")).select(["cid","pk","table","val","db_version","col_version","cl","seq"]).where("db_version",">",t).$if(!t,n=>n.where("cid","!=","__crsql_del")).$if(e===null,n=>n.where("site_id","is",sql`crsql_site_id()`)).$if(typeof e=="string",n=>n.where("site_id","is not",toBytes(e))).$castTo();return{execute:()=>r.execute().then(encode)}}function insertChanges(t){const e=async r=>{t.length&&(await r.insertInto("crsql_changes").values(decode(t)).execute(),await updateVersion.bind(r)().execute())};return{execute:()=>this.isTransaction?e(this):this.transaction().execute(e)}}function resolveChanges(t){return{execute:()=>applyOperation.bind(this)(e=>insertChanges.bind(e)(t).execute()).execute().then(e=>e.changes)}}function applyOperation(t,...e){return{execute:()=>this.transaction().execute(async r=>{const{current:n}=await selectVersion.bind(r)().execute(),s=await t(r,...e),a=await changesSince.bind(r)(n).execute();return{result:s,changes:a}})}}function finalize(){const t=sql`select crsql_finalize();`;return{execute:()=>t.execute(this)}}function affectedTables(t){if(Array.isArray(t)){const e=new Set;for(let r=3;r<t.length;r+=8)e.add(t[r]);return[...e]}if(t.kind==="TableNode")return[t.table.identifier.name];if(t.kind==="ReferenceNode"&&t.table)return[t.table.table.identifier.name];if(t.kind==="AliasNode")return affectedTables(t.node);if(t.kind==="SelectQueryNode"){const e=[...t.from?.froms||[],...t.joins?.map(r=>r.table)||[],...t.selections?.map(r=>r.selection)||[],...t.with?.expressions.map(r=>r.expression)||[]].flatMap(affectedTables);return[...new Set(e)]}return[]}const wasmUrl=""+new URL("../assets/crsqlite.mmzGBJgt.wasm",import.meta.url).href;var Module=(()=>{var t=import.meta.url;return function(e={}){var r=e,n,s;r.ready=new Promise((i,o)=>{n=i,s=o});var a=Object.assign({},r),u="./this.program",d=(i,o)=>{throw o},f=typeof window=="object",y=typeof importScripts=="function",b="",w;(f||y)&&(y?b=self.location.href:typeof document<"u"&&document.currentScript&&(b=document.currentScript.src),t&&(b=t),b.indexOf("blob:")!==0?b=b.substr(0,b.replace(/[?#].*/,"").lastIndexOf("/")+1):b="",y&&(w=i=>{var o=new XMLHttpRequest;return o.open("GET",i,!1),o.responseType="arraybuffer",o.send(null),new Uint8Array(o.response)}));var A=r.print||console.log.bind(console),R=r.printErr||console.error.bind(console);Object.assign(r,a),a=null,r.thisProgram&&(u=r.thisProgram),r.quit&&(d=r.quit);var I;r.wasmBinary&&(I=r.wasmBinary);var h=r.noExitRuntime||!0;typeof WebAssembly!="object"&&te("no native wasm support detected");var N,m=!1,E,v,C,$,T,q,Y,z;function M(){var i=N.buffer;r.HEAP8=v=new Int8Array(i),r.HEAP16=$=new Int16Array(i),r.HEAPU8=C=new Uint8Array(i),r.HEAPU16=new Uint16Array(i),r.HEAP32=T=new Int32Array(i),r.HEAPU32=q=new Uint32Array(i),r.HEAPF32=Y=new Float32Array(i),r.HEAPF64=z=new Float64Array(i)}var W=[],V=[],ae=[],G=[],me=0;function Oe(){var i=r.preRun.shift();W.unshift(i)}var P=0,J=null;function te(i){throw r.onAbort&&r.onAbort(i),i="Aborted("+i+")",R(i),m=!0,E=1,i=new WebAssembly.RuntimeError(i+". Build with -sASSERTIONS for more info."),s(i),i}function le(i){return i.startsWith("data:application/octet-stream;base64,")}var X;if(r.locateFile){if(X="crsqlite.wasm",!le(X)){var ye=X;X=r.locateFile?r.locateFile(ye,b):b+ye}}else X=new URL(""+new URL("../assets/crsqlite.mmzGBJgt.wasm",import.meta.url).href,import.meta.url).href;function ge(i){if(i==X&&I)return new Uint8Array(I);if(w)return w(i);throw"both async and sync fetching of the wasm failed"}function be(i){return I||!f&&!y||typeof fetch!="function"?Promise.resolve().then(()=>ge(i)):fetch(i,{credentials:"same-origin"}).then(o=>{if(!o.ok)throw"failed to load wasm binary file at '"+i+"'";return o.arrayBuffer()}).catch(()=>ge(i))}function ke(i,o,l){return be(i).then(c=>WebAssembly.instantiate(c,o)).then(c=>c).then(l,c=>{R(`failed to asynchronously prepare wasm: ${c}`),te(c)})}function Ae(i,o){var l=X;return I||typeof WebAssembly.instantiateStreaming!="function"||le(l)||typeof fetch!="function"?ke(l,i,o):fetch(l,{credentials:"same-origin"}).then(c=>WebAssembly.instantiateStreaming(c,i).then(o,function(p){return R(`wasm streaming compile failed: ${p}`),R("falling back to ArrayBuffer instantiation"),ke(l,i,o)}))}var U,ne;function He(i){this.name="ExitStatus",this.message=`Program terminated with exit(${i})`,this.status=i}var Pe=i=>{for(;0<i.length;)i.shift()(r)};function se(i,o="i8"){switch(o.endsWith("*")&&(o="*"),o){case"i1":return v[i>>0];case"i8":return v[i>>0];case"i16":return $[i>>1];case"i32":return T[i>>2];case"i64":te("to do getValue(i64) use WASM_BIGINT");case"float":return Y[i>>2];case"double":return z[i>>3];case"*":return q[i>>2];default:te(`invalid type for getValue: ${o}`)}}function de(i,o,l="i8"){switch(l.endsWith("*")&&(l="*"),l){case"i1":v[i>>0]=o;break;case"i8":v[i>>0]=o;break;case"i16":$[i>>1]=o;break;case"i32":T[i>>2]=o;break;case"i64":te("to do setValue(i64) use WASM_BIGINT");case"float":Y[i>>2]=o;break;case"double":z[i>>3]=o;break;case"*":q[i>>2]=o;break;default:te(`invalid type for setValue: ${l}`)}}var Ce=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0,j=(i,o,l)=>{var c=o+l;for(l=o;i[l]&&!(l>=c);)++l;if(16<l-o&&i.buffer&&Ce)return Ce.decode(i.subarray(o,l));for(c="";o<l;){var p=i[o++];if(p&128){var g=i[o++]&63;if((p&224)==192)c+=String.fromCharCode((p&31)<<6|g);else{var _=i[o++]&63;p=(p&240)==224?(p&15)<<12|g<<6|_:(p&7)<<18|g<<12|_<<6|i[o++]&63,65536>p?c+=String.fromCharCode(p):(p-=65536,c+=String.fromCharCode(55296|p>>10,56320|p&1023))}}else c+=String.fromCharCode(p)}return c},je=(i,o)=>{for(var l=0,c=i.length-1;0<=c;c--){var p=i[c];p==="."?i.splice(c,1):p===".."?(i.splice(c,1),l++):l&&(i.splice(c,1),l--)}if(o)for(;l;l--)i.unshift("..");return i},Se=i=>{var o=i.charAt(0)==="/",l=i.substr(-1)==="/";return(i=je(i.split("/").filter(c=>!!c),!o).join("/"))||o||(i="."),i&&l&&(i+="/"),(o?"/":"")+i},ot=i=>{var o=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(i).slice(1);return i=o[0],o=o[1],!i&&!o?".":(o&&(o=o.substr(0,o.length-1)),i+o)},ze=i=>{if(i==="/")return"/";i=Se(i),i=i.replace(/\/$/,"");var o=i.lastIndexOf("/");return o===-1?i:i.substr(o+1)},Q=()=>{if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function")return i=>crypto.getRandomValues(i);te("initRandomDevice")},Z=i=>(Z=Q())(i);function oe(){for(var i="",o=!1,l=arguments.length-1;-1<=l&&!o;l--){if(o=0<=l?arguments[l]:"/",typeof o!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!o)return"";i=o+"/"+i,o=o.charAt(0)==="/"}return i=je(i.split("/").filter(c=>!!c),!o).join("/"),(o?"/":"")+i||"."}var Ne=[],he=i=>{for(var o=0,l=0;l<i.length;++l){var c=i.charCodeAt(l);127>=c?o++:2047>=c?o+=2:55296<=c&&57343>=c?(o+=4,++l):o+=3}return o},ue=(i,o,l,c)=>{if(!(0<c))return 0;var p=l;c=l+c-1;for(var g=0;g<i.length;++g){var _=i.charCodeAt(g);if(55296<=_&&57343>=_){var k=i.charCodeAt(++g);_=65536+((_&1023)<<10)|k&1023}if(127>=_){if(l>=c)break;o[l++]=_}else{if(2047>=_){if(l+1>=c)break;o[l++]=192|_>>6}else{if(65535>=_){if(l+2>=c)break;o[l++]=224|_>>12}else{if(l+3>=c)break;o[l++]=240|_>>18,o[l++]=128|_>>12&63}o[l++]=128|_>>6&63}o[l++]=128|_&63}}return o[l]=0,l-p},We=[];function Te(i,o){We[i]={input:[],Ub:[],ec:o},ft(i,at)}var at={open(i){var o=We[i.node.ic];if(!o)throw new L(43);i.Vb=o,i.seekable=!1},close(i){i.Vb.ec.lc(i.Vb)},lc(i){i.Vb.ec.lc(i.Vb)},read(i,o,l,c){if(!i.Vb||!i.Vb.ec.Ac)throw new L(60);for(var p=0,g=0;g<c;g++){try{var _=i.Vb.ec.Ac(i.Vb)}catch{throw new L(29)}if(_===void 0&&p===0)throw new L(6);if(_==null)break;p++,o[l+g]=_}return p&&(i.node.timestamp=Date.now()),p},write(i,o,l,c){if(!i.Vb||!i.Vb.ec.uc)throw new L(60);try{for(var p=0;p<c;p++)i.Vb.ec.uc(i.Vb,o[l+p])}catch{throw new L(29)}return c&&(i.node.timestamp=Date.now()),p}},lt={Ac(){e:{if(!Ne.length){var i=null;if(typeof window<"u"&&typeof window.prompt=="function"?(i=window.prompt("Input: "),i!==null&&(i+=`
`)):typeof readline=="function"&&(i=readline(),i!==null&&(i+=`
`)),!i){var o=null;break e}o=Array(he(i)+1),i=ue(i,o,0,o.length),o.length=i,Ne=o}o=Ne.shift()}return o},uc(i,o){o===null||o===10?(A(j(i.Ub,0)),i.Ub=[]):o!=0&&i.Ub.push(o)},lc(i){i.Ub&&0<i.Ub.length&&(A(j(i.Ub,0)),i.Ub=[])},ad(){return{Xc:25856,Zc:5,Wc:191,Yc:35387,Vc:[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},bd(){return 0},cd(){return[24,80]}},Kr={uc(i,o){o===null||o===10?(R(j(i.Ub,0)),i.Ub=[]):o!=0&&i.Ub.push(o)},lc(i){i.Ub&&0<i.Ub.length&&(R(j(i.Ub,0)),i.Ub=[])}};function gt(i,o){var l=i.Qb?i.Qb.length:0;l>=o||(o=Math.max(o,l*(1048576>l?2:1.125)>>>0),l!=0&&(o=Math.max(o,256)),l=i.Qb,i.Qb=new Uint8Array(o),0<i.Sb&&i.Qb.set(l.subarray(0,i.Sb),0))}var K={Yb:null,Xb(){return K.createNode(null,"/",16895,0)},createNode(i,o,l,c){if((l&61440)===24576||(l&61440)===4096)throw new L(63);return K.Yb||(K.Yb={dir:{node:{Wb:K.Fb.Wb,Tb:K.Fb.Tb,fc:K.Fb.fc,mc:K.Fb.mc,Ec:K.Fb.Ec,rc:K.Fb.rc,pc:K.Fb.pc,Dc:K.Fb.Dc,qc:K.Fb.qc},stream:{bc:K.Pb.bc}},file:{node:{Wb:K.Fb.Wb,Tb:K.Fb.Tb},stream:{bc:K.Pb.bc,read:K.Pb.read,write:K.Pb.write,xc:K.Pb.xc,nc:K.Pb.nc,oc:K.Pb.oc}},link:{node:{Wb:K.Fb.Wb,Tb:K.Fb.Tb,jc:K.Fb.jc},stream:{}},yc:{node:{Wb:K.Fb.Wb,Tb:K.Fb.Tb},stream:Zr}}),l=St(i,o,l,c),Ie(l.mode)?(l.Fb=K.Yb.dir.node,l.Pb=K.Yb.dir.stream,l.Qb={}):(l.mode&61440)===32768?(l.Fb=K.Yb.file.node,l.Pb=K.Yb.file.stream,l.Sb=0,l.Qb=null):(l.mode&61440)===40960?(l.Fb=K.Yb.link.node,l.Pb=K.Yb.link.stream):(l.mode&61440)===8192&&(l.Fb=K.Yb.yc.node,l.Pb=K.Yb.yc.stream),l.timestamp=Date.now(),i&&(i.Qb[o]=l,i.timestamp=l.timestamp),l},$c(i){return i.Qb?i.Qb.subarray?i.Qb.subarray(0,i.Sb):new Uint8Array(i.Qb):new Uint8Array(0)},Fb:{Wb(i){var o={};return o.Kc=(i.mode&61440)===8192?i.id:1,o.Bc=i.id,o.mode=i.mode,o.Qc=1,o.uid=0,o.Nc=0,o.ic=i.ic,Ie(i.mode)?o.size=4096:(i.mode&61440)===32768?o.size=i.Sb:(i.mode&61440)===40960?o.size=i.link.length:o.size=0,o.Gc=new Date(i.timestamp),o.Pc=new Date(i.timestamp),o.Jc=new Date(i.timestamp),o.Hc=4096,o.Ic=Math.ceil(o.size/o.Hc),o},Tb(i,o){if(o.mode!==void 0&&(i.mode=o.mode),o.timestamp!==void 0&&(i.timestamp=o.timestamp),o.size!==void 0&&(o=o.size,i.Sb!=o))if(o==0)i.Qb=null,i.Sb=0;else{var l=i.Qb;i.Qb=new Uint8Array(o),l&&i.Qb.set(l.subarray(0,Math.min(o,i.Sb))),i.Sb=o}},fc(){throw ct[44]},mc(i,o,l,c){return K.createNode(i,o,l,c)},Ec(i,o,l){if(Ie(i.mode)){try{var c=Be(o,l)}catch{}if(c)for(var p in c.Qb)throw new L(55)}delete i.parent.Qb[i.name],i.parent.timestamp=Date.now(),i.name=l,o.Qb[l]=i,o.timestamp=i.parent.timestamp,i.parent=o},rc(i,o){delete i.Qb[o],i.timestamp=Date.now()},pc(i,o){var l=Be(i,o),c;for(c in l.Qb)throw new L(55);delete i.Qb[o],i.timestamp=Date.now()},Dc(i){var o=[".",".."],l;for(l in i.Qb)i.Qb.hasOwnProperty(l)&&o.push(l);return o},qc(i,o,l){return i=K.createNode(i,o,41471,0),i.link=l,i},jc(i){if((i.mode&61440)!==40960)throw new L(28);return i.link}},Pb:{read(i,o,l,c,p){var g=i.node.Qb;if(p>=i.node.Sb)return 0;if(i=Math.min(i.node.Sb-p,c),8<i&&g.subarray)o.set(g.subarray(p,p+i),l);else for(c=0;c<i;c++)o[l+c]=g[p+c];return i},write(i,o,l,c,p,g){if(o.buffer===v.buffer&&(g=!1),!c)return 0;if(i=i.node,i.timestamp=Date.now(),o.subarray&&(!i.Qb||i.Qb.subarray)){if(g)return i.Qb=o.subarray(l,l+c),i.Sb=c;if(i.Sb===0&&p===0)return i.Qb=o.slice(l,l+c),i.Sb=c;if(p+c<=i.Sb)return i.Qb.set(o.subarray(l,l+c),p),c}if(gt(i,p+c),i.Qb.subarray&&o.subarray)i.Qb.set(o.subarray(l,l+c),p);else for(g=0;g<c;g++)i.Qb[p+g]=o[l+g];return i.Sb=Math.max(i.Sb,p+c),c},bc(i,o,l){if(l===1?o+=i.position:l===2&&(i.node.mode&61440)===32768&&(o+=i.node.Sb),0>o)throw new L(28);return o},xc(i,o,l){gt(i.node,o+l),i.node.Sb=Math.max(i.node.Sb,o+l)},nc(i,o,l,c,p){if((i.node.mode&61440)!==32768)throw new L(43);if(i=i.node.Qb,p&2||i.buffer!==v.buffer){if((0<l||l+o<i.length)&&(i.subarray?i=i.subarray(l,l+o):i=Array.prototype.slice.call(i,l,l+o)),l=!0,o=65536*Math.ceil(o/65536),(p=Pr(65536,o))?(C.fill(0,p,p+o),o=p):o=0,!o)throw new L(48);v.set(i,o)}else l=!1,o=i.byteOffset;return{Rc:o,Fc:l}},oc(i,o,l,c){return K.Pb.write(i,o,0,c,l,!1),0}}},Gr=(i,o)=>{var l=0;return i&&(l|=365),o&&(l|=146),l},ut=null,Ot={},Me=[],Xr=1,Le=null,Tt=!0,L=null,ct={};function Ee(i,o={}){if(i=oe(i),!i)return{path:"",node:null};if(o=Object.assign({zc:!0,vc:0},o),8<o.vc)throw new L(32);i=i.split("/").filter(_=>!!_);for(var l=ut,c="/",p=0;p<i.length;p++){var g=p===i.length-1;if(g&&o.parent)break;if(l=Be(l,i[p]),c=Se(c+"/"+i[p]),l.cc&&(!g||g&&o.zc)&&(l=l.cc.root),!g||o.ac){for(g=0;(l.mode&61440)===40960;)if(l=Lt(c),c=oe(ot(c),l),l=Ee(c,{vc:o.vc+1}).node,40<g++)throw new L(32)}}return{path:c,node:l}}function Ke(i){for(var o;;){if(i===i.parent)return i=i.Xb.Cc,o?i[i.length-1]!=="/"?`${i}/${o}`:i+o:i;o=o?`${i.name}/${o}`:i.name,i=i.parent}}function dt(i,o){for(var l=0,c=0;c<o.length;c++)l=(l<<5)-l+o.charCodeAt(c)|0;return(i+l>>>0)%Le.length}function It(i){var o=dt(i.parent.id,i.name);if(Le[o]===i)Le[o]=i.dc;else for(o=Le[o];o;){if(o.dc===i){o.dc=i.dc;break}o=o.dc}}function Be(i,o){var l;if(l=(l=Qe(i,"x"))?l:i.Fb.fc?0:2)throw new L(l,i);for(l=Le[dt(i.id,o)];l;l=l.dc){var c=l.name;if(l.parent.id===i.id&&c===o)return l}return i.Fb.fc(i,o)}function St(i,o,l,c){return i=new Dr(i,o,l,c),o=dt(i.parent.id,i.name),i.dc=Le[o],Le[o]=i}function Ie(i){return(i&61440)===16384}function vt(i){var o=["r","w","rw"][i&3];return i&512&&(o+="w"),o}function Qe(i,o){if(Tt)return 0;if(!o.includes("r")||i.mode&292){if(o.includes("w")&&!(i.mode&146)||o.includes("x")&&!(i.mode&73))return 2}else return 2;return 0}function Ct(i,o){try{return Be(i,o),20}catch{}return Qe(i,"wx")}function Rt(i,o,l){try{var c=Be(i,o)}catch(p){return p.Rb}if(i=Qe(i,"wx"))return i;if(l){if(!Ie(c.mode))return 54;if(c===c.parent||Ke(c)==="/")return 10}else if(Ie(c.mode))return 31;return 0}function Yr(){for(var i=0;4096>=i;i++)if(!Me[i])return i;throw new L(33)}function we(i){if(i=Me[i],!i)throw new L(8);return i}function xt(i,o=-1){return Ve||(Ve=function(){this.kc={}},Ve.prototype={},Object.defineProperties(Ve.prototype,{object:{get(){return this.node},set(l){this.node=l}},flags:{get(){return this.kc.flags},set(l){this.kc.flags=l}},position:{get(){return this.kc.position},set(l){this.kc.position=l}}})),i=Object.assign(new Ve,i),o==-1&&(o=Yr()),i.Zb=o,Me[o]=i}var Zr={open(i){i.Pb=Ot[i.node.ic].Pb,i.Pb.open&&i.Pb.open(i)},bc(){throw new L(70)}};function ft(i,o){Ot[i]={Pb:o}}function kt(i,o){var l=o==="/",c=!o;if(l&&ut)throw new L(10);if(!l&&!c){var p=Ee(o,{zc:!1});if(o=p.path,p=p.node,p.cc)throw new L(10);if(!Ie(p.mode))throw new L(54)}o={type:i,ed:{},Cc:o,Oc:[]},i=i.Xb(o),i.Xb=o,o.root=i,l?ut=i:p&&(p.cc=o,p.Xb&&p.Xb.Oc.push(o))}function ht(i,o,l){var c=Ee(i,{parent:!0}).node;if(i=ze(i),!i||i==="."||i==="..")throw new L(28);var p=Ct(c,i);if(p)throw new L(p);if(!c.Fb.mc)throw new L(63);return c.Fb.mc(c,i,o,l)}function Re(i,o){return ht(i,(o!==void 0?o:511)&1023|16384,0)}function Ge(i,o,l){typeof l>"u"&&(l=o,o=438),ht(i,o|8192,l)}function pt(i,o){if(!oe(i))throw new L(44);var l=Ee(o,{parent:!0}).node;if(!l)throw new L(44);o=ze(o);var c=Ct(l,o);if(c)throw new L(c);if(!l.Fb.qc)throw new L(63);l.Fb.qc(l,o,i)}function At(i){var o=Ee(i,{parent:!0}).node;i=ze(i);var l=Be(o,i),c=Rt(o,i,!0);if(c)throw new L(c);if(!o.Fb.pc)throw new L(63);if(l.cc)throw new L(10);o.Fb.pc(o,i),It(l)}function Lt(i){if(i=Ee(i).node,!i)throw new L(44);if(!i.Fb.jc)throw new L(28);return oe(Ke(i.parent),i.Fb.jc(i))}function Xe(i,o){if(i=Ee(i,{ac:!o}).node,!i)throw new L(44);if(!i.Fb.Wb)throw new L(63);return i.Fb.Wb(i)}function qt(i){return Xe(i,!0)}function Dt(i,o){if(i=typeof i=="string"?Ee(i,{ac:!0}).node:i,!i.Fb.Tb)throw new L(63);i.Fb.Tb(i,{mode:o&4095|i.mode&-4096,timestamp:Date.now()})}function Wt(i,o){if(0>o)throw new L(28);if(i=typeof i=="string"?Ee(i,{ac:!0}).node:i,!i.Fb.Tb)throw new L(63);if(Ie(i.mode))throw new L(31);if((i.mode&61440)!==32768)throw new L(28);var l=Qe(i,"w");if(l)throw new L(l);i.Fb.Tb(i,{size:o,timestamp:Date.now()})}function Ye(i,o,l){if(i==="")throw new L(44);if(typeof o=="string"){var c={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090}[o];if(typeof c>"u")throw Error(`Unknown file open mode: ${o}`);o=c}if(l=o&64?(typeof l>"u"?438:l)&4095|32768:0,typeof i=="object")var p=i;else{i=Se(i);try{p=Ee(i,{ac:!(o&131072)}).node}catch{}}if(c=!1,o&64)if(p){if(o&128)throw new L(20)}else p=ht(i,l,0),c=!0;if(!p)throw new L(44);if((p.mode&61440)===8192&&(o&=-513),o&65536&&!Ie(p.mode))throw new L(54);if(!c&&(l=p?(p.mode&61440)===40960?32:Ie(p.mode)&&(vt(o)!=="r"||o&512)?31:Qe(p,vt(o)):44))throw new L(l);return o&512&&!c&&Wt(p,0),o&=-131713,p=xt({node:p,path:Ke(p),flags:o,seekable:!0,position:0,Pb:p.Pb,Uc:[],error:!1}),p.Pb.open&&p.Pb.open(p),!r.logReadFiles||o&1||(Ze||(Ze={}),i in Ze||(Ze[i]=1)),p}function Bt(i,o,l){if(i.Zb===null)throw new L(8);if(!i.seekable||!i.Pb.bc)throw new L(70);if(l!=0&&l!=1&&l!=2)throw new L(28);i.position=i.Pb.bc(i,o,l),i.Uc=[]}function Ft(){L||(L=function(i,o){this.name="ErrnoError",this.node=o,this.Sc=function(l){this.Rb=l},this.Sc(i),this.message="FS error"},L.prototype=Error(),L.prototype.constructor=L,[44].forEach(i=>{ct[i]=new L(i),ct[i].stack="<generic error, no stack>"}))}var Pt;function $e(i,o,l){i=Se("/dev/"+i);var c=Gr(!!o,!!l);mt||(mt=64);var p=mt++<<8|0;ft(p,{open(g){g.seekable=!1},close(){l&&l.buffer&&l.buffer.length&&l(10)},read(g,_,k,O){for(var S=0,D=0;D<O;D++){try{var x=o()}catch{throw new L(29)}if(x===void 0&&S===0)throw new L(6);if(x==null)break;S++,_[k+D]=x}return S&&(g.node.timestamp=Date.now()),S},write(g,_,k,O){for(var S=0;S<O;S++)try{l(_[k+S])}catch{throw new L(29)}return O&&(g.node.timestamp=Date.now()),S}}),Ge(i,c,p)}var mt,ie={},Ve,Ze;function Fe(i,o,l){if(o.charAt(0)==="/")return o;if(i=i===-100?"/":we(i).path,o.length==0){if(!l)throw new L(44);return i}return Se(i+"/"+o)}function et(i,o,l){try{var c=i(o)}catch(g){if(g&&g.node&&Se(o)!==Se(Ke(g.node)))return-54;throw g}T[l>>2]=c.Kc,T[l+4>>2]=c.mode,q[l+8>>2]=c.Qc,T[l+12>>2]=c.uid,T[l+16>>2]=c.Nc,T[l+20>>2]=c.ic,ne=[c.size>>>0,(U=c.size,1<=+Math.abs(U)?0<U?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],T[l+24>>2]=ne[0],T[l+28>>2]=ne[1],T[l+32>>2]=4096,T[l+36>>2]=c.Ic,i=c.Gc.getTime(),o=c.Pc.getTime();var p=c.Jc.getTime();return ne=[Math.floor(i/1e3)>>>0,(U=Math.floor(i/1e3),1<=+Math.abs(U)?0<U?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],T[l+40>>2]=ne[0],T[l+44>>2]=ne[1],q[l+48>>2]=i%1e3*1e3,ne=[Math.floor(o/1e3)>>>0,(U=Math.floor(o/1e3),1<=+Math.abs(U)?0<U?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],T[l+56>>2]=ne[0],T[l+60>>2]=ne[1],q[l+64>>2]=o%1e3*1e3,ne=[Math.floor(p/1e3)>>>0,(U=Math.floor(p/1e3),1<=+Math.abs(U)?0<U?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],T[l+72>>2]=ne[0],T[l+76>>2]=ne[1],q[l+80>>2]=p%1e3*1e3,ne=[c.Bc>>>0,(U=c.Bc,1<=+Math.abs(U)?0<U?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],T[l+88>>2]=ne[0],T[l+92>>2]=ne[1],0}var tt=void 0;function rt(){var i=T[tt>>2];return tt+=4,i}var Je=(i,o)=>o+2097152>>>0<4194305-!!i?(i>>>0)+4294967296*o:NaN,en=[0,31,60,91,121,152,182,213,244,274,305,335],tn=[0,31,59,90,120,151,181,212,243,273,304,334],zt=i=>{var o=he(i)+1,l=Et(o);return l&&ue(i,C,l,o),l},Nt={},Qt=()=>{if(!yt){var i={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:u||"./this.program"},o;for(o in Nt)Nt[o]===void 0?delete i[o]:i[o]=Nt[o];var l=[];for(o in i)l.push(`${o}=${i[o]}`);yt=l}return yt},yt;function Ut(){}function Mt(){}function $t(){}function Vt(){}function Jt(){}function Ht(){}function jt(){}function Kt(){}function Gt(){}function Xt(){}function Yt(){}function Zt(){}function er(){}function tr(){}function rr(){}function nr(){}function ir(){}function sr(){}function or(){}function ar(){}function lr(){}function ur(){}function cr(){}function dr(){}function fr(){}function hr(){}function pr(){}function mr(){}function Nr(){}function yr(){}function br(){}function wr(){}function Er(){}function _r(){}function gr(){}function Or(){}function Tr(){}function Ir(){}function Sr(){}function vr(){}var Cr=i=>{E=i,h||0<me||(r.onExit&&r.onExit(i),m=!0),d(i,new He(i))},bt=i=>{i instanceof He||i=="unwind"||d(1,i)},nt=i=>{try{i()}catch(o){te(o)}};function rn(i){var o={},l;for(l in i)(function(c){var p=i[c];o[c]=typeof p=="function"?function(){it.push(c);try{return p.apply(null,arguments)}finally{m||(it.pop()===c||te(),xe&&qe===1&&it.length===0&&(qe=0,nt($r),typeof Fibers<"u"&&Fibers.fd()))}}:p})(l);return o}var qe=0,xe=null,Rr=0,it=[],xr={},kr={},nn=0,wt=null,sn=[];function on(){return new Promise((i,o)=>{wt={resolve:i,reject:o}})}function an(){var i=Et(16396),o=i+12;q[i>>2]=o,q[i+4>>2]=o+16384,o=it[0];var l=xr[o];return l===void 0&&(l=nn++,xr[o]=l,kr[l]=o),T[i+8>>2]=l,i}function Ar(i){if(!m){if(qe===0){var o=!1,l=!1;i((c=0)=>{if(!m&&(Rr=c,o=!0,l)){qe=2,nt(()=>Vr(xe)),typeof Browser<"u"&&Browser.tc.Mc&&Browser.tc.resume(),c=!1;try{var p=(0,F[kr[T[xe+8>>2]]])()}catch(k){p=k,c=!0}var g=!1;if(!xe){var _=wt;_&&(wt=null,(c?_.reject:_.resolve)(p),g=!0)}if(c&&!g)throw p}}),l=!0,o||(qe=1,xe=an(),typeof Browser<"u"&&Browser.tc.Mc&&Browser.tc.pause(),nt(()=>Mr(xe)))}else qe===2?(qe=0,nt(Jr),Br(xe),xe=null,sn.forEach(c=>{if(!m)try{if(c(),!(h||0<me))try{E=c=E,Cr(c)}catch(p){bt(p)}}catch(p){bt(p)}})):te(`invalid state: ${qe}`);return Rr}}function Lr(i){return Ar(o=>{i().then(o)})}var qr={},ve=(i,o,l,c,p)=>{function g(x){return--me,O!==0&&Ur(O),o==="string"?x?j(C,x):"":o==="boolean"?!!x:x}var _={string:x=>{var B=0;if(x!=null&&x!==0){B=he(x)+1;var H=_t(B);ue(x,C,H,B),B=H}return B},array:x=>{var B=_t(x.length);return v.set(x,B),B}};i=r["_"+i];var k=[],O=0;if(c)for(var S=0;S<c.length;S++){var D=_[l[S]];D?(O===0&&(O=Qr()),k[S]=D(c[S])):k[S]=c[S]}return l=xe,c=i.apply(null,k),p=p&&p.async,me+=1,xe!=l?on().then(g):(c=g(c),p?Promise.resolve(c):c)};function Dr(i,o,l,c){i||(i=this),this.parent=i,this.Xb=i.Xb,this.cc=null,this.id=Xr++,this.name=o,this.mode=l,this.Fb={},this.Pb={},this.ic=c}Object.defineProperties(Dr.prototype,{read:{get:function(){return(this.mode&365)===365},set:function(i){i?this.mode|=365:this.mode&=-366}},write:{get:function(){return(this.mode&146)===146},set:function(i){i?this.mode|=146:this.mode&=-147}}}),Ft(),Le=Array(4096),kt(K,"/"),Re("/tmp"),Re("/home"),Re("/home/web_user"),function(){Re("/dev"),ft(259,{read:()=>0,write:(c,p,g,_)=>_}),Ge("/dev/null",259),Te(1280,lt),Te(1536,Kr),Ge("/dev/tty",1280),Ge("/dev/tty1",1536);var i=new Uint8Array(1024),o=0,l=()=>(o===0&&(o=Z(i).byteLength),i[--o]);$e("random",l),$e("urandom",l),Re("/dev/shm"),Re("/dev/shm/tmp")}(),function(){Re("/proc");var i=Re("/proc/self");Re("/proc/self/fd"),kt({Xb(){var o=St(i,"fd",16895,73);return o.Fb={fc(l,c){var p=we(+c);return l={parent:null,Xb:{Cc:"fake"},Fb:{jc:()=>p.path}},l.parent=l}},o}},"/proc/self/fd")}(),function(){const i=new Map;r.setAuthorizer=function(o,l,c){return l?i.set(o,{f:l,wc:c}):i.delete(o),ve("set_authorizer","number",["number"],[o])},Ut=function(o,l,c,p,g,_){if(i.has(o)){const{f:k,wc:O}=i.get(o);return k(O,l,c?c?j(C,c):"":null,p?p?j(C,p):"":null,g?g?j(C,g):"":null,_?_?j(C,_):"":null)}return 0}}(),function(){function i(c,p){const g=[];for(let _=0;c[p+_]!=0;++_){if(1e3<_)throw Error("C-string never terminated after 1k characters");g.push(c[p+_])}return String.fromCharCode(...g)}const o=new Map,l=new Map;r.updateHook=function(c,p){const g=o.size;return o.set(g,p),ve("update_hook","void",["number","number"],[c,g])},r.createFunction=function(c,p,g,_,k,O){const S=o.size;return o.set(S,{f:O,$b:k}),ve("create_function","number","number string number number number number".split(" "),[c,p,g,_,S,0])},r.createAggregate=function(c,p,g,_,k,O,S){const D=o.size;return o.set(D,{step:O,Lc:S,$b:k}),ve("create_function","number","number string number number number number".split(" "),[c,p,g,_,D,1])},r.getFunctionUserData=function(c){return l.get(c)},Ht=function(c,p,g,_,k,O){c=o.get(c);const S=C;k=BigInt(O)<<32n|BigInt(k)&4294967295n,c(p,i(S,g),i(S,_),k)},$t=function(c,p,g,_){c=o.get(c),l.set(p,c.$b),c.f(p,new Uint32Array(C.buffer,_,g)),l.delete(p)},Jt=function(c,p,g,_){c=o.get(c),l.set(p,c.$b),c.step(p,new Uint32Array(C.buffer,_,g)),l.delete(p)},Mt=function(c,p){c=o.get(c),l.set(p,c.$b),c.Lc(p),l.delete(p)}}(),function(){const i=new Map;r.progressHandler=function(o,l,c,p){return c?i.set(o,{f:c,wc:p}):i.delete(o),ve("progress_handler",null,["number","number"],[o,l])},Vt=function(o){if(i.has(o)){const{f:l,wc:c}=i.get(o);return l(c)}return 0}}(),function(){function i(O,S){const D=`get${O}`,x=`set${O}`;return new Proxy(new DataView(C.buffer,S,O==="Int32"?4:8),{get(B,H){if(H===D)return function(ee,fe){if(!fe)throw Error("must be little endian");return B[H](ee,fe)};if(H===x)return function(ee,fe,ce){if(!ce)throw Error("must be little endian");return B[H](ee,fe,ce)};if(typeof H=="string"&&H.match(/^(get)|(set)/))throw Error("invalid type");return B[H]}})}const o=typeof qr=="object",l=new Map,c=new Map,p=new Map,g=o?new Set:null,_=o?new Set:null,k=new Map;cr=function(O,S,D,x){k.set(O?j(C,O):"",{size:S,hc:Array.from(new Uint32Array(C.buffer,x,D))})},r.createModule=function(O,S,D,x){o&&(D.handleAsync=Lr);const B=l.size;return l.set(B,{module:D,$b:x}),x=0,D.xCreate&&(x|=1),D.xConnect&&(x|=2),D.xBestIndex&&(x|=4),D.xDisconnect&&(x|=8),D.xDestroy&&(x|=16),D.xOpen&&(x|=32),D.xClose&&(x|=64),D.xFilter&&(x|=128),D.xNext&&(x|=256),D.xEof&&(x|=512),D.xColumn&&(x|=1024),D.xRowid&&(x|=2048),D.xUpdate&&(x|=4096),D.xBegin&&(x|=8192),D.xSync&&(x|=16384),D.xCommit&&(x|=32768),D.xRollback&&(x|=65536),D.xFindFunction&&(x|=131072),D.xRename&&(x|=262144),ve("create_module","number",["number","string","number","number"],[O,S,B,x])},er=function(O,S,D,x,B,H){if(S=l.get(S),c.set(B,S),o){g.delete(B);for(const ee of g)c.delete(ee)}return x=Array.from(new Uint32Array(C.buffer,x,D)).map(ee=>ee?j(C,ee):""),S.module.xCreate(O,S.$b,x,B,i("Int32",H))},Zt=function(O,S,D,x,B,H){if(S=l.get(S),c.set(B,S),o){g.delete(B);for(const ee of g)c.delete(ee)}return x=Array.from(new Uint32Array(C.buffer,x,D)).map(ee=>ee?j(C,ee):""),S.module.xConnect(O,S.$b,x,B,i("Int32",H))},Kt=function(O,S){var D=c.get(O),x=k.get("sqlite3_index_info").hc;const B={};B.nConstraint=se(S+x[0],"i32"),B.aConstraint=[];for(var H=se(S+x[1],"*"),ee=k.get("sqlite3_index_constraint").size,fe=0;fe<B.nConstraint;++fe){var ce=B.aConstraint,_e=ce.push,pe=H+fe*ee,Ue=k.get("sqlite3_index_constraint").hc,De={};De.iColumn=se(pe+Ue[0],"i32"),De.op=se(pe+Ue[1],"i8"),De.usable=!!se(pe+Ue[2],"i8"),_e.call(ce,De)}for(B.nOrderBy=se(S+x[2],"i32"),B.aOrderBy=[],H=se(S+x[3],"*"),ee=k.get("sqlite3_index_orderby").size,fe=0;fe<B.nOrderBy;++fe)ce=B.aOrderBy,_e=ce.push,pe=H+fe*ee,Ue=k.get("sqlite3_index_orderby").hc,De={},De.iColumn=se(pe+Ue[0],"i32"),De.desc=!!se(pe+Ue[1],"i8"),_e.call(ce,De);for(B.aConstraintUsage=[],H=0;H<B.nConstraint;++H)B.aConstraintUsage.push({argvIndex:0,omit:!1});for(B.idxNum=se(S+x[5],"i32"),B.idxStr=null,B.orderByConsumed=!!se(S+x[8],"i8"),B.estimatedCost=se(S+x[9],"double"),B.estimatedRows=se(S+x[10],"i32"),B.idxFlags=se(S+x[11],"i32"),B.colUsed=se(S+x[12],"i32"),O=D.module.xBestIndex(O,B),D=k.get("sqlite3_index_info").hc,x=se(S+D[4],"*"),H=k.get("sqlite3_index_constraint_usage").size,_e=0;_e<B.nConstraint;++_e)ee=x+_e*H,ce=B.aConstraintUsage[_e],pe=k.get("sqlite3_index_constraint_usage").hc,de(ee+pe[0],ce.argvIndex,"i32"),de(ee+pe[1],ce.omit?1:0,"i8");return de(S+D[5],B.idxNum,"i32"),typeof B.idxStr=="string"&&(x=he(B.idxStr),H=ve("sqlite3_malloc","number",["number"],[x+1]),ue(B.idxStr,C,H,x+1),de(S+D[6],H,"*"),de(S+D[7],1,"i32")),de(S+D[8],B.orderByConsumed,"i32"),de(S+D[9],B.estimatedCost,"double"),de(S+D[10],B.estimatedRows,"i32"),de(S+D[11],B.idxFlags,"i32"),O},rr=function(O){const S=c.get(O);return o?g.add(O):c.delete(O),S.module.xDisconnect(O)},tr=function(O){const S=c.get(O);return o?g.add(O):c.delete(O),S.module.xDestroy(O)},or=function(O,S){const D=c.get(O);if(p.set(S,D),o){_.delete(S);for(const x of _)p.delete(x)}return D.module.xOpen(O,S)},Gt=function(O){const S=p.get(O);return o?_.add(O):p.delete(O),S.module.xClose(O)},nr=function(O){return p.get(O).module.xEof(O)?1:0},ir=function(O,S,D,x,B){const H=p.get(O);return D=D?D?j(C,D):"":null,B=new Uint32Array(C.buffer,B,x),H.module.xFilter(O,S,D,B)},sr=function(O){return p.get(O).module.xNext(O)},Xt=function(O,S,D){return p.get(O).module.xColumn(O,S,D)},ur=function(O,S){return p.get(O).module.xRowid(O,i("BigInt64",S))},fr=function(O,S,D,x){const B=c.get(O);return D=new Uint32Array(C.buffer,D,S),B.module.xUpdate(O,D,i("BigInt64",x))},jt=function(O){return c.get(O).module.xBegin(O)},dr=function(O){return c.get(O).module.xSync(O)},Yt=function(O){return c.get(O).module.xCommit(O)},lr=function(O){return c.get(O).module.xRollback(O)},ar=function(O,S){const D=c.get(O);return S=S?j(C,S):"",D.module.xRename(O,S)}}(),function(){function i(_,k){const O=`get${_}`,S=`set${_}`;return new Proxy(new DataView(C.buffer,k,_==="Int32"?4:8),{get(D,x){if(x===O)return function(B,H){if(!H)throw Error("must be little endian");return D[x](B,H)};if(x===S)return function(B,H,ee){if(!ee)throw Error("must be little endian");return D[x](B,H,ee)};if(typeof x=="string"&&x.match(/^(get)|(set)/))throw Error("invalid type");return D[x]}})}function o(_){return _>>=2,q[_]+q[_+1]*2**32}const l=typeof qr=="object",c=new Map,p=new Map;r.registerVFS=function(_,k){if(ve("sqlite3_vfs_find","number",["string"],[_.name]))throw Error(`VFS '${_.name}' already registered`);l&&(_.handleAsync=Lr);var O=_.dd??64;const S=r._malloc(4);return k=ve("register_vfs","number",["string","number","number","number"],[_.name,O,k?1:0,S]),k||(O=se(S,"*"),c.set(O,_)),r._free(S),k};const g=l?new Set:null;mr=function(_){const k=p.get(_);return l?g.add(_):p.delete(_),k.xClose(_)},gr=function(_,k,O,S){return p.get(_).xRead(_,C.subarray(k,k+O),o(S))},vr=function(_,k,O,S){return p.get(_).xWrite(_,C.subarray(k,k+O),o(S))},Ir=function(_,k){return p.get(_).xTruncate(_,o(k))},Tr=function(_,k){return p.get(_).xSync(_,k)},wr=function(_,k){const O=p.get(_);return k=i("BigInt64",k),O.xFileSize(_,k)},Er=function(_,k){return p.get(_).xLock(_,k)},Sr=function(_,k){return p.get(_).xUnlock(_,k)},pr=function(_,k){const O=p.get(_);return k=i("Int32",k),O.xCheckReservedLock(_,k)},br=function(_,k,O){const S=p.get(_);return O=new DataView(C.buffer,O),S.xFileControl(_,k,O)},Or=function(_){return p.get(_).xSectorSize(_)},yr=function(_){return p.get(_).xDeviceCharacteristics(_)},_r=function(_,k,O,S,D){if(_=c.get(_),p.set(O,_),l){g.delete(O);for(var x of g)p.delete(x)}if(x=null,S&64){x=1;const B=[];for(;x;){const H=C[k++];if(H)B.push(H);else switch(C[k]||(x=null),x){case 1:B.push(63),x=2;break;case 2:B.push(61),x=3;break;case 3:B.push(38),x=2}}x=new TextDecoder().decode(new Uint8Array(B))}else k&&(x=k?j(C,k):"");return D=i("Int32",D),_.xOpen(x,O,S,D)},Nr=function(_,k,O){return c.get(_).xDelete(k?j(C,k):"",O)},hr=function(_,k,O,S){return _=c.get(_),S=i("Int32",S),_.xAccess(k?j(C,k):"",O,S)}}();var ln={a:(i,o,l,c)=>{te(`Assertion failed: ${i?j(C,i):""}, at: `+[o?o?j(C,o):"":"unknown filename",l,c?c?j(C,c):"":"unknown function"])},L:function(i,o){try{return i=i?j(C,i):"",Dt(i,o),0}catch(l){if(typeof ie>"u"||l.name!=="ErrnoError")throw l;return-l.Rb}},N:function(i,o,l){try{if(o=o?j(C,o):"",o=Fe(i,o),l&-8)return-28;var c=Ee(o,{ac:!0}).node;return c?(i="",l&4&&(i+="r"),l&2&&(i+="w"),l&1&&(i+="x"),i&&Qe(c,i)?-2:0):-44}catch(p){if(typeof ie>"u"||p.name!=="ErrnoError")throw p;return-p.Rb}},M:function(i,o){try{var l=we(i);return Dt(l.node,o),0}catch(c){if(typeof ie>"u"||c.name!=="ErrnoError")throw c;return-c.Rb}},K:function(i){try{var o=we(i).node,l=typeof o=="string"?Ee(o,{ac:!0}).node:o;if(!l.Fb.Tb)throw new L(63);return l.Fb.Tb(l,{timestamp:Date.now()}),0}catch(c){if(typeof ie>"u"||c.name!=="ErrnoError")throw c;return-c.Rb}},b:function(i,o,l){tt=l;try{var c=we(i);switch(o){case 0:var p=rt();if(0>p)return-28;for(;Me[p];)p++;return xt(c,p).Zb;case 1:case 2:return 0;case 3:return c.flags;case 4:return p=rt(),c.flags|=p,0;case 5:return p=rt(),$[p+0>>1]=2,0;case 6:case 7:return 0;case 16:case 8:return-28;case 9:return T[Wr()>>2]=28,-1;default:return-28}}catch(g){if(typeof ie>"u"||g.name!=="ErrnoError")throw g;return-g.Rb}},J:function(i,o){try{var l=we(i);return et(Xe,l.path,o)}catch(c){if(typeof ie>"u"||c.name!=="ErrnoError")throw c;return-c.Rb}},n:function(i,o,l){o=Je(o,l);try{if(isNaN(o))return 61;var c=we(i);if(!(c.flags&2097155))throw new L(28);return Wt(c.node,o),0}catch(p){if(typeof ie>"u"||p.name!=="ErrnoError")throw p;return-p.Rb}},D:function(i,o){try{if(o===0)return-28;var l=he("/")+1;return o<l?-68:(ue("/",C,i,o),l)}catch(c){if(typeof ie>"u"||c.name!=="ErrnoError")throw c;return-c.Rb}},G:function(i,o){try{return i=i?j(C,i):"",et(qt,i,o)}catch(l){if(typeof ie>"u"||l.name!=="ErrnoError")throw l;return-l.Rb}},A:function(i,o,l){try{return o=o?j(C,o):"",o=Fe(i,o),o=Se(o),o[o.length-1]==="/"&&(o=o.substr(0,o.length-1)),Re(o,l),0}catch(c){if(typeof ie>"u"||c.name!=="ErrnoError")throw c;return-c.Rb}},F:function(i,o,l,c){try{o=o?j(C,o):"";var p=c&256;return o=Fe(i,o,c&4096),et(p?qt:Xe,o,l)}catch(g){if(typeof ie>"u"||g.name!=="ErrnoError")throw g;return-g.Rb}},z:function(i,o,l,c){tt=c;try{o=o?j(C,o):"",o=Fe(i,o);var p=c?rt():0;return Ye(o,l,p).Zb}catch(g){if(typeof ie>"u"||g.name!=="ErrnoError")throw g;return-g.Rb}},w:function(i,o,l,c){try{if(o=o?j(C,o):"",o=Fe(i,o),0>=c)return-28;var p=Lt(o),g=Math.min(c,he(p)),_=v[l+g];return ue(p,C,l,c+1),v[l+g]=_,g}catch(k){if(typeof ie>"u"||k.name!=="ErrnoError")throw k;return-k.Rb}},v:function(i){try{return i=i?j(C,i):"",At(i),0}catch(o){if(typeof ie>"u"||o.name!=="ErrnoError")throw o;return-o.Rb}},H:function(i,o){try{return i=i?j(C,i):"",et(Xe,i,o)}catch(l){if(typeof ie>"u"||l.name!=="ErrnoError")throw l;return-l.Rb}},r:function(i,o,l){try{if(o=o?j(C,o):"",o=Fe(i,o),l===0){i=o;var c=Ee(i,{parent:!0}).node;if(!c)throw new L(44);var p=ze(i),g=Be(c,p),_=Rt(c,p,!1);if(_)throw new L(_);if(!c.Fb.rc)throw new L(63);if(g.cc)throw new L(10);c.Fb.rc(c,p),It(g)}else l===512?At(o):te("Invalid flags passed to unlinkat");return 0}catch(k){if(typeof ie>"u"||k.name!=="ErrnoError")throw k;return-k.Rb}},q:function(i,o,l){try{if(o=o?j(C,o):"",o=Fe(i,o,!0),l){var c=q[l>>2]+4294967296*T[l+4>>2],p=T[l+8>>2];g=1e3*c+p/1e6,l+=16,c=q[l>>2]+4294967296*T[l+4>>2],p=T[l+8>>2],_=1e3*c+p/1e6}else var g=Date.now(),_=g;i=g;var k=Ee(o,{ac:!0}).node;return k.Fb.Tb(k,{timestamp:Math.max(i,_)}),0}catch(O){if(typeof ie>"u"||O.name!=="ErrnoError")throw O;return-O.Rb}},k:function(i,o,l){i=new Date(1e3*Je(i,o)),T[l>>2]=i.getSeconds(),T[l+4>>2]=i.getMinutes(),T[l+8>>2]=i.getHours(),T[l+12>>2]=i.getDate(),T[l+16>>2]=i.getMonth(),T[l+20>>2]=i.getFullYear()-1900,T[l+24>>2]=i.getDay(),o=i.getFullYear(),T[l+28>>2]=(o%4!==0||o%100===0&&o%400!==0?tn:en)[i.getMonth()]+i.getDate()-1|0,T[l+36>>2]=-(60*i.getTimezoneOffset()),o=new Date(i.getFullYear(),6,1).getTimezoneOffset();var c=new Date(i.getFullYear(),0,1).getTimezoneOffset();T[l+32>>2]=(o!=c&&i.getTimezoneOffset()==Math.min(c,o))|0},i:function(i,o,l,c,p,g,_,k){p=Je(p,g);try{if(isNaN(p))return 61;var O=we(c);if(o&2&&!(l&2)&&(O.flags&2097155)!==2)throw new L(2);if((O.flags&2097155)===1)throw new L(2);if(!O.Pb.nc)throw new L(43);var S=O.Pb.nc(O,i,p,o,l),D=S.Rc;return T[_>>2]=S.Fc,q[k>>2]=D,0}catch(x){if(typeof ie>"u"||x.name!=="ErrnoError")throw x;return-x.Rb}},j:function(i,o,l,c,p,g,_){g=Je(g,_);try{if(isNaN(g))return 61;var k=we(p);if(l&2){if((k.node.mode&61440)!==32768)throw new L(43);c&2||k.Pb.oc&&k.Pb.oc(k,C.slice(i,i+o),g,o,c)}}catch(O){if(typeof ie>"u"||O.name!=="ErrnoError")throw O;return-O.Rb}},s:(i,o,l)=>{function c(O){return(O=O.toTimeString().match(/\(([A-Za-z ]+)\)$/))?O[1]:"GMT"}var p=new Date().getFullYear(),g=new Date(p,0,1),_=new Date(p,6,1);p=g.getTimezoneOffset();var k=_.getTimezoneOffset();q[i>>2]=60*Math.max(p,k),T[o>>2]=+(p!=k),i=c(g),o=c(_),i=zt(i),o=zt(o),k<p?(q[l>>2]=i,q[l+4>>2]=o):(q[l>>2]=o,q[l+4>>2]=i)},e:()=>Date.now(),d:()=>performance.now(),t:(i,o,l)=>C.copyWithin(i,o,o+l),o:i=>{var o=C.length;if(i>>>=0,2147483648<i)return!1;for(var l=1;4>=l;l*=2){var c=o*(1+.2/l);c=Math.min(c,i+100663296);var p=Math;c=Math.max(i,c);e:{p=(p.min.call(p,2147483648,c+(65536-c%65536)%65536)-N.buffer.byteLength+65535)/65536;try{N.grow(p),M();var g=1;break e}catch{}g=void 0}if(g)return!0}return!1},B:(i,o)=>{var l=0;return Qt().forEach((c,p)=>{var g=o+l;for(p=q[i+4*p>>2]=g,g=0;g<c.length;++g)v[p++>>0]=c.charCodeAt(g);v[p>>0]=0,l+=c.length+1}),0},C:(i,o)=>{var l=Qt();q[i>>2]=l.length;var c=0;return l.forEach(p=>c+=p.length+1),q[o>>2]=c,0},f:function(i){try{var o=we(i);if(o.Zb===null)throw new L(8);o.sc&&(o.sc=null);try{o.Pb.close&&o.Pb.close(o)}catch(l){throw l}finally{Me[o.Zb]=null}return o.Zb=null,0}catch(l){if(typeof ie>"u"||l.name!=="ErrnoError")throw l;return l.Rb}},p:function(i,o){try{var l=we(i);return v[o>>0]=l.Vb?2:Ie(l.mode)?3:(l.mode&61440)===40960?7:4,$[o+2>>1]=0,ne=[0,(U=0,1<=+Math.abs(U)?0<U?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],T[o+8>>2]=ne[0],T[o+12>>2]=ne[1],ne=[0,(U=0,1<=+Math.abs(U)?0<U?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],T[o+16>>2]=ne[0],T[o+20>>2]=ne[1],0}catch(c){if(typeof ie>"u"||c.name!=="ErrnoError")throw c;return c.Rb}},y:function(i,o,l,c){try{e:{var p=we(i);i=o;for(var g,_=o=0;_<l;_++){var k=q[i>>2],O=q[i+4>>2];i+=8;var S=p,D=k,x=O,B=g,H=v;if(0>x||0>B)throw new L(28);if(S.Zb===null)throw new L(8);if((S.flags&2097155)===1)throw new L(8);if(Ie(S.node.mode))throw new L(31);if(!S.Pb.read)throw new L(28);var ee=typeof B<"u";if(!ee)B=S.position;else if(!S.seekable)throw new L(70);var fe=S.Pb.read(S,H,D,x,B);ee||(S.position+=fe);var ce=fe;if(0>ce){var _e=-1;break e}if(o+=ce,ce<O)break;typeof g<"u"&&(g+=ce)}_e=o}return q[c>>2]=_e,0}catch(pe){if(typeof ie>"u"||pe.name!=="ErrnoError")throw pe;return pe.Rb}},l:function(i,o,l,c,p){o=Je(o,l);try{if(isNaN(o))return 61;var g=we(i);return Bt(g,o,c),ne=[g.position>>>0,(U=g.position,1<=+Math.abs(U)?0<U?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],T[p>>2]=ne[0],T[p+4>>2]=ne[1],g.sc&&o===0&&c===0&&(g.sc=null),0}catch(_){if(typeof ie>"u"||_.name!=="ErrnoError")throw _;return _.Rb}},E:function(i){try{var o=we(i);return Ar(l=>{var c=o.node.Xb;c.type.Tc?c.type.Tc(c,!1,p=>{l(p?29:0)}):l(0)})}catch(l){if(typeof ie>"u"||l.name!=="ErrnoError")throw l;return l.Rb}},u:function(i,o,l,c){try{e:{var p=we(i);i=o;for(var g,_=o=0;_<l;_++){var k=q[i>>2],O=q[i+4>>2];i+=8;var S=p,D=k,x=O,B=g,H=v;if(0>x||0>B)throw new L(28);if(S.Zb===null)throw new L(8);if(!(S.flags&2097155))throw new L(8);if(Ie(S.node.mode))throw new L(31);if(!S.Pb.write)throw new L(28);S.seekable&&S.flags&1024&&Bt(S,0,2);var ee=typeof B<"u";if(!ee)B=S.position;else if(!S.seekable)throw new L(70);var fe=S.Pb.write(S,H,D,x,B,void 0);ee||(S.position+=fe);var ce=fe;if(0>ce){var _e=-1;break e}o+=ce,typeof g<"u"&&(g+=ce)}_e=o}return q[c>>2]=_e,0}catch(pe){if(typeof ie>"u"||pe.name!=="ErrnoError")throw pe;return pe.Rb}},ta:Ut,P:Mt,ia:$t,da:Vt,_:Jt,I:Ht,ma:jt,x:Kt,g:Gt,pa:Xt,ka:Yt,fa:Zt,ga:er,h:tr,m:rr,qa:nr,sa:ir,ra:sr,ea:or,ha:ar,ja:lr,oa:ur,c:cr,la:dr,na:fr,ba:hr,W:pr,aa:mr,ca:Nr,T:yr,V:br,Z:wr,Y:Er,S:_r,R:gr,U:Or,$:Tr,O:Ir,X:Sr,Q:vr},F=function(){function i(l){if(l=l.exports,F=l=rn(l),N=F.ua,M(),V.unshift(F.va),P--,r.monitorRunDependencies&&r.monitorRunDependencies(P),P==0&&J){var c=J;J=null,c()}return l}var o={a:ln};if(P++,r.monitorRunDependencies&&r.monitorRunDependencies(P),r.instantiateWasm)try{return r.instantiateWasm(o,i)}catch(l){R(`Module.instantiateWasm callback failed with error: ${l}`),s(l)}return Ae(o,function(l){i(l.instance)}).catch(s),{}}();r._sqlite3_step=i=>(r._sqlite3_step=F.wa)(i),r._sqlite3_malloc=i=>(r._sqlite3_malloc=F.xa)(i),r._sqlite3_free=i=>(r._sqlite3_free=F.ya)(i),r._sqlite3_bind_blob=(i,o,l,c,p)=>(r._sqlite3_bind_blob=F.za)(i,o,l,c,p),r._sqlite3_bind_int=(i,o,l)=>(r._sqlite3_bind_int=F.Aa)(i,o,l),r._sqlite3_bind_int64=(i,o,l,c)=>(r._sqlite3_bind_int64=F.Ba)(i,o,l,c),r._sqlite3_bind_double=(i,o,l)=>(r._sqlite3_bind_double=F.Ca)(i,o,l),r._sqlite3_bind_null=(i,o)=>(r._sqlite3_bind_null=F.Da)(i,o),r._sqlite3_clear_bindings=i=>(r._sqlite3_clear_bindings=F.Ea)(i),r._sqlite3_bind_text=(i,o,l,c,p)=>(r._sqlite3_bind_text=F.Fa)(i,o,l,c,p),r._sqlite3_close=i=>(r._sqlite3_close=F.Ga)(i),r._sqlite3_column_type=(i,o)=>(r._sqlite3_column_type=F.Ha)(i,o),r._sqlite3_column_count=i=>(r._sqlite3_column_count=F.Ia)(i),r._sqlite3_column_text=(i,o)=>(r._sqlite3_column_text=F.Ja)(i,o),r._sqlite3_column_blob=(i,o)=>(r._sqlite3_column_blob=F.Ka)(i,o),r._sqlite3_column_bytes=(i,o)=>(r._sqlite3_column_bytes=F.La)(i,o),r._sqlite3_column_double=(i,o)=>(r._sqlite3_column_double=F.Ma)(i,o),r._sqlite3_column_int=(i,o)=>(r._sqlite3_column_int=F.Na)(i,o),r._sqlite3_column_int64=(i,o)=>(r._sqlite3_column_int64=F.Oa)(i,o),r._sqlite3_column_name=(i,o)=>(r._sqlite3_column_name=F.Pa)(i,o),r._sqlite3_declare_vtab=(i,o)=>(r._sqlite3_declare_vtab=F.Qa)(i,o),r._sqlite3_errmsg=i=>(r._sqlite3_errmsg=F.Ra)(i),r._sqlite3_exec=(i,o,l,c,p)=>(r._sqlite3_exec=F.Sa)(i,o,l,c,p),r._sqlite3_finalize=i=>(r._sqlite3_finalize=F.Ta)(i),r._sqlite3_prepare_v2=(i,o,l,c,p)=>(r._sqlite3_prepare_v2=F.Ua)(i,o,l,c,p),r._sqlite3_result_int=(i,o)=>(r._sqlite3_result_int=F.Va)(i,o),r._sqlite3_result_blob=(i,o,l,c)=>(r._sqlite3_result_blob=F.Wa)(i,o,l,c),r._sqlite3_result_int64=(i,o,l)=>(r._sqlite3_result_int64=F.Xa)(i,o,l),r._sqlite3_result_double=(i,o)=>(r._sqlite3_result_double=F.Ya)(i,o),r._sqlite3_result_null=i=>(r._sqlite3_result_null=F.Za)(i),r._sqlite3_result_error=(i,o,l)=>(r._sqlite3_result_error=F._a)(i,o,l),r._sqlite3_result_text=(i,o,l,c)=>(r._sqlite3_result_text=F.$a)(i,o,l,c),r._sqlite3_sql=i=>(r._sqlite3_sql=F.ab)(i),r._sqlite3_reset=i=>(r._sqlite3_reset=F.bb)(i),r._sqlite3_value_text=i=>(r._sqlite3_value_text=F.cb)(i),r._sqlite3_value_type=i=>(r._sqlite3_value_type=F.db)(i),r._sqlite3_value_bytes=i=>(r._sqlite3_value_bytes=F.eb)(i),r._sqlite3_value_blob=i=>(r._sqlite3_value_blob=F.fb)(i),r._sqlite3_value_int=i=>(r._sqlite3_value_int=F.gb)(i),r._sqlite3_value_int64=i=>(r._sqlite3_value_int64=F.hb)(i),r._sqlite3_value_double=i=>(r._sqlite3_value_double=F.ib)(i),r._sqlite3_get_autocommit=i=>(r._sqlite3_get_autocommit=F.jb)(i),r._sqlite3_vfs_find=i=>(r._sqlite3_vfs_find=F.kb)(i),r._sqlite3_data_count=i=>(r._sqlite3_data_count=F.lb)(i),r._sqlite3_bind_parameter_count=i=>(r._sqlite3_bind_parameter_count=F.mb)(i),r._sqlite3_bind_parameter_name=(i,o)=>(r._sqlite3_bind_parameter_name=F.nb)(i,o),r._sqlite3_libversion=()=>(r._sqlite3_libversion=F.ob)(),r._sqlite3_libversion_number=()=>(r._sqlite3_libversion_number=F.pb)(),r._sqlite3_changes=i=>(r._sqlite3_changes=F.qb)(i),r._sqlite3_limit=(i,o,l)=>(r._sqlite3_limit=F.rb)(i,o,l),r._sqlite3_open_v2=(i,o,l,c)=>(r._sqlite3_open_v2=F.sb)(i,o,l,c);var Wr=()=>(Wr=F.tb)(),Et=r._malloc=i=>(Et=r._malloc=F.ub)(i),Br=r._free=i=>(Br=r._free=F.vb)(i);r._RegisterExtensionFunctions=i=>(r._RegisterExtensionFunctions=F.wb)(i),r._set_authorizer=i=>(r._set_authorizer=F.xb)(i),r._create_function=(i,o,l,c,p,g)=>(r._create_function=F.yb)(i,o,l,c,p,g),r._update_hook=(i,o)=>(r._update_hook=F.zb)(i,o),r._create_module=(i,o,l,c)=>(r._create_module=F.Ab)(i,o,l,c),r._progress_handler=(i,o)=>(r._progress_handler=F.Bb)(i,o),r._register_vfs=(i,o,l,c)=>(r._register_vfs=F.Cb)(i,o,l,c),r._getSqliteFree=()=>(r._getSqliteFree=F.Db)();var Fr=r._main=(i,o)=>(Fr=r._main=F.Eb)(i,o),Pr=(i,o)=>(Pr=F.Gb)(i,o),zr=()=>(zr=F.Hb)(),Qr=()=>(Qr=F.Ib)(),Ur=i=>(Ur=F.Jb)(i),_t=i=>(_t=F.Kb)(i),Mr=i=>(Mr=F.Lb)(i),$r=()=>($r=F.Mb)(),Vr=i=>(Vr=F.Nb)(i),Jr=()=>(Jr=F.Ob)();r.getTempRet0=zr,r.ccall=ve,r.cwrap=(i,o,l,c)=>{var p=!l||l.every(g=>g==="number"||g==="boolean");return o!=="string"&&p&&!c?r["_"+i]:function(){return ve(i,o,l,arguments,c)}},r.setValue=de,r.getValue=se,r.UTF8ToString=(i,o)=>i?j(C,i,o):"",r.stringToUTF8=(i,o,l)=>ue(i,C,o,l),r.lengthBytesUTF8=he;var st;J=function i(){st||Hr(),st||(J=i)};function Hr(){function i(){if(!st&&(st=!0,r.calledRun=!0,!m)){if(r.noFSInit||Pt||(Pt=!0,Ft(),r.stdin=r.stdin,r.stdout=r.stdout,r.stderr=r.stderr,r.stdin?$e("stdin",r.stdin):pt("/dev/tty","/dev/stdin"),r.stdout?$e("stdout",null,r.stdout):pt("/dev/tty","/dev/stdout"),r.stderr?$e("stderr",null,r.stderr):pt("/dev/tty1","/dev/stderr"),Ye("/dev/stdin",0),Ye("/dev/stdout",1),Ye("/dev/stderr",1)),Tt=!1,Pe(V),Pe(ae),n(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),jr){var o=Fr;try{var l=o(0,0);E=l,Cr(l)}catch(c){bt(c)}}if(r.postRun)for(typeof r.postRun=="function"&&(r.postRun=[r.postRun]);r.postRun.length;)o=r.postRun.shift(),G.unshift(o);Pe(G)}}if(!(0<P)){if(r.preRun)for(typeof r.preRun=="function"&&(r.preRun=[r.preRun]);r.preRun.length;)Oe();Pe(W),0<P||(r.setStatus?(r.setStatus("Running..."),setTimeout(function(){setTimeout(function(){r.setStatus("")},1),i()},1)):i())}}if(r.preInit)for(typeof r.preInit=="function"&&(r.preInit=[r.preInit]);0<r.preInit.length;)r.preInit.pop()();var jr=!0;return r.noInitialRun&&(jr=!1),Hr(),e.ready}})();const SQLITE_OK=0,SQLITE_BUSY=5,SQLITE_IOERR=10,SQLITE_NOTFOUND=12,SQLITE_CANTOPEN=14,SQLITE_MISUSE=21,SQLITE_RANGE=25,SQLITE_NOTICE=27,SQLITE_ROW=100,SQLITE_DONE=101,SQLITE_IOERR_LOCK=3850,SQLITE_IOERR_SHORT_READ=522,SQLITE_OPEN_READONLY=1,SQLITE_OPEN_READWRITE=2,SQLITE_OPEN_CREATE=4,SQLITE_OPEN_DELETEONCLOSE=8,SQLITE_OPEN_URI=64,SQLITE_LOCK_NONE=0,SQLITE_LOCK_SHARED=1,SQLITE_LOCK_RESERVED=2,SQLITE_LOCK_PENDING=3,SQLITE_LOCK_EXCLUSIVE=4,SQLITE_IOCAP_SAFE_APPEND=512,SQLITE_IOCAP_SEQUENTIAL=1024,SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN=2048,SQLITE_IOCAP_BATCH_ATOMIC=16384,SQLITE_INTEGER=1,SQLITE_FLOAT=2,SQLITE_TEXT=3,SQLITE_BLOB=4,SQLITE_NULL=5,SQLITE_UTF8=1,MAX_INT64=0x7fffffffffffffffn,MIN_INT64=-0x8000000000000000n;class SQLiteError extends Error{constructor(e,r){super(e),this.code=r}}const async=!0;function Factory(t){const e={},r=t._getSqliteFree(),n=t._malloc(8),s=[n,n+4];function a(h){if(typeof h!="string")return 0;const N=t.lengthBytesUTF8(h),m=t._sqlite3_malloc(N+1);return t.stringToUTF8(h,m,N+1),m}function u(h,N){return BigInt(N)<<32n|BigInt(h)&0xffffffffn}const d=function(){const h=BigInt(Number.MAX_SAFE_INTEGER)>>32n,N=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(m,E){return E>h||E<N?u(m,E):E*4294967296+(m&2147483647)-(m&2147483648)}}(),f=new Set;function y(h){if(!f.has(h))throw new SQLiteError("not a database",SQLITE_MISUSE)}const b=new Map;function w(h){if(!b.has(h))throw new SQLiteError("not a statement",SQLITE_MISUSE)}e.bind_collection=function(h,N){w(h);const m=Array.isArray(N),E=e.bind_parameter_count(h);for(let v=1;v<=E;++v){const C=m?v-1:e.bind_parameter_name(h,v),$=N[C];$!==void 0&&e.bind(h,v,$)}return SQLITE_OK},e.bind=function(h,N,m){switch(w(h),typeof m){case"number":return m===(m|0)?e.bind_int(h,N,m):e.bind_double(h,N,m);case"string":return e.bind_text(h,N,m);default:if(m instanceof Uint8Array||Array.isArray(m))return e.bind_blob(h,N,m);if(m===null)return e.bind_null(h,N);if(typeof m=="bigint")return e.bind_int64(h,N,m);if(m===void 0)return SQLITE_NOTICE;throw new Error("Unknown binding type "+typeof m)}},e.bind_blob=function(){const h="sqlite3_bind_blob",N=t.cwrap(h,...decl("nnnnn:n"));return function(m,E,v){w(m);const C=v.byteLength??v.length,$=t._sqlite3_malloc(C);t.HEAPU8.subarray($).set(v);const T=N(m,E,$,C,r);return I(h,T,b.get(m))}}(),e.bind_parameter_count=function(){const N=t.cwrap("sqlite3_bind_parameter_count",...decl("n:n"));return function(m){return w(m),N(m)}}(),e.bind_double=function(){const h="sqlite3_bind_double",N=t.cwrap(h,...decl("nnn:n"));return function(m,E,v){w(m);const C=N(m,E,v);return I(h,C,b.get(m))}}(),e.bind_int=function(){const h="sqlite3_bind_int",N=t.cwrap(h,...decl("nnn:n"));return function(m,E,v){if(w(m),v>2147483647||v<-2147483648)return SQLITE_RANGE;const C=N(m,E,v);return I(h,C,b.get(m))}}(),e.bind_int64=function(){const h="sqlite3_bind_int64",N=t.cwrap(h,...decl("nnnn:n"));return function(m,E,v){if(w(m),v>MAX_INT64||v<MIN_INT64)return SQLITE_RANGE;const C=v&0xffffffffn,$=v>>32n,T=N(m,E,Number(C),Number($));return I(h,T,b.get(m))}}(),e.bind_null=function(){const h="sqlite3_bind_null",N=t.cwrap(h,...decl("nn:n"));return function(m,E){w(m);const v=N(m,E);return I(h,v,b.get(m))}}(),e.bind_parameter_name=function(){const N=t.cwrap("sqlite3_bind_parameter_name",...decl("n:s"));return function(m,E){return w(m),N(m,E)}}(),e.bind_text=function(){const h="sqlite3_bind_text",N=t.cwrap(h,...decl("nnnnn:n"));return function(m,E,v){w(m);const C=a(v),$=N(m,E,C,-1,r);return I(h,$,b.get(m))}}(),e.changes=function(){const N=t.cwrap("sqlite3_changes",...decl("n:n"));return function(m){return y(m),N(m)}}(),e.close=function(){const h="sqlite3_close",N=t.cwrap(h,...decl("n:n"),{async});return async function(m){y(m);const E=await N(m);return f.delete(m),I(h,E,m)}}(),e.column=function(h,N){w(h);const m=e.column_type(h,N);switch(m){case SQLITE_BLOB:return e.column_blob(h,N);case SQLITE_FLOAT:return e.column_double(h,N);case SQLITE_INTEGER:const E=e.column_int(h,N),v=t.getTempRet0();return d(E,v);case SQLITE_NULL:return null;case SQLITE_TEXT:return e.column_text(h,N);default:throw new SQLiteError("unknown type",m)}},e.column_blob=function(){const N=t.cwrap("sqlite3_column_blob",...decl("nn:n"));return function(m,E){w(m);const v=e.column_bytes(m,E),C=N(m,E),$=t.HEAPU8.subarray(C,C+v),T=new ArrayBuffer($.byteLength),q=new Uint8Array(T);return q.set($),q}}(),e.column_bytes=function(){const N=t.cwrap("sqlite3_column_bytes",...decl("nn:n"));return function(m,E){return w(m),N(m,E)}}(),e.column_count=function(){const N=t.cwrap("sqlite3_column_count",...decl("n:n"));return function(m){return w(m),N(m)}}(),e.column_double=function(){const N=t.cwrap("sqlite3_column_double",...decl("nn:n"));return function(m,E){return w(m),N(m,E)}}(),e.column_int=function(){const N=t.cwrap("sqlite3_column_int64",...decl("nn:n"));return function(m,E){return w(m),N(m,E)}}(),e.column_int64=function(){const N=t.cwrap("sqlite3_column_int64",...decl("nn:n"));return function(m,E){w(m);const v=N(m,E),C=t.getTempRet0();return u(v,C)}}(),e.column_name=function(){const N=t.cwrap("sqlite3_column_name",...decl("nn:s"));return function(m,E){return w(m),N(m,E)}}(),e.column_names=function(h){const N=[],m=e.column_count(h);for(let E=0;E<m;++E)N.push(e.column_name(h,E));return N},e.column_text=function(){const N=t.cwrap("sqlite3_column_text",...decl("nn:s"));return function(m,E){return w(m),N(m,E)}}(),e.column_type=function(){const N=t.cwrap("sqlite3_column_type",...decl("nn:n"));return function(m,E){return w(m),N(m,E)}}(),e.update_hook=function(h,N){return y(h),t.updateHook(h,N),SQLITE_OK},e.create_function=function(h,N,m,E,v,C,$,T){if(y(h),C&&!$&&!T){const q=t.createFunction(h,N,m,E,v,C);return I("sqlite3_create_function",q,h)}if(!C&&$&&T){const q=t.createAggregate(h,N,m,E,v,$,T);return I("sqlite3_create_function",q,h)}throw new SQLiteError("invalid function combination",SQLITE_MISUSE)},e.create_module=function(h,N,m,E){y(h);const v=t.createModule(h,N,m,E);return I("sqlite3_create_module",v,h)},e.data_count=function(){const N=t.cwrap("sqlite3_data_count",...decl("n:n"));return function(m){return w(m),N(m)}}(),e.declare_vtab=function(){const N=t.cwrap("sqlite3_declare_vtab",...decl("ns:n"));return function(m,E){const v=N(m,E);return I("sqlite3_declare_vtab",v)}}(),e.exec=async function(h,N,m){for await(const E of e.statements(h,N)){let v;for(;await e.step(E)===SQLITE_ROW;)if(m){v=v??e.column_names(E);const C=e.row(E);await m(C,v)}}return SQLITE_OK},e.finalize=function(){const N=t.cwrap("sqlite3_finalize",...decl("n:n"),{async});return async function(m){if(!b.has(m))return SQLITE_MISUSE;const E=await N(m);return b.get(m),b.delete(m),E}}(),e.get_autocommit=function(){const N=t.cwrap("sqlite3_get_autocommit",...decl("n:n"));return function(m){return N(m)}}(),e.libversion=function(){const N=t.cwrap("sqlite3_libversion",...decl(":s"));return function(){return N()}}(),e.libversion_number=function(){const N=t.cwrap("sqlite3_libversion_number",...decl(":n"));return function(){return N()}}(),e.limit=function(){const N=t.cwrap("sqlite3_limit",...decl("nnn:n"));return function(m,E,v){return N(m,E,v)}}(),e.open_v2=function(){const h="sqlite3_open_v2",N=t.cwrap(h,...decl("snnn:n"),{async});return async function(m,E,v){E=E||SQLITE_OPEN_CREATE|SQLITE_OPEN_READWRITE,v=a(v);const C=await N(m,s[0],E,v),$=t.getValue(s[0],"*");return f.add($),t._sqlite3_free(v),t.ccall("RegisterExtensionFunctions","void",["number"],[$]),I(h,C),$}}(),e.prepare_v2=function(){const h="sqlite3_prepare_v2",N=t.cwrap(h,...decl("nnnnn:n"),{async});return async function(m,E){const v=await N(m,E,-1,s[0],s[1]);I(h,v,m);const C=t.getValue(s[0],"*");return C?(b.set(C,m),{stmt:C,sql:t.getValue(s[1],"*")}):null}}(),e.progress_handler=function(h,N,m,E){y(h),t.progressHandler(h,N,m,E)},e.reset=function(){const h="sqlite3_reset",N=t.cwrap(h,...decl("n:n"),{async});return async function(m){w(m);const E=await N(m);return I(h,E,b.get(m))}}(),e.result=function(h,N){switch(typeof N){case"number":N===(N|0)?e.result_int(h,N):e.result_double(h,N);break;case"string":e.result_text(h,N);break;default:if(N instanceof Uint8Array||Array.isArray(N))e.result_blob(h,N);else if(N===null)e.result_null(h);else{if(typeof N=="bigint")return e.result_int64(h,N);console.warn("unknown result converted to null",N),e.result_null(h)}break}},e.result_blob=function(){const N=t.cwrap("sqlite3_result_blob",...decl("nnnn:n"));return function(m,E){const v=E.byteLength??E.length,C=t._sqlite3_malloc(v);t.HEAPU8.subarray(C).set(E),N(m,C,v,r)}}(),e.result_double=function(){const N=t.cwrap("sqlite3_result_double",...decl("nn:n"));return function(m,E){N(m,E)}}(),e.result_int=function(){const N=t.cwrap("sqlite3_result_int",...decl("nn:n"));return function(m,E){N(m,E)}}(),e.result_int64=function(){const N=t.cwrap("sqlite3_result_int64",...decl("nnn:n"));return function(m,E){if(E>MAX_INT64||E<MIN_INT64)return SQLITE_RANGE;const v=E&0xffffffffn,C=E>>32n;N(m,Number(v),Number(C))}}(),e.result_null=function(){const N=t.cwrap("sqlite3_result_null",...decl("n:n"));return function(m){N(m)}}(),e.result_text=function(){const N=t.cwrap("sqlite3_result_text",...decl("nnnn:n"));return function(m,E){const v=a(E);N(m,v,-1,r)}}(),e.row=function(h){const N=[],m=e.data_count(h);for(let E=0;E<m;++E){const v=e.column(h,E);N.push(v?.buffer===t.HEAPU8.buffer?v.slice():v)}return N},e.set_authorizer=function(h,N,m){y(h);const E=t.setAuthorizer(h,N,m);return I("sqlite3_set_authorizer",E,h)},e.sql=function(){const N=t.cwrap("sqlite3_sql",...decl("n:s"));return function(m){return w(m),N(m)}}(),e.statements=function(h,N){return async function*(){const m=e.str_new(h,N);let E={stmt:null,sql:e.str_value(m)};try{for(;E=await e.prepare_v2(h,E.sql);)yield E.stmt,e.finalize(E.stmt),E.stmt=null}finally{E?.stmt&&e.finalize(E.stmt),e.str_finish(m)}}()},e.step=function(){const h="sqlite3_step",N=t.cwrap(h,...decl("n:n"),{async});return async function(m){w(m);const E=await N(m);return I(h,E,b.get(m),[SQLITE_ROW,SQLITE_DONE])}}();let A=0;const R=new Map;e.str_new=function(h,N=""){const m=t.lengthBytesUTF8(N),E=A++&4294967295,v={offset:t._sqlite3_malloc(m+1),bytes:m};return R.set(E,v),t.stringToUTF8(N,v.offset,v.bytes+1),E},e.str_appendall=function(h,N){if(!R.has(h))throw new SQLiteError("not a string",SQLITE_MISUSE);const m=R.get(h),E=t.lengthBytesUTF8(N),v=m.bytes+E,C=t._sqlite3_malloc(v+1);t.HEAPU8.subarray(C,C+v+1).set(t.HEAPU8.subarray(m.offset,m.offset+m.bytes)),t.stringToUTF8(N,C+m.bytes,E+1),t._sqlite3_free(m.offset),m.offset=C,m.bytes=v,R.set(h,m)},e.str_finish=function(h){if(!R.has(h))throw new SQLiteError("not a string",SQLITE_MISUSE);const N=R.get(h);R.delete(h),t._sqlite3_free(N.offset)},e.str_value=function(h){if(!R.has(h))throw new SQLiteError("not a string",SQLITE_MISUSE);return R.get(h).offset},e.user_data=function(h){return t.getFunctionUserData(h)},e.value=function(h){const N=e.value_type(h);switch(N){case SQLITE_BLOB:return e.value_blob(h);case SQLITE_FLOAT:return e.value_double(h);case SQLITE_INTEGER:const m=e.value_int(h),E=t.getTempRet0();return d(m,E);case SQLITE_NULL:return null;case SQLITE_TEXT:return e.value_text(h);default:throw new SQLiteError("unknown type",N)}},e.value_blob=function(){const N=t.cwrap("sqlite3_value_blob",...decl("n:n"));return function(m){const E=e.value_bytes(m),v=N(m);return t.HEAPU8.subarray(v,v+E)}}(),e.value_bytes=function(){const N=t.cwrap("sqlite3_value_bytes",...decl("n:n"));return function(m){return N(m)}}(),e.value_double=function(){const N=t.cwrap("sqlite3_value_double",...decl("n:n"));return function(m){return N(m)}}(),e.value_int=function(){const N=t.cwrap("sqlite3_value_int64",...decl("n:n"));return function(m){return N(m)}}(),e.value_int64=function(){const N=t.cwrap("sqlite3_value_int64",...decl("n:n"));return function(m){const E=N(m),v=t.getTempRet0();return u(E,v)}}(),e.value_text=function(){const N=t.cwrap("sqlite3_value_text",...decl("n:s"));return function(m){return N(m)}}(),e.value_type=function(){const N=t.cwrap("sqlite3_value_type",...decl("n:n"));return function(m){return N(m)}}(),e.vfs_register=function(h,N){const m=t.registerVFS(h,N);return I("sqlite3_vfs_register",m)};function I(h,N,m=null,E=[SQLITE_OK]){if(E.includes(N))return N;const v=m?t.ccall("sqlite3_errmsg","string",["number"],[m]):h;throw new SQLiteError(v,N)}return e}function decl(t){const e=[],r=t.match(/([ns@]*):([nsv@])/);switch(r[2]){case"n":e.push("number");break;case"s":e.push("string");break;case"v":e.push(null);break}const n=[];for(let s of r[1])switch(s){case"n":n.push("number");break;case"s":n.push("string");break}return e.push(n),e}class Base{mxPathName=64;xClose(e){return SQLITE_IOERR}xRead(e,r,n){return SQLITE_IOERR}xWrite(e,r,n){return SQLITE_IOERR}xTruncate(e,r){return SQLITE_IOERR}xSync(e,r){return SQLITE_OK}xFileSize(e,r){return SQLITE_IOERR}xLock(e,r){return SQLITE_OK}xUnlock(e,r){return SQLITE_OK}xCheckReservedLock(e,r){return r.setInt32(0,0,!0),SQLITE_OK}xFileControl(e,r,n){return SQLITE_NOTFOUND}xSectorSize(e){return 512}xDeviceCharacteristics(e){return 0}xOpen(e,r,n,s){return SQLITE_CANTOPEN}xDelete(e,r){return SQLITE_IOERR}xAccess(e,r,n){return SQLITE_IOERR}handleAsync(e){return e()}}const LOCK_TYPE_MASK=SQLITE_LOCK_NONE|SQLITE_LOCK_SHARED|SQLITE_LOCK_RESERVED|SQLITE_LOCK_PENDING|SQLITE_LOCK_EXCLUSIVE;class WebLocksBase{get state(){return this.#e}#e=SQLITE_LOCK_NONE;timeoutMillis=0;#t=new Map;#r=Promise.resolve(0);async lock(e){return this.#n(this.#i,e)}async unlock(e){return this.#n(this.#s,e)}async isSomewhereReserved(){throw new Error("unimplemented")}async#n(e,r){const n=r&LOCK_TYPE_MASK;try{const s=()=>e.call(this,n);return await(this.#r=this.#r.then(s,s)),this.#e=n,SQLITE_OK}catch(s){return s.name==="AbortError"?SQLITE_BUSY:(console.error(s),SQLITE_IOERR_LOCK)}}async#i(e){if(e===this.#e)return SQLITE_OK;switch(this.#e){case SQLITE_LOCK_NONE:switch(e){case SQLITE_LOCK_SHARED:return this._NONEtoSHARED();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case SQLITE_LOCK_SHARED:switch(e){case SQLITE_LOCK_RESERVED:return this._SHAREDtoRESERVED();case SQLITE_LOCK_EXCLUSIVE:return this._SHAREDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case SQLITE_LOCK_RESERVED:switch(e){case SQLITE_LOCK_EXCLUSIVE:return this._RESERVEDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}}async#s(e){if(e===this.#e)return SQLITE_OK;switch(this.#e){case SQLITE_LOCK_EXCLUSIVE:switch(e){case SQLITE_LOCK_SHARED:return this._EXCLUSIVEtoSHARED();case SQLITE_LOCK_NONE:return this._EXCLUSIVEtoNONE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case SQLITE_LOCK_RESERVED:switch(e){case SQLITE_LOCK_SHARED:return this._RESERVEDtoSHARED();case SQLITE_LOCK_NONE:return this._RESERVEDtoNONE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case SQLITE_LOCK_SHARED:switch(e){case SQLITE_LOCK_NONE:return this._SHAREDtoNONE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}}async _NONEtoSHARED(){}async _SHAREDtoEXCLUSIVE(){await this._SHAREDtoRESERVED(),await this._RESERVEDtoEXCLUSIVE()}async _SHAREDtoRESERVED(){}async _RESERVEDtoEXCLUSIVE(){}async _EXCLUSIVEtoRESERVED(){}async _EXCLUSIVEtoSHARED(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED()}async _EXCLUSIVEtoNONE(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _RESERVEDtoSHARED(){}async _RESERVEDtoNONE(){await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _SHAREDtoNONE(){}_acquireWebLock(e,r){return new Promise(async(n,s)=>{try{await navigator.locks.request(e,r,a=>{if(n(a),a)return new Promise(u=>this.#t.set(e,u))})}catch(a){s(a)}})}_releaseWebLock(e){this.#t.get(e)?.(),this.#t.delete(e)}async _pollWebLock(e){return(await navigator.locks.query()).held.find(({name:n})=>n===e)?.mode}_getTimeoutSignal(){if(this.timeoutMillis){const e=new AbortController;return setTimeout(()=>e.abort(),this.timeoutMillis),e.signal}}}class WebLocksExclusive extends WebLocksBase{constructor(e){super(),this._lockName=e+"-outer",this._reservedName=e+"-reserved"}async isSomewhereReserved(){return await this._pollWebLock(this._reservedName)==="exclusive"}async _NONEtoSHARED(){await this._acquireWebLock(this._lockName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _SHAREDtoRESERVED(){await this._acquireWebLock(this._reservedName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _RESERVEDtoSHARED(){this._releaseWebLock(this._reservedName)}async _SHAREDtoNONE(){this._releaseWebLock(this._lockName)}}const MAX_TRANSACTION_LIFETIME_MILLIS=5e3;let nextTxId=0;const mapTxToId=new WeakMap;function log$2(...t){}class IDBContext{#e;#t;#r;#n=null;#i=0;#s=Promise.resolve();#o=Promise.resolve();constructor(e,r={durability:"default"}){this.#t=Promise.resolve(e).then(n=>this.#e=n),this.#r=r}async close(){const e=this.#e??await this.#t;await this.#s,await this.sync(),e.close()}async run(e,r){const n=this.#s.then(()=>this.#a(e,r));return this.#s=n.catch(()=>{}),n}async#a(e,r){const n=this.#e??await this.#t;if(e==="readwrite"&&this.#n?.mode==="readonly")this.#n=null;else if(performance.now()-this.#i>MAX_TRANSACTION_LIFETIME_MILLIS){try{this.#n?.commit()}catch(s){if(s.name!=="InvalidStateError")throw s}await new Promise(s=>setTimeout(s)),this.#n=null}for(let s=0;s<2;++s){if(!this.#n){this.#n=n.transaction(n.objectStoreNames,e,this.#r);const a=this.#i=performance.now();this.#o=this.#o.then(()=>new Promise((u,d)=>{this.#n.addEventListener("complete",f=>{u(),this.#n===f.target&&(this.#n=null),log$2(`transaction ${mapTxToId.get(f.target)} complete`)}),this.#n.addEventListener("abort",f=>{console.warn("tx abort",(performance.now()-a)/1e3);const y=f.target.error;d(y),this.#n===f.target&&(this.#n=null),log$2(`transaction ${mapTxToId.get(f.target)} aborted`,y)})})),mapTxToId.set(this.#n,nextTxId++)}try{const a=Object.fromEntries(Array.from(n.objectStoreNames,u=>[u,new ObjectStore(this.#n.objectStore(u))]));return await r(a)}catch(a){if(this.#n=null,s)throw a}}}async sync(){await this.#s,await this.#o,this.#o=Promise.resolve()}}function wrapRequest(t){return new Promise((e,r)=>{t.addEventListener("success",()=>e(t.result)),t.addEventListener("error",()=>r(t.error))})}class ObjectStore{#e;constructor(e){this.#e=e}get(e){log$2(`get ${this.#e.name}`,e);const r=this.#e.get(e);return wrapRequest(r)}getAll(e,r){log$2(`getAll ${this.#e.name}`,e,r);const n=this.#e.getAll(e,r);return wrapRequest(n)}getKey(e){log$2(`getKey ${this.#e.name}`,e);const r=this.#e.getKey(e);return wrapRequest(r)}getAllKeys(e,r){log$2(`getAllKeys ${this.#e.name}`,e,r);const n=this.#e.getAllKeys(e,r);return wrapRequest(n)}put(e,r){log$2(`put ${this.#e.name}`,e,r);const n=this.#e.put(e,r);return wrapRequest(n)}delete(e){log$2(`delete ${this.#e.name}`,e);const r=this.#e.delete(e);return wrapRequest(r)}clear(){log$2(`clear ${this.#e.name}`);const e=this.#e.clear();return wrapRequest(e)}index(e){return new Index(this.#e.index(e))}}class Index{#e;constructor(e){this.#e=e}getAllKeys(e,r){log$2(`IDBIndex.getAllKeys ${this.#e.objectStore.name}<${this.#e.name}>`,e,r);const n=this.#e.getAllKeys(e,r);return wrapRequest(n)}}const SECTOR_SIZE=512,MAX_TASK_MILLIS=3e3,DEFAULT_OPTIONS={durability:"default",purge:"deferred",purgeAtLeast:16};function log$1(...t){}class IDBBatchAtomicVFS extends Base{#e;#t=new Map;#r;#n=new Set;#i=performance.now();#s=new Set;constructor(e="wa-sqlite",r=DEFAULT_OPTIONS){super(),this.name=e,this.#e=Object.assign({},DEFAULT_OPTIONS,r),this.#r=new IDBContext(openDatabase(e),{durability:this.#e.durability})}async close(){for(const e of this.#t.keys())await this.xClose(e);await this.#r?.close(),this.#r=null}xOpen(e,r,n,s){return this.handleAsync(async()=>{e===null&&(e=`null_${r}`),log$1(`xOpen ${e} 0x${r.toString(16)} 0x${n.toString(16)}`);try{const a=new URL(e,"http://localhost/"),u={path:a.pathname,flags:n,block0:null,isMetadataChanged:!0,locks:new WebLocksExclusive(a.pathname)};return this.#t.set(r,u),await this.#r.run("readwrite",async({blocks:d})=>{if(u.block0=await d.get(this.#l(u,0)),!u.block0)if(n&SQLITE_OPEN_CREATE)u.block0={path:u.path,offset:0,version:0,data:new Uint8Array(0),fileSize:0},d.put(u.block0);else throw new Error(`file not found: ${u.path}`)}),s.setInt32(0,n&SQLITE_OPEN_READONLY,!0),SQLITE_OK}catch(a){return console.error(a),SQLITE_CANTOPEN}})}xClose(e){return this.handleAsync(async()=>{try{const r=this.#t.get(e);return r&&(log$1(`xClose ${r.path}`),this.#t.delete(e),r.flags&SQLITE_OPEN_DELETEONCLOSE&&this.#r.run("readwrite",({blocks:n})=>{n.delete(IDBKeyRange.bound([r.path],[r.path,[]]))})),SQLITE_OK}catch(r){return console.error(r),SQLITE_IOERR}})}xRead(e,r,n){return this.handleAsync(async()=>{const s=this.#t.get(e);log$1(`xRead ${s.path} ${r.byteLength} ${n}`);try{return await this.#r.run("readonly",async({blocks:u})=>{let d=0;for(;d<r.byteLength;){const f=n+d,y=f<s.block0.data.byteLength?s.block0:await u.get(this.#l(s,-f));if(!y||y.data.byteLength-y.offset<=f)return r.fill(0,d),SQLITE_IOERR_SHORT_READ;const b=r.subarray(d),w=f+y.offset,A=Math.min(Math.max(y.data.byteLength-w,0),b.byteLength);b.set(y.data.subarray(w,w+A)),d+=A}return SQLITE_OK})}catch(a){return console.error(a),SQLITE_IOERR}})}xWrite(e,r,n){const s=this.#s.has(e);if(s||performance.now()-this.#i>MAX_TASK_MILLIS){const a=this.handleAsync(async()=>{this.handleAsync!==super.handleAsync&&this.#s.add(e),await new Promise(d=>setTimeout(d));const u=this.#o(e,r,n);return this.#i=performance.now(),u});return s&&this.#s.delete(e),a}return this.#o(e,r,n)}#o(e,r,n){const s=this.#t.get(e);log$1(`xWrite ${s.path} ${r.byteLength} ${n}`);try{const a=s.block0.fileSize;s.block0.fileSize<n+r.byteLength&&(s.block0.fileSize=n+r.byteLength,s.isMetadataChanged=!0);const u=n===0?s.block0:{path:s.path,offset:-n,version:s.block0.version,data:null};return u.data=r.slice(),s.changedPages?(a===s.block0.fileSize&&s.changedPages.add(-n),n!==0&&this.#r.run("readwrite",({blocks:d})=>d.put(u))):this.#r.run("readwrite",({blocks:d})=>d.put(u)),s.isMetadataChanged=n===0?!1:s.isMetadataChanged,SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}}xTruncate(e,r){const n=this.#t.get(e);log$1(`xTruncate ${n.path} ${r}`);try{Object.assign(n.block0,{fileSize:r,data:n.block0.data.slice(0,r)});const s=Object.assign({},n.block0);return this.#r.run("readwrite",({blocks:a})=>{a.delete(this.#l(n,-1/0,-r)),a.put(s)}),SQLITE_OK}catch(s){return console.error(s),SQLITE_IOERR}}xSync(e,r){const n=this.#s.has(e);if(n||this.#e.durability!=="relaxed"||performance.now()-this.#i>MAX_TASK_MILLIS){const a=this.handleAsync(async()=>{this.handleAsync!==super.handleAsync&&this.#s.add(e);const u=await this.#a(e,r);return this.#i=performance.now(),u});return n&&this.#s.delete(e),a}const s=this.#t.get(e);return log$1(`xSync ${s.path} ${r}`),SQLITE_OK}async#a(e,r){const n=this.#t.get(e);log$1(`xSync ${n.path} ${r}`);try{n.isMetadataChanged&&(this.#r.run("readwrite",async({blocks:s})=>{await s.put(n.block0)}),n.isMetadataChanged=!1),await this.#r.sync()}catch(s){return console.error(s),SQLITE_IOERR}return SQLITE_OK}xFileSize(e,r){const n=this.#t.get(e);return log$1(`xFileSize ${n.path}`),r.setBigInt64(0,BigInt(n.block0.fileSize),!0),SQLITE_OK}xLock(e,r){return this.handleAsync(async()=>{const n=this.#t.get(e);log$1(`xLock ${n.path} ${r}`);try{const s=await n.locks.lock(r);return s===SQLITE_OK&&n.locks.state===SQLITE_LOCK_SHARED&&(n.block0=await this.#r.run("readonly",({blocks:a})=>a.get(this.#l(n,0)))),s}catch(s){return console.error(s),SQLITE_IOERR}})}xUnlock(e,r){return this.handleAsync(async()=>{const n=this.#t.get(e);log$1(`xUnlock ${n.path} ${r}`);try{return n.locks.unlock(r)}catch(s){return console.error(s),SQLITE_IOERR}})}xCheckReservedLock(e,r){return this.handleAsync(async()=>{const n=this.#t.get(e);log$1(`xCheckReservedLock ${n.path}`);const s=await n.locks.isSomewhereReserved();return r.setInt32(0,s?1:0,!0),SQLITE_OK})}xSectorSize(e){return SECTOR_SIZE}xDeviceCharacteristics(e){return SQLITE_IOCAP_BATCH_ATOMIC|SQLITE_IOCAP_SAFE_APPEND|SQLITE_IOCAP_SEQUENTIAL|SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN}xFileControl(e,r,n){const s=this.#t.get(e);switch(log$1(`xFileControl ${s.path} ${r}`),r){case 11:return s.overwrite=!0,SQLITE_OK;case 21:if(s.overwrite)try{return this.handleAsync(async()=>(await this.#c(s),SQLITE_OK))}catch(a){return console.error(a),SQLITE_IOERR}if(s.isMetadataChanged)try{this.#r.run("readwrite",async({blocks:a})=>{await a.put(s.block0)}),s.isMetadataChanged=!1}catch(a){return console.error(a),SQLITE_IOERR}return SQLITE_OK;case 22:return s.overwrite=!1,SQLITE_OK;case 31:return this.handleAsync(async()=>{try{return s.block0.version--,s.changedPages=new Set,this.#r.run("readwrite",async({blocks:a})=>{const u=await a.index("version").getAllKeys(IDBKeyRange.bound([s.path],[s.path,s.block0.version]));for(const d of u)a.delete(d)}),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}});case 32:try{const a=Object.assign({},s.block0);a.data=a.data.slice();const u=s.changedPages;return s.changedPages=null,s.isMetadataChanged=!1,this.#r.run("readwrite",async({blocks:d})=>{d.put(a);const f=await d.get([s.path,"purge",0])??{path:s.path,offset:"purge",version:0,data:new Map,count:0};f.count+=u.size;for(const y of u)f.data.set(y,a.version);d.put(f),this.#u(s.path,f.count)}),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}case 33:return this.handleAsync(async()=>{try{return s.changedPages=null,s.isMetadataChanged=!1,s.block0=await this.#r.run("readonly",({blocks:a})=>a.get([s.path,0,s.block0.version+1])),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}});default:return SQLITE_NOTFOUND}}xAccess(e,r,n){return this.handleAsync(async()=>{try{const s=new URL(e,"file://localhost/").pathname;log$1(`xAccess ${s} ${r}`);const a=await this.#r.run("readonly",({blocks:u})=>u.getKey(this.#l({path:s},0)));return n.setInt32(0,a?1:0,!0),SQLITE_OK}catch(s){return console.error(s),SQLITE_IOERR}})}xDelete(e,r){return this.handleAsync(async()=>{const n=new URL(e,"file://localhost/").pathname;try{return this.#r.run("readwrite",({blocks:s})=>s.delete(IDBKeyRange.bound([n],[n,[]]))),r&&await this.#r.sync(),SQLITE_OK}catch(s){return console.error(s),SQLITE_IOERR}})}async purge(e){const r=Date.now();await this.#r.run("readwrite",async({blocks:n})=>{const s=await n.get([e,"purge",0]);if(s){for(const[a,u]of s.data)n.delete(IDBKeyRange.bound([e,a,u],[e,a,1/0],!0,!1));await n.delete([e,"purge",0])}log$1(`purge ${e} ${s?.data.size??0} pages in ${Date.now()-r} ms`)})}#u(e,r){this.#e.purge==="manual"||this.#n.has(e)||r<this.#e.purgeAtLeast||(globalThis.requestIdleCallback?globalThis.requestIdleCallback(()=>{this.purge(e),this.#n.delete(e)}):setTimeout(()=>{this.purge(e),this.#n.delete(e)}),this.#n.add(e))}#l(e,r,n=0){const s=!r||-r<e.block0.data.length?-1/0:e.block0.version;return IDBKeyRange.bound([e.path,r,s],[e.path,n,1/0])}async#c(e){const r=e.block0.data.length;if(r<18)return;const n=new DataView(e.block0.data.buffer,e.block0.data.byteOffset);let s=n.getUint16(16);if(s===1&&(s=65536),s===r)return;const a=Math.max(r,s),u=a/r,d=a/s,y=n.getUint32(28)*s,b=e.block0.version;await this.#r.run("readwrite",async({blocks:w})=>{const A=await w.index("version").getAllKeys(IDBKeyRange.bound([e.path,b+1],[e.path,1/0]));for(const R of A)w.delete(R);w.delete([e.path,"purge",0]);for(let R=0;R<y;R+=a){const I=await w.getAll(IDBKeyRange.lowerBound([e.path,-(R+a),1/0]),u);for(const h of I)w.delete([h.path,h.offset,h.version]);if(d===1){const h=new Uint8Array(s);for(const m of I)h.set(m.data,-(R+m.offset));const N={path:e.path,offset:-R,version:b,data:h};N.offset===0&&(N.fileSize=y,e.block0=N),w.put(N)}else{const h=I[0];for(let N=0;N<d;++N){const m=-(R+N*s);if(-m>=y)break;const E={path:h.path,offset:m,version:b,data:h.data.subarray(N*s,(N+1)*s)};E.offset===0&&(E.fileSize=y,e.block0=E),w.put(E)}}}})}}function openDatabase(t){return new Promise((e,r)=>{const n=globalThis.indexedDB.open(t,5);n.addEventListener("upgradeneeded",function(){n.result.createObjectStore("blocks",{keyPath:["path","offset","version"]}).createIndex("version",["path","version"])}),n.addEventListener("success",()=>{e(n.result)}),n.addEventListener("error",()=>{r(n.error)})})}const E_CANCELED=new Error("request for lock canceled");var __awaiter$2=function(t,e,r,n){function s(a){return a instanceof r?a:new r(function(u){u(a)})}return new(r||(r=Promise))(function(a,u){function d(b){try{y(n.next(b))}catch(w){u(w)}}function f(b){try{y(n.throw(b))}catch(w){u(w)}}function y(b){b.done?a(b.value):s(b.value).then(d,f)}y((n=n.apply(t,e||[])).next())})};class Semaphore{constructor(e,r=E_CANCELED){this._value=e,this._cancelError=r,this._weightedQueues=[],this._weightedWaiters=[]}acquire(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((r,n)=>{this._weightedQueues[e-1]||(this._weightedQueues[e-1]=[]),this._weightedQueues[e-1].push({resolve:r,reject:n}),this._dispatch()})}runExclusive(e,r=1){return __awaiter$2(this,void 0,void 0,function*(){const[n,s]=yield this.acquire(r);try{return yield e(n)}finally{s()}})}waitForUnlock(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise(r=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),this._weightedWaiters[e-1].push(r),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatch()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatch()}cancel(){this._weightedQueues.forEach(e=>e.forEach(r=>r.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var e;for(let r=this._value;r>0;r--){const n=(e=this._weightedQueues[r-1])===null||e===void 0?void 0:e.shift();if(!n)continue;const s=this._value,a=r;this._value-=r,r=this._value+1,n.resolve([s,this._newReleaser(a)])}this._drainUnlockWaiters()}_newReleaser(e){let r=!1;return()=>{r||(r=!0,this.release(e))}}_drainUnlockWaiters(){for(let e=this._value;e>0;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(r=>r()),this._weightedWaiters[e-1]=[])}}var __awaiter$1=function(t,e,r,n){function s(a){return a instanceof r?a:new r(function(u){u(a)})}return new(r||(r=Promise))(function(a,u){function d(b){try{y(n.next(b))}catch(w){u(w)}}function f(b){try{y(n.throw(b))}catch(w){u(w)}}function y(b){b.done?a(b.value):s(b.value).then(d,f)}y((n=n.apply(t,e||[])).next())})};class Mutex{constructor(e){this._semaphore=new Semaphore(1,e)}acquire(){return __awaiter$1(this,void 0,void 0,function*(){const[,e]=yield this._semaphore.acquire();return e})}runExclusive(e){return this._semaphore.runExclusive(()=>e())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}const isDebug=globalThis.__vlcn_wa_crsqlite_dbg;function log(...t){isDebug&&console.log("crsqlite-wasm: ",...t)}const re=/insert\s|update\s|delete\s/,txRe=/begin\s|commit\s|rollback\s|savepoint\s/;function computeCacheKey(t,e,r){const n=t.toLowerCase();if(txRe.exec(n)==null)return re.exec(n)!=null?(log("received write"),null):r!=null?n+"|"+e+"|"+r.map(a=>a!=null?a.toString():"null").join("|"):n}class Stmt{originDB;stmtFinalizer;cache;api;base;str;sql;mode="o";finalized=!1;bindings=[];constructor(e,r,n,s,a,u,d){this.originDB=e,this.stmtFinalizer=r,this.cache=n,this.api=s,this.base=a,this.str=u,this.sql=d,r.set(a,this)}run(e,...r){return serialize(this.cache,computeCacheKey(this.sql,this.mode,r.length>0?r:this.bindings),()=>(r.length>0&&this.bind(r),this.api.step(this.base).then(()=>this.api.reset(this.base))),e?.__mutex||this.originDB.__mutex)}get(e,...r){return serialize(this.cache,computeCacheKey(this.sql,this.mode,r.length>0?r:this.bindings),async()=>{r.length>0&&this.bind(r);let n=null,s=this.mode==="o"?this.api.column_names(this.base):null;if(await this.api.step(this.base)==SQLITE_ROW){const a=this.api.row(this.base);if(s!=null){const u={};for(let d=0;d<s.length;++d)u[s[d]]=a[d];n=u}else n=a}return await this.api.reset(this.base),n},e?.__mutex||this.originDB.__mutex)}all(e,...r){return serialize(this.cache,computeCacheKey(this.sql,this.mode,r.length>0?r:this.bindings),async()=>{r.length>0&&this.bind(r);const n=[];let s=this.mode==="o"?this.api.column_names(this.base):null;for(;await this.api.step(this.base)==SQLITE_ROW;)if(s!=null){const a={};for(let u=0;u<s.length;++u)a[s[u]]=this.api.column(this.base,u);n.push(a)}else{n.push(this.api.row(this.base));continue}return await this.api.reset(this.base),n},e?.__mutex||this.originDB.__mutex)}async*iterate(e,...r){for(this.bind(r);await serialize(this.cache,void 0,()=>this.api.step(this.base),e?.__mutex||this.originDB.__mutex)==SQLITE_ROW;)yield this.api.row(this.base);await serialize(this.cache,void 0,()=>this.api.reset(this.base),e?.__mutex||this.originDB.__mutex)}raw(e){return e?this.mode="a":this.mode="o",this}bind(e){this.bindings=e;for(let r=0;r<e.length;++r)this.api.bind(this.base,r+1,e[r]);return this}finalize(e){return serialize(this.cache,void 0,()=>{if(!this.finalized)return this.finalized=!0,this.api.str_finish(this.str),this.stmtFinalizer.delete(this.base),this.api.finalize(this.base)},e?.__mutex||this.originDB.__mutex)}}class TX{api;db;__mutex;assertOpen;stmtFinalizer;cache=new Map;constructor(e,r,n,s,a){this.api=e,this.db=r,this.__mutex=n,this.assertOpen=s,this.stmtFinalizer=a}execMany(e){return this.assertOpen(),serialize(this.cache,null,()=>this.api.exec(this.db,e.join("")),this.__mutex)}exec(e,r){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"a",r),()=>this.statements(e,!1,r),this.__mutex)}execO(e,r){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"o",r),()=>this.statements(e,!0,r),this.__mutex)}execA(e,r){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"a",r),()=>this.statements(e,!1,r),this.__mutex)}prepare(e){return this.assertOpen(),serialize(this.cache,void 0,async()=>{const r=this.api.str_new(this.db,e),n=await this.api.prepare_v2(this.db,this.api.str_value(r));if(n==null)throw this.api.str_finish(r),new Error(`Could not prepare ${e}`);return new Stmt(this,this.stmtFinalizer,this.cache,this.api,n.stmt,r,e)},this.__mutex)}tx(e){this.assertOpen();const r="crsql"+crypto.randomUUID().replaceAll("-","");return serializeTx(async n=>{await n.exec("SAVEPOINT "+r);try{await e(n)}catch(s){throw await n.exec("ROLLBACK TO "+r),await n.exec("RELEASE "+r),s}await n.exec("RELEASE "+r)},this.__mutex,this)}imperativeTx(){return this.__mutex.acquire().then(e=>{const r=new Mutex;return[e,new TX(this.api,this.db,r,this.assertOpen,this.stmtFinalizer)]})}async statements(e,r,n){const s=[],a=this.api.str_new(this.db,e);let u={stmt:null,sql:this.api.str_value(a)};try{for(;u=await this.api.prepare_v2(this.db,u.sql);){const y=u.stmt,b=[],w=this.api.column_names(y);for(n&&this.bind(y,n);await this.api.step(y)===SQLITE_ROW;){const A=this.api.row(y);b.push(A)}w.length&&s.push({columns:w,rows:b}),this.api.finalize(u.stmt),u.stmt=null}}catch(y){throw console.error(`Failed running ${e}`,y),y}finally{u?.stmt&&this.api.finalize(u.stmt),this.api.str_finish(a)}const d=s[0];if(d==null)return null;if(!r)return d.rows;const f=[];for(const y of d.rows){const b={};for(let w=0;w<d.columns.length;++w)b[d.columns[w]]=y[w];f.push(b)}return f}bind(e,r){for(let n=0;n<r.length;++n){const s=r[n];this.api.bind(e,n+1,typeof s=="boolean"?s&&1||0:s)}}}const topLevelMutex=new Mutex;topLevelMutex.name="topLevelMutex";function serialize(t,e,r,n){if(e===null)log("Cache clear"),t?.clear();else if(e!==void 0){const a=t?.get(e);if(a)return log("Cache hit",e),a}log("Enqueueing query ",e);const s=n.runExclusive(r);return e&&(t?.set(e,s),s.finally(()=>t?.delete(e)).catch(a=>{console.error(a)})),s}function serializeTx(t,e,r){return e.runExclusive(()=>{const n=new Mutex,s=new TX(r.api,r.db,n,r.assertOpen,r.stmtFinalizer);return t(s)})}function cryb64(t,e=0){let r=3735928559^e,n=1103547991^e;for(let s=0,a;s<t.length;s++)a=t.charCodeAt(s),r=Math.imul(r^a,2654435761),n=Math.imul(n^a,1597334677);return r=Math.imul(r^r>>>16,2246822507),r^=Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(r^r>>>13,3266489909),4294967296n*BigInt(n)+BigInt(r)}function firstPick(t){const e=t[0];if(e!=null)return e[Object.keys(e)[0]]}class DB{api;db;filename;__mutex=topLevelMutex;stmtFinalizer=new Map;#e=null;#t=null;cache=new Map;#r=null;#n=!1;#i;constructor(e,r,n){this.api=e,this.db=r,this.filename=n,this.#i=new TX(e,r,topLevelMutex,this.#s,this.stmtFinalizer)}get siteid(){return this.#e}_setSiteid(e){if(this.#e)throw new Error("Site id already set");this.#e=e}_setTablesUsedStmt(e){this.#t=e}get tablesUsedStmt(){if(this.#t==null)throw new Error("tablesUsedStmt not set");return this.#t}async automigrateTo(e,r){const n=cryb64(r),s=firstPick(await this.execA("SELECT value FROM crsql_master WHERE key = 'schema_name'")),a=firstPick(await this.execA("SELECT value FROM crsql_master WHERE key = 'schema_version'"));if(s===e&&BigInt(a||0)===n)return"noop";const u=s===void 0||s!==e?"apply":"migrate";return await this.tx(async d=>{if(a==null||s!==e){if(s!==e){const f=await d.execA("SELECT name FROM sqlite_master WHERE type = 'table' AND name NOT LIKE 'sqlite_%' AND name NOT LIKE 'crsql_%'");for(const y of f)await d.exec(`DROP TABLE [${y[0]}]`)}await d.exec(r)}else await d.exec("SELECT crsql_automigrate(?, 'SELECT crsql_finalize();')",[r]);await d.exec("INSERT OR REPLACE INTO crsql_master (key, value) VALUES (?, ?)",["schema_version",n]),await d.exec("INSERT OR REPLACE INTO crsql_master (key, value) VALUES (?, ?)",["schema_name",e])}),await this.exec("VACUUM;"),u}execMany(e){return this.#i.execMany(e)}exec(e,r){return this.#i.exec(e,r)}#s=()=>{if(this.#n)throw new Error("The DB is closed")};execO(e,r){return this.#i.execO(e,r)}execA(e,r){return this.#i.execA(e,r)}prepare(e){return this.#i.prepare(e)}tx(e){return this.#i.tx(e)}imperativeTx(){return this.#i.imperativeTx()}async close(){for(const e of this.stmtFinalizer.values())await e.finalize(this);return this.#t?.finalize(this),this.exec("SELECT crsql_finalize()").then(()=>(this.#n=!0,serialize(this.cache,void 0,()=>this.api.close(this.db),this.__mutex)))}createFunction(e,r,n){this.#s(),this.api.create_function(this.db,e,r.length,SQLITE_UTF8,0,(s,a)=>{const u=[];for(let f=0;f<r.length;++f)u.push(this.api.value(a[f]));const d=r(...u);d!==void 0&&this.api.result(s,d)})}onUpdate(e){return this.#r==null&&(this.api.update_hook(this.db,this.#o),this.#r=new Set),this.#r.add(e),()=>this.#r?.delete(e)}#o=(e,r,n,s)=>{this.#r!=null&&this.#r.forEach(a=>{try{a(e,r,n,s)}catch(u){console.error("Failed notifying a DB update listener"),console.error(u)}})}}let api=null;class SQLite3{base;constructor(e){this.base=e}open(e,r="c"){return serialize(null,void 0,()=>this.base.open_v2(e||":memory:",SQLITE_OPEN_CREATE|SQLITE_OPEN_READWRITE|SQLITE_OPEN_URI,e!=null?"idb-batch-atomic":void 0),topLevelMutex).then(n=>{const s=new DB(this.base,n,e||":memory:");return s.prepare(`SELECT tbl_name FROM tables_used(?) AS u
        JOIN sqlite_master ON sqlite_master.name = u.name
        WHERE u.schema = 'main'`).then(a=>{a.raw(!0),s._setTablesUsedStmt(a)}).then(()=>s.execA("select quote(crsql_site_id());")).then(a=>(s._setSiteid(a[0][0].replace(/'|X/g,"")),s))})}}async function initWasm(t){if(api!=null)return api;const e=await Module({locateFile(n){return t?t(n):new URL(""+new URL("../assets/crsqlite.mmzGBJgt.wasm",import.meta.url).href,import.meta.url).href}}),r=Factory(e);return r.vfs_register(new IDBBatchAtomicVFS("idb-batch-atomic",{durability:"relaxed"})),api=new SQLite3(r),api}async function load(t,e){return{database:await(await initWasm(()=>e.wasm||wasmUrl)).open(t),browser:!0}}class CRDialect extends SqliteDialect{database;constructor(e){super(e),this.database=async()=>typeof e.database=="function"?e.database():e.database}createDriver(){const e=this.database,r=mutex();let n,s;return{async init(){n=await e(),s={async executeQuery(a){return{rows:await n.execO(a.sql,a.parameters)}},async*streamQuery(){throw new Error("Sqlite driver doesn't support streaming")}}},async acquireConnection(){return await r.lock(),s},async beginTransaction(a){await a.executeQuery(CompiledQuery.raw("begin"))},async commitTransaction(a){await a.executeQuery(CompiledQuery.raw("commit"))},async rollbackTransaction(a){await a.executeQuery(CompiledQuery.raw("rollback"))},async releaseConnection(){r.unlock()},async destroy(){n?.close()}}}}function mutex(){let t,e;return{async lock(){for(;t;)await t;t=new Promise(r=>e=r)},unlock(){const r=e;t=void 0,e=void 0,r?.()}}}function json(t,e){const r=Object.entries(e).flatMap(([n,s])=>[sql.lit(n),typeof s=="string"?t.ref(s):s]);return sql`json_object(${sql.join(r)})`.withPlugin({transformQuery({node:n}){return{...n,json:!0}}}).$castTo()}function group(t,e){const r=typeof e=="string"?t.ref(e).toOperationNode():e.toOperationNode();return new AggregateFunctionBuilder({aggregateFunctionNode:{...AggregateFunctionNode.create("json_group_array",[r]),json:!0}})}function groupJSON(t,e){return group(t,json(t,e))}class JSONPlugin{#e=new WeakMap;transformQuery({node:e,queryId:r}){return e.kind!=="SelectQueryNode"||this.#e.set(r,new Set(this.getColumns(e))),e}async transformResult({result:e,queryId:r}){if(!Array.isArray(e.rows))return e;const n=this.#e.get(r);return n&&e.rows.forEach(s=>this.parseObject(s,n)),e}getColumns(e){const r=[];for(const n in e)e[n]&&typeof e[n]=="object"&&(e[n].json===!0&&typeof e.alias?.name=="string"&&r.push(e.alias?.name),r.push(...this.getColumns(e[n])));return r}parseObject(e,r){for(const n in e)r.has(n)&&(e[n]=JSON.parse(String(e[n]))),typeof e[n]=="object"&&this.parseObject(e[n],r)}}function covert(t){const r={any:"blob",string:"text",number:"real",unknown:"blob",instance:"blob",bigint:"integer",integer:"integer",boolean:"boolean"}[t];if(r)return r;throw new Error(`Type "${t}" is not allowed in the database schema!`)}async function apply(t,{schema:e}){for(const r in e){const n=e[r];let s=t.schema.createTable(r).ifNotExists();for(const a in n.schema){const{type:u}=n.schema[a];s=s.addColumn(a,n.ordered?.find(([d])=>d===a)?"blob":covert(u),d=>n.primary?.includes(a)?d.notNull():d)}n.primary&&(s=s.addPrimaryKeyConstraint("primary_key",n.primary)),await s.execute();for(const a of n.indices||[])await t.schema.createIndex(`${r}_${a.join("_")}`).ifNotExists().on(r).columns(a).execute();n.crr&&await sql`SELECT crsql_as_crr(${r})`.execute(t);for(const a of n.ordered||[])await sql`SELECT crsql_fract_as_ordered(${r},${sql.join(a)})`.execute(t);await t.schema.createTable("__crstore_sync").ifNotExists().addColumn("version","integer").execute(),await sql`INSERT INTO __crstore_sync (version) SELECT 0
      WHERE NOT EXISTS (SELECT * FROM __crstore_sync)
    `.execute(t)}}function primary(t,...e){return t.primary=e,t}function crr(t){return t.crr=!0,t}function ordered(t,e,...r){return t.ordered||(t.ordered=[]),t.ordered.push([e,...r]),t}function index(t,...e){return t.indices||(t.indices=[]),t.indices.push(e),t}const connections$1=new Map,defaultPaths={};async function init(t,e,r=defaultPaths){if(connections$1.has(t))return connections$1.get(t);const{database:n,browser:s}=await load(t,r),a=s?CRDialect:SqliteDialect,u=new Kysely({dialect:new a({database:n}),plugins:[new JSONPlugin]}),d=u.destroy.bind(u);await u.transaction().execute(y=>apply(y,e));const f=Object.assign(u,{resolveChanges,applyOperation,insertChanges,updateVersion,selectVersion,selectClient,changesSince,async destroy(){return connections$1.delete(t),await finalize.bind(u)().execute(),d()}});return connections$1.set(t,f),f}const raf=globalThis.requestAnimationFrame||globalThis.setTimeout,error=Symbol("error");function queue(t,e){const r=new Map;let n;async function s(){return n||(n=new Promise(a=>raf(async()=>{const u=await t,d=new Map;await u.transaction().execute(async f=>{const y=e&&(await selectVersion.bind(f)().execute()).current;for(const[b,w]of r.entries()){const A=await w(f).catch(R=>({[error]:R}));d.set(b,A)}e?.(await changesSince.bind(f)(y).execute())}),r.clear(),n=void 0,a(d)})))}return{enqueue(a,u,...d){return r.set(a,f=>u(f,...d)),s().then(f=>f.get(a)).then(f=>{if(f&&typeof f=="object"&&error in f)throw f[error];return f})}}}const empty=[],ready=t=>t!==empty;function database(t,{ssr:e=!1,name:r="crstore.db",paths:n=defaultPaths,error:s=void 0,push:a=void 0,pull:u=void 0,online:d=()=>!!globalThis.navigator?.onLine}={}){const y=!e&&!1?new Promise(()=>{}):init(r,t,n),b="BroadcastChannel"in globalThis?new globalThis.BroadcastChannel(`${r}-sync`):null,w=z=>T(z.data,z.data[0]),A=queue(y,T),R=queue(y);b?.addEventListener("message",w),globalThis.addEventListener?.("online",v);const I=new Map;let h=()=>{};v();async function N(z,M){return R.enqueue(M,W=>W.getExecutor().executeQuery(z,M)).then(W=>W.rows)}function m(z,M,W){const V=async(ae,G)=>{try{if(W&&W.client===G)return;await M(ae,G)}catch(me){s?.(me)}};return z.forEach(ae=>{I.has(ae)||I.set(ae,new Set),I.get(ae)?.add(V)}),W?y.then(async ae=>{const G=await ae.changesSince(W.version,W.client).execute();G.length&&V(G)}):V([]),()=>z.forEach(ae=>I.get(ae)?.delete(V))}async function E(){if(!a||!d())return;const z=await y,{current:M,synced:W}=await z.selectVersion().execute();if(M<=W)return;const V=await z.changesSince(W,null).execute();await a(V),await z.updateVersion(M).execute()}async function v(){if(globalThis.removeEventListener?.("offline",h),h(),!u||!d())return;const z=await y,{synced:M}=await z.selectVersion().execute(),W=await z.selectClient().execute();await E(),h=u({version:M,client:W},{async onData(V){V.length&&(await z.insertChanges(V).execute(),await T(V,V[0]))}}).unsubscribe,globalThis.addEventListener?.("offline",h)}async function C(z,...M){return A.enqueue({},z,...M)}async function $(z){if(!z.length)return;const M=await y;await T(await M.resolveChanges(z).execute(),z[0])}async function T(z,M){if(!z.length)return;const W=new Set,V=affectedTables(z);I.get("*")?.forEach(G=>W.add(G)),V.forEach(G=>I.get(G)?.forEach(me=>W.add(me)));const ae=[...W].map(G=>G(z,M));M||(b?.postMessage(z),await E()),await Promise.all(ae)}async function q(){h(),b?.close(),I.clear(),globalThis.removeEventListener?.("online",v),globalThis.removeEventListener?.("offline",h),b?.removeEventListener("message",w),await y.then(z=>z.destroy())}const Y=Object.assign(store.bind({connection:y,subscribe:m,update:C,refresh:N},[]),{with:(...z)=>store.bind({connection:y,subscribe:m,update:C,refresh:N},z)});return{close:q,merge:$,update:C,subscribe:m,connection:y,store:Y}}function store(t,e,r={}){const{connection:n,update:s,refresh:a}=this,u=derived(t,R=>R);let d=null,f=null;const{subscribe:y,set:b}=writable(empty,()=>{let R=()=>{};return n.then(I=>{if(!R)return;let h=()=>{};const N=u.subscribe(m=>{const E=e(I,...m).toOperationNode(),v=affectedTables(E),C=I.getExecutor();f={queryId:Math.random().toString(36).slice(2)},d=C.compileQuery(C.transformQuery(E,f),f),h(),h=this.subscribe(v,w)});R=()=>(N(),h())}),()=>(R?.(),R=null)});async function w(){await n,!(!d||!f)&&b(await a(d,f))}const A={};for(const R in r)A[R]=(...I)=>s(r[R],...I);return{...A,set:b,subscribe:y,update(R,...I){return R?s(R,...I):w()},then(R,I){let h=[];const N=y(m=>h=m);return w().then(()=>(N(),R(h)),I)}}}const APPEND=1,source=t=>t.selectFrom(e=>e.selectFrom("sources").select(["owner","source"]).orderBy("sources.primary","desc").as("ordered")).select(["owner",e=>group(e,"source").as("sources")]).groupBy("owner").$castTo(),asset=t=>t.selectFrom(e=>e.selectFrom("assets").select(["owner","art","thumbnail"]).orderBy("assets.primary","desc").as("ordered")).select(["owner",e=>group(e,"art").as("arts"),e=>group(e,"thumbnail").as("thumbnails")]).groupBy("owner").$castTo(),artist$1=t=>t.selectFrom("artists").leftJoin("source","source.owner","artists.id").leftJoin("asset","asset.owner","artists.id").select(["artists.id","artists.title","artists.following",e=>e.fn.coalesce("asset.arts",e.val("[]")).as("arts"),e=>e.fn.coalesce("asset.thumbnails",e.val("[]")).as("thumbnails"),e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources")]).$castTo(),album$1=t=>t.selectFrom("albums").leftJoin("source","source.owner","albums.id").leftJoin("asset","asset.owner","albums.id").leftJoin("attribution","attribution.album","albums.id").innerJoin("artist","artist.id","attribution.artist").select(["albums.id","albums.title","albums.year",e=>e.fn.coalesce("asset.arts",e.val("[]")).as("arts"),e=>e.fn.coalesce("asset.thumbnails",e.val("[]")).as("thumbnails"),e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources"),e=>groupJSON(e,{id:"artist.id",title:"artist.title",arts:"artist.arts",thumbnails:"artist.thumbnails",sources:"artist.sources"}).filterWhere("artist.id","is not",null).as("artists")]).groupBy("albums.id").$castTo(),track$2=t=>t.selectFrom("tracks").leftJoin("source","source.owner","tracks.id").innerJoin("album","album.id","tracks.album").select(["tracks.id","tracks.title","tracks.duration","album.artists",e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources"),e=>json(e,{id:"album.id",title:"album.title",year:"album.year",arts:"album.arts",thumbnails:"album.thumbnails",sources:"album.sources"}).as("album")]).$castTo(),localDevice=sql`crsql_site_id()`,uuid=()=>Math.random()*2**32>>>0,sanitize=t=>t.replace(/-/g," ").split(/\s+/g).map(e=>`"${e.replace(/"/g,'""')}"`).join(" "),position={first:null,before:t=>t.selectFrom("queue").select("id").where("position","=",1).limit(1),shift:t=>e=>e.selectFrom("queue").select("id").whereRef(r=>r.selectFrom("queue").select(sql`position + 1`.as("position")).where("id","=",t),"=","position").limit(1),next:t=>t.selectFrom("devices").select("playback").where("id","=",localDevice).limit(1),last:t=>t.selectFrom("playback").select("id").where("device","=",localDevice).orderBy("order","desc").orderBy("id","desc").limit(1),random:t=>e=>e.selectFrom(r=>r.selectFrom("queue").select(["id","position"]).$if(!!t.length,n=>n.unionAll(sql`VALUES ${sql.raw(t.map(s=>`(${s}, 1)`).join(","))}`)).unionAll(sql`SELECT null,1 WHERE NOT EXISTS (SELECT 1 FROM queue WHERE position >= 0)`).as("data")).select("id").where("position",">=",0).orderBy(sql`random()`).limit(1)};async function pushTracks(t,e){e.length&&(await pushAlbums(t,e.map(r=>({...r.album,artists:r.artists}))),await t.insertInto("tracks").onConflict(r=>r.doNothing()).values(e.map(r=>({id:r.id,title:r.title,duration:r.duration,album:r.album.id}))).execute(),await pushResources(t,e))}async function pushAlbums(t,e){e.length&&(await pushArtists(t,e.flatMap(r=>r.artists)),e.find(r=>r.artists.length)&&await t.insertInto("attribution").onConflict(r=>r.doNothing()).values(e.flatMap(r=>r.artists.map(({id:n})=>({album:r.id,artist:n})))).execute(),await t.insertInto("albums").onConflict(r=>r.doNothing()).values(e.map(r=>({id:r.id,title:r.title,year:r.year}))).execute(),await pushResources(t,e))}async function pushArtists(t,e){e.length&&(await t.insertInto("artists").onConflict(r=>r.doNothing()).values(e.map(r=>({id:r.id,title:r.title,following:0}))).execute(),await pushResources(t,e))}async function pushResources(t,e){e.length&&(e.find(r=>r.sources.length)&&await t.insertInto("sources").onConflict(r=>r.doNothing()).values(e.flatMap(({id:r,sources:n})=>n.map((s,a)=>({owner:r,source:s,primary:+!a&&sql`NOT EXISTS (SELECT 1 FROM sources WHERE owner = ${r} AND "primary" = 1)`})))).execute(),e.find(r=>r.arts?.length)&&await t.insertInto("assets").onConflict(r=>r.doNothing()).values(e.flatMap(({id:r,arts:n,thumbnails:s})=>{if(!n)return[];const a=n.find((u,d)=>!!s?.[d])||n[0];return n.map((u,d)=>({owner:r,art:u,thumbnail:s?.[d],primary:+(u===a)&&sql`NOT EXISTS (SELECT 1 FROM assets WHERE owner = ${r} AND "primary" = 1)`}))})).execute())}const preceding$1=({store:t})=>t(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).with("update",r=>r.selectFrom("playback").select(n=>n.selectFrom("devices").select("id").as("_"))).selectFrom("queue").innerJoin("track","track.id","queue.track").where("position","<",0).select("queue.id as entry").select(fields).$castTo()),upcoming$1=({store:t})=>t(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).with("update",r=>r.selectFrom("playback").select(n=>n.selectFrom("devices").select("id").as("_"))).selectFrom("queue").innerJoin("track","track.id","queue.track").where("position",">",0).select("queue.id as entry").select(fields).$castTo()),playback$2=({store:t})=>t(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("devices").innerJoin("playback","playback.id","devices.playback").innerJoin("track","track.id","playback.track").select(["direction","repeat","infinite","device","progress"]).select(r=>json(r,{entry:"playback.id",id:"track.id",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).as("track")).select(sql`device = crsql_site_id()`.as("local")).select(fields).$castTo(),{async push(e,r,n="next"){if(!r.length)return;await pushTracks(e,r);const{direction:s,playback:a}=await e.selectFrom("devices").where("id","=",localDevice).select(["direction","playback"]).executeTakeFirstOrThrow(),u=r.map(uuid),d=s!=1?Number.isInteger(n)?n:n==="first"?position.first:n==="next"?position.next:position.last:Number.isInteger(n)?position.shift(+n):n==="first"?position.last:n==="next"?position.before:position.first;await e.insertInto("playback_fractindex").values(r.map((f,y)=>({id:u[y],track:f.id,device:localDevice,after_id:n==="random"?position.random(u.slice(0,y)):y>0&&s!=1?u[y-1]:d}))).execute(),!~a&&n==="random"&&await e.updateTable("devices").set({playback:f=>f.selectFrom("queue").select("id").$castTo().limit(1)}).execute()},async purge(e,r){r.length&&await e.deleteFrom("playback").where("id","in",r).execute()},async clear(e,r=localDevice){await e.deleteFrom("playback").where("device","=",r).execute(),await e.updateTable("devices").set({playback:-1,progress:0}).where("id","=",r).execute()},async sync(e,r){await e.updateTable("devices").where("id","=",localDevice).set({progress:r}).execute()},async rearrange(e,r,n=null){const{direction:s}=await e.selectFrom("devices").where("id","=",localDevice).select(["direction"]).executeTakeFirstOrThrow(),a=s!=1?n:n!=null?position.shift(n):position.last;await e.updateTable("playback_fractindex").set({after_id:a}).where("id","=",r).execute()},async redirect(e,r){const n=["forward","backward","shuffled"],{direction:s}=await e.selectFrom("devices").select("direction").where("id","=",localDevice).executeTakeFirstOrThrow(),a=n.indexOf(r);s!==a&&await e.updateTable("devices").set({direction:a}).where("id","=",localDevice).execute()},async repeat(e,r){const n=["none","single","all"];await e.updateTable("devices").set({repeat:n.indexOf(r)}).where("id","=",localDevice).execute()},async infinite(e,r){await e.updateTable("devices").set({infinite:r==null?sql`!infinite`:+r}).where("id","=",localDevice).execute()},async replicate(e,r){const n=uuid();await e.updateTable("devices").where("id","=",localDevice).set({playback:n,progress:s=>s.selectFrom("devices").where("id","=",r).select("progress")}).execute(),await e.deleteFrom("playback").where("device","=",localDevice).execute(),await e.insertInto("playback").expression(s=>s.selectFrom("playback").select(a=>a.case().when(u=>u.selectFrom("devices").whereRef("id","=","playback.device").select("devices.playback"),"=",a.ref("playback.id")).then(n).else(sql`ABS(RANDOM() % 4294967296)`).end().as("id")).select(sql`${localDevice}`.as("device")).select(["track","order","temp"]).where("device","=",r)).execute()}}),fields=["track.id","track.title","track.duration","track.album","track.artists","track.sources"];class StructError extends TypeError{constructor(e,r){let n;const{message:s,explanation:a,...u}=e,{path:d}=e,f=d.length===0?s:`At path: ${d.join(".")} -- ${s}`;super(a??f),a!=null&&(this.cause=f),Object.assign(this,u),this.name=this.constructor.name,this.failures=()=>n??(n=[e,...r()])}}function isIterable(t){return isObject$2(t)&&typeof t[Symbol.iterator]=="function"}function isObject$2(t){return typeof t=="object"&&t!=null}function print(t){return typeof t=="symbol"?t.toString():typeof t=="string"?JSON.stringify(t):`${t}`}function shiftIterator(t){const{done:e,value:r}=t.next();return e?void 0:r}function toFailure(t,e,r,n){if(t===!0)return;t===!1?t={}:typeof t=="string"&&(t={message:t});const{path:s,branch:a}=e,{type:u}=r,{refinement:d,message:f=`Expected a value of type \`${u}\`${d?` with refinement \`${d}\``:""}, but received: \`${print(n)}\``}=t;return{value:n,type:u,refinement:d,key:s[s.length-1],path:s,branch:a,...t,message:f}}function*toFailures(t,e,r,n){isIterable(t)||(t=[t]);for(const s of t){const a=toFailure(s,e,r,n);a&&(yield a)}}function*run(t,e,r={}){const{path:n=[],branch:s=[t],coerce:a=!1,mask:u=!1}=r,d={path:n,branch:s};if(a&&(t=e.coercer(t,d),u&&e.type!=="type"&&isObject$2(e.schema)&&isObject$2(t)&&!Array.isArray(t)))for(const y in t)e.schema[y]===void 0&&delete t[y];let f="valid";for(const y of e.validator(t,d))y.explanation=r.message,f="not_valid",yield[y,void 0];for(let[y,b,w]of e.entries(t,d)){const A=run(b,w,{path:y===void 0?n:[...n,y],branch:y===void 0?s:[...s,b],coerce:a,mask:u,message:r.message});for(const R of A)R[0]?(f=R[0].refinement!=null?"not_refined":"not_valid",yield[R[0],void 0]):a&&(b=R[1],y===void 0?t=b:t instanceof Map?t.set(y,b):t instanceof Set?t.add(b):isObject$2(t)&&(b!==void 0||y in t)&&(t[y]=b))}if(f!=="not_valid")for(const y of e.refiner(t,d))y.explanation=r.message,f="not_refined",yield[y,void 0];f==="valid"&&(yield[void 0,t])}class Struct{constructor(e){const{type:r,schema:n,validator:s,refiner:a,coercer:u=f=>f,entries:d=function*(){}}=e;this.type=r,this.schema=n,this.entries=d,this.coercer=u,s?this.validator=(f,y)=>{const b=s(f,y);return toFailures(b,y,this,f)}:this.validator=()=>[],a?this.refiner=(f,y)=>{const b=a(f,y);return toFailures(b,y,this,f)}:this.refiner=()=>[]}assert(e,r){return assert(e,this,r)}create(e,r){return create(e,this,r)}is(e){return is(e,this)}mask(e,r){return mask(e,this,r)}validate(e,r={}){return validate(e,this,r)}}function assert(t,e,r){const n=validate(t,e,{message:r});if(n[0])throw n[0]}function create(t,e,r){const n=validate(t,e,{coerce:!0,message:r});if(n[0])throw n[0];return n[1]}function mask(t,e,r){const n=validate(t,e,{coerce:!0,mask:!0,message:r});if(n[0])throw n[0];return n[1]}function is(t,e){return!validate(t,e)[0]}function validate(t,e,r={}){const n=run(t,e,r),s=shiftIterator(n);return s[0]?[new StructError(s[0],function*(){for(const u of n)u[0]&&(yield u[0])}),void 0]:[void 0,s[1]]}function assign(...t){const e=t[0].type==="type",r=t.map(s=>s.schema),n=Object.assign({},...r);return e?type(n):object(n)}function define(t,e){return new Struct({type:t,schema:null,validator:e})}function omit(t,e){const{schema:r}=t,n={...r};for(const s of e)delete n[s];switch(t.type){case"type":return type(n);default:return object(n)}}function any(){return define("any",()=>!0)}function array(t){return new Struct({type:"array",schema:t,*entries(e){if(t&&Array.isArray(e))for(const[r,n]of e.entries())yield[r,n,t]},coercer(e){return Array.isArray(e)?e.slice():e},validator(e){return Array.isArray(e)||`Expected an array value, but received: ${print(e)}`}})}function instance$1(t){return define("instance",e=>e instanceof t||`Expected a \`${t.name}\` instance, but received: ${print(e)}`)}function integer(){return define("integer",t=>typeof t=="number"&&!isNaN(t)&&Number.isInteger(t)||`Expected an integer, but received: ${print(t)}`)}function literal(t){const e=print(t),r=typeof t;return new Struct({type:"literal",schema:r==="string"||r==="number"||r==="boolean"?t:null,validator(n){return n===t||`Expected the literal \`${e}\`, but received: ${print(n)}`}})}function never(){return define("never",()=>!1)}function nullable(t){return new Struct({...t,validator:(e,r)=>e===null||t.validator(e,r),refiner:(e,r)=>e===null||t.refiner(e,r)})}function number(){return define("number",t=>typeof t=="number"&&!isNaN(t)||`Expected a number, but received: ${print(t)}`)}function object(t){const e=t?Object.keys(t):[],r=never();return new Struct({type:"object",schema:t||null,*entries(n){if(t&&isObject$2(n)){const s=new Set(Object.keys(n));for(const a of e)s.delete(a),yield[a,n[a],t[a]];for(const a of s)yield[a,n[a],r]}},validator(n){return isObject$2(n)||`Expected an object, but received: ${print(n)}`},coercer(n){return isObject$2(n)?{...n}:n}})}function optional(t){return new Struct({...t,validator:(e,r)=>e===void 0||t.validator(e,r),refiner:(e,r)=>e===void 0||t.refiner(e,r)})}function string(){return define("string",t=>typeof t=="string"||`Expected a string, but received: ${print(t)}`)}function type(t){const e=Object.keys(t);return new Struct({type:"type",schema:t,*entries(r){if(isObject$2(r))for(const n of e)yield[n,r[n],t[n]]},validator(r){return isObject$2(r)||`Expected an object, but received: ${print(r)}`},coercer(r){return isObject$2(r)?{...r}:r}})}function union(t){const e=t.map(r=>r.type).join(" | ");return new Struct({type:"union",schema:null,coercer(r){for(const n of t){const[s,a]=n.validate(r,{coerce:!0});if(!s)return a}return r},validator(r,n){const s=[];for(const a of t){const[...u]=run(r,a,n),[d]=u;if(d[0])for(const[f]of u)f&&s.push(f);else return[]}return[`Expected the value to satisfy a union of \`${e}\`, but received: ${print(r)}`,...s]}})}const track$1=object({title:string(),duration:number()}),album=object({title:string(),year:integer()}),artist=object({title:string()}),playlist=object({title:string(),relevancy:number(),shared:nullable(string()),remote:nullable(string())});type({title:optional(string()),album:optional(type({title:optional(string())})),artists:optional(array(type({title:optional(string())})))});const media=object({sources:array(string()),arts:optional(array(string())),thumbnails:optional(array(nullable(string())))}),collection=t=>object({size:integer(),duration:number(),tracks:array(t)}),unique=t=>assign(t,object({id:integer()})),artistInfo=assign(artist,media),albumInfo=assign(album,assign(media,object({artists:array(artistInfo)}))),trackInfo=assign(track$1,assign(omit(media,["arts","thumbnails"]),object({album:omit(albumInfo,["artists"]),artists:array(artistInfo)}))),playlistInfo=playlist,track=assign(unique(trackInfo),object({entry:optional(number()),album:unique(trackInfo.schema.album),artists:array(unique(trackInfo.schema.artists.schema))}));assign(unique(albumInfo),object({artists:array(unique(albumInfo.schema.artists.schema)),collection:optional(collection(track))}));assign(unique(artistInfo),object({following:optional(union([literal(0),literal(1)])),collection:optional(collection(track))}));assign(unique(playlistInfo),object({collection:optional(collection(track))}));function has(t,e){return t!==null&&typeof t=="object"&&e in t&&t[e]!==void 0}function getDefaultExportFromCjs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var murmurhash={exports:{}};(function(t){(function(){const e=a=>new TextEncoder().encode(a);function r(a,u){typeof a=="string"&&(a=e(a));let d=a.length,f=u^d,y=0,b;for(;d>=4;)b=a[y]&255|(a[++y]&255)<<8|(a[++y]&255)<<16|(a[++y]&255)<<24,b=(b&65535)*1540483477+(((b>>>16)*1540483477&65535)<<16),b^=b>>>24,b=(b&65535)*1540483477+(((b>>>16)*1540483477&65535)<<16),f=(f&65535)*1540483477+(((f>>>16)*1540483477&65535)<<16)^b,d-=4,++y;switch(d){case 3:f^=(a[y+2]&255)<<16;case 2:f^=(a[y+1]&255)<<8;case 1:f^=a[y]&255,f=(f&65535)*1540483477+(((f>>>16)*1540483477&65535)<<16)}return f^=f>>>13,f=(f&65535)*1540483477+(((f>>>16)*1540483477&65535)<<16),f^=f>>>15,f>>>0}function n(a,u){typeof a=="string"&&(a=e(a));let d,f,y,b,w,A,R,I;for(d=a.length&3,f=a.length-d,y=u,w=3432918353,A=461845907,I=0;I<f;)R=a[I]&255|(a[++I]&255)<<8|(a[++I]&255)<<16|(a[++I]&255)<<24,++I,R=(R&65535)*w+(((R>>>16)*w&65535)<<16)&4294967295,R=R<<15|R>>>17,R=(R&65535)*A+(((R>>>16)*A&65535)<<16)&4294967295,y^=R,y=y<<13|y>>>19,b=(y&65535)*5+(((y>>>16)*5&65535)<<16)&4294967295,y=(b&65535)+27492+(((b>>>16)+58964&65535)<<16);switch(R=0,d){case 3:R^=(a[I+2]&255)<<16;case 2:R^=(a[I+1]&255)<<8;case 1:R^=a[I]&255,R=(R&65535)*w+(((R>>>16)*w&65535)<<16)&4294967295,R=R<<15|R>>>17,R=(R&65535)*A+(((R>>>16)*A&65535)<<16)&4294967295,y^=R}return y^=a.length,y^=y>>>16,y=(y&65535)*2246822507+(((y>>>16)*2246822507&65535)<<16)&4294967295,y^=y>>>13,y=(y&65535)*3266489909+(((y>>>16)*3266489909&65535)<<16)&4294967295,y^=y>>>16,y>>>0}const s=n;s.v2=r,s.v3=n,t.exports=s})()})(murmurhash);var murmurhashExports=murmurhash.exports;const hash=getDefaultExportFromCjs(murmurhashExports);function titled(t){return has(t,"title")?t.title:t}function compare$1(t,e){return typeof t=="string"&&typeof e=="string"?t.localeCompare(e):typeof t=="number"&&typeof e=="number"?t-e:has(t,"title")&&has(e,"title")?compare$1(clean(titled(t)),clean(titled(e))):0}function normalize(t){if(typeof t=="string")return clean(t);if(typeof t!="object")return t;const e={...t};for(const r in e)Array.isArray(e[r])?e[r]=e[r].map(normalize).sort(compare$1):e[r]=normalize(e[r]);return e}function stringify(t){return t=normalize(t),typeof t=="string"?t:typeof t!="object"?clean(String(t)):has(t,"artists")&&has(t,"title")&&has(t,"album")?`${t.artists.map(titled)} - ${t.title} - ${titled(t.album)}`:has(t,"artists")&&has(t,"title")?`${t.artists.map(titled)} - ${t.title}`:has(t,"title")?t.title:Array.isArray(t)?t.map(titled).toString():JSON.stringify(t)}function identify(t){return has(t,"id")?+t.id:hash(stringify(t))}const playlists$2=({store:t})=>t(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",r=>track$2(r).innerJoin("library","library.track","tracks.id").select(["library.playlist","library.id as entry"]).orderBy("library.order").orderBy("library.id")).selectFrom("track").fullJoin("playlists","playlists.id","track.playlist").where("playlists.id",">=",0).select(["playlists.id","playlists.title","playlists.relevancy","playlists.shared","playlists.remote",r=>json(r,{size:r.fn.count("track.duration"),duration:r.fn.coalesce(r.fn.sum("track.duration"),r.val(0)),tracks:groupJSON(r,{id:"track.id",entry:"track.entry",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("playlists.id").orderBy("playlists.order").orderBy("playlists.id").$castTo(),{async create(e,r){await e.insertInto("playlists").onConflict(n=>n.doNothing()).values({id:identify(r),order:APPEND,relevancy:1,...r}).execute()},async edit(e,r,n){await e.updateTable("playlists").where("id","=",r).set(n).execute()},async rearrange(e,r,n){await e.updateTable("playlists_fractindex").set({after_id:n||null}).where("id","=",r).execute()},async delete(e,r){await e.deleteFrom("playlists").where("id","=",r).execute()},get(e,r){return e.selectFrom("playlists").selectAll().where("id","=",r).executeTakeFirstOrThrow()}}),resources$1=({store:t})=>t(e=>e.with("source",source).with("asset",asset).selectFrom("source").leftJoin("asset","asset.owner","source.owner").select([r=>r.fn.coalesce("asset.arts",r.val("[]")).as("arts"),r=>r.fn.coalesce("asset.thumbnails",r.val("[]")).as("thumbnails"),r=>r.fn.coalesce("source.sources",r.val("[]")).as("sources")]).$castTo(),{async prioritize(e,r,n){const s=r==="art"?"assets":"sources";await e.updateTable(s).set({primary:sql`${sql.ref(r)} = ${n}`}).where("owner","=",a=>a.selectFrom(s).where(r,"=",n).select("owner")).execute()},get(e,r){return e.with("source",source).with("asset",asset).selectFrom("source").leftJoin("asset","asset.owner","source.owner").select([n=>n.fn.coalesce("asset.arts",n.val("[]")).as("arts"),n=>n.fn.coalesce("asset.thumbnails",n.val("[]")).as("thumbnails"),n=>n.fn.coalesce("source.sources",n.val("[]")).as("sources")]).where("source.owner","=",r).$castTo().executeTakeFirstOrThrow()}}),settings$2=({store:t})=>t(e=>e.selectFrom("settings").select(["key",sql`json_extract(value, '$')`.as("value")]),{async store(e,r,n,s="settings"){s!=="settings"&&(await e.schema.createTable(s).ifNotExists().addColumn("key","text",a=>a.primaryKey().notNull()).addColumn("value","text").execute(),await e.schema.createIndex(s+"_value").ifNotExists().on(s).column("value").execute()),await e.insertInto(s).onConflict(a=>a.doUpdateSet({value:JSON.stringify(n)})).values({key:r,value:JSON.stringify(n)}).execute()},async extract(e,r,n="settings"){return e.selectFrom(n).select("value").where("key","=",r).executeTakeFirstOrThrow().then(s=>JSON.parse(s.value))},async lookup(e,r,n="settings"){return e.selectFrom(n).select("key").where("value","=",JSON.stringify(r)).executeTakeFirstOrThrow().then(s=>s.key)}}),history$2=({store:t})=>t(e=>e.selectFrom("history").orderBy("date","desc").selectAll(),{async log(e,r){r.trim()&&await e.insertInto("history").onConflict(n=>n.doUpdateSet({date:Date.now()})).values({query:r,date:Date.now()}).execute()},async clear(e){await e.deleteFrom("history").execute()},get(e){return e.selectFrom("history").selectAll().orderBy("date","desc").execute()}}),artists$2=({store:t})=>t(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("artist").leftJoin("attribution","attribution.artist","artist.id").leftJoin("albums","albums.id","attribution.album").leftJoin("tracks","tracks.album","albums.id").leftJoin("track","track.id","tracks.id").select(["artist.id","artist.title","artist.following","artist.arts","artist.thumbnails","artist.sources",r=>json(r,{size:r.fn.count("track.duration"),duration:r.fn.coalesce(r.fn.sum("track.duration"),r.val(0)),tracks:groupJSON(r,{id:"track.id",entry:"track.id",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("artist.id").orderBy(r=>r.fn.count("track.duration"),"desc").orderBy("artist.title").$castTo(),{async push(e,r){await pushArtists(e,r)},async edit(e,r,n){await e.updateTable("artists").where("id","=",r).set(n)},async follow(e,r){await e.updateTable("artists").set({following:1}).where("id","=",r).execute()},async unfollow(e,r){await e.updateTable("artists").set({following:0}).where("id","=",r).execute()},async search(e,r,n=10,s=0){return r?e.with("source",source).with("asset",asset).with("artist",artist$1).selectFrom("artists_fts").where("artists_fts","match",sanitize(r)).orderBy("rank").innerJoin("artist","artist.id","artists_fts.rowid").selectAll().limit(n).offset(s).$castTo().execute():[]},get(e,r){return e.with("source",source).with("asset",asset).with("artist",artist$1).selectFrom("artist").where("artist.id","=",r).selectAll().$castTo().executeTakeFirstOrThrow()}}),library$2=({store:t})=>t(e=>e.selectFrom("library").selectAll(),{async push(e,r,n){r.length&&(await pushTracks(e,r),n!=null&&await e.insertInto("library").onConflict(s=>s.doNothing()).values(r.map(({id:s})=>({id:uuid(),order:APPEND,date:~~(Date.now()/1e3),track:s,playlist:n}))).execute())},async rearrange(e,r,n){await e.updateTable("library_fractindex").set({after_id:n||null}).where("id","=",r).execute()},async purge(e,r){const n=r.map(s=>e.deleteFrom("library").where("id","=",s).execute());await Promise.all(n)},async get(e,r){return r.length?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources","library.id as entry"]).where("library.id","in",r).$castTo().execute():[]},async sample(e,r){const n=r,s=n*Math.sqrt(2*Math.PI)/2,a=sql`POW(ABS(RANDOM()) / 9223372036854775808,
        ${s} /
        EXP(-0.5 * POW(row_number() OVER (ORDER BY date DESC) / ${n},2)) *
        playlists.relevancy
      )`;return await e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").innerJoin("playlists","playlists.id","library.playlist").innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources"]).where("relevancy",">",0).orderBy(a,"desc").limit(r).execute()},async banned(e){return await e.selectFrom("library").leftJoin("playlists","playlists.id","library.playlist").select("library.track").where("relevancy","<",0).execute().then(r=>r.map(n=>n.track))}}),id=integer,boolean=integer,tracks$2=assign(unique(track$1),object({album:id()}));crr(tracks$2);index(tracks$2,"album");primary(tracks$2,"id");const albums$2=unique(album);crr(albums$2);primary(albums$2,"id");const artists$1=assign(unique(artist),object({following:boolean()}));crr(artists$1);primary(artists$1,"id");const attribution=object({album:id(),artist:id()});crr(attribution);index(attribution,"artist");primary(attribution,"album","artist");const sources=object({source:string(),owner:id(),primary:boolean()});crr(sources);primary(sources,"owner","source");const assets=object({art:string(),thumbnail:nullable(string()),owner:id(),primary:boolean()});crr(assets);primary(assets,"owner","art");const playlists$1=assign(unique(playlist),object({order:string()}));crr(playlists$1);primary(playlists$1,"id");ordered(playlists$1,"order");index(playlists$1,"order","id");const library$1=object({id:id(),playlist:id(),track:id(),date:integer(),order:string()});crr(library$1);primary(library$1,"id");index(library$1,"date");index(library$1,"track");index(library$1,"playlist");index(library$1,"order","id");ordered(library$1,"order","playlist");const playback$1=object({id:id(),device:instance$1(Uint8Array),track:id(),order:string(),temp:any()});crr(playback$1);primary(playback$1,"id");index(playback$1,"device");index(playback$1,"order","id");ordered(playback$1,"order","device");const devices=object({id:instance$1(Uint8Array),playback:id(),direction:integer(),infinite:integer(),progress:number(),repeat:integer()});crr(devices);primary(devices,"id");const settings$1=object({key:string(),value:string()});crr(settings$1);index(settings$1,"value");primary(settings$1,"key");const history$1=object({query:string(),date:integer()});crr(history$1);index(history$1,"date");primary(history$1,"query");const schema=object({tracks:tracks$2,albums:albums$2,attribution,artists:artists$1,sources,assets,library:library$1,playlists:playlists$1,playback:playback$1,devices,settings:settings$1,history:history$1}),tracks$1=({store:t})=>t(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").where("playlist",">=",0).innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources","library.id as entry","library.date"]).orderBy("library.date","desc").orderBy("library.id").$castTo(),{async edit(e,r,n){const s=await e.updateTable("tracks").where("id","=",r).set({...n,album:void 0}).returning("album").executeTakeFirst();s?.album&&n.album&&await e.updateTable("albums").where("id","=",s.album).set(n.album).execute()},async search(e,r,n=10,s=0){return r?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("tracks_fts").where("tracks_fts","match",sanitize(r)).orderBy("rank").innerJoin("track","track.id","rowid").selectAll().limit(n).offset(s).$castTo().execute():[]},get(e,r){return e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("track").selectAll().where("id","=",r).$castTo().executeTakeFirstOrThrow()}}),albums$1=({store:t})=>t(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("album").selectAll().orderBy("album.title"),{async push(e,r){await pushAlbums(e,r)},async search(e,r,n=10,s=0){return r?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("albums_fts").where("albums_fts","match",sanitize(r)).orderBy("rank").innerJoin("album","album.id","albums_fts.rowid").selectAll().limit(n).offset(s).$castTo().execute():[]},get(e,r){return e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("album").selectAll().where("album.id","=",r).$castTo().executeTakeFirstOrThrow()}}),feed$1=({store:t})=>t(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",r=>track$2(r).innerJoin("library","library.track","tracks.id").select(["library.playlist","library.id as entry"]).orderBy("library.order").orderBy("library.id")).selectFrom("track").fullJoin("playlists","playlists.id","track.playlist").where("playlists.id","<",0).select(["playlists.id","playlists.title","playlists.relevancy","playlists.shared","playlists.remote",r=>json(r,{size:r.fn.count("track.duration"),duration:r.fn.coalesce(r.fn.sum("track.duration"),r.val(0)),tracks:groupJSON(r,{id:"track.id",entry:"track.entry",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("playlists.id").orderBy("playlists.order").orderBy("playlists.id").$castTo(),{async clear(e,r){await e.deleteFrom("library").where("playlist","=",r).execute()},async get(e,r,n=-1){return e.selectFrom("library").where("playlist","=",r).select("id").limit(n).execute().then(s=>s.map(a=>a.id))}}),connections=new Map,stores=t=>({playlists:playlists$2(t),resources:resources$1(t),preceding:preceding$1(t),playback:playback$2(t),upcoming:upcoming$1(t),settings:settings$2(t),history:history$2(t),artists:artists$2(t),library:library$2(t),albums:albums$1(t),tracks:tracks$1(t),feed:feed$1(t)});function connect(t){if(!connections.has(t.name)){const e=database(t.local?nocrr(schema):schema,t);connections.set(t.name,{...e,...stores(e)});const r=Object.assign({"../sql/cascade.sql":__vite_glob_0_0,"../sql/fts.sql":__vite_glob_0_1,"../sql/playback.sql":__vite_glob_0_2,"../sql/playlists.sql":__vite_glob_0_3});t.local&&delete r["../sql/fts.sql"];const n=Object.values(r).flatMap(s=>s.split(/\r?\n\r?\n/)).map(s=>sql.raw(s));e.update(s=>Promise.all(n.map(a=>a.execute(s))))}return connections.get(t.name)}function nocrr(t){return{...t,schema:Object.fromEntries(Object.entries(t.schema).map(([e,r])=>[e,{...r,crr:!1}]))}}function identity(t){return t}function pipeFromArray(t){return t.length===0?identity:t.length===1?t[0]:function(r){return t.reduce((n,s)=>s(n),r)}}function observable(t){const e={subscribe(r){let n=null,s=!1,a=!1,u=!1;function d(){if(n===null){u=!0;return}a||(a=!0,typeof n=="function"?n():n&&n.unsubscribe())}return n=t({next(f){s||r.next?.(f)},error(f){s||(s=!0,r.error?.(f),d())},complete(){s||(s=!0,r.complete?.(),d())}}),u&&d(),{unsubscribe:d}},pipe(...r){return pipeFromArray(r)(e)}};return e}function share(t){return e=>{let r=0,n=null;const s=[];function a(){n||(n=e.subscribe({next(d){for(const f of s)f.next?.(d)},error(d){for(const f of s)f.error?.(d)},complete(){for(const d of s)d.complete?.()}}))}function u(){if(r===0&&n){const d=n;n=null,d.unsubscribe()}}return{subscribe(d){return r++,s.push(d),a(),{unsubscribe(){r--,u();const f=s.findIndex(y=>y===d);f>-1&&s.splice(f,1)}}}}}}class ObservableAbortError extends Error{constructor(e){super(e),this.name="ObservableAbortError",Object.setPrototypeOf(this,ObservableAbortError.prototype)}}function observableToPromise(t){let e;return{promise:new Promise((n,s)=>{let a=!1;function u(){a||(a=!0,s(new ObservableAbortError("This operation was aborted.")),d.unsubscribe())}const d=t.subscribe({next(f){a=!0,n(f),u()},error(f){a=!0,s(f),u()},complete(){a=!0,u()}});e=u}),abort:e}}function createChain(t){return observable(e=>{function r(s=0,a=t.op){const u=t.links[s];if(!u)throw new Error("No more links to execute - did you forget to add an ending link?");return u({op:a,next(f){return r(s+1,f)}})}return r().subscribe(e)})}function invert(t){const e=Object.create(null);for(const r in t){const n=t[r];e[n]=r}return e}const TRPC_ERROR_CODES_BY_KEY={PARSE_ERROR:-32700,BAD_REQUEST:-32600,INTERNAL_SERVER_ERROR:-32603,NOT_IMPLEMENTED:-32603,UNAUTHORIZED:-32001,FORBIDDEN:-32003,NOT_FOUND:-32004,METHOD_NOT_SUPPORTED:-32005,TIMEOUT:-32008,CONFLICT:-32009,PRECONDITION_FAILED:-32012,PAYLOAD_TOO_LARGE:-32013,UNPROCESSABLE_CONTENT:-32022,TOO_MANY_REQUESTS:-32029,CLIENT_CLOSED_REQUEST:-32099};invert(TRPC_ERROR_CODES_BY_KEY);invert(TRPC_ERROR_CODES_BY_KEY);const noop=()=>{};function createInnerProxy(t,e){return new Proxy(noop,{get(n,s){if(!(typeof s!="string"||s==="then"))return createInnerProxy(t,[...e,s])},apply(n,s,a){const u=e[e.length-1]==="apply";return t({args:u?a.length>=2?a[1]:[]:a,path:u?e.slice(0,-1):e})}})}const createRecursiveProxy=t=>createInnerProxy(t,[]),createFlatProxy=t=>new Proxy(noop,{get(e,r){if(!(typeof r!="string"||r==="then"))return t(r)}});function isObject$1(t){return!!t&&!Array.isArray(t)&&typeof t=="object"}class UnknownCauseError extends Error{}function getCauseFromUnknown(t){if(t instanceof Error)return t;const e=typeof t;if(!(e==="undefined"||e==="function"||t===null)){if(e!=="object")return new Error(String(t));if(isObject$1(t)){const r=new UnknownCauseError;for(const n in t)r[n]=t[n];return r}}}function isObject(t){return!!t&&!Array.isArray(t)&&typeof t=="object"}function transformResultInner(t,e){if("error"in t){const n=e.transformer.deserialize(t.error);return{ok:!1,error:{...t,error:n}}}return{ok:!0,result:{...t.result,...(!t.result.type||t.result.type==="data")&&{type:"data",data:e.transformer.deserialize(t.result.data)}}}}class TransformResultError extends Error{constructor(){super("Unable to transform response from server")}}function transformResult(t,e){let r;try{r=transformResultInner(t,e)}catch{throw new TransformResultError}if(!r.ok&&(!isObject(r.error.error)||typeof r.error.error.code!="number"))throw new TransformResultError;if(r.ok&&!isObject(r.result))throw new TransformResultError;return r}function isTRPCClientError(t){return t instanceof TRPCClientError||t instanceof Error&&t.name==="TRPCClientError"}function isTRPCErrorResponse(t){return isObject(t)&&isObject(t.error)&&typeof t.error.code=="number"&&typeof t.error.message=="string"}class TRPCClientError extends Error{static from(e,r={}){const n=e;return isTRPCClientError(n)?(r.meta&&(n.meta={...n.meta,...r.meta}),n):isTRPCErrorResponse(n)?new TRPCClientError(n.error.message,{...r,result:n}):n instanceof Error?new TRPCClientError(n.message,{...r,cause:getCauseFromUnknown(n)}):new TRPCClientError("Unknown error",{...r,cause:n})}constructor(e,r){const n=r?.cause;super(e,{cause:n}),this.meta=r?.meta,this.cause=n,this.shape=r?.result?.error,this.data=r?.result?.error.data,this.name="TRPCClientError",Object.setPrototypeOf(this,TRPCClientError.prototype)}}/* istanbul ignore next -- @preserve */const retryDelay=t=>t===0?0:Math.min(1e3*2**t,3e4);function createWSClient(t){const{url:e,WebSocket:r=WebSocket,retryDelayMs:n=retryDelay,onOpen:s,onClose:a}=t;/* istanbul ignore next -- @preserve */if(!r)throw new Error("No WebSocket implementation found - you probably don't want to use this on the server, but if you do you need to pass a `WebSocket`-ponyfill");let u=[];const d=Object.create(null);let f=0,y=null,b=null,w=C(),A="connecting";function R(){A!=="open"||y||(y=setTimeout(()=>{y=null,u.length===1?w.send(JSON.stringify(u.pop())):w.send(JSON.stringify(u)),u=[]}))}function I(){if(b!==null||A==="closed")return;const T=n(f++);N(T)}function h(){A="connecting";const T=w;w=C(),m(T)}function N(T){b||(A="connecting",b=setTimeout(h,T))}function m(T){Object.values(d).some(Y=>Y.ws===T)||T.close()}function E(){Object.values(d).forEach(T=>{T.type==="subscription"&&T.callbacks.complete()})}function v(T){u.some(q=>q.id===T.op.id)||$(T.op,T.callbacks)}function C(){const T=typeof e=="function"?e():e,q=new r(T);clearTimeout(b),b=null,q.addEventListener("open",()=>{/* istanbul ignore next -- @preserve */q===w&&(f=0,A="open",s?.(),R())}),q.addEventListener("error",()=>{q===w&&I()});const Y=M=>{if(M.method==="reconnect"&&q===w){A==="open"&&a?.(),h();for(const W of Object.values(d))W.type==="subscription"&&v(W)}},z=M=>{const W=M.id!==null&&d[M.id];if(W){if(W.callbacks.next?.(M),W.ws!==w&&q===w){const V=W.ws;W.ws=w,m(V)}"result"in M&&M.result.type==="stopped"&&q===w&&W.callbacks.complete()}};return q.addEventListener("message",({data:M})=>{const W=JSON.parse(M);"method"in W?Y(W):z(W),(q!==w||A==="closed")&&m(q)}),q.addEventListener("close",({code:M})=>{A==="open"&&a?.({code:M}),w===q&&I();for(const[W,V]of Object.entries(d))if(V.ws===q){if(A==="closed"){delete d[W],V.callbacks.complete?.();continue}V.type==="subscription"?v(V):(delete d[W],V.callbacks.error?.(TRPCClientError.from(new TRPCWebSocketClosedError("WebSocket closed prematurely"))))}}),q}function $(T,q){const{type:Y,input:z,path:M,id:W}=T,V={id:W,method:Y,params:{input:z,path:M}};return d[W]={ws:w,type:Y,callbacks:q,op:T},u.push(V),R(),()=>{const ae=d[W]?.callbacks;delete d[W],u=u.filter(G=>G.id!==W),ae?.complete?.(),w.readyState===r.OPEN&&T.type==="subscription"&&(u.push({id:W,method:"subscription.stop"}),R())}}return{close:()=>{A="closed",a?.(),E(),m(w),clearTimeout(b),b=null},request:$,getConnection(){return w}}}class TRPCWebSocketClosedError extends Error{constructor(e){super(e),this.name="TRPCWebSocketClosedError",Object.setPrototypeOf(this,TRPCWebSocketClosedError.prototype)}}function wsLink(t){return e=>{const{client:r}=t;return({op:n})=>observable(s=>{const{type:a,path:u,id:d,context:f}=n,y=e.transformer.serialize(n.input),b=r.request({type:a,path:u,input:y,id:d,context:f},{error(w){s.error(w),b()},complete(){s.complete()},next(w){const A=transformResult(w,e);if(!A.ok){s.error(TRPCClientError.from(A.error));return}s.next({result:A.result}),n.type!=="subscription"&&(b(),s.complete())}});return()=>{b()}})}}class TRPCUntypedClient{$request({type:e,input:r,path:n,context:s={}}){return createChain({links:this.links,op:{id:++this.requestId,type:e,path:n,input:r,context:s}}).pipe(share())}requestAsPromise(e){const r=this.$request(e),{promise:n,abort:s}=observableToPromise(r);return new Promise((u,d)=>{e.signal?.addEventListener("abort",s),n.then(f=>{u(f.result.data)}).catch(f=>{d(TRPCClientError.from(f))})})}query(e,r,n){return this.requestAsPromise({type:"query",path:e,input:r,context:n?.context,signal:n?.signal})}mutation(e,r,n){return this.requestAsPromise({type:"mutation",path:e,input:r,context:n?.context,signal:n?.signal})}subscription(e,r,n){return this.$request({type:"subscription",path:e,input:r,context:n?.context}).subscribe({next(a){a.result.type==="started"?n.onStarted?.():a.result.type==="stopped"?n.onStopped?.():n.onData?.(a.result.data)},error(a){n.onError?.(a)},complete(){n.onComplete?.()}})}constructor(e){this.requestId=0;const r=(()=>{const n=e.transformer;return n?"input"in n?e.transformer:{input:n,output:n}:{input:{serialize:s=>s,deserialize:s=>s},output:{serialize:s=>s,deserialize:s=>s}}})();this.runtime={transformer:{serialize:n=>r.input.serialize(n),deserialize:n=>r.output.deserialize(n)},combinedTransformer:r},this.links=e.links.map(n=>n(this.runtime))}}const clientCallTypeMap={query:"query",mutate:"mutation",subscribe:"subscription"},clientCallTypeToProcedureType=t=>clientCallTypeMap[t];function createTRPCClientProxy(t){return createFlatProxy(e=>t.hasOwnProperty(e)?t[e]:e==="__untypedClient"?t:createRecursiveProxy(({path:r,args:n})=>{const s=[e,...r],a=clientCallTypeToProcedureType(s.pop()),u=s.join(".");return t[a](u,...n)}))}function createTRPCProxyClient(t){const e=new TRPCUntypedClient(t);return createTRPCClientProxy(e)}const{sync,search:search$1,streams,expand,desource,transcribe}=createTRPCProxyClient({links:[globalThis.localStorage?.getItem("remote")?wsLink({client:createWSClient({url:()=>localStorage.getItem("remote")})}):()=>()=>observable(()=>{})]}),{playlists,resources,preceding,playback,upcoming,settings,history,artists,library,albums,tracks,update,feed}=connect({name:"library.db",push:sync.push.mutate,pull:sync.pull.subscribe}),search=writable(""),extra=writable(null);function format(t,e=!1){if(!e){t=Math.round(+t),t<=0&&(t=0);const d=~~(t/3600);t-=d*3600;const f=~~(t/60);t-=f*60;const y=t,b=w=>w.toString().padStart(2,"0");return d?`${d}:${b(f)}:${b(y)}`:`${f}:${b(y)}`}const r=new Intl.RelativeTimeFormat("en"),n=Math.floor((Date.now()-+t)/1e3),s=Math.floor(n/60),a=Math.floor(s/60),u=Math.floor(a/24);return n<=1?"just now":n<60?r.format(-n,"seconds"):s<60?r.format(-s,"minutes"):a<24?r.format(-a,"hours"):r.format(-u,"days")}function compare(t){const e=new Date;return+t>+e?"In The Future":t.getFullYear()===e.getFullYear()?t.getMonth()===e.getMonth()?e.getDate()-t.getDate()===0?"Today":e.getDate()-t.getDate()===1?"Yesterday":e.getDate()-t.getDate()<7&&e.getDay()>t.getDay()?"This Week":e.getDate()-t.getDate()<7||e.getDate()-t.getDate()<14&&e.getDay()>=t.getDay()?"Last Week":"This Month":e.getMonth()-t.getMonth()===1?"Last Month":`In ${t.toLocaleString("default",{month:"long"})}`:t.getFullYear().toString()}const get_default_slot_changes=t=>({}),get_default_slot_context=t=>({slot:"after"});function create_default_slot_6(t){let e;return{c(){e=text(t[4])},l(r){e=claim_text(r,t[4])},m(r,n){insert_hydration(r,e,n)},p(r,n){n&16&&set_data(e,r[4])},d(r){r&&detach(e)}}}function create_default_slot_5(t){let e,r,n,s;return n=new Text({props:{secondary:!0,$$slots:{default:[create_default_slot_6]},$$scope:{ctx:t}}}),{c(){e=text(t[5]),r=space(),create_component(n.$$.fragment)},l(a){e=claim_text(a,t[5]),r=claim_space(a),claim_component(n.$$.fragment,a)},m(a,u){insert_hydration(a,e,u),insert_hydration(a,r,u),mount_component(n,a,u),s=!0},p(a,u){(!s||u&32)&&set_data(e,a[5]);const d={};u&1040&&(d.$$scope={dirty:u,ctx:a}),n.$set(d)},i(a){s||(transition_in(n.$$.fragment,a),s=!0)},o(a){transition_out(n.$$.fragment,a),s=!1},d(a){a&&(detach(e),detach(r)),destroy_component(n,a)}}}function create_default_slot_4(t){let e=t[3]?.artists.map(func).join(", ")+"",r;return{c(){r=text(e)},l(n){r=claim_text(n,e)},m(n,s){insert_hydration(n,r,s)},p(n,s){s&8&&e!==(e=n[3]?.artists.map(func).join(", ")+"")&&set_data(r,e)},d(n){n&&detach(r)}}}function create_if_block(t){let e,r;return e=new When({props:{lg:!0,$$slots:{default:[create_default_slot_2]},$$scope:{ctx:t}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),r=!0},p(n,s){const a={};s&1032&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){r||(transition_in(e.$$.fragment,n),r=!0)},o(n){transition_out(e.$$.fragment,n),r=!1},d(n){destroy_component(e,n)}}}function create_default_slot_3(t){let e=t[3]?.album.title+"",r;return{c(){r=text(e)},l(n){r=claim_text(n,e)},m(n,s){insert_hydration(n,r,s)},p(n,s){s&8&&e!==(e=n[3]?.album.title+"")&&set_data(r,e)},d(n){n&&detach(r)}}}function create_default_slot_2(t){let e,r;return e=new Text({props:{secondary:!0,sm:!0,loading:!t[3],$$slots:{default:[create_default_slot_3]},$$scope:{ctx:t}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),r=!0},p(n,s){const a={};s&8&&(a.loading=!n[3]),s&1032&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){r||(transition_in(e.$$.fragment,n),r=!0)},o(n){transition_out(e.$$.fragment,n),r=!1},d(n){destroy_component(e,n)}}}function create_default_slot_1(t){let e,r,n,s,a,u,d=`scaleX(${t[1]})`,f;e=new Text({props:{accent:!0,loading:!t[3],$$slots:{default:[create_default_slot_5]},$$scope:{ctx:t}}}),n=new Text({props:{secondary:!0,sm:!0,loading:!t[3],$$slots:{default:[create_default_slot_4]},$$scope:{ctx:t}}});let y=!t[0]&&create_if_block(t);return{c(){create_component(e.$$.fragment),r=space(),create_component(n.$$.fragment),s=space(),y&&y.c(),a=space(),u=element("div"),this.h()},l(b){claim_component(e.$$.fragment,b),r=claim_space(b),claim_component(n.$$.fragment,b),s=claim_space(b),y&&y.l(b),a=claim_space(b),u=claim_element(b,"DIV",{class:!0}),children(u).forEach(detach),this.h()},h(){attr(u,"class","absolute bottom-0 left-0 h-0.5 w-full origin-left transform-gpu bg-highlight-200 transition-transform duration-1000"),set_style(u,"transform",d)},m(b,w){mount_component(e,b,w),insert_hydration(b,r,w),mount_component(n,b,w),insert_hydration(b,s,w),y&&y.m(b,w),insert_hydration(b,a,w),insert_hydration(b,u,w),f=!0},p(b,w){const A={};w&8&&(A.loading=!b[3]),w&1072&&(A.$$scope={dirty:w,ctx:b}),e.$set(A);const R={};w&8&&(R.loading=!b[3]),w&1032&&(R.$$scope={dirty:w,ctx:b}),n.$set(R),b[0]?y&&(group_outros(),transition_out(y,1,1,()=>{y=null}),check_outros()):y?(y.p(b,w),w&1&&transition_in(y,1)):(y=create_if_block(b),y.c(),transition_in(y,1),y.m(a.parentNode,a)),w&2&&d!==(d=`scaleX(${b[1]})`)&&set_style(u,"transform",d)},i(b){f||(transition_in(e.$$.fragment,b),transition_in(n.$$.fragment,b),transition_in(y),f=!0)},o(b){transition_out(e.$$.fragment,b),transition_out(n.$$.fragment,b),transition_out(y),f=!1},d(b){b&&(detach(r),detach(s),detach(a),detach(u)),destroy_component(e,b),destroy_component(n,b),y&&y.d(b)}}}function create_default_slot(t){let e,r,n=`hue-rotate(${t[3]?.id||0}deg)`,s;return r=new Icon({props:{name:"note"}}),{c(){e=element("div"),create_component(r.$$.fragment),this.h()},l(a){e=claim_element(a,"DIV",{class:!0});var u=children(e);claim_component(r.$$.fragment,u),u.forEach(detach),this.h()},h(){attr(e,"class","flex h-full w-full items-center justify-center bg-gradient-to-r from-rose-400 to-red-400 text-white"),set_style(e,"filter",n)},m(a,u){insert_hydration(a,e,u),mount_component(r,e,null),s=!0},p(a,u){u&8&&n!==(n=`hue-rotate(${a[3]?.id||0}deg)`)&&set_style(e,"filter",n)},i(a){s||(transition_in(r.$$.fragment,a),s=!0)},o(a){transition_out(r.$$.fragment,a),s=!1},d(a){a&&detach(e),destroy_component(r)}}}function create_before_slot(t){let e,r;return e=new Image({props:{src:t[3]?t[3].album.arts?.[0]||"":void 0,thumbnail:t[3]?t[3].album.thumbnails?.[0]||"":void 0,slot:"before",$$slots:{default:[create_default_slot]},$$scope:{ctx:t}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),r=!0},p(n,s){const a={};s&8&&(a.src=n[3]?n[3].album.arts?.[0]||"":void 0),s&8&&(a.thumbnail=n[3]?n[3].album.thumbnails?.[0]||"":void 0),s&1032&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){r||(transition_in(e.$$.fragment,n),r=!0)},o(n){transition_out(e.$$.fragment,n),r=!1},d(n){destroy_component(e,n)}}}function create_after_slot(t){let e;const r=t[7].default,n=create_slot(r,t,t[10],get_default_slot_context);return{c(){n&&n.c()},l(s){n&&n.l(s)},m(s,a){n&&n.m(s,a),e=!0},p(s,a){n&&n.p&&(!e||a&1024)&&update_slot_base(n,r,s,s[10],e?get_slot_changes(r,s[10],a,get_default_slot_changes):get_all_dirty_from_scope(s[10]),get_default_slot_context)},i(s){e||(transition_in(n,s),e=!0)},o(s){transition_out(n,s),e=!1},d(s){n&&n.d(s)}}}function create_fragment(t){let e,r;return e=new Card({props:{sm:!0,flat:!0,flow:!t[0],interactive:!0,selected:t[2],$$slots:{after:[create_after_slot],before:[create_before_slot],default:[create_default_slot_1]},$$scope:{ctx:t}}}),e.$on("contextmenu",t[8]),e.$on("click",t[9]),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,s){mount_component(e,n,s),r=!0},p(n,[s]){const a={};s&1&&(a.flow=!n[0]),s&4&&(a.selected=n[2]),s&1083&&(a.$$scope={dirty:s,ctx:n}),e.$set(a)},i(n){r||(transition_in(e.$$.fragment,n),r=!0)},o(n){transition_out(e.$$.fragment,n),r=!1},d(n){destroy_component(e,n)}}}const func=t=>t.title;function instance(t,e,r){let n,s,a,{$$slots:u={},$$scope:d}=e,{sm:f=!1}=e,{progress:y=0}=e,{selected:b=!1}=e,{track:w=void 0}=e;function A(I){bubble.call(this,t,I)}function R(I){bubble.call(this,t,I)}return t.$$set=I=>{"sm"in I&&r(0,f=I.sm),"progress"in I&&r(1,y=I.progress),"selected"in I&&r(2,b=I.selected),"track"in I&&r(3,w=I.track),"$$scope"in I&&r(10,d=I.$$scope)},t.$$.update=()=>{t.$$.dirty&8&&r(5,[n=void 0,...s]=w?.title.split("(")||[],n,(r(6,s),r(3,w))),t.$$.dirty&64&&r(4,a=s.length?"("+s.join("("):"")},[f,y,b,w,a,n,s,u,A,R,d]}class Track extends SvelteComponent{constructor(e){super(),init$1(this,e,instance,create_fragment,safe_not_equal,{sm:0,progress:1,selected:2,track:3})}}export{Card as C,Image as I,Portal as P,Realm as R,Track as T,Virtual as V,When as W,extra as a,streams as b,capitalize as c,search$1 as d,ensure_array_like as e,albums as f,artists as g,history as h,initRealm as i,expand as j,playback as k,library as l,feed as m,Text as n,outro_and_destroy_block as o,playlists as p,format as q,ready as r,search as s,tracks as t,update_keyed_each as u,hold as v,compare as w,upcoming as x,desource as y};
