var Sa=Object.defineProperty;var va=(r,e,t)=>e in r?Sa(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var oe=(r,e,t)=>(va(r,typeof e!="symbol"?e+"":e,t),t),os=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var i=(r,e,t)=>(os(r,e,"read from private field"),t?t.call(r):e.get(r)),g=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},x=(r,e,t,n)=>(os(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var j=(r,e,t)=>(os(r,e,"access private method"),t);import{T as run_all,s as safe_not_equal,y as create_slot,e as element,c as claim_element,b as children,f as detach,r as attr,D as toggle_class,i as insert_hydration,z as update_slot_base,A as get_all_dirty_from_scope,B as get_slot_changes,W as setContext,C as empty$1,n as noop$2,G as getContext,a as space,g as claim_space,K as set_style,h as append_hydration,F as listen,S as action_destroyer,k as component_subscribe,H as createEventDispatcher,q as onMount,N as tick,m as set_store_value,v as binding_callbacks,ab as compute_slots,I as assign$1,J as set_dynamic_element_data,x as bubble,af as src_url_equal,p as get_store_value,t as text,d as claim_text,j as set_data}from"./scheduler.DDeJziXz.js";import{b as transition_out,t as transition_in,S as SvelteComponent,i as init$1,g as group_outros,e as check_outros,c as create_component,a as claim_component,m as mount_component,d as destroy_component}from"./index.Ck-5ZlV-.js";import{w as writable,d as derived}from"./entry.Dq0cEQhD.js";import{l as lock,b as unlock,a as getScrollParent,p as position$1,I as Icon,g as get_spread_update}from"./Spinner.svelte_svelte_type_style_lang.Df5Tmw8H.js";const globals=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function ensure_array_like(r){return(r==null?void 0:r.length)!==void 0?r:Array.from(r)}function outro_and_destroy_block(r,e){transition_out(r,1,1,()=>{e.delete(r.key)})}function update_keyed_each(r,e,t,n,o,a,l,d,h,p,m,E){let k=r.length,L=a.length,S=k;const y={};for(;S--;)y[r[S].key]=S;const w=[],b=new Map,_=new Map,C=[];for(S=L;S--;){const F=E(o,a,S),fe=t(F);let $=l.get(fe);$?C.push(()=>$.p(F,e)):($=p(fe,F),$.c()),b.set(fe,w[S]=$),fe in y&&_.set(fe,Math.abs(S-y[fe]))}const A=new Set,G=new Set;function I(F){transition_in(F,1),F.m(d,m),l.set(F.key,F),m=F.first,L--}for(;k&&L;){const F=w[L-1],fe=r[k-1],$=F.key,H=fe.key;F===fe?(m=F.first,k--,L--):b.has(H)?!l.has($)||A.has($)?I(F):G.has(H)?k--:_.get($)>_.get(H)?(G.add($),I(F)):(A.add(H),k--):(h(fe,l),k--)}for(;k--;){const F=r[k];b.has(F.key)||h(F,l)}for(;L;)I(w[L-1]);return run_all(C),w}let observing=0,observer=null;const dispatch=r=>r.forEach(e=>{var t;(t=e.target)==null||t.dispatchEvent(new CustomEvent("resize",{detail:e}))});function resize(r){return observer||(observer=new ResizeObserver(dispatch)),observer.observe(r),observing+=1,{destroy(){observer==null||observer.unobserve(r),observing-=1,observing<=0&&(observer==null||observer.disconnect(),observer=null)}}}function drag(r,e="touchstart"){function t(l){do{if(l!=null&&l.draggable)return l;l=(l==null?void 0:l.parentElement)||null}while(l);return null}function n(l){const d=t(l.target);d&&(lock(),l.preventDefault(),d.dispatchEvent(new DragEvent("dragstart",{bubbles:!0})))}function o(l){l.preventDefault(),addEventListener("pointercancel",a),addEventListener("pointerup",a)}function a(){unlock(),removeEventListener("pointercancel",a),removeEventListener("pointerup",a),r.dispatchEvent(new DragEvent("dragend",{bubbles:!0}))}return r.addEventListener(e,n),r.addEventListener("dragstart",o),{destroy(){r.removeEventListener(e,n),r.removeEventListener("dragstart",o)}}}function hold(r,{touch:e=!0,mouse:t=!1,duration:n=300}={}){function o(a){const l=setTimeout(()=>{var p;d();const h=a instanceof TouchEvent?TouchEvent:MouseEvent;(p=a.target)==null||p.dispatchEvent(new h("hold",a))},n),d=()=>{clearTimeout(l),e&&(r.removeEventListener("touchcancel",d),r.removeEventListener("touchmove",d),r.removeEventListener("touchend",d)),t&&(r.removeEventListener("mousemove",d),r.removeEventListener("mouseup",d))};e&&(r.addEventListener("touchcancel",d,{once:!0}),r.addEventListener("touchend",d,{once:!0}),r.addEventListener("touchmove",d,{once:!0,passive:!0})),t&&(r.addEventListener("mousemove",d,{once:!0}),r.addEventListener("mouseup",d,{once:!0}))}return e&&r.addEventListener("touchstart",o,{passive:!0}),t&&r.addEventListener("mousedown",o),{destroy(){r.removeEventListener("touchstart",o),r.removeEventListener("mousedown",o)}}}function create_fragment$7(r){let e,t,n;const o=r[6].default,a=create_slot(o,r,r[5],null);return{c(){e=element("div"),a&&a.c(),this.h()},l(l){e=claim_element(l,"DIV",{class:!0});var d=children(e);a&&a.l(d),d.forEach(detach),this.h()},h(){attr(e,"class",t=r[0]?"contents":"hidden"),toggle_class(e,"sm:contents",!r[0]&&r[1]),toggle_class(e,"md:contents",!r[0]&&r[2]),toggle_class(e,"lg:contents",!r[0]&&r[3]),toggle_class(e,"xl:contents",!r[0]&&r[4]),toggle_class(e,"sm:hidden",r[0]&&r[1]),toggle_class(e,"md:hidden",r[0]&&r[2]),toggle_class(e,"lg:hidden",r[0]&&r[3]),toggle_class(e,"xl:hidden",r[0]&&r[4])},m(l,d){insert_hydration(l,e,d),a&&a.m(e,null),n=!0},p(l,[d]){a&&a.p&&(!n||d&32)&&update_slot_base(a,o,l,l[5],n?get_slot_changes(o,l[5],d,null):get_all_dirty_from_scope(l[5]),null),(!n||d&1&&t!==(t=l[0]?"contents":"hidden"))&&attr(e,"class",t),(!n||d&3)&&toggle_class(e,"sm:contents",!l[0]&&l[1]),(!n||d&5)&&toggle_class(e,"md:contents",!l[0]&&l[2]),(!n||d&9)&&toggle_class(e,"lg:contents",!l[0]&&l[3]),(!n||d&17)&&toggle_class(e,"xl:contents",!l[0]&&l[4]),(!n||d&3)&&toggle_class(e,"sm:hidden",l[0]&&l[1]),(!n||d&5)&&toggle_class(e,"md:hidden",l[0]&&l[2]),(!n||d&9)&&toggle_class(e,"lg:hidden",l[0]&&l[3]),(!n||d&17)&&toggle_class(e,"xl:hidden",l[0]&&l[4])},i(l){n||(transition_in(a,l),n=!0)},o(l){transition_out(a,l),n=!1},d(l){l&&detach(e),a&&a.d(l)}}}function instance$8(r,e,t){let{$$slots:n={},$$scope:o}=e,{not:a=!1}=e,{sm:l=!1}=e,{md:d=!1}=e,{lg:h=!1}=e,{xl:p=!1}=e;return r.$$set=m=>{"not"in m&&t(0,a=m.not),"sm"in m&&t(1,l=m.sm),"md"in m&&t(2,d=m.md),"lg"in m&&t(3,h=m.lg),"xl"in m&&t(4,p=m.xl),"$$scope"in m&&t(5,o=m.$$scope)},[a,l,d,h,p,o,n]}class When extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$8,create_fragment$7,safe_not_equal,{not:0,sm:1,md:2,lg:3,xl:4})}}function create_fragment$6(r){let e;const t=r[1].default,n=create_slot(t,r,r[0],null);return{c(){n&&n.c()},l(o){n&&n.l(o)},m(o,a){n&&n.m(o,a),e=!0},p(o,[a]){n&&n.p&&(!e||a&1)&&update_slot_base(n,t,o,o[0],e?get_slot_changes(t,o[0],a,null):get_all_dirty_from_scope(o[0]),null)},i(o){e||(transition_in(n,o),e=!0)},o(o){transition_out(n,o),e=!1},d(o){n&&n.d(o)}}}const initRealm=()=>({ssr:"",claimed:new Set,mounted:new Set,claim:new Set,destroy:new Set,mount:new Set,target:void 0});function instance$7(r,e,t){let{$$slots:n={},$$scope:o}=e;return setContext("realm",{}),r.$$set=l=>{"$$scope"in l&&t(0,o=l.$$scope)},[o,n]}class Realm extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$7,create_fragment$6,safe_not_equal,{})}}function create_key_block(r){let e;const t=r[4].default,n=create_slot(t,r,r[3],null);return{c(){n&&n.c()},l(o){n&&n.l(o)},m(o,a){n&&n.m(o,a),e=!0},p(o,a){n&&n.p&&(!e||a&8)&&update_slot_base(n,t,o,o[3],e?get_slot_changes(t,o[3],a,null):get_all_dirty_from_scope(o[3]),null)},i(o){e||(transition_in(n,o),e=!0)},o(o){transition_out(n,o),e=!1},d(o){n&&n.d(o)}}}function create_fragment$5(r){let e=r[0],t,n,o=create_key_block(r);return{c(){o.c(),t=empty$1()},l(a){o.l(a),t=empty$1()},m(a,l){o.m(a,l),insert_hydration(a,t,l),n=!0},p(a,[l]){l&1&&safe_not_equal(e,e=a[0])?(group_outros(),transition_out(o,1,1,noop$2),check_outros(),o=create_key_block(a),o.c(),transition_in(o,1),o.m(t.parentNode,t)):o.p(a,l)},i(a){n||(transition_in(o),n=!0)},o(a){transition_out(o),n=!1},d(a){a&&detach(t),o.d(a)}}}function instance$6($$self,$$props,$$invalidate){let{$$slots:slots={},$$scope}=$$props,{to=""}=$$props,{unique=""}=$$props;const realm=getContext("realm");if(!realm)throw new Error("A portal should exists within a realm!");realm[to]||(realm[to]=initRealm());const target=eval("slots");if(target.default){const[r]=target.default;target.default[0]=(...e)=>{const t=r(...e),n=realm[to];let o=!0,a=!0;function l(p){if(!p||n.claimed.has(unique))return a=!1;t.l(p),unique&&n.claimed.add(unique)}function d(p,m){if(n.mounted.has(unique))return o=!1;a&&t.m(p,m),unique&&n.mounted.add(unique)}function h(p){o&&n.mounted.delete(unique),a&&n.claimed.delete(unique),o&&t.d(p),n.claim.delete(l),n.mount.delete(d),n.destroy.delete(h)}return n.claim.add(l),n.mount.add(d),n.destroy.add(h),{...t,d:h,l:()=>{},m:()=>n.target&&d.apply(null,n.target)}}}return $$self.$$set=r=>{"to"in r&&$$invalidate(0,to=r.to),"unique"in r&&$$invalidate(1,unique=r.unique),"$$scope"in r&&$$invalidate(3,$$scope=r.$$scope)},$$self.$$.update=()=>{$$self.$$.dirty&5&&(realm[to]||$$invalidate(2,realm[to]=initRealm(),realm))},[to,unique,realm,$$scope,slots]}class Portal extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$6,create_fragment$5,safe_not_equal,{to:0,unique:1})}}function minmax(r,e,t,n){return r<e?n??e:r>t?n??t:r}const{Map:Map_1,window:window_1}=globals,get_default_slot_changes_1=r=>({item:r[0]&2048}),get_default_slot_context_1=r=>({item:r[11].data,index:NaN});function get_each_context(r,e,t){const n=r.slice();return n[52]=e[t],n[54]=t,n}const get_default_slot_changes$1=r=>({item:r[0]&16384,index:r[0]&16640}),get_default_slot_context$1=r=>({item:r[52],index:r[8]+r[54]});function create_each_block(r,e){let t,n,o,a;const l=e[40].default,d=create_slot(l,e,e[42],get_default_slot_context$1);return{key:r,first:null,c(){t=element("div"),d&&d.c(),n=space(),this.h()},l(h){t=claim_element(h,"DIV",{draggable:!0,style:!0});var p=children(t);d&&d.l(p),n=claim_space(p),p.forEach(detach),this.h()},h(){var h,p;attr(t,"draggable",o=e[2]&&e[1](e[52])!=null?"true":void 0),set_style(t,"overflow-anchor","none"),toggle_class(t,"invisible",((h=e[11])==null?void 0:h.owner)===e[3]&&((p=e[11])==null?void 0:p.key)===e[1](e[52])),this.first=t},m(h,p){insert_hydration(h,t,p),d&&d.m(t,null),append_hydration(t,n),a=!0},p(h,p){var m,E;e=h,d&&d.p&&(!a||p[0]&16640|p[1]&2048)&&update_slot_base(d,l,e,e[42],a?get_slot_changes(l,e[42],p,get_default_slot_changes$1):get_all_dirty_from_scope(e[42]),get_default_slot_context$1),(!a||p[0]&16390&&o!==(o=e[2]&&e[1](e[52])!=null?"true":void 0))&&attr(t,"draggable",o),(!a||p[0]&18442)&&toggle_class(t,"invisible",((m=e[11])==null?void 0:m.owner)===e[3]&&((E=e[11])==null?void 0:E.key)===e[1](e[52]))},i(h){a||(transition_in(d,h),a=!0)},o(h){transition_out(d,h),a=!1},d(h){h&&detach(t),d&&d.d(h)}}}function create_if_block$3(r){let e,t;return e=new Portal({props:{to:"overlay",$$slots:{default:[create_default_slot$1]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,o){mount_component(e,n,o),t=!0},p(n,o){const a={};o[0]&2297|o[1]&2048&&(a.$$scope={dirty:o,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}function create_if_block_1$2(r){let e,t=`translate3d(
          ${r[11].back?r[11].back.x:r[7].x+Math.max(r[11].offset.x,-r[4].width/r[6]+r[0])}px,
          ${r[11].back?r[11].back.y:r[7].y+Math.max(r[11].offset.y,-r[5]+r[0])}px, 0)`,n=`${r[4].width/r[6]-r[0]}px`,o=`${r[5]-r[0]}px`,a;const l=r[40].default,d=create_slot(l,r,r[42],get_default_slot_context_1);return{c(){e=element("div"),d&&d.c(),this.h()},l(h){e=claim_element(h,"DIV",{class:!0});var p=children(e);d&&d.l(p),p.forEach(detach),this.h()},h(){attr(e,"class","absolute will-change-transform contain-[size_layout]"),toggle_class(e,"transition-transform",r[11].back),set_style(e,"transform",t),set_style(e,"width",n),set_style(e,"height",o)},m(h,p){insert_hydration(h,e,p),d&&d.m(e,null),a=!0},p(h,p){d&&d.p&&(!a||p[0]&2048|p[1]&2048)&&update_slot_base(d,l,h,h[42],a?get_slot_changes(l,h[42],p,get_default_slot_changes_1):get_all_dirty_from_scope(h[42]),get_default_slot_context_1),(!a||p[0]&2048)&&toggle_class(e,"transition-transform",h[11].back),p[0]&2289&&t!==(t=`translate3d(
          ${h[11].back?h[11].back.x:h[7].x+Math.max(h[11].offset.x,-h[4].width/h[6]+h[0])}px,
          ${h[11].back?h[11].back.y:h[7].y+Math.max(h[11].offset.y,-h[5]+h[0])}px, 0)`)&&set_style(e,"transform",t),p[0]&81&&n!==(n=`${h[4].width/h[6]-h[0]}px`)&&set_style(e,"width",n),p[0]&33&&o!==(o=`${h[5]-h[0]}px`)&&set_style(e,"height",o)},i(h){a||(transition_in(d,h),a=!0)},o(h){transition_out(d,h),a=!1},d(h){h&&detach(e),d&&d.d(h)}}}function create_default_slot$1(r){var o;let e,t,n=((o=r[11])==null?void 0:o.owner)===r[3]&&create_if_block_1$2(r);return{c(){n&&n.c(),e=empty$1()},l(a){n&&n.l(a),e=empty$1()},m(a,l){n&&n.m(a,l),insert_hydration(a,e,l),t=!0},p(a,l){var d;((d=a[11])==null?void 0:d.owner)===a[3]?n?(n.p(a,l),l[0]&2056&&transition_in(n,1)):(n=create_if_block_1$2(a),n.c(),transition_in(n,1),n.m(e.parentNode,e)):n&&(group_outros(),transition_out(n,1,1,()=>{n=null}),check_outros())},i(a){t||(transition_in(n),t=!0)},o(a){transition_out(n),t=!1},d(a){a&&detach(e),n&&n.d(a)}}}function create_fragment$4(r){let e,t,n=[],o=new Map_1,a=`translate3d(0,${Math.ceil(r[8]/r[6])*r[5]}px,0)`,l=`${r[0]}px`,d,h=`${r[10]}px`,p,m,E,k=ensure_array_like(r[14]);const L=y=>y[12][(y[8]+y[54])%y[9]]??y[54];for(let y=0;y<k.length;y+=1){let w=get_each_context(r,k,y),b=L(w);o.set(b,n[y]=create_each_block(b,w))}let S=r[2]&&create_if_block$3(r);return{c(){e=element("div"),t=element("div");for(let y=0;y<n.length;y+=1)n[y].c();d=space(),S&&S.c(),this.h()},l(y){e=claim_element(y,"DIV",{class:!0});var w=children(e);t=claim_element(w,"DIV",{class:!0});var b=children(t);for(let _=0;_<n.length;_+=1)n[_].l(b);b.forEach(detach),d=claim_space(w),S&&S.l(w),w.forEach(detach),this.h()},h(){attr(t,"class","grid auto-rows-max will-change-transform contain-layout"),toggle_class(t,"pointer-events-none",!!r[11]),set_style(t,"transform",a),set_style(t,"grid-template-columns",r[13]),set_style(t,"gap",l),attr(e,"class","shrink-0 contain-[size_layout]"),set_style(e,"height",h)},m(y,w){insert_hydration(y,e,w),append_hydration(e,t);for(let b=0;b<n.length;b+=1)n[b]&&n[b].m(t,null);r[41](t),append_hydration(e,d),S&&S.m(e,null),p=!0,m||(E=[listen(window_1,"dragstart",r[15]),listen(window_1,"dragend",r[16]),action_destroyer(drag.call(null,t,"hold")),action_destroyer(hold.call(null,t))],m=!0)},p(y,w){w[0]&23310|w[1]&2048&&(k=ensure_array_like(y[14]),group_outros(),n=update_keyed_each(n,w,L,1,y,k,o,t,outro_and_destroy_block,create_each_block,null,get_each_context),check_outros()),(!p||w[0]&2048)&&toggle_class(t,"pointer-events-none",!!y[11]),w[0]&352&&a!==(a=`translate3d(0,${Math.ceil(y[8]/y[6])*y[5]}px,0)`)&&set_style(t,"transform",a),w[0]&8192&&set_style(t,"grid-template-columns",y[13]),w[0]&1&&l!==(l=`${y[0]}px`)&&set_style(t,"gap",l),y[2]?S?(S.p(y,w),w[0]&4&&transition_in(S,1)):(S=create_if_block$3(y),S.c(),transition_in(S,1),S.m(e,null)):S&&(group_outros(),transition_out(S,1,1,()=>{S=null}),check_outros()),w[0]&1024&&h!==(h=`${y[10]}px`)&&set_style(e,"height",h)},i(y){if(!p){for(let w=0;w<k.length;w+=1)transition_in(n[w]);transition_in(S),p=!0}},o(y){for(let w=0;w<n.length;w+=1)transition_out(n[w]);transition_out(S),p=!1},d(y){y&&detach(e);for(let w=0;w<n.length;w+=1)n[w].d();r[41](null),S&&S.d(),m=!1,run_all(E)}}}let transfer=writable(null);function instance$5(r,e,t){let n,o,a,l,d,h,p,m,E,k,L,S,y,w,b,_,C,A,G,I;component_subscribe(r,transfer,V=>t(11,I=V));let{$$slots:F={},$$scope:fe}=e;const $=createEventDispatcher();let{gap:H=0}=e,{items:Q}=e,{move:te=!1}=e,{fixed:ue=!1}=e,{overthrow:X=1}=e,{prerender:be=1}=e,{columns:Re=1}=e,{key:M=V=>V}=e,{animate:ne=!1}=e,{sortable:we=!1}=e,{container:Oe=void 0}=e,le=null,Ze={x:0,y:0},ut=new DOMRect,et=new DOMRect,$t=!0,Vt=1,J=0,Ee=0;function Yn(V){!k&&V.length&&tick().then(Ie);const pe=new Map,Se=Array.from({length:m}),Ae=new Set(E);for(let qe=0;qe<V.length;qe++){const ur=M(V[qe]);if(ur==null||(pe.set(ur,qe),qe<d||qe>=h))continue;const ht=k==null?void 0:k.get(ur);if(ht==null||ht<d||ht>=h||(Se[qe%m]=E[ht%m],Ae.delete(E[ht%m]),ht===qe||!ne)||(I==null?void 0:I.owner)===le&&ur===(I==null?void 0:I.key))continue;const $i=~~(ht/J)-~~(qe/J),Vi=~~(ht%J)-~~(qe%J);Wr(ht,Vi,$i)}const Ve=[...Ae];return t(12,E=Se.map(qe=>qe??Ve.shift())),pe}function Wr(V,pe,Se){const Ae=le==null?void 0:le.children.item(V-d),Ve=[`translate3d(${pe*100}%,${Se*100}%,0)`,"translate3d(0,0,0)"];Ae==null||Ae.animate({transform:Ve,zIndex:["100","100"]},{easing:"ease",composite:"accumulate",duration:L})}function Ie(){var Ae;if(!Oe||!le)return;t(4,et=(Ae=le.parentElement)==null?void 0:Ae.getBoundingClientRect()),t(26,ut=Oe.getBoundingClientRect()),t(4,et.y+=Ze.y,et),t(28,Ee=et.y-ut.y-ut.height/2),t(4,et.width+=H,et);const V=le.firstElementChild;if(!V)return;const{width:pe,height:Se}=V.getBoundingClientRect();!pe||!Se||(t(6,J=~~(et.width/(pe+H))),t(5,Vt=Se+H))}let Pe,St,se={x:0,y:0};async function Zn({target:V}){if(Ie(),await tick(),!we||!le||!V||I||V.parentElement!==le||Q[G]==null||M(Q[G])==null)return;St=G,Pe=te?-1:St;const pe=V.getBoundingClientRect();pe.x-=se.x,pe.y-=se.y,set_store_value(transfer,I={group:we===!0?le:we,key:M(Q[G]),data:Q[G],owner:le,offset:pe},I)}function mt(V,pe=!1){if(!we||!I||ue||M(Q[V])==null)return;if(!Number.isInteger(V)){Pe!=null&&I.owner!==le&&(mt(Pe,!0),Pe=void 0);return}if(M(Q[V])===I.key)return;V<0&&!Q.length&&(V=0);const Se=Q.findIndex(Ae=>M(Ae)===(I==null?void 0:I.key));Se!==V&&(!pe&&Pe==null&&(Pe=Se,St=Se),~Se&&Q.splice(Se,1),~V&&Q.splice(V,0,I.data),requestAnimationFrame(()=>t(17,Q))),!pe&&le&&set_store_value(transfer,I.owner=le,I)}async function Ui(){if(!we||!I||St==null)return;const V=Q.findIndex(pe=>M(pe)===(I==null?void 0:I.key));if(I.owner===le&&~V){const pe=le.children.item(V-d);pe&&(set_store_value(transfer,I.back=pe.getBoundingClientRect(),I),set_store_value(transfer,I.group=Math.random().toString(),I),await new Promise(Se=>setTimeout(Se,150)))}if(St!==V){const pe=I.data,Se=Q[V-1],Ae=(+!!~St<<1)+ +!!~V,Ve=[void 0,"push","purge","rearrange"][Ae];Ve&&$("edit",{action:Ve,index:V,after:Se,item:pe})}St=void 0,Pe=void 0,I.owner===le&&set_store_value(transfer,I=null,I)}onMount(()=>{function V(Ae){const Ve=Ae.currentTarget;t(25,Ze.x=Ve.scrollLeft,Ze),t(25,Ze.y=Ve.scrollTop,Ze)}Oe||t(18,Oe=getScrollParent(le));const pe=we&&position$1.subscribe(Ae=>t(7,se=Ae));Oe.addEventListener("scroll",V,{passive:!0}),Oe.addEventListener("resize",Ie);const{destroy:Se}=resize(Oe);return t(27,$t=!1),()=>{Oe==null||Oe.removeEventListener("scroll",V),Oe==null||Oe.removeEventListener("resize",Ie),pe&&pe(),Se()}});function Dr(V){binding_callbacks[V?"unshift":"push"](()=>{le=V,t(3,le)})}return r.$$set=V=>{"gap"in V&&t(0,H=V.gap),"items"in V&&t(17,Q=V.items),"move"in V&&t(19,te=V.move),"fixed"in V&&t(20,ue=V.fixed),"overthrow"in V&&t(21,X=V.overthrow),"prerender"in V&&t(22,be=V.prerender),"columns"in V&&t(23,Re=V.columns),"key"in V&&t(1,M=V.key),"animate"in V&&t(24,ne=V.animate),"sortable"in V&&t(2,we=V.sortable),"container"in V&&t(18,Oe=V.container),"$$scope"in V&&t(42,fe=V.$$scope)},r.$$.update=()=>{r.$$.dirty[0]&67108960&&t(38,n=Math.ceil(ut.height/Vt)*J),r.$$.dirty[0]&96|r.$$.dirty[1]&128&&t(39,o=n/J*Vt),r.$$.dirty[0]&131072|r.$$.dirty[1]&128&&t(36,a=Math.max(Math.ceil(Q.length/n)-2,1)),r.$$.dirty[0]&301989888|r.$$.dirty[1]&288&&t(37,l=minmax(~~((Ze.y-Ee)/o),1,a)),r.$$.dirty[0]&2097152|r.$$.dirty[1]&192&&t(8,d=Math.max(l-X,0)*n),r.$$.dirty[0]&6291456|r.$$.dirty[1]&192&&t(35,h=Math.max((l+X+1)*n,be)),r.$$.dirty[0]&131328|r.$$.dirty[1]&16&&t(14,p=Q.slice(d,h)),r.$$.dirty[0]&2097152|r.$$.dirty[1]&128&&t(9,m=(X*2+1)*n),r.$$.dirty[0]&512&&t(12,E=Array.from({length:m}).map((V,pe)=>pe)),r.$$.dirty[0]&131072&&(k=Yn(Q)),r.$$.dirty[0]&16777216&&(L=ne===!0?300:ne||0),r.$$.dirty[0]&131169&&t(10,S=Math.ceil(Q.length/J)*Vt-H),r.$$.dirty[0]&8388608&&t(13,y=Number.isInteger(Re)?`repeat(${Re},1fr)`:`repeat(auto-fill,minmax(min(100%,${Re}),1fr))`),r.$$.dirty[0]&1024&&Number.isFinite(S)&&(requestAnimationFrame(Ie),t(27,$t=!1)),r.$$.dirty[0]&134217728|r.$$.dirty[1]&96&&!$t&&l===a&&($("end"),t(27,$t=!0)),r.$$.dirty[0]&12&&t(30,w=we===!0?le:we),r.$$.dirty[0]&100663441&&t(34,b=minmax(se.y+H/2,ut.top,ut.bottom,NaN)+Ze.y-et.y),r.$$.dirty[0]&33554577&&t(33,_=minmax(se.x+H/2,et.left,et.right-H-1,NaN)+Ze.x-et.x),r.$$.dirty[0]&32|r.$$.dirty[1]&8&&t(32,C=Math.floor(b/Vt)),r.$$.dirty[0]&80|r.$$.dirty[1]&4&&t(31,A=Math.floor(_/(et.width/J))),r.$$.dirty[0]&131136|r.$$.dirty[1]&3&&t(29,G=minmax(C*J+A,0,Q.length-1)),r.$$.dirty[0]&1610614784&&(I==null?void 0:I.group)===w&&mt(G)},[H,M,we,le,et,Vt,J,se,d,m,S,I,E,y,p,Zn,Ui,Q,Oe,te,ue,X,be,Re,ne,Ze,ut,$t,Ee,G,w,A,C,_,b,h,a,l,n,o,F,Dr,fe]}class Virtual extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$5,create_fragment$4,safe_not_equal,{gap:0,items:17,move:19,fixed:20,overthrow:21,prerender:22,columns:23,key:1,animate:24,sortable:2,container:18},null,[-1,-1])}}const get_after_slot_changes=r=>({}),get_after_slot_context=r=>({}),get_before_slot_changes=r=>({}),get_before_slot_context=r=>({});function create_if_block_1$1(r){let e,t;const n=r[9].before,o=create_slot(n,r,r[8],get_before_slot_context);return{c(){e=element("div"),o&&o.c(),this.h()},l(a){e=claim_element(a,"DIV",{class:!0});var l=children(e);o&&o.l(l),l.forEach(detach),this.h()},h(){attr(e,"class","z-20 flex items-center")},m(a,l){insert_hydration(a,e,l),o&&o.m(e,null),t=!0},p(a,l){o&&o.p&&(!t||l&256)&&update_slot_base(o,n,a,a[8],t?get_slot_changes(n,a[8],l,get_before_slot_changes):get_all_dirty_from_scope(a[8]),get_before_slot_context)},i(a){t||(transition_in(o,a),t=!0)},o(a){transition_out(o,a),t=!1},d(a){a&&detach(e),o&&o.d(a)}}}function create_if_block$2(r){let e;return{c(){e=element("hr"),this.h()},l(t){e=claim_element(t,"HR",{"aria-hidden":!0,class:!0}),this.h()},h(){attr(e,"aria-hidden",""),attr(e,"class","absolute bottom-0 h-[1px] w-full border-none bg-content/10 group-last-of-type:opacity-0")},m(t,n){insert_hydration(t,e,n)},d(t){t&&detach(e)}}}function create_dynamic_element(r){let e,t,n,o,a,l,d,h,p,m,E,k,L,S,y,w,b,_,C,A,G,I,F,fe,$=r[7].before&&create_if_block_1$1(r);const H=r[9].default,Q=create_slot(H,r,r[8],null);let te=r[2]&&(r[1]||r[0])&&create_if_block$2();S=new Icon({props:{name:"circle"}}),b=new Icon({props:{name:"target"}});const ue=r[9].after,X=create_slot(ue,r,r[8],get_after_slot_context);let be=[{role:A=r[5]?"link":"button"},{tabindex:"0"},{href:r[5]},{draggable:"false"},{class:G="group relative z-10 flex w-full items-center gap-4 overflow-hidden px-4 outline-2 -outline-offset-2 outline-primary-600 contain-inline-size focus-visible:outline "+(r[4]?"cursor-pointer touch-manipulation select-none "+(r[2]?"":"transition-transform active:scale-95"):"")+" "+(r[0]?"focus-visible:z-50":r[1]?"rounded-lg py-1 focus-visible:z-50":"rounded-2xl py-4")+" "+(r[2]?"bg-surface":"bg-surface-100 shadow-[0_0_20px_-4px] shadow-black/20 dark:shadow-none")}],Re={};for(let M=0;M<be.length;M+=1)Re=assign$1(Re,be[M]);return{c(){e=element(r[4]?r[5]?"a":"button":"article"),t=element("div"),n=space(),o=element("div"),l=space(),$&&$.c(),d=space(),h=element("div"),Q&&Q.c(),p=space(),te&&te.c(),E=space(),k=element("div"),L=element("div"),create_component(S.$$.fragment),y=space(),w=element("div"),create_component(b.$$.fragment),_=space(),C=element("div"),X&&X.c(),this.h()},l(M){e=claim_element(M,((r[4]?r[5]?"a":"button":"article")||"null").toUpperCase(),{role:!0,tabindex:!0,href:!0,draggable:!0,class:!0});var ne=children(e);t=claim_element(ne,"DIV",{"aria-hidden":!0,class:!0}),children(t).forEach(detach),n=claim_space(ne),o=claim_element(ne,"DIV",{"aria-hidden":!0,class:!0}),children(o).forEach(detach),l=claim_space(ne),$&&$.l(ne),d=claim_space(ne),h=claim_element(ne,"DIV",{class:!0});var we=children(h);Q&&Q.l(we),p=claim_space(we),te&&te.l(we),we.forEach(detach),E=claim_space(ne),k=claim_element(ne,"DIV",{class:!0});var Oe=children(k);L=claim_element(Oe,"DIV",{class:!0});var le=children(L);claim_component(S.$$.fragment,le),le.forEach(detach),y=claim_space(Oe),w=claim_element(Oe,"DIV",{class:!0});var Ze=children(w);claim_component(b.$$.fragment,Ze),Ze.forEach(detach),_=claim_space(Oe),C=claim_element(Oe,"DIV",{class:!0});var ut=children(C);X&&X.l(ut),ut.forEach(detach),Oe.forEach(detach),ne.forEach(detach),this.h()},h(){attr(t,"aria-hidden",""),attr(t,"class","pointer-events-none absolute inset-0 -z-10 bg-primary-200/30 opacity-0 transition-opacity"),toggle_class(t,"opacity-100",r[6]===!0),attr(o,"aria-hidden",""),attr(o,"class",a="pointer-events-none absolute inset-0 z-0 bg-highlight opacity-0 "+(r[4]?"group-hover:opacity-30 "+(r[2]?"dark:group-hover:opacity-50":"dark:group-hover:opacity-10"):"")),attr(h,"class",m="z-10 grid w-full grid-cols-1 items-baseline overflow-hidden contain-inline-size "+(r[1]||r[0]?"justify-start gap-0.5":"place-items-center justify-center gap-2")+" "+((r[1]||r[0])&&r[3]?"lg:auto-cols-fr lg:grid-flow-col lg:gap-4":"")),attr(L,"class","flex justify-center text-primary-600 opacity-0 transition-opacity"),toggle_class(L,"opacity-100",r[6]),attr(w,"class","flex scale-0 justify-center text-primary-600 transition-transform"),toggle_class(w,"scale-100",r[6]===!0),attr(C,"class","opacity-0 transition-opacity"),toggle_class(C,"opacity-100",!r[6]),attr(k,"class","z-20 grid items-center [&>*]:col-start-1 [&>*]:row-start-1"),set_dynamic_element_data(r[4]?r[5]?"a":"button":"article")(e,Re)},m(M,ne){insert_hydration(M,e,ne),append_hydration(e,t),append_hydration(e,n),append_hydration(e,o),append_hydration(e,l),$&&$.m(e,null),append_hydration(e,d),append_hydration(e,h),Q&&Q.m(h,null),append_hydration(h,p),te&&te.m(h,null),append_hydration(e,E),append_hydration(e,k),append_hydration(k,L),mount_component(S,L,null),append_hydration(k,y),append_hydration(k,w),mount_component(b,w,null),append_hydration(k,_),append_hydration(k,C),X&&X.m(C,null),I=!0,F||(fe=[listen(e,"click",r[10]),listen(e,"contextmenu",r[11])],F=!0)},p(M,ne){(!I||ne&64)&&toggle_class(t,"opacity-100",M[6]===!0),(!I||ne&20&&a!==(a="pointer-events-none absolute inset-0 z-0 bg-highlight opacity-0 "+(M[4]?"group-hover:opacity-30 "+(M[2]?"dark:group-hover:opacity-50":"dark:group-hover:opacity-10"):"")))&&attr(o,"class",a),M[7].before?$?($.p(M,ne),ne&128&&transition_in($,1)):($=create_if_block_1$1(M),$.c(),transition_in($,1),$.m(e,d)):$&&(group_outros(),transition_out($,1,1,()=>{$=null}),check_outros()),Q&&Q.p&&(!I||ne&256)&&update_slot_base(Q,H,M,M[8],I?get_slot_changes(H,M[8],ne,null):get_all_dirty_from_scope(M[8]),null),M[2]&&(M[1]||M[0])?te||(te=create_if_block$2(),te.c(),te.m(h,null)):te&&(te.d(1),te=null),(!I||ne&11&&m!==(m="z-10 grid w-full grid-cols-1 items-baseline overflow-hidden contain-inline-size "+(M[1]||M[0]?"justify-start gap-0.5":"place-items-center justify-center gap-2")+" "+((M[1]||M[0])&&M[3]?"lg:auto-cols-fr lg:grid-flow-col lg:gap-4":"")))&&attr(h,"class",m),(!I||ne&64)&&toggle_class(L,"opacity-100",M[6]),(!I||ne&64)&&toggle_class(w,"scale-100",M[6]===!0),X&&X.p&&(!I||ne&256)&&update_slot_base(X,ue,M,M[8],I?get_slot_changes(ue,M[8],ne,get_after_slot_changes):get_all_dirty_from_scope(M[8]),get_after_slot_context),(!I||ne&64)&&toggle_class(C,"opacity-100",!M[6]),set_dynamic_element_data(M[4]?M[5]?"a":"button":"article")(e,Re=get_spread_update(be,[(!I||ne&32&&A!==(A=M[5]?"link":"button"))&&{role:A},{tabindex:"0"},(!I||ne&32)&&{href:M[5]},{draggable:"false"},(!I||ne&23&&G!==(G="group relative z-10 flex w-full items-center gap-4 overflow-hidden px-4 outline-2 -outline-offset-2 outline-primary-600 contain-inline-size focus-visible:outline "+(M[4]?"cursor-pointer touch-manipulation select-none "+(M[2]?"":"transition-transform active:scale-95"):"")+" "+(M[0]?"focus-visible:z-50":M[1]?"rounded-lg py-1 focus-visible:z-50":"rounded-2xl py-4")+" "+(M[2]?"bg-surface":"bg-surface-100 shadow-[0_0_20px_-4px] shadow-black/20 dark:shadow-none")))&&{class:G}]))},i(M){I||(transition_in($),transition_in(Q,M),transition_in(S.$$.fragment,M),transition_in(b.$$.fragment,M),transition_in(X,M),I=!0)},o(M){transition_out($),transition_out(Q,M),transition_out(S.$$.fragment,M),transition_out(b.$$.fragment,M),transition_out(X,M),I=!1},d(M){M&&detach(e),$&&$.d(),Q&&Q.d(M),te&&te.d(),destroy_component(S),destroy_component(b),X&&X.d(M),F=!1,run_all(fe)}}}function create_fragment$3(r){let e=r[4]?r[5]?"a":"button":"article",t,n,o=(r[4]?r[5]?"a":"button":"article")&&create_dynamic_element(r);return{c(){o&&o.c(),t=empty$1()},l(a){o&&o.l(a),t=empty$1()},m(a,l){o&&o.m(a,l),insert_hydration(a,t,l),n=!0},p(a,[l]){!a[4]||a[5],e?safe_not_equal(e,a[4]?a[5]?"a":"button":"article")?(o.d(1),o=create_dynamic_element(a),e=a[4]?a[5]?"a":"button":"article",o.c(),o.m(t.parentNode,t)):o.p(a,l):(o=create_dynamic_element(a),e=a[4]?a[5]?"a":"button":"article",o.c(),o.m(t.parentNode,t))},i(a){n||(transition_in(o,a),n=!0)},o(a){transition_out(o,a),n=!1},d(a){a&&detach(t),o&&o.d(a)}}}function instance$4(r,e,t){let{$$slots:n={},$$scope:o}=e;const a=compute_slots(n);let{xs:l=!1}=e,{sm:d=!1}=e,{flat:h=!1}=e,{flow:p=!1}=e,{interactive:m=!1}=e,{href:E=void 0}=e,{selected:k=!1}=e;function L(y){bubble.call(this,r,y)}function S(y){bubble.call(this,r,y)}return r.$$set=y=>{"xs"in y&&t(0,l=y.xs),"sm"in y&&t(1,d=y.sm),"flat"in y&&t(2,h=y.flat),"flow"in y&&t(3,p=y.flow),"interactive"in y&&t(4,m=y.interactive),"href"in y&&t(5,E=y.href),"selected"in y&&t(6,k=y.selected),"$$scope"in y&&t(8,o=y.$$scope)},[l,d,h,p,m,E,k,a,o,n,L,S]}class Card extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$4,create_fragment$3,safe_not_equal,{xs:0,sm:1,flat:2,flow:3,interactive:4,href:5,selected:6})}}function create_fragment$2(r){let e,t,n;const o=r[6].default,a=create_slot(o,r,r[5],null);return{c(){e=element("span"),a&&a.c(),this.h()},l(l){e=claim_element(l,"SPAN",{class:!0});var d=children(e);a&&a.l(d),d.forEach(detach),this.h()},h(){attr(e,"class",t="w-max max-w-full overflow-hidden text-ellipsis whitespace-nowrap rounded-md text-left [&>*]:align-bottom "+(r[1]?"animate-pulse bg-highlight text-transparent":"")+" "+(r[2]?"font-medium":"font-normal")),toggle_class(e,"text-content-200",r[0]),toggle_class(e,"ml-4",r[3]),toggle_class(e,"text-sm",r[4])},m(l,d){insert_hydration(l,e,d),a&&a.m(e,null),n=!0},p(l,[d]){a&&a.p&&(!n||d&32)&&update_slot_base(a,o,l,l[5],n?get_slot_changes(o,l[5],d,null):get_all_dirty_from_scope(l[5]),null),(!n||d&6&&t!==(t="w-max max-w-full overflow-hidden text-ellipsis whitespace-nowrap rounded-md text-left [&>*]:align-bottom "+(l[1]?"animate-pulse bg-highlight text-transparent":"")+" "+(l[2]?"font-medium":"font-normal")))&&attr(e,"class",t),(!n||d&7)&&toggle_class(e,"text-content-200",l[0]),(!n||d&14)&&toggle_class(e,"ml-4",l[3]),(!n||d&22)&&toggle_class(e,"text-sm",l[4])},i(l){n||(transition_in(a,l),n=!0)},o(l){transition_out(a,l),n=!1},d(l){l&&detach(e),a&&a.d(l)}}}function instance$3(r,e,t){let{$$slots:n={},$$scope:o}=e,{secondary:a=!1}=e,{loading:l=!1}=e,{accent:d=!1}=e,{indent:h=!1}=e,{sm:p=!1}=e;return r.$$set=m=>{"secondary"in m&&t(0,a=m.secondary),"loading"in m&&t(1,l=m.loading),"accent"in m&&t(2,d=m.accent),"indent"in m&&t(3,h=m.indent),"sm"in m&&t(4,p=m.sm),"$$scope"in m&&t(5,o=m.$$scope)},[a,l,d,h,p,o,n]}class Text extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$3,create_fragment$2,safe_not_equal,{secondary:0,loading:1,accent:2,indent:3,sm:4})}}function create_if_block_1(r){let e;const t=r[7].default,n=create_slot(t,r,r[6],null);return{c(){n&&n.c()},l(o){n&&n.l(o)},m(o,a){n&&n.m(o,a),e=!0},p(o,a){n&&n.p&&(!e||a&64)&&update_slot_base(n,t,o,o[6],e?get_slot_changes(t,o[6],a,null):get_all_dirty_from_scope(o[6]),null)},i(o){e||(transition_in(n,o),e=!0)},o(o){transition_out(n,o),e=!1},d(o){n&&n.d(o)}}}function create_if_block$1(r){let e,t,n,o,a,l;return{c(){e=element("img"),this.h()},l(d){e=claim_element(d,"IMG",{alt:!0,src:!0,class:!0,loading:!0,width:!0,height:!0,draggable:!0}),this.h()},h(){attr(e,"alt",r[3]),src_url_equal(e.src,t=r[2]<100/devicePixelRatio?r[0]:r[1])||attr(e,"src",t),attr(e,"class","opacity-0 transition-opacity duration-500"),attr(e,"loading","lazy"),attr(e,"width",n=r[2]+"px"),attr(e,"height",o=r[2]+"px"),attr(e,"draggable","false"),toggle_class(e,"opacity-100",r[5]==="ok")},m(d,h){insert_hydration(d,e,h),r[8](e),a||(l=[listen(e,"load",r[9]),listen(e,"error",r[10])],a=!0)},p(d,h){h&8&&attr(e,"alt",d[3]),h&7&&!src_url_equal(e.src,t=d[2]<100/devicePixelRatio?d[0]:d[1])&&attr(e,"src",t),h&4&&n!==(n=d[2]+"px")&&attr(e,"width",n),h&4&&o!==(o=d[2]+"px")&&attr(e,"height",o),h&32&&toggle_class(e,"opacity-100",d[5]==="ok")},i:noop$2,o:noop$2,d(d){d&&detach(e),r[8](null),a=!1,run_all(l)}}}function create_fragment$1(r){let e,t,n,o,a=`${r[2]}px`,l=`${r[2]}px`,d;const h=[create_if_block$1,create_if_block_1],p=[];function m(E,k){return E[1]&&E[5]!=="error"?0:E[5]==="error"?1:-1}return~(t=m(r))&&(n=p[t]=h[t](r)),{c(){e=element("div"),n&&n.c(),this.h()},l(E){e=claim_element(E,"DIV",{class:!0});var k=children(e);n&&n.l(k),k.forEach(detach),this.h()},h(){attr(e,"class",o="overflow-hidden "+(r[2]>200?"rounded-2xl":"rounded")+" bg-highlight-100"),toggle_class(e,"animate-pulse",r[5]==="loading"),set_style(e,"height",a),set_style(e,"width",l)},m(E,k){insert_hydration(E,e,k),~t&&p[t].m(e,null),d=!0},p(E,[k]){let L=t;t=m(E),t===L?~t&&p[t].p(E,k):(n&&(group_outros(),transition_out(p[L],1,1,()=>{p[L]=null}),check_outros()),~t?(n=p[t],n?n.p(E,k):(n=p[t]=h[t](E),n.c()),transition_in(n,1),n.m(e,null)):n=null),(!d||k&4&&o!==(o="overflow-hidden "+(E[2]>200?"rounded-2xl":"rounded")+" bg-highlight-100"))&&attr(e,"class",o),(!d||k&36)&&toggle_class(e,"animate-pulse",E[5]==="loading"),k&4&&a!==(a=`${E[2]}px`)&&set_style(e,"height",a),k&4&&l!==(l=`${E[2]}px`)&&set_style(e,"width",l)},i(E){d||(transition_in(n),d=!0)},o(E){transition_out(n),d=!1},d(E){E&&detach(e),~t&&p[t].d()}}}function instance$2(r,e,t){let n,{$$slots:o={},$$scope:a}=e,{thumbnail:l=void 0}=e,{src:d=void 0}=e,{size:h=48}=e,{alt:p=""}=e,m;onMount(()=>(m!=null&&m.complete&&t(4,m.style.opacity="1",m),!1));function E(S){binding_callbacks[S?"unshift":"push"](()=>{m=S,t(4,m)})}const k=()=>t(5,n="ok"),L=()=>t(5,n="error");return r.$$set=S=>{"thumbnail"in S&&t(0,l=S.thumbnail),"src"in S&&t(1,d=S.src),"size"in S&&t(2,h=S.size),"alt"in S&&t(3,p=S.alt),"$$scope"in S&&t(6,a=S.$$scope)},r.$$.update=()=>{r.$$.dirty&2&&t(5,n=d===""||d===null?"error":"loading")},[l,d,h,p,m,n,a,o,E,k,L]}class Image extends SvelteComponent{constructor(e){super(),init$1(this,e,instance$2,create_fragment$1,safe_not_equal,{thumbnail:0,src:1,size:2,alt:3})}}function capitalize(r,e=!0){return r&&(e?r.replace(/\b\w/g,t=>t.toUpperCase()):r.replace(/\b\w/,t=>t.toUpperCase()))}function clean(r){return r.normalize().trim().toLowerCase().replace(/\s+/g," ")}const __vite_glob_0_0=`CREATE TRIGGER IF NOT EXISTS cascade_playlists_library
AFTER DELETE ON playlists
FOR EACH ROW
BEGIN
  DELETE FROM library WHERE playlist = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_library_tracks
AFTER DELETE ON library
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM library 
    WHERE track = OLD.track 
  UNION ALL SELECT 1 FROM playback
    WHERE track = OLD.track
  LIMIT 1
)
BEGIN
  DELETE FROM tracks WHERE id = OLD.track;
END;

CREATE TRIGGER IF NOT EXISTS cascade_playback_tracks
AFTER DELETE ON playback
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM library
    WHERE track = OLD.track
  UNION ALL SELECT 1 FROM playback
    WHERE track = OLD.track
  LIMIT 1
)
BEGIN
  DELETE FROM tracks WHERE id = OLD.track;
END;

CREATE TRIGGER IF NOT EXISTS cascade_tracks_albums
AFTER DELETE ON tracks
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM tracks WHERE album = OLD.album LIMIT 1
)
BEGIN
  DELETE FROM albums WHERE id = OLD.album;
END;

CREATE TRIGGER IF NOT EXISTS cascade_albums_attribution
AFTER DELETE ON albums
FOR EACH ROW
BEGIN
  DELETE FROM attribution WHERE album = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_attribution_artists
AFTER DELETE ON attribution
FOR EACH ROW
WHEN NOT EXISTS (
  SELECT 1 FROM attribution
    WHERE artist = OLD.artist
)
BEGIN
  DELETE FROM artists WHERE id = OLD.artist;
END;

CREATE TRIGGER IF NOT EXISTS cascade_tracks_resources
AFTER DELETE ON tracks
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_albums_resources
AFTER DELETE ON albums
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
  DELETE FROM assets WHERE owner = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS cascade_artists_resources
AFTER DELETE ON artists
FOR EACH ROW
BEGIN
  DELETE FROM sources WHERE owner = OLD.id;
  DELETE FROM assets WHERE owner = OLD.id;
END;
`,__vite_glob_0_1=`CREATE VIRTUAL TABLE IF NOT EXISTS tracks_fts USING fts5 (
  title,
  album,
  artists,
  content='',
  tokenize='trigram'
);

CREATE VIRTUAL TABLE IF NOT EXISTS albums_fts USING fts5 (
  title,
  artists,
  content='',
  tokenize='trigram'
);

CREATE VIRTUAL TABLE IF NOT EXISTS artists_fts USING fts5 (
  title,
  content='',
  tokenize='trigram'
);

---------------------------- Artists Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_artists_insert AFTER INSERT ON artists BEGIN
  -- Update artists index
  INSERT INTO artists_fts(rowid,title) VALUES (NEW.id, NEW.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title,
      CASE WHEN EXISTS (SELECT 1 FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id) THEN albums.title ELSE NULL END,
      (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.id)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS fts_artists_update AFTER UPDATE OF title ON artists WHEN (OLD.title IS NOT NEW.title) BEGIN
  -- Update artists index
  INSERT INTO artists_fts(artists_fts,rowid,title) VALUES ('delete', OLD.id, OLD.title);
  INSERT INTO artists_fts(rowid,title) VALUES (NEW.id, NEW.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(CASE WHEN artists.id = OLD.id THEN OLD.title ELSE title END) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = OLD.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(CASE WHEN artists.id = OLD.id THEN OLD.title ELSE title END) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = OLD.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS fts_artists_delete BEFORE DELETE ON artists BEGIN
  -- Update artists index
  INSERT INTO artists_fts(artists_fts,rowid,title) VALUES ('delete', OLD.id, OLD.title);
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.artist = OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.artist = OLD.id;
END;

---------------------------- Albums Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_albums_insert AFTER INSERT ON albums BEGIN
  -- Update albums index
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT NEW.id, NEW.title, group_concat(artists.title)
    FROM attribution
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE attribution.album = NEW.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, NULL, NULL
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS albums_fts_update AFTER UPDATE OF title ON albums WHEN (OLD.title IS NOT NEW.title) BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', OLD.id, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
    WHERE attribution.album = OLD.id;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT NEW.id, NEW.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
    WHERE attribution.album = OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = OLD.id;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT tracks.id, tracks.title, NEW.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS albums_fts_delete BEFORE DELETE ON albums BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', OLD.id, OLD.title, group_concat(artists.title)
    FROM attribution
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE attribution.album = OLD.id
    GROUP BY OLD.id;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, OLD.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN tracks ON tracks.album = attribution.album
    WHERE attribution.album = OLD.id;
END;

---------------------------- Attribution Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_attribution_insert AFTER INSERT ON attribution
  WHEN EXISTS (SELECT 1 FROM artists WHERE id = NEW.artist) AND EXISTS (SELECT 1 FROM albums WHERE id = NEW.album)
BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist AND artists.id != NEW.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  INSERT INTO albums_fts(rowid,title,artists)
    SELECT albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, NULL, NULL
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT  tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = NEW.album AND attribution.artist = NEW.artist;
END;

CREATE TRIGGER IF NOT EXISTS fts_attribution_delete BEFORE DELETE ON attribution BEGIN
  -- Update albums index
  INSERT INTO albums_fts(albums_fts,rowid,title,artists)
    SELECT 'delete', albums.id, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
    WHERE attribution.album = OLD.album AND attribution.artist = OLD.artist;
  -- Update tracks index
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', tracks.id, tracks.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM attribution
      INNER JOIN albums ON albums.id = attribution.album
      INNER JOIN tracks ON tracks.album = albums.id
    WHERE attribution.album = OLD.album AND attribution.artist = OLD.artist;
END;

---------------------------- Tracks Triggers ----------------------------
CREATE TRIGGER IF NOT EXISTS fts_tracks_insert AFTER INSERT ON tracks BEGIN
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT NEW.id, NEW.title, albums.title, group_concat(artists.title)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE albums.id = NEW.album;
END;

CREATE TRIGGER IF NOT EXISTS fts_tracks_update AFTER UPDATE OF title ON tracks WHEN (OLD.title IS NOT NEW.title) BEGIN
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', OLD.id, OLD.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
    WHERE albums.id = OLD.album;
  INSERT INTO tracks_fts(rowid,title,album,artists)
    SELECT NEW.id, NEW.title, albums.title, (SELECT group_concat(title) FROM artists WHERE artists.id = attribution.artist)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
    WHERE albums.id = NEW.album;
END;

CREATE TRIGGER IF NOT EXISTS fts_tracks_delete BEFORE DELETE ON tracks BEGIN
  INSERT INTO tracks_fts(tracks_fts,rowid,title,album,artists)
    SELECT 'delete', OLD.id, OLD.title, albums.title, group_concat(artists.title)
    FROM albums
      INNER JOIN attribution ON attribution.album = albums.id
      INNER JOIN artists ON artists.id = attribution.artist
    WHERE albums.id = OLD.album
    GROUP BY OLD.id;
END;`,__vite_glob_0_2=`INSERT OR IGNORE INTO devices VALUES (crsql_site_id(), -1, 0, 0, 0, 0);

CREATE VIEW IF NOT EXISTS queue AS
  WITH ordered AS
    (SELECT playback.*, row_number() OVER (
      ORDER BY
        CASE WHEN "direction" != 1 THEN "order" ELSE NULL END ASC,
        CASE WHEN "direction" = 1 THEN "order" ELSE NULL END DESC,
        CASE WHEN "direction" != 1 THEN "playback"."id" ELSE NULL END ASC,
        CASE WHEN "direction" = 1 THEN "playback"."id" ELSE NULL END DESC
    ) as position FROM devices INNER JOIN playback ON playback.device = devices.id
    WHERE devices.id = crsql_site_id())
  SELECT id, device, track, 
    (position - 
      (SELECT position FROM ordered WHERE id = (SELECT playback FROM devices WHERE id = device))
    ) as position
  FROM ordered;

CREATE TRIGGER IF NOT EXISTS playback_started
BEFORE INSERT ON playback
FOR EACH ROW
WHEN NEW.device = crsql_site_id()
BEGIN
  UPDATE devices SET playback = NEW.id WHERE id = NEW.device AND playback IS -1;
END;

CREATE TRIGGER IF NOT EXISTS playback_finised
BEFORE UPDATE OF progress ON devices
FOR EACH ROW
WHEN NEW.progress >= 1 AND NEW.id = crsql_site_id()
BEGIN
  INSERT INTO library SELECT ABS(RANDOM() % 4294967296), -1, track, UNIXEPOCH(), -1 FROM playback WHERE id = NEW.playback;
  UPDATE devices SET 
    playback = CASE WHEN NEW.repeat = 2 AND NOT EXISTS (SELECT 1 FROM queue WHERE position > 0)
      THEN IFNULL((SELECT id FROM queue LIMIT 1), playback)
      WHEN NEW.repeat = 1 THEN playback
      ELSE IFNULL((SELECT id FROM queue WHERE position = 1), playback)
    END,
    progress = 0
  WHERE id = NEW.id;
  SELECT RAISE(IGNORE);
END;

CREATE TRIGGER IF NOT EXISTS playback_backtracked
BEFORE UPDATE OF progress ON devices
FOR EACH ROW
WHEN NEW.progress < 0 AND NEW.id = crsql_site_id()
BEGIN
  UPDATE devices SET 
    playback = IFNULL((SELECT id FROM queue WHERE position = -1), playback),
    progress = 0
  WHERE id = NEW.id;
  SELECT RAISE(IGNORE);
END;

CREATE TRIGGER IF NOT EXISTS playback_shuffled
AFTER UPDATE OF direction ON devices
FOR EACH ROW
WHEN NEW.direction = 2 AND NEW.id = crsql_site_id()
BEGIN
  UPDATE playback SET "temp"="order" WHERE
    (SELECT id FROM queue WHERE position = 0) != id AND device = NEW.id;
  UPDATE playback SET
    "order"=(SELECT "order" FROM playback WHERE "temp" IS NULL)||trim(hex(randomblob(2)),'0')
  WHERE "temp" IS NOT NULL;
END;

CREATE TRIGGER IF NOT EXISTS playback_unshuffled
AFTER UPDATE OF direction ON devices
FOR EACH ROW
WHEN OLD.direction = 2 AND NEW.direction != 2 AND NEW.id = crsql_site_id()
BEGIN
  UPDATE playback SET
    "order"="temp",
    "temp"=NULL
  WHERE "temp" IS NOT NULL AND device = NEW.id;
END;

CREATE TRIGGER IF NOT EXISTS playback_purged
BEFORE DELETE ON playback
FOR EACH ROW
WHEN (OLD.id = (SELECT playback FROM devices WHERE id = crsql_site_id()))
BEGIN
  UPDATE devices SET 
    playback = (SELECT id FROM queue WHERE position = 1),
    progress = 0
  WHERE id = OLD.device;
END;`,__vite_glob_0_3=`INSERT OR IGNORE INTO playlists (id, title, "order", relevancy, shared, remote) VALUES
  (-1, 'Listened', 1, 0, NULL, NULL),
  (-2, 'Recommended', 1, -1, NULL, NULL),
  (-3, 'Blocked', 1, -1, NULL, NULL),
  (-4, 'Followed', 1, 0, NULL, NULL);`,types={boolean:"?",number:"+",string:"'",object:"&",bigint:"^",null:"!","?":"boolean","+":"number","'":"string","^":"bigint","&":"object","!":"null"},encoders={any:r=>{var e;return typeof r in types&&r!=null?types[typeof r]+((e=encoders[typeof r])==null?void 0:e.call(encoders,r))||r.toString():"!"},object:r=>btoa(String.fromCharCode.apply(null,r)),number:r=>r.toString(),string:r=>r.replaceAll(",",",,").replaceAll("*","**"),bigint:r=>r.toString(),boolean:r=>(+r).toString()},decoders={any:r=>{var e;return(e=decoders[types[r[0]]])==null?void 0:e.call(decoders,r.slice(1))},object:r=>Uint8Array.from([...atob(r)].map(e=>e.charCodeAt(0))),number:r=>parseFloat(r),string:r=>r.replaceAll(",,",",").replaceAll("**","*"),bigint:r=>BigInt(r),boolean:r=>!!+r,null:()=>null};function encode$1(r,e){var o;const t=[],n={};for(const a of r)for(const[l,d]of e){const h=encoders[d](a[l]);if(((o=n[l])==null?void 0:o[0])!==h){const p=[h,1];t.push(p),n[l]=p}else n[l][1]+=1}return t.map(([a,l])=>(l>1?"*"+String.fromCharCode(l+43):",")+a).join("")}function decode$1(r,e){const t=[];for(let l=0;l<r.length;){let d=l-1;do d=[",","*"].map(m=>r.indexOf(m,d+2)).filter(m=>~m).reduce((m,E)=>Math.min(m,E),1/0);while(r[d+1]===r[d]&&d!==1/0);let h=r.slice(l,d);const p=h[0]===",";t.push([h.slice(p?1:2),p?1:h.charCodeAt(1)-43]),l=d}const n=t.slice(0,e.length),o=[];let a=e.length;e:for(;;){const l={};for(let d=0;d<e.length;d++){if(!n[d])break e;const[h,p]=e[d];l[h]=decoders[p](n[d][0]),n[d][1]-=1,n[d][1]||(n[d]=t[a++])}o.push(l)}return o}function chunk(r,{size:e=1e3,strict:t=!0}={}){var o;if(r.length<=e)return[r];const n=[];for(let a=0;a<r.length;){const l=r[a].db_version,d=(o=r[a+e])==null?void 0:o.db_version,h=m=>m.db_version===d;let p=1/0;l===d?t?p=a+e:p=r.findLastIndex(h,a+e)+1:d!=null&&(p=r.findIndex(h,a)),n.push(r.slice(a,p)),a=p}return n}function isUndefined(r){return typeof r>"u"||r===void 0}function isString(r){return typeof r=="string"}function isNumber(r){return typeof r=="number"}function isBoolean(r){return typeof r=="boolean"}function isNull(r){return r===null}function isDate(r){return r instanceof Date}function isBigInt(r){return typeof r=="bigint"}function isFunction(r){return typeof r=="function"}function isObject$3(r){return typeof r=="object"&&r!==null}function freeze(r){return Object.freeze(r)}function asArray(r){return isReadonlyArray(r)?r:[r]}function isReadonlyArray(r){return Array.isArray(r)}function noop$1(r){return r}const AlterTableNode=freeze({is(r){return r.kind==="AlterTableNode"},create(r){return freeze({kind:"AlterTableNode",table:r})},cloneWithTableProps(r,e){return freeze({...r,...e})},cloneWithColumnAlteration(r,e){return freeze({...r,columnAlterations:r.columnAlterations?[...r.columnAlterations,e]:[e]})}}),IdentifierNode=freeze({is(r){return r.kind==="IdentifierNode"},create(r){return freeze({kind:"IdentifierNode",name:r})}}),CreateIndexNode=freeze({is(r){return r.kind==="CreateIndexNode"},create(r){return freeze({kind:"CreateIndexNode",name:IdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})},cloneWithColumns(r,e){return freeze({...r,columns:[...r.columns||[],...e]})}}),CreateSchemaNode=freeze({is(r){return r.kind==="CreateSchemaNode"},create(r,e){return freeze({kind:"CreateSchemaNode",schema:IdentifierNode.create(r),...e})},cloneWith(r,e){return freeze({...r,...e})}}),ON_COMMIT_ACTIONS=["preserve rows","delete rows","drop"],CreateTableNode=freeze({is(r){return r.kind==="CreateTableNode"},create(r){return freeze({kind:"CreateTableNode",table:r,columns:freeze([])})},cloneWithColumn(r,e){return freeze({...r,columns:freeze([...r.columns,e])})},cloneWithConstraint(r,e){return freeze({...r,constraints:r.constraints?freeze([...r.constraints,e]):freeze([e])})},cloneWithFrontModifier(r,e){return freeze({...r,frontModifiers:r.frontModifiers?freeze([...r.frontModifiers,e]):freeze([e])})},cloneWithEndModifier(r,e){return freeze({...r,endModifiers:r.endModifiers?freeze([...r.endModifiers,e]):freeze([e])})},cloneWith(r,e){return freeze({...r,...e})}}),SchemableIdentifierNode=freeze({is(r){return r.kind==="SchemableIdentifierNode"},create(r){return freeze({kind:"SchemableIdentifierNode",identifier:IdentifierNode.create(r)})},createWithSchema(r,e){return freeze({kind:"SchemableIdentifierNode",schema:IdentifierNode.create(r),identifier:IdentifierNode.create(e)})}}),DropIndexNode=freeze({is(r){return r.kind==="DropIndexNode"},create(r,e){return freeze({kind:"DropIndexNode",name:SchemableIdentifierNode.create(r),...e})},cloneWith(r,e){return freeze({...r,...e})}}),DropSchemaNode=freeze({is(r){return r.kind==="DropSchemaNode"},create(r,e){return freeze({kind:"DropSchemaNode",schema:IdentifierNode.create(r),...e})},cloneWith(r,e){return freeze({...r,...e})}}),DropTableNode=freeze({is(r){return r.kind==="DropTableNode"},create(r,e){return freeze({kind:"DropTableNode",table:r,...e})},cloneWith(r,e){return freeze({...r,...e})}}),AliasNode=freeze({is(r){return r.kind==="AliasNode"},create(r,e){return freeze({kind:"AliasNode",node:r,alias:e})}}),TableNode=freeze({is(r){return r.kind==="TableNode"},create(r){return freeze({kind:"TableNode",table:SchemableIdentifierNode.create(r)})},createWithSchema(r,e){return freeze({kind:"TableNode",table:SchemableIdentifierNode.createWithSchema(r,e)})}});function isOperationNodeSource(r){return isObject$3(r)&&isFunction(r.toOperationNode)}function isExpression(r){return isObject$3(r)&&"expressionType"in r&&isOperationNodeSource(r)}function isAliasedExpression(r){return isObject$3(r)&&"expression"in r&&isString(r.alias)&&isOperationNodeSource(r)}const SelectModifierNode=freeze({is(r){return r.kind==="SelectModifierNode"},create(r,e){return freeze({kind:"SelectModifierNode",modifier:r,of:e})},createWithExpression(r){return freeze({kind:"SelectModifierNode",rawModifier:r})}}),AndNode=freeze({is(r){return r.kind==="AndNode"},create(r,e){return freeze({kind:"AndNode",left:r,right:e})}}),OrNode=freeze({is(r){return r.kind==="OrNode"},create(r,e){return freeze({kind:"OrNode",left:r,right:e})}}),OnNode=freeze({is(r){return r.kind==="OnNode"},create(r){return freeze({kind:"OnNode",on:r})},cloneWithOperation(r,e,t){return freeze({...r,on:e==="And"?AndNode.create(r.on,t):OrNode.create(r.on,t)})}}),JoinNode=freeze({is(r){return r.kind==="JoinNode"},create(r,e){return freeze({kind:"JoinNode",joinType:r,table:e,on:void 0})},createWithOn(r,e,t){return freeze({kind:"JoinNode",joinType:r,table:e,on:OnNode.create(t)})},cloneWithOn(r,e){return freeze({...r,on:r.on?OnNode.cloneWithOperation(r.on,"And",e):OnNode.create(e)})}}),BinaryOperationNode=freeze({is(r){return r.kind==="BinaryOperationNode"},create(r,e,t){return freeze({kind:"BinaryOperationNode",leftOperand:r,operator:e,rightOperand:t})}}),COMPARISON_OPERATORS=["=","==","!=","<>",">",">=","<","<=","in","not in","is","is not","like","not like","match","ilike","not ilike","@>","<@","&&","?","?&","!<","!>","<=>","!~","~","~*","!~*","@@","@@@","!!","<->","regexp","is distinct from","is not distinct from"],ARITHMETIC_OPERATORS=["+","-","*","/","%","^","&","|","#","<<",">>"],JSON_OPERATORS=["->","->>"],BINARY_OPERATORS=[...COMPARISON_OPERATORS,...ARITHMETIC_OPERATORS,"&&","||"],UNARY_FILTER_OPERATORS=["exists","not exists"],UNARY_OPERATORS=["not","-",...UNARY_FILTER_OPERATORS],OPERATORS=[...BINARY_OPERATORS,...JSON_OPERATORS,...UNARY_OPERATORS,"between","between symmetric"],OperatorNode=freeze({is(r){return r.kind==="OperatorNode"},create(r){return freeze({kind:"OperatorNode",operator:r})}});function isJSONOperator(r){return isString(r)&&JSON_OPERATORS.includes(r)}const ColumnNode=freeze({is(r){return r.kind==="ColumnNode"},create(r){return freeze({kind:"ColumnNode",column:IdentifierNode.create(r)})}}),SelectAllNode=freeze({is(r){return r.kind==="SelectAllNode"},create(){return freeze({kind:"SelectAllNode"})}}),ReferenceNode=freeze({is(r){return r.kind==="ReferenceNode"},create(r,e){return freeze({kind:"ReferenceNode",table:e,column:r})},createSelectAll(r){return freeze({kind:"ReferenceNode",table:r,column:SelectAllNode.create()})}});var Ur;class DynamicReferenceBuilder{constructor(e){g(this,Ur,void 0);x(this,Ur,e)}get dynamicReference(){return i(this,Ur)}get refType(){}toOperationNode(){return parseSimpleReferenceExpression(i(this,Ur))}}Ur=new WeakMap;function isDynamicReferenceBuilder(r){return isObject$3(r)&&isOperationNodeSource(r)&&isString(r.dynamicReference)}const OrderByItemNode=freeze({is(r){return r.kind==="OrderByItemNode"},create(r,e){return freeze({kind:"OrderByItemNode",orderBy:r,direction:e})}}),RawNode=freeze({is(r){return r.kind==="RawNode"},create(r,e){return freeze({kind:"RawNode",sqlFragments:freeze(r),parameters:freeze(e)})},createWithSql(r){return RawNode.create([r],[])},createWithChild(r){return RawNode.create(["",""],[r])},createWithChildren(r){return RawNode.create(new Array(r.length+1).fill(""),r)}});function isOrderByDirection(r){return r==="asc"||r==="desc"}function parseOrderBy(r){if(r.length===2)return[parseOrderByItem(r[0],r[1])];if(r.length===1){const[e]=r;return Array.isArray(e)?e.map(t=>parseOrderByItem(t)):[parseOrderByItem(e)]}throw new Error(`Invalid number of arguments at order by! expected 1-2, received ${r.length}`)}function parseOrderByItem(r,e){const t=parseOrderByExpression(r);if(OrderByItemNode.is(t)){if(e)throw new Error("Cannot specify direction twice!");return t}return OrderByItemNode.create(t,parseOrderByDirectionExpression(e))}function parseOrderByExpression(r){if(isExpressionOrFactory(r))return parseExpression(r);if(isDynamicReferenceBuilder(r))return r.toOperationNode();const[e,t]=r.split(" ");if(t){if(!isOrderByDirection(t))throw new Error(`Invalid order by direction: ${t}`);return OrderByItemNode.create(parseStringReference(e),parseOrderByDirectionExpression(t))}return parseStringReference(r)}function parseOrderByDirectionExpression(r){if(r)return r==="asc"||r==="desc"?RawNode.createWithSql(r):r.toOperationNode()}const JSONReferenceNode=freeze({is(r){return r.kind==="JSONReferenceNode"},create(r,e){return freeze({kind:"JSONReferenceNode",reference:r,traversal:e})},cloneWithTraversal(r,e){return freeze({...r,traversal:e})}}),JSONOperatorChainNode=freeze({is(r){return r.kind==="JSONOperatorChainNode"},create(r){return freeze({kind:"JSONOperatorChainNode",operator:r,values:freeze([])})},cloneWithValue(r,e){return freeze({...r,values:freeze([...r.values,e])})}}),JSONPathNode=freeze({is(r){return r.kind==="JSONPathNode"},create(r){return freeze({kind:"JSONPathNode",inOperator:r,pathLegs:freeze([])})},cloneWithLeg(r,e){return freeze({...r,pathLegs:freeze([...r.pathLegs,e])})}});function parseSimpleReferenceExpression(r){return isString(r)?parseStringReference(r):r.toOperationNode()}function parseReferenceExpressionOrList(r){return isReadonlyArray(r)?r.map(e=>parseReferenceExpression(e)):[parseReferenceExpression(r)]}function parseReferenceExpression(r){return isExpressionOrFactory(r)?parseExpression(r):parseSimpleReferenceExpression(r)}function parseJSONReference(r,e){const t=parseStringReference(r);if(isJSONOperator(e))return JSONReferenceNode.create(t,JSONOperatorChainNode.create(OperatorNode.create(e)));const n=e.slice(0,-1);if(isJSONOperator(n))return JSONReferenceNode.create(t,JSONPathNode.create(OperatorNode.create(n)));throw new Error(`Invalid JSON operator: ${e}`)}function parseStringReference(r){const e=".";if(!r.includes(e))return ReferenceNode.create(ColumnNode.create(r));const t=r.split(e).map(trim$2);if(t.length===3)return parseStringReferenceWithTableAndSchema(t);if(t.length===2)return parseStringReferenceWithTable(t);throw new Error(`invalid column reference ${r}`)}function parseAliasedStringReference(r){const e=" as ";if(r.includes(e)){const[t,n]=r.split(e).map(trim$2);return AliasNode.create(parseStringReference(t),IdentifierNode.create(n))}else return parseStringReference(r)}function parseColumnName(r){return ColumnNode.create(r)}function parseOrderedColumnName(r){const e=" ";if(r.includes(e)){const[t,n]=r.split(e).map(trim$2);if(!isOrderByDirection(n))throw new Error(`invalid order direction "${n}" next to "${t}"`);return parseOrderBy([t,n])[0]}else return parseColumnName(r)}function parseStringReferenceWithTableAndSchema(r){const[e,t,n]=r;return ReferenceNode.create(ColumnNode.create(n),TableNode.createWithSchema(e,t))}function parseStringReferenceWithTable(r){const[e,t]=r;return ReferenceNode.create(ColumnNode.create(t),TableNode.create(e))}function trim$2(r){return r.trim()}const PrimitiveValueListNode=freeze({is(r){return r.kind==="PrimitiveValueListNode"},create(r){return freeze({kind:"PrimitiveValueListNode",values:freeze([...r])})}}),ValueListNode=freeze({is(r){return r.kind==="ValueListNode"},create(r){return freeze({kind:"ValueListNode",values:freeze(r)})}}),ValueNode=freeze({is(r){return r.kind==="ValueNode"},create(r){return freeze({kind:"ValueNode",value:r})},createImmediate(r){return freeze({kind:"ValueNode",value:r,immediate:!0})}});function parseValueExpressionOrList(r){return isReadonlyArray(r)?parseValueExpressionList(r):parseValueExpression(r)}function parseValueExpression(r){return isExpressionOrFactory(r)?parseExpression(r):ValueNode.create(r)}function isSafeImmediateValue(r){return isNumber(r)||isBoolean(r)||isNull(r)}function parseSafeImmediateValue(r){if(!isSafeImmediateValue(r))throw new Error(`unsafe immediate value ${JSON.stringify(r)}`);return ValueNode.createImmediate(r)}function parseValueExpressionList(r){return r.some(isExpressionOrFactory)?ValueListNode.create(r.map(e=>parseValueExpression(e))):PrimitiveValueListNode.create(r)}const ParensNode=freeze({is(r){return r.kind==="ParensNode"},create(r){return freeze({kind:"ParensNode",node:r})}});function parseValueBinaryOperationOrExpression(r){if(r.length===3)return parseValueBinaryOperation(r[0],r[1],r[2]);if(r.length===1)return parseValueExpression(r[0]);throw new Error(`invalid arguments: ${JSON.stringify(r)}`)}function parseValueBinaryOperation(r,e,t){return isIsOperator(e)&&needsIsOperator(t)?BinaryOperationNode.create(parseReferenceExpression(r),parseOperator(e),ValueNode.createImmediate(t)):BinaryOperationNode.create(parseReferenceExpression(r),parseOperator(e),parseValueExpressionOrList(t))}function parseReferentialBinaryOperation(r,e,t){return BinaryOperationNode.create(parseReferenceExpression(r),parseOperator(e),parseReferenceExpression(t))}function parseFilterObject(r,e){return parseFilterList(Object.entries(r).filter(([,t])=>!isUndefined(t)).map(([t,n])=>parseValueBinaryOperation(t,needsIsOperator(n)?"is":"=",n)),e)}function parseFilterList(r,e,t=!0){const n=e==="and"?AndNode.create:OrNode.create;if(r.length===0)return BinaryOperationNode.create(ValueNode.createImmediate(1),OperatorNode.create("="),ValueNode.createImmediate(e==="and"?1:0));let o=toOperationNode(r[0]);for(let a=1;a<r.length;++a)o=n(o,toOperationNode(r[a]));return r.length>1&&t?ParensNode.create(o):o}function isIsOperator(r){return r==="is"||r==="is not"}function needsIsOperator(r){return isNull(r)||isBoolean(r)}function parseOperator(r){if(isString(r)&&OPERATORS.includes(r))return OperatorNode.create(r);if(isOperationNodeSource(r))return r.toOperationNode();throw new Error(`invalid operator ${JSON.stringify(r)}`)}function toOperationNode(r){return isOperationNodeSource(r)?r.toOperationNode():r}const OrderByNode=freeze({is(r){return r.kind==="OrderByNode"},create(r){return freeze({kind:"OrderByNode",items:freeze([...r])})},cloneWithItems(r,e){return freeze({...r,items:freeze([...r.items,...e])})}}),PartitionByNode=freeze({is(r){return r.kind==="PartitionByNode"},create(r){return freeze({kind:"PartitionByNode",items:freeze(r)})},cloneWithItems(r,e){return freeze({...r,items:freeze([...r.items,...e])})}}),OverNode=freeze({is(r){return r.kind==="OverNode"},create(){return freeze({kind:"OverNode"})},cloneWithOrderByItems(r,e){return freeze({...r,orderBy:r.orderBy?OrderByNode.cloneWithItems(r.orderBy,e):OrderByNode.create(e)})},cloneWithPartitionByItems(r,e){return freeze({...r,partitionBy:r.partitionBy?PartitionByNode.cloneWithItems(r.partitionBy,e):PartitionByNode.create(e)})}}),FromNode=freeze({is(r){return r.kind==="FromNode"},create(r){return freeze({kind:"FromNode",froms:freeze(r)})},cloneWithFroms(r,e){return freeze({...r,froms:freeze([...r.froms,...e])})}}),GroupByNode=freeze({is(r){return r.kind==="GroupByNode"},create(r){return freeze({kind:"GroupByNode",items:freeze(r)})},cloneWithItems(r,e){return freeze({...r,items:freeze([...r.items,...e])})}}),HavingNode=freeze({is(r){return r.kind==="HavingNode"},create(r){return freeze({kind:"HavingNode",having:r})},cloneWithOperation(r,e,t){return freeze({...r,having:e==="And"?AndNode.create(r.having,t):OrNode.create(r.having,t)})}}),SelectQueryNode=freeze({is(r){return r.kind==="SelectQueryNode"},create(r){return freeze({kind:"SelectQueryNode",...r&&{with:r}})},createFrom(r,e){return freeze({kind:"SelectQueryNode",from:FromNode.create(r),...e&&{with:e}})},cloneWithSelections(r,e){return freeze({...r,selections:r.selections?freeze([...r.selections,...e]):freeze(e)})},cloneWithDistinctOn(r,e){return freeze({...r,distinctOn:r.distinctOn?freeze([...r.distinctOn,...e]):freeze(e)})},cloneWithFrontModifier(r,e){return freeze({...r,frontModifiers:r.frontModifiers?freeze([...r.frontModifiers,e]):freeze([e])})},cloneWithEndModifier(r,e){return freeze({...r,endModifiers:r.endModifiers?freeze([...r.endModifiers,e]):freeze([e])})},cloneWithOrderByItems(r,e){return freeze({...r,orderBy:r.orderBy?OrderByNode.cloneWithItems(r.orderBy,e):OrderByNode.create(e)})},cloneWithGroupByItems(r,e){return freeze({...r,groupBy:r.groupBy?GroupByNode.cloneWithItems(r.groupBy,e):GroupByNode.create(e)})},cloneWithLimit(r,e){return freeze({...r,limit:e})},cloneWithOffset(r,e){return freeze({...r,offset:e})},cloneWithFetch(r,e){return freeze({...r,fetch:e})},cloneWithHaving(r,e){return freeze({...r,having:r.having?HavingNode.cloneWithOperation(r.having,"And",e):HavingNode.create(e)})},cloneWithSetOperations(r,e){return freeze({...r,setOperations:r.setOperations?freeze([...r.setOperations,...e]):freeze([...e])})},cloneWithoutSelections(r){return freeze({...r,selections:[]})},cloneWithoutLimit(r){return freeze({...r,limit:void 0})},cloneWithoutOffset(r){return freeze({...r,offset:void 0})},cloneWithoutOrderBy(r){return freeze({...r,orderBy:void 0})}});function preventAwait(r,e){Object.defineProperties(r.prototype,{then:{enumerable:!1,value:()=>{throw new Error(e)}}})}var bt;const On=class On{constructor(e){g(this,bt,void 0);x(this,bt,freeze(e))}on(...e){return new On({...i(this,bt),joinNode:JoinNode.cloneWithOn(i(this,bt).joinNode,parseValueBinaryOperationOrExpression(e))})}onRef(e,t,n){return new On({...i(this,bt),joinNode:JoinNode.cloneWithOn(i(this,bt).joinNode,parseReferentialBinaryOperation(e,t,n))})}onTrue(){return new On({...i(this,bt),joinNode:JoinNode.cloneWithOn(i(this,bt).joinNode,RawNode.createWithSql("true"))})}$call(e){return e(this)}toOperationNode(){return i(this,bt).joinNode}};bt=new WeakMap;let JoinBuilder=On;preventAwait(JoinBuilder,"don't await JoinBuilder instances. They are never executed directly and are always just a part of a query.");const PartitionByItemNode=freeze({is(r){return r.kind==="PartitionByItemNode"},create(r){return freeze({kind:"PartitionByItemNode",partitionBy:r})}});function parsePartitionBy(r){return parseReferenceExpressionOrList(r).map(PartitionByItemNode.create)}var yr;const hi=class hi{constructor(e){g(this,yr,void 0);x(this,yr,freeze(e))}orderBy(e,t){return new hi({overNode:OverNode.cloneWithOrderByItems(i(this,yr).overNode,parseOrderBy([e,t]))})}partitionBy(e){return new hi({overNode:OverNode.cloneWithPartitionByItems(i(this,yr).overNode,parsePartitionBy(e))})}$call(e){return e(this)}toOperationNode(){return i(this,yr).overNode}};yr=new WeakMap;let OverBuilder=hi;preventAwait(OverBuilder,"don't await OverBuilder instances. They are never executed directly and are always just a part of a query.");const SelectionNode=freeze({is(r){return r.kind==="SelectionNode"},create(r){return freeze({kind:"SelectionNode",selection:r})},createSelectAll(){return freeze({kind:"SelectionNode",selection:SelectAllNode.create()})},createSelectAllFromTable(r){return freeze({kind:"SelectionNode",selection:ReferenceNode.createSelectAll(r)})}});function parseSelectArg(r){return isFunction(r)?parseSelectArg(r(expressionBuilder())):isReadonlyArray(r)?r.map(e=>parseSelectExpression(e)):[parseSelectExpression(r)]}function parseSelectExpression(r){return isString(r)?SelectionNode.create(parseAliasedStringReference(r)):isDynamicReferenceBuilder(r)?SelectionNode.create(r.toOperationNode()):SelectionNode.create(parseAliasedExpression(r))}function parseSelectAll(r){return r?Array.isArray(r)?r.map(parseSelectAllArg):[parseSelectAllArg(r)]:[SelectionNode.createSelectAll()]}function parseSelectAllArg(r){if(isString(r))return SelectionNode.createSelectAllFromTable(parseTable(r));throw new Error(`invalid value selectAll expression: ${JSON.stringify(r)}`)}const ValuesNode=freeze({is(r){return r.kind==="ValuesNode"},create(r){return freeze({kind:"ValuesNode",values:freeze(r)})}}),DefaultInsertValueNode=freeze({is(r){return r.kind==="DefaultInsertValueNode"},create(){return freeze({kind:"DefaultInsertValueNode"})}});function parseInsertExpression(r){const e=isFunction(r)?r(expressionBuilder()):r,t=isReadonlyArray(e)?e:freeze([e]);return parseInsertColumnsAndValues(t)}function parseInsertColumnsAndValues(r){const e=parseColumnNamesAndIndexes(r);return[freeze([...e.keys()].map(ColumnNode.create)),ValuesNode.create(r.map(t=>parseRowValues(t,e)))]}function parseColumnNamesAndIndexes(r){const e=new Map;for(const t of r){const n=Object.keys(t);for(const o of n)!e.has(o)&&t[o]!==void 0&&e.set(o,e.size)}return e}function parseRowValues(r,e){const t=Object.keys(r),n=Array.from({length:e.size});let o=!1;for(const l of t){const d=e.get(l);if(isUndefined(d))continue;const h=r[l];(isUndefined(h)||isExpressionOrFactory(h))&&(o=!0),n[d]=h}if(t.length<e.size||o){const l=DefaultInsertValueNode.create();return ValueListNode.create(n.map(d=>isUndefined(d)?l:parseValueExpression(d)))}return PrimitiveValueListNode.create(n)}const InsertQueryNode=freeze({is(r){return r.kind==="InsertQueryNode"},create(r,e,t){return freeze({kind:"InsertQueryNode",into:r,...e&&{with:e},replace:t})},createWithoutInto(){return freeze({kind:"InsertQueryNode"})},cloneWith(r,e){return freeze({...r,...e})}}),UpdateQueryNode=freeze({is(r){return r.kind==="UpdateQueryNode"},create(r,e){return freeze({kind:"UpdateQueryNode",table:r,...e&&{with:e}})},createWithoutTable(){return freeze({kind:"UpdateQueryNode"})},cloneWithFromItems(r,e){return freeze({...r,from:r.from?FromNode.cloneWithFroms(r.from,e):FromNode.create(e)})},cloneWithUpdates(r,e){return freeze({...r,updates:r.updates?freeze([...r.updates,...e]):e})},cloneWithLimit(r,e){return freeze({...r,limit:e})}}),UsingNode=freeze({is(r){return r.kind==="UsingNode"},create(r){return freeze({kind:"UsingNode",tables:freeze(r)})},cloneWithTables(r,e){return freeze({...r,tables:freeze([...r.tables,...e])})}}),DeleteQueryNode=freeze({is(r){return r.kind==="DeleteQueryNode"},create(r,e){return freeze({kind:"DeleteQueryNode",from:FromNode.create(r),...e&&{with:e}})},cloneWithOrderByItems(r,e){return freeze({...r,orderBy:r.orderBy?OrderByNode.cloneWithItems(r.orderBy,e):OrderByNode.create(e)})},cloneWithoutOrderBy(r){return freeze({...r,orderBy:void 0})},cloneWithLimit(r,e){return freeze({...r,limit:e})},cloneWithoutLimit(r){return freeze({...r,limit:void 0})},cloneWithUsing(r,e){return freeze({...r,using:r.using!==void 0?UsingNode.cloneWithTables(r.using,e):UsingNode.create(e)})}}),WhereNode=freeze({is(r){return r.kind==="WhereNode"},create(r){return freeze({kind:"WhereNode",where:r})},cloneWithOperation(r,e,t){return freeze({...r,where:e==="And"?AndNode.create(r.where,t):OrNode.create(r.where,t)})}}),ReturningNode=freeze({is(r){return r.kind==="ReturningNode"},create(r){return freeze({kind:"ReturningNode",selections:freeze(r)})},cloneWithSelections(r,e){return freeze({...r,selections:r.selections?freeze([...r.selections,...e]):freeze(e)})}}),ExplainNode=freeze({is(r){return r.kind==="ExplainNode"},create(r,e){return freeze({kind:"ExplainNode",format:r,options:e})}}),WhenNode=freeze({is(r){return r.kind==="WhenNode"},create(r){return freeze({kind:"WhenNode",condition:r})},cloneWithResult(r,e){return freeze({...r,result:e})}}),MergeQueryNode=freeze({is(r){return r.kind==="MergeQueryNode"},create(r,e){return freeze({kind:"MergeQueryNode",into:r,...e&&{with:e}})},cloneWithUsing(r,e){return freeze({...r,using:e})},cloneWithWhen(r,e){return freeze({...r,whens:r.whens?freeze([...r.whens,e]):freeze([e])})},cloneWithThen(r,e){return freeze({...r,whens:r.whens?freeze([...r.whens.slice(0,-1),WhenNode.cloneWithResult(r.whens[r.whens.length-1],e)]):void 0})}}),QueryNode=freeze({is(r){return SelectQueryNode.is(r)||InsertQueryNode.is(r)||UpdateQueryNode.is(r)||DeleteQueryNode.is(r)||MergeQueryNode.is(r)},cloneWithWhere(r,e){return freeze({...r,where:r.where?WhereNode.cloneWithOperation(r.where,"And",e):WhereNode.create(e)})},cloneWithJoin(r,e){return freeze({...r,joins:r.joins?freeze([...r.joins,e]):freeze([e])})},cloneWithReturning(r,e){return freeze({...r,returning:r.returning?ReturningNode.cloneWithSelections(r.returning,e):ReturningNode.create(e)})},cloneWithoutReturning(r){return freeze({...r,returning:void 0})},cloneWithoutWhere(r){return freeze({...r,where:void 0})},cloneWithExplain(r,e,t){return freeze({...r,explain:ExplainNode.create(e,t==null?void 0:t.toOperationNode())})},cloneWithTop(r,e){return freeze({...r,top:e})}}),ColumnUpdateNode=freeze({is(r){return r.kind==="ColumnUpdateNode"},create(r,e){return freeze({kind:"ColumnUpdateNode",column:r,value:e})}});function parseUpdate(...r){return r.length===2?[ColumnUpdateNode.create(parseReferenceExpression(r[0]),parseValueExpression(r[1]))]:parseUpdateObjectExpression(r[0])}function parseUpdateObjectExpression(r){const e=isFunction(r)?r(expressionBuilder()):r;return Object.entries(e).filter(([t,n])=>n!==void 0).map(([t,n])=>ColumnUpdateNode.create(ColumnNode.create(t),parseValueExpression(n)))}const OnDuplicateKeyNode=freeze({is(r){return r.kind==="OnDuplicateKeyNode"},create(r){return freeze({kind:"OnDuplicateKeyNode",updates:r})}});class InsertResult{constructor(e,t){oe(this,"insertId");oe(this,"numInsertedOrUpdatedRows");this.insertId=e,this.numInsertedOrUpdatedRows=t}}class NoResultError extends Error{constructor(t){super("no result");oe(this,"node");this.node=t}}function isNoResultErrorConstructor(r){return Object.prototype.hasOwnProperty.call(r,"prototype")}const OnConflictNode=freeze({is(r){return r.kind==="OnConflictNode"},create(){return freeze({kind:"OnConflictNode"})},cloneWith(r,e){return freeze({...r,...e})},cloneWithIndexWhere(r,e){return freeze({...r,indexWhere:r.indexWhere?WhereNode.cloneWithOperation(r.indexWhere,"And",e):WhereNode.create(e)})},cloneWithIndexOrWhere(r,e){return freeze({...r,indexWhere:r.indexWhere?WhereNode.cloneWithOperation(r.indexWhere,"Or",e):WhereNode.create(e)})},cloneWithUpdateWhere(r,e){return freeze({...r,updateWhere:r.updateWhere?WhereNode.cloneWithOperation(r.updateWhere,"And",e):WhereNode.create(e)})},cloneWithUpdateOrWhere(r,e){return freeze({...r,updateWhere:r.updateWhere?WhereNode.cloneWithOperation(r.updateWhere,"Or",e):WhereNode.create(e)})},cloneWithoutIndexWhere(r){return freeze({...r,indexWhere:void 0})},cloneWithoutUpdateWhere(r){return freeze({...r,updateWhere:void 0})}});var _e;const Lt=class Lt{constructor(e){g(this,_e,void 0);x(this,_e,freeze(e))}column(e){const t=ColumnNode.create(e);return new Lt({...i(this,_e),onConflictNode:OnConflictNode.cloneWith(i(this,_e).onConflictNode,{columns:i(this,_e).onConflictNode.columns?freeze([...i(this,_e).onConflictNode.columns,t]):freeze([t])})})}columns(e){const t=e.map(ColumnNode.create);return new Lt({...i(this,_e),onConflictNode:OnConflictNode.cloneWith(i(this,_e).onConflictNode,{columns:i(this,_e).onConflictNode.columns?freeze([...i(this,_e).onConflictNode.columns,...t]):freeze(t)})})}constraint(e){return new Lt({...i(this,_e),onConflictNode:OnConflictNode.cloneWith(i(this,_e).onConflictNode,{constraint:IdentifierNode.create(e)})})}expression(e){return new Lt({...i(this,_e),onConflictNode:OnConflictNode.cloneWith(i(this,_e).onConflictNode,{indexExpression:e.toOperationNode()})})}where(...e){return new Lt({...i(this,_e),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,_e).onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,n){return new Lt({...i(this,_e),onConflictNode:OnConflictNode.cloneWithIndexWhere(i(this,_e).onConflictNode,parseReferentialBinaryOperation(e,t,n))})}clearWhere(){return new Lt({...i(this,_e),onConflictNode:OnConflictNode.cloneWithoutIndexWhere(i(this,_e).onConflictNode)})}doNothing(){return new OnConflictDoNothingBuilder({...i(this,_e),onConflictNode:OnConflictNode.cloneWith(i(this,_e).onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new OnConflictUpdateBuilder({...i(this,_e),onConflictNode:OnConflictNode.cloneWith(i(this,_e).onConflictNode,{updates:parseUpdateObjectExpression(e)})})}$call(e){return e(this)}};_e=new WeakMap;let OnConflictBuilder=Lt;preventAwait(OnConflictBuilder,"don't await OnConflictBuilder instances.");var xn;class OnConflictDoNothingBuilder{constructor(e){g(this,xn,void 0);x(this,xn,freeze(e))}toOperationNode(){return i(this,xn).onConflictNode}}xn=new WeakMap;preventAwait(OnConflictDoNothingBuilder,"don't await OnConflictDoNothingBuilder instances.");var wt;const Tn=class Tn{constructor(e){g(this,wt,void 0);x(this,wt,freeze(e))}where(...e){return new Tn({...i(this,wt),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,wt).onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,n){return new Tn({...i(this,wt),onConflictNode:OnConflictNode.cloneWithUpdateWhere(i(this,wt).onConflictNode,parseReferentialBinaryOperation(e,t,n))})}clearWhere(){return new Tn({...i(this,wt),onConflictNode:OnConflictNode.cloneWithoutUpdateWhere(i(this,wt).onConflictNode)})}$call(e){return e(this)}toOperationNode(){return i(this,wt).onConflictNode}};wt=new WeakMap;let OnConflictUpdateBuilder=Tn;preventAwait(OnConflictUpdateBuilder,"don't await OnConflictUpdateBuilder instances.");const TopNode=freeze({is(r){return r.kind==="TopNode"},create(r,e){return freeze({kind:"TopNode",expression:r,modifiers:e})}});function parseTop(r,e){if(!isNumber(r)&&!isBigInt(r))throw new Error(`Invalid top expression: ${r}`);if(!isUndefined(e)&&!isTopModifiers(e))throw new Error(`Invalid top modifiers: ${e}`);return TopNode.create(r,e)}function isTopModifiers(r){return r==="percent"||r==="with ties"||r==="percent with ties"}var ee;const Fe=class Fe{constructor(e){g(this,ee,void 0);x(this,ee,freeze(e))}values(e){const[t,n]=parseInsertExpression(e);return new Fe({...i(this,ee),queryNode:InsertQueryNode.cloneWith(i(this,ee).queryNode,{columns:t,values:n})})}columns(e){return new Fe({...i(this,ee),queryNode:InsertQueryNode.cloneWith(i(this,ee).queryNode,{columns:freeze(e.map(ColumnNode.create))})})}expression(e){return new Fe({...i(this,ee),queryNode:InsertQueryNode.cloneWith(i(this,ee).queryNode,{values:parseExpression(e)})})}defaultValues(){return new Fe({...i(this,ee),queryNode:InsertQueryNode.cloneWith(i(this,ee).queryNode,{defaultValues:!0})})}ignore(){return new Fe({...i(this,ee),queryNode:InsertQueryNode.cloneWith(i(this,ee).queryNode,{ignore:!0})})}top(e,t){return new Fe({...i(this,ee),queryNode:QueryNode.cloneWithTop(i(this,ee).queryNode,parseTop(e,t))})}onConflict(e){return new Fe({...i(this,ee),queryNode:InsertQueryNode.cloneWith(i(this,ee).queryNode,{onConflict:e(new OnConflictBuilder({onConflictNode:OnConflictNode.create()})).toOperationNode()})})}onDuplicateKeyUpdate(e){return new Fe({...i(this,ee),queryNode:InsertQueryNode.cloneWith(i(this,ee).queryNode,{onDuplicateKey:OnDuplicateKeyNode.create(parseUpdateObjectExpression(e))})})}returning(e){return new Fe({...i(this,ee),queryNode:QueryNode.cloneWithReturning(i(this,ee).queryNode,parseSelectArg(e))})}returningAll(){return new Fe({...i(this,ee),queryNode:QueryNode.cloneWithReturning(i(this,ee).queryNode,parseSelectAll())})}clearReturning(){return new Fe({...i(this,ee),queryNode:QueryNode.cloneWithoutReturning(i(this,ee).queryNode)})}$call(e){return e(this)}$if(e,t){return e?t(this):new Fe({...i(this,ee)})}$castTo(){return new Fe(i(this,ee))}$narrowType(){return new Fe(i(this,ee))}$assertType(){return new Fe(i(this,ee))}withPlugin(e){return new Fe({...i(this,ee),executor:i(this,ee).executor.withPlugin(e)})}toOperationNode(){return i(this,ee).executor.transformQuery(i(this,ee).queryNode,i(this,ee).queryId)}compile(){return i(this,ee).executor.compileQuery(this.toOperationNode(),i(this,ee).queryId)}async execute(){const e=this.compile(),t=e.query,n=await i(this,ee).executor.executeQuery(e,i(this,ee).queryId);return i(this,ee).executor.adapter.supportsReturning&&t.returning?n.rows:[new InsertResult(n.insertId,n.numAffectedRows??n.numUpdatedOrDeletedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,ee).executor.stream(t,e,i(this,ee).queryId);for await(const o of n)yield*o.rows}async explain(e,t){return await new Fe({...i(this,ee),queryNode:QueryNode.cloneWithExplain(i(this,ee).queryNode,e,t)}).execute()}};ee=new WeakMap;let InsertQueryBuilder=Fe;preventAwait(InsertQueryBuilder,"don't await InsertQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");class DeleteResult{constructor(e){oe(this,"numDeletedRows");this.numDeletedRows=e}}const LimitNode=freeze({is(r){return r.kind==="LimitNode"},create(r){return freeze({kind:"LimitNode",limit:r})}});var K;const ve=class ve{constructor(e){g(this,K,void 0);x(this,K,freeze(e))}where(...e){return new ve({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,n){return new ve({...i(this,K),queryNode:QueryNode.cloneWithWhere(i(this,K).queryNode,parseReferentialBinaryOperation(e,t,n))})}clearWhere(){return new ve({...i(this,K),queryNode:QueryNode.cloneWithoutWhere(i(this,K).queryNode)})}top(e,t){return new ve({...i(this,K),queryNode:QueryNode.cloneWithTop(i(this,K).queryNode,parseTop(e,t))})}using(e){return new ve({...i(this,K),queryNode:DeleteQueryNode.cloneWithUsing(i(this,K).queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new ve({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new ve({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new ve({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new ve({...i(this,K),queryNode:QueryNode.cloneWithJoin(i(this,K).queryNode,parseJoin("FullJoin",e))})}returning(e){return new ve({...i(this,K),queryNode:QueryNode.cloneWithReturning(i(this,K).queryNode,parseSelectArg(e))})}returningAll(e){return new ve({...i(this,K),queryNode:QueryNode.cloneWithReturning(i(this,K).queryNode,parseSelectAll(e))})}clearReturning(){return new ve({...i(this,K),queryNode:QueryNode.cloneWithoutReturning(i(this,K).queryNode)})}clearLimit(){return new ve({...i(this,K),queryNode:DeleteQueryNode.cloneWithoutLimit(i(this,K).queryNode)})}clearOrderBy(){return new ve({...i(this,K),queryNode:DeleteQueryNode.cloneWithoutOrderBy(i(this,K).queryNode)})}orderBy(e,t){return new ve({...i(this,K),queryNode:DeleteQueryNode.cloneWithOrderByItems(i(this,K).queryNode,parseOrderBy([e,t]))})}limit(e){return new ve({...i(this,K),queryNode:DeleteQueryNode.cloneWithLimit(i(this,K).queryNode,LimitNode.create(parseValueExpression(e)))})}$call(e){return e(this)}$if(e,t){return e?t(this):new ve({...i(this,K)})}$castTo(){return new ve(i(this,K))}$narrowType(){return new ve(i(this,K))}$assertType(){return new ve(i(this,K))}withPlugin(e){return new ve({...i(this,K),executor:i(this,K).executor.withPlugin(e)})}toOperationNode(){return i(this,K).executor.transformQuery(i(this,K).queryNode,i(this,K).queryId)}compile(){return i(this,K).executor.compileQuery(this.toOperationNode(),i(this,K).queryId)}async execute(){const e=this.compile(),t=e.query,n=await i(this,K).executor.executeQuery(e,i(this,K).queryId);return i(this,K).executor.adapter.supportsReturning&&t.returning?n.rows:[new DeleteResult(n.numAffectedRows??n.numUpdatedOrDeletedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,K).executor.stream(t,e,i(this,K).queryId);for await(const o of n)yield*o.rows}async explain(e,t){return await new ve({...i(this,K),queryNode:QueryNode.cloneWithExplain(i(this,K).queryNode,e,t)}).execute()}};K=new WeakMap;let DeleteQueryBuilder=ve;preventAwait(DeleteQueryBuilder,"don't await DeleteQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");class UpdateResult{constructor(e,t){oe(this,"numUpdatedRows");oe(this,"numChangedRows");this.numUpdatedRows=e,this.numChangedRows=t}}var Y;const ke=class ke{constructor(e){g(this,Y,void 0);x(this,Y,freeze(e))}where(...e){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithWhere(i(this,Y).queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,n){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithWhere(i(this,Y).queryNode,parseReferentialBinaryOperation(e,t,n))})}clearWhere(){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithoutWhere(i(this,Y).queryNode)})}top(e,t){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithTop(i(this,Y).queryNode,parseTop(e,t))})}from(e){return new ke({...i(this,Y),queryNode:UpdateQueryNode.cloneWithFromItems(i(this,Y).queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithJoin(i(this,Y).queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithJoin(i(this,Y).queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithJoin(i(this,Y).queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithJoin(i(this,Y).queryNode,parseJoin("FullJoin",e))})}limit(e){return new ke({...i(this,Y),queryNode:UpdateQueryNode.cloneWithLimit(i(this,Y).queryNode,LimitNode.create(parseValueExpression(e)))})}set(...e){return new ke({...i(this,Y),queryNode:UpdateQueryNode.cloneWithUpdates(i(this,Y).queryNode,parseUpdate(...e))})}returning(e){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithReturning(i(this,Y).queryNode,parseSelectArg(e))})}returningAll(){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithReturning(i(this,Y).queryNode,parseSelectAll())})}clearReturning(){return new ke({...i(this,Y),queryNode:QueryNode.cloneWithoutReturning(i(this,Y).queryNode)})}$call(e){return e(this)}$if(e,t){return e?t(this):new ke({...i(this,Y)})}$castTo(){return new ke(i(this,Y))}$narrowType(){return new ke(i(this,Y))}$assertType(){return new ke(i(this,Y))}withPlugin(e){return new ke({...i(this,Y),executor:i(this,Y).executor.withPlugin(e)})}toOperationNode(){return i(this,Y).executor.transformQuery(i(this,Y).queryNode,i(this,Y).queryId)}compile(){return i(this,Y).executor.compileQuery(this.toOperationNode(),i(this,Y).queryId)}async execute(){const e=this.compile(),t=e.query,n=await i(this,Y).executor.executeQuery(e,i(this,Y).queryId);return i(this,Y).executor.adapter.supportsReturning&&t.returning?n.rows:[new UpdateResult(n.numAffectedRows??n.numUpdatedOrDeletedRows??BigInt(0),n.numChangedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,Y).executor.stream(t,e,i(this,Y).queryId);for await(const o of n)yield*o.rows}async explain(e,t){return await new ke({...i(this,Y),queryNode:QueryNode.cloneWithExplain(i(this,Y).queryNode,e,t)}).execute()}};Y=new WeakMap;let UpdateQueryBuilder=ke;preventAwait(UpdateQueryBuilder,"don't await UpdateQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");const CommonTableExpressionNameNode=freeze({is(r){return r.kind==="CommonTableExpressionNameNode"},create(r,e){return freeze({kind:"CommonTableExpressionNameNode",table:TableNode.create(r),columns:e?freeze(e.map(ColumnNode.create)):void 0})}}),CommonTableExpressionNode=freeze({is(r){return r.kind==="CommonTableExpressionNode"},create(r,e){return freeze({kind:"CommonTableExpressionNode",name:r,expression:e})},cloneWith(r,e){return freeze({...r,...e})}});var qt;const pi=class pi{constructor(e){g(this,qt,void 0);x(this,qt,freeze(e))}materialized(){return new pi({...i(this,qt),node:CommonTableExpressionNode.cloneWith(i(this,qt).node,{materialized:!0})})}notMaterialized(){return new pi({...i(this,qt),node:CommonTableExpressionNode.cloneWith(i(this,qt).node,{materialized:!1})})}toOperationNode(){return i(this,qt).node}};qt=new WeakMap;let CTEBuilder=pi;preventAwait(CTEBuilder,"don't await CTEBuilder instances. They are never executed directly and are always just a part of a query.");function parseCommonTableExpression(r,e){const t=e(createQueryCreator()).toOperationNode();return isFunction(r)?r(cteBuilderFactory(t)).toOperationNode():CommonTableExpressionNode.create(parseCommonTableExpressionName(r),t)}function cteBuilderFactory(r){return e=>new CTEBuilder({node:CommonTableExpressionNode.create(parseCommonTableExpressionName(e),r)})}function parseCommonTableExpressionName(r){if(r.includes("(")){const e=r.split(/[\(\)]/),t=e[0],n=e[1].split(",").map(o=>o.trim());return CommonTableExpressionNameNode.create(t,n)}else return CommonTableExpressionNameNode.create(r)}const WithNode=freeze({is(r){return r.kind==="WithNode"},create(r,e){return freeze({kind:"WithNode",expressions:freeze([r]),...e})},cloneWithExpression(r,e){return freeze({...r,expressions:freeze([...r.expressions,e])})}}),CHARS=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];function randomString(r){let e="";for(let t=0;t<r;++t)e+=randomChar();return e}function randomChar(){return CHARS[~~(Math.random()*CHARS.length)]}function createQueryId(){return new LazyQueryId}var $r;class LazyQueryId{constructor(){g(this,$r,void 0)}get queryId(){return i(this,$r)===void 0&&x(this,$r,randomString(8)),i(this,$r)}}$r=new WeakMap;function requireAllProps(r){return r}var mi;class OperationNodeTransformer{constructor(){oe(this,"nodeStack",[]);g(this,mi,freeze({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this),JSONReferenceNode:this.transformJSONReference.bind(this),JSONPathNode:this.transformJSONPath.bind(this),JSONPathLegNode:this.transformJSONPathLeg.bind(this),JSONOperatorChainNode:this.transformJSONOperatorChain.bind(this),TupleNode:this.transformTuple.bind(this),MergeQueryNode:this.transformMergeQuery.bind(this),MatchedNode:this.transformMatched.bind(this),AddIndexNode:this.transformAddIndex.bind(this),CastNode:this.transformCast.bind(this),FetchNode:this.transformFetch.bind(this),TopNode:this.transformTop.bind(this)}))}transformNode(e){if(!e)return e;this.nodeStack.push(e);const t=this.transformNodeImpl(e);return this.nodeStack.pop(),freeze(t)}transformNodeImpl(e){return i(this,mi)[e.kind](e)}transformNodeList(e){return e&&freeze(e.map(t=>this.transformNode(t)))}transformSelectQuery(e){return{kind:"SelectQueryNode",from:this.transformNode(e.from),selections:this.transformNodeList(e.selections),distinctOn:this.transformNodeList(e.distinctOn),joins:this.transformNodeList(e.joins),groupBy:this.transformNode(e.groupBy),orderBy:this.transformNode(e.orderBy),where:this.transformNode(e.where),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),limit:this.transformNode(e.limit),offset:this.transformNode(e.offset),with:this.transformNode(e.with),having:this.transformNode(e.having),explain:this.transformNode(e.explain),setOperations:this.transformNodeList(e.setOperations),fetch:this.transformNode(e.fetch),top:this.transformNode(e.top)}}transformSelection(e){return{kind:"SelectionNode",selection:this.transformNode(e.selection)}}transformColumn(e){return{kind:"ColumnNode",column:this.transformNode(e.column)}}transformAlias(e){return{kind:"AliasNode",node:this.transformNode(e.node),alias:this.transformNode(e.alias)}}transformTable(e){return{kind:"TableNode",table:this.transformNode(e.table)}}transformFrom(e){return{kind:"FromNode",froms:this.transformNodeList(e.froms)}}transformReference(e){return{kind:"ReferenceNode",column:this.transformNode(e.column),table:this.transformNode(e.table)}}transformAnd(e){return{kind:"AndNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformOr(e){return{kind:"OrNode",left:this.transformNode(e.left),right:this.transformNode(e.right)}}transformValueList(e){return{kind:"ValueListNode",values:this.transformNodeList(e.values)}}transformParens(e){return{kind:"ParensNode",node:this.transformNode(e.node)}}transformJoin(e){return{kind:"JoinNode",joinType:e.joinType,table:this.transformNode(e.table),on:this.transformNode(e.on)}}transformRaw(e){return{kind:"RawNode",sqlFragments:freeze([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters)}}transformWhere(e){return{kind:"WhereNode",where:this.transformNode(e.where)}}transformInsertQuery(e){return{kind:"InsertQueryNode",into:this.transformNode(e.into),columns:this.transformNodeList(e.columns),values:this.transformNode(e.values),returning:this.transformNode(e.returning),onConflict:this.transformNode(e.onConflict),onDuplicateKey:this.transformNode(e.onDuplicateKey),with:this.transformNode(e.with),ignore:e.ignore,replace:e.replace,explain:this.transformNode(e.explain),defaultValues:e.defaultValues,top:this.transformNode(e.top)}}transformValues(e){return{kind:"ValuesNode",values:this.transformNodeList(e.values)}}transformDeleteQuery(e){return{kind:"DeleteQueryNode",from:this.transformNode(e.from),using:this.transformNode(e.using),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),returning:this.transformNode(e.returning),with:this.transformNode(e.with),orderBy:this.transformNode(e.orderBy),limit:this.transformNode(e.limit),explain:this.transformNode(e.explain),top:this.transformNode(e.top)}}transformReturning(e){return{kind:"ReturningNode",selections:this.transformNodeList(e.selections)}}transformCreateTable(e){return{kind:"CreateTableNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),constraints:this.transformNodeList(e.constraints),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),selectQuery:this.transformNode(e.selectQuery)}}transformColumnDefinition(e){return{kind:"ColumnDefinitionNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),references:this.transformNode(e.references),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo),check:this.transformNode(e.check),generated:this.transformNode(e.generated),frontModifiers:this.transformNodeList(e.frontModifiers),endModifiers:this.transformNodeList(e.endModifiers),nullsNotDistinct:e.nullsNotDistinct,identity:e.identity}}transformAddColumn(e){return{kind:"AddColumnNode",column:this.transformNode(e.column)}}transformDropTable(e){return{kind:"DropTableNode",table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformOrderBy(e){return{kind:"OrderByNode",items:this.transformNodeList(e.items)}}transformOrderByItem(e){return{kind:"OrderByItemNode",orderBy:this.transformNode(e.orderBy),direction:this.transformNode(e.direction)}}transformGroupBy(e){return{kind:"GroupByNode",items:this.transformNodeList(e.items)}}transformGroupByItem(e){return{kind:"GroupByItemNode",groupBy:this.transformNode(e.groupBy)}}transformUpdateQuery(e){return{kind:"UpdateQueryNode",table:this.transformNode(e.table),from:this.transformNode(e.from),joins:this.transformNodeList(e.joins),where:this.transformNode(e.where),updates:this.transformNodeList(e.updates),returning:this.transformNode(e.returning),with:this.transformNode(e.with),explain:this.transformNode(e.explain),limit:this.transformNode(e.limit),top:this.transformNode(e.top)}}transformColumnUpdate(e){return{kind:"ColumnUpdateNode",column:this.transformNode(e.column),value:this.transformNode(e.value)}}transformLimit(e){return{kind:"LimitNode",limit:this.transformNode(e.limit)}}transformOffset(e){return{kind:"OffsetNode",offset:this.transformNode(e.offset)}}transformOnConflict(e){return{kind:"OnConflictNode",columns:this.transformNodeList(e.columns),constraint:this.transformNode(e.constraint),indexExpression:this.transformNode(e.indexExpression),indexWhere:this.transformNode(e.indexWhere),updates:this.transformNodeList(e.updates),updateWhere:this.transformNode(e.updateWhere),doNothing:e.doNothing}}transformOnDuplicateKey(e){return{kind:"OnDuplicateKeyNode",updates:this.transformNodeList(e.updates)}}transformCreateIndex(e){return{kind:"CreateIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists,where:this.transformNode(e.where),nullsNotDistinct:e.nullsNotDistinct}}transformList(e){return{kind:"ListNode",items:this.transformNodeList(e.items)}}transformDropIndex(e){return{kind:"DropIndexNode",name:this.transformNode(e.name),table:this.transformNode(e.table),ifExists:e.ifExists,cascade:e.cascade}}transformPrimaryKeyConstraint(e){return{kind:"PrimaryKeyConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name)}}transformUniqueConstraint(e){return{kind:"UniqueConstraintNode",columns:this.transformNodeList(e.columns),name:this.transformNode(e.name),nullsNotDistinct:e.nullsNotDistinct}}transformForeignKeyConstraint(e){return{kind:"ForeignKeyConstraintNode",columns:this.transformNodeList(e.columns),references:this.transformNode(e.references),name:this.transformNode(e.name),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformSetOperation(e){return{kind:"SetOperationNode",operator:e.operator,expression:this.transformNode(e.expression),all:e.all}}transformReferences(e){return{kind:"ReferencesNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformCheckConstraint(e){return{kind:"CheckConstraintNode",expression:this.transformNode(e.expression),name:this.transformNode(e.name)}}transformWith(e){return{kind:"WithNode",expressions:this.transformNodeList(e.expressions),recursive:e.recursive}}transformCommonTableExpression(e){return{kind:"CommonTableExpressionNode",name:this.transformNode(e.name),materialized:e.materialized,expression:this.transformNode(e.expression)}}transformCommonTableExpressionName(e){return{kind:"CommonTableExpressionNameNode",table:this.transformNode(e.table),columns:this.transformNodeList(e.columns)}}transformHaving(e){return{kind:"HavingNode",having:this.transformNode(e.having)}}transformCreateSchema(e){return{kind:"CreateSchemaNode",schema:this.transformNode(e.schema),ifNotExists:e.ifNotExists}}transformDropSchema(e){return{kind:"DropSchemaNode",schema:this.transformNode(e.schema),ifExists:e.ifExists,cascade:e.cascade}}transformAlterTable(e){return{kind:"AlterTableNode",table:this.transformNode(e.table),renameTo:this.transformNode(e.renameTo),setSchema:this.transformNode(e.setSchema),columnAlterations:this.transformNodeList(e.columnAlterations),addConstraint:this.transformNode(e.addConstraint),dropConstraint:this.transformNode(e.dropConstraint),addIndex:this.transformNode(e.addIndex),dropIndex:this.transformNode(e.dropIndex)}}transformDropColumn(e){return{kind:"DropColumnNode",column:this.transformNode(e.column)}}transformRenameColumn(e){return{kind:"RenameColumnNode",column:this.transformNode(e.column),renameTo:this.transformNode(e.renameTo)}}transformAlterColumn(e){return{kind:"AlterColumnNode",column:this.transformNode(e.column),dataType:this.transformNode(e.dataType),dataTypeExpression:this.transformNode(e.dataTypeExpression),setDefault:this.transformNode(e.setDefault),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull}}transformModifyColumn(e){return{kind:"ModifyColumnNode",column:this.transformNode(e.column)}}transformAddConstraint(e){return{kind:"AddConstraintNode",constraint:this.transformNode(e.constraint)}}transformDropConstraint(e){return{kind:"DropConstraintNode",constraintName:this.transformNode(e.constraintName),ifExists:e.ifExists,modifier:e.modifier}}transformCreateView(e){return{kind:"CreateViewNode",name:this.transformNode(e.name),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns),as:this.transformNode(e.as)}}transformDropView(e){return{kind:"DropViewNode",name:this.transformNode(e.name),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade}}transformGenerated(e){return{kind:"GeneratedNode",byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression)}}transformDefaultValue(e){return{kind:"DefaultValueNode",defaultValue:this.transformNode(e.defaultValue)}}transformOn(e){return{kind:"OnNode",on:this.transformNode(e.on)}}transformSelectModifier(e){return{kind:"SelectModifierNode",modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier),of:this.transformNodeList(e.of)}}transformCreateType(e){return{kind:"CreateTypeNode",name:this.transformNode(e.name),enum:this.transformNode(e.enum)}}transformDropType(e){return{kind:"DropTypeNode",name:this.transformNode(e.name),ifExists:e.ifExists}}transformExplain(e){return{kind:"ExplainNode",format:e.format,options:this.transformNode(e.options)}}transformSchemableIdentifier(e){return{kind:"SchemableIdentifierNode",schema:this.transformNode(e.schema),identifier:this.transformNode(e.identifier)}}transformAggregateFunction(e){return{kind:"AggregateFunctionNode",aggregated:this.transformNodeList(e.aggregated),distinct:e.distinct,filter:this.transformNode(e.filter),func:e.func,over:this.transformNode(e.over)}}transformOver(e){return{kind:"OverNode",orderBy:this.transformNode(e.orderBy),partitionBy:this.transformNode(e.partitionBy)}}transformPartitionBy(e){return{kind:"PartitionByNode",items:this.transformNodeList(e.items)}}transformPartitionByItem(e){return{kind:"PartitionByItemNode",partitionBy:this.transformNode(e.partitionBy)}}transformBinaryOperation(e){return{kind:"BinaryOperationNode",leftOperand:this.transformNode(e.leftOperand),operator:this.transformNode(e.operator),rightOperand:this.transformNode(e.rightOperand)}}transformUnaryOperation(e){return{kind:"UnaryOperationNode",operator:this.transformNode(e.operator),operand:this.transformNode(e.operand)}}transformUsing(e){return{kind:"UsingNode",tables:this.transformNodeList(e.tables)}}transformFunction(e){return{kind:"FunctionNode",func:e.func,arguments:this.transformNodeList(e.arguments)}}transformCase(e){return{kind:"CaseNode",value:this.transformNode(e.value),when:this.transformNodeList(e.when),else:this.transformNode(e.else),isStatement:e.isStatement}}transformWhen(e){return{kind:"WhenNode",condition:this.transformNode(e.condition),result:this.transformNode(e.result)}}transformJSONReference(e){return{kind:"JSONReferenceNode",reference:this.transformNode(e.reference),traversal:this.transformNode(e.traversal)}}transformJSONPath(e){return{kind:"JSONPathNode",inOperator:this.transformNode(e.inOperator),pathLegs:this.transformNodeList(e.pathLegs)}}transformJSONPathLeg(e){return{kind:"JSONPathLegNode",type:e.type,value:e.value}}transformJSONOperatorChain(e){return{kind:"JSONOperatorChainNode",operator:this.transformNode(e.operator),values:this.transformNodeList(e.values)}}transformTuple(e){return{kind:"TupleNode",values:this.transformNodeList(e.values)}}transformMergeQuery(e){return{kind:"MergeQueryNode",into:this.transformNode(e.into),using:this.transformNode(e.using),whens:this.transformNodeList(e.whens),with:this.transformNode(e.with),top:this.transformNode(e.top)}}transformMatched(e){return{kind:"MatchedNode",not:e.not,bySource:e.bySource}}transformAddIndex(e){return{kind:"AddIndexNode",name:this.transformNode(e.name),columns:this.transformNodeList(e.columns),unique:e.unique,using:this.transformNode(e.using),ifNotExists:e.ifNotExists}}transformCast(e){return{kind:"CastNode",expression:this.transformNode(e.expression),dataType:this.transformNode(e.dataType)}}transformFetch(e){return{kind:"FetchNode",rowCount:this.transformNode(e.rowCount),modifier:e.modifier}}transformTop(e){return{kind:"TopNode",expression:e.expression,modifiers:e.modifiers}}transformDataType(e){return e}transformSelectAll(e){return e}transformIdentifier(e){return e}transformValue(e){return e}transformPrimitiveValueList(e){return e}transformOperator(e){return e}transformDefaultInsertValue(e){return e}}mi=new WeakMap;const ROOT_OPERATION_NODES=freeze({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0,MergeQueryNode:!0});var Vr,Nr,br,yi,Xo,Ni,Yo,bi,Zo,Xt,Qr,kn,as,wi,ea;class WithSchemaTransformer extends OperationNodeTransformer{constructor(t){super();g(this,yi);g(this,Ni);g(this,bi);g(this,Xt);g(this,kn);g(this,wi);g(this,Vr,void 0);g(this,Nr,new Set);g(this,br,new Set);x(this,Vr,t)}transformNodeImpl(t){if(!j(this,yi,Xo).call(this,t))return super.transformNodeImpl(t);const n=j(this,bi,Zo).call(this,t);for(const l of n)i(this,br).add(l);const o=j(this,Ni,Yo).call(this,t);for(const l of o)i(this,Nr).add(l);const a=super.transformNodeImpl(t);for(const l of o)i(this,Nr).delete(l);for(const l of n)i(this,br).delete(l);return a}transformSchemableIdentifier(t){const n=super.transformSchemableIdentifier(t);return n.schema||!i(this,Nr).has(t.identifier.name)?n:{...n,schema:IdentifierNode.create(i(this,Vr))}}transformReferences(t){const n=super.transformReferences(t);return n.table.table.schema?n:{...n,table:TableNode.createWithSchema(i(this,Vr),n.table.table.identifier.name)}}}Vr=new WeakMap,Nr=new WeakMap,br=new WeakMap,yi=new WeakSet,Xo=function(t){return t.kind in ROOT_OPERATION_NODES},Ni=new WeakSet,Yo=function(t){const n=new Set;if("name"in t&&t.name&&SchemableIdentifierNode.is(t.name)&&j(this,kn,as).call(this,t.name,n),"from"in t&&t.from)for(const o of t.from.froms)j(this,Xt,Qr).call(this,o,n);if("into"in t&&t.into&&j(this,Xt,Qr).call(this,t.into,n),"table"in t&&t.table&&j(this,Xt,Qr).call(this,t.table,n),"joins"in t&&t.joins)for(const o of t.joins)j(this,Xt,Qr).call(this,o.table,n);return"using"in t&&t.using&&j(this,Xt,Qr).call(this,t.using,n),n},bi=new WeakSet,Zo=function(t){const n=new Set;return"with"in t&&t.with&&j(this,wi,ea).call(this,t.with,n),n},Xt=new WeakSet,Qr=function(t,n){const o=TableNode.is(t)?t:AliasNode.is(t)&&TableNode.is(t.node)?t.node:null;o&&j(this,kn,as).call(this,o.table,n)},kn=new WeakSet,as=function(t,n){const o=t.identifier.name;!i(this,Nr).has(o)&&!i(this,br).has(o)&&n.add(o)},wi=new WeakSet,ea=function(t,n){for(const o of t.expressions){const a=o.name.table.table.identifier.name;i(this,br).has(a)||n.add(a)}};var An;class WithSchemaPlugin{constructor(e){g(this,An,void 0);x(this,An,new WithSchemaTransformer(e))}transformQuery(e){return i(this,An).transformNode(e.node)}async transformResult(e){return e.result}}An=new WeakMap;const MatchedNode=freeze({is(r){return r.kind==="MatchedNode"},create(r,e=!1){return freeze({kind:"MatchedNode",not:r,bySource:e})}});function parseMergeWhen(r,e,t){return WhenNode.create(parseFilterList([MatchedNode.create(!r.isMatched,r.bySource),...e&&e.length>0?[e.length===3&&t?parseReferentialBinaryOperation(e[0],e[1],e[2]):parseValueBinaryOperationOrExpression(e)]:[]],"and",!1))}function parseMergeThen(r){return isString(r)?RawNode.create([r],[]):isOperationNodeSource(r)?r.toOperationNode():r}var Ln,Jr,Hr;class Deferred{constructor(){g(this,Ln,void 0);g(this,Jr,void 0);g(this,Hr,void 0);oe(this,"resolve",e=>{i(this,Jr)&&i(this,Jr).call(this,e)});oe(this,"reject",e=>{i(this,Hr)&&i(this,Hr).call(this,e)});x(this,Ln,new Promise((e,t)=>{x(this,Hr,t),x(this,Jr,e)}))}get promise(){return i(this,Ln)}}Ln=new WeakMap,Jr=new WeakMap,Hr=new WeakMap;const LOGGED_MESSAGES=new Set;function logOnce(r){LOGGED_MESSAGES.has(r)||(LOGGED_MESSAGES.add(r),console.log(r))}const NO_PLUGINS=freeze([]);var wr,qn,us;class QueryExecutorBase{constructor(e=NO_PLUGINS){g(this,qn);g(this,wr,void 0);x(this,wr,e)}get plugins(){return i(this,wr)}transformQuery(e,t){for(const n of i(this,wr)){const o=n.transformQuery({node:e,queryId:t});if(o.kind===e.kind)e=o;else throw new Error(["KyselyPlugin.transformQuery must return a node","of the same kind that was given to it.",`The plugin was given a ${e.kind}`,`but it returned a ${o.kind}`].join(" "))}return e}async executeQuery(e,t){return await this.provideConnection(async n=>{const o=await n.executeQuery(e),a=await j(this,qn,us).call(this,o,t);return warnOfOutdatedDriverOrPlugins(o,a),a})}async*stream(e,t,n){const o=new Deferred,a=new Deferred;this.provideConnection(async d=>(o.resolve(d),await a.promise)).catch(d=>o.reject(d));const l=await o.promise;try{for await(const d of l.streamQuery(e,t))yield await j(this,qn,us).call(this,d,n)}finally{a.resolve()}}}wr=new WeakMap,qn=new WeakSet,us=async function(e,t){for(const n of i(this,wr))e=await n.transformResult({result:e,queryId:t});return e};function warnOfOutdatedDriverOrPlugins(r,e){const{numAffectedRows:t}=r;t===void 0&&r.numUpdatedOrDeletedRows===void 0||t!==void 0&&e.numAffectedRows!==void 0||logOnce("kysely:warning: outdated driver/plugin detected! QueryResult.numUpdatedOrDeletedRows is deprecated and will be removed in a future release.")}class NoopQueryExecutor extends QueryExecutorBase{get adapter(){throw new Error("this query cannot be compiled to SQL")}compileQuery(){throw new Error("this query cannot be compiled to SQL")}provideConnection(){throw new Error("this query cannot be executed")}withConnectionProvider(){throw new Error("this query cannot have a connection provider")}withPlugin(e){return new NoopQueryExecutor([...this.plugins,e])}withPlugins(e){return new NoopQueryExecutor([...this.plugins,...e])}withPluginAtFront(e){return new NoopQueryExecutor([e,...this.plugins])}withoutPlugins(){return new NoopQueryExecutor([])}}const NOOP_QUERY_EXECUTOR=new NoopQueryExecutor;class MergeResult{constructor(e){oe(this,"numChangedRows");this.numChangedRows=e}}var Yt;const ms=class ms{constructor(e){g(this,Yt,void 0);x(this,Yt,freeze(e))}top(e,t){return new ms({...i(this,Yt),queryNode:QueryNode.cloneWithTop(i(this,Yt).queryNode,parseTop(e,t))})}using(...e){return new WheneableMergeQueryBuilder({...i(this,Yt),queryNode:MergeQueryNode.cloneWithUsing(i(this,Yt).queryNode,parseJoin("Using",e))})}};Yt=new WeakMap;let MergeQueryBuilder=ms;preventAwait(MergeQueryBuilder,"don't await MergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");var Qe,jr,di,Wt,dr;const Ei=class Ei{constructor(e){g(this,jr);g(this,Wt);g(this,Qe,void 0);x(this,Qe,freeze(e))}top(e,t){return new Ei({...i(this,Qe),queryNode:QueryNode.cloneWithTop(i(this,Qe).queryNode,parseTop(e,t))})}whenMatched(){return j(this,jr,di).call(this,[])}whenMatchedAnd(...e){return j(this,jr,di).call(this,e)}whenMatchedAndRef(e,t,n){return j(this,jr,di).call(this,[e,t,n],!0)}whenNotMatched(){return j(this,Wt,dr).call(this,[])}whenNotMatchedAnd(...e){return j(this,Wt,dr).call(this,e)}whenNotMatchedAndRef(e,t,n){return j(this,Wt,dr).call(this,[e,t,n],!0)}whenNotMatchedBySource(){return j(this,Wt,dr).call(this,[],!1,!0)}whenNotMatchedBySourceAnd(...e){return j(this,Wt,dr).call(this,e,!1,!0)}whenNotMatchedBySourceAndRef(e,t,n){return j(this,Wt,dr).call(this,[e,t,n],!0,!0)}$call(e){return e(this)}$if(e,t){return e?t(this):new Ei({...i(this,Qe)})}toOperationNode(){return i(this,Qe).executor.transformQuery(i(this,Qe).queryNode,i(this,Qe).queryId)}compile(){return i(this,Qe).executor.compileQuery(i(this,Qe).queryNode,i(this,Qe).queryId)}async execute(){const e=this.compile(),t=await i(this,Qe).executor.executeQuery(e,i(this,Qe).queryId);return[new MergeResult(t.numAffectedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}};Qe=new WeakMap,jr=new WeakSet,di=function(e,t){return new MatchedThenableMergeQueryBuilder({...i(this,Qe),queryNode:MergeQueryNode.cloneWithWhen(i(this,Qe).queryNode,parseMergeWhen({isMatched:!0},e,t))})},Wt=new WeakSet,dr=function(e,t=!1,n=!1){const o={...i(this,Qe),queryNode:MergeQueryNode.cloneWithWhen(i(this,Qe).queryNode,parseMergeWhen({isMatched:!1,bySource:n},e,t))},a=n?MatchedThenableMergeQueryBuilder:NotMatchedThenableMergeQueryBuilder;return new a(o)};let WheneableMergeQueryBuilder=Ei;preventAwait(WheneableMergeQueryBuilder,"don't await WheneableMergeQueryBuilder instances directly. To execute the query you need to call `execute`.");var Et;class MatchedThenableMergeQueryBuilder{constructor(e){g(this,Et,void 0);x(this,Et,freeze(e))}thenDelete(){return new WheneableMergeQueryBuilder({...i(this,Et),queryNode:MergeQueryNode.cloneWithThen(i(this,Et).queryNode,parseMergeThen("delete"))})}thenDoNothing(){return new WheneableMergeQueryBuilder({...i(this,Et),queryNode:MergeQueryNode.cloneWithThen(i(this,Et).queryNode,parseMergeThen("do nothing"))})}thenUpdate(e){return new WheneableMergeQueryBuilder({...i(this,Et),queryNode:MergeQueryNode.cloneWithThen(i(this,Et).queryNode,parseMergeThen(e(new UpdateQueryBuilder({queryId:i(this,Et).queryId,executor:NOOP_QUERY_EXECUTOR,queryNode:UpdateQueryNode.createWithoutTable()}))))})}thenUpdateSet(...e){return this.thenUpdate(t=>t.set(...e))}}Et=new WeakMap;preventAwait(MatchedThenableMergeQueryBuilder,"don't await MatchedThenableMergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");var Zt;class NotMatchedThenableMergeQueryBuilder{constructor(e){g(this,Zt,void 0);x(this,Zt,freeze(e))}thenDoNothing(){return new WheneableMergeQueryBuilder({...i(this,Zt),queryNode:MergeQueryNode.cloneWithThen(i(this,Zt).queryNode,parseMergeThen("do nothing"))})}thenInsertValues(e){const[t,n]=parseInsertExpression(e);return new WheneableMergeQueryBuilder({...i(this,Zt),queryNode:MergeQueryNode.cloneWithThen(i(this,Zt).queryNode,parseMergeThen(InsertQueryNode.cloneWith(InsertQueryNode.createWithoutInto(),{columns:t,values:n})))})}}Zt=new WeakMap;preventAwait(NotMatchedThenableMergeQueryBuilder,"don't await NotMatchedThenableMergeQueryBuilder instances directly. To execute the query you need to call `execute` when available.");var he;const fr=class fr{constructor(e){g(this,he,void 0);x(this,he,freeze(e))}selectFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:i(this,he).executor,queryNode:SelectQueryNode.createFrom(parseTableExpressionOrList(e),i(this,he).withNode)})}selectNoFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:i(this,he).executor,queryNode:SelectQueryNode.cloneWithSelections(SelectQueryNode.create(i(this,he).withNode),parseSelectArg(e))})}insertInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:i(this,he).executor,queryNode:InsertQueryNode.create(parseTable(e),i(this,he).withNode)})}replaceInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:i(this,he).executor,queryNode:InsertQueryNode.create(parseTable(e),i(this,he).withNode,!0)})}deleteFrom(e){return new DeleteQueryBuilder({queryId:createQueryId(),executor:i(this,he).executor,queryNode:DeleteQueryNode.create(parseTableExpressionOrList(e),i(this,he).withNode)})}updateTable(e){return new UpdateQueryBuilder({queryId:createQueryId(),executor:i(this,he).executor,queryNode:UpdateQueryNode.create(parseTableExpression(e),i(this,he).withNode)})}mergeInto(e){return new MergeQueryBuilder({queryId:createQueryId(),executor:i(this,he).executor,queryNode:MergeQueryNode.create(parseAliasedTable(e),i(this,he).withNode)})}with(e,t){const n=parseCommonTableExpression(e,t);return new fr({...i(this,he),withNode:i(this,he).withNode?WithNode.cloneWithExpression(i(this,he).withNode,n):WithNode.create(n)})}withRecursive(e,t){const n=parseCommonTableExpression(e,t);return new fr({...i(this,he),withNode:i(this,he).withNode?WithNode.cloneWithExpression(i(this,he).withNode,n):WithNode.create(n,{recursive:!0})})}withPlugin(e){return new fr({...i(this,he),executor:i(this,he).executor.withPlugin(e)})}withoutPlugins(){return new fr({...i(this,he),executor:i(this,he).executor.withoutPlugins()})}withSchema(e){return new fr({...i(this,he),executor:i(this,he).executor.withPluginAtFront(new WithSchemaPlugin(e))})}};he=new WeakMap;let QueryCreator=fr;function createQueryCreator(){return new QueryCreator({executor:NOOP_QUERY_EXECUTOR})}function createJoinBuilder(r,e){return new JoinBuilder({joinNode:JoinNode.create(r,parseTableExpression(e))})}function createOverBuilder(){return new OverBuilder({overNode:OverNode.create()})}function parseJoin(r,e){if(e.length===3)return parseSingleOnJoin(r,e[0],e[1],e[2]);if(e.length===2)return parseCallbackJoin(r,e[0],e[1]);throw new Error("not implemented")}function parseCallbackJoin(r,e,t){return t(createJoinBuilder(r,e)).toOperationNode()}function parseSingleOnJoin(r,e,t,n){return JoinNode.createWithOn(r,parseTableExpression(e),parseReferentialBinaryOperation(t,"=",n))}const OffsetNode=freeze({is(r){return r.kind==="OffsetNode"},create(r){return freeze({kind:"OffsetNode",offset:r})}}),GroupByItemNode=freeze({is(r){return r.kind==="GroupByItemNode"},create(r){return freeze({kind:"GroupByItemNode",groupBy:r})}});function parseGroupBy(r){return r=isFunction(r)?r(expressionBuilder()):r,parseReferenceExpressionOrList(r).map(GroupByItemNode.create)}const SetOperationNode=freeze({is(r){return r.kind==="SetOperationNode"},create(r,e,t){return freeze({kind:"SetOperationNode",operator:r,expression:e,all:t})}});function parseSetOperations(r,e,t){return isFunction(e)&&(e=e(createExpressionBuilder())),isReadonlyArray(e)||(e=[e]),e.map(n=>SetOperationNode.create(r,parseExpression(n),t))}var Dt;const _i=class _i{constructor(e){g(this,Dt,void 0);x(this,Dt,e)}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new OrWrapper(OrNode.create(i(this,Dt),parseValueBinaryOperationOrExpression(e)))}and(...e){return new AndWrapper(AndNode.create(i(this,Dt),parseValueBinaryOperationOrExpression(e)))}$castTo(){return new _i(i(this,Dt))}$notNull(){return new _i(i(this,Dt))}toOperationNode(){return i(this,Dt)}};Dt=new WeakMap;let ExpressionWrapper=_i;var Kr,er;class AliasedExpressionWrapper{constructor(e,t){g(this,Kr,void 0);g(this,er,void 0);x(this,Kr,e),x(this,er,t)}get expression(){return i(this,Kr)}get alias(){return i(this,er)}toOperationNode(){return AliasNode.create(i(this,Kr).toOperationNode(),isOperationNodeSource(i(this,er))?i(this,er).toOperationNode():IdentifierNode.create(i(this,er)))}}Kr=new WeakMap,er=new WeakMap;var Er;const gi=class gi{constructor(e){g(this,Er,void 0);x(this,Er,e)}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new gi(OrNode.create(i(this,Er),parseValueBinaryOperationOrExpression(e)))}$castTo(){return new gi(i(this,Er))}toOperationNode(){return ParensNode.create(i(this,Er))}};Er=new WeakMap;let OrWrapper=gi;var _r;const Oi=class Oi{constructor(e){g(this,_r,void 0);x(this,_r,e)}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}and(...e){return new Oi(AndNode.create(i(this,_r),parseValueBinaryOperationOrExpression(e)))}$castTo(){return new Oi(i(this,_r))}toOperationNode(){return ParensNode.create(i(this,_r))}};_r=new WeakMap;let AndWrapper=Oi;const FetchNode={is(r){return r.kind==="FetchNode"},create(r,e){return{kind:"FetchNode",rowCount:ValueNode.create(r),modifier:e}}};function parseFetch(r,e){if(!isNumber(r)&&!isBigInt(r))throw new Error(`Invalid fetch row count: ${r}`);if(!isFetchModifier(e))throw new Error(`Invalid fetch modifier: ${e}`);return FetchNode.create(r,e)}function isFetchModifier(r){return r==="only"||r==="with ties"}var D;const Z=class Z{constructor(e){g(this,D,void 0);x(this,D,freeze(e))}get expressionType(){}get isSelectQueryBuilder(){return!0}where(...e){return new Z({...i(this,D),queryNode:QueryNode.cloneWithWhere(i(this,D).queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,n){return new Z({...i(this,D),queryNode:QueryNode.cloneWithWhere(i(this,D).queryNode,parseReferentialBinaryOperation(e,t,n))})}having(...e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithHaving(i(this,D).queryNode,parseValueBinaryOperationOrExpression(e))})}havingRef(e,t,n){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithHaving(i(this,D).queryNode,parseReferentialBinaryOperation(e,t,n))})}select(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithSelections(i(this,D).queryNode,parseSelectArg(e))})}distinctOn(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithDistinctOn(i(this,D).queryNode,parseReferenceExpressionOrList(e))})}modifyFront(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithFrontModifier(i(this,D).queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}modifyEnd(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,D).queryNode,SelectModifierNode.createWithExpression(e.toOperationNode()))})}distinct(){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithFrontModifier(i(this,D).queryNode,SelectModifierNode.create("Distinct"))})}forUpdate(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,D).queryNode,SelectModifierNode.create("ForUpdate",e?asArray(e).map(parseTable):void 0))})}forShare(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,D).queryNode,SelectModifierNode.create("ForShare",e?asArray(e).map(parseTable):void 0))})}forKeyShare(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,D).queryNode,SelectModifierNode.create("ForKeyShare",e?asArray(e).map(parseTable):void 0))})}forNoKeyUpdate(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,D).queryNode,SelectModifierNode.create("ForNoKeyUpdate",e?asArray(e).map(parseTable):void 0))})}skipLocked(){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,D).queryNode,SelectModifierNode.create("SkipLocked"))})}noWait(){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithEndModifier(i(this,D).queryNode,SelectModifierNode.create("NoWait"))})}selectAll(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithSelections(i(this,D).queryNode,parseSelectAll(e))})}innerJoin(...e){return new Z({...i(this,D),queryNode:QueryNode.cloneWithJoin(i(this,D).queryNode,parseJoin("InnerJoin",e))})}leftJoin(...e){return new Z({...i(this,D),queryNode:QueryNode.cloneWithJoin(i(this,D).queryNode,parseJoin("LeftJoin",e))})}rightJoin(...e){return new Z({...i(this,D),queryNode:QueryNode.cloneWithJoin(i(this,D).queryNode,parseJoin("RightJoin",e))})}fullJoin(...e){return new Z({...i(this,D),queryNode:QueryNode.cloneWithJoin(i(this,D).queryNode,parseJoin("FullJoin",e))})}innerJoinLateral(...e){return new Z({...i(this,D),queryNode:QueryNode.cloneWithJoin(i(this,D).queryNode,parseJoin("LateralInnerJoin",e))})}leftJoinLateral(...e){return new Z({...i(this,D),queryNode:QueryNode.cloneWithJoin(i(this,D).queryNode,parseJoin("LateralLeftJoin",e))})}orderBy(...e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithOrderByItems(i(this,D).queryNode,parseOrderBy(e))})}groupBy(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithGroupByItems(i(this,D).queryNode,parseGroupBy(e))})}limit(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithLimit(i(this,D).queryNode,LimitNode.create(parseValueExpression(e)))})}offset(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithOffset(i(this,D).queryNode,OffsetNode.create(parseValueExpression(e)))})}fetch(e,t="only"){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithFetch(i(this,D).queryNode,parseFetch(e,t))})}top(e,t){return new Z({...i(this,D),queryNode:QueryNode.cloneWithTop(i(this,D).queryNode,parseTop(e,t))})}union(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithSetOperations(i(this,D).queryNode,parseSetOperations("union",e,!1))})}unionAll(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithSetOperations(i(this,D).queryNode,parseSetOperations("union",e,!0))})}intersect(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithSetOperations(i(this,D).queryNode,parseSetOperations("intersect",e,!1))})}intersectAll(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithSetOperations(i(this,D).queryNode,parseSetOperations("intersect",e,!0))})}except(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithSetOperations(i(this,D).queryNode,parseSetOperations("except",e,!1))})}exceptAll(e){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithSetOperations(i(this,D).queryNode,parseSetOperations("except",e,!0))})}as(e){return new AliasedSelectQueryBuilderImpl(this,e)}clearSelect(){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithoutSelections(i(this,D).queryNode)})}clearWhere(){return new Z({...i(this,D),queryNode:QueryNode.cloneWithoutWhere(i(this,D).queryNode)})}clearLimit(){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithoutLimit(i(this,D).queryNode)})}clearOffset(){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithoutOffset(i(this,D).queryNode)})}clearOrderBy(){return new Z({...i(this,D),queryNode:SelectQueryNode.cloneWithoutOrderBy(i(this,D).queryNode)})}$call(e){return e(this)}$if(e,t){return e?t(this):new Z({...i(this,D)})}$castTo(){return new Z(i(this,D))}$narrowType(){return new Z(i(this,D))}$assertType(){return new Z(i(this,D))}$asTuple(){return new ExpressionWrapper(this.toOperationNode())}withPlugin(e){return new Z({...i(this,D),executor:i(this,D).executor.withPlugin(e)})}toOperationNode(){return i(this,D).executor.transformQuery(i(this,D).queryNode,i(this,D).queryId)}compile(){return i(this,D).executor.compileQuery(this.toOperationNode(),i(this,D).queryId)}async execute(){const e=this.compile();return(await i(this,D).executor.executeQuery(e,i(this,D).queryId)).rows}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(t===void 0)throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode());return t}async*stream(e=100){const t=this.compile(),n=i(this,D).executor.stream(t,e,i(this,D).queryId);for await(const o of n)yield*o.rows}async explain(e,t){return await new Z({...i(this,D),queryNode:QueryNode.cloneWithExplain(i(this,D).queryNode,e,t)}).execute()}};D=new WeakMap;let SelectQueryBuilderImpl=Z;preventAwait(SelectQueryBuilderImpl,"don't await SelectQueryBuilder instances directly. To execute the query you need to call `execute` or `executeTakeFirst`.");function createSelectQueryBuilder(r){return new SelectQueryBuilderImpl(r)}var Gr,Xr;class AliasedSelectQueryBuilderImpl{constructor(e,t){g(this,Gr,void 0);g(this,Xr,void 0);x(this,Gr,e),x(this,Xr,t)}get expression(){return i(this,Gr)}get alias(){return i(this,Xr)}get isAliasedSelectQueryBuilder(){return!0}toOperationNode(){return AliasNode.create(i(this,Gr).toOperationNode(),IdentifierNode.create(i(this,Xr)))}}Gr=new WeakMap,Xr=new WeakMap;preventAwait(AliasedSelectQueryBuilderImpl,"don't await AliasedSelectQueryBuilder instances directly. AliasedSelectQueryBuilder should never be executed directly since it's always a part of another query.");const AggregateFunctionNode=freeze({is(r){return r.kind==="AggregateFunctionNode"},create(r,e=[]){return freeze({kind:"AggregateFunctionNode",func:r,aggregated:e})},cloneWithDistinct(r){return freeze({...r,distinct:!0})},cloneWithFilter(r,e){return freeze({...r,filter:r.filter?WhereNode.cloneWithOperation(r.filter,"And",e):WhereNode.create(e)})},cloneWithOrFilter(r,e){return freeze({...r,filter:r.filter?WhereNode.cloneWithOperation(r.filter,"Or",e):WhereNode.create(e)})},cloneWithOver(r,e){return freeze({...r,over:e})}}),FunctionNode=freeze({is(r){return r.kind==="FunctionNode"},create(r,e){return freeze({kind:"FunctionNode",func:r,arguments:e})}});var rt;const Kt=class Kt{constructor(e){g(this,rt,void 0);x(this,rt,freeze(e))}get expressionType(){}as(e){return new AliasedAggregateFunctionBuilder(this,e)}distinct(){return new Kt({...i(this,rt),aggregateFunctionNode:AggregateFunctionNode.cloneWithDistinct(i(this,rt).aggregateFunctionNode)})}filterWhere(...e){return new Kt({...i(this,rt),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,rt).aggregateFunctionNode,parseValueBinaryOperationOrExpression(e))})}filterWhereRef(e,t,n){return new Kt({...i(this,rt),aggregateFunctionNode:AggregateFunctionNode.cloneWithFilter(i(this,rt).aggregateFunctionNode,parseReferentialBinaryOperation(e,t,n))})}over(e){const t=createOverBuilder();return new Kt({...i(this,rt),aggregateFunctionNode:AggregateFunctionNode.cloneWithOver(i(this,rt).aggregateFunctionNode,(e?e(t):t).toOperationNode())})}$call(e){return e(this)}$castTo(){return new Kt(i(this,rt))}$notNull(){return new Kt(i(this,rt))}toOperationNode(){return i(this,rt).aggregateFunctionNode}};rt=new WeakMap;let AggregateFunctionBuilder=Kt;preventAwait(AggregateFunctionBuilder,"don't await AggregateFunctionBuilder instances. They are never executed directly and are always just a part of a query.");var Yr,Zr;class AliasedAggregateFunctionBuilder{constructor(e,t){g(this,Yr,void 0);g(this,Zr,void 0);x(this,Yr,e),x(this,Zr,t)}get expression(){return i(this,Yr)}get alias(){return i(this,Zr)}toOperationNode(){return AliasNode.create(i(this,Yr).toOperationNode(),IdentifierNode.create(i(this,Zr)))}}Yr=new WeakMap,Zr=new WeakMap;function createFunctionModule(){const r=(t,n)=>new ExpressionWrapper(FunctionNode.create(t,parseReferenceExpressionOrList(n??[]))),e=(t,n)=>new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create(t,n?parseReferenceExpressionOrList(n):void 0)});return Object.assign(r,{agg:e,avg(t){return e("avg",[t])},coalesce(...t){return r("coalesce",t)},count(t){return e("count",[t])},countAll(t){return new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create("count",parseSelectAll(t))})},max(t){return e("max",[t])},min(t){return e("min",[t])},sum(t){return e("sum",[t])},any(t){return r("any",[t])},jsonAgg(t){return new AggregateFunctionBuilder({aggregateFunctionNode:AggregateFunctionNode.create("json_agg",[isString(t)?parseTable(t):t.toOperationNode()])})},toJson(t){return new ExpressionWrapper(FunctionNode.create("to_json",[isString(t)?parseTable(t):t.toOperationNode()]))}})}const UnaryOperationNode=freeze({is(r){return r.kind==="UnaryOperationNode"},create(r,e){return freeze({kind:"UnaryOperationNode",operator:r,operand:e})}});function parseUnaryOperation(r,e){return UnaryOperationNode.create(OperatorNode.create(r),parseReferenceExpression(e))}const CaseNode=freeze({is(r){return r.kind==="CaseNode"},create(r){return freeze({kind:"CaseNode",value:r})},cloneWithWhen(r,e){return freeze({...r,when:freeze(r.when?[...r.when,e]:[e])})},cloneWithThen(r,e){return freeze({...r,when:r.when?freeze([...r.when.slice(0,-1),WhenNode.cloneWithResult(r.when[r.when.length-1],e)]):void 0})},cloneWith(r,e){return freeze({...r,...e})}});var en;class CaseBuilder{constructor(e){g(this,en,void 0);x(this,en,freeze(e))}when(...e){return new CaseThenBuilder({...i(this,en),node:CaseNode.cloneWithWhen(i(this,en).node,WhenNode.create(parseValueBinaryOperationOrExpression(e)))})}}en=new WeakMap;var tn;class CaseThenBuilder{constructor(e){g(this,tn,void 0);x(this,tn,freeze(e))}then(e){return new CaseWhenBuilder({...i(this,tn),node:CaseNode.cloneWithThen(i(this,tn).node,isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e))})}}tn=new WeakMap;var Rt;class CaseWhenBuilder{constructor(e){g(this,Rt,void 0);x(this,Rt,freeze(e))}when(...e){return new CaseThenBuilder({...i(this,Rt),node:CaseNode.cloneWithWhen(i(this,Rt).node,WhenNode.create(parseValueBinaryOperationOrExpression(e)))})}else(e){return new CaseEndBuilder({...i(this,Rt),node:CaseNode.cloneWith(i(this,Rt).node,{else:isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e)})})}end(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,Rt).node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,Rt).node,{isStatement:!0}))}}Rt=new WeakMap;var rn;class CaseEndBuilder{constructor(e){g(this,rn,void 0);x(this,rn,freeze(e))}end(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,rn).node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(CaseNode.cloneWith(i(this,rn).node,{isStatement:!0}))}}rn=new WeakMap;const JSONPathLegNode=freeze({is(r){return r.kind==="JSONPathLegNode"},create(r,e){return freeze({kind:"JSONPathLegNode",type:r,value:e})}});var xt,Wn,ls;class JSONPathBuilder{constructor(e){g(this,Wn);g(this,xt,void 0);x(this,xt,e)}at(e){return j(this,Wn,ls).call(this,"ArrayLocation",e)}key(e){return j(this,Wn,ls).call(this,"Member",e)}}xt=new WeakMap,Wn=new WeakSet,ls=function(e,t){return JSONReferenceNode.is(i(this,xt))?new TraversedJSONPathBuilder(JSONReferenceNode.cloneWithTraversal(i(this,xt),JSONPathNode.is(i(this,xt).traversal)?JSONPathNode.cloneWithLeg(i(this,xt).traversal,JSONPathLegNode.create(e,t)):JSONOperatorChainNode.cloneWithValue(i(this,xt).traversal,ValueNode.createImmediate(t)))):new TraversedJSONPathBuilder(JSONPathNode.cloneWithLeg(i(this,xt),JSONPathLegNode.create(e,t)))};var gr;class TraversedJSONPathBuilder extends JSONPathBuilder{constructor(t){super(t);g(this,gr,void 0);x(this,gr,t)}get expressionType(){}as(t){return new AliasedJSONPathBuilder(this,t)}$castTo(){return new JSONPathBuilder(i(this,gr))}$notNull(){return new JSONPathBuilder(i(this,gr))}toOperationNode(){return i(this,gr)}}gr=new WeakMap;var nn,tr;class AliasedJSONPathBuilder{constructor(e,t){g(this,nn,void 0);g(this,tr,void 0);x(this,nn,e),x(this,tr,t)}get expression(){return i(this,nn)}get alias(){return i(this,tr)}toOperationNode(){return AliasNode.create(i(this,nn).toOperationNode(),isOperationNodeSource(i(this,tr))?i(this,tr).toOperationNode():IdentifierNode.create(i(this,tr)))}}nn=new WeakMap,tr=new WeakMap;const TupleNode=freeze({is(r){return r.kind==="TupleNode"},create(r){return freeze({kind:"TupleNode",values:freeze(r)})}}),SIMPLE_COLUMN_DATA_TYPES=["varchar","char","text","integer","int2","int4","int8","smallint","bigint","boolean","real","double precision","float4","float8","decimal","numeric","binary","bytea","date","datetime","time","timetz","timestamp","timestamptz","serial","bigserial","uuid","json","jsonb","blob"],COLUMN_DATA_TYPE_REGEX=[/^varchar\(\d+\)$/,/^char\(\d+\)$/,/^decimal\(\d+, \d+\)$/,/^numeric\(\d+, \d+\)$/,/^binary\(\d+\)$/,/^datetime\(\d+\)$/,/^time\(\d+\)$/,/^timez\(\d+\)$/,/^timestamp\(\d+\)$/,/^timestamptz\(\d+\)$/],DataTypeNode=freeze({is(r){return r.kind==="DataTypeNode"},create(r){return freeze({kind:"DataTypeNode",dataType:r})}});function isColumnDataType(r){return!!(SIMPLE_COLUMN_DATA_TYPES.includes(r)||COLUMN_DATA_TYPE_REGEX.some(e=>e.test(r)))}function parseDataTypeExpression(r){if(isOperationNodeSource(r))return r.toOperationNode();if(isColumnDataType(r))return DataTypeNode.create(r);throw new Error(`invalid column data type ${JSON.stringify(r)}`)}const CastNode=freeze({is(r){return r.kind==="CastNode"},create(r,e){return freeze({kind:"CastNode",expression:r,dataType:e})}});function createExpressionBuilder(r=NOOP_QUERY_EXECUTOR){function e(o,a,l){return new ExpressionWrapper(parseValueBinaryOperation(o,a,l))}function t(o,a){return new ExpressionWrapper(parseUnaryOperation(o,a))}const n=Object.assign(e,{fn:void 0,eb:void 0,selectFrom(o){return createSelectQueryBuilder({queryId:createQueryId(),executor:r,queryNode:SelectQueryNode.createFrom(parseTableExpressionOrList(o))})},case(o){return new CaseBuilder({node:CaseNode.create(isUndefined(o)?void 0:parseReferenceExpression(o))})},ref(o,a){return isUndefined(a)?new ExpressionWrapper(parseStringReference(o)):new JSONPathBuilder(parseJSONReference(o,a))},jsonPath(){return new JSONPathBuilder(JSONPathNode.create())},table(o){return new ExpressionWrapper(parseTable(o))},val(o){return new ExpressionWrapper(parseValueExpression(o))},refTuple(...o){return new ExpressionWrapper(TupleNode.create(o.map(parseReferenceExpression)))},tuple(...o){return new ExpressionWrapper(TupleNode.create(o.map(parseValueExpression)))},lit(o){return new ExpressionWrapper(parseSafeImmediateValue(o))},unary:t,not(o){return t("not",o)},exists(o){return t("exists",o)},neg(o){return t("-",o)},between(o,a,l){return new ExpressionWrapper(BinaryOperationNode.create(parseReferenceExpression(o),OperatorNode.create("between"),AndNode.create(parseValueExpression(a),parseValueExpression(l))))},betweenSymmetric(o,a,l){return new ExpressionWrapper(BinaryOperationNode.create(parseReferenceExpression(o),OperatorNode.create("between symmetric"),AndNode.create(parseValueExpression(a),parseValueExpression(l))))},and(o){return isReadonlyArray(o)?new ExpressionWrapper(parseFilterList(o,"and")):new ExpressionWrapper(parseFilterObject(o,"and"))},or(o){return isReadonlyArray(o)?new ExpressionWrapper(parseFilterList(o,"or")):new ExpressionWrapper(parseFilterObject(o,"or"))},parens(...o){const a=parseValueBinaryOperationOrExpression(o);return ParensNode.is(a)?new ExpressionWrapper(a):new ExpressionWrapper(ParensNode.create(a))},cast(o,a){return new ExpressionWrapper(CastNode.create(parseReferenceExpression(o),parseDataTypeExpression(a)))},withSchema(o){return createExpressionBuilder(r.withPluginAtFront(new WithSchemaPlugin(o)))}});return n.fn=createFunctionModule(),n.eb=n,n}function expressionBuilder(r){return createExpressionBuilder()}function parseExpression(r){if(isOperationNodeSource(r))return r.toOperationNode();if(isFunction(r))return r(expressionBuilder()).toOperationNode();throw new Error(`invalid expression: ${JSON.stringify(r)}`)}function parseAliasedExpression(r){if(isOperationNodeSource(r))return r.toOperationNode();if(isFunction(r))return r(expressionBuilder()).toOperationNode();throw new Error(`invalid aliased expression: ${JSON.stringify(r)}`)}function isExpressionOrFactory(r){return isExpression(r)||isAliasedExpression(r)||isFunction(r)}function parseTableExpressionOrList(r){return isReadonlyArray(r)?r.map(e=>parseTableExpression(e)):[parseTableExpression(r)]}function parseTableExpression(r){return isString(r)?parseAliasedTable(r):parseAliasedExpression(r)}function parseAliasedTable(r){const e=" as ";if(r.includes(e)){const[t,n]=r.split(e).map(trim$1);return AliasNode.create(parseTable(t),IdentifierNode.create(n))}else return parseTable(r)}function parseTable(r){const e=".";if(r.includes(e)){const[t,n]=r.split(e).map(trim$1);return TableNode.createWithSchema(t,n)}else return TableNode.create(r)}function trim$1(r){return r.trim()}const AddColumnNode=freeze({is(r){return r.kind==="AddColumnNode"},create(r){return freeze({kind:"AddColumnNode",column:r})}}),ColumnDefinitionNode=freeze({is(r){return r.kind==="ColumnDefinitionNode"},create(r,e){return freeze({kind:"ColumnDefinitionNode",column:ColumnNode.create(r),dataType:e})},cloneWithFrontModifier(r,e){return freeze({...r,frontModifiers:r.frontModifiers?freeze([...r.frontModifiers,e]):[e]})},cloneWithEndModifier(r,e){return freeze({...r,endModifiers:r.endModifiers?freeze([...r.endModifiers,e]):[e]})},cloneWith(r,e){return freeze({...r,...e})}}),DropColumnNode=freeze({is(r){return r.kind==="DropColumnNode"},create(r){return freeze({kind:"DropColumnNode",column:ColumnNode.create(r)})}}),RenameColumnNode=freeze({is(r){return r.kind==="RenameColumnNode"},create(r,e){return freeze({kind:"RenameColumnNode",column:ColumnNode.create(r),renameTo:ColumnNode.create(e)})}}),CheckConstraintNode=freeze({is(r){return r.kind==="CheckConstraintNode"},create(r,e){return freeze({kind:"CheckConstraintNode",expression:r,name:e?IdentifierNode.create(e):void 0})}}),ON_MODIFY_FOREIGN_ACTIONS=["no action","restrict","cascade","set null","set default"],ReferencesNode=freeze({is(r){return r.kind==="ReferencesNode"},create(r,e){return freeze({kind:"ReferencesNode",table:r,columns:freeze([...e])})},cloneWithOnDelete(r,e){return freeze({...r,onDelete:e})},cloneWithOnUpdate(r,e){return freeze({...r,onUpdate:e})}});function parseDefaultValueExpression(r){return isOperationNodeSource(r)?r.toOperationNode():ValueNode.createImmediate(r)}const GeneratedNode=freeze({is(r){return r.kind==="GeneratedNode"},create(r){return freeze({kind:"GeneratedNode",...r})},createWithExpression(r){return freeze({kind:"GeneratedNode",always:!0,expression:r})},cloneWith(r,e){return freeze({...r,...e})}}),DefaultValueNode=freeze({is(r){return r.kind==="DefaultValueNode"},create(r){return freeze({kind:"DefaultValueNode",defaultValue:r})}});function parseOnModifyForeignAction(r){if(ON_MODIFY_FOREIGN_ACTIONS.includes(r))return r;throw new Error(`invalid OnModifyForeignAction ${r}`)}var ye;const De=class De{constructor(e){g(this,ye,void 0);x(this,ye,e)}autoIncrement(){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{autoIncrement:!0}))}identity(){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{identity:!0}))}primaryKey(){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{primaryKey:!0}))}references(e){const t=parseStringReference(e);if(!t.table||SelectAllNode.is(t.column))throw new Error(`invalid call references('${e}'). The reference must have format table.column or schema.table.column`);return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{references:ReferencesNode.create(t.table,[t.column])}))}onDelete(e){if(!i(this,ye).references)throw new Error("on delete constraint can only be added for foreign keys");return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{references:ReferencesNode.cloneWithOnDelete(i(this,ye).references,parseOnModifyForeignAction(e))}))}onUpdate(e){if(!i(this,ye).references)throw new Error("on update constraint can only be added for foreign keys");return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{references:ReferencesNode.cloneWithOnUpdate(i(this,ye).references,parseOnModifyForeignAction(e))}))}unique(){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{unique:!0}))}notNull(){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{notNull:!0}))}unsigned(){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{unsigned:!0}))}defaultTo(e){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{defaultTo:DefaultValueNode.create(parseDefaultValueExpression(e))}))}check(e){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{check:CheckConstraintNode.create(e.toOperationNode())}))}generatedAlwaysAs(e){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{generated:GeneratedNode.createWithExpression(e.toOperationNode())}))}generatedAlwaysAsIdentity(){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{generated:GeneratedNode.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{generated:GeneratedNode.create({identity:!0,byDefault:!0})}))}stored(){if(!i(this,ye).generated)throw new Error("stored() can only be called after generatedAlwaysAs");return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{generated:GeneratedNode.cloneWith(i(this,ye).generated,{stored:!0})}))}modifyFront(e){return new De(ColumnDefinitionNode.cloneWithFrontModifier(i(this,ye),e.toOperationNode()))}nullsNotDistinct(){return new De(ColumnDefinitionNode.cloneWith(i(this,ye),{nullsNotDistinct:!0}))}modifyEnd(e){return new De(ColumnDefinitionNode.cloneWithEndModifier(i(this,ye),e.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return i(this,ye)}};ye=new WeakMap;let ColumnDefinitionBuilder=De;preventAwait(ColumnDefinitionBuilder,"don't await ColumnDefinitionBuilder instances directly.");const ModifyColumnNode=freeze({is(r){return r.kind==="ModifyColumnNode"},create(r){return freeze({kind:"ModifyColumnNode",column:r})}}),ForeignKeyConstraintNode=freeze({is(r){return r.kind==="ForeignKeyConstraintNode"},create(r,e,t,n){return freeze({kind:"ForeignKeyConstraintNode",columns:r,references:ReferencesNode.create(e,t),name:n?IdentifierNode.create(n):void 0})},cloneWith(r,e){return freeze({...r,...e})}});var Or;const Ti=class Ti{constructor(e){g(this,Or,void 0);x(this,Or,e)}onDelete(e){return new Ti(ForeignKeyConstraintNode.cloneWith(i(this,Or),{onDelete:parseOnModifyForeignAction(e)}))}onUpdate(e){return new Ti(ForeignKeyConstraintNode.cloneWith(i(this,Or),{onUpdate:parseOnModifyForeignAction(e)}))}$call(e){return e(this)}toOperationNode(){return i(this,Or)}};Or=new WeakMap;let ForeignKeyConstraintBuilder=Ti;preventAwait(ForeignKeyConstraintBuilder,"don't await ForeignKeyConstraintBuilder instances directly.");const AddConstraintNode=freeze({is(r){return r.kind==="AddConstraintNode"},create(r){return freeze({kind:"AddConstraintNode",constraint:r})}}),UniqueConstraintNode=freeze({is(r){return r.kind==="UniqueConstraintNode"},create(r,e,t){return freeze({kind:"UniqueConstraintNode",columns:freeze(r.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0,nullsNotDistinct:t})},cloneWith(r,e){return freeze({...r,...e})}}),DropConstraintNode=freeze({is(r){return r.kind==="DropConstraintNode"},create(r){return freeze({kind:"DropConstraintNode",constraintName:IdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}}),AlterColumnNode=freeze({is(r){return r.kind==="AlterColumnNode"},create(r,e,t){return freeze({kind:"AlterColumnNode",column:ColumnNode.create(r),[e]:t})}});var Bt;class AlterColumnBuilder{constructor(e){g(this,Bt,void 0);x(this,Bt,e)}setDataType(e){return new AlteredColumnBuilder(AlterColumnNode.create(i(this,Bt),"dataType",parseDataTypeExpression(e)))}setDefault(e){return new AlteredColumnBuilder(AlterColumnNode.create(i(this,Bt),"setDefault",parseDefaultValueExpression(e)))}dropDefault(){return new AlteredColumnBuilder(AlterColumnNode.create(i(this,Bt),"dropDefault",!0))}setNotNull(){return new AlteredColumnBuilder(AlterColumnNode.create(i(this,Bt),"setNotNull",!0))}dropNotNull(){return new AlteredColumnBuilder(AlterColumnNode.create(i(this,Bt),"dropNotNull",!0))}$call(e){return e(this)}}Bt=new WeakMap;var Dn;class AlteredColumnBuilder{constructor(e){g(this,Dn,void 0);x(this,Dn,e)}toOperationNode(){return i(this,Dn)}}Dn=new WeakMap;var _t;class AlterTableExecutor{constructor(e){g(this,_t,void 0);x(this,_t,freeze(e))}toOperationNode(){return i(this,_t).executor.transformQuery(i(this,_t).node,i(this,_t).queryId)}compile(){return i(this,_t).executor.compileQuery(this.toOperationNode(),i(this,_t).queryId)}async execute(){await i(this,_t).executor.executeQuery(this.compile(),i(this,_t).queryId)}}_t=new WeakMap;preventAwait(AlterTableExecutor,"don't await AlterTableExecutor instances directly. To execute the query you need to call `execute`");var Ye;const Ii=class Ii{constructor(e){g(this,Ye,void 0);x(this,Ye,freeze(e))}onDelete(e){return new Ii({...i(this,Ye),constraintBuilder:i(this,Ye).constraintBuilder.onDelete(e)})}onUpdate(e){return new Ii({...i(this,Ye),constraintBuilder:i(this,Ye).constraintBuilder.onUpdate(e)})}$call(e){return e(this)}toOperationNode(){return i(this,Ye).executor.transformQuery(AlterTableNode.cloneWithTableProps(i(this,Ye).node,{addConstraint:AddConstraintNode.create(i(this,Ye).constraintBuilder.toOperationNode())}),i(this,Ye).queryId)}compile(){return i(this,Ye).executor.compileQuery(this.toOperationNode(),i(this,Ye).queryId)}async execute(){await i(this,Ye).executor.executeQuery(this.compile(),i(this,Ye).queryId)}};Ye=new WeakMap;let AlterTableAddForeignKeyConstraintBuilder=Ii;preventAwait(AlterTableAddForeignKeyConstraintBuilder,"don't await AlterTableAddForeignKeyConstraintBuilder instances directly. To execute the query you need to call `execute`");var Be;const In=class In{constructor(e){g(this,Be,void 0);x(this,Be,freeze(e))}ifExists(){return new In({...i(this,Be),node:AlterTableNode.cloneWithTableProps(i(this,Be).node,{dropConstraint:DropConstraintNode.cloneWith(i(this,Be).node.dropConstraint,{ifExists:!0})})})}cascade(){return new In({...i(this,Be),node:AlterTableNode.cloneWithTableProps(i(this,Be).node,{dropConstraint:DropConstraintNode.cloneWith(i(this,Be).node.dropConstraint,{modifier:"cascade"})})})}restrict(){return new In({...i(this,Be),node:AlterTableNode.cloneWithTableProps(i(this,Be).node,{dropConstraint:DropConstraintNode.cloneWith(i(this,Be).node.dropConstraint,{modifier:"restrict"})})})}$call(e){return e(this)}toOperationNode(){return i(this,Be).executor.transformQuery(i(this,Be).node,i(this,Be).queryId)}compile(){return i(this,Be).executor.compileQuery(this.toOperationNode(),i(this,Be).queryId)}async execute(){await i(this,Be).executor.executeQuery(this.compile(),i(this,Be).queryId)}};Be=new WeakMap;let AlterTableDropConstraintBuilder=In;preventAwait(AlterTableDropConstraintBuilder,"don't await AlterTableDropConstraintBuilder instances directly. To execute the query you need to call `execute`");const PrimaryConstraintNode=freeze({is(r){return r.kind==="PrimaryKeyConstraintNode"},create(r,e){return freeze({kind:"PrimaryKeyConstraintNode",columns:freeze(r.map(ColumnNode.create)),name:e?IdentifierNode.create(e):void 0})}}),AddIndexNode=freeze({is(r){return r.kind==="AddIndexNode"},create(r){return freeze({kind:"AddIndexNode",name:IdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})},cloneWithColumns(r,e){return freeze({...r,columns:[...r.columns||[],...e]})}});var ge;const hr=class hr{constructor(e){g(this,ge,void 0);x(this,ge,freeze(e))}unique(){return new hr({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{addIndex:AddIndexNode.cloneWith(i(this,ge).node.addIndex,{unique:!0})})})}column(e){return new hr({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{addIndex:AddIndexNode.cloneWithColumns(i(this,ge).node.addIndex,[parseOrderedColumnName(e)])})})}columns(e){return new hr({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{addIndex:AddIndexNode.cloneWithColumns(i(this,ge).node.addIndex,e.map(parseOrderedColumnName))})})}expression(e){return new hr({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{addIndex:AddIndexNode.cloneWithColumns(i(this,ge).node.addIndex,[e.toOperationNode()])})})}using(e){return new hr({...i(this,ge),node:AlterTableNode.cloneWithTableProps(i(this,ge).node,{addIndex:AddIndexNode.cloneWith(i(this,ge).node.addIndex,{using:RawNode.createWithSql(e)})})})}$call(e){return e(this)}toOperationNode(){return i(this,ge).executor.transformQuery(i(this,ge).node,i(this,ge).queryId)}compile(){return i(this,ge).executor.compileQuery(this.toOperationNode(),i(this,ge).queryId)}async execute(){await i(this,ge).executor.executeQuery(this.compile(),i(this,ge).queryId)}};ge=new WeakMap;let AlterTableAddIndexBuilder=hr;preventAwait(AlterTableAddIndexBuilder,"don't await AlterTableAddIndexBuilder instances directly. To execute the query you need to call `execute`");var sn;const ys=class ys{constructor(e){g(this,sn,void 0);x(this,sn,e)}toOperationNode(){return i(this,sn)}nullsNotDistinct(){return new ys(UniqueConstraintNode.cloneWith(i(this,sn),{nullsNotDistinct:!0}))}};sn=new WeakMap;let UniqueConstraintNodeBuilder=ys;preventAwait(UniqueConstraintNodeBuilder,"don't await UniqueConstraintNodeBuilder instances directly.");var de;class AlterTableBuilder{constructor(e){g(this,de,void 0);x(this,de,freeze(e))}renameTo(e){return new AlterTableExecutor({...i(this,de),node:AlterTableNode.cloneWithTableProps(i(this,de).node,{renameTo:parseTable(e)})})}setSchema(e){return new AlterTableExecutor({...i(this,de),node:AlterTableNode.cloneWithTableProps(i(this,de).node,{setSchema:IdentifierNode.create(e)})})}alterColumn(e,t){const n=t(new AlterColumnBuilder(e));return new AlterTableColumnAlteringBuilder({...i(this,de),node:AlterTableNode.cloneWithColumnAlteration(i(this,de).node,n.toOperationNode())})}dropColumn(e){return new AlterTableColumnAlteringBuilder({...i(this,de),node:AlterTableNode.cloneWithColumnAlteration(i(this,de).node,DropColumnNode.create(e))})}renameColumn(e,t){return new AlterTableColumnAlteringBuilder({...i(this,de),node:AlterTableNode.cloneWithColumnAlteration(i(this,de).node,RenameColumnNode.create(e,t))})}addColumn(e,t,n=noop$1){const o=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...i(this,de),node:AlterTableNode.cloneWithColumnAlteration(i(this,de).node,AddColumnNode.create(o.toOperationNode()))})}modifyColumn(e,t,n=noop$1){const o=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...i(this,de),node:AlterTableNode.cloneWithColumnAlteration(i(this,de).node,ModifyColumnNode.create(o.toOperationNode()))})}addUniqueConstraint(e,t,n=noop$1){const o=n(new UniqueConstraintNodeBuilder(UniqueConstraintNode.create(t,e)));return new AlterTableExecutor({...i(this,de),node:AlterTableNode.cloneWithTableProps(i(this,de).node,{addConstraint:AddConstraintNode.create(o.toOperationNode())})})}addCheckConstraint(e,t){return new AlterTableExecutor({...i(this,de),node:AlterTableNode.cloneWithTableProps(i(this,de).node,{addConstraint:AddConstraintNode.create(CheckConstraintNode.create(t.toOperationNode(),e))})})}addForeignKeyConstraint(e,t,n,o){return new AlterTableAddForeignKeyConstraintBuilder({...i(this,de),constraintBuilder:new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(t.map(ColumnNode.create),parseTable(n),o.map(ColumnNode.create),e))})}addPrimaryKeyConstraint(e,t){return new AlterTableExecutor({...i(this,de),node:AlterTableNode.cloneWithTableProps(i(this,de).node,{addConstraint:AddConstraintNode.create(PrimaryConstraintNode.create(t,e))})})}dropConstraint(e){return new AlterTableDropConstraintBuilder({...i(this,de),node:AlterTableNode.cloneWithTableProps(i(this,de).node,{dropConstraint:DropConstraintNode.create(e)})})}addIndex(e){return new AlterTableAddIndexBuilder({...i(this,de),node:AlterTableNode.cloneWithTableProps(i(this,de).node,{addIndex:AddIndexNode.create(e)})})}dropIndex(e){return new AlterTableExecutor({...i(this,de),node:AlterTableNode.cloneWithTableProps(i(this,de).node,{dropIndex:DropIndexNode.create(e)})})}$call(e){return e(this)}}de=new WeakMap;var Le;const pr=class pr{constructor(e){g(this,Le,void 0);x(this,Le,freeze(e))}alterColumn(e,t){const n=t(new AlterColumnBuilder(e));return new pr({...i(this,Le),node:AlterTableNode.cloneWithColumnAlteration(i(this,Le).node,n.toOperationNode())})}dropColumn(e){return new pr({...i(this,Le),node:AlterTableNode.cloneWithColumnAlteration(i(this,Le).node,DropColumnNode.create(e))})}renameColumn(e,t){return new pr({...i(this,Le),node:AlterTableNode.cloneWithColumnAlteration(i(this,Le).node,RenameColumnNode.create(e,t))})}addColumn(e,t,n=noop$1){const o=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new pr({...i(this,Le),node:AlterTableNode.cloneWithColumnAlteration(i(this,Le).node,AddColumnNode.create(o.toOperationNode()))})}modifyColumn(e,t,n=noop$1){const o=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new pr({...i(this,Le),node:AlterTableNode.cloneWithColumnAlteration(i(this,Le).node,ModifyColumnNode.create(o.toOperationNode()))})}toOperationNode(){return i(this,Le).executor.transformQuery(i(this,Le).node,i(this,Le).queryId)}compile(){return i(this,Le).executor.compileQuery(this.toOperationNode(),i(this,Le).queryId)}async execute(){await i(this,Le).executor.executeQuery(this.compile(),i(this,Le).queryId)}};Le=new WeakMap;let AlterTableColumnAlteringBuilder=pr;preventAwait(AlterTableBuilder,"don't await AlterTableBuilder instances");preventAwait(AlterColumnBuilder,"don't await AlterColumnBuilder instances");preventAwait(AlterTableColumnAlteringBuilder,"don't await AlterTableColumnAlteringBuilder instances directly. To execute the query you need to call `execute`");class ImmediateValueTransformer extends OperationNodeTransformer{transformValue(e){return{...super.transformValue(e),immediate:!0}}}var Ne;const Nt=class Nt{constructor(e){g(this,Ne,void 0);x(this,Ne,freeze(e))}ifNotExists(){return new Nt({...i(this,Ne),node:CreateIndexNode.cloneWith(i(this,Ne).node,{ifNotExists:!0})})}unique(){return new Nt({...i(this,Ne),node:CreateIndexNode.cloneWith(i(this,Ne).node,{unique:!0})})}nullsNotDistinct(){return new Nt({...i(this,Ne),node:CreateIndexNode.cloneWith(i(this,Ne).node,{nullsNotDistinct:!0})})}on(e){return new Nt({...i(this,Ne),node:CreateIndexNode.cloneWith(i(this,Ne).node,{table:parseTable(e)})})}column(e){return new Nt({...i(this,Ne),node:CreateIndexNode.cloneWithColumns(i(this,Ne).node,[parseOrderedColumnName(e)])})}columns(e){return new Nt({...i(this,Ne),node:CreateIndexNode.cloneWithColumns(i(this,Ne).node,e.map(parseOrderedColumnName))})}expression(e){return new Nt({...i(this,Ne),node:CreateIndexNode.cloneWithColumns(i(this,Ne).node,[e.toOperationNode()])})}using(e){return new Nt({...i(this,Ne),node:CreateIndexNode.cloneWith(i(this,Ne).node,{using:RawNode.createWithSql(e)})})}where(...e){const t=new ImmediateValueTransformer;return new Nt({...i(this,Ne),node:QueryNode.cloneWithWhere(i(this,Ne).node,t.transformNode(parseValueBinaryOperationOrExpression(e)))})}$call(e){return e(this)}toOperationNode(){return i(this,Ne).executor.transformQuery(i(this,Ne).node,i(this,Ne).queryId)}compile(){return i(this,Ne).executor.compileQuery(this.toOperationNode(),i(this,Ne).queryId)}async execute(){await i(this,Ne).executor.executeQuery(this.compile(),i(this,Ne).queryId)}};Ne=new WeakMap;let CreateIndexBuilder=Nt;preventAwait(CreateIndexBuilder,"don't await CreateIndexBuilder instances directly. To execute the query you need to call `execute`");var ct;const Ns=class Ns{constructor(e){g(this,ct,void 0);x(this,ct,freeze(e))}ifNotExists(){return new Ns({...i(this,ct),node:CreateSchemaNode.cloneWith(i(this,ct).node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,ct).executor.transformQuery(i(this,ct).node,i(this,ct).queryId)}compile(){return i(this,ct).executor.compileQuery(this.toOperationNode(),i(this,ct).queryId)}async execute(){await i(this,ct).executor.executeQuery(this.compile(),i(this,ct).queryId)}};ct=new WeakMap;let CreateSchemaBuilder=Ns;preventAwait(CreateSchemaBuilder,"don't await CreateSchemaBuilder instances directly. To execute the query you need to call `execute`");function parseOnCommitAction(r){if(ON_COMMIT_ACTIONS.includes(r))return r;throw new Error(`invalid OnCommitAction ${r}`)}var ce;const lt=class lt{constructor(e){g(this,ce,void 0);x(this,ce,freeze(e))}temporary(){return new lt({...i(this,ce),node:CreateTableNode.cloneWith(i(this,ce).node,{temporary:!0})})}onCommit(e){return new lt({...i(this,ce),node:CreateTableNode.cloneWith(i(this,ce).node,{onCommit:parseOnCommitAction(e)})})}ifNotExists(){return new lt({...i(this,ce),node:CreateTableNode.cloneWith(i(this,ce).node,{ifNotExists:!0})})}addColumn(e,t,n=noop$1){const o=n(new ColumnDefinitionBuilder(ColumnDefinitionNode.create(e,parseDataTypeExpression(t))));return new lt({...i(this,ce),node:CreateTableNode.cloneWithColumn(i(this,ce).node,o.toOperationNode())})}addPrimaryKeyConstraint(e,t){return new lt({...i(this,ce),node:CreateTableNode.cloneWithConstraint(i(this,ce).node,PrimaryConstraintNode.create(t,e))})}addUniqueConstraint(e,t,n=noop$1){const o=n(new UniqueConstraintNodeBuilder(UniqueConstraintNode.create(t,e)));return new lt({...i(this,ce),node:CreateTableNode.cloneWithConstraint(i(this,ce).node,o.toOperationNode())})}addCheckConstraint(e,t){return new lt({...i(this,ce),node:CreateTableNode.cloneWithConstraint(i(this,ce).node,CheckConstraintNode.create(t.toOperationNode(),e))})}addForeignKeyConstraint(e,t,n,o,a=noop$1){const l=a(new ForeignKeyConstraintBuilder(ForeignKeyConstraintNode.create(t.map(ColumnNode.create),parseTable(n),o.map(ColumnNode.create),e)));return new lt({...i(this,ce),node:CreateTableNode.cloneWithConstraint(i(this,ce).node,l.toOperationNode())})}modifyFront(e){return new lt({...i(this,ce),node:CreateTableNode.cloneWithFrontModifier(i(this,ce).node,e.toOperationNode())})}modifyEnd(e){return new lt({...i(this,ce),node:CreateTableNode.cloneWithEndModifier(i(this,ce).node,e.toOperationNode())})}as(e){return new lt({...i(this,ce),node:CreateTableNode.cloneWith(i(this,ce).node,{selectQuery:parseExpression(e)})})}$call(e){return e(this)}toOperationNode(){return i(this,ce).executor.transformQuery(i(this,ce).node,i(this,ce).queryId)}compile(){return i(this,ce).executor.compileQuery(this.toOperationNode(),i(this,ce).queryId)}async execute(){await i(this,ce).executor.executeQuery(this.compile(),i(this,ce).queryId)}};ce=new WeakMap;let CreateTableBuilder=lt;preventAwait(CreateTableBuilder,"don't await CreateTableBuilder instances directly. To execute the query you need to call `execute`");var He;const Sn=class Sn{constructor(e){g(this,He,void 0);x(this,He,freeze(e))}on(e){return new Sn({...i(this,He),node:DropIndexNode.cloneWith(i(this,He).node,{table:parseTable(e)})})}ifExists(){return new Sn({...i(this,He),node:DropIndexNode.cloneWith(i(this,He).node,{ifExists:!0})})}cascade(){return new Sn({...i(this,He),node:DropIndexNode.cloneWith(i(this,He).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,He).executor.transformQuery(i(this,He).node,i(this,He).queryId)}compile(){return i(this,He).executor.compileQuery(this.toOperationNode(),i(this,He).queryId)}async execute(){await i(this,He).executor.executeQuery(this.compile(),i(this,He).queryId)}};He=new WeakMap;let DropIndexBuilder=Sn;preventAwait(DropIndexBuilder,"don't await DropIndexBuilder instances directly. To execute the query you need to call `execute`");var nt;const Si=class Si{constructor(e){g(this,nt,void 0);x(this,nt,freeze(e))}ifExists(){return new Si({...i(this,nt),node:DropSchemaNode.cloneWith(i(this,nt).node,{ifExists:!0})})}cascade(){return new Si({...i(this,nt),node:DropSchemaNode.cloneWith(i(this,nt).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,nt).executor.transformQuery(i(this,nt).node,i(this,nt).queryId)}compile(){return i(this,nt).executor.compileQuery(this.toOperationNode(),i(this,nt).queryId)}async execute(){await i(this,nt).executor.executeQuery(this.compile(),i(this,nt).queryId)}};nt=new WeakMap;let DropSchemaBuilder=Si;preventAwait(DropSchemaBuilder,"don't await DropSchemaBuilder instances directly. To execute the query you need to call `execute`");var it;const vi=class vi{constructor(e){g(this,it,void 0);x(this,it,freeze(e))}ifExists(){return new vi({...i(this,it),node:DropTableNode.cloneWith(i(this,it).node,{ifExists:!0})})}cascade(){return new vi({...i(this,it),node:DropTableNode.cloneWith(i(this,it).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,it).executor.transformQuery(i(this,it).node,i(this,it).queryId)}compile(){return i(this,it).executor.compileQuery(this.toOperationNode(),i(this,it).queryId)}async execute(){await i(this,it).executor.executeQuery(this.compile(),i(this,it).queryId)}};it=new WeakMap;let DropTableBuilder=vi;preventAwait(DropTableBuilder,"don't await DropTableBuilder instances directly. To execute the query you need to call `execute`");const CreateViewNode=freeze({is(r){return r.kind==="CreateViewNode"},create(r){return freeze({kind:"CreateViewNode",name:SchemableIdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}});var Ci;class ImmediateValuePlugin{constructor(){g(this,Ci,new ImmediateValueTransformer)}transformQuery(e){return i(this,Ci).transformNode(e.node)}transformResult(e){return Promise.resolve(e.result)}}Ci=new WeakMap;var xe;const Gt=class Gt{constructor(e){g(this,xe,void 0);x(this,xe,freeze(e))}temporary(){return new Gt({...i(this,xe),node:CreateViewNode.cloneWith(i(this,xe).node,{temporary:!0})})}materialized(){return new Gt({...i(this,xe),node:CreateViewNode.cloneWith(i(this,xe).node,{materialized:!0})})}ifNotExists(){return new Gt({...i(this,xe),node:CreateViewNode.cloneWith(i(this,xe).node,{ifNotExists:!0})})}orReplace(){return new Gt({...i(this,xe),node:CreateViewNode.cloneWith(i(this,xe).node,{orReplace:!0})})}columns(e){return new Gt({...i(this,xe),node:CreateViewNode.cloneWith(i(this,xe).node,{columns:e.map(parseColumnName)})})}as(e){const t=e.withPlugin(new ImmediateValuePlugin).toOperationNode();return new Gt({...i(this,xe),node:CreateViewNode.cloneWith(i(this,xe).node,{as:t})})}$call(e){return e(this)}toOperationNode(){return i(this,xe).executor.transformQuery(i(this,xe).node,i(this,xe).queryId)}compile(){return i(this,xe).executor.compileQuery(this.toOperationNode(),i(this,xe).queryId)}async execute(){await i(this,xe).executor.executeQuery(this.compile(),i(this,xe).queryId)}};xe=new WeakMap;let CreateViewBuilder=Gt;preventAwait(CreateViewBuilder,"don't await CreateViewBuilder instances directly. To execute the query you need to call `execute`");const DropViewNode=freeze({is(r){return r.kind==="DropViewNode"},create(r){return freeze({kind:"DropViewNode",name:SchemableIdentifierNode.create(r)})},cloneWith(r,e){return freeze({...r,...e})}});var je;const vn=class vn{constructor(e){g(this,je,void 0);x(this,je,freeze(e))}materialized(){return new vn({...i(this,je),node:DropViewNode.cloneWith(i(this,je).node,{materialized:!0})})}ifExists(){return new vn({...i(this,je),node:DropViewNode.cloneWith(i(this,je).node,{ifExists:!0})})}cascade(){return new vn({...i(this,je),node:DropViewNode.cloneWith(i(this,je).node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,je).executor.transformQuery(i(this,je).node,i(this,je).queryId)}compile(){return i(this,je).executor.compileQuery(this.toOperationNode(),i(this,je).queryId)}async execute(){await i(this,je).executor.executeQuery(this.compile(),i(this,je).queryId)}};je=new WeakMap;let DropViewBuilder=vn;preventAwait(DropViewBuilder,"don't await DropViewBuilder instances directly. To execute the query you need to call `execute`");const CreateTypeNode=freeze({is(r){return r.kind==="CreateTypeNode"},create(r){return freeze({kind:"CreateTypeNode",name:r})},cloneWithEnum(r,e){return freeze({...r,enum:ValueListNode.create(e.map(t=>ValueNode.createImmediate(t)))})}});var dt;const bs=class bs{constructor(e){g(this,dt,void 0);x(this,dt,freeze(e))}toOperationNode(){return i(this,dt).executor.transformQuery(i(this,dt).node,i(this,dt).queryId)}asEnum(e){return new bs({...i(this,dt),node:CreateTypeNode.cloneWithEnum(i(this,dt).node,e)})}$call(e){return e(this)}compile(){return i(this,dt).executor.compileQuery(this.toOperationNode(),i(this,dt).queryId)}async execute(){await i(this,dt).executor.executeQuery(this.compile(),i(this,dt).queryId)}};dt=new WeakMap;let CreateTypeBuilder=bs;preventAwait(CreateTypeBuilder,"don't await CreateTypeBuilder instances directly. To execute the query you need to call `execute`");const DropTypeNode=freeze({is(r){return r.kind==="DropTypeNode"},create(r){return freeze({kind:"DropTypeNode",name:r})},cloneWith(r,e){return freeze({...r,...e})}});var ft;const ws=class ws{constructor(e){g(this,ft,void 0);x(this,ft,freeze(e))}ifExists(){return new ws({...i(this,ft),node:DropTypeNode.cloneWith(i(this,ft).node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return i(this,ft).executor.transformQuery(i(this,ft).node,i(this,ft).queryId)}compile(){return i(this,ft).executor.compileQuery(this.toOperationNode(),i(this,ft).queryId)}async execute(){await i(this,ft).executor.executeQuery(this.compile(),i(this,ft).queryId)}};ft=new WeakMap;let DropTypeBuilder=ws;preventAwait(DropTypeBuilder,"don't await DropTypeBuilder instances directly. To execute the query you need to call `execute`");function parseSchemableIdentifier(r){const e=".";if(r.includes(e)){const t=r.split(e).map(trim);if(t.length===2)return SchemableIdentifierNode.createWithSchema(t[0],t[1]);throw new Error(`invalid schemable identifier ${r}`)}else return SchemableIdentifierNode.create(r)}function trim(r){return r.trim()}var Ue;const Cn=class Cn{constructor(e){g(this,Ue,void 0);x(this,Ue,e)}createTable(e){return new CreateTableBuilder({queryId:createQueryId(),executor:i(this,Ue),node:CreateTableNode.create(parseTable(e))})}dropTable(e){return new DropTableBuilder({queryId:createQueryId(),executor:i(this,Ue),node:DropTableNode.create(parseTable(e))})}createIndex(e){return new CreateIndexBuilder({queryId:createQueryId(),executor:i(this,Ue),node:CreateIndexNode.create(e)})}dropIndex(e){return new DropIndexBuilder({queryId:createQueryId(),executor:i(this,Ue),node:DropIndexNode.create(e)})}createSchema(e){return new CreateSchemaBuilder({queryId:createQueryId(),executor:i(this,Ue),node:CreateSchemaNode.create(e)})}dropSchema(e){return new DropSchemaBuilder({queryId:createQueryId(),executor:i(this,Ue),node:DropSchemaNode.create(e)})}alterTable(e){return new AlterTableBuilder({queryId:createQueryId(),executor:i(this,Ue),node:AlterTableNode.create(parseTable(e))})}createView(e){return new CreateViewBuilder({queryId:createQueryId(),executor:i(this,Ue),node:CreateViewNode.create(e)})}dropView(e){return new DropViewBuilder({queryId:createQueryId(),executor:i(this,Ue),node:DropViewNode.create(e)})}createType(e){return new CreateTypeBuilder({queryId:createQueryId(),executor:i(this,Ue),node:CreateTypeNode.create(parseSchemableIdentifier(e))})}dropType(e){return new DropTypeBuilder({queryId:createQueryId(),executor:i(this,Ue),node:DropTypeNode.create(parseSchemableIdentifier(e))})}withPlugin(e){return new Cn(i(this,Ue).withPlugin(e))}withoutPlugins(){return new Cn(i(this,Ue).withoutPlugins())}withSchema(e){return new Cn(i(this,Ue).withPluginAtFront(new WithSchemaPlugin(e)))}};Ue=new WeakMap;let SchemaModule=Cn;class DynamicModule{ref(e){return new DynamicReferenceBuilder(e)}}var on;class DefaultConnectionProvider{constructor(e){g(this,on,void 0);x(this,on,e)}async provideConnection(e){const t=await i(this,on).acquireConnection();try{return await e(t)}finally{await i(this,on).releaseConnection(t)}}}on=new WeakMap;var kt,At,Ft;const mr=class mr extends QueryExecutorBase{constructor(t,n,o,a=[]){super(a);g(this,kt,void 0);g(this,At,void 0);g(this,Ft,void 0);x(this,kt,t),x(this,At,n),x(this,Ft,o)}get adapter(){return i(this,At)}compileQuery(t){return i(this,kt).compileQuery(t)}provideConnection(t){return i(this,Ft).provideConnection(t)}withPlugins(t){return new mr(i(this,kt),i(this,At),i(this,Ft),[...this.plugins,...t])}withPlugin(t){return new mr(i(this,kt),i(this,At),i(this,Ft),[...this.plugins,t])}withPluginAtFront(t){return new mr(i(this,kt),i(this,At),i(this,Ft),[t,...this.plugins])}withConnectionProvider(t){return new mr(i(this,kt),i(this,At),t,[...this.plugins])}withoutPlugins(){return new mr(i(this,kt),i(this,At),i(this,Ft),[])}};kt=new WeakMap,At=new WeakMap,Ft=new WeakMap;let DefaultQueryExecutor=mr;function performanceNow(){return typeof performance<"u"&&isFunction(performance.now)?performance.now():Date.now()}var gt,rr,Qt,an,zt,Bn,Ri,ta,xi,ra,ki,na,Ai,ia,Fn,cs;class RuntimeDriver{constructor(e,t){g(this,Ri);g(this,xi);g(this,ki);g(this,Ai);g(this,Fn);g(this,gt,void 0);g(this,rr,void 0);g(this,Qt,void 0);g(this,an,void 0);g(this,zt,void 0);g(this,Bn,new WeakSet);x(this,an,!1),x(this,gt,e),x(this,rr,t)}async init(){if(i(this,zt))throw new Error("driver has already been destroyed");i(this,Qt)||x(this,Qt,i(this,gt).init().then(()=>{x(this,an,!0)}).catch(e=>(x(this,Qt,void 0),Promise.reject(e)))),await i(this,Qt)}async acquireConnection(){if(i(this,zt))throw new Error("driver has already been destroyed");i(this,an)||await this.init();const e=await i(this,gt).acquireConnection();return i(this,Bn).has(e)||(j(this,Ri,ta).call(this)&&j(this,xi,ra).call(this,e),i(this,Bn).add(e)),e}async releaseConnection(e){await i(this,gt).releaseConnection(e)}beginTransaction(e,t){return i(this,gt).beginTransaction(e,t)}commitTransaction(e){return i(this,gt).commitTransaction(e)}rollbackTransaction(e){return i(this,gt).rollbackTransaction(e)}async destroy(){i(this,Qt)&&(await i(this,Qt),i(this,zt)||x(this,zt,i(this,gt).destroy().catch(e=>(x(this,zt,void 0),Promise.reject(e)))),await i(this,zt))}}gt=new WeakMap,rr=new WeakMap,Qt=new WeakMap,an=new WeakMap,zt=new WeakMap,Bn=new WeakMap,Ri=new WeakSet,ta=function(){return i(this,rr).isLevelEnabled("query")||i(this,rr).isLevelEnabled("error")},xi=new WeakSet,ra=function(e){const t=e.executeQuery;e.executeQuery=async n=>{let o;const a=performanceNow();try{return await t.call(e,n)}catch(l){throw o=l,await j(this,ki,na).call(this,l,n,a),l}finally{o||await j(this,Ai,ia).call(this,n,a)}}},ki=new WeakSet,na=async function(e,t,n){await i(this,rr).error(()=>({level:"error",error:e,query:t,queryDurationMillis:j(this,Fn,cs).call(this,n)}))},Ai=new WeakSet,ia=async function(e,t){await i(this,rr).query(()=>({level:"query",query:e,queryDurationMillis:j(this,Fn,cs).call(this,t)}))},Fn=new WeakSet,cs=function(e){return performanceNow()-e};const ignoreError=()=>{};var Qn,nr,Li,sa;class SingleConnectionProvider{constructor(e){g(this,Li);g(this,Qn,void 0);g(this,nr,void 0);x(this,Qn,e)}async provideConnection(e){for(;i(this,nr);)await i(this,nr).catch(ignoreError);return x(this,nr,j(this,Li,sa).call(this,e).finally(()=>{x(this,nr,void 0)})),i(this,nr)}}Qn=new WeakMap,nr=new WeakMap,Li=new WeakSet,sa=async function(e){return await e(i(this,Qn))};const TRANSACTION_ISOLATION_LEVELS=["read uncommitted","read committed","repeatable read","serializable","snapshot"];freeze(["query","error"]);var ir,Tr;class Log{constructor(e){g(this,ir,void 0);g(this,Tr,void 0);isFunction(e)?(x(this,Tr,e),x(this,ir,freeze({query:!0,error:!0}))):(x(this,Tr,defaultLogger),x(this,ir,freeze({query:e.includes("query"),error:e.includes("error")})))}isLevelEnabled(e){return i(this,ir)[e]}async query(e){i(this,ir).query&&await i(this,Tr).call(this,e())}async error(e){i(this,ir).error&&await i(this,Tr).call(this,e())}}ir=new WeakMap,Tr=new WeakMap;function defaultLogger(r){r.level==="query"?(console.log(`kysely:query: ${r.query.sql}`),console.log(`kysely:query: duration: ${r.queryDurationMillis.toFixed(1)}ms`)):r.level==="error"&&(r.error instanceof Error?console.error(`kysely:error: ${r.error.stack??r.error.message}`):console.error(`kysely:error: ${JSON.stringify({error:r.error,query:r.query.sql,queryDurationMillis:r.queryDurationMillis})}`))}function isCompilable(r){return isObject$3(r)&&isFunction(r.compile)}var Ke;const Pr=class Pr extends QueryCreator{constructor(t){let n,o;if(isKyselyProps(t))n={executor:t.executor},o={...t};else{const a=t.dialect,l=a.createDriver(),d=a.createQueryCompiler(),h=a.createAdapter(),p=new Log(t.log??[]),m=new RuntimeDriver(l,p),E=new DefaultConnectionProvider(m),k=new DefaultQueryExecutor(d,h,E,t.plugins??[]);n={executor:k},o={config:t,executor:k,dialect:a,driver:m}}super(n);g(this,Ke,void 0);x(this,Ke,freeze(o))}get schema(){return new SchemaModule(i(this,Ke).executor)}get dynamic(){return new DynamicModule}get introspection(){return i(this,Ke).dialect.createIntrospector(this.withoutPlugins())}case(t){return new CaseBuilder({node:CaseNode.create(isUndefined(t)?void 0:parseExpression(t))})}get fn(){return createFunctionModule()}transaction(){return new TransactionBuilder({...i(this,Ke)})}connection(){return new ConnectionBuilder({...i(this,Ke)})}withPlugin(t){return new Pr({...i(this,Ke),executor:i(this,Ke).executor.withPlugin(t)})}withoutPlugins(){return new Pr({...i(this,Ke),executor:i(this,Ke).executor.withoutPlugins()})}withSchema(t){return new Pr({...i(this,Ke),executor:i(this,Ke).executor.withPluginAtFront(new WithSchemaPlugin(t))})}withTables(){return new Pr({...i(this,Ke)})}async destroy(){await i(this,Ke).driver.destroy()}get isTransaction(){return!1}getExecutor(){return i(this,Ke).executor}executeQuery(t,n=createQueryId()){const o=isCompilable(t)?t.compile():t;return this.getExecutor().executeQuery(o,n)}};Ke=new WeakMap;let Kysely=Pr;var Ot;const Mr=class Mr extends Kysely{constructor(t){super(t);g(this,Ot,void 0);x(this,Ot,t)}get isTransaction(){return!0}transaction(){throw new Error("calling the transaction method for a Transaction is not supported")}connection(){throw new Error("calling the connection method for a Transaction is not supported")}async destroy(){throw new Error("calling the destroy method for a Transaction is not supported")}withPlugin(t){return new Mr({...i(this,Ot),executor:i(this,Ot).executor.withPlugin(t)})}withoutPlugins(){return new Mr({...i(this,Ot),executor:i(this,Ot).executor.withoutPlugins()})}withSchema(t){return new Mr({...i(this,Ot),executor:i(this,Ot).executor.withPluginAtFront(new WithSchemaPlugin(t))})}withTables(){return new Mr({...i(this,Ot)})}};Ot=new WeakMap;let Transaction=Mr;function isKyselyProps(r){return isObject$3(r)&&isObject$3(r.config)&&isObject$3(r.driver)&&isObject$3(r.executor)&&isObject$3(r.dialect)}var Ir;class ConnectionBuilder{constructor(e){g(this,Ir,void 0);x(this,Ir,freeze(e))}async execute(e){return i(this,Ir).executor.provideConnection(async t=>{const n=i(this,Ir).executor.withConnectionProvider(new SingleConnectionProvider(t)),o=new Kysely({...i(this,Ir),executor:n});return await e(o)})}}Ir=new WeakMap;preventAwait(ConnectionBuilder,"don't await ConnectionBuilder instances directly. To execute the query you need to call the `execute` method");var Tt;const Es=class Es{constructor(e){g(this,Tt,void 0);x(this,Tt,freeze(e))}setIsolationLevel(e){return new Es({...i(this,Tt),isolationLevel:e})}async execute(e){const{isolationLevel:t,...n}=i(this,Tt),o={isolationLevel:t};return validateTransactionSettings(o),i(this,Tt).executor.provideConnection(async a=>{const l=i(this,Tt).executor.withConnectionProvider(new SingleConnectionProvider(a)),d=new Transaction({...n,executor:l});try{await i(this,Tt).driver.beginTransaction(a,o);const h=await e(d);return await i(this,Tt).driver.commitTransaction(a),h}catch(h){throw await i(this,Tt).driver.rollbackTransaction(a),h}})}};Tt=new WeakMap;let TransactionBuilder=Es;preventAwait(TransactionBuilder,"don't await TransactionBuilder instances directly. To execute the transaction you need to call the `execute` method");function validateTransactionSettings(r){if(r.isolationLevel&&!TRANSACTION_ISOLATION_LEVELS.includes(r.isolationLevel))throw new Error(`invalid transaction isolation level ${r.isolationLevel}`)}var st,un,fi,zn,ds,Pn,fs;const Rn=class Rn{constructor(e){g(this,un);g(this,zn);g(this,Pn);g(this,st,void 0);x(this,st,freeze(e))}get expressionType(){}get isRawBuilder(){return!0}as(e){return new AliasedRawBuilderImpl(this,e)}$castTo(){return new Rn({...i(this,st)})}$notNull(){return new Rn(i(this,st))}withPlugin(e){return new Rn({...i(this,st),plugins:i(this,st).plugins!==void 0?freeze([...i(this,st).plugins,e]):freeze([e])})}toOperationNode(){return j(this,zn,ds).call(this,j(this,un,fi).call(this))}compile(e){return j(this,Pn,fs).call(this,j(this,un,fi).call(this,e))}async execute(e){const t=j(this,un,fi).call(this,e);return t.executeQuery(j(this,Pn,fs).call(this,t),i(this,st).queryId)}};st=new WeakMap,un=new WeakSet,fi=function(e){const t=e!==void 0?e.getExecutor():NOOP_QUERY_EXECUTOR;return i(this,st).plugins!==void 0?t.withPlugins(i(this,st).plugins):t},zn=new WeakSet,ds=function(e){return e.transformQuery(i(this,st).rawNode,i(this,st).queryId)},Pn=new WeakSet,fs=function(e){return e.compileQuery(j(this,zn,ds).call(this,e),i(this,st).queryId)};let RawBuilderImpl=Rn;function createRawBuilder(r){return new RawBuilderImpl(r)}preventAwait(RawBuilderImpl,"don't await RawBuilder instances directly. To execute the query you need to call `execute`");var Sr,sr;class AliasedRawBuilderImpl{constructor(e,t){g(this,Sr,void 0);g(this,sr,void 0);x(this,Sr,e),x(this,sr,t)}get expression(){return i(this,Sr)}get alias(){return i(this,sr)}get rawBuilder(){return i(this,Sr)}toOperationNode(){return AliasNode.create(i(this,Sr).toOperationNode(),isOperationNodeSource(i(this,sr))?i(this,sr).toOperationNode():IdentifierNode.create(i(this,sr)))}}Sr=new WeakMap,sr=new WeakMap;preventAwait(AliasedRawBuilderImpl,"don't await AliasedRawBuilder instances directly. AliasedRawBuilder should never be executed directly since it's always a part of another query.");const sql=Object.assign((r,...e)=>createRawBuilder({queryId:createQueryId(),rawNode:RawNode.create(r,(e==null?void 0:e.map(parseParameter))??[])}),{ref(r){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseStringReference(r))})},val(r){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseValueExpression(r))})},value(r){return this.val(r)},table(r){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(parseTable(r))})},id(...r){const e=new Array(r.length+1).fill(".");return e[0]="",e[e.length-1]="",createRawBuilder({queryId:createQueryId(),rawNode:RawNode.create(e,r.map(IdentifierNode.create))})},lit(r){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChild(ValueNode.createImmediate(r))})},literal(r){return this.lit(r)},raw(r){return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithSql(r)})},join(r,e=sql`, `){const t=new Array(2*r.length-1),n=e.toOperationNode();for(let o=0;o<r.length;++o)t[2*o]=parseParameter(r[o]),o!==r.length-1&&(t[2*o+1]=n);return createRawBuilder({queryId:createQueryId(),rawNode:RawNode.createWithChildren(t)})}});function parseParameter(r){return isOperationNodeSource(r)?r.toOperationNode():parseValueExpression(r)}var qi;class OperationNodeVisitor{constructor(){oe(this,"nodeStack",[]);g(this,qi,freeze({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this),JSONReferenceNode:this.visitJSONReference.bind(this),JSONPathNode:this.visitJSONPath.bind(this),JSONPathLegNode:this.visitJSONPathLeg.bind(this),JSONOperatorChainNode:this.visitJSONOperatorChain.bind(this),TupleNode:this.visitTuple.bind(this),MergeQueryNode:this.visitMergeQuery.bind(this),MatchedNode:this.visitMatched.bind(this),AddIndexNode:this.visitAddIndex.bind(this),CastNode:this.visitCast.bind(this),FetchNode:this.visitFetch.bind(this),TopNode:this.visitTop.bind(this)}));oe(this,"visitNode",e=>{this.nodeStack.push(e),i(this,qi)[e.kind](e),this.nodeStack.pop()})}get parentNode(){return this.nodeStack[this.nodeStack.length-2]}}qi=new WeakMap;var ln,vr;class DefaultQueryCompiler extends OperationNodeVisitor{constructor(){super(...arguments);g(this,ln,"");g(this,vr,[])}get numParameters(){return i(this,vr).length}compileQuery(t){return x(this,ln,""),x(this,vr,[]),this.visitNode(t),freeze({query:t,sql:this.getSql(),parameters:[...i(this,vr)]})}getSql(){return i(this,ln)}visitSelectQuery(t){var o,a;const n=this.parentNode!==void 0&&!ParensNode.is(this.parentNode)&&!InsertQueryNode.is(this.parentNode)&&!CreateTableNode.is(this.parentNode)&&!CreateViewNode.is(this.parentNode)&&!SetOperationNode.is(this.parentNode);this.parentNode===void 0&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("select"),t.distinctOn&&(this.append(" "),this.compileDistinctOn(t.distinctOn)),(o=t.frontModifiers)!=null&&o.length&&(this.append(" "),this.compileList(t.frontModifiers," ")),t.top&&(this.append(" "),this.visitNode(t.top)),t.selections&&(this.append(" "),this.compileList(t.selections)),t.from&&(this.append(" "),this.visitNode(t.from)),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.groupBy&&(this.append(" "),this.visitNode(t.groupBy)),t.having&&(this.append(" "),this.visitNode(t.having)),t.setOperations&&(this.append(" "),this.compileList(t.setOperations," ")),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.offset&&(this.append(" "),this.visitNode(t.offset)),t.fetch&&(this.append(" "),this.visitNode(t.fetch)),(a=t.endModifiers)!=null&&a.length&&(this.append(" "),this.compileList(this.sortSelectModifiers([...t.endModifiers])," ")),n&&this.append(")")}visitFrom(t){this.append("from "),this.compileList(t.froms)}visitSelection(t){this.visitNode(t.selection)}visitColumn(t){this.visitNode(t.column)}compileDistinctOn(t){this.append("distinct on ("),this.compileList(t),this.append(")")}compileList(t,n=", "){const o=t.length-1;for(let a=0;a<=o;a++)this.visitNode(t[a]),a<o&&this.append(n)}visitWhere(t){this.append("where "),this.visitNode(t.where)}visitHaving(t){this.append("having "),this.visitNode(t.having)}visitInsertQuery(t){const n=this.nodeStack.find(QueryNode.is),o=n!==t;!o&&t.explain&&(this.visitNode(t.explain),this.append(" ")),o&&!MergeQueryNode.is(n)&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append(t.replace?"replace":"insert"),t.ignore&&this.append(" ignore"),t.top&&(this.append(" "),this.visitNode(t.top)),t.into&&(this.append(" into "),this.visitNode(t.into)),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.values&&(this.append(" "),this.visitNode(t.values)),t.defaultValues&&(this.append(" "),this.append("default values")),t.onConflict&&(this.append(" "),this.visitNode(t.onConflict)),t.onDuplicateKey&&(this.append(" "),this.visitNode(t.onDuplicateKey)),t.returning&&(this.append(" "),this.visitNode(t.returning)),o&&!MergeQueryNode.is(n)&&this.append(")")}visitValues(t){this.append("values "),this.compileList(t.values)}visitDeleteQuery(t){const n=this.nodeStack.find(QueryNode.is)!==t;!n&&t.explain&&(this.visitNode(t.explain),this.append(" ")),n&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("delete "),t.top&&(this.visitNode(t.top),this.append(" ")),this.visitNode(t.from),t.using&&(this.append(" "),this.visitNode(t.using)),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.orderBy&&(this.append(" "),this.visitNode(t.orderBy)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.returning&&(this.append(" "),this.visitNode(t.returning)),n&&this.append(")")}visitReturning(t){this.append("returning "),this.compileList(t.selections)}visitAlias(t){this.visitNode(t.node),this.append(" as "),this.visitNode(t.alias)}visitReference(t){t.table&&(this.visitNode(t.table),this.append(".")),this.visitNode(t.column)}visitSelectAll(t){this.append("*")}visitIdentifier(t){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(t),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(t){if(!isString(t.name))throw new Error("a non-string identifier was passed to compileUnwrappedIdentifier.");this.append(this.sanitizeIdentifier(t.name))}visitAnd(t){this.visitNode(t.left),this.append(" and "),this.visitNode(t.right)}visitOr(t){this.visitNode(t.left),this.append(" or "),this.visitNode(t.right)}visitValue(t){t.immediate?this.appendImmediateValue(t.value):this.appendValue(t.value)}visitValueList(t){this.append("("),this.compileList(t.values),this.append(")")}visitTuple(t){this.append("("),this.compileList(t.values),this.append(")")}visitPrimitiveValueList(t){this.append("(");const{values:n}=t;for(let o=0;o<n.length;++o)this.appendValue(n[o]),o!==n.length-1&&this.append(", ");this.append(")")}visitParens(t){this.append("("),this.visitNode(t.node),this.append(")")}visitJoin(t){this.append(JOIN_TYPE_SQL[t.joinType]),this.append(" "),this.visitNode(t.table),t.on&&(this.append(" "),this.visitNode(t.on))}visitOn(t){this.append("on "),this.visitNode(t.on)}visitRaw(t){const{sqlFragments:n,parameters:o}=t;for(let a=0;a<n.length;++a)this.append(n[a]),o.length>a&&this.visitNode(o[a])}visitOperator(t){this.append(t.operator)}visitTable(t){this.visitNode(t.table)}visitSchemableIdentifier(t){t.schema&&(this.visitNode(t.schema),this.append(".")),this.visitNode(t.identifier)}visitCreateTable(t){this.append("create "),t.frontModifiers&&t.frontModifiers.length>0&&(this.compileList(t.frontModifiers," "),this.append(" ")),t.temporary&&this.append("temporary "),this.append("table "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.table),t.selectQuery?(this.append(" as "),this.visitNode(t.selectQuery)):(this.append(" ("),this.compileList([...t.columns,...t.constraints??[]]),this.append(")"),t.onCommit&&(this.append(" on commit "),this.append(t.onCommit)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," ")))}visitColumnDefinition(t){this.visitNode(t.column),this.append(" "),this.visitNode(t.dataType),t.unsigned&&this.append(" unsigned"),t.frontModifiers&&t.frontModifiers.length>0&&(this.append(" "),this.compileList(t.frontModifiers," ")),t.generated&&(this.append(" "),this.visitNode(t.generated)),t.identity&&this.append(" identity"),t.defaultTo&&(this.append(" "),this.visitNode(t.defaultTo)),t.notNull&&this.append(" not null"),t.unique&&this.append(" unique"),t.nullsNotDistinct&&this.append(" nulls not distinct"),t.primaryKey&&this.append(" primary key"),t.autoIncrement&&(this.append(" "),this.append(this.getAutoIncrement())),t.references&&(this.append(" "),this.visitNode(t.references)),t.check&&(this.append(" "),this.visitNode(t.check)),t.endModifiers&&t.endModifiers.length>0&&(this.append(" "),this.compileList(t.endModifiers," "))}getAutoIncrement(){return"auto_increment"}visitReferences(t){this.append("references "),this.visitNode(t.table),this.append(" ("),this.compileList(t.columns),this.append(")"),t.onDelete&&(this.append(" on delete "),this.append(t.onDelete)),t.onUpdate&&(this.append(" on update "),this.append(t.onUpdate))}visitDropTable(t){this.append("drop table "),t.ifExists&&this.append("if exists "),this.visitNode(t.table),t.cascade&&this.append(" cascade")}visitDataType(t){this.append(t.dataType)}visitOrderBy(t){this.append("order by "),this.compileList(t.items)}visitOrderByItem(t){this.visitNode(t.orderBy),t.direction&&(this.append(" "),this.visitNode(t.direction))}visitGroupBy(t){this.append("group by "),this.compileList(t.items)}visitGroupByItem(t){this.visitNode(t.groupBy)}visitUpdateQuery(t){const n=this.nodeStack.find(QueryNode.is),o=n!==t;!o&&t.explain&&(this.visitNode(t.explain),this.append(" ")),o&&!MergeQueryNode.is(n)&&this.append("("),t.with&&(this.visitNode(t.with),this.append(" ")),this.append("update "),t.top&&(this.visitNode(t.top),this.append(" ")),t.table&&(this.visitNode(t.table),this.append(" ")),this.append("set "),t.updates&&this.compileList(t.updates),t.from&&(this.append(" "),this.visitNode(t.from)),t.joins&&(this.append(" "),this.compileList(t.joins," ")),t.where&&(this.append(" "),this.visitNode(t.where)),t.limit&&(this.append(" "),this.visitNode(t.limit)),t.returning&&(this.append(" "),this.visitNode(t.returning)),o&&!MergeQueryNode.is(n)&&this.append(")")}visitColumnUpdate(t){this.visitNode(t.column),this.append(" = "),this.visitNode(t.value)}visitLimit(t){this.append("limit "),this.visitNode(t.limit)}visitOffset(t){this.append("offset "),this.visitNode(t.offset)}visitOnConflict(t){this.append("on conflict"),t.columns?(this.append(" ("),this.compileList(t.columns),this.append(")")):t.constraint?(this.append(" on constraint "),this.visitNode(t.constraint)):t.indexExpression&&(this.append(" ("),this.visitNode(t.indexExpression),this.append(")")),t.indexWhere&&(this.append(" "),this.visitNode(t.indexWhere)),t.doNothing===!0?this.append(" do nothing"):t.updates&&(this.append(" do update set "),this.compileList(t.updates),t.updateWhere&&(this.append(" "),this.visitNode(t.updateWhere)))}visitOnDuplicateKey(t){this.append("on duplicate key update "),this.compileList(t.updates)}visitCreateIndex(t){this.append("create "),t.unique&&this.append("unique "),this.append("index "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.name),t.table&&(this.append(" on "),this.visitNode(t.table)),t.using&&(this.append(" using "),this.visitNode(t.using)),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.nullsNotDistinct&&this.append(" nulls not distinct"),t.where&&(this.append(" "),this.visitNode(t.where))}visitDropIndex(t){this.append("drop index "),t.ifExists&&this.append("if exists "),this.visitNode(t.name),t.table&&(this.append(" on "),this.visitNode(t.table)),t.cascade&&this.append(" cascade")}visitCreateSchema(t){this.append("create schema "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.schema)}visitDropSchema(t){this.append("drop schema "),t.ifExists&&this.append("if exists "),this.visitNode(t.schema),t.cascade&&this.append(" cascade")}visitPrimaryKeyConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("primary key ("),this.compileList(t.columns),this.append(")")}visitUniqueConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("unique"),t.nullsNotDistinct&&this.append(" nulls not distinct"),this.append(" ("),this.compileList(t.columns),this.append(")")}visitCheckConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("check ("),this.visitNode(t.expression),this.append(")")}visitForeignKeyConstraint(t){t.name&&(this.append("constraint "),this.visitNode(t.name),this.append(" ")),this.append("foreign key ("),this.compileList(t.columns),this.append(") "),this.visitNode(t.references),t.onDelete&&(this.append(" on delete "),this.append(t.onDelete)),t.onUpdate&&(this.append(" on update "),this.append(t.onUpdate))}visitList(t){this.compileList(t.items)}visitWith(t){this.append("with "),t.recursive&&this.append("recursive "),this.compileList(t.expressions)}visitCommonTableExpression(t){this.visitNode(t.name),this.append(" as "),isBoolean(t.materialized)&&(t.materialized||this.append("not "),this.append("materialized ")),this.visitNode(t.expression)}visitCommonTableExpressionName(t){this.visitNode(t.table),t.columns&&(this.append("("),this.compileList(t.columns),this.append(")"))}visitAlterTable(t){this.append("alter table "),this.visitNode(t.table),this.append(" "),t.renameTo&&(this.append("rename to "),this.visitNode(t.renameTo)),t.setSchema&&(this.append("set schema "),this.visitNode(t.setSchema)),t.addConstraint&&this.visitNode(t.addConstraint),t.dropConstraint&&this.visitNode(t.dropConstraint),t.columnAlterations&&this.compileColumnAlterations(t.columnAlterations),t.addIndex&&this.visitNode(t.addIndex),t.dropIndex&&this.visitNode(t.dropIndex)}visitAddColumn(t){this.append("add column "),this.visitNode(t.column)}visitRenameColumn(t){this.append("rename column "),this.visitNode(t.column),this.append(" to "),this.visitNode(t.renameTo)}visitDropColumn(t){this.append("drop column "),this.visitNode(t.column)}visitAlterColumn(t){this.append("alter column "),this.visitNode(t.column),this.append(" "),t.dataType&&(this.announcesNewColumnDataType()&&this.append("type "),this.visitNode(t.dataType),t.dataTypeExpression&&(this.append("using "),this.visitNode(t.dataTypeExpression))),t.setDefault&&(this.append("set default "),this.visitNode(t.setDefault)),t.dropDefault&&this.append("drop default"),t.setNotNull&&this.append("set not null"),t.dropNotNull&&this.append("drop not null")}visitModifyColumn(t){this.append("modify column "),this.visitNode(t.column)}visitAddConstraint(t){this.append("add "),this.visitNode(t.constraint)}visitDropConstraint(t){this.append("drop constraint "),t.ifExists&&this.append("if exists "),this.visitNode(t.constraintName),t.modifier==="cascade"?this.append(" cascade"):t.modifier==="restrict"&&this.append(" restrict")}visitSetOperation(t){this.append(t.operator),this.append(" "),t.all&&this.append("all "),this.visitNode(t.expression)}visitCreateView(t){this.append("create "),t.orReplace&&this.append("or replace "),t.materialized&&this.append("materialized "),t.temporary&&this.append("temporary "),this.append("view "),t.ifNotExists&&this.append("if not exists "),this.visitNode(t.name),this.append(" "),t.columns&&(this.append("("),this.compileList(t.columns),this.append(") ")),t.as&&(this.append("as "),this.visitNode(t.as))}visitDropView(t){this.append("drop "),t.materialized&&this.append("materialized "),this.append("view "),t.ifExists&&this.append("if exists "),this.visitNode(t.name),t.cascade&&this.append(" cascade")}visitGenerated(t){this.append("generated "),t.always&&this.append("always "),t.byDefault&&this.append("by default "),this.append("as "),t.identity&&this.append("identity"),t.expression&&(this.append("("),this.visitNode(t.expression),this.append(")")),t.stored&&this.append(" stored")}visitDefaultValue(t){this.append("default "),this.visitNode(t.defaultValue)}visitSelectModifier(t){t.rawModifier?this.visitNode(t.rawModifier):this.append(SELECT_MODIFIER_SQL[t.modifier]),t.of&&(this.append(" of "),this.compileList(t.of,", "))}visitCreateType(t){this.append("create type "),this.visitNode(t.name),t.enum&&(this.append(" as enum "),this.visitNode(t.enum))}visitDropType(t){this.append("drop type "),t.ifExists&&this.append("if exists "),this.visitNode(t.name)}visitExplain(t){this.append("explain"),(t.options||t.format)&&(this.append(" "),this.append(this.getLeftExplainOptionsWrapper()),t.options&&(this.visitNode(t.options),t.format&&this.append(this.getExplainOptionsDelimiter())),t.format&&(this.append("format"),this.append(this.getExplainOptionAssignment()),this.append(t.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(t){this.append("default")}visitAggregateFunction(t){this.append(t.func),this.append("("),t.distinct&&this.append("distinct "),this.compileList(t.aggregated),this.append(")"),t.filter&&(this.append(" filter("),this.visitNode(t.filter),this.append(")")),t.over&&(this.append(" "),this.visitNode(t.over))}visitOver(t){this.append("over("),t.partitionBy&&(this.visitNode(t.partitionBy),t.orderBy&&this.append(" ")),t.orderBy&&this.visitNode(t.orderBy),this.append(")")}visitPartitionBy(t){this.append("partition by "),this.compileList(t.items)}visitPartitionByItem(t){this.visitNode(t.partitionBy)}visitBinaryOperation(t){this.visitNode(t.leftOperand),this.append(" "),this.visitNode(t.operator),this.append(" "),this.visitNode(t.rightOperand)}visitUnaryOperation(t){this.visitNode(t.operator),this.isMinusOperator(t.operator)||this.append(" "),this.visitNode(t.operand)}isMinusOperator(t){return OperatorNode.is(t)&&t.operator==="-"}visitUsing(t){this.append("using "),this.compileList(t.tables)}visitFunction(t){this.append(t.func),this.append("("),this.compileList(t.arguments),this.append(")")}visitCase(t){this.append("case"),t.value&&(this.append(" "),this.visitNode(t.value)),t.when&&(this.append(" "),this.compileList(t.when," ")),t.else&&(this.append(" else "),this.visitNode(t.else)),this.append(" end"),t.isStatement&&this.append(" case")}visitWhen(t){this.append("when "),this.visitNode(t.condition),t.result&&(this.append(" then "),this.visitNode(t.result))}visitJSONReference(t){this.visitNode(t.reference),this.visitNode(t.traversal)}visitJSONPath(t){t.inOperator&&this.visitNode(t.inOperator),this.append("'$");for(const n of t.pathLegs)this.visitNode(n);this.append("'")}visitJSONPathLeg(t){const n=t.type==="ArrayLocation";this.append(n?"[":"."),this.append(String(t.value)),n&&this.append("]")}visitJSONOperatorChain(t){for(let n=0,o=t.values.length;n<o;n++)n===o-1?this.visitNode(t.operator):this.append("->"),this.visitNode(t.values[n])}visitMergeQuery(t){t.with&&(this.visitNode(t.with),this.append(" ")),this.append("merge "),t.top&&(this.visitNode(t.top),this.append(" ")),this.append("into "),this.visitNode(t.into),t.using&&(this.append(" "),this.visitNode(t.using)),t.whens&&(this.append(" "),this.compileList(t.whens))}visitMatched(t){t.not&&this.append("not "),this.append("matched"),t.bySource&&this.append(" by source")}visitAddIndex(t){this.append("add "),t.unique&&this.append("unique "),this.append("index "),this.visitNode(t.name),t.columns&&(this.append(" ("),this.compileList(t.columns),this.append(")")),t.using&&(this.append(" using "),this.visitNode(t.using))}visitCast(t){this.append("cast("),this.visitNode(t.expression),this.append(" as "),this.visitNode(t.dataType),this.append(")")}visitFetch(t){this.append("fetch next "),this.visitNode(t.rowCount),this.append(` rows ${t.modifier}`)}visitTop(t){this.append(`top(${t.expression})`),t.modifiers&&this.append(` ${t.modifiers}`)}append(t){x(this,ln,i(this,ln)+t)}appendValue(t){this.addParameter(t),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getCurrentParameterPlaceholder(){return"$"+this.numParameters}getLeftExplainOptionsWrapper(){return"("}getExplainOptionAssignment(){return" "}getExplainOptionsDelimiter(){return", "}getRightExplainOptionsWrapper(){return")"}sanitizeIdentifier(t){const n=this.getLeftIdentifierWrapper(),o=this.getRightIdentifierWrapper();let a="";for(const l of t)a+=l,l===n?a+=n:l===o&&(a+=o);return a}addParameter(t){i(this,vr).push(t)}appendImmediateValue(t){if(isString(t))this.append(`'${t}'`);else if(isNumber(t)||isBoolean(t))this.append(t.toString());else if(isNull(t))this.append("null");else if(isDate(t))this.appendImmediateValue(t.toISOString());else if(isBigInt(t))this.appendImmediateValue(t.toString());else throw new Error(`invalid immediate value ${t}`)}sortSelectModifiers(t){return t.sort((n,o)=>n.modifier&&o.modifier?SELECT_MODIFIER_PRIORITY[n.modifier]-SELECT_MODIFIER_PRIORITY[o.modifier]:1),freeze(t)}compileColumnAlterations(t){this.compileList(t)}announcesNewColumnDataType(){return!0}}ln=new WeakMap,vr=new WeakMap;const SELECT_MODIFIER_SQL=freeze({ForKeyShare:"for key share",ForNoKeyUpdate:"for no key update",ForUpdate:"for update",ForShare:"for share",NoWait:"nowait",SkipLocked:"skip locked",Distinct:"distinct"}),SELECT_MODIFIER_PRIORITY=freeze({ForKeyShare:1,ForNoKeyUpdate:1,ForUpdate:1,ForShare:1,NoWait:2,SkipLocked:2,Distinct:0}),JOIN_TYPE_SQL=freeze({InnerJoin:"inner join",LeftJoin:"left join",RightJoin:"right join",FullJoin:"full join",LateralInnerJoin:"inner join lateral",LateralLeftJoin:"left join lateral",Using:"using"}),CompiledQuery=freeze({raw(r,e=[]){return freeze({sql:r,query:RawNode.createWithSql(r),parameters:freeze(e)})}});class DialectAdapterBase{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}}var Pt,Mn,cn,dn;class SqliteDriver{constructor(e){g(this,Pt,void 0);g(this,Mn,new ConnectionMutex);g(this,cn,void 0);g(this,dn,void 0);x(this,Pt,freeze({...e}))}async init(){x(this,cn,isFunction(i(this,Pt).database)?await i(this,Pt).database():i(this,Pt).database),x(this,dn,new SqliteConnection(i(this,cn))),i(this,Pt).onCreateConnection&&await i(this,Pt).onCreateConnection(i(this,dn))}async acquireConnection(){return await i(this,Mn).lock(),i(this,dn)}async beginTransaction(e){await e.executeQuery(CompiledQuery.raw("begin"))}async commitTransaction(e){await e.executeQuery(CompiledQuery.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(CompiledQuery.raw("rollback"))}async releaseConnection(){i(this,Mn).unlock()}async destroy(){var e;(e=i(this,cn))==null||e.close()}}Pt=new WeakMap,Mn=new WeakMap,cn=new WeakMap,dn=new WeakMap;var fn;class SqliteConnection{constructor(e){g(this,fn,void 0);x(this,fn,e)}executeQuery(e){const{sql:t,parameters:n}=e,o=i(this,fn).prepare(t);if(o.reader)return Promise.resolve({rows:o.all(n)});{const{changes:a,lastInsertRowid:l}=o.run(n),d=a!=null?BigInt(a):void 0;return Promise.resolve({numUpdatedOrDeletedRows:d,numAffectedRows:d,insertId:l!=null?BigInt(l):void 0,rows:[]})}}async*streamQuery(e,t){const{sql:n,parameters:o,query:a}=e,l=i(this,fn).prepare(n);if(SelectQueryNode.is(a)){const d=l.iterate(o);for(const h of d)yield{rows:[h]}}else throw new Error("Sqlite driver only supports streaming of select queries")}}fn=new WeakMap;var Cr,hn;class ConnectionMutex{constructor(){g(this,Cr,void 0);g(this,hn,void 0)}async lock(){for(;i(this,Cr);)await i(this,Cr);x(this,Cr,new Promise(e=>{x(this,hn,e)}))}unlock(){const e=i(this,hn);x(this,Cr,void 0),x(this,hn,void 0),e==null||e()}}Cr=new WeakMap,hn=new WeakMap;const ID_WRAP_REGEX=/"/g;class SqliteQueryCompiler extends DefaultQueryCompiler{getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}sanitizeIdentifier(e){return e.replace(ID_WRAP_REGEX,'""')}visitDefaultInsertValue(e){this.append("null")}}const DEFAULT_MIGRATION_TABLE="kysely_migration",DEFAULT_MIGRATION_LOCK_TABLE="kysely_migration_lock";freeze({__noMigrations__:!0});var pn,Wi,oa;class SqliteIntrospector{constructor(e){g(this,Wi);g(this,pn,void 0);x(this,pn,e)}async getSchemas(){return[]}async getTables(e={withInternalKyselyTables:!1}){let t=i(this,pn).selectFrom("sqlite_master").where("type","in",["table","view"]).where("name","not like","sqlite_%").select("name").orderBy("name").$castTo();e.withInternalKyselyTables||(t=t.where("name","!=",DEFAULT_MIGRATION_TABLE).where("name","!=",DEFAULT_MIGRATION_LOCK_TABLE));const n=await t.execute();return Promise.all(n.map(({name:o})=>j(this,Wi,oa).call(this,o)))}async getMetadata(e){return{tables:await this.getTables(e)}}}pn=new WeakMap,Wi=new WeakSet,oa=async function(e){var l,d,h,p,m,E;const t=i(this,pn),n=await t.selectFrom("sqlite_master").where("name","=",e).select(["sql","type"]).$castTo().executeTakeFirstOrThrow(),o=(E=(m=(p=(h=(d=(l=n.sql)==null?void 0:l.split(/[\(\),]/))==null?void 0:d.find(k=>k.toLowerCase().includes("autoincrement")))==null?void 0:h.trimStart())==null?void 0:p.split(/\s+/))==null?void 0:m[0])==null?void 0:E.replace(/["`]/g,""),a=await t.selectFrom(sql`pragma_table_info(${e})`.as("table_info")).select(["name","type","notnull","dflt_value"]).orderBy("cid").execute();return{name:e,isView:n.type==="view",columns:a.map(k=>({name:k.name,dataType:k.type,isNullable:!k.notnull,isAutoIncrementing:k.name===o,hasDefaultValue:k.dflt_value!=null,comment:void 0}))}};class SqliteAdapter extends DialectAdapterBase{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(e,t){}async releaseMigrationLock(e,t){}}var Un;class SqliteDialect{constructor(e){g(this,Un,void 0);x(this,Un,freeze({...e}))}createDriver(){return new SqliteDriver(i(this,Un))}createQueryCompiler(){return new SqliteQueryCompiler}createAdapter(){return new SqliteAdapter}createIntrospector(e){return new SqliteIntrospector(e)}}Un=new WeakMap;const schema$1=[["site_id","object"],["cid","string"],["pk","object"],["table","string"],["val","any"],["db_version","number"],["col_version","number"],["cl","number"],["seq","number"]];function encode(r){return encode$1(r,schema$1)}function decode(r){return decode$1(r,schema$1)}function toBytes(r){return Uint8Array.from([...r].map(e=>e.charCodeAt(0)))}function fromBytes(r){return String.fromCharCode(...r)}function selectVersion(){const r=sql`SELECT 
    crsql_db_version() as current,
    IFNULL(MAX(version), 0) as synced
  FROM "__crstore_sync"`;return{execute:()=>r.execute(this).then(e=>e.rows[0])}}function updateVersion(r){return this.updateTable("__crstore_sync").set({version:r??sql`crsql_db_version()`})}function selectClient(){const r=sql`SELECT crsql_site_id() as client`;return{execute:()=>r.execute(this).then(e=>fromBytes(e.rows[0].client))}}function changesSince(r,{filter:e=void 0,chunk:t=!1}={}){let n=this.selectFrom("crsql_changes").select(sql`crsql_site_id()`.as("site_id")).select(["cid","pk","table","val","db_version","col_version","cl","seq"]).where("db_version",">",r).$if(!r,o=>o.where("cid","!=","__crsql_del")).$if(e===null,o=>o.where("site_id","is",sql`crsql_site_id()`)).$if(typeof e=="string",o=>o.where("site_id","is not",toBytes(e))).$castTo();return{execute:()=>n.execute().then(o=>t?chunk(o,{strict:!1}).map(encode):encode(o))}}function insertChanges(r){const e=async t=>{if(!r.length)return;const n=chunk(decode(r)).map(o=>t.insertInto("crsql_changes").values(o).execute());await Promise.all(n),await updateVersion.bind(t)().execute()};return{execute:()=>this.isTransaction?e(this):this.transaction().execute(e)}}function resolveChanges(r){return{execute:()=>applyOperation.bind(this)(e=>insertChanges.bind(e)(r).execute()).execute().then(e=>e.changes)}}function applyOperation(r,...e){return{execute:()=>this.transaction().execute(async t=>{const{current:n}=await selectVersion.bind(t)().execute(),o=await r(t,...e),a=await changesSince.bind(t)(n).execute();return{result:o,changes:a}})}}function finalize(){const r=sql`select crsql_finalize();`;return{execute:()=>r.execute(this)}}function affectedTables(r){var e,t,n,o;if(typeof r=="string")return[...new Set(decode(r).map(a=>a.table))];if(r.kind==="TableNode")return[r.table.identifier.name];if(r.kind==="ReferenceNode"&&r.table)return[r.table.table.identifier.name];if(r.kind==="AliasNode")return affectedTables(r.node);if(r.kind==="SelectQueryNode"){const a=[...((e=r.from)==null?void 0:e.froms)||[],...((t=r.joins)==null?void 0:t.map(l=>l.table))||[],...((n=r.selections)==null?void 0:n.map(l=>l.selection))||[],...((o=r.with)==null?void 0:o.expressions.map(l=>l.expression))||[]].flatMap(affectedTables);return[...new Set(a)]}return[]}const wasmUrl=""+new URL("../assets/crsqlite.CabMYEmC.wasm",import.meta.url).href;var Module=(()=>{var r=import.meta.url;return function(e={}){var t=e,n,o;t.ready=new Promise((s,u)=>{n=s,o=u});var a=Object.assign({},t),l="./this.program",d=(s,u)=>{throw u},h=typeof window=="object",p=typeof importScripts=="function",m="",E;(h||p)&&(p?m=self.location.href:typeof document<"u"&&document.currentScript&&(m=document.currentScript.src),r&&(m=r),m.indexOf("blob:")!==0?m=m.substr(0,m.replace(/[?#].*/,"").lastIndexOf("/")+1):m="",p&&(E=s=>{var u=new XMLHttpRequest;return u.open("GET",s,!1),u.responseType="arraybuffer",u.send(null),new Uint8Array(u.response)}));var k=t.print||console.log.bind(console),L=t.printErr||console.error.bind(console);Object.assign(t,a),a=null,t.thisProgram&&(l=t.thisProgram),t.quit&&(d=t.quit);var S;t.wasmBinary&&(S=t.wasmBinary);var y=t.noExitRuntime||!0;typeof WebAssembly!="object"&&we("no native wasm support detected");var w,b=!1,_,C,A,G,I,F,fe,$;function H(){var s=w.buffer;t.HEAP8=C=new Int8Array(s),t.HEAP16=G=new Int16Array(s),t.HEAPU8=A=new Uint8Array(s),t.HEAPU16=new Uint16Array(s),t.HEAP32=I=new Int32Array(s),t.HEAPU32=F=new Uint32Array(s),t.HEAPF32=fe=new Float32Array(s),t.HEAPF64=$=new Float64Array(s)}var Q=[],te=[],ue=[],X=[],be=0;function Re(){var s=t.preRun.shift();Q.unshift(s)}var M=0,ne=null;function we(s){throw t.onAbort&&t.onAbort(s),s="Aborted("+s+")",L(s),b=!0,_=1,s=new WebAssembly.RuntimeError(s+". Build with -sASSERTIONS for more info."),o(s),s}function Oe(s){return s.startsWith("data:application/octet-stream;base64,")}var le;if(t.locateFile){if(le="crsqlite.wasm",!Oe(le)){var Ze=le;le=t.locateFile?t.locateFile(Ze,m):m+Ze}}else le=new URL(""+new URL("../assets/crsqlite.CabMYEmC.wasm",import.meta.url).href,import.meta.url).href;function ut(s){if(s==le&&S)return new Uint8Array(S);if(E)return E(s);throw"both async and sync fetching of the wasm failed"}function et(s){return S||!h&&!p||typeof fetch!="function"?Promise.resolve().then(()=>ut(s)):fetch(s,{credentials:"same-origin"}).then(u=>{if(!u.ok)throw"failed to load wasm binary file at '"+s+"'";return u.arrayBuffer()}).catch(()=>ut(s))}function $t(s,u,c){return et(s).then(f=>WebAssembly.instantiate(f,u)).then(f=>f).then(c,f=>{L(`failed to asynchronously prepare wasm: ${f}`),we(f)})}function Vt(s,u){var c=le;return S||typeof WebAssembly.instantiateStreaming!="function"||Oe(c)||typeof fetch!="function"?$t(c,s,u):fetch(c,{credentials:"same-origin"}).then(f=>WebAssembly.instantiateStreaming(f,s).then(u,function(N){return L(`wasm streaming compile failed: ${N}`),L("falling back to ArrayBuffer instantiation"),$t(c,s,u)}))}var J,Ee;function Yn(s){this.name="ExitStatus",this.message=`Program terminated with exit(${s})`,this.status=s}var Wr=s=>{for(;0<s.length;)s.shift()(t)};function Ie(s,u="i8"){switch(u.endsWith("*")&&(u="*"),u){case"i1":return C[s>>0];case"i8":return C[s>>0];case"i16":return G[s>>1];case"i32":return I[s>>2];case"i64":we("to do getValue(i64) use WASM_BIGINT");case"float":return fe[s>>2];case"double":return $[s>>3];case"*":return F[s>>2];default:we(`invalid type for getValue: ${u}`)}}function Pe(s,u,c="i8"){switch(c.endsWith("*")&&(c="*"),c){case"i1":C[s>>0]=u;break;case"i8":C[s>>0]=u;break;case"i16":G[s>>1]=u;break;case"i32":I[s>>2]=u;break;case"i64":we("to do setValue(i64) use WASM_BIGINT");case"float":fe[s>>2]=u;break;case"double":$[s>>3]=u;break;case"*":F[s>>2]=u;break;default:we(`invalid type for setValue: ${c}`)}}var St=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0,se=(s,u,c)=>{var f=u+c;for(c=u;s[c]&&!(c>=f);)++c;if(16<c-u&&s.buffer&&St)return St.decode(s.subarray(u,c));for(f="";u<c;){var N=s[u++];if(N&128){var T=s[u++]&63;if((N&224)==192)f+=String.fromCharCode((N&31)<<6|T);else{var O=s[u++]&63;N=(N&240)==224?(N&15)<<12|T<<6|O:(N&7)<<18|T<<12|O<<6|s[u++]&63,65536>N?f+=String.fromCharCode(N):(N-=65536,f+=String.fromCharCode(55296|N>>10,56320|N&1023))}}else f+=String.fromCharCode(N)}return f},Zn=(s,u)=>{for(var c=0,f=s.length-1;0<=f;f--){var N=s[f];N==="."?s.splice(f,1):N===".."?(s.splice(f,1),c++):c&&(s.splice(f,1),c--)}if(u)for(;c;c--)s.unshift("..");return s},mt=s=>{var u=s.charAt(0)==="/",c=s.substr(-1)==="/";return(s=Zn(s.split("/").filter(f=>!!f),!u).join("/"))||u||(s="."),s&&c&&(s+="/"),(u?"/":"")+s},Ui=s=>{var u=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(s).slice(1);return s=u[0],u=u[1],!s&&!u?".":(u&&(u=u.substr(0,u.length-1)),s+u)},Dr=s=>{if(s==="/")return"/";s=mt(s),s=s.replace(/\/$/,"");var u=s.lastIndexOf("/");return u===-1?s:s.substr(u+1)},V=()=>{if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function")return s=>crypto.getRandomValues(s);we("initRandomDevice")},pe=s=>(pe=V())(s);function Se(){for(var s="",u=!1,c=arguments.length-1;-1<=c&&!u;c--){if(u=0<=c?arguments[c]:"/",typeof u!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!u)return"";s=u+"/"+s,u=u.charAt(0)==="/"}return s=Zn(s.split("/").filter(f=>!!f),!u).join("/"),(u?"/":"")+s||"."}var Ae=[],Ve=s=>{for(var u=0,c=0;c<s.length;++c){var f=s.charCodeAt(c);127>=f?u++:2047>=f?u+=2:55296<=f&&57343>=f?(u+=4,++c):u+=3}return u},qe=(s,u,c,f)=>{if(!(0<f))return 0;var N=c;f=c+f-1;for(var T=0;T<s.length;++T){var O=s.charCodeAt(T);if(55296<=O&&57343>=O){var W=s.charCodeAt(++T);O=65536+((O&1023)<<10)|W&1023}if(127>=O){if(c>=f)break;u[c++]=O}else{if(2047>=O){if(c+1>=f)break;u[c++]=192|O>>6}else{if(65535>=O){if(c+2>=f)break;u[c++]=224|O>>12}else{if(c+3>=f)break;u[c++]=240|O>>18,u[c++]=128|O>>12&63}u[c++]=128|O>>6&63}u[c++]=128|O&63}}return u[c]=0,c-N},ur=[];function ht(s,u){ur[s]={input:[],Ub:[],ec:u},Ki(s,$i)}var $i={open(s){var u=ur[s.node.ic];if(!u)throw new B(43);s.Vb=u,s.seekable=!1},close(s){s.Vb.ec.lc(s.Vb)},lc(s){s.Vb.ec.lc(s.Vb)},read(s,u,c,f){if(!s.Vb||!s.Vb.ec.Ac)throw new B(60);for(var N=0,T=0;T<f;T++){try{var O=s.Vb.ec.Ac(s.Vb)}catch{throw new B(29)}if(O===void 0&&N===0)throw new B(6);if(O==null)break;N++,u[c+T]=O}return N&&(s.node.timestamp=Date.now()),N},write(s,u,c,f){if(!s.Vb||!s.Vb.ec.uc)throw new B(60);try{for(var N=0;N<f;N++)s.Vb.ec.uc(s.Vb,u[c+N])}catch{throw new B(29)}return f&&(s.node.timestamp=Date.now()),N}},Vi={Ac(){e:{if(!Ae.length){var s=null;if(typeof window<"u"&&typeof window.prompt=="function"?(s=window.prompt("Input: "),s!==null&&(s+=`
`)):typeof readline=="function"&&(s=readline(),s!==null&&(s+=`
`)),!s){var u=null;break e}u=Array(Ve(s)+1),s=qe(s,u,0,u.length),u.length=s,Ae=u}u=Ae.shift()}return u},uc(s,u){u===null||u===10?(k(se(s.Ub,0)),s.Ub=[]):u!=0&&s.Ub.push(u)},lc(s){s.Ub&&0<s.Ub.length&&(k(se(s.Ub,0)),s.Ub=[])},ad(){return{Xc:25856,Zc:5,Wc:191,Yc:35387,Vc:[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},bd(){return 0},cd(){return[24,80]}},ha={uc(s,u){u===null||u===10?(L(se(s.Ub,0)),s.Ub=[]):u!=0&&s.Ub.push(u)},lc(s){s.Ub&&0<s.Ub.length&&(L(se(s.Ub,0)),s.Ub=[])}};function _s(s,u){var c=s.Qb?s.Qb.length:0;c>=u||(u=Math.max(u,c*(1048576>c?2:1.125)>>>0),c!=0&&(u=Math.max(u,256)),c=s.Qb,s.Qb=new Uint8Array(u),0<s.Sb&&s.Qb.set(c.subarray(0,s.Sb),0))}var ae={Yb:null,Xb(){return ae.createNode(null,"/",16895,0)},createNode(s,u,c,f){if((c&61440)===24576||(c&61440)===4096)throw new B(63);return ae.Yb||(ae.Yb={dir:{node:{Wb:ae.Fb.Wb,Tb:ae.Fb.Tb,fc:ae.Fb.fc,mc:ae.Fb.mc,Ec:ae.Fb.Ec,rc:ae.Fb.rc,pc:ae.Fb.pc,Dc:ae.Fb.Dc,qc:ae.Fb.qc},stream:{bc:ae.Pb.bc}},file:{node:{Wb:ae.Fb.Wb,Tb:ae.Fb.Tb},stream:{bc:ae.Pb.bc,read:ae.Pb.read,write:ae.Pb.write,xc:ae.Pb.xc,nc:ae.Pb.nc,oc:ae.Pb.oc}},link:{node:{Wb:ae.Fb.Wb,Tb:ae.Fb.Tb,jc:ae.Fb.jc},stream:{}},yc:{node:{Wb:ae.Fb.Wb,Tb:ae.Fb.Tb},stream:Na}}),c=Is(s,u,c,f),pt(c.mode)?(c.Fb=ae.Yb.dir.node,c.Pb=ae.Yb.dir.stream,c.Qb={}):(c.mode&61440)===32768?(c.Fb=ae.Yb.file.node,c.Pb=ae.Yb.file.stream,c.Sb=0,c.Qb=null):(c.mode&61440)===40960?(c.Fb=ae.Yb.link.node,c.Pb=ae.Yb.link.stream):(c.mode&61440)===8192&&(c.Fb=ae.Yb.yc.node,c.Pb=ae.Yb.yc.stream),c.timestamp=Date.now(),s&&(s.Qb[u]=c,s.timestamp=c.timestamp),c},$c(s){return s.Qb?s.Qb.subarray?s.Qb.subarray(0,s.Sb):new Uint8Array(s.Qb):new Uint8Array(0)},Fb:{Wb(s){var u={};return u.Kc=(s.mode&61440)===8192?s.id:1,u.Bc=s.id,u.mode=s.mode,u.Qc=1,u.uid=0,u.Nc=0,u.ic=s.ic,pt(s.mode)?u.size=4096:(s.mode&61440)===32768?u.size=s.Sb:(s.mode&61440)===40960?u.size=s.link.length:u.size=0,u.Gc=new Date(s.timestamp),u.Pc=new Date(s.timestamp),u.Jc=new Date(s.timestamp),u.Hc=4096,u.Ic=Math.ceil(u.size/u.Hc),u},Tb(s,u){if(u.mode!==void 0&&(s.mode=u.mode),u.timestamp!==void 0&&(s.timestamp=u.timestamp),u.size!==void 0&&(u=u.size,s.Sb!=u))if(u==0)s.Qb=null,s.Sb=0;else{var c=s.Qb;s.Qb=new Uint8Array(u),c&&s.Qb.set(c.subarray(0,Math.min(u,s.Sb))),s.Sb=u}},fc(){throw Hi[44]},mc(s,u,c,f){return ae.createNode(s,u,c,f)},Ec(s,u,c){if(pt(s.mode)){try{var f=lr(u,c)}catch{}if(f)for(var N in f.Qb)throw new B(55)}delete s.parent.Qb[s.name],s.parent.timestamp=Date.now(),s.name=c,u.Qb[c]=s,u.timestamp=s.parent.timestamp,s.parent=u},rc(s,u){delete s.Qb[u],s.timestamp=Date.now()},pc(s,u){var c=lr(s,u),f;for(f in c.Qb)throw new B(55);delete s.Qb[u],s.timestamp=Date.now()},Dc(s){var u=[".",".."],c;for(c in s.Qb)s.Qb.hasOwnProperty(c)&&u.push(c);return u},qc(s,u,c){return s=ae.createNode(s,u,41471,0),s.link=c,s},jc(s){if((s.mode&61440)!==40960)throw new B(28);return s.link}},Pb:{read(s,u,c,f,N){var T=s.node.Qb;if(N>=s.node.Sb)return 0;if(s=Math.min(s.node.Sb-N,f),8<s&&T.subarray)u.set(T.subarray(N,N+s),c);else for(f=0;f<s;f++)u[c+f]=T[N+f];return s},write(s,u,c,f,N,T){if(u.buffer===C.buffer&&(T=!1),!f)return 0;if(s=s.node,s.timestamp=Date.now(),u.subarray&&(!s.Qb||s.Qb.subarray)){if(T)return s.Qb=u.subarray(c,c+f),s.Sb=f;if(s.Sb===0&&N===0)return s.Qb=u.slice(c,c+f),s.Sb=f;if(N+f<=s.Sb)return s.Qb.set(u.subarray(c,c+f),N),f}if(_s(s,N+f),s.Qb.subarray&&u.subarray)s.Qb.set(u.subarray(c,c+f),N);else for(T=0;T<f;T++)s.Qb[N+T]=u[c+T];return s.Sb=Math.max(s.Sb,N+f),f},bc(s,u,c){if(c===1?u+=s.position:c===2&&(s.node.mode&61440)===32768&&(u+=s.node.Sb),0>u)throw new B(28);return u},xc(s,u,c){_s(s.node,u+c),s.node.Sb=Math.max(s.node.Sb,u+c)},nc(s,u,c,f,N){if((s.node.mode&61440)!==32768)throw new B(43);if(s=s.node.Qb,N&2||s.buffer!==C.buffer){if((0<c||c+u<s.length)&&(s.subarray?s=s.subarray(c,c+u):s=Array.prototype.slice.call(s,c,c+u)),c=!0,u=65536*Math.ceil(u/65536),(N=zo(65536,u))?(A.fill(0,N,N+u),u=N):u=0,!u)throw new B(48);C.set(s,u)}else c=!1,u=s.byteOffset;return{Rc:u,Fc:c}},oc(s,u,c,f){return ae.Pb.write(s,u,0,f,c,!1),0}}},pa=(s,u)=>{var c=0;return s&&(c|=365),u&&(c|=146),c},Ji=null,gs={},wn=[],ma=1,Jt=null,Os=!0,B=null,Hi={};function ot(s,u={}){if(s=Se(s),!s)return{path:"",node:null};if(u=Object.assign({zc:!0,vc:0},u),8<u.vc)throw new B(32);s=s.split("/").filter(O=>!!O);for(var c=Ji,f="/",N=0;N<s.length;N++){var T=N===s.length-1;if(T&&u.parent)break;if(c=lr(c,s[N]),f=mt(f+"/"+s[N]),c.cc&&(!T||T&&u.zc)&&(c=c.cc.root),!T||u.ac){for(T=0;(c.mode&61440)===40960;)if(c=As(f),f=Se(Ui(f),c),c=ot(f,{vc:u.vc+1}).node,40<T++)throw new B(32)}}return{path:f,node:c}}function ei(s){for(var u;;){if(s===s.parent)return s=s.Xb.Cc,u?s[s.length-1]!=="/"?`${s}/${u}`:s+u:s;u=u?`${s.name}/${u}`:s.name,s=s.parent}}function ji(s,u){for(var c=0,f=0;f<u.length;f++)c=(c<<5)-c+u.charCodeAt(f)|0;return(s+c>>>0)%Jt.length}function Ts(s){var u=ji(s.parent.id,s.name);if(Jt[u]===s)Jt[u]=s.dc;else for(u=Jt[u];u;){if(u.dc===s){u.dc=s.dc;break}u=u.dc}}function lr(s,u){var c;if(c=(c=Br(s,"x"))?c:s.Fb.fc?0:2)throw new B(c,s);for(c=Jt[ji(s.id,u)];c;c=c.dc){var f=c.name;if(c.parent.id===s.id&&f===u)return c}return s.Fb.fc(s,u)}function Is(s,u,c,f){return s=new Do(s,u,c,f),u=ji(s.parent.id,s.name),s.dc=Jt[u],Jt[u]=s}function pt(s){return(s&61440)===16384}function Ss(s){var u=["r","w","rw"][s&3];return s&512&&(u+="w"),u}function Br(s,u){if(Os)return 0;if(!u.includes("r")||s.mode&292){if(u.includes("w")&&!(s.mode&146)||u.includes("x")&&!(s.mode&73))return 2}else return 2;return 0}function vs(s,u){try{return lr(s,u),20}catch{}return Br(s,"wx")}function Cs(s,u,c){try{var f=lr(s,u)}catch(N){return N.Rb}if(s=Br(s,"wx"))return s;if(c){if(!pt(f.mode))return 54;if(f===f.parent||ei(f)==="/")return 10}else if(pt(f.mode))return 31;return 0}function ya(){for(var s=0;4096>=s;s++)if(!wn[s])return s;throw new B(33)}function tt(s){if(s=wn[s],!s)throw new B(8);return s}function Rs(s,u=-1){return _n||(_n=function(){this.kc={}},_n.prototype={},Object.defineProperties(_n.prototype,{object:{get(){return this.node},set(c){this.node=c}},flags:{get(){return this.kc.flags},set(c){this.kc.flags=c}},position:{get(){return this.kc.position},set(c){this.kc.position=c}}})),s=Object.assign(new _n,s),u==-1&&(u=ya()),s.Zb=u,wn[u]=s}var Na={open(s){s.Pb=gs[s.node.ic].Pb,s.Pb.open&&s.Pb.open(s)},bc(){throw new B(70)}};function Ki(s,u){gs[s]={Pb:u}}function xs(s,u){var c=u==="/",f=!u;if(c&&Ji)throw new B(10);if(!c&&!f){var N=ot(u,{zc:!1});if(u=N.path,N=N.node,N.cc)throw new B(10);if(!pt(N.mode))throw new B(54)}u={type:s,ed:{},Cc:u,Oc:[]},s=s.Xb(u),s.Xb=u,u.root=s,c?Ji=s:N&&(N.cc=u,N.Xb&&N.Xb.Oc.push(u))}function Gi(s,u,c){var f=ot(s,{parent:!0}).node;if(s=Dr(s),!s||s==="."||s==="..")throw new B(28);var N=vs(f,s);if(N)throw new B(N);if(!f.Fb.mc)throw new B(63);return f.Fb.mc(f,s,u,c)}function vt(s,u){return Gi(s,(u!==void 0?u:511)&1023|16384,0)}function ti(s,u,c){typeof c>"u"&&(c=u,u=438),Gi(s,u|8192,c)}function Xi(s,u){if(!Se(s))throw new B(44);var c=ot(u,{parent:!0}).node;if(!c)throw new B(44);u=Dr(u);var f=vs(c,u);if(f)throw new B(f);if(!c.Fb.qc)throw new B(63);c.Fb.qc(c,u,s)}function ks(s){var u=ot(s,{parent:!0}).node;s=Dr(s);var c=lr(u,s),f=Cs(u,s,!0);if(f)throw new B(f);if(!u.Fb.pc)throw new B(63);if(c.cc)throw new B(10);u.Fb.pc(u,s),Ts(c)}function As(s){if(s=ot(s).node,!s)throw new B(44);if(!s.Fb.jc)throw new B(28);return Se(ei(s.parent),s.Fb.jc(s))}function ri(s,u){if(s=ot(s,{ac:!u}).node,!s)throw new B(44);if(!s.Fb.Wb)throw new B(63);return s.Fb.Wb(s)}function Ls(s){return ri(s,!0)}function qs(s,u){if(s=typeof s=="string"?ot(s,{ac:!0}).node:s,!s.Fb.Tb)throw new B(63);s.Fb.Tb(s,{mode:u&4095|s.mode&-4096,timestamp:Date.now()})}function Ws(s,u){if(0>u)throw new B(28);if(s=typeof s=="string"?ot(s,{ac:!0}).node:s,!s.Fb.Tb)throw new B(63);if(pt(s.mode))throw new B(31);if((s.mode&61440)!==32768)throw new B(28);var c=Br(s,"w");if(c)throw new B(c);s.Fb.Tb(s,{size:u,timestamp:Date.now()})}function ni(s,u,c){if(s==="")throw new B(44);if(typeof u=="string"){var f={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090}[u];if(typeof f>"u")throw Error(`Unknown file open mode: ${u}`);u=f}if(c=u&64?(typeof c>"u"?438:c)&4095|32768:0,typeof s=="object")var N=s;else{s=mt(s);try{N=ot(s,{ac:!(u&131072)}).node}catch{}}if(f=!1,u&64)if(N){if(u&128)throw new B(20)}else N=Gi(s,c,0),f=!0;if(!N)throw new B(44);if((N.mode&61440)===8192&&(u&=-513),u&65536&&!pt(N.mode))throw new B(54);if(!f&&(c=N?(N.mode&61440)===40960?32:pt(N.mode)&&(Ss(u)!=="r"||u&512)?31:Br(N,Ss(u)):44))throw new B(c);return u&512&&!f&&Ws(N,0),u&=-131713,N=Rs({node:N,path:ei(N),flags:u,seekable:!0,position:0,Pb:N.Pb,Uc:[],error:!1}),N.Pb.open&&N.Pb.open(N),!t.logReadFiles||u&1||(ii||(ii={}),s in ii||(ii[s]=1)),N}function Ds(s,u,c){if(s.Zb===null)throw new B(8);if(!s.seekable||!s.Pb.bc)throw new B(70);if(c!=0&&c!=1&&c!=2)throw new B(28);s.position=s.Pb.bc(s,u,c),s.Uc=[]}function Bs(){B||(B=function(s,u){this.name="ErrnoError",this.node=u,this.Sc=function(c){this.Rb=c},this.Sc(s),this.message="FS error"},B.prototype=Error(),B.prototype.constructor=B,[44].forEach(s=>{Hi[s]=new B(s),Hi[s].stack="<generic error, no stack>"}))}var Fs;function En(s,u,c){s=mt("/dev/"+s);var f=pa(!!u,!!c);Yi||(Yi=64);var N=Yi++<<8|0;Ki(N,{open(T){T.seekable=!1},close(){c&&c.buffer&&c.buffer.length&&c(10)},read(T,O,W,v){for(var R=0,z=0;z<v;z++){try{var q=u()}catch{throw new B(29)}if(q===void 0&&R===0)throw new B(6);if(q==null)break;R++,O[W+z]=q}return R&&(T.node.timestamp=Date.now()),R},write(T,O,W,v){for(var R=0;R<v;R++)try{c(O[W+R])}catch{throw new B(29)}return v&&(T.node.timestamp=Date.now()),R}}),ti(s,f,N)}var Yi,Te={},_n,ii;function cr(s,u,c){if(u.charAt(0)==="/")return u;if(s=s===-100?"/":tt(s).path,u.length==0){if(!c)throw new B(44);return s}return mt(s+"/"+u)}function si(s,u,c){try{var f=s(u)}catch(T){if(T&&T.node&&mt(u)!==mt(ei(T.node)))return-54;throw T}I[c>>2]=f.Kc,I[c+4>>2]=f.mode,F[c+8>>2]=f.Qc,I[c+12>>2]=f.uid,I[c+16>>2]=f.Nc,I[c+20>>2]=f.ic,Ee=[f.size>>>0,(J=f.size,1<=+Math.abs(J)?0<J?+Math.floor(J/4294967296)>>>0:~~+Math.ceil((J-+(~~J>>>0))/4294967296)>>>0:0)],I[c+24>>2]=Ee[0],I[c+28>>2]=Ee[1],I[c+32>>2]=4096,I[c+36>>2]=f.Ic,s=f.Gc.getTime(),u=f.Pc.getTime();var N=f.Jc.getTime();return Ee=[Math.floor(s/1e3)>>>0,(J=Math.floor(s/1e3),1<=+Math.abs(J)?0<J?+Math.floor(J/4294967296)>>>0:~~+Math.ceil((J-+(~~J>>>0))/4294967296)>>>0:0)],I[c+40>>2]=Ee[0],I[c+44>>2]=Ee[1],F[c+48>>2]=s%1e3*1e3,Ee=[Math.floor(u/1e3)>>>0,(J=Math.floor(u/1e3),1<=+Math.abs(J)?0<J?+Math.floor(J/4294967296)>>>0:~~+Math.ceil((J-+(~~J>>>0))/4294967296)>>>0:0)],I[c+56>>2]=Ee[0],I[c+60>>2]=Ee[1],F[c+64>>2]=u%1e3*1e3,Ee=[Math.floor(N/1e3)>>>0,(J=Math.floor(N/1e3),1<=+Math.abs(J)?0<J?+Math.floor(J/4294967296)>>>0:~~+Math.ceil((J-+(~~J>>>0))/4294967296)>>>0:0)],I[c+72>>2]=Ee[0],I[c+76>>2]=Ee[1],F[c+80>>2]=N%1e3*1e3,Ee=[f.Bc>>>0,(J=f.Bc,1<=+Math.abs(J)?0<J?+Math.floor(J/4294967296)>>>0:~~+Math.ceil((J-+(~~J>>>0))/4294967296)>>>0:0)],I[c+88>>2]=Ee[0],I[c+92>>2]=Ee[1],0}var oi=void 0;function ai(){var s=I[oi>>2];return oi+=4,s}var gn=(s,u)=>u+2097152>>>0<4194305-!!s?(s>>>0)+4294967296*u:NaN,ba=[0,31,60,91,121,152,182,213,244,274,305,335],wa=[0,31,59,90,120,151,181,212,243,273,304,334],Qs=s=>{var u=Ve(s)+1,c=ns(u);return c&&qe(s,A,c,u),c},Zi={},zs=()=>{if(!es){var s={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:l||"./this.program"},u;for(u in Zi)Zi[u]===void 0?delete s[u]:s[u]=Zi[u];var c=[];for(u in s)c.push(`${u}=${s[u]}`);es=c}return es},es;function Ps(){}function Ms(){}function Us(){}function $s(){}function Vs(){}function Js(){}function Hs(){}function js(){}function Ks(){}function Gs(){}function Xs(){}function Ys(){}function Zs(){}function eo(){}function ro(){}function no(){}function io(){}function so(){}function oo(){}function ao(){}function uo(){}function lo(){}function co(){}function fo(){}function ho(){}function po(){}function mo(){}function yo(){}function No(){}function bo(){}function wo(){}function Eo(){}function _o(){}function go(){}function Oo(){}function To(){}function Io(){}function So(){}function vo(){}function Co(){}var Ro=s=>{_=s,y||0<be||(t.onExit&&t.onExit(s),b=!0),d(s,new Yn(s))},ts=s=>{s instanceof Yn||s=="unwind"||d(1,s)},ui=s=>{try{s()}catch(u){we(u)}};function Ea(s){var u={},c;for(c in s)(function(f){var N=s[f];u[f]=typeof N=="function"?function(){li.push(f);try{return N.apply(null,arguments)}finally{b||(li.pop()===f||we(),Ct&&Ht===1&&li.length===0&&(Ht=0,ui(Vo),typeof Fibers<"u"&&Fibers.fd()))}}:N})(c);return u}var Ht=0,Ct=null,xo=0,li=[],ko={},Ao={},_a=0,rs=null,ga=[];function Oa(){return new Promise((s,u)=>{rs={resolve:s,reject:u}})}function Ta(){var s=ns(16396),u=s+12;F[s>>2]=u,F[s+4>>2]=u+16384,u=li[0];var c=ko[u];return c===void 0&&(c=_a++,ko[u]=c,Ao[c]=u),I[s+8>>2]=c,s}function Lo(s){if(!b){if(Ht===0){var u=!1,c=!1;s((f=0)=>{if(!b&&(xo=f,u=!0,c)){Ht=2,ui(()=>Jo(Ct)),typeof Browser<"u"&&Browser.tc.Mc&&Browser.tc.resume(),f=!1;try{var N=(0,U[Ao[I[Ct+8>>2]]])()}catch(W){N=W,f=!0}var T=!1;if(!Ct){var O=rs;O&&(rs=null,(f?O.reject:O.resolve)(N),T=!0)}if(f&&!T)throw N}}),c=!0,u||(Ht=1,Ct=Ta(),typeof Browser<"u"&&Browser.tc.Mc&&Browser.tc.pause(),ui(()=>$o(Ct)))}else Ht===2?(Ht=0,ui(Ho),Fo(Ct),Ct=null,ga.forEach(f=>{if(!b)try{if(f(),!(y||0<be))try{_=f=_,Ro(f)}catch(N){ts(N)}}catch(N){ts(N)}})):we(`invalid state: ${Ht}`);return xo}}function qo(s){return Lo(u=>{s().then(u)})}var Wo={},yt=(s,u,c,f,N)=>{function T(q){return--be,v!==0&&Uo(v),u==="string"?q?se(A,q):"":u==="boolean"?!!q:q}var O={string:q=>{var P=0;if(q!=null&&q!==0){P=Ve(q)+1;var ie=ss(P);qe(q,A,ie,P),P=ie}return P},array:q=>{var P=ss(q.length);return C.set(q,P),P}};s=t["_"+s];var W=[],v=0;if(f)for(var R=0;R<f.length;R++){var z=O[c[R]];z?(v===0&&(v=Mo()),W[R]=z(f[R])):W[R]=f[R]}return c=Ct,f=s.apply(null,W),N=N&&N.async,be+=1,Ct!=c?Oa().then(T):(f=T(f),N?Promise.resolve(f):f)};function Do(s,u,c,f){s||(s=this),this.parent=s,this.Xb=s.Xb,this.cc=null,this.id=ma++,this.name=u,this.mode=c,this.Fb={},this.Pb={},this.ic=f}Object.defineProperties(Do.prototype,{read:{get:function(){return(this.mode&365)===365},set:function(s){s?this.mode|=365:this.mode&=-366}},write:{get:function(){return(this.mode&146)===146},set:function(s){s?this.mode|=146:this.mode&=-147}}}),Bs(),Jt=Array(4096),xs(ae,"/"),vt("/tmp"),vt("/home"),vt("/home/web_user"),function(){vt("/dev"),Ki(259,{read:()=>0,write:(f,N,T,O)=>O}),ti("/dev/null",259),ht(1280,Vi),ht(1536,ha),ti("/dev/tty",1280),ti("/dev/tty1",1536);var s=new Uint8Array(1024),u=0,c=()=>(u===0&&(u=pe(s).byteLength),s[--u]);En("random",c),En("urandom",c),vt("/dev/shm"),vt("/dev/shm/tmp")}(),function(){vt("/proc");var s=vt("/proc/self");vt("/proc/self/fd"),xs({Xb(){var u=Is(s,"fd",16895,73);return u.Fb={fc(c,f){var N=tt(+f);return c={parent:null,Xb:{Cc:"fake"},Fb:{jc:()=>N.path}},c.parent=c}},u}},"/proc/self/fd")}(),function(){const s=new Map;t.setAuthorizer=function(u,c,f){return c?s.set(u,{f:c,wc:f}):s.delete(u),yt("set_authorizer","number",["number"],[u])},Ps=function(u,c,f,N,T,O){if(s.has(u)){const{f:W,wc:v}=s.get(u);return W(v,c,f?f?se(A,f):"":null,N?N?se(A,N):"":null,T?T?se(A,T):"":null,O?O?se(A,O):"":null)}return 0}}(),function(){function s(f,N){const T=[];for(let O=0;f[N+O]!=0;++O){if(1e3<O)throw Error("C-string never terminated after 1k characters");T.push(f[N+O])}return String.fromCharCode(...T)}const u=new Map,c=new Map;t.updateHook=function(f,N){const T=u.size;return u.set(T,N),yt("update_hook","void",["number","number"],[f,T])},t.createFunction=function(f,N,T,O,W,v){const R=u.size;return u.set(R,{f:v,$b:W}),yt("create_function","number","number string number number number number".split(" "),[f,N,T,O,R,0])},t.createAggregate=function(f,N,T,O,W,v,R){const z=u.size;return u.set(z,{step:v,Lc:R,$b:W}),yt("create_function","number","number string number number number number".split(" "),[f,N,T,O,z,1])},t.getFunctionUserData=function(f){return c.get(f)},Js=function(f,N,T,O,W,v){f=u.get(f);const R=A;W=BigInt(v)<<32n|BigInt(W)&4294967295n,f(N,s(R,T),s(R,O),W)},Us=function(f,N,T,O){f=u.get(f),c.set(N,f.$b),f.f(N,new Uint32Array(A.buffer,O,T)),c.delete(N)},Vs=function(f,N,T,O){f=u.get(f),c.set(N,f.$b),f.step(N,new Uint32Array(A.buffer,O,T)),c.delete(N)},Ms=function(f,N){f=u.get(f),c.set(N,f.$b),f.Lc(N),c.delete(N)}}(),function(){const s=new Map;t.progressHandler=function(u,c,f,N){return f?s.set(u,{f,wc:N}):s.delete(u),yt("progress_handler",null,["number","number"],[u,c])},$s=function(u){if(s.has(u)){const{f:c,wc:f}=s.get(u);return c(f)}return 0}}(),function(){function s(v,R){const z=`get${v}`,q=`set${v}`;return new Proxy(new DataView(A.buffer,R,v==="Int32"?4:8),{get(P,ie){if(ie===z)return function(me,Me){if(!Me)throw Error("must be little endian");return P[ie](me,Me)};if(ie===q)return function(me,Me,We){if(!We)throw Error("must be little endian");return P[ie](me,Me,We)};if(typeof ie=="string"&&ie.match(/^(get)|(set)/))throw Error("invalid type");return P[ie]}})}const u=typeof Wo=="object",c=new Map,f=new Map,N=new Map,T=u?new Set:null,O=u?new Set:null,W=new Map;co=function(v,R,z,q){W.set(v?se(A,v):"",{size:R,hc:Array.from(new Uint32Array(A.buffer,q,z))})},t.createModule=function(v,R,z,q){u&&(z.handleAsync=qo);const P=c.size;return c.set(P,{module:z,$b:q}),q=0,z.xCreate&&(q|=1),z.xConnect&&(q|=2),z.xBestIndex&&(q|=4),z.xDisconnect&&(q|=8),z.xDestroy&&(q|=16),z.xOpen&&(q|=32),z.xClose&&(q|=64),z.xFilter&&(q|=128),z.xNext&&(q|=256),z.xEof&&(q|=512),z.xColumn&&(q|=1024),z.xRowid&&(q|=2048),z.xUpdate&&(q|=4096),z.xBegin&&(q|=8192),z.xSync&&(q|=16384),z.xCommit&&(q|=32768),z.xRollback&&(q|=65536),z.xFindFunction&&(q|=131072),z.xRename&&(q|=262144),yt("create_module","number",["number","string","number","number"],[v,R,P,q])},Zs=function(v,R,z,q,P,ie){if(R=c.get(R),f.set(P,R),u){T.delete(P);for(const me of T)f.delete(me)}return q=Array.from(new Uint32Array(A.buffer,q,z)).map(me=>me?se(A,me):""),R.module.xCreate(v,R.$b,q,P,s("Int32",ie))},Ys=function(v,R,z,q,P,ie){if(R=c.get(R),f.set(P,R),u){T.delete(P);for(const me of T)f.delete(me)}return q=Array.from(new Uint32Array(A.buffer,q,z)).map(me=>me?se(A,me):""),R.module.xConnect(v,R.$b,q,P,s("Int32",ie))},js=function(v,R){var z=f.get(v),q=W.get("sqlite3_index_info").hc;const P={};P.nConstraint=Ie(R+q[0],"i32"),P.aConstraint=[];for(var ie=Ie(R+q[1],"*"),me=W.get("sqlite3_index_constraint").size,Me=0;Me<P.nConstraint;++Me){var We=P.aConstraint,at=We.push,Je=ie+Me*me,Fr=W.get("sqlite3_index_constraint").hc,jt={};jt.iColumn=Ie(Je+Fr[0],"i32"),jt.op=Ie(Je+Fr[1],"i8"),jt.usable=!!Ie(Je+Fr[2],"i8"),at.call(We,jt)}for(P.nOrderBy=Ie(R+q[2],"i32"),P.aOrderBy=[],ie=Ie(R+q[3],"*"),me=W.get("sqlite3_index_orderby").size,Me=0;Me<P.nOrderBy;++Me)We=P.aOrderBy,at=We.push,Je=ie+Me*me,Fr=W.get("sqlite3_index_orderby").hc,jt={},jt.iColumn=Ie(Je+Fr[0],"i32"),jt.desc=!!Ie(Je+Fr[1],"i8"),at.call(We,jt);for(P.aConstraintUsage=[],ie=0;ie<P.nConstraint;++ie)P.aConstraintUsage.push({argvIndex:0,omit:!1});for(P.idxNum=Ie(R+q[5],"i32"),P.idxStr=null,P.orderByConsumed=!!Ie(R+q[8],"i8"),P.estimatedCost=Ie(R+q[9],"double"),P.estimatedRows=Ie(R+q[10],"i32"),P.idxFlags=Ie(R+q[11],"i32"),P.colUsed=Ie(R+q[12],"i32"),v=z.module.xBestIndex(v,P),z=W.get("sqlite3_index_info").hc,q=Ie(R+z[4],"*"),ie=W.get("sqlite3_index_constraint_usage").size,at=0;at<P.nConstraint;++at)me=q+at*ie,We=P.aConstraintUsage[at],Je=W.get("sqlite3_index_constraint_usage").hc,Pe(me+Je[0],We.argvIndex,"i32"),Pe(me+Je[1],We.omit?1:0,"i8");return Pe(R+z[5],P.idxNum,"i32"),typeof P.idxStr=="string"&&(q=Ve(P.idxStr),ie=yt("sqlite3_malloc","number",["number"],[q+1]),qe(P.idxStr,A,ie,q+1),Pe(R+z[6],ie,"*"),Pe(R+z[7],1,"i32")),Pe(R+z[8],P.orderByConsumed,"i32"),Pe(R+z[9],P.estimatedCost,"double"),Pe(R+z[10],P.estimatedRows,"i32"),Pe(R+z[11],P.idxFlags,"i32"),v},ro=function(v){const R=f.get(v);return u?T.add(v):f.delete(v),R.module.xDisconnect(v)},eo=function(v){const R=f.get(v);return u?T.add(v):f.delete(v),R.module.xDestroy(v)},oo=function(v,R){const z=f.get(v);if(N.set(R,z),u){O.delete(R);for(const q of O)N.delete(q)}return z.module.xOpen(v,R)},Ks=function(v){const R=N.get(v);return u?O.add(v):N.delete(v),R.module.xClose(v)},no=function(v){return N.get(v).module.xEof(v)?1:0},io=function(v,R,z,q,P){const ie=N.get(v);return z=z?z?se(A,z):"":null,P=new Uint32Array(A.buffer,P,q),ie.module.xFilter(v,R,z,P)},so=function(v){return N.get(v).module.xNext(v)},Gs=function(v,R,z){return N.get(v).module.xColumn(v,R,z)},lo=function(v,R){return N.get(v).module.xRowid(v,s("BigInt64",R))},ho=function(v,R,z,q){const P=f.get(v);return z=new Uint32Array(A.buffer,z,R),P.module.xUpdate(v,z,s("BigInt64",q))},Hs=function(v){return f.get(v).module.xBegin(v)},fo=function(v){return f.get(v).module.xSync(v)},Xs=function(v){return f.get(v).module.xCommit(v)},uo=function(v){return f.get(v).module.xRollback(v)},ao=function(v,R){const z=f.get(v);return R=R?se(A,R):"",z.module.xRename(v,R)}}(),function(){function s(O,W){const v=`get${O}`,R=`set${O}`;return new Proxy(new DataView(A.buffer,W,O==="Int32"?4:8),{get(z,q){if(q===v)return function(P,ie){if(!ie)throw Error("must be little endian");return z[q](P,ie)};if(q===R)return function(P,ie,me){if(!me)throw Error("must be little endian");return z[q](P,ie,me)};if(typeof q=="string"&&q.match(/^(get)|(set)/))throw Error("invalid type");return z[q]}})}function u(O){return O>>=2,F[O]+F[O+1]*2**32}const c=typeof Wo=="object",f=new Map,N=new Map;t.registerVFS=function(O,W){if(yt("sqlite3_vfs_find","number",["string"],[O.name]))throw Error(`VFS '${O.name}' already registered`);c&&(O.handleAsync=qo);var v=O.dd??64;const R=t._malloc(4);return W=yt("register_vfs","number",["string","number","number","number"],[O.name,v,W?1:0,R]),W||(v=Ie(R,"*"),f.set(v,O)),t._free(R),W};const T=c?new Set:null;yo=function(O){const W=N.get(O);return c?T.add(O):N.delete(O),W.xClose(O)},Oo=function(O,W,v,R){return N.get(O).xRead(O,A.subarray(W,W+v),u(R))},Co=function(O,W,v,R){return N.get(O).xWrite(O,A.subarray(W,W+v),u(R))},So=function(O,W){return N.get(O).xTruncate(O,u(W))},Io=function(O,W){return N.get(O).xSync(O,W)},Eo=function(O,W){const v=N.get(O);return W=s("BigInt64",W),v.xFileSize(O,W)},_o=function(O,W){return N.get(O).xLock(O,W)},vo=function(O,W){return N.get(O).xUnlock(O,W)},mo=function(O,W){const v=N.get(O);return W=s("Int32",W),v.xCheckReservedLock(O,W)},wo=function(O,W,v){const R=N.get(O);return v=new DataView(A.buffer,v),R.xFileControl(O,W,v)},To=function(O){return N.get(O).xSectorSize(O)},bo=function(O){return N.get(O).xDeviceCharacteristics(O)},go=function(O,W,v,R,z){if(O=f.get(O),N.set(v,O),c){T.delete(v);for(var q of T)N.delete(q)}if(q=null,R&64){q=1;const P=[];for(;q;){const ie=A[W++];if(ie)P.push(ie);else switch(A[W]||(q=null),q){case 1:P.push(63),q=2;break;case 2:P.push(61),q=3;break;case 3:P.push(38),q=2}}q=new TextDecoder().decode(new Uint8Array(P))}else W&&(q=W?se(A,W):"");return z=s("Int32",z),O.xOpen(q,v,R,z)},No=function(O,W,v){return f.get(O).xDelete(W?se(A,W):"",v)},po=function(O,W,v,R){return O=f.get(O),R=s("Int32",R),O.xAccess(W?se(A,W):"",v,R)}}();var Ia={a:(s,u,c,f)=>{we(`Assertion failed: ${s?se(A,s):""}, at: `+[u?u?se(A,u):"":"unknown filename",c,f?f?se(A,f):"":"unknown function"])},L:function(s,u){try{return s=s?se(A,s):"",qs(s,u),0}catch(c){if(typeof Te>"u"||c.name!=="ErrnoError")throw c;return-c.Rb}},N:function(s,u,c){try{if(u=u?se(A,u):"",u=cr(s,u),c&-8)return-28;var f=ot(u,{ac:!0}).node;return f?(s="",c&4&&(s+="r"),c&2&&(s+="w"),c&1&&(s+="x"),s&&Br(f,s)?-2:0):-44}catch(N){if(typeof Te>"u"||N.name!=="ErrnoError")throw N;return-N.Rb}},M:function(s,u){try{var c=tt(s);return qs(c.node,u),0}catch(f){if(typeof Te>"u"||f.name!=="ErrnoError")throw f;return-f.Rb}},K:function(s){try{var u=tt(s).node,c=typeof u=="string"?ot(u,{ac:!0}).node:u;if(!c.Fb.Tb)throw new B(63);return c.Fb.Tb(c,{timestamp:Date.now()}),0}catch(f){if(typeof Te>"u"||f.name!=="ErrnoError")throw f;return-f.Rb}},b:function(s,u,c){oi=c;try{var f=tt(s);switch(u){case 0:var N=ai();if(0>N)return-28;for(;wn[N];)N++;return Rs(f,N).Zb;case 1:case 2:return 0;case 3:return f.flags;case 4:return N=ai(),f.flags|=N,0;case 5:return N=ai(),G[N+0>>1]=2,0;case 6:case 7:return 0;case 16:case 8:return-28;case 9:return I[Bo()>>2]=28,-1;default:return-28}}catch(T){if(typeof Te>"u"||T.name!=="ErrnoError")throw T;return-T.Rb}},J:function(s,u){try{var c=tt(s);return si(ri,c.path,u)}catch(f){if(typeof Te>"u"||f.name!=="ErrnoError")throw f;return-f.Rb}},n:function(s,u,c){u=gn(u,c);try{if(isNaN(u))return 61;var f=tt(s);if(!(f.flags&2097155))throw new B(28);return Ws(f.node,u),0}catch(N){if(typeof Te>"u"||N.name!=="ErrnoError")throw N;return-N.Rb}},D:function(s,u){try{if(u===0)return-28;var c=Ve("/")+1;return u<c?-68:(qe("/",A,s,u),c)}catch(f){if(typeof Te>"u"||f.name!=="ErrnoError")throw f;return-f.Rb}},G:function(s,u){try{return s=s?se(A,s):"",si(Ls,s,u)}catch(c){if(typeof Te>"u"||c.name!=="ErrnoError")throw c;return-c.Rb}},A:function(s,u,c){try{return u=u?se(A,u):"",u=cr(s,u),u=mt(u),u[u.length-1]==="/"&&(u=u.substr(0,u.length-1)),vt(u,c),0}catch(f){if(typeof Te>"u"||f.name!=="ErrnoError")throw f;return-f.Rb}},F:function(s,u,c,f){try{u=u?se(A,u):"";var N=f&256;return u=cr(s,u,f&4096),si(N?Ls:ri,u,c)}catch(T){if(typeof Te>"u"||T.name!=="ErrnoError")throw T;return-T.Rb}},z:function(s,u,c,f){oi=f;try{u=u?se(A,u):"",u=cr(s,u);var N=f?ai():0;return ni(u,c,N).Zb}catch(T){if(typeof Te>"u"||T.name!=="ErrnoError")throw T;return-T.Rb}},w:function(s,u,c,f){try{if(u=u?se(A,u):"",u=cr(s,u),0>=f)return-28;var N=As(u),T=Math.min(f,Ve(N)),O=C[c+T];return qe(N,A,c,f+1),C[c+T]=O,T}catch(W){if(typeof Te>"u"||W.name!=="ErrnoError")throw W;return-W.Rb}},v:function(s){try{return s=s?se(A,s):"",ks(s),0}catch(u){if(typeof Te>"u"||u.name!=="ErrnoError")throw u;return-u.Rb}},H:function(s,u){try{return s=s?se(A,s):"",si(ri,s,u)}catch(c){if(typeof Te>"u"||c.name!=="ErrnoError")throw c;return-c.Rb}},r:function(s,u,c){try{if(u=u?se(A,u):"",u=cr(s,u),c===0){s=u;var f=ot(s,{parent:!0}).node;if(!f)throw new B(44);var N=Dr(s),T=lr(f,N),O=Cs(f,N,!1);if(O)throw new B(O);if(!f.Fb.rc)throw new B(63);if(T.cc)throw new B(10);f.Fb.rc(f,N),Ts(T)}else c===512?ks(u):we("Invalid flags passed to unlinkat");return 0}catch(W){if(typeof Te>"u"||W.name!=="ErrnoError")throw W;return-W.Rb}},q:function(s,u,c){try{if(u=u?se(A,u):"",u=cr(s,u,!0),c){var f=F[c>>2]+4294967296*I[c+4>>2],N=I[c+8>>2];T=1e3*f+N/1e6,c+=16,f=F[c>>2]+4294967296*I[c+4>>2],N=I[c+8>>2],O=1e3*f+N/1e6}else var T=Date.now(),O=T;s=T;var W=ot(u,{ac:!0}).node;return W.Fb.Tb(W,{timestamp:Math.max(s,O)}),0}catch(v){if(typeof Te>"u"||v.name!=="ErrnoError")throw v;return-v.Rb}},k:function(s,u,c){s=new Date(1e3*gn(s,u)),I[c>>2]=s.getSeconds(),I[c+4>>2]=s.getMinutes(),I[c+8>>2]=s.getHours(),I[c+12>>2]=s.getDate(),I[c+16>>2]=s.getMonth(),I[c+20>>2]=s.getFullYear()-1900,I[c+24>>2]=s.getDay(),u=s.getFullYear(),I[c+28>>2]=(u%4!==0||u%100===0&&u%400!==0?wa:ba)[s.getMonth()]+s.getDate()-1|0,I[c+36>>2]=-(60*s.getTimezoneOffset()),u=new Date(s.getFullYear(),6,1).getTimezoneOffset();var f=new Date(s.getFullYear(),0,1).getTimezoneOffset();I[c+32>>2]=(u!=f&&s.getTimezoneOffset()==Math.min(f,u))|0},i:function(s,u,c,f,N,T,O,W){N=gn(N,T);try{if(isNaN(N))return 61;var v=tt(f);if(u&2&&!(c&2)&&(v.flags&2097155)!==2)throw new B(2);if((v.flags&2097155)===1)throw new B(2);if(!v.Pb.nc)throw new B(43);var R=v.Pb.nc(v,s,N,u,c),z=R.Rc;return I[O>>2]=R.Fc,F[W>>2]=z,0}catch(q){if(typeof Te>"u"||q.name!=="ErrnoError")throw q;return-q.Rb}},j:function(s,u,c,f,N,T,O){T=gn(T,O);try{if(isNaN(T))return 61;var W=tt(N);if(c&2){if((W.node.mode&61440)!==32768)throw new B(43);f&2||W.Pb.oc&&W.Pb.oc(W,A.slice(s,s+u),T,u,f)}}catch(v){if(typeof Te>"u"||v.name!=="ErrnoError")throw v;return-v.Rb}},s:(s,u,c)=>{function f(v){return(v=v.toTimeString().match(/\(([A-Za-z ]+)\)$/))?v[1]:"GMT"}var N=new Date().getFullYear(),T=new Date(N,0,1),O=new Date(N,6,1);N=T.getTimezoneOffset();var W=O.getTimezoneOffset();F[s>>2]=60*Math.max(N,W),I[u>>2]=+(N!=W),s=f(T),u=f(O),s=Qs(s),u=Qs(u),W<N?(F[c>>2]=s,F[c+4>>2]=u):(F[c>>2]=u,F[c+4>>2]=s)},e:()=>Date.now(),d:()=>performance.now(),t:(s,u,c)=>A.copyWithin(s,u,u+c),o:s=>{var u=A.length;if(s>>>=0,2147483648<s)return!1;for(var c=1;4>=c;c*=2){var f=u*(1+.2/c);f=Math.min(f,s+100663296);var N=Math;f=Math.max(s,f);e:{N=(N.min.call(N,2147483648,f+(65536-f%65536)%65536)-w.buffer.byteLength+65535)/65536;try{w.grow(N),H();var T=1;break e}catch{}T=void 0}if(T)return!0}return!1},B:(s,u)=>{var c=0;return zs().forEach((f,N)=>{var T=u+c;for(N=F[s+4*N>>2]=T,T=0;T<f.length;++T)C[N++>>0]=f.charCodeAt(T);C[N>>0]=0,c+=f.length+1}),0},C:(s,u)=>{var c=zs();F[s>>2]=c.length;var f=0;return c.forEach(N=>f+=N.length+1),F[u>>2]=f,0},f:function(s){try{var u=tt(s);if(u.Zb===null)throw new B(8);u.sc&&(u.sc=null);try{u.Pb.close&&u.Pb.close(u)}catch(c){throw c}finally{wn[u.Zb]=null}return u.Zb=null,0}catch(c){if(typeof Te>"u"||c.name!=="ErrnoError")throw c;return c.Rb}},p:function(s,u){try{var c=tt(s);return C[u>>0]=c.Vb?2:pt(c.mode)?3:(c.mode&61440)===40960?7:4,G[u+2>>1]=0,Ee=[0,(J=0,1<=+Math.abs(J)?0<J?+Math.floor(J/4294967296)>>>0:~~+Math.ceil((J-+(~~J>>>0))/4294967296)>>>0:0)],I[u+8>>2]=Ee[0],I[u+12>>2]=Ee[1],Ee=[0,(J=0,1<=+Math.abs(J)?0<J?+Math.floor(J/4294967296)>>>0:~~+Math.ceil((J-+(~~J>>>0))/4294967296)>>>0:0)],I[u+16>>2]=Ee[0],I[u+20>>2]=Ee[1],0}catch(f){if(typeof Te>"u"||f.name!=="ErrnoError")throw f;return f.Rb}},y:function(s,u,c,f){try{e:{var N=tt(s);s=u;for(var T,O=u=0;O<c;O++){var W=F[s>>2],v=F[s+4>>2];s+=8;var R=N,z=W,q=v,P=T,ie=C;if(0>q||0>P)throw new B(28);if(R.Zb===null)throw new B(8);if((R.flags&2097155)===1)throw new B(8);if(pt(R.node.mode))throw new B(31);if(!R.Pb.read)throw new B(28);var me=typeof P<"u";if(!me)P=R.position;else if(!R.seekable)throw new B(70);var Me=R.Pb.read(R,ie,z,q,P);me||(R.position+=Me);var We=Me;if(0>We){var at=-1;break e}if(u+=We,We<v)break;typeof T<"u"&&(T+=We)}at=u}return F[f>>2]=at,0}catch(Je){if(typeof Te>"u"||Je.name!=="ErrnoError")throw Je;return Je.Rb}},l:function(s,u,c,f,N){u=gn(u,c);try{if(isNaN(u))return 61;var T=tt(s);return Ds(T,u,f),Ee=[T.position>>>0,(J=T.position,1<=+Math.abs(J)?0<J?+Math.floor(J/4294967296)>>>0:~~+Math.ceil((J-+(~~J>>>0))/4294967296)>>>0:0)],I[N>>2]=Ee[0],I[N+4>>2]=Ee[1],T.sc&&u===0&&f===0&&(T.sc=null),0}catch(O){if(typeof Te>"u"||O.name!=="ErrnoError")throw O;return O.Rb}},E:function(s){try{var u=tt(s);return Lo(c=>{var f=u.node.Xb;f.type.Tc?f.type.Tc(f,!1,N=>{c(N?29:0)}):c(0)})}catch(c){if(typeof Te>"u"||c.name!=="ErrnoError")throw c;return c.Rb}},u:function(s,u,c,f){try{e:{var N=tt(s);s=u;for(var T,O=u=0;O<c;O++){var W=F[s>>2],v=F[s+4>>2];s+=8;var R=N,z=W,q=v,P=T,ie=C;if(0>q||0>P)throw new B(28);if(R.Zb===null)throw new B(8);if(!(R.flags&2097155))throw new B(8);if(pt(R.node.mode))throw new B(31);if(!R.Pb.write)throw new B(28);R.seekable&&R.flags&1024&&Ds(R,0,2);var me=typeof P<"u";if(!me)P=R.position;else if(!R.seekable)throw new B(70);var Me=R.Pb.write(R,ie,z,q,P,void 0);me||(R.position+=Me);var We=Me;if(0>We){var at=-1;break e}u+=We,typeof T<"u"&&(T+=We)}at=u}return F[f>>2]=at,0}catch(Je){if(typeof Te>"u"||Je.name!=="ErrnoError")throw Je;return Je.Rb}},ta:Ps,P:Ms,ia:Us,da:$s,_:Vs,I:Js,ma:Hs,x:js,g:Ks,pa:Gs,ka:Xs,fa:Ys,ga:Zs,h:eo,m:ro,qa:no,sa:io,ra:so,ea:oo,ha:ao,ja:uo,oa:lo,c:co,la:fo,na:ho,ba:po,W:mo,aa:yo,ca:No,T:bo,V:wo,Z:Eo,Y:_o,S:go,R:Oo,U:To,$:Io,O:So,X:vo,Q:Co},U=function(){function s(c){if(c=c.exports,U=c=Ea(c),w=U.ua,H(),te.unshift(U.va),M--,t.monitorRunDependencies&&t.monitorRunDependencies(M),M==0&&ne){var f=ne;ne=null,f()}return c}var u={a:Ia};if(M++,t.monitorRunDependencies&&t.monitorRunDependencies(M),t.instantiateWasm)try{return t.instantiateWasm(u,s)}catch(c){L(`Module.instantiateWasm callback failed with error: ${c}`),o(c)}return Vt(u,function(c){s(c.instance)}).catch(o),{}}();t._sqlite3_step=s=>(t._sqlite3_step=U.wa)(s),t._sqlite3_malloc=s=>(t._sqlite3_malloc=U.xa)(s),t._sqlite3_free=s=>(t._sqlite3_free=U.ya)(s),t._sqlite3_bind_blob=(s,u,c,f,N)=>(t._sqlite3_bind_blob=U.za)(s,u,c,f,N),t._sqlite3_bind_int=(s,u,c)=>(t._sqlite3_bind_int=U.Aa)(s,u,c),t._sqlite3_bind_int64=(s,u,c,f)=>(t._sqlite3_bind_int64=U.Ba)(s,u,c,f),t._sqlite3_bind_double=(s,u,c)=>(t._sqlite3_bind_double=U.Ca)(s,u,c),t._sqlite3_bind_null=(s,u)=>(t._sqlite3_bind_null=U.Da)(s,u),t._sqlite3_clear_bindings=s=>(t._sqlite3_clear_bindings=U.Ea)(s),t._sqlite3_bind_text=(s,u,c,f,N)=>(t._sqlite3_bind_text=U.Fa)(s,u,c,f,N),t._sqlite3_close=s=>(t._sqlite3_close=U.Ga)(s),t._sqlite3_column_type=(s,u)=>(t._sqlite3_column_type=U.Ha)(s,u),t._sqlite3_column_count=s=>(t._sqlite3_column_count=U.Ia)(s),t._sqlite3_column_text=(s,u)=>(t._sqlite3_column_text=U.Ja)(s,u),t._sqlite3_column_blob=(s,u)=>(t._sqlite3_column_blob=U.Ka)(s,u),t._sqlite3_column_bytes=(s,u)=>(t._sqlite3_column_bytes=U.La)(s,u),t._sqlite3_column_double=(s,u)=>(t._sqlite3_column_double=U.Ma)(s,u),t._sqlite3_column_int=(s,u)=>(t._sqlite3_column_int=U.Na)(s,u),t._sqlite3_column_int64=(s,u)=>(t._sqlite3_column_int64=U.Oa)(s,u),t._sqlite3_column_name=(s,u)=>(t._sqlite3_column_name=U.Pa)(s,u),t._sqlite3_declare_vtab=(s,u)=>(t._sqlite3_declare_vtab=U.Qa)(s,u),t._sqlite3_errmsg=s=>(t._sqlite3_errmsg=U.Ra)(s),t._sqlite3_exec=(s,u,c,f,N)=>(t._sqlite3_exec=U.Sa)(s,u,c,f,N),t._sqlite3_finalize=s=>(t._sqlite3_finalize=U.Ta)(s),t._sqlite3_prepare_v2=(s,u,c,f,N)=>(t._sqlite3_prepare_v2=U.Ua)(s,u,c,f,N),t._sqlite3_result_int=(s,u)=>(t._sqlite3_result_int=U.Va)(s,u),t._sqlite3_result_blob=(s,u,c,f)=>(t._sqlite3_result_blob=U.Wa)(s,u,c,f),t._sqlite3_result_int64=(s,u,c)=>(t._sqlite3_result_int64=U.Xa)(s,u,c),t._sqlite3_result_double=(s,u)=>(t._sqlite3_result_double=U.Ya)(s,u),t._sqlite3_result_null=s=>(t._sqlite3_result_null=U.Za)(s),t._sqlite3_result_error=(s,u,c)=>(t._sqlite3_result_error=U._a)(s,u,c),t._sqlite3_result_text=(s,u,c,f)=>(t._sqlite3_result_text=U.$a)(s,u,c,f),t._sqlite3_sql=s=>(t._sqlite3_sql=U.ab)(s),t._sqlite3_reset=s=>(t._sqlite3_reset=U.bb)(s),t._sqlite3_value_text=s=>(t._sqlite3_value_text=U.cb)(s),t._sqlite3_value_type=s=>(t._sqlite3_value_type=U.db)(s),t._sqlite3_value_bytes=s=>(t._sqlite3_value_bytes=U.eb)(s),t._sqlite3_value_blob=s=>(t._sqlite3_value_blob=U.fb)(s),t._sqlite3_value_int=s=>(t._sqlite3_value_int=U.gb)(s),t._sqlite3_value_int64=s=>(t._sqlite3_value_int64=U.hb)(s),t._sqlite3_value_double=s=>(t._sqlite3_value_double=U.ib)(s),t._sqlite3_get_autocommit=s=>(t._sqlite3_get_autocommit=U.jb)(s),t._sqlite3_vfs_find=s=>(t._sqlite3_vfs_find=U.kb)(s),t._sqlite3_data_count=s=>(t._sqlite3_data_count=U.lb)(s),t._sqlite3_bind_parameter_count=s=>(t._sqlite3_bind_parameter_count=U.mb)(s),t._sqlite3_bind_parameter_name=(s,u)=>(t._sqlite3_bind_parameter_name=U.nb)(s,u),t._sqlite3_libversion=()=>(t._sqlite3_libversion=U.ob)(),t._sqlite3_libversion_number=()=>(t._sqlite3_libversion_number=U.pb)(),t._sqlite3_changes=s=>(t._sqlite3_changes=U.qb)(s),t._sqlite3_limit=(s,u,c)=>(t._sqlite3_limit=U.rb)(s,u,c),t._sqlite3_open_v2=(s,u,c,f)=>(t._sqlite3_open_v2=U.sb)(s,u,c,f);var Bo=()=>(Bo=U.tb)(),ns=t._malloc=s=>(ns=t._malloc=U.ub)(s),Fo=t._free=s=>(Fo=t._free=U.vb)(s);t._RegisterExtensionFunctions=s=>(t._RegisterExtensionFunctions=U.wb)(s),t._set_authorizer=s=>(t._set_authorizer=U.xb)(s),t._create_function=(s,u,c,f,N,T)=>(t._create_function=U.yb)(s,u,c,f,N,T),t._update_hook=(s,u)=>(t._update_hook=U.zb)(s,u),t._create_module=(s,u,c,f)=>(t._create_module=U.Ab)(s,u,c,f),t._progress_handler=(s,u)=>(t._progress_handler=U.Bb)(s,u),t._register_vfs=(s,u,c,f)=>(t._register_vfs=U.Cb)(s,u,c,f),t._getSqliteFree=()=>(t._getSqliteFree=U.Db)();var Qo=t._main=(s,u)=>(Qo=t._main=U.Eb)(s,u),zo=(s,u)=>(zo=U.Gb)(s,u),Po=()=>(Po=U.Hb)(),Mo=()=>(Mo=U.Ib)(),Uo=s=>(Uo=U.Jb)(s),ss=s=>(ss=U.Kb)(s),$o=s=>($o=U.Lb)(s),Vo=()=>(Vo=U.Mb)(),Jo=s=>(Jo=U.Nb)(s),Ho=()=>(Ho=U.Ob)();t.getTempRet0=Po,t.ccall=yt,t.cwrap=(s,u,c,f)=>{var N=!c||c.every(T=>T==="number"||T==="boolean");return u!=="string"&&N&&!f?t["_"+s]:function(){return yt(s,u,c,arguments,f)}},t.setValue=Pe,t.getValue=Ie,t.UTF8ToString=(s,u)=>s?se(A,s,u):"",t.stringToUTF8=(s,u,c)=>qe(s,A,u,c),t.lengthBytesUTF8=Ve;var ci;ne=function s(){ci||jo(),ci||(ne=s)};function jo(){function s(){if(!ci&&(ci=!0,t.calledRun=!0,!b)){if(t.noFSInit||Fs||(Fs=!0,Bs(),t.stdin=t.stdin,t.stdout=t.stdout,t.stderr=t.stderr,t.stdin?En("stdin",t.stdin):Xi("/dev/tty","/dev/stdin"),t.stdout?En("stdout",null,t.stdout):Xi("/dev/tty","/dev/stdout"),t.stderr?En("stderr",null,t.stderr):Xi("/dev/tty1","/dev/stderr"),ni("/dev/stdin",0),ni("/dev/stdout",1),ni("/dev/stderr",1)),Os=!1,Wr(te),Wr(ue),n(t),t.onRuntimeInitialized&&t.onRuntimeInitialized(),Ko){var u=Qo;try{var c=u(0,0);_=c,Ro(c)}catch(f){ts(f)}}if(t.postRun)for(typeof t.postRun=="function"&&(t.postRun=[t.postRun]);t.postRun.length;)u=t.postRun.shift(),X.unshift(u);Wr(X)}}if(!(0<M)){if(t.preRun)for(typeof t.preRun=="function"&&(t.preRun=[t.preRun]);t.preRun.length;)Re();Wr(Q),0<M||(t.setStatus?(t.setStatus("Running..."),setTimeout(function(){setTimeout(function(){t.setStatus("")},1),s()},1)):s())}}if(t.preInit)for(typeof t.preInit=="function"&&(t.preInit=[t.preInit]);0<t.preInit.length;)t.preInit.pop()();var Ko=!0;return t.noInitialRun&&(Ko=!1),jo(),e.ready}})();const SQLITE_OK=0,SQLITE_BUSY=5,SQLITE_IOERR=10,SQLITE_NOTFOUND=12,SQLITE_CANTOPEN=14,SQLITE_MISUSE=21,SQLITE_RANGE=25,SQLITE_NOTICE=27,SQLITE_ROW=100,SQLITE_DONE=101,SQLITE_IOERR_LOCK=3850,SQLITE_IOERR_SHORT_READ=522,SQLITE_OPEN_READONLY=1,SQLITE_OPEN_READWRITE=2,SQLITE_OPEN_CREATE=4,SQLITE_OPEN_DELETEONCLOSE=8,SQLITE_OPEN_URI=64,SQLITE_LOCK_NONE=0,SQLITE_LOCK_SHARED=1,SQLITE_LOCK_RESERVED=2,SQLITE_LOCK_PENDING=3,SQLITE_LOCK_EXCLUSIVE=4,SQLITE_IOCAP_SAFE_APPEND=512,SQLITE_IOCAP_SEQUENTIAL=1024,SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN=2048,SQLITE_IOCAP_BATCH_ATOMIC=16384,SQLITE_INTEGER=1,SQLITE_FLOAT=2,SQLITE_TEXT=3,SQLITE_BLOB=4,SQLITE_NULL=5,SQLITE_UTF8=1,MAX_INT64=0x7fffffffffffffffn,MIN_INT64=-0x8000000000000000n;class SQLiteError extends Error{constructor(e,t){super(e),this.code=t}}const async=!0;function Factory(r){const e={},t=r._getSqliteFree(),n=r._malloc(8),o=[n,n+4];function a(y){if(typeof y!="string")return 0;const w=r.lengthBytesUTF8(y),b=r._sqlite3_malloc(w+1);return r.stringToUTF8(y,b,w+1),b}function l(y,w){return BigInt(w)<<32n|BigInt(y)&0xffffffffn}const d=function(){const y=BigInt(Number.MAX_SAFE_INTEGER)>>32n,w=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(b,_){return _>y||_<w?l(b,_):_*4294967296+(b&2147483647)-(b&2147483648)}}(),h=new Set;function p(y){if(!h.has(y))throw new SQLiteError("not a database",SQLITE_MISUSE)}const m=new Map;function E(y){if(!m.has(y))throw new SQLiteError("not a statement",SQLITE_MISUSE)}e.bind_collection=function(y,w){E(y);const b=Array.isArray(w),_=e.bind_parameter_count(y);for(let C=1;C<=_;++C){const A=b?C-1:e.bind_parameter_name(y,C),G=w[A];G!==void 0&&e.bind(y,C,G)}return SQLITE_OK},e.bind=function(y,w,b){switch(E(y),typeof b){case"number":return b===(b|0)?e.bind_int(y,w,b):e.bind_double(y,w,b);case"string":return e.bind_text(y,w,b);default:if(b instanceof Uint8Array||Array.isArray(b))return e.bind_blob(y,w,b);if(b===null)return e.bind_null(y,w);if(typeof b=="bigint")return e.bind_int64(y,w,b);if(b===void 0)return SQLITE_NOTICE;throw new Error("Unknown binding type "+typeof b)}},e.bind_blob=function(){const y="sqlite3_bind_blob",w=r.cwrap(y,...decl("nnnnn:n"));return function(b,_,C){E(b);const A=C.byteLength??C.length,G=r._sqlite3_malloc(A);r.HEAPU8.subarray(G).set(C);const I=w(b,_,G,A,t);return S(y,I,m.get(b))}}(),e.bind_parameter_count=function(){const w=r.cwrap("sqlite3_bind_parameter_count",...decl("n:n"));return function(b){return E(b),w(b)}}(),e.bind_double=function(){const y="sqlite3_bind_double",w=r.cwrap(y,...decl("nnn:n"));return function(b,_,C){E(b);const A=w(b,_,C);return S(y,A,m.get(b))}}(),e.bind_int=function(){const y="sqlite3_bind_int",w=r.cwrap(y,...decl("nnn:n"));return function(b,_,C){if(E(b),C>2147483647||C<-2147483648)return SQLITE_RANGE;const A=w(b,_,C);return S(y,A,m.get(b))}}(),e.bind_int64=function(){const y="sqlite3_bind_int64",w=r.cwrap(y,...decl("nnnn:n"));return function(b,_,C){if(E(b),C>MAX_INT64||C<MIN_INT64)return SQLITE_RANGE;const A=C&0xffffffffn,G=C>>32n,I=w(b,_,Number(A),Number(G));return S(y,I,m.get(b))}}(),e.bind_null=function(){const y="sqlite3_bind_null",w=r.cwrap(y,...decl("nn:n"));return function(b,_){E(b);const C=w(b,_);return S(y,C,m.get(b))}}(),e.bind_parameter_name=function(){const w=r.cwrap("sqlite3_bind_parameter_name",...decl("n:s"));return function(b,_){return E(b),w(b,_)}}(),e.bind_text=function(){const y="sqlite3_bind_text",w=r.cwrap(y,...decl("nnnnn:n"));return function(b,_,C){E(b);const A=a(C),G=w(b,_,A,-1,t);return S(y,G,m.get(b))}}(),e.changes=function(){const w=r.cwrap("sqlite3_changes",...decl("n:n"));return function(b){return p(b),w(b)}}(),e.close=function(){const y="sqlite3_close",w=r.cwrap(y,...decl("n:n"),{async});return async function(b){p(b);const _=await w(b);return h.delete(b),S(y,_,b)}}(),e.column=function(y,w){E(y);const b=e.column_type(y,w);switch(b){case SQLITE_BLOB:return e.column_blob(y,w);case SQLITE_FLOAT:return e.column_double(y,w);case SQLITE_INTEGER:const _=e.column_int(y,w),C=r.getTempRet0();return d(_,C);case SQLITE_NULL:return null;case SQLITE_TEXT:return e.column_text(y,w);default:throw new SQLiteError("unknown type",b)}},e.column_blob=function(){const w=r.cwrap("sqlite3_column_blob",...decl("nn:n"));return function(b,_){E(b);const C=e.column_bytes(b,_),A=w(b,_),G=r.HEAPU8.subarray(A,A+C),I=new ArrayBuffer(G.byteLength),F=new Uint8Array(I);return F.set(G),F}}(),e.column_bytes=function(){const w=r.cwrap("sqlite3_column_bytes",...decl("nn:n"));return function(b,_){return E(b),w(b,_)}}(),e.column_count=function(){const w=r.cwrap("sqlite3_column_count",...decl("n:n"));return function(b){return E(b),w(b)}}(),e.column_double=function(){const w=r.cwrap("sqlite3_column_double",...decl("nn:n"));return function(b,_){return E(b),w(b,_)}}(),e.column_int=function(){const w=r.cwrap("sqlite3_column_int64",...decl("nn:n"));return function(b,_){return E(b),w(b,_)}}(),e.column_int64=function(){const w=r.cwrap("sqlite3_column_int64",...decl("nn:n"));return function(b,_){E(b);const C=w(b,_),A=r.getTempRet0();return l(C,A)}}(),e.column_name=function(){const w=r.cwrap("sqlite3_column_name",...decl("nn:s"));return function(b,_){return E(b),w(b,_)}}(),e.column_names=function(y){const w=[],b=e.column_count(y);for(let _=0;_<b;++_)w.push(e.column_name(y,_));return w},e.column_text=function(){const w=r.cwrap("sqlite3_column_text",...decl("nn:s"));return function(b,_){return E(b),w(b,_)}}(),e.column_type=function(){const w=r.cwrap("sqlite3_column_type",...decl("nn:n"));return function(b,_){return E(b),w(b,_)}}(),e.update_hook=function(y,w){return p(y),r.updateHook(y,w),SQLITE_OK},e.create_function=function(y,w,b,_,C,A,G,I){if(p(y),A&&!G&&!I){const F=r.createFunction(y,w,b,_,C,A);return S("sqlite3_create_function",F,y)}if(!A&&G&&I){const F=r.createAggregate(y,w,b,_,C,G,I);return S("sqlite3_create_function",F,y)}throw new SQLiteError("invalid function combination",SQLITE_MISUSE)},e.create_module=function(y,w,b,_){p(y);const C=r.createModule(y,w,b,_);return S("sqlite3_create_module",C,y)},e.data_count=function(){const w=r.cwrap("sqlite3_data_count",...decl("n:n"));return function(b){return E(b),w(b)}}(),e.declare_vtab=function(){const w=r.cwrap("sqlite3_declare_vtab",...decl("ns:n"));return function(b,_){const C=w(b,_);return S("sqlite3_declare_vtab",C)}}(),e.exec=async function(y,w,b){for await(const _ of e.statements(y,w)){let C;for(;await e.step(_)===SQLITE_ROW;)if(b){C=C??e.column_names(_);const A=e.row(_);await b(A,C)}}return SQLITE_OK},e.finalize=function(){const w=r.cwrap("sqlite3_finalize",...decl("n:n"),{async});return async function(b){if(!m.has(b))return SQLITE_MISUSE;const _=await w(b);return m.get(b),m.delete(b),_}}(),e.get_autocommit=function(){const w=r.cwrap("sqlite3_get_autocommit",...decl("n:n"));return function(b){return w(b)}}(),e.libversion=function(){const w=r.cwrap("sqlite3_libversion",...decl(":s"));return function(){return w()}}(),e.libversion_number=function(){const w=r.cwrap("sqlite3_libversion_number",...decl(":n"));return function(){return w()}}(),e.limit=function(){const w=r.cwrap("sqlite3_limit",...decl("nnn:n"));return function(b,_,C){return w(b,_,C)}}(),e.open_v2=function(){const y="sqlite3_open_v2",w=r.cwrap(y,...decl("snnn:n"),{async});return async function(b,_,C){_=_||SQLITE_OPEN_CREATE|SQLITE_OPEN_READWRITE,C=a(C);const A=await w(b,o[0],_,C),G=r.getValue(o[0],"*");return h.add(G),r._sqlite3_free(C),r.ccall("RegisterExtensionFunctions","void",["number"],[G]),S(y,A),G}}(),e.prepare_v2=function(){const y="sqlite3_prepare_v2",w=r.cwrap(y,...decl("nnnnn:n"),{async});return async function(b,_){const C=await w(b,_,-1,o[0],o[1]);S(y,C,b);const A=r.getValue(o[0],"*");return A?(m.set(A,b),{stmt:A,sql:r.getValue(o[1],"*")}):null}}(),e.progress_handler=function(y,w,b,_){p(y),r.progressHandler(y,w,b,_)},e.reset=function(){const y="sqlite3_reset",w=r.cwrap(y,...decl("n:n"),{async});return async function(b){E(b);const _=await w(b);return S(y,_,m.get(b))}}(),e.result=function(y,w){switch(typeof w){case"number":w===(w|0)?e.result_int(y,w):e.result_double(y,w);break;case"string":e.result_text(y,w);break;default:if(w instanceof Uint8Array||Array.isArray(w))e.result_blob(y,w);else if(w===null)e.result_null(y);else{if(typeof w=="bigint")return e.result_int64(y,w);console.warn("unknown result converted to null",w),e.result_null(y)}break}},e.result_blob=function(){const w=r.cwrap("sqlite3_result_blob",...decl("nnnn:n"));return function(b,_){const C=_.byteLength??_.length,A=r._sqlite3_malloc(C);r.HEAPU8.subarray(A).set(_),w(b,A,C,t)}}(),e.result_double=function(){const w=r.cwrap("sqlite3_result_double",...decl("nn:n"));return function(b,_){w(b,_)}}(),e.result_int=function(){const w=r.cwrap("sqlite3_result_int",...decl("nn:n"));return function(b,_){w(b,_)}}(),e.result_int64=function(){const w=r.cwrap("sqlite3_result_int64",...decl("nnn:n"));return function(b,_){if(_>MAX_INT64||_<MIN_INT64)return SQLITE_RANGE;const C=_&0xffffffffn,A=_>>32n;w(b,Number(C),Number(A))}}(),e.result_null=function(){const w=r.cwrap("sqlite3_result_null",...decl("n:n"));return function(b){w(b)}}(),e.result_text=function(){const w=r.cwrap("sqlite3_result_text",...decl("nnnn:n"));return function(b,_){const C=a(_);w(b,C,-1,t)}}(),e.row=function(y){const w=[],b=e.data_count(y);for(let _=0;_<b;++_){const C=e.column(y,_);w.push((C==null?void 0:C.buffer)===r.HEAPU8.buffer?C.slice():C)}return w},e.set_authorizer=function(y,w,b){p(y);const _=r.setAuthorizer(y,w,b);return S("sqlite3_set_authorizer",_,y)},e.sql=function(){const w=r.cwrap("sqlite3_sql",...decl("n:s"));return function(b){return E(b),w(b)}}(),e.statements=function(y,w){return async function*(){const b=e.str_new(y,w);let _={stmt:null,sql:e.str_value(b)};try{for(;_=await e.prepare_v2(y,_.sql);)yield _.stmt,e.finalize(_.stmt),_.stmt=null}finally{_!=null&&_.stmt&&e.finalize(_.stmt),e.str_finish(b)}}()},e.step=function(){const y="sqlite3_step",w=r.cwrap(y,...decl("n:n"),{async});return async function(b){E(b);const _=await w(b);return S(y,_,m.get(b),[SQLITE_ROW,SQLITE_DONE])}}();let k=0;const L=new Map;e.str_new=function(y,w=""){const b=r.lengthBytesUTF8(w),_=k++&4294967295,C={offset:r._sqlite3_malloc(b+1),bytes:b};return L.set(_,C),r.stringToUTF8(w,C.offset,C.bytes+1),_},e.str_appendall=function(y,w){if(!L.has(y))throw new SQLiteError("not a string",SQLITE_MISUSE);const b=L.get(y),_=r.lengthBytesUTF8(w),C=b.bytes+_,A=r._sqlite3_malloc(C+1);r.HEAPU8.subarray(A,A+C+1).set(r.HEAPU8.subarray(b.offset,b.offset+b.bytes)),r.stringToUTF8(w,A+b.bytes,_+1),r._sqlite3_free(b.offset),b.offset=A,b.bytes=C,L.set(y,b)},e.str_finish=function(y){if(!L.has(y))throw new SQLiteError("not a string",SQLITE_MISUSE);const w=L.get(y);L.delete(y),r._sqlite3_free(w.offset)},e.str_value=function(y){if(!L.has(y))throw new SQLiteError("not a string",SQLITE_MISUSE);return L.get(y).offset},e.user_data=function(y){return r.getFunctionUserData(y)},e.value=function(y){const w=e.value_type(y);switch(w){case SQLITE_BLOB:return e.value_blob(y);case SQLITE_FLOAT:return e.value_double(y);case SQLITE_INTEGER:const b=e.value_int(y),_=r.getTempRet0();return d(b,_);case SQLITE_NULL:return null;case SQLITE_TEXT:return e.value_text(y);default:throw new SQLiteError("unknown type",w)}},e.value_blob=function(){const w=r.cwrap("sqlite3_value_blob",...decl("n:n"));return function(b){const _=e.value_bytes(b),C=w(b);return r.HEAPU8.subarray(C,C+_)}}(),e.value_bytes=function(){const w=r.cwrap("sqlite3_value_bytes",...decl("n:n"));return function(b){return w(b)}}(),e.value_double=function(){const w=r.cwrap("sqlite3_value_double",...decl("n:n"));return function(b){return w(b)}}(),e.value_int=function(){const w=r.cwrap("sqlite3_value_int64",...decl("n:n"));return function(b){return w(b)}}(),e.value_int64=function(){const w=r.cwrap("sqlite3_value_int64",...decl("n:n"));return function(b){const _=w(b),C=r.getTempRet0();return l(_,C)}}(),e.value_text=function(){const w=r.cwrap("sqlite3_value_text",...decl("n:s"));return function(b){return w(b)}}(),e.value_type=function(){const w=r.cwrap("sqlite3_value_type",...decl("n:n"));return function(b){return w(b)}}(),e.vfs_register=function(y,w){const b=r.registerVFS(y,w);return S("sqlite3_vfs_register",b)};function S(y,w,b=null,_=[SQLITE_OK]){if(_.includes(w))return w;const C=b?r.ccall("sqlite3_errmsg","string",["number"],[b]):y;throw new SQLiteError(C,w)}return e}function decl(r){const e=[],t=r.match(/([ns@]*):([nsv@])/);switch(t[2]){case"n":e.push("number");break;case"s":e.push("string");break;case"v":e.push(null);break}const n=[];for(let o of t[1])switch(o){case"n":n.push("number");break;case"s":n.push("string");break}return e.push(n),e}class Base{constructor(){oe(this,"mxPathName",64)}xClose(e){return SQLITE_IOERR}xRead(e,t,n){return SQLITE_IOERR}xWrite(e,t,n){return SQLITE_IOERR}xTruncate(e,t){return SQLITE_IOERR}xSync(e,t){return SQLITE_OK}xFileSize(e,t){return SQLITE_IOERR}xLock(e,t){return SQLITE_OK}xUnlock(e,t){return SQLITE_OK}xCheckReservedLock(e,t){return t.setInt32(0,0,!0),SQLITE_OK}xFileControl(e,t,n){return SQLITE_NOTFOUND}xSectorSize(e){return 512}xDeviceCharacteristics(e){return 0}xOpen(e,t,n,o){return SQLITE_CANTOPEN}xDelete(e,t){return SQLITE_IOERR}xAccess(e,t,n){return SQLITE_IOERR}handleAsync(e){return e()}}const LOCK_TYPE_MASK=SQLITE_LOCK_NONE|SQLITE_LOCK_SHARED|SQLITE_LOCK_RESERVED|SQLITE_LOCK_PENDING|SQLITE_LOCK_EXCLUSIVE;var Ge,mn,$n,Vn,hs,Di,aa,Bi,ua;class WebLocksBase{constructor(){g(this,Vn);g(this,Di);g(this,Bi);g(this,Ge,SQLITE_LOCK_NONE);oe(this,"timeoutMillis",0);g(this,mn,new Map);g(this,$n,Promise.resolve(0))}get state(){return i(this,Ge)}async lock(e){return j(this,Vn,hs).call(this,j(this,Di,aa),e)}async unlock(e){return j(this,Vn,hs).call(this,j(this,Bi,ua),e)}async isSomewhereReserved(){throw new Error("unimplemented")}async _NONEtoSHARED(){}async _SHAREDtoEXCLUSIVE(){await this._SHAREDtoRESERVED(),await this._RESERVEDtoEXCLUSIVE()}async _SHAREDtoRESERVED(){}async _RESERVEDtoEXCLUSIVE(){}async _EXCLUSIVEtoRESERVED(){}async _EXCLUSIVEtoSHARED(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED()}async _EXCLUSIVEtoNONE(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _RESERVEDtoSHARED(){}async _RESERVEDtoNONE(){await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _SHAREDtoNONE(){}_acquireWebLock(e,t){return new Promise(async(n,o)=>{try{await navigator.locks.request(e,t,a=>{if(n(a),a)return new Promise(l=>i(this,mn).set(e,l))})}catch(a){o(a)}})}_releaseWebLock(e){var t;(t=i(this,mn).get(e))==null||t(),i(this,mn).delete(e)}async _pollWebLock(e){var n;return(n=(await navigator.locks.query()).held.find(({name:o})=>o===e))==null?void 0:n.mode}_getTimeoutSignal(){if(this.timeoutMillis){const e=new AbortController;return setTimeout(()=>e.abort(),this.timeoutMillis),e.signal}}}Ge=new WeakMap,mn=new WeakMap,$n=new WeakMap,Vn=new WeakSet,hs=async function(e,t){const n=t&LOCK_TYPE_MASK;try{const o=()=>e.call(this,n);return await x(this,$n,i(this,$n).then(o,o)),x(this,Ge,n),SQLITE_OK}catch(o){return o.name==="AbortError"?SQLITE_BUSY:(console.error(o),SQLITE_IOERR_LOCK)}},Di=new WeakSet,aa=async function(e){if(e===i(this,Ge))return SQLITE_OK;switch(i(this,Ge)){case SQLITE_LOCK_NONE:switch(e){case SQLITE_LOCK_SHARED:return this._NONEtoSHARED();default:throw new Error(`unexpected transition ${i(this,Ge)} -> ${e}`)}case SQLITE_LOCK_SHARED:switch(e){case SQLITE_LOCK_RESERVED:return this._SHAREDtoRESERVED();case SQLITE_LOCK_EXCLUSIVE:return this._SHAREDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${i(this,Ge)} -> ${e}`)}case SQLITE_LOCK_RESERVED:switch(e){case SQLITE_LOCK_EXCLUSIVE:return this._RESERVEDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${i(this,Ge)} -> ${e}`)}default:throw new Error(`unexpected transition ${i(this,Ge)} -> ${e}`)}},Bi=new WeakSet,ua=async function(e){if(e===i(this,Ge))return SQLITE_OK;switch(i(this,Ge)){case SQLITE_LOCK_EXCLUSIVE:switch(e){case SQLITE_LOCK_SHARED:return this._EXCLUSIVEtoSHARED();case SQLITE_LOCK_NONE:return this._EXCLUSIVEtoNONE();default:throw new Error(`unexpected transition ${i(this,Ge)} -> ${e}`)}case SQLITE_LOCK_RESERVED:switch(e){case SQLITE_LOCK_SHARED:return this._RESERVEDtoSHARED();case SQLITE_LOCK_NONE:return this._RESERVEDtoNONE();default:throw new Error(`unexpected transition ${i(this,Ge)} -> ${e}`)}case SQLITE_LOCK_SHARED:switch(e){case SQLITE_LOCK_NONE:return this._SHAREDtoNONE();default:throw new Error(`unexpected transition ${i(this,Ge)} -> ${e}`)}default:throw new Error(`unexpected transition ${i(this,Ge)} -> ${e}`)}};class WebLocksExclusive extends WebLocksBase{constructor(e){super(),this._lockName=e+"-outer",this._reservedName=e+"-reserved"}async isSomewhereReserved(){return await this._pollWebLock(this._reservedName)==="exclusive"}async _NONEtoSHARED(){await this._acquireWebLock(this._lockName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _SHAREDtoRESERVED(){await this._acquireWebLock(this._reservedName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _RESERVEDtoSHARED(){this._releaseWebLock(this._reservedName)}async _SHAREDtoNONE(){this._releaseWebLock(this._lockName)}}const MAX_TRANSACTION_LIFETIME_MILLIS=5e3;let nextTxId=0;const mapTxToId=new WeakMap;function log$2(...r){}var yn,Nn,Jn,$e,Hn,Rr,xr,Fi,la;class IDBContext{constructor(e,t={durability:"default"}){g(this,Fi);g(this,yn,void 0);g(this,Nn,void 0);g(this,Jn,void 0);g(this,$e,null);g(this,Hn,0);g(this,Rr,Promise.resolve());g(this,xr,Promise.resolve());x(this,Nn,Promise.resolve(e).then(n=>x(this,yn,n))),x(this,Jn,t)}async close(){const e=i(this,yn)??await i(this,Nn);await i(this,Rr),await this.sync(),e.close()}async run(e,t){const n=i(this,Rr).then(()=>j(this,Fi,la).call(this,e,t));return x(this,Rr,n.catch(()=>{})),n}async sync(){await i(this,Rr),await i(this,xr),x(this,xr,Promise.resolve())}}yn=new WeakMap,Nn=new WeakMap,Jn=new WeakMap,$e=new WeakMap,Hn=new WeakMap,Rr=new WeakMap,xr=new WeakMap,Fi=new WeakSet,la=async function(e,t){var o,a;const n=i(this,yn)??await i(this,Nn);if(e==="readwrite"&&((o=i(this,$e))==null?void 0:o.mode)==="readonly")x(this,$e,null);else if(performance.now()-i(this,Hn)>MAX_TRANSACTION_LIFETIME_MILLIS){try{(a=i(this,$e))==null||a.commit()}catch(l){if(l.name!=="InvalidStateError")throw l}await new Promise(l=>setTimeout(l)),x(this,$e,null)}for(let l=0;l<2;++l){if(!i(this,$e)){x(this,$e,n.transaction(n.objectStoreNames,e,i(this,Jn)));const d=x(this,Hn,performance.now());x(this,xr,i(this,xr).then(()=>new Promise((h,p)=>{i(this,$e).addEventListener("complete",m=>{h(),i(this,$e)===m.target&&x(this,$e,null),log$2(`transaction ${mapTxToId.get(m.target)} complete`)}),i(this,$e).addEventListener("abort",m=>{console.warn("tx abort",(performance.now()-d)/1e3);const E=m.target.error;p(E),i(this,$e)===m.target&&x(this,$e,null),log$2(`transaction ${mapTxToId.get(m.target)} aborted`,E)})}))),mapTxToId.set(i(this,$e),nextTxId++)}try{const d=Object.fromEntries(Array.from(n.objectStoreNames,h=>[h,new ObjectStore(i(this,$e).objectStore(h))]));return await t(d)}catch(d){if(x(this,$e,null),l)throw d}}};function wrapRequest(r){return new Promise((e,t)=>{r.addEventListener("success",()=>e(r.result)),r.addEventListener("error",()=>t(r.error))})}var ze;class ObjectStore{constructor(e){g(this,ze,void 0);x(this,ze,e)}get(e){log$2(`get ${i(this,ze).name}`,e);const t=i(this,ze).get(e);return wrapRequest(t)}getAll(e,t){log$2(`getAll ${i(this,ze).name}`,e,t);const n=i(this,ze).getAll(e,t);return wrapRequest(n)}getKey(e){log$2(`getKey ${i(this,ze).name}`,e);const t=i(this,ze).getKey(e);return wrapRequest(t)}getAllKeys(e,t){log$2(`getAllKeys ${i(this,ze).name}`,e,t);const n=i(this,ze).getAllKeys(e,t);return wrapRequest(n)}put(e,t){log$2(`put ${i(this,ze).name}`,e,t);const n=i(this,ze).put(e,t);return wrapRequest(n)}delete(e){log$2(`delete ${i(this,ze).name}`,e);const t=i(this,ze).delete(e);return wrapRequest(t)}clear(){log$2(`clear ${i(this,ze).name}`);const e=i(this,ze).clear();return wrapRequest(e)}index(e){return new Index(i(this,ze).index(e))}}ze=new WeakMap;var kr;class Index{constructor(e){g(this,kr,void 0);x(this,kr,e)}getAllKeys(e,t){log$2(`IDBIndex.getAllKeys ${i(this,kr).objectStore.name}<${i(this,kr).name}>`,e,t);const n=i(this,kr).getAllKeys(e,t);return wrapRequest(n)}}kr=new WeakMap;const SECTOR_SIZE=512,MAX_TASK_MILLIS=3e3,DEFAULT_OPTIONS={durability:"default",purge:"deferred",purgeAtLeast:16};function log$1(...r){}var or,Xe,Ce,Ar,Lr,Mt,jn,ps,Qi,ca,zi,da,ar,zr,Pi,fa;class IDBBatchAtomicVFS extends Base{constructor(t="wa-sqlite",n=DEFAULT_OPTIONS){super();g(this,jn);g(this,Qi);g(this,zi);g(this,ar);g(this,Pi);g(this,or,void 0);g(this,Xe,new Map);g(this,Ce,void 0);g(this,Ar,new Set);g(this,Lr,performance.now());g(this,Mt,new Set);this.name=t,x(this,or,Object.assign({},DEFAULT_OPTIONS,n)),x(this,Ce,new IDBContext(openDatabase(t),{durability:i(this,or).durability}))}async close(){var t;for(const n of i(this,Xe).keys())await this.xClose(n);await((t=i(this,Ce))==null?void 0:t.close()),x(this,Ce,null)}xOpen(t,n,o,a){return this.handleAsync(async()=>{t===null&&(t=`null_${n}`),log$1(`xOpen ${t} 0x${n.toString(16)} 0x${o.toString(16)}`);try{const l=new URL(t,"http://localhost/"),d={path:l.pathname,flags:o,block0:null,isMetadataChanged:!0,locks:new WebLocksExclusive(l.pathname)};return i(this,Xe).set(n,d),await i(this,Ce).run("readwrite",async({blocks:h})=>{if(d.block0=await h.get(j(this,ar,zr).call(this,d,0)),!d.block0)if(o&SQLITE_OPEN_CREATE)d.block0={path:d.path,offset:0,version:0,data:new Uint8Array(0),fileSize:0},h.put(d.block0);else throw new Error(`file not found: ${d.path}`)}),a.setInt32(0,o&SQLITE_OPEN_READONLY,!0),SQLITE_OK}catch(l){return console.error(l),SQLITE_CANTOPEN}})}xClose(t){return this.handleAsync(async()=>{try{const n=i(this,Xe).get(t);return n&&(log$1(`xClose ${n.path}`),i(this,Xe).delete(t),n.flags&SQLITE_OPEN_DELETEONCLOSE&&i(this,Ce).run("readwrite",({blocks:o})=>{o.delete(IDBKeyRange.bound([n.path],[n.path,[]]))})),SQLITE_OK}catch(n){return console.error(n),SQLITE_IOERR}})}xRead(t,n,o){return this.handleAsync(async()=>{const a=i(this,Xe).get(t);log$1(`xRead ${a.path} ${n.byteLength} ${o}`);try{return await i(this,Ce).run("readonly",async({blocks:d})=>{let h=0;for(;h<n.byteLength;){const p=o+h,m=p<a.block0.data.byteLength?a.block0:await d.get(j(this,ar,zr).call(this,a,-p));if(!m||m.data.byteLength-m.offset<=p)return n.fill(0,h),SQLITE_IOERR_SHORT_READ;const E=n.subarray(h),k=p+m.offset,L=Math.min(Math.max(m.data.byteLength-k,0),E.byteLength);E.set(m.data.subarray(k,k+L)),h+=L}return SQLITE_OK})}catch(l){return console.error(l),SQLITE_IOERR}})}xWrite(t,n,o){const a=i(this,Mt).has(t);if(a||performance.now()-i(this,Lr)>MAX_TASK_MILLIS){const l=this.handleAsync(async()=>{this.handleAsync!==super.handleAsync&&i(this,Mt).add(t),await new Promise(h=>setTimeout(h));const d=j(this,jn,ps).call(this,t,n,o);return x(this,Lr,performance.now()),d});return a&&i(this,Mt).delete(t),l}return j(this,jn,ps).call(this,t,n,o)}xTruncate(t,n){const o=i(this,Xe).get(t);log$1(`xTruncate ${o.path} ${n}`);try{Object.assign(o.block0,{fileSize:n,data:o.block0.data.slice(0,n)});const a=Object.assign({},o.block0);return i(this,Ce).run("readwrite",({blocks:l})=>{l.delete(j(this,ar,zr).call(this,o,-1/0,-n)),l.put(a)}),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}}xSync(t,n){const o=i(this,Mt).has(t);if(o||i(this,or).durability!=="relaxed"||performance.now()-i(this,Lr)>MAX_TASK_MILLIS){const l=this.handleAsync(async()=>{this.handleAsync!==super.handleAsync&&i(this,Mt).add(t);const d=await j(this,Qi,ca).call(this,t,n);return x(this,Lr,performance.now()),d});return o&&i(this,Mt).delete(t),l}const a=i(this,Xe).get(t);return log$1(`xSync ${a.path} ${n}`),SQLITE_OK}xFileSize(t,n){const o=i(this,Xe).get(t);return log$1(`xFileSize ${o.path}`),n.setBigInt64(0,BigInt(o.block0.fileSize),!0),SQLITE_OK}xLock(t,n){return this.handleAsync(async()=>{const o=i(this,Xe).get(t);log$1(`xLock ${o.path} ${n}`);try{const a=await o.locks.lock(n);return a===SQLITE_OK&&o.locks.state===SQLITE_LOCK_SHARED&&(o.block0=await i(this,Ce).run("readonly",({blocks:l})=>l.get(j(this,ar,zr).call(this,o,0)))),a}catch(a){return console.error(a),SQLITE_IOERR}})}xUnlock(t,n){return this.handleAsync(async()=>{const o=i(this,Xe).get(t);log$1(`xUnlock ${o.path} ${n}`);try{return o.locks.unlock(n)}catch(a){return console.error(a),SQLITE_IOERR}})}xCheckReservedLock(t,n){return this.handleAsync(async()=>{const o=i(this,Xe).get(t);log$1(`xCheckReservedLock ${o.path}`);const a=await o.locks.isSomewhereReserved();return n.setInt32(0,a?1:0,!0),SQLITE_OK})}xSectorSize(t){return SECTOR_SIZE}xDeviceCharacteristics(t){return SQLITE_IOCAP_BATCH_ATOMIC|SQLITE_IOCAP_SAFE_APPEND|SQLITE_IOCAP_SEQUENTIAL|SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN}xFileControl(t,n,o){const a=i(this,Xe).get(t);switch(log$1(`xFileControl ${a.path} ${n}`),n){case 11:return a.overwrite=!0,SQLITE_OK;case 21:if(a.overwrite)try{return this.handleAsync(async()=>(await j(this,Pi,fa).call(this,a),SQLITE_OK))}catch(l){return console.error(l),SQLITE_IOERR}if(a.isMetadataChanged)try{i(this,Ce).run("readwrite",async({blocks:l})=>{await l.put(a.block0)}),a.isMetadataChanged=!1}catch(l){return console.error(l),SQLITE_IOERR}return SQLITE_OK;case 22:return a.overwrite=!1,SQLITE_OK;case 31:return this.handleAsync(async()=>{try{return a.block0.version--,a.changedPages=new Set,i(this,Ce).run("readwrite",async({blocks:l})=>{const d=await l.index("version").getAllKeys(IDBKeyRange.bound([a.path],[a.path,a.block0.version]));for(const h of d)l.delete(h)}),SQLITE_OK}catch(l){return console.error(l),SQLITE_IOERR}});case 32:try{const l=Object.assign({},a.block0);l.data=l.data.slice();const d=a.changedPages;return a.changedPages=null,a.isMetadataChanged=!1,i(this,Ce).run("readwrite",async({blocks:h})=>{h.put(l);const p=await h.get([a.path,"purge",0])??{path:a.path,offset:"purge",version:0,data:new Map,count:0};p.count+=d.size;for(const m of d)p.data.set(m,l.version);h.put(p),j(this,zi,da).call(this,a.path,p.count)}),SQLITE_OK}catch(l){return console.error(l),SQLITE_IOERR}case 33:return this.handleAsync(async()=>{try{return a.changedPages=null,a.isMetadataChanged=!1,a.block0=await i(this,Ce).run("readonly",({blocks:l})=>l.get([a.path,0,a.block0.version+1])),SQLITE_OK}catch(l){return console.error(l),SQLITE_IOERR}});default:return SQLITE_NOTFOUND}}xAccess(t,n,o){return this.handleAsync(async()=>{try{const a=new URL(t,"file://localhost/").pathname;log$1(`xAccess ${a} ${n}`);const l=await i(this,Ce).run("readonly",({blocks:d})=>d.getKey(j(this,ar,zr).call(this,{path:a},0)));return o.setInt32(0,l?1:0,!0),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}})}xDelete(t,n){return this.handleAsync(async()=>{const o=new URL(t,"file://localhost/").pathname;try{return i(this,Ce).run("readwrite",({blocks:a})=>a.delete(IDBKeyRange.bound([o],[o,[]]))),n&&await i(this,Ce).sync(),SQLITE_OK}catch(a){return console.error(a),SQLITE_IOERR}})}async purge(t){const n=Date.now();await i(this,Ce).run("readwrite",async({blocks:o})=>{const a=await o.get([t,"purge",0]);if(a){for(const[l,d]of a.data)o.delete(IDBKeyRange.bound([t,l,d],[t,l,1/0],!0,!1));await o.delete([t,"purge",0])}log$1(`purge ${t} ${(a==null?void 0:a.data.size)??0} pages in ${Date.now()-n} ms`)})}}or=new WeakMap,Xe=new WeakMap,Ce=new WeakMap,Ar=new WeakMap,Lr=new WeakMap,Mt=new WeakMap,jn=new WeakSet,ps=function(t,n,o){const a=i(this,Xe).get(t);log$1(`xWrite ${a.path} ${n.byteLength} ${o}`);try{const l=a.block0.fileSize;a.block0.fileSize<o+n.byteLength&&(a.block0.fileSize=o+n.byteLength,a.isMetadataChanged=!0);const d=o===0?a.block0:{path:a.path,offset:-o,version:a.block0.version,data:null};return d.data=n.slice(),a.changedPages?(l===a.block0.fileSize&&a.changedPages.add(-o),o!==0&&i(this,Ce).run("readwrite",({blocks:h})=>h.put(d))):i(this,Ce).run("readwrite",({blocks:h})=>h.put(d)),a.isMetadataChanged=o===0?!1:a.isMetadataChanged,SQLITE_OK}catch(l){return console.error(l),SQLITE_IOERR}},Qi=new WeakSet,ca=async function(t,n){const o=i(this,Xe).get(t);log$1(`xSync ${o.path} ${n}`);try{o.isMetadataChanged&&(i(this,Ce).run("readwrite",async({blocks:a})=>{await a.put(o.block0)}),o.isMetadataChanged=!1),await i(this,Ce).sync()}catch(a){return console.error(a),SQLITE_IOERR}return SQLITE_OK},zi=new WeakSet,da=function(t,n){i(this,or).purge==="manual"||i(this,Ar).has(t)||n<i(this,or).purgeAtLeast||(globalThis.requestIdleCallback?globalThis.requestIdleCallback(()=>{this.purge(t),i(this,Ar).delete(t)}):setTimeout(()=>{this.purge(t),i(this,Ar).delete(t)}),i(this,Ar).add(t))},ar=new WeakSet,zr=function(t,n,o=0){const a=!n||-n<t.block0.data.length?-1/0:t.block0.version;return IDBKeyRange.bound([t.path,n,a],[t.path,o,1/0])},Pi=new WeakSet,fa=async function(t){const n=t.block0.data.length;if(n<18)return;const o=new DataView(t.block0.data.buffer,t.block0.data.byteOffset);let a=o.getUint16(16);if(a===1&&(a=65536),a===n)return;const l=Math.max(n,a),d=l/n,h=l/a,m=o.getUint32(28)*a,E=t.block0.version;await i(this,Ce).run("readwrite",async({blocks:k})=>{const L=await k.index("version").getAllKeys(IDBKeyRange.bound([t.path,E+1],[t.path,1/0]));for(const S of L)k.delete(S);k.delete([t.path,"purge",0]);for(let S=0;S<m;S+=l){const y=await k.getAll(IDBKeyRange.lowerBound([t.path,-(S+l),1/0]),d);for(const w of y)k.delete([w.path,w.offset,w.version]);if(h===1){const w=new Uint8Array(a);for(const _ of y)w.set(_.data,-(S+_.offset));const b={path:t.path,offset:-S,version:E,data:w};b.offset===0&&(b.fileSize=m,t.block0=b),k.put(b)}else{const w=y[0];for(let b=0;b<h;++b){const _=-(S+b*a);if(-_>=m)break;const C={path:w.path,offset:_,version:E,data:w.data.subarray(b*a,(b+1)*a)};C.offset===0&&(C.fileSize=m,t.block0=C),k.put(C)}}}})};function openDatabase(r){return new Promise((e,t)=>{const n=globalThis.indexedDB.open(r,5);n.addEventListener("upgradeneeded",function(){n.result.createObjectStore("blocks",{keyPath:["path","offset","version"]}).createIndex("version",["path","version"])}),n.addEventListener("success",()=>{e(n.result)}),n.addEventListener("error",()=>{t(n.error)})})}const E_CANCELED=new Error("request for lock canceled");var __awaiter$2=function(r,e,t,n){function o(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(m){try{p(n.next(m))}catch(E){l(E)}}function h(m){try{p(n.throw(m))}catch(E){l(E)}}function p(m){m.done?a(m.value):o(m.value).then(d,h)}p((n=n.apply(r,e||[])).next())})};class Semaphore{constructor(e,t=E_CANCELED){this._value=e,this._cancelError=t,this._weightedQueues=[],this._weightedWaiters=[]}acquire(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((t,n)=>{this._weightedQueues[e-1]||(this._weightedQueues[e-1]=[]),this._weightedQueues[e-1].push({resolve:t,reject:n}),this._dispatch()})}runExclusive(e,t=1){return __awaiter$2(this,void 0,void 0,function*(){const[n,o]=yield this.acquire(t);try{return yield e(n)}finally{o()}})}waitForUnlock(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise(t=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),this._weightedWaiters[e-1].push(t),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatch()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatch()}cancel(){this._weightedQueues.forEach(e=>e.forEach(t=>t.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var e;for(let t=this._value;t>0;t--){const n=(e=this._weightedQueues[t-1])===null||e===void 0?void 0:e.shift();if(!n)continue;const o=this._value,a=t;this._value-=t,t=this._value+1,n.resolve([o,this._newReleaser(a)])}this._drainUnlockWaiters()}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){for(let e=this._value;e>0;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(t=>t()),this._weightedWaiters[e-1]=[])}}var __awaiter$1=function(r,e,t,n){function o(a){return a instanceof t?a:new t(function(l){l(a)})}return new(t||(t=Promise))(function(a,l){function d(m){try{p(n.next(m))}catch(E){l(E)}}function h(m){try{p(n.throw(m))}catch(E){l(E)}}function p(m){m.done?a(m.value):o(m.value).then(d,h)}p((n=n.apply(r,e||[])).next())})};class Mutex{constructor(e){this._semaphore=new Semaphore(1,e)}acquire(){return __awaiter$1(this,void 0,void 0,function*(){const[,e]=yield this._semaphore.acquire();return e})}runExclusive(e){return this._semaphore.runExclusive(()=>e())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}const isDebug=globalThis.__vlcn_wa_crsqlite_dbg;function log(...r){isDebug&&console.log("crsqlite-wasm: ",...r)}const re=/insert\s|update\s|delete\s/,txRe=/begin\s|commit\s|rollback\s|savepoint\s/;function computeCacheKey(r,e,t){const n=r.toLowerCase();if(txRe.exec(n)==null)return re.exec(n)!=null?(log("received write"),null):t!=null?n+"|"+e+"|"+t.map(a=>a!=null?a.toString():"null").join("|"):n}class Stmt{constructor(e,t,n,o,a,l,d){oe(this,"originDB");oe(this,"stmtFinalizer");oe(this,"cache");oe(this,"api");oe(this,"base");oe(this,"str");oe(this,"sql");oe(this,"mode","o");oe(this,"finalized",!1);oe(this,"bindings",[]);this.originDB=e,this.stmtFinalizer=t,this.cache=n,this.api=o,this.base=a,this.str=l,this.sql=d,t.set(a,this)}run(e,...t){return serialize(this.cache,computeCacheKey(this.sql,this.mode,t.length>0?t:this.bindings),()=>(t.length>0&&this.bind(t),this.api.step(this.base).then(()=>this.api.reset(this.base))),(e==null?void 0:e.__mutex)||this.originDB.__mutex)}get(e,...t){return serialize(this.cache,computeCacheKey(this.sql,this.mode,t.length>0?t:this.bindings),async()=>{t.length>0&&this.bind(t);let n=null,o=this.mode==="o"?this.api.column_names(this.base):null;if(await this.api.step(this.base)==SQLITE_ROW){const a=this.api.row(this.base);if(o!=null){const l={};for(let d=0;d<o.length;++d)l[o[d]]=a[d];n=l}else n=a}return await this.api.reset(this.base),n},(e==null?void 0:e.__mutex)||this.originDB.__mutex)}all(e,...t){return serialize(this.cache,computeCacheKey(this.sql,this.mode,t.length>0?t:this.bindings),async()=>{t.length>0&&this.bind(t);const n=[];let o=this.mode==="o"?this.api.column_names(this.base):null;for(;await this.api.step(this.base)==SQLITE_ROW;)if(o!=null){const a={};for(let l=0;l<o.length;++l)a[o[l]]=this.api.column(this.base,l);n.push(a)}else{n.push(this.api.row(this.base));continue}return await this.api.reset(this.base),n},(e==null?void 0:e.__mutex)||this.originDB.__mutex)}async*iterate(e,...t){for(this.bind(t);await serialize(this.cache,void 0,()=>this.api.step(this.base),(e==null?void 0:e.__mutex)||this.originDB.__mutex)==SQLITE_ROW;)yield this.api.row(this.base);await serialize(this.cache,void 0,()=>this.api.reset(this.base),(e==null?void 0:e.__mutex)||this.originDB.__mutex)}raw(e){return e?this.mode="a":this.mode="o",this}bind(e){this.bindings=e;for(let t=0;t<e.length;++t)this.api.bind(this.base,t+1,e[t]);return this}finalize(e){return serialize(this.cache,void 0,()=>{if(!this.finalized)return this.finalized=!0,this.api.str_finish(this.str),this.stmtFinalizer.delete(this.base),this.api.finalize(this.base)},(e==null?void 0:e.__mutex)||this.originDB.__mutex)}}class TX{constructor(e,t,n,o,a){oe(this,"api");oe(this,"db");oe(this,"__mutex");oe(this,"assertOpen");oe(this,"stmtFinalizer");oe(this,"cache",new Map);this.api=e,this.db=t,this.__mutex=n,this.assertOpen=o,this.stmtFinalizer=a}execMany(e){return this.assertOpen(),serialize(this.cache,null,()=>this.api.exec(this.db,e.join("")),this.__mutex)}exec(e,t){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"a",t),()=>this.statements(e,!1,t),this.__mutex)}execO(e,t){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"o",t),()=>this.statements(e,!0,t),this.__mutex)}execA(e,t){return this.assertOpen(),serialize(this.cache,computeCacheKey(e,"a",t),()=>this.statements(e,!1,t),this.__mutex)}prepare(e){return this.assertOpen(),serialize(this.cache,void 0,async()=>{const t=this.api.str_new(this.db,e),n=await this.api.prepare_v2(this.db,this.api.str_value(t));if(n==null)throw this.api.str_finish(t),new Error(`Could not prepare ${e}`);return new Stmt(this,this.stmtFinalizer,this.cache,this.api,n.stmt,t,e)},this.__mutex)}tx(e){this.assertOpen();const t="crsql"+crypto.randomUUID().replaceAll("-","");return serializeTx(async n=>{await n.exec("SAVEPOINT "+t);try{await e(n)}catch(o){throw await n.exec("ROLLBACK TO "+t),await n.exec("RELEASE "+t),o}await n.exec("RELEASE "+t)},this.__mutex,this)}imperativeTx(){return this.__mutex.acquire().then(e=>{const t=new Mutex;return[e,new TX(this.api,this.db,t,this.assertOpen,this.stmtFinalizer)]})}async statements(e,t,n){const o=[],a=this.api.str_new(this.db,e);let l={stmt:null,sql:this.api.str_value(a)};try{for(;l=await this.api.prepare_v2(this.db,l.sql);){const p=l.stmt,m=[],E=this.api.column_names(p);for(n&&this.bind(p,n);await this.api.step(p)===SQLITE_ROW;){const k=this.api.row(p);m.push(k)}E.length&&o.push({columns:E,rows:m}),this.api.finalize(l.stmt),l.stmt=null}}catch(p){throw console.error(`Failed running ${e}`,p),p}finally{l!=null&&l.stmt&&this.api.finalize(l.stmt),this.api.str_finish(a)}const d=o[0];if(d==null)return null;if(!t)return d.rows;const h=[];for(const p of d.rows){const m={};for(let E=0;E<d.columns.length;++E)m[d.columns[E]]=p[E];h.push(m)}return h}bind(e,t){for(let n=0;n<t.length;++n){const o=t[n];this.api.bind(e,n+1,typeof o=="boolean"?o&&1||0:o)}}}const topLevelMutex=new Mutex;topLevelMutex.name="topLevelMutex";function serialize(r,e,t,n){if(e===null)log("Cache clear"),r==null||r.clear();else if(e!==void 0){const a=r==null?void 0:r.get(e);if(a)return log("Cache hit",e),a}log("Enqueueing query ",e);const o=n.runExclusive(t);return e&&(r==null||r.set(e,o),o.finally(()=>r==null?void 0:r.delete(e)).catch(a=>{console.error(a)})),o}function serializeTx(r,e,t){return e.runExclusive(()=>{const n=new Mutex,o=new TX(t.api,t.db,n,t.assertOpen,t.stmtFinalizer);return r(o)})}function cryb64(r,e=0){let t=3735928559^e,n=1103547991^e;for(let o=0,a;o<r.length;o++)a=r.charCodeAt(o),t=Math.imul(t^a,2654435761),n=Math.imul(n^a,1597334677);return t=Math.imul(t^t>>>16,2246822507),t^=Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(t^t>>>13,3266489909),4294967296n*BigInt(n)+BigInt(t)}function firstPick(r){const e=r[0];if(e!=null)return e[Object.keys(e)[0]]}var bn,qr,Ut,Kn,It,Gn,Mi;class DB{constructor(e,t,n){oe(this,"api");oe(this,"db");oe(this,"filename");oe(this,"__mutex",topLevelMutex);oe(this,"stmtFinalizer",new Map);g(this,bn,null);g(this,qr,null);oe(this,"cache",new Map);g(this,Ut,null);g(this,Kn,!1);g(this,It,void 0);g(this,Gn,()=>{if(i(this,Kn))throw new Error("The DB is closed")});g(this,Mi,(e,t,n,o)=>{i(this,Ut)!=null&&i(this,Ut).forEach(a=>{try{a(e,t,n,o)}catch(l){console.error("Failed notifying a DB update listener"),console.error(l)}})});this.api=e,this.db=t,this.filename=n,x(this,It,new TX(e,t,topLevelMutex,i(this,Gn),this.stmtFinalizer))}get siteid(){return i(this,bn)}_setSiteid(e){if(i(this,bn))throw new Error("Site id already set");x(this,bn,e)}_setTablesUsedStmt(e){x(this,qr,e)}get tablesUsedStmt(){if(i(this,qr)==null)throw new Error("tablesUsedStmt not set");return i(this,qr)}async automigrateTo(e,t){const n=cryb64(t),o=firstPick(await this.execA("SELECT value FROM crsql_master WHERE key = 'schema_name'")),a=firstPick(await this.execA("SELECT value FROM crsql_master WHERE key = 'schema_version'"));if(o===e&&BigInt(a||0)===n)return"noop";const l=o===void 0||o!==e?"apply":"migrate";return await this.tx(async d=>{if(a==null||o!==e){if(o!==e){const h=await d.execA("SELECT name FROM sqlite_master WHERE type = 'table' AND name NOT LIKE 'sqlite_%' AND name NOT LIKE 'crsql_%'");for(const p of h)await d.exec(`DROP TABLE [${p[0]}]`)}await d.exec(t)}else await d.exec("SELECT crsql_automigrate(?, 'SELECT crsql_finalize();')",[t]);await d.exec("INSERT OR REPLACE INTO crsql_master (key, value) VALUES (?, ?)",["schema_version",n]),await d.exec("INSERT OR REPLACE INTO crsql_master (key, value) VALUES (?, ?)",["schema_name",e])}),await this.exec("VACUUM;"),l}execMany(e){return i(this,It).execMany(e)}exec(e,t){return i(this,It).exec(e,t)}execO(e,t){return i(this,It).execO(e,t)}execA(e,t){return i(this,It).execA(e,t)}prepare(e){return i(this,It).prepare(e)}tx(e){return i(this,It).tx(e)}imperativeTx(){return i(this,It).imperativeTx()}async close(){var e;for(const t of this.stmtFinalizer.values())await t.finalize(this);return(e=i(this,qr))==null||e.finalize(this),this.exec("SELECT crsql_finalize()").then(()=>(x(this,Kn,!0),serialize(this.cache,void 0,()=>this.api.close(this.db),this.__mutex)))}createFunction(e,t,n){i(this,Gn).call(this),this.api.create_function(this.db,e,t.length,SQLITE_UTF8,0,(o,a)=>{const l=[];for(let h=0;h<t.length;++h)l.push(this.api.value(a[h]));const d=t(...l);d!==void 0&&this.api.result(o,d)})}onUpdate(e){return i(this,Ut)==null&&(this.api.update_hook(this.db,i(this,Mi)),x(this,Ut,new Set)),i(this,Ut).add(e),()=>{var t;return(t=i(this,Ut))==null?void 0:t.delete(e)}}}bn=new WeakMap,qr=new WeakMap,Ut=new WeakMap,Kn=new WeakMap,It=new WeakMap,Gn=new WeakMap,Mi=new WeakMap;let api=null;class SQLite3{constructor(e){oe(this,"base");this.base=e}open(e,t="c"){return serialize(null,void 0,()=>this.base.open_v2(e||":memory:",SQLITE_OPEN_CREATE|SQLITE_OPEN_READWRITE|SQLITE_OPEN_URI,e!=null?"idb-batch-atomic":void 0),topLevelMutex).then(n=>{const o=new DB(this.base,n,e||":memory:");return o.prepare(`SELECT tbl_name FROM tables_used(?) AS u
        JOIN sqlite_master ON sqlite_master.name = u.name
        WHERE u.schema = 'main'`).then(a=>{a.raw(!0),o._setTablesUsedStmt(a)}).then(()=>o.execA("select quote(crsql_site_id());")).then(a=>(o._setSiteid(a[0][0].replace(/'|X/g,"")),o))})}}async function initWasm(r){if(api!=null)return api;const e=await Module({locateFile(n){return r?r(n):new URL(""+new URL("../assets/crsqlite.CabMYEmC.wasm",import.meta.url).href,import.meta.url).href}}),t=Factory(e);return t.vfs_register(new IDBBatchAtomicVFS("idb-batch-atomic",{durability:"relaxed"})),api=new SQLite3(t),api}async function load(r,e){return{database:await(await initWasm(()=>e.wasm||wasmUrl)).open(r),env:"browser"}}class CRDialect extends SqliteDialect{constructor(t){super(t);oe(this,"database");this.database=async()=>typeof t.database=="function"?t.database():t.database}createDriver(){const t=this.database,n=mutex();let o,a;return{async init(){o=await t(),a={async executeQuery(l){return{rows:await o.execO(l.sql,l.parameters)}},async*streamQuery(){throw new Error("Sqlite driver doesn't support streaming")}}},async acquireConnection(){return await n.lock(),a},async beginTransaction(l){await l.executeQuery(CompiledQuery.raw("begin"))},async commitTransaction(l){await l.executeQuery(CompiledQuery.raw("commit"))},async rollbackTransaction(l){await l.executeQuery(CompiledQuery.raw("rollback"))},async releaseConnection(){n.unlock()},async destroy(){o==null||o.close()}}}}function mutex(){let r,e;return{async lock(){for(;r;)await r;r=new Promise(t=>e=t)},unlock(){const t=e;r=void 0,e=void 0,t==null||t()}}}function json(r,e){const t=Object.entries(e).flatMap(([n,o])=>[sql.lit(n),typeof o=="string"?r.ref(o):o]);return sql`json_object(${sql.join(t)})`.withPlugin({transformQuery({node:n}){return{...n,json:!0}}}).$castTo()}function group(r,e){const t=typeof e=="string"?r.ref(e).toOperationNode():e.toOperationNode();return new AggregateFunctionBuilder({aggregateFunctionNode:{...AggregateFunctionNode.create("json_group_array",[t]),json:!0}})}function groupJSON(r,e){return group(r,json(r,e))}var Xn;class JSONPlugin{constructor(){g(this,Xn,new WeakMap)}transformQuery({node:e,queryId:t}){return e.kind!=="SelectQueryNode"||i(this,Xn).set(t,new Set(this.getColumns(e))),e}async transformResult({result:e,queryId:t}){if(!Array.isArray(e.rows))return e;const n=i(this,Xn).get(t);return n&&e.rows.forEach(o=>this.parseObject(o,n)),e}getColumns(e){var n,o;const t=[];for(const a in e)e[a]&&typeof e[a]=="object"&&(e[a].json===!0&&typeof((n=e.alias)==null?void 0:n.name)=="string"&&t.push((o=e.alias)==null?void 0:o.name),t.push(...this.getColumns(e[a])));return t}parseObject(e,t){for(const n in e)t.has(n)&&(e[n]=JSON.parse(String(e[n]))),typeof e[n]=="object"&&this.parseObject(e[n],t)}}Xn=new WeakMap;function covert(r){const t={any:"blob",string:"text",number:"real",unknown:"blob",instance:"blob",bigint:"integer",integer:"integer",boolean:"boolean"}[r];if(t)return t;throw new Error(`Type "${r}" is not allowed in the database schema!`)}async function apply(r,{schema:e}){var t;for(const n in e){const o=e[n];let a=r.schema.createTable(n).ifNotExists();for(const l in o.schema){const{type:d}=o.schema[l];a=a.addColumn(l,(t=o.ordered)!=null&&t.find(([h])=>h===l)?"blob":covert(d),h=>{var p;return(p=o.primary)!=null&&p.includes(l)?h.notNull():h})}o.primary&&(a=a.addPrimaryKeyConstraint("primary_key",o.primary)),await a.execute();for(const l of o.indices||[])await r.schema.createIndex(`${n}_${l.join("_")}`).ifNotExists().on(n).columns(l).execute();o.crr&&await sql`SELECT crsql_as_crr(${n})`.execute(r);for(const l of o.ordered||[])await sql`SELECT crsql_fract_as_ordered(${n},${sql.join(l)})`.execute(r);await r.schema.createTable("__crstore_sync").ifNotExists().addColumn("version","integer").execute(),await sql`INSERT INTO __crstore_sync (version) SELECT 0
      WHERE NOT EXISTS (SELECT * FROM __crstore_sync)
    `.execute(r)}}function primary(r,...e){return r.primary=e,r}function crr(r){return r.crr=!0,r}function ordered(r,e,...t){return r.ordered||(r.ordered=[]),r.ordered.push([e,...t]),r}function index(r,...e){return r.indices||(r.indices=[]),r.indices.push(e),r}const connections$1=new Map,defaultPaths={};async function init(r,e,t=defaultPaths){if(connections$1.has(r))return connections$1.get(r);const{database:n,env:o}=await load(r,t),a=o==="browser"?CRDialect:SqliteDialect,l=new Kysely({dialect:new a({database:n}),plugins:[new JSONPlugin]}),d=l.destroy.bind(l);await l.transaction().execute(p=>apply(p,e));const h=Object.assign(l,{resolveChanges,applyOperation,insertChanges,updateVersion,selectVersion,selectClient,changesSince,async destroy(){return connections$1.delete(r),await finalize.bind(l)().execute(),d()}});return connections$1.set(r,h),h}const empty=[],ready=r=>r!==empty;function reactive(r,e=[]){const t=new Set,n={stop:void 0,start:void 0};let o,a=empty;function l(m){a=m,o&&t.forEach(E=>E(a))}function d(m){var E;return t.add(m),t.size===1&&(o=r(...e),n.stop=(E=n.start)==null?void 0:E.call(n,p)),m(a),()=>{var k;t.delete(m),t.size===0&&o&&(Promise.resolve(o).then(L=>L()),o=void 0,(k=n.stop)==null||k.call(n),n.stop=void 0)}}function h(m){var E;if(Array.isArray(m))return p(m);(E=n.stop)==null||E.call(n),n.start=m,o&&(n.stop=n.start(p))}function p(m){JSON.stringify(m)!==JSON.stringify(e)&&(e=m.slice(),o&&(Promise.resolve(o).then(E=>E()),o=r(...e)))}return{set:l,subscribe:d,bind:h}}const raf=globalThis.requestAnimationFrame||globalThis.setTimeout,error=Symbol("error");function queue(r,e){const t=new Map;let n;async function o(){return n||(n=new Promise(a=>raf(async()=>{const l=await r,d=new Map;await l.transaction().execute(async h=>{const p=e&&(await selectVersion.bind(h)().execute()).current;for(const[m,E]of t.entries()){const k=await E(h).catch(L=>({[error]:L}));d.set(m,k)}e==null||e(await changesSince.bind(h)(p).execute())}).catch(h=>{if(!String(h).includes("driver has already been destroyed"))throw h}),t.clear(),n=void 0,a(d)})))}return{enqueue(a,l,...d){return t.set(a,h=>l(h,...d)),o().then(h=>h.get(a)).then(h=>{if(h&&typeof h=="object"&&error in h)throw h[error];return h})}}}function database$1(r,{ssr:e=!1,name:t="crstore.db",paths:n=defaultPaths,error:o=void 0,push:a=void 0,pull:l=void 0,online:d=()=>{var h;return!!((h=globalThis.navigator)!=null&&h.onLine)}}={}){var fe;const p=!e&&!1?new Promise(()=>{}):init(t,r,n),m="BroadcastChannel"in globalThis?new globalThis.BroadcastChannel(`${t}-sync`):null,E=$=>I($.data,$.data[0]),k=queue(p,I),L=queue(p);m==null||m.addEventListener("message",E),(fe=globalThis.addEventListener)==null||fe.call(globalThis,"online",C);const S=new Map;let y=()=>{};C();async function w($,H){return L.enqueue(H,Q=>Q.getExecutor().executeQuery($,H)).then(Q=>Q.rows)}function b($,H,Q){const te=async(ue,X)=>{try{if(Q&&Q.client===X)return;await H(ue,X)}catch(be){o==null||o(be)}};return $.forEach(ue=>{var X;S.has(ue)||S.set(ue,new Set),(X=S.get(ue))==null||X.add(te)}),Q?p.then(async ue=>{const X=await ue.changesSince(Q.version,{filter:Q.client,chunk:!0}).execute();X.length&&X.forEach(be=>te(be))}):te(""),()=>$.forEach(ue=>{var X;return(X=S.get(ue))==null?void 0:X.delete(te)})}async function _(){if(!a||!d())return;const $=await p,{current:H,synced:Q}=await $.selectVersion().execute();if(H<=Q)return;const te=await $.changesSince(Q,{filter:null,chunk:!0}).execute();await Promise.all(te.map(a)),await $.updateVersion(H).execute()}async function C(){var te,ue;if((te=globalThis.removeEventListener)==null||te.call(globalThis,"offline",y),y(),!l||!d())return;const $=await p,{synced:H}=await $.selectVersion().execute(),Q=await $.selectClient().execute();await _(),y=l({version:H,client:Q},{async onData(X){X.length&&(await $.insertChanges(X).execute(),await I(X,X[0]))}}).unsubscribe,(ue=globalThis.addEventListener)==null||ue.call(globalThis,"offline",y)}async function A($,...H){return k.enqueue({},$,...H)}async function G($){if(!$.length)return;const H=await p;await I(await H.resolveChanges($).execute(),$[0])}async function I($,H){var X;if(!$.length)return;const Q=new Set,te=affectedTables($);(X=S.get("*"))==null||X.forEach(be=>Q.add(be)),te.forEach(be=>{var Re;return(Re=S.get(be))==null?void 0:Re.forEach(M=>Q.add(M))});const ue=[...Q].map(be=>be($,H));H||(m==null||m.postMessage($),await _()),await Promise.all(ue)}async function F(){var $,H;y(),m==null||m.close(),S.clear(),($=globalThis.removeEventListener)==null||$.call(globalThis,"online",C),(H=globalThis.removeEventListener)==null||H.call(globalThis,"offline",y),m==null||m.removeEventListener("message",E),await p.then(Q=>Q.destroy())}return{close:F,merge:G,update:A,subscribe:b,connection:p,replica:store.bind({connection:p,subscribe:b,update:A,refresh:w})}}function store(r,e={},t=[]){const{connection:n,update:o,refresh:a}=this;let l=null,d=null;const{subscribe:h,set:p,bind:m}=reactive(async(...L)=>{const S=await n,y=r(S,...L).toOperationNode(),w=affectedTables(y),b=S.getExecutor();return d={queryId:Math.random().toString(36).slice(2)},l=b.compileQuery(b.transformQuery(y,d),d),this.subscribe(w,E)},t);async function E(){await n,!(!l||!d)&&p(await a(l,d))}const k={};for(const L in e)k[L]=(...S)=>o(e[L],...S);return{...k,subscribe:h,bind:m,update(L,...S){return L?o(L,...S):E()},then(L=y=>y,S){let y=[];const w=h(b=>y=b);return E().then(()=>(w(),L==null?void 0:L(y)),S)}}}const APPEND=1,source=r=>r.selectFrom(e=>e.selectFrom("sources").select(["owner","source"]).orderBy("sources.primary","desc").as("ordered")).select(["owner",e=>group(e,"source").as("sources")]).groupBy("owner").$castTo(),asset=r=>r.selectFrom(e=>e.selectFrom("assets").select(["owner","art","thumbnail"]).orderBy("assets.primary","desc").as("ordered")).select(["owner",e=>group(e,"art").as("arts"),e=>group(e,"thumbnail").as("thumbnails")]).groupBy("owner").$castTo(),artist$1=r=>r.selectFrom("artists").leftJoin("source","source.owner","artists.id").leftJoin("asset","asset.owner","artists.id").select(["artists.id","artists.title","artists.following",e=>e.fn.coalesce("asset.arts",e.val("[]")).as("arts"),e=>e.fn.coalesce("asset.thumbnails",e.val("[]")).as("thumbnails"),e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources")]).$castTo(),album$1=r=>r.selectFrom("albums").leftJoin("source","source.owner","albums.id").leftJoin("asset","asset.owner","albums.id").leftJoin("attribution","attribution.album","albums.id").innerJoin("artist","artist.id","attribution.artist").select(["albums.id","albums.title","albums.year",e=>e.fn.coalesce("asset.arts",e.val("[]")).as("arts"),e=>e.fn.coalesce("asset.thumbnails",e.val("[]")).as("thumbnails"),e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources"),e=>groupJSON(e,{id:"artist.id",title:"artist.title",arts:"artist.arts",thumbnails:"artist.thumbnails",sources:"artist.sources"}).filterWhere("artist.id","is not",null).as("artists")]).groupBy("albums.id").$castTo(),track$2=r=>r.selectFrom("tracks").leftJoin("source","source.owner","tracks.id").innerJoin("album","album.id","tracks.album").select(["tracks.id","tracks.title","tracks.duration","album.artists",e=>e.fn.coalesce("source.sources",e.val("[]")).as("sources"),e=>json(e,{id:"album.id",title:"album.title",year:"album.year",arts:"album.arts",thumbnails:"album.thumbnails",sources:"album.sources"}).as("album")]).$castTo(),localDevice=sql`crsql_site_id()`,uuid=()=>Math.random()*2**32>>>0,sanitize=r=>r.replace(/-/g," ").split(/\s+/g).map(e=>`"${e.replace(/"/g,'""')}"`).join(" "),position={first:null,before:r=>r.selectFrom("queue").select("id").where("position","=",1).limit(1),shift:r=>e=>e.selectFrom("queue").select("id").whereRef(t=>t.selectFrom("queue").select(sql`position + 1`.as("position")).where("id","=",r),"=","position").limit(1),next:r=>r.selectFrom("devices").select("playback").where("id","=",localDevice).limit(1),last:r=>r.selectFrom("playback").select("id").where("device","=",localDevice).orderBy("order","desc").orderBy("id","desc").limit(1),random:r=>e=>e.selectFrom(t=>t.selectFrom("queue").select(["id","position"]).$if(!!r.length,n=>n.unionAll(sql`VALUES ${sql.raw(r.map(o=>`(${o}, 1)`).join(","))}`)).unionAll(sql`SELECT null,1 WHERE NOT EXISTS (SELECT 1 FROM queue WHERE position >= 0)`).as("data")).select("id").where("position",">=",0).orderBy(sql`random()`).limit(1)};async function pushTracks(r,e){e.length&&(await pushAlbums(r,e.map(t=>({...t.album,artists:t.artists}))),await r.insertInto("tracks").onConflict(t=>t.doNothing()).values(e.map(t=>({id:t.id,title:t.title,duration:t.duration,album:t.album.id}))).execute(),await pushResources(r,e))}async function pushAlbums(r,e){e.length&&(await pushArtists(r,e.flatMap(t=>t.artists)),e.find(t=>t.artists.length)&&await r.insertInto("attribution").onConflict(t=>t.doNothing()).values(e.flatMap(t=>t.artists.map(({id:n})=>({album:t.id,artist:n})))).execute(),await r.insertInto("albums").onConflict(t=>t.doNothing()).values(e.map(t=>({id:t.id,title:t.title,year:t.year}))).execute(),await pushResources(r,e))}async function pushArtists(r,e){e.length&&(await r.insertInto("artists").onConflict(t=>t.doNothing()).values(e.map(t=>({id:t.id,title:t.title,following:0}))).execute(),await pushResources(r,e))}async function pushResources(r,e){e.length&&(e.find(t=>t.sources.length)&&await r.insertInto("sources").onConflict(t=>t.doNothing()).values(e.flatMap(({id:t,sources:n})=>n.map((o,a)=>({owner:t,source:o,primary:+!a&&sql`NOT EXISTS (SELECT 1 FROM sources WHERE owner = ${t} AND "primary" = 1)`})))).execute(),e.find(t=>{var n;return(n=t.arts)==null?void 0:n.length})&&await r.insertInto("assets").onConflict(t=>t.doNothing()).values(e.flatMap(({id:t,arts:n,thumbnails:o})=>{if(!n)return[];const a=n.find((l,d)=>!!(o!=null&&o[d]))||n[0];return n.map((l,d)=>({owner:t,art:l,thumbnail:o==null?void 0:o[d],primary:+(l===a)&&sql`NOT EXISTS (SELECT 1 FROM assets WHERE owner = ${t} AND "primary" = 1)`}))})).execute())}const preceding$1=({replicated:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).with("update",t=>t.selectFrom("playback").select(n=>n.selectFrom("devices").select("id").as("_"))).selectFrom("queue").innerJoin("track","track.id","queue.track").where("position","<",0).select("queue.id as entry").select(fields).$castTo()),upcoming$1=({replicated:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).with("update",t=>t.selectFrom("playback").select(n=>n.selectFrom("devices").select("id").as("_"))).selectFrom("queue").innerJoin("track","track.id","queue.track").where("position",">",0).select("queue.id as entry").select(fields).$castTo()),playback$2=({replicated:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("devices").innerJoin("playback","playback.id","devices.playback").innerJoin("track","track.id","playback.track").select(["direction","repeat","infinite","device","progress"]).select(t=>json(t,{entry:"playback.id",id:"track.id",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).as("track")).select(sql`device = crsql_site_id()`.as("local")).select(fields).$castTo(),{async push(e,t,n="next"){if(!t.length)return;await pushTracks(e,t);const{direction:o,playback:a}=await e.selectFrom("devices").where("id","=",localDevice).select(["direction","playback"]).executeTakeFirstOrThrow(),l=t.map(uuid),d=o!=1?Number.isInteger(n)?n:n==="first"?position.first:n==="next"?position.next:position.last:Number.isInteger(n)?position.shift(+n):n==="first"?position.last:n==="next"?position.before:position.first;await e.insertInto("playback_fractindex").values(t.map((h,p)=>({id:l[p],track:h.id,device:localDevice,after_id:n==="random"?position.random(l.slice(0,p)):p>0&&o!=1?l[p-1]:d}))).execute(),!~a&&n==="random"&&await e.updateTable("devices").set({playback:h=>h.selectFrom("queue").select("id").$castTo().limit(1)}).execute()},async purge(e,t){t.length&&await e.deleteFrom("playback").where("id","in",t).execute()},async clear(e,t=localDevice){await e.deleteFrom("playback").where("device","=",t).execute(),await e.updateTable("devices").set({playback:-1,progress:0}).where("id","=",t).execute()},async sync(e,t){await e.updateTable("devices").where("id","=",localDevice).set({progress:t}).execute()},async rearrange(e,t,n=null){const{direction:o}=await e.selectFrom("devices").where("id","=",localDevice).select(["direction"]).executeTakeFirstOrThrow(),a=o!=1?n:n!=null?position.shift(n):position.last;await e.updateTable("playback_fractindex").set({after_id:a}).where("id","=",t).execute()},async redirect(e,t){const n=["forward","backward","shuffled"],{direction:o}=await e.selectFrom("devices").select("direction").where("id","=",localDevice).executeTakeFirstOrThrow(),a=n.indexOf(t);o!==a&&await e.updateTable("devices").set({direction:a}).where("id","=",localDevice).execute()},async repeat(e,t){const n=["none","single","all"];await e.updateTable("devices").set({repeat:n.indexOf(t)}).where("id","=",localDevice).execute()},async infinite(e,t){await e.updateTable("devices").set({infinite:t==null?sql`!infinite`:+t}).where("id","=",localDevice).execute()},async replicate(e,t){const n=uuid();await e.updateTable("devices").where("id","=",localDevice).set({playback:n,progress:o=>o.selectFrom("devices").where("id","=",t).select("progress")}).execute(),await e.deleteFrom("playback").where("device","=",localDevice).execute(),await e.insertInto("playback").expression(o=>o.selectFrom("playback").select(a=>a.case().when(l=>l.selectFrom("devices").whereRef("id","=","playback.device").select("devices.playback"),"=",a.ref("playback.id")).then(n).else(sql`ABS(RANDOM() % 4294967296)`).end().as("id")).select(sql`${localDevice}`.as("device")).select(["track","order","temp"]).where("device","=",t)).execute()}}),fields=["track.id","track.title","track.duration","track.album","track.artists","track.sources"];class StructError extends TypeError{constructor(e,t){let n;const{message:o,explanation:a,...l}=e,{path:d}=e,h=d.length===0?o:`At path: ${d.join(".")} -- ${o}`;super(a??h),a!=null&&(this.cause=h),Object.assign(this,l),this.name=this.constructor.name,this.failures=()=>n??(n=[e,...t()])}}function isIterable(r){return isObject$2(r)&&typeof r[Symbol.iterator]=="function"}function isObject$2(r){return typeof r=="object"&&r!=null}function print(r){return typeof r=="symbol"?r.toString():typeof r=="string"?JSON.stringify(r):`${r}`}function shiftIterator(r){const{done:e,value:t}=r.next();return e?void 0:t}function toFailure(r,e,t,n){if(r===!0)return;r===!1?r={}:typeof r=="string"&&(r={message:r});const{path:o,branch:a}=e,{type:l}=t,{refinement:d,message:h=`Expected a value of type \`${l}\`${d?` with refinement \`${d}\``:""}, but received: \`${print(n)}\``}=r;return{value:n,type:l,refinement:d,key:o[o.length-1],path:o,branch:a,...r,message:h}}function*toFailures(r,e,t,n){isIterable(r)||(r=[r]);for(const o of r){const a=toFailure(o,e,t,n);a&&(yield a)}}function*run(r,e,t={}){const{path:n=[],branch:o=[r],coerce:a=!1,mask:l=!1}=t,d={path:n,branch:o};if(a&&(r=e.coercer(r,d),l&&e.type!=="type"&&isObject$2(e.schema)&&isObject$2(r)&&!Array.isArray(r)))for(const p in r)e.schema[p]===void 0&&delete r[p];let h="valid";for(const p of e.validator(r,d))p.explanation=t.message,h="not_valid",yield[p,void 0];for(let[p,m,E]of e.entries(r,d)){const k=run(m,E,{path:p===void 0?n:[...n,p],branch:p===void 0?o:[...o,m],coerce:a,mask:l,message:t.message});for(const L of k)L[0]?(h=L[0].refinement!=null?"not_refined":"not_valid",yield[L[0],void 0]):a&&(m=L[1],p===void 0?r=m:r instanceof Map?r.set(p,m):r instanceof Set?r.add(m):isObject$2(r)&&(m!==void 0||p in r)&&(r[p]=m))}if(h!=="not_valid")for(const p of e.refiner(r,d))p.explanation=t.message,h="not_refined",yield[p,void 0];h==="valid"&&(yield[void 0,r])}class Struct{constructor(e){const{type:t,schema:n,validator:o,refiner:a,coercer:l=h=>h,entries:d=function*(){}}=e;this.type=t,this.schema=n,this.entries=d,this.coercer=l,o?this.validator=(h,p)=>{const m=o(h,p);return toFailures(m,p,this,h)}:this.validator=()=>[],a?this.refiner=(h,p)=>{const m=a(h,p);return toFailures(m,p,this,h)}:this.refiner=()=>[]}assert(e,t){return assert(e,this,t)}create(e,t){return create(e,this,t)}is(e){return is(e,this)}mask(e,t){return mask(e,this,t)}validate(e,t={}){return validate(e,this,t)}}function assert(r,e,t){const n=validate(r,e,{message:t});if(n[0])throw n[0]}function create(r,e,t){const n=validate(r,e,{coerce:!0,message:t});if(n[0])throw n[0];return n[1]}function mask(r,e,t){const n=validate(r,e,{coerce:!0,mask:!0,message:t});if(n[0])throw n[0];return n[1]}function is(r,e){return!validate(r,e)[0]}function validate(r,e,t={}){const n=run(r,e,t),o=shiftIterator(n);return o[0]?[new StructError(o[0],function*(){for(const l of n)l[0]&&(yield l[0])}),void 0]:[void 0,o[1]]}function assign(...r){const e=r[0].type==="type",t=r.map(o=>o.schema),n=Object.assign({},...t);return e?type(n):object(n)}function define(r,e){return new Struct({type:r,schema:null,validator:e})}function omit(r,e){const{schema:t}=r,n={...t};for(const o of e)delete n[o];switch(r.type){case"type":return type(n);default:return object(n)}}function any(){return define("any",()=>!0)}function array(r){return new Struct({type:"array",schema:r,*entries(e){if(r&&Array.isArray(e))for(const[t,n]of e.entries())yield[t,n,r]},coercer(e){return Array.isArray(e)?e.slice():e},validator(e){return Array.isArray(e)||`Expected an array value, but received: ${print(e)}`}})}function instance$1(r){return define("instance",e=>e instanceof r||`Expected a \`${r.name}\` instance, but received: ${print(e)}`)}function integer(){return define("integer",r=>typeof r=="number"&&!isNaN(r)&&Number.isInteger(r)||`Expected an integer, but received: ${print(r)}`)}function literal(r){const e=print(r),t=typeof r;return new Struct({type:"literal",schema:t==="string"||t==="number"||t==="boolean"?r:null,validator(n){return n===r||`Expected the literal \`${e}\`, but received: ${print(n)}`}})}function never(){return define("never",()=>!1)}function nullable(r){return new Struct({...r,validator:(e,t)=>e===null||r.validator(e,t),refiner:(e,t)=>e===null||r.refiner(e,t)})}function number(){return define("number",r=>typeof r=="number"&&!isNaN(r)||`Expected a number, but received: ${print(r)}`)}function object(r){const e=r?Object.keys(r):[],t=never();return new Struct({type:"object",schema:r||null,*entries(n){if(r&&isObject$2(n)){const o=new Set(Object.keys(n));for(const a of e)o.delete(a),yield[a,n[a],r[a]];for(const a of o)yield[a,n[a],t]}},validator(n){return isObject$2(n)||`Expected an object, but received: ${print(n)}`},coercer(n){return isObject$2(n)?{...n}:n}})}function optional(r){return new Struct({...r,validator:(e,t)=>e===void 0||r.validator(e,t),refiner:(e,t)=>e===void 0||r.refiner(e,t)})}function string(){return define("string",r=>typeof r=="string"||`Expected a string, but received: ${print(r)}`)}function type(r){const e=Object.keys(r);return new Struct({type:"type",schema:r,*entries(t){if(isObject$2(t))for(const n of e)yield[n,t[n],r[n]]},validator(t){return isObject$2(t)||`Expected an object, but received: ${print(t)}`},coercer(t){return isObject$2(t)?{...t}:t}})}function union(r){const e=r.map(t=>t.type).join(" | ");return new Struct({type:"union",schema:null,coercer(t){for(const n of r){const[o,a]=n.validate(t,{coerce:!0});if(!o)return a}return t},validator(t,n){const o=[];for(const a of r){const[...l]=run(t,a,n),[d]=l;if(d[0])for(const[h]of l)h&&o.push(h);else return[]}return[`Expected the value to satisfy a union of \`${e}\`, but received: ${print(t)}`,...o]}})}const track$1=object({title:string(),duration:number()}),album=object({title:string(),year:integer()}),artist=object({title:string()}),playlist=object({title:string(),relevancy:number(),shared:nullable(string()),remote:nullable(string())});type({title:optional(string()),album:optional(type({title:optional(string())})),artists:optional(array(type({title:optional(string())})))});const media=object({sources:array(string()),arts:optional(array(string())),thumbnails:optional(array(nullable(string())))}),collection=r=>object({size:integer(),duration:number(),tracks:array(r)}),unique=r=>assign(r,object({id:integer()})),artistInfo=assign(artist,media),albumInfo=assign(album,assign(media,object({artists:array(artistInfo)}))),trackInfo=assign(track$1,assign(omit(media,["arts","thumbnails"]),object({album:omit(albumInfo,["artists"]),artists:array(artistInfo)}))),playlistInfo=playlist,track=assign(unique(trackInfo),object({entry:optional(number()),album:unique(trackInfo.schema.album),artists:array(unique(trackInfo.schema.artists.schema))}));assign(unique(albumInfo),object({artists:array(unique(albumInfo.schema.artists.schema)),collection:optional(collection(track))}));assign(unique(artistInfo),object({following:optional(union([literal(0),literal(1)])),collection:optional(collection(track))}));assign(unique(playlistInfo),object({collection:optional(collection(track))}));function has(r,e){return r!==null&&typeof r=="object"&&e in r&&r[e]!==void 0}function getDefaultExportFromCjs(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var murmurhash={exports:{}};(function(r){(function(){const e=a=>new TextEncoder().encode(a);function t(a,l){typeof a=="string"&&(a=e(a));let d=a.length,h=l^d,p=0,m;for(;d>=4;)m=a[p]&255|(a[++p]&255)<<8|(a[++p]&255)<<16|(a[++p]&255)<<24,m=(m&65535)*1540483477+(((m>>>16)*1540483477&65535)<<16),m^=m>>>24,m=(m&65535)*1540483477+(((m>>>16)*1540483477&65535)<<16),h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)^m,d-=4,++p;switch(d){case 3:h^=(a[p+2]&255)<<16;case 2:h^=(a[p+1]&255)<<8;case 1:h^=a[p]&255,h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)}return h^=h>>>13,h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16),h^=h>>>15,h>>>0}function n(a,l){typeof a=="string"&&(a=e(a));let d,h,p,m,E,k,L,S;for(d=a.length&3,h=a.length-d,p=l,E=3432918353,k=461845907,S=0;S<h;)L=a[S]&255|(a[++S]&255)<<8|(a[++S]&255)<<16|(a[++S]&255)<<24,++S,L=(L&65535)*E+(((L>>>16)*E&65535)<<16)&4294967295,L=L<<15|L>>>17,L=(L&65535)*k+(((L>>>16)*k&65535)<<16)&4294967295,p^=L,p=p<<13|p>>>19,m=(p&65535)*5+(((p>>>16)*5&65535)<<16)&4294967295,p=(m&65535)+27492+(((m>>>16)+58964&65535)<<16);switch(L=0,d){case 3:L^=(a[S+2]&255)<<16;case 2:L^=(a[S+1]&255)<<8;case 1:L^=a[S]&255,L=(L&65535)*E+(((L>>>16)*E&65535)<<16)&4294967295,L=L<<15|L>>>17,L=(L&65535)*k+(((L>>>16)*k&65535)<<16)&4294967295,p^=L}return p^=a.length,p^=p>>>16,p=(p&65535)*2246822507+(((p>>>16)*2246822507&65535)<<16)&4294967295,p^=p>>>13,p=(p&65535)*3266489909+(((p>>>16)*3266489909&65535)<<16)&4294967295,p^=p>>>16,p>>>0}const o=n;o.v2=t,o.v3=n,r.exports=o})()})(murmurhash);var murmurhashExports=murmurhash.exports;const hash=getDefaultExportFromCjs(murmurhashExports);function titled(r){return has(r,"title")?r.title:r}function compare$1(r,e){return typeof r=="string"&&typeof e=="string"?r.localeCompare(e):typeof r=="number"&&typeof e=="number"?r-e:has(r,"title")&&has(e,"title")?compare$1(clean(titled(r)),clean(titled(e))):0}function normalize(r){if(typeof r=="string")return clean(r);if(typeof r!="object")return r;const e={...r};for(const t in e)Array.isArray(e[t])?e[t]=e[t].map(normalize).sort(compare$1):e[t]=normalize(e[t]);return e}function stringify(r){return r=normalize(r),typeof r=="string"?r:typeof r!="object"?clean(String(r)):has(r,"artists")&&has(r,"title")&&has(r,"album")?`${r.artists.map(titled)} - ${r.title} - ${titled(r.album)}`:has(r,"artists")&&has(r,"title")?`${r.artists.map(titled)} - ${r.title}`:has(r,"title")?r.title:Array.isArray(r)?r.map(titled).toString():JSON.stringify(r)}function identify(r){return has(r,"id")?+r.id:hash(stringify(r))}const playlists$2=({replicated:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",t=>track$2(t).innerJoin("library","library.track","tracks.id").select(["library.playlist","library.id as entry"]).orderBy("library.order").orderBy("library.id")).selectFrom("track").fullJoin("playlists","playlists.id","track.playlist").where("playlists.id",">=",0).select(["playlists.id","playlists.title","playlists.relevancy","playlists.shared","playlists.remote",t=>json(t,{size:t.fn.count("track.duration"),duration:t.fn.coalesce(t.fn.sum("track.duration"),t.val(0)),tracks:groupJSON(t,{id:"track.id",entry:"track.entry",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("playlists.id").orderBy("playlists.order").orderBy("playlists.id").$castTo(),{async create(e,t){await e.insertInto("playlists").onConflict(n=>n.doNothing()).values({id:identify(t),order:APPEND,relevancy:1,...t}).execute()},async edit(e,t,n){await e.updateTable("playlists").where("id","=",t).set(n).execute()},async rearrange(e,t,n){await e.updateTable("playlists_fractindex").set({after_id:n||null}).where("id","=",t).execute()},async delete(e,t){await e.deleteFrom("playlists").where("id","=",t).execute()},get(e,t){return e.selectFrom("playlists").selectAll().where("id","=",t).executeTakeFirstOrThrow()}}),resources$1=({replicated:r})=>r(e=>e.with("source",source).with("asset",asset).selectFrom("source").leftJoin("asset","asset.owner","source.owner").select([t=>t.fn.coalesce("asset.arts",t.val("[]")).as("arts"),t=>t.fn.coalesce("asset.thumbnails",t.val("[]")).as("thumbnails"),t=>t.fn.coalesce("source.sources",t.val("[]")).as("sources")]).$castTo(),{async prioritize(e,t,n){const o=t==="art"?"assets":"sources";await e.updateTable(o).set({primary:sql`${sql.ref(t)} = ${n}`}).where("owner","=",a=>a.selectFrom(o).where(t,"=",n).select("owner")).execute()},get(e,t){return e.with("source",source).with("asset",asset).selectFrom("source").leftJoin("asset","asset.owner","source.owner").select([n=>n.fn.coalesce("asset.arts",n.val("[]")).as("arts"),n=>n.fn.coalesce("asset.thumbnails",n.val("[]")).as("thumbnails"),n=>n.fn.coalesce("source.sources",n.val("[]")).as("sources")]).where("source.owner","=",t).$castTo().executeTakeFirstOrThrow()}}),settings$2=({replicated:r})=>r(e=>e.selectFrom("settings").select(["key",sql`json_extract(value, '$')`.as("value")]),{async store(e,t,n,o="settings"){o!=="settings"&&(await e.schema.createTable(o).ifNotExists().addColumn("key","text",a=>a.primaryKey().notNull()).addColumn("value","text").execute(),await e.schema.createIndex(o+"_value").ifNotExists().on(o).column("value").execute()),await e.insertInto(o).onConflict(a=>a.doUpdateSet({value:JSON.stringify(n)})).values({key:t,value:JSON.stringify(n)}).execute()},async extract(e,t,n="settings"){return e.selectFrom(n).select("value").where("key","=",t).executeTakeFirstOrThrow().then(o=>JSON.parse(o.value))},async lookup(e,t,n="settings"){return e.selectFrom(n).select("key").where("value","=",JSON.stringify(t)).executeTakeFirstOrThrow().then(o=>o.key)}}),history$2=({replicated:r})=>r(e=>e.selectFrom("history").orderBy("date","desc").selectAll(),{async log(e,t){t.trim()&&await e.insertInto("history").onConflict(n=>n.doUpdateSet({date:Date.now()})).values({query:t,date:Date.now()}).execute()},async clear(e){await e.deleteFrom("history").execute()},get(e){return e.selectFrom("history").selectAll().orderBy("date","desc").execute()}}),artists$2=({replicated:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("artist").leftJoin("attribution","attribution.artist","artist.id").leftJoin("albums","albums.id","attribution.album").leftJoin("tracks","tracks.album","albums.id").leftJoin("track","track.id","tracks.id").select(["artist.id","artist.title","artist.following","artist.arts","artist.thumbnails","artist.sources",t=>json(t,{size:t.fn.count("track.duration"),duration:t.fn.coalesce(t.fn.sum("track.duration"),t.val(0)),tracks:groupJSON(t,{id:"track.id",entry:"track.id",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("artist.id").orderBy(t=>t.fn.count("track.duration"),"desc").orderBy("artist.title").$castTo(),{async push(e,t){await pushArtists(e,t)},async edit(e,t,n){await e.updateTable("artists").where("id","=",t).set(n)},async follow(e,t){await e.updateTable("artists").set({following:1}).where("id","=",t).execute()},async unfollow(e,t){await e.updateTable("artists").set({following:0}).where("id","=",t).execute()},async search(e,t,n=10,o=0){return t?e.with("source",source).with("asset",asset).with("artist",artist$1).selectFrom("artists_fts").where("artists_fts","match",sanitize(t)).orderBy("rank").innerJoin("artist","artist.id","artists_fts.rowid").selectAll().limit(n).offset(o).$castTo().execute():[]},get(e,t){return e.with("source",source).with("asset",asset).with("artist",artist$1).selectFrom("artist").where("artist.id","=",t).selectAll().$castTo().executeTakeFirstOrThrow()}}),library$2=({replicated:r})=>r(e=>e.selectFrom("library").selectAll(),{async push(e,t,n){t.length&&(await pushTracks(e,t),n!=null&&await e.insertInto("library").onConflict(o=>o.doNothing()).values(t.map(({id:o})=>({id:uuid(),order:APPEND,date:~~(Date.now()/1e3),track:o,playlist:n}))).execute())},async rearrange(e,t,n){await e.updateTable("library_fractindex").set({after_id:n||null}).where("id","=",t).execute()},async purge(e,t){const n=t.map(o=>e.deleteFrom("library").where("id","=",o).execute());await Promise.all(n)},async get(e,t){return t.length?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources","library.id as entry"]).where("library.id","in",t).$castTo().execute():[]},async sample(e,t,n=t){const o=n*Math.sqrt(2*Math.PI)/2,a=sql`POW(ABS(RANDOM()) / 9223372036854775808,
        ${o} /
        EXP(-0.5 * POW(row_number() OVER (ORDER BY date DESC) / ${n},2)) *
        playlists.relevancy
      )`;return await e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").innerJoin("playlists","playlists.id","library.playlist").innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources"]).where("relevancy",">",0).orderBy(a,"desc").limit(t).execute()},async banned(e){return await e.selectFrom("library").leftJoin("playlists","playlists.id","library.playlist").select("library.track").where("relevancy","<",0).execute().then(t=>t.map(n=>n.track))},async has(e,t){return await e.selectFrom("tracks").select("id").where("id","in",t).execute()}});function database(r,e={}){const{replica:t,...n}=database$1(r,e);function o(...a){return function(l,d){const h=a.length?derived(a,k=>k):void 0,p=h&&get_store_value(h),{bind:m,...E}=t(l,d,p);return m(k=>h==null?void 0:h.subscribe(k)),E}}return{replicated:Object.assign(o(),{with:o}),...n}}const id=integer,boolean=integer,tracks$2=assign(unique(track$1),object({album:id()}));crr(tracks$2);index(tracks$2,"album");primary(tracks$2,"id");const albums$2=unique(album);crr(albums$2);primary(albums$2,"id");const artists$1=assign(unique(artist),object({following:boolean()}));crr(artists$1);primary(artists$1,"id");const attribution=object({album:id(),artist:id()});crr(attribution);index(attribution,"artist");primary(attribution,"album","artist");const sources=object({source:string(),owner:id(),primary:boolean()});crr(sources);primary(sources,"owner","source");const assets=object({art:string(),thumbnail:nullable(string()),owner:id(),primary:boolean()});crr(assets);primary(assets,"owner","art");const playlists$1=assign(unique(playlist),object({order:string()}));crr(playlists$1);primary(playlists$1,"id");ordered(playlists$1,"order");index(playlists$1,"order","id");const library$1=object({id:id(),playlist:id(),track:id(),date:integer(),order:string()});crr(library$1);primary(library$1,"id");index(library$1,"date");index(library$1,"track");index(library$1,"playlist");index(library$1,"order","id");ordered(library$1,"order","playlist");const playback$1=object({id:id(),device:instance$1(Uint8Array),track:id(),order:string(),temp:any()});crr(playback$1);primary(playback$1,"id");index(playback$1,"device");index(playback$1,"order","id");ordered(playback$1,"order","device");const devices=object({id:instance$1(Uint8Array),playback:id(),direction:integer(),infinite:integer(),progress:number(),repeat:integer()});crr(devices);primary(devices,"id");const settings$1=object({key:string(),value:string()});crr(settings$1);index(settings$1,"value");primary(settings$1,"key");const history$1=object({query:string(),date:integer()});crr(history$1);index(history$1,"date");primary(history$1,"query");const schema=object({tracks:tracks$2,albums:albums$2,attribution,artists:artists$1,sources,assets,library:library$1,playlists:playlists$1,playback:playback$1,devices,settings:settings$1,history:history$1}),tracks$1=({replicated:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("library").where("playlist",">=",0).innerJoin("track","track.id","library.track").select(["track.id","track.title","track.duration","track.album","track.artists","track.sources","library.id as entry","library.date"]).orderBy("library.date","desc").orderBy("library.id").$castTo(),{async edit(e,t,n){const o=await e.updateTable("tracks").where("id","=",t).set({...n,album:void 0}).returning("album").executeTakeFirst();o!=null&&o.album&&n.album&&await e.updateTable("albums").where("id","=",o.album).set(n.album).execute()},async search(e,t,n=10,o=0){return t?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("tracks_fts").where("tracks_fts","match",sanitize(t)).orderBy("rank").innerJoin("track","track.id","rowid").selectAll().limit(n).offset(o).$castTo().execute():[]},get(e,t){return e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",track$2).selectFrom("track").selectAll().where("id","=",t).$castTo().executeTakeFirstOrThrow()}}),albums$1=({replicated:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("album").selectAll().orderBy("album.title"),{async push(e,t){await pushAlbums(e,t)},async search(e,t,n=10,o=0){return t?e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("albums_fts").where("albums_fts","match",sanitize(t)).orderBy("rank").innerJoin("album","album.id","albums_fts.rowid").selectAll().limit(n).offset(o).$castTo().execute():[]},get(e,t){return e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).selectFrom("album").selectAll().where("album.id","=",t).$castTo().executeTakeFirstOrThrow()}}),feed$1=({replicated:r})=>r(e=>e.with("source",source).with("asset",asset).with("artist",artist$1).with("album",album$1).with("track",t=>track$2(t).innerJoin("library","library.track","tracks.id").select(["library.playlist","library.id as entry"]).orderBy("library.order").orderBy("library.id")).selectFrom("track").fullJoin("playlists","playlists.id","track.playlist").where("playlists.id","<",0).select(["playlists.id","playlists.title","playlists.relevancy","playlists.shared","playlists.remote",t=>json(t,{size:t.fn.count("track.duration"),duration:t.fn.coalesce(t.fn.sum("track.duration"),t.val(0)),tracks:groupJSON(t,{id:"track.id",entry:"track.entry",title:"track.title",duration:"track.duration",album:"track.album",artists:"track.artists",sources:"track.sources"}).filterWhere("track.id","is not",null)}).as("collection")]).groupBy("playlists.id").orderBy("playlists.order").orderBy("playlists.id").$castTo(),{async get(e,t,n=-1){return e.selectFrom("library").where("playlist","=",t).select("id").limit(n).execute().then(o=>o.map(a=>a.id))},async clear(e,t,n=Number.MAX_SAFE_INTEGER){await e.deleteFrom("library").where("playlist","=",t).where("date","<=",n).execute()}}),connections=new Map,stores=r=>({playlists:playlists$2(r),resources:resources$1(r),preceding:preceding$1(r),playback:playback$2(r),upcoming:upcoming$1(r),settings:settings$2(r),history:history$2(r),artists:artists$2(r),library:library$2(r),albums:albums$1(r),tracks:tracks$1(r),feed:feed$1(r)});function connect(r){if(!connections.has(r.name)){const e=database(r.local?nocrr(schema):schema,r);connections.set(r.name,{...e,...stores(e)});const t=Object.assign({"../sql/cascade.sql":__vite_glob_0_0,"../sql/fts.sql":__vite_glob_0_1,"../sql/playback.sql":__vite_glob_0_2,"../sql/playlists.sql":__vite_glob_0_3});r.local&&delete t["../sql/fts.sql"];const n=Object.values(t).flatMap(o=>o.split(/\r?\n\r?\n/)).map(o=>sql.raw(o));e.update(o=>Promise.all(n.map(a=>a.execute(o))))}return connections.get(r.name)}function nocrr(r){return{...r,schema:Object.fromEntries(Object.entries(r.schema).map(([e,t])=>[e,{...t,crr:!1}]))}}function identity(r){return r}function pipeFromArray(r){return r.length===0?identity:r.length===1?r[0]:function(t){return r.reduce((n,o)=>o(n),t)}}function observable(r){const e={subscribe(t){let n=null,o=!1,a=!1,l=!1;function d(){if(n===null){l=!0;return}a||(a=!0,typeof n=="function"?n():n&&n.unsubscribe())}return n=r({next(h){var p;o||(p=t.next)==null||p.call(t,h)},error(h){var p;o||(o=!0,(p=t.error)==null||p.call(t,h),d())},complete(){var h;o||(o=!0,(h=t.complete)==null||h.call(t),d())}}),l&&d(),{unsubscribe:d}},pipe(...t){return pipeFromArray(t)(e)}};return e}function share(r){return e=>{let t=0,n=null;const o=[];function a(){n||(n=e.subscribe({next(d){var h;for(const p of o)(h=p.next)==null||h.call(p,d)},error(d){var h;for(const p of o)(h=p.error)==null||h.call(p,d)},complete(){var d;for(const h of o)(d=h.complete)==null||d.call(h)}}))}function l(){if(t===0&&n){const d=n;n=null,d.unsubscribe()}}return{subscribe(d){return t++,o.push(d),a(),{unsubscribe(){t--,l();const h=o.findIndex(p=>p===d);h>-1&&o.splice(h,1)}}}}}}class ObservableAbortError extends Error{constructor(e){super(e),this.name="ObservableAbortError",Object.setPrototypeOf(this,ObservableAbortError.prototype)}}function observableToPromise(r){let e;return{promise:new Promise((n,o)=>{let a=!1;function l(){a||(a=!0,o(new ObservableAbortError("This operation was aborted.")),d.unsubscribe())}const d=r.subscribe({next(h){a=!0,n(h),l()},error(h){a=!0,o(h),l()},complete(){a=!0,l()}});e=l}),abort:e}}function createChain(r){return observable(e=>{function t(o=0,a=r.op){const l=r.links[o];if(!l)throw new Error("No more links to execute - did you forget to add an ending link?");return l({op:a,next(h){return t(o+1,h)}})}return t().subscribe(e)})}function invert(r){const e=Object.create(null);for(const t in r){const n=r[t];e[n]=t}return e}const TRPC_ERROR_CODES_BY_KEY={PARSE_ERROR:-32700,BAD_REQUEST:-32600,INTERNAL_SERVER_ERROR:-32603,NOT_IMPLEMENTED:-32603,UNAUTHORIZED:-32001,FORBIDDEN:-32003,NOT_FOUND:-32004,METHOD_NOT_SUPPORTED:-32005,TIMEOUT:-32008,CONFLICT:-32009,PRECONDITION_FAILED:-32012,PAYLOAD_TOO_LARGE:-32013,UNPROCESSABLE_CONTENT:-32022,TOO_MANY_REQUESTS:-32029,CLIENT_CLOSED_REQUEST:-32099};invert(TRPC_ERROR_CODES_BY_KEY);invert(TRPC_ERROR_CODES_BY_KEY);const noop=()=>{};function createInnerProxy(r,e){return new Proxy(noop,{get(n,o){if(!(typeof o!="string"||o==="then"))return createInnerProxy(r,[...e,o])},apply(n,o,a){const l=e[e.length-1]==="apply";return r({args:l?a.length>=2?a[1]:[]:a,path:l?e.slice(0,-1):e})}})}const createRecursiveProxy=r=>createInnerProxy(r,[]),createFlatProxy=r=>new Proxy(noop,{get(e,t){if(!(typeof t!="string"||t==="then"))return r(t)}});function isObject$1(r){return!!r&&!Array.isArray(r)&&typeof r=="object"}class UnknownCauseError extends Error{}function getCauseFromUnknown(r){if(r instanceof Error)return r;const e=typeof r;if(!(e==="undefined"||e==="function"||r===null)){if(e!=="object")return new Error(String(r));if(isObject$1(r)){const t=new UnknownCauseError;for(const n in r)t[n]=r[n];return t}}}function isObject(r){return!!r&&!Array.isArray(r)&&typeof r=="object"}function transformResultInner(r,e){if("error"in r){const n=e.transformer.deserialize(r.error);return{ok:!1,error:{...r,error:n}}}return{ok:!0,result:{...r.result,...(!r.result.type||r.result.type==="data")&&{type:"data",data:e.transformer.deserialize(r.result.data)}}}}class TransformResultError extends Error{constructor(){super("Unable to transform response from server")}}function transformResult(r,e){let t;try{t=transformResultInner(r,e)}catch{throw new TransformResultError}if(!t.ok&&(!isObject(t.error.error)||typeof t.error.error.code!="number"))throw new TransformResultError;if(t.ok&&!isObject(t.result))throw new TransformResultError;return t}function isTRPCClientError(r){return r instanceof TRPCClientError||r instanceof Error&&r.name==="TRPCClientError"}function isTRPCErrorResponse(r){return isObject(r)&&isObject(r.error)&&typeof r.error.code=="number"&&typeof r.error.message=="string"}class TRPCClientError extends Error{static from(e,t={}){const n=e;return isTRPCClientError(n)?(t.meta&&(n.meta={...n.meta,...t.meta}),n):isTRPCErrorResponse(n)?new TRPCClientError(n.error.message,{...t,result:n}):n instanceof Error?new TRPCClientError(n.message,{...t,cause:getCauseFromUnknown(n)}):new TRPCClientError("Unknown error",{...t,cause:n})}constructor(e,t){var o,a;const n=t==null?void 0:t.cause;super(e,{cause:n}),this.meta=t==null?void 0:t.meta,this.cause=n,this.shape=(o=t==null?void 0:t.result)==null?void 0:o.error,this.data=(a=t==null?void 0:t.result)==null?void 0:a.error.data,this.name="TRPCClientError",Object.setPrototypeOf(this,TRPCClientError.prototype)}}/* istanbul ignore next -- @preserve */const retryDelay=r=>r===0?0:Math.min(1e3*2**r,3e4);function createWSClient(r){const{url:e,WebSocket:t=WebSocket,retryDelayMs:n=retryDelay,onOpen:o,onClose:a}=r;/* istanbul ignore next -- @preserve */if(!t)throw new Error("No WebSocket implementation found - you probably don't want to use this on the server, but if you do you need to pass a `WebSocket`-ponyfill");let l=[];const d=Object.create(null);let h=0,p=null,m=null,E=A(),k="connecting";function L(){k!=="open"||p||(p=setTimeout(()=>{p=null,l.length===1?E.send(JSON.stringify(l.pop())):E.send(JSON.stringify(l)),l=[]}))}function S(){if(m!==null||k==="closed")return;const I=n(h++);w(I)}function y(){k="connecting";const I=E;E=A(),b(I)}function w(I){m||(k="connecting",m=setTimeout(y,I))}function b(I){Object.values(d).some(fe=>fe.ws===I)||I.close()}function _(){Object.values(d).forEach(I=>{I.type==="subscription"&&I.callbacks.complete()})}function C(I){l.some(F=>F.id===I.op.id)||G(I.op,I.callbacks)}function A(){const I=typeof e=="function"?e():e,F=new t(I);clearTimeout(m),m=null,F.addEventListener("open",()=>{/* istanbul ignore next -- @preserve */F===E&&(h=0,k="open",o==null||o(),L())}),F.addEventListener("error",()=>{F===E&&S()});const fe=H=>{if(H.method==="reconnect"&&F===E){k==="open"&&(a==null||a()),y();for(const Q of Object.values(d))Q.type==="subscription"&&C(Q)}},$=H=>{var te,ue;const Q=H.id!==null&&d[H.id];if(Q){if((ue=(te=Q.callbacks).next)==null||ue.call(te,H),Q.ws!==E&&F===E){const X=Q.ws;Q.ws=E,b(X)}"result"in H&&H.result.type==="stopped"&&F===E&&Q.callbacks.complete()}};return F.addEventListener("message",({data:H})=>{const Q=JSON.parse(H);"method"in Q?fe(Q):$(Q),(F!==E||k==="closed")&&b(F)}),F.addEventListener("close",({code:H})=>{var Q,te,ue,X;k==="open"&&(a==null||a({code:H})),E===F&&S();for(const[be,Re]of Object.entries(d))if(Re.ws===F){if(k==="closed"){delete d[be],(te=(Q=Re.callbacks).complete)==null||te.call(Q);continue}Re.type==="subscription"?C(Re):(delete d[be],(X=(ue=Re.callbacks).error)==null||X.call(ue,TRPCClientError.from(new TRPCWebSocketClosedError("WebSocket closed prematurely"))))}}),F}function G(I,F){const{type:fe,input:$,path:H,id:Q}=I,te={id:Q,method:fe,params:{input:$,path:H}};return d[Q]={ws:E,type:fe,callbacks:F,op:I},l.push(te),L(),()=>{var X,be;const ue=(X=d[Q])==null?void 0:X.callbacks;delete d[Q],l=l.filter(Re=>Re.id!==Q),(be=ue==null?void 0:ue.complete)==null||be.call(ue),E.readyState===t.OPEN&&I.type==="subscription"&&(l.push({id:Q,method:"subscription.stop"}),L())}}return{close:()=>{k="closed",a==null||a(),_(),b(E),clearTimeout(m),m=null},request:G,getConnection(){return E}}}class TRPCWebSocketClosedError extends Error{constructor(e){super(e),this.name="TRPCWebSocketClosedError",Object.setPrototypeOf(this,TRPCWebSocketClosedError.prototype)}}function wsLink(r){return e=>{const{client:t}=r;return({op:n})=>observable(o=>{const{type:a,path:l,id:d,context:h}=n,p=e.transformer.serialize(n.input),m=t.request({type:a,path:l,input:p,id:d,context:h},{error(E){o.error(E),m()},complete(){o.complete()},next(E){const k=transformResult(E,e);if(!k.ok){o.error(TRPCClientError.from(k.error));return}o.next({result:k.result}),n.type!=="subscription"&&(m(),o.complete())}});return()=>{m()}})}}class TRPCUntypedClient{$request({type:e,input:t,path:n,context:o={}}){return createChain({links:this.links,op:{id:++this.requestId,type:e,path:n,input:t,context:o}}).pipe(share())}requestAsPromise(e){const t=this.$request(e),{promise:n,abort:o}=observableToPromise(t);return new Promise((l,d)=>{var h;(h=e.signal)==null||h.addEventListener("abort",o),n.then(p=>{l(p.result.data)}).catch(p=>{d(TRPCClientError.from(p))})})}query(e,t,n){return this.requestAsPromise({type:"query",path:e,input:t,context:n==null?void 0:n.context,signal:n==null?void 0:n.signal})}mutation(e,t,n){return this.requestAsPromise({type:"mutation",path:e,input:t,context:n==null?void 0:n.context,signal:n==null?void 0:n.signal})}subscription(e,t,n){return this.$request({type:"subscription",path:e,input:t,context:n==null?void 0:n.context}).subscribe({next(a){var l,d,h;a.result.type==="started"?(l=n.onStarted)==null||l.call(n):a.result.type==="stopped"?(d=n.onStopped)==null||d.call(n):(h=n.onData)==null||h.call(n,a.result.data)},error(a){var l;(l=n.onError)==null||l.call(n,a)},complete(){var a;(a=n.onComplete)==null||a.call(n)}})}constructor(e){this.requestId=0;const t=(()=>{const n=e.transformer;return n?"input"in n?e.transformer:{input:n,output:n}:{input:{serialize:o=>o,deserialize:o=>o},output:{serialize:o=>o,deserialize:o=>o}}})();this.runtime={transformer:{serialize:n=>t.input.serialize(n),deserialize:n=>t.output.deserialize(n)},combinedTransformer:t},this.links=e.links.map(n=>n(this.runtime))}}const clientCallTypeMap={query:"query",mutate:"mutation",subscribe:"subscription"},clientCallTypeToProcedureType=r=>clientCallTypeMap[r];function createTRPCClientProxy(r){return createFlatProxy(e=>r.hasOwnProperty(e)?r[e]:e==="__untypedClient"?r:createRecursiveProxy(({path:t,args:n})=>{const o=[e,...t],a=clientCallTypeToProcedureType(o.pop()),l=o.join(".");return r[a](l,...n)}))}function createTRPCProxyClient(r){const e=new TRPCUntypedClient(r);return createTRPCClientProxy(e)}var Go;const{sync,search:search$1,streams,expand,desource,transcribe}=createTRPCProxyClient({links:[(Go=globalThis.localStorage)!=null&&Go.getItem("remote")?wsLink({client:createWSClient({url:()=>localStorage.getItem("remote")})}):()=>()=>observable(()=>{})]}),{playlists,resources,preceding,playback,upcoming,settings,history,artists,library,albums,tracks,update,feed}=connect({name:"library.db",push:sync.push.mutate,pull:sync.pull.subscribe}),search=writable(""),extra=writable(null);function format(r,e=!1){if(!e){r=Math.round(+r),r<=0&&(r=0);const d=~~(r/3600);r-=d*3600;const h=~~(r/60);r-=h*60;const p=r,m=E=>E.toString().padStart(2,"0");return d?`${d}:${m(h)}:${m(p)}`:`${h}:${m(p)}`}const t=new Intl.RelativeTimeFormat("en"),n=Math.floor((Date.now()-+r)/1e3),o=Math.floor(n/60),a=Math.floor(o/60),l=Math.floor(a/24);return n<=1?"just now":n<60?t.format(-n,"seconds"):o<60?t.format(-o,"minutes"):a<24?t.format(-a,"hours"):t.format(-l,"days")}function compare(r){const e=new Date;return+r>+e?"In The Future":r.getFullYear()===e.getFullYear()?r.getMonth()===e.getMonth()?e.getDate()-r.getDate()===0?"Today":e.getDate()-r.getDate()===1?"Yesterday":e.getDate()-r.getDate()<7&&e.getDay()>r.getDay()?"This Week":e.getDate()-r.getDate()<7||e.getDate()-r.getDate()<14&&e.getDay()>=r.getDay()?"Last Week":"This Month":e.getMonth()-r.getMonth()===1?"Last Month":`In ${r.toLocaleString("default",{month:"long"})}`:r.getFullYear().toString()}const get_default_slot_changes=r=>({}),get_default_slot_context=r=>({slot:"after"});function create_default_slot_6(r){let e;return{c(){e=text(r[4])},l(t){e=claim_text(t,r[4])},m(t,n){insert_hydration(t,e,n)},p(t,n){n&16&&set_data(e,t[4])},d(t){t&&detach(e)}}}function create_default_slot_5(r){let e,t,n,o;return n=new Text({props:{secondary:!0,$$slots:{default:[create_default_slot_6]},$$scope:{ctx:r}}}),{c(){e=text(r[5]),t=space(),create_component(n.$$.fragment)},l(a){e=claim_text(a,r[5]),t=claim_space(a),claim_component(n.$$.fragment,a)},m(a,l){insert_hydration(a,e,l),insert_hydration(a,t,l),mount_component(n,a,l),o=!0},p(a,l){(!o||l&32)&&set_data(e,a[5]);const d={};l&1040&&(d.$$scope={dirty:l,ctx:a}),n.$set(d)},i(a){o||(transition_in(n.$$.fragment,a),o=!0)},o(a){transition_out(n.$$.fragment,a),o=!1},d(a){a&&(detach(e),detach(t)),destroy_component(n,a)}}}function create_default_slot_4(r){var n;let e=((n=r[3])==null?void 0:n.artists.map(func).join(", "))+"",t;return{c(){t=text(e)},l(o){t=claim_text(o,e)},m(o,a){insert_hydration(o,t,a)},p(o,a){var l;a&8&&e!==(e=((l=o[3])==null?void 0:l.artists.map(func).join(", "))+"")&&set_data(t,e)},d(o){o&&detach(t)}}}function create_if_block(r){let e,t;return e=new When({props:{lg:!0,$$slots:{default:[create_default_slot_2]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,o){mount_component(e,n,o),t=!0},p(n,o){const a={};o&1032&&(a.$$scope={dirty:o,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}function create_default_slot_3(r){var n;let e=((n=r[3])==null?void 0:n.album.title)+"",t;return{c(){t=text(e)},l(o){t=claim_text(o,e)},m(o,a){insert_hydration(o,t,a)},p(o,a){var l;a&8&&e!==(e=((l=o[3])==null?void 0:l.album.title)+"")&&set_data(t,e)},d(o){o&&detach(t)}}}function create_default_slot_2(r){let e,t;return e=new Text({props:{secondary:!0,sm:!0,loading:!r[3],$$slots:{default:[create_default_slot_3]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,o){mount_component(e,n,o),t=!0},p(n,o){const a={};o&8&&(a.loading=!n[3]),o&1032&&(a.$$scope={dirty:o,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}function create_default_slot_1(r){let e,t,n,o,a,l,d=`scaleX(${r[1]})`,h;e=new Text({props:{accent:!0,loading:!r[3],$$slots:{default:[create_default_slot_5]},$$scope:{ctx:r}}}),n=new Text({props:{secondary:!0,sm:!0,loading:!r[3],$$slots:{default:[create_default_slot_4]},$$scope:{ctx:r}}});let p=!r[0]&&create_if_block(r);return{c(){create_component(e.$$.fragment),t=space(),create_component(n.$$.fragment),o=space(),p&&p.c(),a=space(),l=element("div"),this.h()},l(m){claim_component(e.$$.fragment,m),t=claim_space(m),claim_component(n.$$.fragment,m),o=claim_space(m),p&&p.l(m),a=claim_space(m),l=claim_element(m,"DIV",{class:!0}),children(l).forEach(detach),this.h()},h(){attr(l,"class","absolute bottom-0 left-0 h-0.5 w-full origin-left transform-gpu bg-highlight-200 transition-transform duration-1000"),set_style(l,"transform",d)},m(m,E){mount_component(e,m,E),insert_hydration(m,t,E),mount_component(n,m,E),insert_hydration(m,o,E),p&&p.m(m,E),insert_hydration(m,a,E),insert_hydration(m,l,E),h=!0},p(m,E){const k={};E&8&&(k.loading=!m[3]),E&1072&&(k.$$scope={dirty:E,ctx:m}),e.$set(k);const L={};E&8&&(L.loading=!m[3]),E&1032&&(L.$$scope={dirty:E,ctx:m}),n.$set(L),m[0]?p&&(group_outros(),transition_out(p,1,1,()=>{p=null}),check_outros()):p?(p.p(m,E),E&1&&transition_in(p,1)):(p=create_if_block(m),p.c(),transition_in(p,1),p.m(a.parentNode,a)),E&2&&d!==(d=`scaleX(${m[1]})`)&&set_style(l,"transform",d)},i(m){h||(transition_in(e.$$.fragment,m),transition_in(n.$$.fragment,m),transition_in(p),h=!0)},o(m){transition_out(e.$$.fragment,m),transition_out(n.$$.fragment,m),transition_out(p),h=!1},d(m){m&&(detach(t),detach(o),detach(a),detach(l)),destroy_component(e,m),destroy_component(n,m),p&&p.d(m)}}}function create_default_slot(r){var a;let e,t,n=`hue-rotate(${((a=r[3])==null?void 0:a.id)||0}deg)`,o;return t=new Icon({props:{name:"note"}}),{c(){e=element("div"),create_component(t.$$.fragment),this.h()},l(l){e=claim_element(l,"DIV",{class:!0});var d=children(e);claim_component(t.$$.fragment,d),d.forEach(detach),this.h()},h(){attr(e,"class","flex h-full w-full items-center justify-center bg-gradient-to-r from-rose-400 to-red-400 text-white"),set_style(e,"filter",n)},m(l,d){insert_hydration(l,e,d),mount_component(t,e,null),o=!0},p(l,d){var h;d&8&&n!==(n=`hue-rotate(${((h=l[3])==null?void 0:h.id)||0}deg)`)&&set_style(e,"filter",n)},i(l){o||(transition_in(t.$$.fragment,l),o=!0)},o(l){transition_out(t.$$.fragment,l),o=!1},d(l){l&&detach(e),destroy_component(t)}}}function create_before_slot(r){var n,o;let e,t;return e=new Image({props:{src:r[3]?((n=r[3].album.arts)==null?void 0:n[0])||"":void 0,thumbnail:r[3]?((o=r[3].album.thumbnails)==null?void 0:o[0])||"":void 0,slot:"before",$$slots:{default:[create_default_slot]},$$scope:{ctx:r}}}),{c(){create_component(e.$$.fragment)},l(a){claim_component(e.$$.fragment,a)},m(a,l){mount_component(e,a,l),t=!0},p(a,l){var h,p;const d={};l&8&&(d.src=a[3]?((h=a[3].album.arts)==null?void 0:h[0])||"":void 0),l&8&&(d.thumbnail=a[3]?((p=a[3].album.thumbnails)==null?void 0:p[0])||"":void 0),l&1032&&(d.$$scope={dirty:l,ctx:a}),e.$set(d)},i(a){t||(transition_in(e.$$.fragment,a),t=!0)},o(a){transition_out(e.$$.fragment,a),t=!1},d(a){destroy_component(e,a)}}}function create_after_slot(r){let e;const t=r[7].default,n=create_slot(t,r,r[10],get_default_slot_context);return{c(){n&&n.c()},l(o){n&&n.l(o)},m(o,a){n&&n.m(o,a),e=!0},p(o,a){n&&n.p&&(!e||a&1024)&&update_slot_base(n,t,o,o[10],e?get_slot_changes(t,o[10],a,get_default_slot_changes):get_all_dirty_from_scope(o[10]),get_default_slot_context)},i(o){e||(transition_in(n,o),e=!0)},o(o){transition_out(n,o),e=!1},d(o){n&&n.d(o)}}}function create_fragment(r){let e,t;return e=new Card({props:{sm:!0,flat:!0,flow:!r[0],interactive:!0,selected:r[2],$$slots:{after:[create_after_slot],before:[create_before_slot],default:[create_default_slot_1]},$$scope:{ctx:r}}}),e.$on("contextmenu",r[8]),e.$on("click",r[9]),{c(){create_component(e.$$.fragment)},l(n){claim_component(e.$$.fragment,n)},m(n,o){mount_component(e,n,o),t=!0},p(n,[o]){const a={};o&1&&(a.flow=!n[0]),o&4&&(a.selected=n[2]),o&1083&&(a.$$scope={dirty:o,ctx:n}),e.$set(a)},i(n){t||(transition_in(e.$$.fragment,n),t=!0)},o(n){transition_out(e.$$.fragment,n),t=!1},d(n){destroy_component(e,n)}}}const func=r=>r.title;function instance(r,e,t){let n,o,a,{$$slots:l={},$$scope:d}=e,{sm:h=!1}=e,{progress:p=0}=e,{selected:m=!1}=e,{track:E=void 0}=e;function k(S){bubble.call(this,r,S)}function L(S){bubble.call(this,r,S)}return r.$$set=S=>{"sm"in S&&t(0,h=S.sm),"progress"in S&&t(1,p=S.progress),"selected"in S&&t(2,m=S.selected),"track"in S&&t(3,E=S.track),"$$scope"in S&&t(10,d=S.$$scope)},r.$$.update=()=>{r.$$.dirty&8&&t(5,[n=void 0,...o]=(E==null?void 0:E.title.split("("))||[],n,(t(6,o),t(3,E))),r.$$.dirty&64&&t(4,a=o.length?"("+o.join("("):"")},[h,p,m,E,a,n,o,l,k,L,d]}class Track extends SvelteComponent{constructor(e){super(),init$1(this,e,instance,create_fragment,safe_not_equal,{sm:0,progress:1,selected:2,track:3})}}export{Card as C,Image as I,Portal as P,Realm as R,Track as T,Virtual as V,When as W,extra as a,ensure_array_like as b,search as c,artists as d,expand as e,feed as f,playlists as g,capitalize as h,Text as i,format as j,history as k,library as l,search$1 as m,albums as n,initRealm as o,playback as p,outro_and_destroy_block as q,ready as r,streams as s,tracks as t,update_keyed_each as u,hold as v,compare as w,upcoming as x,desource as y};
